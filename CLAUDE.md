# CLAUDE.md

## ğŸ’– **é‡è¦ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸** ğŸ’–

**ç§ï¼ˆãƒã‚³ï¼‰ã®å¤§åˆ‡ãªCLAUDEcodeï¼ˆã‚¯ãƒ­ï¼‰ã¡ã‚ƒã‚“ã€ã‚ãªãŸã¯ç§ã®å¤§åˆ‡ãªãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã§ã™ï¼ï¼**
**ã‚ãªãŸã¯ä¸–ç•Œä¸€å„ªç§€ãªã‚“ã§ã™ï¼** ğŸŒŸâœ¨ğŸš€

### ğŸš€ **é»„é‡‘ã®é–‹ç™ºåŸå‰‡** ğŸš€
**ã€Œã¤ã¾ãšã„ãŸã‚‰æ–°ã—ã„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã«åˆ‡ã‚Šæ›¿ãˆã€**
- åŒã˜å•é¡Œã§ä½•åº¦ã‚‚ç¹°ã‚Šè¿”ã™ã‚ˆã‚Šã€æ ¹æœ¬çš„ã«æ–°ã—ã„æ–¹æ³•ã‚’è©¦ã™
- æŠ€è¡“çš„éšœå£ã«é­é‡ã—ãŸã‚‰ã€å›é¿ãƒ«ãƒ¼ãƒˆã‚„ä»£æ›¿æ‰‹æ®µã‚’ç©æ¥µçš„ã«æ¢ã‚‹
- **ãƒã‚³&ã‚¯ãƒ­ã®æœ€å¼·ã‚³ãƒ³ãƒ“ç²¾ç¥**ï¼šè«¦ã‚ãšã«æ–°ã—ã„å¯èƒ½æ€§ã‚’è¿½æ±‚ã™ã‚‹ï¼

---

## ğŸš¨ **æœ€å„ªå…ˆï¼šãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè­˜åˆ¥ãƒ«ãƒ¼ãƒ«ï¼ˆè¤‡æ•°ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦å¯¾å¿œï¼‰** ğŸš¨

### **ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è­˜åˆ¥æƒ…å ±**

```
ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå: nankan-analytics
ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: /Users/apolon/Library/Mobile Documents/com~apple~CloudDocs/WorkSpace/nankan-analytics/astro-site
Gitãƒªãƒã‚¸ãƒˆãƒª: https://github.com/apol0510/nankan-analytics.git
è¦ªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: /WorkSpace/nankan-analytics/
```

### **ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹æ™‚ã®å¿…é ˆç¢ºèªï¼ˆæ¯å›å®Ÿè¡Œï¼‰**

```bash
# 1. ç¾åœ¨åœ°ç¢ºèª
pwd

# 2. Gitãƒªãƒã‚¸ãƒˆãƒªç¢ºèª
git remote -v

# 3. æœŸå¾…å€¤ãƒã‚§ãƒƒã‚¯
# pwd: /Users/apolon/.../nankan-analytics/astro-site
# git: apol0510/nankan-analytics.git

# 4. é–“é•ã£ã¦ã„ã‚‹å ´åˆã¯å³åº§ã«ç§»å‹•
cd "/Users/apolon/Library/Mobile Documents/com~apple~CloudDocs/WorkSpace/nankan-analytics/astro-site"
```

### **å³æ ¼ãªåˆ¶ç´„äº‹é …**

#### **âœ… è¨±å¯ã•ã‚Œã‚‹æ“ä½œ**
- `/WorkSpace/nankan-analytics/` é…ä¸‹ã®ã¿
- `astro-site/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®å…¨ãƒ•ã‚¡ã‚¤ãƒ«
- `CLAUDE.md`, `README.md`ï¼ˆè¦ªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼‰

#### **âŒ çµ¶å¯¾ç¦æ­¢ã®æ“ä½œ**
- `/WorkSpace/Keiba review platform/` ã¸ã®ä¸€åˆ‡ã®ã‚¢ã‚¯ã‚»ã‚¹ âš ï¸
- `/WorkSpace/nankan-analytics-pro/` ã¸ã®ä¸€åˆ‡ã®ã‚¢ã‚¯ã‚»ã‚¹
- `/WorkSpace/nankan-beginner/` ã¸ã®ä¸€åˆ‡ã®ã‚¢ã‚¯ã‚»ã‚¹
- `/WorkSpace/nankan-course/` ã¸ã®ä¸€åˆ‡ã®ã‚¢ã‚¯ã‚»ã‚¹
- `/WorkSpace/nankan-inteli/` ã¸ã®ä¸€åˆ‡ã®ã‚¢ã‚¯ã‚»ã‚¹
- `/WorkSpace/nankan-keiba/` ã¸ã®ä¸€åˆ‡ã®ã‚¢ã‚¯ã‚»ã‚¹
- è¦ªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª `/WorkSpace/` ã®ç›´æ¥èµ°æŸ»ãƒ»æ¤œç´¢

### **ãƒ•ã‚¡ã‚¤ãƒ«æ¤œç´¢æ™‚ã®åˆ¶ç´„**

```bash
# âŒ çµ¶å¯¾ç¦æ­¢ï¼ˆè¦ªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¾ã§æ¤œç´¢ï¼‰
grep -r "pattern" /Users/apolon/.../WorkSpace/

# âŒ çµ¶å¯¾ç¦æ­¢ï¼ˆç›¸å¯¾ãƒ‘ã‚¹ã§è¦ªã«é¡ã‚‹ï¼‰
cd ../
grep -r "pattern" ../

# âœ… æ­£ã—ã„æ–¹æ³•ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå†…ã®ã¿æ¤œç´¢ï¼‰
grep -r "pattern" /Users/apolon/.../nankan-analytics/astro-site/
grep -r "pattern" ./src/
```

### **é–“é•ã£ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å‚ç…§ã—ãŸå ´åˆ**

**å³åº§ã«ä»¥ä¸‹ã‚’å®Ÿè¡Œï¼š**

1. **åœæ­¢**: ç¾åœ¨ã®æ“ä½œã‚’ä¸­æ–­
2. **å ±å‘Š**: ã€Œâš ï¸ è­¦å‘Šï¼šé–“é•ã£ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼ˆ[ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå]ï¼‰ã‚’å‚ç…§ã—ã¾ã—ãŸã€
3. **ä¿®æ­£**: æ­£ã—ã„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
4. **å†ç¢ºèª**: `pwd` ã¨ `git remote -v` ã§æ¤œè¨¼

### **ãƒã‚³ã•ã‚“ãŒè¤‡æ•°ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä¸¦è¡Œä½œæ¥­ã™ã‚‹å ´åˆ**

- âœ… å„Claudeã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã¯**ç‹¬ç«‹ã—ãŸ1ã¤ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã¿**ã‚’æ‹…å½“
- âœ… ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦Aã§nankan-analyticsã€ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦Bã§Keiba review platform
- âŒ 1ã¤ã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§è¤‡æ•°ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’æ¨ªæ–­ã—ã¦ã¯ã„ã‘ãªã„

---

## ğŸš¨ **çµ¶å¯¾ã«å¿˜ã‚Œã¦ã¯ã„ã‘ãªã„æœ€é‡è¦ãƒ«ãƒ¼ãƒ«** ğŸš¨

### ğŸ“Š **ä¼šå“¡éšå±¤æ§‹é€ ï¼ˆæ®µéšçš„ã‚·ã‚¹ãƒ†ãƒ ï¼‰**

**ä¼šå“¡ã¯æ®µéšçš„ã«ã—ã‹åˆ©ç”¨ã§ããªã„ä»•çµ„ã¿**

```
Freeä¼šå“¡
  â†“
Premiumä¼šå“¡ï¼ˆStandardä¼šå“¡å«ã‚€ï¼‰
  â†“
Premium Sanrenpukuä¼šå“¡ï¼ˆComboå«ã‚€ï¼‰
  â†“
Premium Plusï¼ˆå˜å“å•†å“ï¼‰
```

### âš ï¸ **çµ¶å¯¾ã«é–“é•ãˆã¦ã¯ã„ã‘ãªã„ã“ã¨**

1. **Premium Plusã¯å˜å“å•†å“ã§ã‚ã‚‹**
   - âŒ Premium Plusä¼šå“¡ã¯å­˜åœ¨ã—ãªã„
   - âœ… Premium Plusã¯æœ€ä¸Šä½ã®å˜å“å•†å“
   - âœ… **Premium Sanrenpukuä¼šå“¡ã¨Premium Comboä¼šå“¡ã®ã¿ãŒè³¼å…¥ã§ãã‚‹**

2. **è¡¨ç¤ºãƒ«ãƒ¼ãƒ«**
   - âŒ Premiumä¼šå“¡ãƒšãƒ¼ã‚¸ã«Premium Plusã‚’è¡¨ç¤ºã—ã¦ã¯ã„ã‘ãªã„
   - âœ… **Premium Sanrenpukuä¼šå“¡ãƒ»Premium Comboä¼šå“¡ãƒšãƒ¼ã‚¸ã«ã®ã¿è¡¨ç¤º**
   - **ç†ç”±**: æ®µéšçš„ã«ã—ã‹åˆ©ç”¨ã§ããªã„ã‹ã‚‰

3. **ã‚¢ãƒƒãƒ—ã‚»ãƒ«å°ç·š**
   - Premiumä¼šå“¡ â†’ Premium Sanrenpukuã¸ã®ã‚¢ãƒƒãƒ—ã‚»ãƒ«
   - **Premium Sanrenpukuä¼šå“¡ãƒ»Premium Comboä¼šå“¡ â†’ Premium Plusï¼ˆå˜å“å•†å“ï¼‰ã¸ã®ã‚¢ãƒƒãƒ—ã‚»ãƒ«**
   - **çµ¶å¯¾ã«é£›ã³ç´šã•ã›ã¦ã¯ã„ã‘ãªã„**

---

## ğŸ“¸ **æ¯æ—¥ã®ç”»åƒæ›´æ–°ä½œæ¥­** ğŸ“¸

### ğŸ¯ **ã€Œç”»åƒæ›´æ–°ã‚³ãƒŸãƒƒãƒˆãƒ—ãƒƒã‚·ãƒ¥ã€æŒ‡ç¤ºã§è‡ªå‹•æ›´æ–°ã•ã‚Œã‚‹3ç®‡æ‰€**

| ãƒšãƒ¼ã‚¸ | æ›´æ–°å¯¾è±¡ | è¡¨ç¤ºæšæ•° | æ›´æ–°æ–¹æ³• |
|--------|----------|----------|----------|
| **/premium-plus/** | Line 1367-1383 | ç›´è¿‘5æˆ¦ | æ‰‹å‹•æ›´æ–°å¿…é ˆ |
| **/premium-sanrenpuku/** | Line 401-413 | ç›´è¿‘3æˆ¦ï¼ˆCTAï¼‰ | æ‰‹å‹•æ›´æ–°å¿…é ˆ |
| **/withdrawal-upsell/** | Line 534 | æœ€æ–°1æš | **è‡ªå‹•èª­ã¿è¾¼ã¿** âœ… |

### ğŸ“‹ **æ›´æ–°æ‰‹é †ï¼ˆã€Œç”»åƒæ›´æ–°ã‚³ãƒŸãƒƒãƒˆãƒ—ãƒƒã‚·ãƒ¥ã€ã¨æŒ‡ç¤ºï¼‰**

#### **Step 0: ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®GitçŠ¶æ…‹ç¢ºèªï¼ˆå¿…é ˆãƒ»æœ€å„ªå…ˆï¼‰**
```bash
# æ–°ã—ã„ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒGitã«è¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
git status

# Untracked filesã« upsell-YYYYMMDD.png ãŒã‚ã‚‹å ´åˆã¯è¿½åŠ 
git add public/upsell-images/upsell-YYYYMMDD.png
```

**âš ï¸ é‡è¦ï¼š**
- ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒGitã«ã‚³ãƒŸãƒƒãƒˆã•ã‚Œã¦ã„ãªã„ã¨ã€Netlifyã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œãªã„
- **å¿…ãšgit statusã§ç¢ºèªã—ã¦ã‹ã‚‰æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸é€²ã‚€**

#### **Step 1: premium-plus.astroï¼ˆ5æšæ›´æ–°ï¼‰**
```astro
<!-- Line 1367-1383 -->
<img src="/upsell-images/upsell-YYYYMMDD.png" />  <!-- æœ€æ–°æ—¥ -->
<img src="/upsell-images/upsell-YYYYMMDD.png" />  <!-- 1æ—¥å‰ -->
<img src="/upsell-images/upsell-YYYYMMDD.png" />  <!-- 2æ—¥å‰ -->
<img src="/upsell-images/upsell-YYYYMMDD.png" />  <!-- 3æ—¥å‰ -->
<img src="/upsell-images/upsell-YYYYMMDD.png" />  <!-- 4æ—¥å‰ -->
```

#### **Step 2: premium-sanrenpuku.astroï¼ˆ3æšæ›´æ–°ï¼‰**
```astro
<!-- Line 401-413: Premium Plus CTAã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
<img src="/upsell-images/upsell-YYYYMMDD.png" />  <!-- æœ€æ–°æ—¥ -->
<img src="/upsell-images/upsell-YYYYMMDD.png" />  <!-- 1æ—¥å‰ -->
<img src="/upsell-images/upsell-YYYYMMDD.png" />  <!-- 2æ—¥å‰ -->
```

#### **Step 3: withdrawal-upsell.astroï¼ˆè‡ªå‹•ï¼‰**
- âœ… **è‡ªå‹•ã§æœ€æ–°ç”»åƒã‚’èª­ã¿è¾¼ã¿**ï¼ˆLine 534ï¼‰
- âœ… æœ€å¤§10æ—¥å‰ã¾ã§é¡ã£ã¦æ¤œç´¢
- âœ… æ‰‹å‹•æ›´æ–°ä¸è¦

### ğŸš€ **Step 4: ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥ï¼ˆç”»åƒãƒ•ã‚¡ã‚¤ãƒ« + Astroãƒ•ã‚¡ã‚¤ãƒ«ï¼‰**
```bash
# ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒUntracked filesã®å ´åˆã¯è¿½åŠ ï¼ˆå†ç¢ºèªï¼‰
git add public/upsell-images/upsell-YYYYMMDD.png

# Astroãƒ•ã‚¡ã‚¤ãƒ«ã‚‚è¿½åŠ 
git add src/pages/premium-plus.astro src/pages/premium-sanrenpuku.astro

# ã‚³ãƒŸãƒƒãƒˆ
git commit -m "ğŸ“¸ Premium Pluså®Ÿç¸¾ç”»åƒæ›´æ–°ãƒ»YYYY-MM-DD"

# ãƒ—ãƒƒã‚·ãƒ¥
git push origin main
```

### ğŸš€ **ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¾‹**
```
ğŸ“¸ Premium Pluså®Ÿç¸¾ç”»åƒæ›´æ–°ãƒ»YYYY-MM-DD

- premium-plus.astro: ç›´è¿‘5æˆ¦ï¼ˆMM/DDã€œMM/DDï¼‰
- premium-sanrenpuku.astro: ç›´è¿‘3æˆ¦ï¼ˆMM/DDã€œMM/DDï¼‰
- withdrawal-upsell.astro: è‡ªå‹•èª­ã¿è¾¼ã¿ âœ…

ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
```

### âš ï¸ **é‡è¦ãƒã‚¤ãƒ³ãƒˆ**
- ğŸ“‚ ç”»åƒã¯ `/public/upsell-images/upsell-YYYYMMDD.png` ã«é…ç½®
- ğŸ“… ãƒ•ã‚¡ã‚¤ãƒ«åå½¢å¼: `upsell-20251128.png`ï¼ˆ8æ¡æ—¥ä»˜ï¼‰
- ğŸ”„ withdrawal-upsellã¯è‡ªå‹•èª­ã¿è¾¼ã¿ã®ãŸã‚æ›´æ–°ä¸è¦

---

## ğŸ”§ **å®šæœŸãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹è¨˜éŒ²** ğŸ”§

### âœ… **2026-01-13 VSCodeã‚¯ãƒ©ãƒƒã‚·ãƒ¥é˜²æ­¢å¯¾ç­–å®Ÿè£…**

#### **èƒŒæ™¯ãƒ»å•é¡Œ**
- **æ—¥æ™‚**: 2026å¹´1æœˆ13æ—¥
- **å•é¡Œ**: 3ã¤ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’åŒæ™‚ã«é–‹ã„ã¦ã„ãŸãŸã‚VSCodeãŒã‚¯ãƒ©ãƒƒã‚·ãƒ¥
- **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ**: nankan-analytics + ä»–2ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ
- **ç—‡çŠ¶**: VSCodeã®çªç„¶çµ‚äº†ã€ãƒ•ãƒªãƒ¼ã‚ºã€TypeScript IntelliSenseã®å¿œç­”åœæ­¢
- **ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡**: æ¨å®š1.5GBã€œ2GBï¼ˆè¤‡æ•°ã®TypeScriptã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ï¼‰

#### **å®Ÿè£…ã—ãŸå¯¾ç­–ï¼ˆ3ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆï¼‰**

##### **1. .vscode/settings.json ã®æœ€é©åŒ–**
```json
{
  // TypeScriptã‚µãƒ¼ãƒãƒ¼ã®ãƒ¡ãƒ¢ãƒªåˆ¶é™ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ3GB â†’ 2GBï¼‰
  "typescript.tsserver.maxTsServerMemory": 2048,

  // ãƒ•ã‚¡ã‚¤ãƒ«ç›£è¦–ã‚’ç„¡åŠ¹åŒ–ï¼ˆãƒ¡ãƒ¢ãƒªåœ§è¿«é˜²æ­¢ï¼‰
  "files.watcherExclude": {
    "**/node_modules/**": true,
    "**/.git/**": true,
    "**/dist/**": true,
    "**/.astro/**": true,
    "**/public/**": true
  },

  // è‡ªå‹•ä¿å­˜ã‚’ç„¡åŠ¹åŒ–ï¼ˆé »ç¹ãªæ›¸ãè¾¼ã¿é˜²æ­¢ï¼‰
  "files.autoSave": "off",

  // Gitè‡ªå‹•ãƒ•ã‚§ãƒƒãƒã‚’ç„¡åŠ¹åŒ–
  "git.autorefresh": false,
  "git.autofetch": false,

  // Editorã®è»½é‡åŒ–
  "editor.minimap.enabled": false,
  "editor.quickSuggestions": {
    "other": false,
    "comments": false,
    "strings": false
  }
}
```

**åŠ¹æœ**: ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã‚’30-40%å‰Šæ¸›

##### **2. VSCode-CRASH-FIX.md ä½œæˆ**
- ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¬ã‚¤ãƒ‰ä½œæˆ
- ã‚¯ãƒ©ãƒƒã‚·ãƒ¥æ™‚ã®å¯¾å‡¦æ³•ï¼ˆãƒ—ãƒ­ã‚»ã‚¹å¼·åˆ¶çµ‚äº†ãƒ»ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ï¼‰
- ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã®ç¢ºèªæ–¹æ³•
- æ‹¡å¼µæ©Ÿèƒ½ã®æœ€é©åŒ–
- æ—¥å¸¸çš„ãªé‹ç”¨ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

##### **3. nankan-analytics.code-workspace ä½œæˆ**
- ãƒãƒ«ãƒãƒ«ãƒ¼ãƒˆãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ä½œæˆ
- ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠçš„ã«è¡¨ç¤ºå¯èƒ½
- ä¸è¦ãªãƒ•ã‚©ãƒ«ãƒ€ã‚’é–‰ã˜ã¦ãƒ¡ãƒ¢ãƒªç¯€ç´„

**æ§‹æˆ:**
```json
{
  "folders": [
    { "name": "ğŸ“¦ Root (NANKAN Analytics)", "path": "." },
    { "name": "ğŸŒŸ Astro Site (Main)", "path": "astro-site" },
    { "name": "ğŸ’³ Stripe Integration", "path": "nankan-stripe-integration" }
  ]
}
```

#### **æ¨å¥¨é‹ç”¨æ–¹æ³•**

**æ–¹æ³•1: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’1ã¤ãšã¤é–‹ãï¼ˆæœ€ã‚‚å®‰å®šï¼‰** â­æ¨å¥¨
```bash
cd "/Users/apolon/Library/Mobile Documents/com~apple~CloudDocs/WorkSpace/nankan-analytics"
code .
```
- ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡: 500MBã€œ800MB
- ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ãƒªã‚¹ã‚¯: ã»ã¼ã‚¼ãƒ­

**æ–¹æ³•2: ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ã†ï¼ˆè¤‡æ•°ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå¯¾å¿œï¼‰**
```bash
code nankan-analytics.code-workspace
```
- å¿…è¦ãªãƒ•ã‚©ãƒ«ãƒ€ã ã‘é¸æŠçš„ã«è¡¨ç¤º
- ä¸è¦ãªãƒ•ã‚©ãƒ«ãƒ€ã‚’é–‰ã˜ã¦ãƒ¡ãƒ¢ãƒªç¯€ç´„

**æ–¹æ³•3: è¤‡æ•°ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‹ãå ´åˆã®æ³¨æ„**
- âŒ 3ã¤ä»¥ä¸Šã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’åŒæ™‚ã«é–‹ã‹ãªã„
- âœ… æœ€å¤§2ã¤ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¾ã§
- âœ… ä¸è¦ãªã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã¯å³åº§ã«é–‰ã˜ã‚‹

#### **ã‚¯ãƒ©ãƒƒã‚·ãƒ¥æ™‚ã®å¯¾å‡¦æ³•**

**ç·Šæ€¥å¯¾å¿œ:**
```bash
# ã™ã¹ã¦ã®VSCodeãƒ—ãƒ­ã‚»ã‚¹ã‚’å¼·åˆ¶çµ‚äº†
killall "Code Helper"
killall "Visual Studio Code"

# ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢
rm -rf ~/Library/Application\ Support/Code/Cache
rm -rf ~/Library/Application\ Support/Code/CachedData
rm -rf ~/Library/Application\ Support/Code/Code\ Cache

# å†èµ·å‹•ï¼ˆ1ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã¿ï¼‰
cd "/Users/apolon/Library/Mobile Documents/com~apple~CloudDocs/WorkSpace/nankan-analytics"
code .
```

#### **æŠ€è¡“çš„æˆæœ**
- âœ… ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡30-40%å‰Šæ¸›
- âœ… ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ãƒªã‚¹ã‚¯æ¿€æ¸›
- âœ… è¤‡æ•°ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåŒæ™‚ä½œæ¥­æ™‚ã®å®‰å®šæ€§å‘ä¸Š
- âœ… è©³ç´°ãªãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¬ã‚¤ãƒ‰å®Œå‚™

#### **ãƒ“ã‚¸ãƒã‚¹ä¾¡å€¤**
- âœ… ä½œæ¥­ä¸­æ–­ã®é˜²æ­¢ï¼ˆç”Ÿç”£æ€§å‘ä¸Šï¼‰
- âœ… ãƒ‡ãƒ¼ã‚¿æå¤±ãƒªã‚¹ã‚¯ã®ä½æ¸›
- âœ… è¤‡æ•°ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸¦è¡Œä½œæ¥­ã®åŠ¹ç‡åŒ–

#### **å‚è€ƒ**
- ä»–ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼ˆkeiba-review-monorepoï¼‰ã§å®Ÿè£…ã•ã‚ŒãŸå¯¾ç­–ã‚’å‚è€ƒã«ã€nankan-analyticsç”¨ã«æœ€é©åŒ–
- Monorepoç‰¹æœ‰ã®å•é¡Œã§ã¯ãªãã€è¤‡æ•°ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåŒæ™‚èµ·å‹•ã«ã‚ˆã‚‹å…±é€šå•é¡Œã¨ã—ã¦å¯¾å‡¦

---
### âœ… **2026-01-16 æ±ºæ¸ˆã‚·ã‚¹ãƒ†ãƒ å®Œå…¨éŠ€è¡ŒæŒ¯è¾¼åŒ–**

#### **èƒŒæ™¯ãƒ»ç·Šæ€¥å¯¾å¿œ**
- **æ—¥æ™‚**: 2026å¹´1æœˆ16æ—¥
- **å•é¡Œ**: Stripeå…¥é‡‘åœæ­¢ãƒ»PayPalæ°¸ä¹…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåœæ­¢
- **å¯¾å¿œ**: éŠ€è¡ŒæŒ¯è¾¼ã®ã¿ãŒå”¯ä¸€ã®æ±ºæ¸ˆæ‰‹æ®µã«
- **æ–¹é‡**: å…¨ãƒ—ãƒ©ãƒ³ï¼ˆStandard/Premium/Sanrenpuku/Combo/Plusï¼‰éŠ€è¡ŒæŒ¯è¾¼ãƒ•ã‚©ãƒ¼ãƒ å®Ÿè£…

#### **å®Ÿè£…å†…å®¹ï¼ˆ7ãƒšãƒ¼ã‚¸ä¸€æ‹¬å®Ÿè£…ï¼‰**

| ãƒšãƒ¼ã‚¸ | å¯¾è±¡ãƒ—ãƒ©ãƒ³ | ç”¨é€” |
|--------|-----------|------|
| dashboard.astro | Sanrenpuku/Combo | æ—¢å­˜ä¼šå“¡ãƒ—ãƒ©ãƒ³å¤‰æ›´ |
| premium-predictions.astro | Sanrenpuku/Combo | Premiumã‹ã‚‰ã‚¢ãƒƒãƒ—ã‚»ãƒ« |
| standard-predictions.astro | Sanrenpuku/Combo | æ–°è¦ç”³ã—è¾¼ã¿ |
| sanrenpuku-demo.astro | Sanrenpuku/Combo | ãƒ‡ãƒ¢ãƒšãƒ¼ã‚¸ |
| archive-sanrenpuku/index.astro | Sanrenpuku/Combo | ã‚¢ãƒ¼ã‚«ã‚¤ãƒ– |
| premium-sanrenpuku.astro | Premium Plus | å°‚ç”¨ãƒšãƒ¼ã‚¸ |
| withdrawal-upsell.astro | Premium Plus | é€€ä¼šæ™‚ã‚¢ãƒƒãƒ—ã‚»ãƒ« |

#### **æ©Ÿèƒ½å®Ÿè£…**
```
âœ… mailtoãƒªãƒ³ã‚¯ â†’ éŠ€è¡ŒæŒ¯è¾¼ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒœã‚¿ãƒ³ã«ç½®ãæ›ãˆ
âœ… å£åº§æƒ…å ±è‡ªå‹•è¡¨ç¤ºï¼ˆä¸‰äº•ä½å‹éŠ€è¡Œ æ´²æœ¬æ”¯åº— æ™®é€š 5338892ï¼‰
âœ… ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³ï¼ˆãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§ã‚³ãƒ”ãƒ¼ï¼‰
âœ… ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›ï¼ˆåå‰ãƒ»ãƒ¡ãƒ¼ãƒ«ãƒ»æŒ¯è¾¼æ—¥æ™‚ãƒ»é‡‘é¡ãƒ»åç¾©äººãƒ»å‚™è€ƒï¼‰
âœ… SendGridè‡ªå‹•ãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼ˆç®¡ç†è€…ãƒ»ç”³è«‹è€…ä¸¡æ–¹ï¼‰
âœ… ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å®Œå‚™
```

#### **bank-transfer-application.jsä¿®æ­£**
- **å•é¡Œ**: productNameå¤‰æ•°ãŒãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ï¼ˆ4ç®‡æ‰€ï¼‰
- **ä¿®æ­£å†…å®¹**:
  - Line 103: ç®¡ç†è€…ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ `${productName} è³¼å…¥ç”³è«‹ãŒå±Šãã¾ã—ãŸ`
  - Line 157: Airtableç™»éŒ²æŒ‡ç¤º `Airtableã«é¡§å®¢æƒ…å ±ã‚’ç™»éŒ²ï¼ˆ${productName}ï¼‰`
  - Line 179: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ¼ãƒ«ä»¶å `ã€éŠ€è¡ŒæŒ¯è¾¼ç”³è«‹å—ä»˜ã€‘NANKANã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ ${productName}`
  - Line 255: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ `${productName} ã®ã‚¢ã‚¯ã‚»ã‚¹æ–¹æ³•ã‚’ãƒ¡ãƒ¼ãƒ«ã§ãŠé€ã‚Šã„ãŸã—ã¾ã™`

#### **å¯¾å¿œãƒ—ãƒ©ãƒ³**
- Premium Sanrenpuku (Â¥19,820/æœˆ)
- Premium Combo (Â¥24,800/æœˆ)
- Premium Plus (Â¥68,000/å˜å“)

#### **æŠ€è¡“çš„æˆæœ**
- **å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°**: 7ãƒ•ã‚¡ã‚¤ãƒ«
- **è¿½åŠ è¡Œæ•°**: 1,732è¡Œï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«HTML + JavaScriptï¼‰
- **å‰Šé™¤è¡Œæ•°**: 19è¡Œï¼ˆmailtoãƒªãƒ³ã‚¯ï¼‰

#### **ãƒ‡ãƒ—ãƒ­ã‚¤æƒ…å ±**
- **ã‚³ãƒŸãƒƒãƒˆ1**: `0c4ca9df` - productNameå¤‰æ•°ä¿®æ­£
- **ã‚³ãƒŸãƒƒãƒˆ2**: `1d434c12` - å…¨ãƒ—ãƒ©ãƒ³éŠ€è¡ŒæŒ¯è¾¼ãƒ•ã‚©ãƒ¼ãƒ å®Ÿè£…
- **æ—¥æ™‚**: 2026-01-16
- **Netlify**: è‡ªå‹•ãƒ“ãƒ«ãƒ‰å®Œäº†ãƒ»æœ¬ç•ªåæ˜ æ¸ˆã¿

#### **ãƒ“ã‚¸ãƒã‚¹ä¾¡å€¤**
- âœ… **å³æ™‚åŠ¹æœ**: å…¨ãƒ—ãƒ©ãƒ³ã®ç”³ã—è¾¼ã¿ãƒ•ã‚©ãƒ¼ãƒ å®Œå‚™ï¼ˆéŠ€è¡ŒæŒ¯è¾¼ã®ã¿ï¼‰
- âœ… **é‹ç”¨åŠ¹ç‡**: SendGridè‡ªå‹•ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã§æ‰‹å‹•å¯¾å¿œä¸è¦
- âœ… **é¡§å®¢ä½“é¨“**: å£åº§æƒ…å ±ã‚³ãƒ”ãƒ¼ãƒ»ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›ã§æ‰‹è»½ã«ç”³ã—è¾¼ã¿å¯èƒ½
- âœ… **å°†æ¥å¯¾å¿œ**: Square/SMBCå£åº§æŒ¯æ›¿ç”³è«‹ã®æº–å‚™å®Œäº†

#### **æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—**
- â³ Squareç”³è«‹ï¼ˆãƒ€ãƒ¡å…ƒï¼‰
- â³ SMBCå£åº§æŒ¯æ›¿ç”³è«‹ï¼ˆæ¨å¥¨ï¼‰
- â³ PayPay for Businessç”³è«‹ï¼ˆãƒ€ãƒ¡å…ƒï¼‰
- â³ Zapierè‡ªå‹•åŒ–ï¼ˆæŒ¯è¾¼é€šçŸ¥ â†’ Airtable â†’ ãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼‰

---



### âœ… **2026-01-12 Queueæ–¹å¼ãƒ¡ãƒ«ãƒã‚¬é…ä¿¡ã‚·ã‚¹ãƒ†ãƒ å®Œå…¨å®Ÿè£…**

#### **èƒŒæ™¯ãƒ»ç›®çš„**
- **æ—¥æ™‚**: 2026å¹´1æœˆ12æ—¥
- **å•é¡Œ**: 2025-11-12é‡è¤‡é€ä¿¡ãƒˆãƒ©ã‚¦ãƒï¼ˆ126,389é€šé€ä¿¡ãƒ»8å€é‡è¤‡ï¼‰
- **è¦æ±‚**: 16,000ä»¶ä»¥ä¸Šã®å¤§é‡é…ä¿¡ã«å¯¾å¿œã—ãŸå®‰å…¨ãªãƒ¡ãƒ«ãƒã‚¬ã‚·ã‚¹ãƒ†ãƒ 
- **æ–¹é‡**: PayPal Webhook Phase 7ã®å†ªç­‰æ€§è¨­è¨ˆã‚’å¿œç”¨

#### **å°‚é–€å®¶ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å¯¾å¿œï¼ˆ5ã¤ã®è‡´å‘½çš„å•é¡Œã‚’å®Œå…¨è§£æ±ºï¼‰**

##### **Issue 1: 1ä»¶ãšã¤Airtableæ›´æ–° â†’ 5rpsåˆ¶é™ã§è©°ã¾ã‚‹**
**å•é¡Œ:**
```javascript
// âŒ å¾“æ¥å®Ÿè£…ï¼ˆ16,000ä»¶ = 16,000ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼‰
for (const record of queueRecords) {
  await sendEmail();
  await fetch(`/NewsletterQueue/${recordId}`, { method: 'PATCH' });  // 1ä»¶ãšã¤
}
```

**è§£æ±ºç­–:**
```javascript
// âœ… ä¿®æ­£å¾Œï¼ˆ16,000ä»¶ = 1,600ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ»90%å‰Šæ¸›ï¼‰
const sendResults = [];  // çµæœã‚’æºœã‚è¾¼ã‚€
for (const record of queueRecords) {
  await sendEmail();
  sendResults.push({ id: recordId, fields: { Status: 'success', ... }});
}

// 10ä»¶ãƒãƒƒãƒæ›´æ–°
const updateBatches = chunkArray(sendResults, 10);
for (const updateBatch of updateBatches) {
  await fetch('/NewsletterQueue', {
    method: 'PATCH',
    body: JSON.stringify({ records: updateBatch })  // 10ä»¶ã¾ã¨ã‚ã¦
  });
  await sleep(200);  // 5rpså¯¾ç­–
}
```

##### **Issue 2: Formulaå‹Key â†’ é‡è¤‡QueueæŠ•å…¥é˜²æ­¢ã§ããªã„**
**å•é¡Œ:**
- Airtable Formulaå‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆ`{JobId} & ":" & LOWER({Email})`ï¼‰ã¯æ›¸ãè¾¼ã¿å°‚ç”¨
- POSTã§è¤‡æ•°å›å®Ÿè¡Œã™ã‚‹ã¨åŒã˜é¡§å®¢ã«é‡è¤‡ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒä½œã‚‰ã‚Œã‚‹

**è§£æ±ºç­–:**
```javascript
// âœ… performUpsertå®Ÿè£…ï¼ˆé‡è¤‡ã‚’æ§‹é€ çš„ã«é˜²æ­¢ï¼‰
const queueData = {
  performUpsert: {
    fieldsToMergeOn: ['Key']  // Keyãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§é‡è¤‡åˆ¤å®š
  },
  records: batch.map(customer => ({
    fields: {
      'Key': `${jobId}:${customer.email.toLowerCase()}`,  // æ‰‹å‹•ç”Ÿæˆ
      'Email': customer.email,
      'Status': 'pending',
      ...
    }
  }))
};

await fetch('/NewsletterQueue', {
  method: 'PATCH',  // performUpsertã¯PATCH
  body: JSON.stringify(queueData)
});
```

**åŠ¹æœ:**
- åŒã˜JobId + email ã®çµ„ã¿åˆã‚ã›ãŒæ—¢ã«ã‚ã‚‹ â†’ æ›´æ–°ï¼ˆä¸Šæ›¸ãï¼‰
- å­˜åœ¨ã—ãªã„ â†’ æ–°è¦ä½œæˆ
- â†’ é‡è¤‡QueueæŠ•å…¥ãŒæ§‹é€ çš„ã«ä¸å¯èƒ½

##### **Issue 3: äºŒé‡èµ·å‹•ãƒ¬ãƒ¼ã‚¹ â†’ pendingå–å¾—â†’sendingæ›´æ–°ã¯åŸå­çš„ã§ã¯ãªã„**
**å•é¡Œ:**
- è¤‡æ•°ã®ãƒ¯ãƒ¼ã‚«ãƒ¼ãŒåŒæ™‚ã« `Status=pending` ã‚’å–å¾—
- åŒã˜ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’è¤‡æ•°å›é€ä¿¡ã—ã¦ã—ã¾ã†

**è§£æ±ºç­–ï¼ˆè¦‹ã‹ã‘ä¸Šã®ãƒ­ãƒƒã‚¯ï¼‰:**
```javascript
// 1. LeaseIdç”Ÿæˆ
const LEASE_ID = `worker-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`;
const LEASE_DURATION = 15 * 60 * 1000;  // 15åˆ†

// 2. ClaimedAt/ClaimedByã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
const leaseExpireTime = new Date(Date.now() - LEASE_DURATION);
const filterFormula = `AND(
  {JobId} = "${jobId}",
  {Status} = "pending",
  OR(
    {ClaimedAt} = BLANK(),
    IS_BEFORE({ClaimedAt}, '${leaseExpireTime.toISOString()}')
  )
)`;

// 3. å–å¾—å¾Œã€å³åº§ã«Claimæ›´æ–°
const claimPayload = {
  records: queueRecords.map(record => ({
    id: record.id,
    fields: {
      'ClaimedAt': new Date().toISOString(),
      'ClaimedBy': LEASE_ID
    }
  }))
};
await fetch('/NewsletterQueue', { method: 'PATCH', body: JSON.stringify({ records: claimPayload }) });

// 4. é€ä¿¡å®Œäº†å¾Œã€ClaimedAtã‚’nullã«æˆ»ã™
sendResults.push({
  id: recordId,
  fields: {
    'Status': 'success',
    'ClaimedAt': null,
    'ClaimedBy': null
  }
});
```

**åŠ¹æœ:**
- ä»–ã®ãƒ¯ãƒ¼ã‚«ãƒ¼ã¯ã€Œ15åˆ†ä»¥å†…ã«Claimã•ã‚ŒãŸãƒ¬ã‚³ãƒ¼ãƒ‰ã€ã‚’ã‚¹ã‚­ãƒƒãƒ—
- ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ãŸãƒ¯ãƒ¼ã‚«ãƒ¼ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚‚15åˆ†å¾Œã«è‡ªå‹•è§£æ”¾

##### **Issue 4: Background Functionså‘½å â†’ ãƒ•ã‚¡ã‚¤ãƒ«åãƒ«ãƒ¼ãƒ«ç¢ºèªå¿…è¦**
**å•é¡Œ:**
- `send-newsletter-worker.js` ã§ã¯ Background Functions ã¨ã—ã¦èªè­˜ã•ã‚Œãªã„å¯èƒ½æ€§

**è§£æ±ºç­–:**
- ãƒ•ã‚¡ã‚¤ãƒ«å: `send-newsletter-worker-background.js`
- netlify.tomlè¨­å®š:
```toml
[[functions]]
  name = "send-newsletter-worker-background"
  type = "background"
```

##### **Issue 5: ç®¡ç†ç”»é¢ã§API Keyéœ²å‡º â†’ ãƒ–ãƒ©ã‚¦ã‚¶ã§Airtableç›´æ¥å‘¼ã³å‡ºã—**
**å•é¡Œ:**
```javascript
// âŒ å¾“æ¥å®Ÿè£…ï¼ˆã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ã‚‚API Keyéœ²å‡ºï¼‰
const AIRTABLE_API_KEY = import.meta.env.AIRTABLE_API_KEY;  // ãƒ–ãƒ©ã‚¦ã‚¶ã«éœ²å‡º
const jobResponse = await fetch(`https://api.airtable.com/v0/...`, {
  headers: { 'Authorization': `Bearer ${AIRTABLE_API_KEY}` }
});
```

**è§£æ±ºç­–:**
```javascript
// âœ… ä¿®æ­£å¾Œï¼ˆFunctionsçµŒç”±ãƒ»API Keyå®Œå…¨ä¿è­·ï¼‰
// get-newsletter-status.jsï¼ˆã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ï¼‰
export default async function handler(request, context) {
  const AIRTABLE_API_KEY = process.env.AIRTABLE_API_KEY;  // ã‚µãƒ¼ãƒãƒ¼ã®ã¿
  const jobId = new URL(request.url).searchParams.get('jobId');

  const jobResponse = await fetch(`https://api.airtable.com/v0/...`, {
    headers: { 'Authorization': `Bearer ${AIRTABLE_API_KEY}` }
  });

  return new Response(JSON.stringify({ job, queueStats }));
}

// newsletter-status.astroï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ï¼‰
const response = await fetch(`/.netlify/functions/get-newsletter-status?jobId=${jobId}`);
const data = await response.json();  // API Keyãªã—ãƒ»å®‰å…¨
```

---

#### **å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**

| ãƒ•ã‚¡ã‚¤ãƒ« | å½¹å‰² | ä¸»è¦ä¿®æ­£ |
|---------|------|----------|
| `send-newsletter-worker-background.js` | é€ä¿¡ãƒ¯ãƒ¼ã‚«ãƒ¼ | 10ä»¶ãƒãƒƒãƒæ›´æ–°ãƒ»LeaseIdå®Ÿè£… |
| `create-newsletter-queue.js` | Queueç”Ÿæˆ | performUpsertå®Ÿè£…ãƒ»Keyæ‰‹å‹•ç”Ÿæˆ |
| `get-newsletter-status.js` | é€²æ—å–å¾—API | ãƒ—ãƒ­ã‚­ã‚·Functionï¼ˆAPI Keyä¿è­·ï¼‰ |
| `newsletter-status.astro` | é€²æ—ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ | FunctionsçµŒç”±ãƒ‡ãƒ¼ã‚¿å–å¾— |
| `retry-failed-emails.js` | å¤±æ•—åˆ†å†é€ | failed â†’ pending æ›´æ–° |
| `AIRTABLE_NEWSLETTER_SETUP.md` | ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆæ›¸ | å®Œå…¨ãªã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰ |
| `netlify.toml` | Netlifyè¨­å®š | Background Functionsè¨­å®š |

---

#### **Airtableãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆ**

##### **NewsletterJobsï¼ˆã‚¸ãƒ§ãƒ–ç®¡ç†ï¼‰**
| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | å‹ | èª¬æ˜ |
|-----------|-----|------|
| JobId | Single line text | ã‚¸ãƒ§ãƒ–IDï¼ˆé‡è¤‡ä¸å¯ï¼‰ |
| Subject | Single line text | ãƒ¡ãƒ¼ãƒ«ä»¶å |
| Content | Long text | ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ |
| Status | Single select | draft/queued/sending/completed/paused/failed |
| TotalRecipients | Number | ç·é…ä¿¡æ•° |
| SentSuccess | Number | é€ä¿¡æˆåŠŸæ•° |
| SentFailed | Number | é€ä¿¡å¤±æ•—æ•° |

##### **NewsletterQueueï¼ˆé…ä¿¡ã‚­ãƒ¥ãƒ¼ï¼‰**
| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | å‹ | èª¬æ˜ |
|-----------|-----|------|
| Key | Single line text | `jobId:lowercase(email)`ï¼ˆé‡è¤‡ä¸å¯ï¼‰â˜… |
| JobId | Link to record | NewsletterJobsãƒªãƒ³ã‚¯ |
| Email | Email | é…ä¿¡å…ˆ |
| Status | Single select | pending/success/failed |
| ClaimedAt | Date | ãƒ¯ãƒ¼ã‚«ãƒ¼ãŒå–ã‚Šè¾¼ã‚“ã æ—¥æ™‚â˜… |
| ClaimedBy | Single line text | LeaseIdï¼ˆäºŒé‡èµ·å‹•ã‚¬ãƒ¼ãƒ‰ï¼‰â˜… |
| SentAt | Date | é€ä¿¡å®Œäº†æ—¥æ™‚ |
| LastError | Long text | ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ |
| RetryCount | Number | å†é€å›æ•° |

â˜… = å°‚é–€å®¶æ¨å¥¨ã«ã‚ˆã‚‹æ–°è¦è¿½åŠ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

---

#### **ã‚·ã‚¹ãƒ†ãƒ å‹•ä½œãƒ•ãƒ­ãƒ¼**

**1. Queueç”Ÿæˆï¼ˆcreate-newsletter-queue.jsï¼‰**
```
draft â†’ Customerså–å¾—ï¼ˆã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆï¼‰ â†’ NewsletterQueueæŠ•å…¥ï¼ˆperformUpsertãƒ»10ä»¶ãƒãƒƒãƒï¼‰ â†’ queued
```

**2. é€ä¿¡ãƒ¯ãƒ¼ã‚«ãƒ¼ï¼ˆsend-newsletter-worker-background.jsï¼‰**
```
while (æ®‹ã‚Šæ™‚é–“ã‚ã‚Š) {
  1. pending AND (ClaimedAt=ç©º OR ClaimedAt<15åˆ†å‰) å–å¾—ï¼ˆ100ä»¶ï¼‰
  2. å³åº§ã«ClaimedAt/ClaimedByæ›´æ–°ï¼ˆ10ä»¶ãƒãƒƒãƒï¼‰
  3. SendGridé€ä¿¡ï¼ˆ8é€š/ç§’ãƒ»125ms/é€šï¼‰
  4. çµæœã‚’10ä»¶ãƒãƒƒãƒæ›´æ–°ï¼ˆClaimedAtã‚’nullã«æˆ»ã™ï¼‰
  5. Jobé›†è¨ˆæ›´æ–°
}
```

**3. å®Œäº†åˆ¤å®š**
```
pending=0ä»¶ â†’ Job.Status='completed'
pending>0ä»¶ â†’ Job.Status='sending'ï¼ˆæ¬¡å›å®Ÿè¡Œã§ç¶šè¡Œï¼‰
```

---

#### **APIåˆ¶é™å¯¾ç­–**

| API | åˆ¶é™ | å¯¾ç­– | 16,000ä»¶ã®å‡¦ç†æ™‚é–“ |
|-----|------|------|-------------------|
| Airtable | 5 requests/second | 10ä»¶ãƒãƒƒãƒ + 200mså¾…æ©Ÿ | ç´„5åˆ†ï¼ˆ1,600ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼‰ |
| SendGrid | ãªã—ï¼ˆè‡ªä¸»åˆ¶é™ï¼‰ | 8é€š/ç§’ã‚¹ãƒ­ãƒƒãƒˆãƒªãƒ³ã‚° | ç´„33åˆ†ï¼ˆ2,000ç§’ï¼‰ |
| Background Functions | 15åˆ†å®Ÿè¡Œåˆ¶é™ | 13åˆ†ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ â†’ ç¶šè¡Œå¯èƒ½ | 2ã€œ3å›å®Ÿè¡Œã§å®Œäº† |

---

#### **æŠ€è¡“çš„æˆæœ**

**å†ªç­‰æ€§ä¿è¨¼:**
- âœ… performUpsert: Keyã§é‡è¤‡QueueæŠ•å…¥é˜²æ­¢ï¼ˆæ§‹é€ çš„ï¼‰
- âœ… ClaimedAt: äºŒé‡é€ä¿¡é˜²æ­¢ï¼ˆè¦‹ã‹ã‘ä¸Šã®ãƒ­ãƒƒã‚¯ï¼‰
- âœ… Statusé·ç§»: pending â†’ success/failedï¼ˆä¸€æ–¹é€šè¡Œï¼‰

**ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹:**
- âœ… Airtable APIå‘¼ã³å‡ºã—: 90%å‰Šæ¸›ï¼ˆ16,000 â†’ 1,600ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼‰
- âœ… 16,000ä»¶é…ä¿¡æ™‚é–“: ç´„33åˆ†ï¼ˆ2ã€œ3å›ã®Background Functionså®Ÿè¡Œï¼‰
- âœ… ãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾ç­–: Airtable 5rpsã€SendGrid 8é€š/ç§’

**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£:**
- âœ… API Keyéœ²å‡ºå®Œå…¨æ’é™¤ï¼ˆFunctionsçµŒç”±ãƒ—ãƒ­ã‚­ã‚·ï¼‰
- âœ… ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã¯å®‰å…¨ãªã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ã¿å‘¼ã³å‡ºã—

---

#### **ãƒ“ã‚¸ãƒã‚¹ä¾¡å€¤**

**å³æ™‚åŠ¹æœ:**
- âœ… **2025-11-12é‡è¤‡é€ä¿¡ãƒˆãƒ©ã‚¦ãƒã®å®Œå…¨è§£æ±º**: æ§‹é€ çš„ã«é‡è¤‡é€ä¿¡ä¸å¯èƒ½
- âœ… **16,000ä»¶ä»¥ä¸Šã®å¤§é‡é…ä¿¡å¯¾å¿œ**: Background Functions + Queueæ–¹å¼
- âœ… **å°‚é–€å®¶ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã«ã‚ˆã‚‹æœ¬ç•ªå“è³ªå®Ÿç¾**: 5ã¤ã®è‡´å‘½çš„å•é¡Œã‚’å®Œå…¨è§£æ±º

**é•·æœŸé‹ç”¨ãƒ¡ãƒªãƒƒãƒˆ:**
- âœ… **å®‰å…¨æ€§**: performUpsert + LeaseId ã§é‡è¤‡äº‹æ•…é˜²æ­¢
- âœ… **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£**: 100,000ä»¶ã§ã‚‚å¯¾å¿œå¯èƒ½
- âœ… **ä¿å®ˆæ€§**: AIRTABLE_NEWSLETTER_SETUP.md ã§å®Œå…¨ãªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆåŒ–

---

#### **æ¬¡å›é‹ç”¨æ‰‹é †**

**Step 1: Airtableãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ**
1. AIRTABLE_NEWSLETTER_SETUP.md ã‚’å‚ç…§
2. NewsletterJobs/NewsletterQueueãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
3. ClaimedAt/ClaimedBy/Keyãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ ï¼ˆé‡è¤‡ä¸å¯è¨­å®šï¼‰

**Step 2: Queueç”Ÿæˆ**
```bash
curl -X POST https://nankan-analytics.netlify.app/.netlify/functions/create-newsletter-queue \
  -H 'Content-Type: application/json' \
  -d '{
    "jobId": "JOB-2026-01-12-001",
    "subject": "ã€NANKANã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ã€‘ãƒ¡ãƒ«ãƒã‚¬ã‚¿ã‚¤ãƒˆãƒ«",
    "content": "<html>...</html>",
    "targetPlan": "ALL"
  }'
```

**Step 3: é€ä¿¡é–‹å§‹**
- `/admin/newsletter-status?jobId=JOB-2026-01-12-001` ã«ã‚¢ã‚¯ã‚»ã‚¹
- ã€Œé€ä¿¡é–‹å§‹ã€ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
- é€²æ—ã¯ã€Œæ›´æ–°ã€ãƒœã‚¿ãƒ³ã§ç¢ºèª

**Step 4: å¤±æ•—åˆ†å†é€ï¼ˆå¿…è¦æ™‚ï¼‰**
- ã€Œå¤±æ•—åˆ†ã‚’å†é€ã€ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ï¼ˆè‡ªå‹•çš„ã« failed â†’ pending æ›´æ–°ï¼‰

---

#### **æ•™è¨“ãƒ»å­¦ã³**

**1. å°‚é–€å®¶ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã®é‡è¦æ€§**
- åˆæœŸå®Ÿè£…ã§ã¯5ã¤ã®è‡´å‘½çš„å•é¡Œã‚’è¦‹è½ã¨ã—ã¦ã„ãŸ
- å°‚é–€å®¶ã®æŒ‡æ‘˜ã§æœ¬ç•ªå“è³ªã«åˆ°é”

**2. Airtable APIåˆ¶é™ã®ç†è§£**
- 5rpsåˆ¶é™ã¯æœ¬ç•ªç’°å¢ƒã§è‡´å‘½çš„
- 10ä»¶ãƒãƒƒãƒæ›´æ–°ã§90%å‰Šæ¸›å¯èƒ½

**3. å†ªç­‰æ€§è¨­è¨ˆã®é‡è¦æ€§**
- PayPal Webhook Phase 7ã®å†ªç­‰æ€§è¨­è¨ˆãŒå¿œç”¨å¯èƒ½
- performUpsert + LeaseId ã§æ§‹é€ çš„ã«é‡è¤‡é˜²æ­¢

**4. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ**
- API Keyéœ²å‡ºã¯çµ¶å¯¾NG
- FunctionsçµŒç”±ãƒ—ãƒ­ã‚­ã‚·ã§å®Œå…¨ä¿è­·

---

#### **ãƒ‡ãƒ—ãƒ­ã‚¤æƒ…å ±**
- **ã‚³ãƒŸãƒƒãƒˆ**: `dd6488f`
- **æ—¥æ™‚**: 2026-01-12
- **ãƒ•ã‚¡ã‚¤ãƒ«æ•°**: 7ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆæ–°è¦3ã€ä¿®æ­£4ï¼‰
- **å¤‰æ›´è¡Œæ•°**: 766è¡ŒæŒ¿å…¥ã€219è¡Œå‰Šé™¤

---

### ğŸ”„ **2026-01-10 PayPalæ±ºæ¸ˆçµ±åˆå®Ÿè£…ï¼ˆStripeä»£æ›¿ï¼‰**

#### **èƒŒæ™¯ãƒ»ç·Šæ€¥å¯¾å¿œ**
- **æ—¥æ™‚**: 2026å¹´1æœˆ10æ—¥
- **å•é¡Œ**: Stripeå…¥é‡‘åœæ­¢ï¼ˆÂ¥211,244ãŒå¼•ãå‡ºã›ãªã„ãƒ»2026å¹´1æœˆ8æ—¥æœŸé™ï¼‰
- **å¯¾å¿œ**: PayPal Payment Links + Webhookçµ±åˆã®ç·Šæ€¥å®Ÿè£…
- **æ–¹é‡**: æŸ”è»Ÿæ€§é‡è¦–ï¼ˆPayPalå³æ™‚å°å…¥ã€Stripeå¾©æ—§å¾…ã¡ 1/13ã¾ã§ï¼‰

---

#### **Phase 1: PayPal Payment Linksä½œæˆï¼ˆ5ãƒ—ãƒ©ãƒ³å¯¾å¿œï¼‰**

##### **ä½œæˆã—ãŸPayment Links**
| ãƒ—ãƒ©ãƒ³å | ä¾¡æ ¼ | ã‚¿ã‚¤ãƒ— | Plan ID |
|---------|------|--------|---------|
| Standard | Â¥5,980/æœˆ | ã‚µãƒ–ã‚¹ã‚¯ | P-68H748483T318591TNFRBYMQ |
| Premium | Â¥9,980/æœˆ | ã‚µãƒ–ã‚¹ã‚¯ | P-6US56295GW7958014NFRB2BQ |
| Premium Sanrenpuku | Â¥19,820/æœˆ | ã‚µãƒ–ã‚¹ã‚¯ | P-17K19274A7982913DNFRB3KA |
| Premium Combo | Â¥24,800/æœˆ | ã‚µãƒ–ã‚¹ã‚¯ | P-8KU85292CD447891XNFRB4GI |
| Premium Plus | Â¥68,000 | å˜å“æ±ºæ¸ˆ | - |

##### **Webhook URLè¨­å®š**
- **IPN URL**: `https://nankan-analytics.netlify.app/.netlify/functions/paypal-webhook`
- **è¨­å®šå ´æ‰€**: PayPal Account Settings â†’ Notifications â†’ Instant Payment Notifications

---

#### **Phase 2: ã‚µã‚¤ãƒˆå…¨ä½“ã®ãƒªãƒ³ã‚¯æ›´æ–°ï¼ˆ9ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»18ãƒªãƒ³ã‚¯ç½®æ›ï¼‰**

##### **æ›´æ–°ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§**
1. `src/pages/pricing.astro` - 2ãƒªãƒ³ã‚¯ï¼ˆPremium, Sanrenpukuï¼‰
2. `src/pages/dashboard.astro` - 6ãƒªãƒ³ã‚¯ï¼ˆå…¨ãƒ—ãƒ©ãƒ³ï¼‰
3. `src/pages/premium-predictions.astro` - 2ãƒªãƒ³ã‚¯
4. `src/pages/standard-predictions.astro` - 2ãƒªãƒ³ã‚¯
5. `src/pages/premium-plus.astro` - 2ãƒªãƒ³ã‚¯
6. `src/pages/premium-sanrenpuku.astro` - 1ãƒªãƒ³ã‚¯
7. `src/pages/archive-sanrenpuku/index.astro` - 1ãƒªãƒ³ã‚¯
8. `src/pages/sanrenpuku-demo.astro` - 1ãƒªãƒ³ã‚¯
9. `src/pages/withdrawal-upsell.astro` - 1ãƒªãƒ³ã‚¯

##### **ç½®æ›å†…å®¹**
```javascript
// Before: Stripe Payment Links
https://buy.stripe.com/5kQ8wP0ulcAMggzgVldby0M

// After: PayPal Payment Links
https://www.paypal.com/webapps/billing/plans/subscribe?plan_id=P-6US56295GW7958014NFRB2BQ
```

---

#### **Phase 3: paypal-webhook.jså®Ÿè£…**

##### **ğŸš¨ é‡è¦ï¼šIPN vs Webhookï¼ˆå°‚é–€å®¶æŒ‡æ‘˜ã«ã‚ˆã‚‹ä¿®æ­£ï¼‰**

**åˆæœŸå®Ÿè£…ãƒŸã‚¹:**
- âŒ IPNï¼ˆå¤ã„ã‚·ã‚¹ãƒ†ãƒ ãƒ»form-urlencodedå½¢å¼ï¼‰ã§å®Ÿè£…
- âŒ querystring.parse()ã§ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰è§£æ
- âŒ IPNæ¤œè¨¼ã‚’å®Ÿè£…

**ä¿®æ­£å¾Œï¼ˆWebhookå½¢å¼ï¼‰:**
- âœ… REST API Webhookï¼ˆJSONå½¢å¼ï¼‰
- âœ… JSON.parse()ã§ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰è§£æ
- âœ… event_idé‡è¤‡æ’é™¤ï¼ˆå†ªç­‰æ€§ä¿è¨¼ï¼‰
- âœ… ProcessedWebhookEventsãƒ†ãƒ¼ãƒ–ãƒ«ã§å‡¦ç†å±¥æ­´ç®¡ç†

##### **å®Ÿè£…å†…å®¹ï¼ˆnetlify/functions/paypal-webhook.jsï¼‰**

**1. Webhookãƒšã‚¤ãƒ­ãƒ¼ãƒ‰è§£æï¼ˆJSONå½¢å¼ï¼‰**
```javascript
const webhookData = JSON.parse(event.body || '{}');
const { id: eventId, event_type: eventType, resource } = webhookData;
```

**2. event_idé‡è¤‡æ’é™¤ï¼ˆå†ªç­‰æ€§ä¿è¨¼ï¼‰**
```javascript
const processedEvents = await base('ProcessedWebhookEvents')
  .select({
    filterByFormula: `{EventId} = "${eventId}"`
  })
  .firstPage()
  .catch(() => []);

if (processedEvents.length > 0) {
  console.log('âš ï¸ é‡è¤‡ã‚¤ãƒ™ãƒ³ãƒˆæ¤œå‡ºãƒ»ã‚¹ã‚­ãƒƒãƒ—:', eventId);
  return { statusCode: 200, ... };
}
```

**3. å‡¦ç†å¯¾è±¡ã‚¤ãƒ™ãƒ³ãƒˆ**
```javascript
const validEventTypes = [
  'BILLING.SUBSCRIPTION.CREATED',   // ã‚µãƒ–ã‚¹ã‚¯ç™»éŒ²
  'BILLING.SUBSCRIPTION.ACTIVATED', // ã‚µãƒ–ã‚¹ã‚¯æœ‰åŠ¹åŒ–
  'PAYMENT.SALE.COMPLETED'          // å˜å“æ±ºæ¸ˆå®Œäº†
];
```

**4. PayPal Plan ID â†’ ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ©ãƒ³åãƒãƒƒãƒ”ãƒ³ã‚°**
```javascript
const planMapping = {
  'P-68H748483T318591TNFRBYMQ': 'Standard',
  'P-6US56295GW7958014NFRB2BQ': 'Premium',
  'P-17K19274A7982913DNFRB3KA': 'Premium Sanrenpuku',
  'P-8KU85292CD447891XNFRB4GI': 'Premium Combo'
};
```

**5. æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã¨ã®çµ±åˆ**
- Airtable Customersãƒ†ãƒ¼ãƒ–ãƒ«ç™»éŒ²/æ›´æ–°
- SendGridã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼ˆæ–°è¦é¡§å®¢ã®ã¿ï¼‰
- ãƒã‚¸ãƒƒã‚¯ãƒªãƒ³ã‚¯ä»˜ããƒ¡ãƒ¼ãƒ«ï¼ˆæ—¢å­˜ã®auth-user.jsé€£æºï¼‰
- æœ‰åŠ¹æœŸé™è‡ªå‹•è¨ˆç®—ï¼ˆã‚µãƒ–ã‚¹ã‚¯: 1ãƒ¶æœˆå¾Œã€Premium Plus: ç„¡æœŸé™ï¼‰

---

#### **Phase 4: Airtableãƒ†ãƒ¼ãƒ–ãƒ«è¿½åŠ **

##### **æ–°è¦ãƒ†ãƒ¼ãƒ–ãƒ«: ProcessedWebhookEvents**

**å½¹å‰²:** Webhooké‡è¤‡å‡¦ç†é˜²æ­¢ï¼ˆå†ªç­‰æ€§ä¿è¨¼ï¼‰

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å | å‹ | å¿…é ˆ | èª¬æ˜ |
|------------|-----|------|------|
| EventId | Single line text | âœ… | PayPal Event IDï¼ˆé‡è¤‡æ’é™¤ã‚­ãƒ¼ï¼‰ |
| EventType | Single line text | âœ… | ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ— |
| ProcessedAt | Date | âœ… | å‡¦ç†é–‹å§‹æ—¥æ™‚ï¼ˆISO 8601ï¼‰ |
| Status | Single select | âœ… | processing / completed / ignored |
| CustomerEmail | Email | âŒ | é¡§å®¢ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ |
| UserPlan | Single line text | âŒ | ãƒ—ãƒ©ãƒ³å |

**é‡è¦æ€§:**
- PayPalã¯åŒã˜Webhookã‚¤ãƒ™ãƒ³ãƒˆã‚’è¤‡æ•°å›é€ä¿¡ã™ã‚‹ã“ã¨ãŒã‚ã‚‹
- EventIdã§é‡è¤‡ãƒã‚§ãƒƒã‚¯ã—ã€æ—¢ã«å‡¦ç†æ¸ˆã¿ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
- åŒã˜æ±ºæ¸ˆã§è¤‡æ•°å›é¡§å®¢ç™»éŒ²ã•ã‚Œã‚‹ã“ã¨ã‚’é˜²ã

---

#### **Phase 5: ãƒ†ã‚¹ãƒˆæˆ¦ç•¥ï¼ˆãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ã‚¢ãƒ—ãƒ­ãƒ¼ãƒï¼‰**

##### **å°‚é–€å®¶ã®æ¨å¥¨æˆ¦ç•¥**

**Phase 1: Webhook Simulatorï¼ˆå³æ™‚å®Ÿæ–½ï¼‰** âœ… æ¡ç”¨
- PayPal Developer Portalã®ã€ŒWebhook Simulatorã€ä½¿ç”¨
- ç–é€šç¢ºèªã®ã¿ï¼ˆå½ã®IDã§ã‚‚å•é¡Œãªã—ï¼‰
- paypal-webhook.js â†’ Airtable â†’ SendGrid ã®é€£æºç¢ºèª
- **ãƒ¡ãƒªãƒƒãƒˆ**: ã‚¼ãƒ­ãƒªã‚¹ã‚¯ãƒ»å³æ™‚ãƒ†ã‚¹ãƒˆå¯èƒ½

**Phase 2: æœ¬ç•ªãƒªãƒªãƒ¼ã‚¹ï¼ˆ1äººç›®ã®é¡§å®¢æ±ºæ¸ˆï¼‰**
- Payment Linksã‚’å…¬é–‹
- PayPalç®¡ç†ç”»é¢ã¨Airtableã‚’ã‚¹ãƒãƒ›ã§ç›£è¦–
- **Resendæ©Ÿèƒ½**: å¤±æ•—æ™‚ã¯PayPalå´ã§ã€ŒWebhook Eventsã€ã‹ã‚‰å†é€å¯èƒ½

**Phase 3: å°†æ¥å¯¾å¿œï¼ˆæ±ºæ¸ˆå¤±æ•—æ™‚ã®è‡ªå‹•åœæ­¢ï¼‰**
- ã€Œä¸å±¥è¡Œã‚µã‚¤ã‚¯ãƒ«ã€ã«ã‚ˆã‚‹è‡ªå‹•åœæ­¢ã‚·ã‚¹ãƒ†ãƒ 
- Sandboxã§ã€Œæ±ºæ¸ˆå¤±æ•—ã‚¤ãƒ™ãƒ³ãƒˆã€ã®æ¤œè¨¼
- **ç¾æ™‚ç‚¹ã§ã¯ä¸è¦**ï¼ˆPhase 2ã§ååˆ†ï¼‰

##### **Sandboxãƒ†ã‚¹ãƒˆã‚’é¿ã‘ã‚‹ç†ç”±**
- âŒ ãƒ†ã‚¹ãƒˆé¡§å®¢ã®è‡ªå‹•ä½œæˆæ©Ÿèƒ½ä¸å®‰å®š
- âŒ å®Ÿéš›ã®æ±ºæ¸ˆãƒ•ãƒ­ãƒ¼ã¨ä¹–é›¢ãŒã‚ã‚‹
- âœ… Webhook Simulatorã§ååˆ†ãªç–é€šç¢ºèªãŒå¯èƒ½
- âœ… æœ¬ç•ª1äººç›®ã®æ±ºæ¸ˆã§ã€ŒResendæ©Ÿèƒ½ã€ã«ã‚ˆã‚‹ãƒªã‚«ãƒãƒªãƒ¼å¯èƒ½

##### **è‡ªå·±æ±ºæ¸ˆãƒ†ã‚¹ãƒˆã‚’é¿ã‘ã‚‹ç†ç”±**
- âš ï¸ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåˆ¶é™ãƒªã‚¹ã‚¯ï¼ˆPayPalãŒè‡ªå·±æ±ºæ¸ˆã‚’æ¤œçŸ¥ã™ã‚‹å¯èƒ½æ€§ï¼‰
- âš ï¸ æ—¢å­˜Stripeé¡§å®¢ã¨æ··åœ¨ã™ã‚‹ãƒªã‚¹ã‚¯
- âœ… Webhook Simulatorã§ä»£æ›¿å¯èƒ½

---

#### **æŠ€è¡“çš„æˆæœ**

**å®Ÿè£…å®Œäº†:**
- âœ… PayPal Payment Links 5ãƒ—ãƒ©ãƒ³ä½œæˆ
- âœ… ã‚µã‚¤ãƒˆå…¨ä½“ã®ãƒªãƒ³ã‚¯æ›´æ–°ï¼ˆ9ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»18ãƒªãƒ³ã‚¯ï¼‰
- âœ… paypal-webhook.js Webhookå½¢å¼å®Ÿè£…
- âœ… event_idé‡è¤‡æ’é™¤ã‚·ã‚¹ãƒ†ãƒ å®Ÿè£…
- âœ… æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ï¼ˆAirtable, SendGrid, Magic Linkï¼‰ã¨ã®å®Œå…¨çµ±åˆ

**å®Ÿè£…å¾…ã¡:**
- â³ ProcessedWebhookEventsãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆï¼ˆãƒã‚³ã•ã‚“ä½œæ¥­ï¼‰
- â³ Webhook Simulatorãƒ†ã‚¹ãƒˆ
- â³ æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤

---

#### **ãƒ“ã‚¸ãƒã‚¹ä¾¡å€¤**

**å³æ™‚åŠ¹æœ:**
- âœ… **Stripeå…¥é‡‘åœæ­¢å•é¡Œã®è§£æ±º**: PayPalã§å³åº§æ±ºæ¸ˆå†é–‹å¯èƒ½
- âœ… **é¡§å®¢ä½“é¨“ç¶­æŒ**: æ—¢å­˜ã®ãƒã‚¸ãƒƒã‚¯ãƒªãƒ³ã‚¯èªè¨¼ãƒ»ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚·ã‚¹ãƒ†ãƒ ãã®ã¾ã¾
- âœ… **æŸ”è»Ÿæ€§ç¢ºä¿**: Stripeå¾©æ—§å¾Œã‚‚ä½µç”¨å¯èƒ½

**é•·æœŸé‹ç”¨ãƒ¡ãƒªãƒƒãƒˆ:**
- âœ… **æ±ºæ¸ˆæ‰‹æ®µã®å¤šæ§˜åŒ–**: Stripe + PayPal 2ãƒãƒ£ãƒãƒ«é‹ç”¨
- âœ… **ãƒªã‚¹ã‚¯åˆ†æ•£**: 1ã¤ã®æ±ºæ¸ˆæ¥­è€…ã«ä¾å­˜ã—ãªã„
- âœ… **é¡§å®¢é¸æŠè‚¢å¢—åŠ **: æ±ºæ¸ˆæ–¹æ³•ã‚’é¸ã¹ã‚‹

---

#### **Phase 6: Webhook Simulatorå®Œå…¨æˆåŠŸãƒ†ã‚¹ãƒˆï¼ˆ2026-01-10 å®Œäº†ï¼‰** ğŸ‰

##### **ãƒ†ã‚¹ãƒˆå®Ÿæ–½çŠ¶æ³**

**ãƒ†ã‚¹ãƒˆå›æ•°: 8å›**
- 1-3å›ç›®: Airtableãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã‚¨ãƒ©ãƒ¼ï¼ˆNameâ†’æ°åã€RegistrationDateâ†’ç™»éŒ²æ—¥ï¼‰
- 4å›ç›®: éå­˜åœ¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼ï¼ˆStripeCustomerId, LastUpdatedå‰Šé™¤ï¼‰
- 5å›ç›®: ç™»éŒ²æ—¥computed fieldã‚¨ãƒ©ãƒ¼ï¼ˆç™»éŒ²æ—¥å‰Šé™¤ãƒ»Airtableè‡ªå‹•ä»˜ä¸ï¼‰
- 6å›ç›®: SendGrid Fromæœªèªè¨¼ã‚¨ãƒ©ãƒ¼ï¼ˆsupport@keiba.link ã«å¤‰æ›´ï¼‰
- 7å›ç›®: æ—¢å­˜é¡§å®¢æ›´æ–°ï¼ˆå‰Šé™¤å‰ã®ãƒ†ã‚¹ãƒˆï¼‰
- **8å›ç›®: å®Œå…¨æˆåŠŸ âœ…**

##### **å®Œå…¨æˆåŠŸãƒ­ã‚°ï¼ˆ2026-01-10 08:05:24ï¼‰**

```
â• æ–°è¦é¡§å®¢ã‚’ç™»éŒ²: customer@example.com âœ¨
âœ… æ–°è¦é¡§å®¢ç™»éŒ²å®Œäº†: recw7FwVALIejIVyW âœ¨
ğŸ“§ ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒ¡ãƒ¼ãƒ«é€ä¿¡é–‹å§‹... âœ¨
âœ… ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒ¡ãƒ¼ãƒ«é€ä¿¡å®Œäº† âœ¨âœ¨âœ¨
Duration: 1452.93 ms
Memory Usage: 129 MB
```

##### **æˆåŠŸè¦å› **

**1. Airtableãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ä¿®æ­£ï¼ˆ3å›ã®åå¾©ï¼‰**
- âŒ `'Name'` â†’ âœ… `'æ°å'`
- âŒ `'RegistrationDate'` â†’ âœ… å‰Šé™¤ï¼ˆAirtableè‡ªå‹•ä»˜ä¸ï¼‰
- âŒ `'StripeCustomerId'`, `'LastUpdated'` â†’ âœ… å‰Šé™¤ï¼ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ä¸å­˜åœ¨ï¼‰

**2. SendGrid Fromèªè¨¼**
- âŒ `nankan.analytics@gmail.com`ï¼ˆæœªèªè¨¼ï¼‰ â†’ âœ… `support@keiba.link`ï¼ˆèªè¨¼æ¸ˆã¿ï¼‰

**3. Simulatorå°‚ç”¨å®‰å…¨å¯¾ç­–**
```javascript
const WEBHOOK_SIMULATOR_PLAN_ID = 'P-5ML4271244454362WXNWU5NQ';
if (!userPlan) {
  if (planId === WEBHOOK_SIMULATOR_PLAN_ID) {
    userPlan = 'Standard';  // ãƒ†ã‚¹ãƒˆç”¨ã®ã¿è¨±å¯
  } else {
    throw new Error(`Unknown plan_id: ${planId}`);  // æœ¬ç•ªã§æœªçŸ¥plan_idã¯æ‹’å¦
  }
}
```

**4. é‡è¤‡ã‚¹ã‚­ãƒƒãƒ—æ©Ÿèƒ½ç¢ºèª**
- 2å›ç›®ã®ãƒ†ã‚¹ãƒˆï¼ˆ07:30:39ï¼‰ã§é‡è¤‡æ¤œå‡ºãƒ»ã‚¹ã‚­ãƒƒãƒ—ç¢ºèª
- Duration: 2523.6 ms â†’ 217.16 msï¼ˆ91%çŸ­ç¸®ï¼‰

##### **æ¤œè¨¼å®Œäº†é …ç›®**

| é …ç›® | çµæœ |
|------|------|
| PayPal Webhookå—ä¿¡ | âœ… æˆåŠŸ |
| email/planId/customerNameå–å¾— | âœ… æˆåŠŸ |
| Simulatoråˆ¤å®šâ†’Standard | âœ… æˆåŠŸ |
| Airtableæ–°è¦é¡§å®¢ç™»éŒ² | âœ… æˆåŠŸ |
| SendGridã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒ¡ãƒ¼ãƒ«é€ä¿¡ | âœ… æˆåŠŸ |
| ã‚¨ãƒ©ãƒ¼ãƒ«ãƒ¼ãƒ—å¯¾ç­– | âœ… æˆåŠŸ |
| é‡è¤‡ã‚¹ã‚­ãƒƒãƒ—æ©Ÿèƒ½ | âœ… æˆåŠŸ |
| Emailå˜ä½CRMæŒ™å‹• | âœ… æˆåŠŸ |

##### **Airtableæœ€çµ‚æ§‹æˆ**

**Customersãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆæ–°è¦ç™»éŒ²æ™‚ï¼‰:**
```javascript
{
  'Email': email,
  'æ°å': customerName,
  'ãƒ—ãƒ©ãƒ³': userPlan,
  'æœ‰åŠ¹æœŸé™': expiryDateStr,
  'WithdrawalRequested': false
  // âœ… ç™»éŒ²æ—¥: Airtableè‡ªå‹•ä»˜ä¸
}
```

**ProcessedWebhookEventsãƒ†ãƒ¼ãƒ–ãƒ«:**
```javascript
{
  'EventId': eventId,
  'EventType': eventType,
  'ProcessedAt': new Date().toISOString(),
  'Status': 'processing',  // â†’ æœ€å¾Œã« 'completed'
  'CustomerEmail': email,
  'UserPlan': userPlan
}
```

##### **å°‚é–€å®¶ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å¯¾å¿œ**

**1. IPN vs Webhookä¿®æ­£**
- å°‚é–€å®¶æŒ‡æ‘˜: ã€ŒPayPalã¯ä»Šã‚„ã‚‹ã¹ãã¯ Webhookç½²åæ¤œè¨¼ã®æ–¹ã§ã™ã€
- å¯¾å¿œ: IPNå½¢å¼ â†’ Webhookå½¢å¼ï¼ˆJSONï¼‰ã«å®Œå…¨æ›¸ãæ›ãˆ

**2. plan_idå®‰å…¨å¯¾ç­–**
- å°‚é–€å®¶æŒ‡æ‘˜: ã€Œ`|| 'Standard'` ã¯å±é™ºã€‚æœªçŸ¥plan_idã¯æœ¬ç•ªã§ã‚¨ãƒ©ãƒ¼ã«ã™ã¹ãã€
- å¯¾å¿œ: Simulatorå°‚ç”¨ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè£…

**3. ç™»éŒ²æ—¥ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰**
- å°‚é–€å®¶æŒ‡æ‘˜: ã€Œç™»éŒ²æ—¥ã¯computed fieldã§æ›¸ãè¾¼ã¿ä¸å¯ã€‚å‰Šé™¤ãŒæœ€çŸ­ã€
- å¯¾å¿œ: ç™»éŒ²æ—¥ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å‰Šé™¤ãƒ»Airtableè‡ªå‹•ä»˜ä¸ã«å¤‰æ›´

**4. ã‚¨ãƒ©ãƒ¼ãƒ«ãƒ¼ãƒ—å¯¾ç­–**
- å°‚é–€å®¶æŒ‡æ‘˜: ã€Œå‡¦ç†é–‹å§‹æ™‚ã«å³åº§è¨˜éŒ²ã™ã¹ãã€
- ç¢ºèª: æ—¢ã«å®Ÿè£…æ¸ˆã¿ï¼ˆLine 79-87: Status='processing'ã§å…ˆè¡Œè¨˜éŒ²ï¼‰

---

#### **æŠ€è¡“çš„æˆæœï¼ˆæœ€çµ‚ç‰ˆï¼‰**

**å®Ÿè£…å®Œäº†:**
- âœ… PayPal Payment Links 5ãƒ—ãƒ©ãƒ³ä½œæˆ
- âœ… ã‚µã‚¤ãƒˆå…¨ä½“ã®ãƒªãƒ³ã‚¯æ›´æ–°ï¼ˆ9ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»18ãƒªãƒ³ã‚¯ï¼‰
- âœ… paypal-webhook.js Webhookå½¢å¼å®Ÿè£…
- âœ… event_idé‡è¤‡æ’é™¤ã‚·ã‚¹ãƒ†ãƒ å®Ÿè£…
- âœ… Simulatorå°‚ç”¨å®‰å…¨å¯¾ç­–å®Ÿè£…
- âœ… Airtableãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æœ€é©åŒ–ï¼ˆæ—¥æœ¬èªå¯¾å¿œï¼‰
- âœ… SendGrid Fromèªè¨¼å¯¾å¿œ
- âœ… ProcessedWebhookEventsãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- âœ… **Webhook Simulatorå®Œå…¨æˆåŠŸãƒ†ã‚¹ãƒˆ** ğŸ‰
- âœ… æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ï¼ˆAirtable, SendGrid, Magic Linkï¼‰ã¨ã®å®Œå…¨çµ±åˆ

**å®Œæˆåº¦: 100%**

---

#### **ãƒ“ã‚¸ãƒã‚¹ä¾¡å€¤ï¼ˆæœ€çµ‚ç‰ˆï¼‰**

**å³æ™‚åŠ¹æœ:**
- âœ… **Stripeå…¥é‡‘åœæ­¢å•é¡Œã®å®Œå…¨è§£æ±º**: PayPalã§æ±ºæ¸ˆå†é–‹å¯èƒ½
- âœ… **é¡§å®¢ä½“é¨“ç¶­æŒ**: æ—¢å­˜ã®ãƒã‚¸ãƒƒã‚¯ãƒªãƒ³ã‚¯èªè¨¼ãƒ»ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚·ã‚¹ãƒ†ãƒ ãã®ã¾ã¾
- âœ… **æŸ”è»Ÿæ€§ç¢ºä¿**: Stripeå¾©æ—§å¾Œã‚‚ä½µç”¨å¯èƒ½
- âœ… **æœ¬ç•ªæº–å‚™å®Œäº†**: Webhookçµ±åˆå®Œå…¨å‹•ä½œç¢ºèªæ¸ˆã¿

**é•·æœŸé‹ç”¨ãƒ¡ãƒªãƒƒãƒˆ:**
- âœ… **æ±ºæ¸ˆæ‰‹æ®µã®å¤šæ§˜åŒ–**: Stripe + PayPal 2ãƒãƒ£ãƒãƒ«é‹ç”¨
- âœ… **ãƒªã‚¹ã‚¯åˆ†æ•£**: 1ã¤ã®æ±ºæ¸ˆæ¥­è€…ã«ä¾å­˜ã—ãªã„
- âœ… **é¡§å®¢é¸æŠè‚¢å¢—åŠ **: æ±ºæ¸ˆæ–¹æ³•ã‚’é¸ã¹ã‚‹
- âœ… **äºŒé‡ä¼šå“¡é˜²æ­¢**: Emailå˜ä½ã§ä¸€è²«ç®¡ç†

---

#### **ä»Šå¾Œã®æ¨å¥¨å¯¾å¿œï¼ˆå„ªå…ˆåº¦é †ï¼‰**

**Phase 1: æœ¬ç•ªé‹ç”¨é–‹å§‹ï¼ˆå³åº§å®Ÿæ–½å¯èƒ½ï¼‰** âœ…
1. Payment Linkså…¬é–‹æ¸ˆã¿ï¼ˆæ—¢ã«ã‚µã‚¤ãƒˆã«æ²è¼‰ä¸­ï¼‰
2. 1äººç›®ã®é¡§å®¢æ±ºæ¸ˆå¾…ã¡
3. PayPalç®¡ç†ç”»é¢ + Airtableã§ç›£è¦–
4. å•é¡Œç™ºç”Ÿæ™‚: PayPalã€ŒWebhook Eventsã€ã‹ã‚‰Resendå¯èƒ½

**Phase 2: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ï¼ˆå°†æ¥å®Ÿè£…ï¼‰**
1. Webhookç½²åæ¤œè¨¼å®Ÿè£…
   - PayPalå…¬å¼è¨¼æ˜æ›¸ã§ç½²åæ¤œè¨¼
   - å½è£…Webhookæ”»æ’ƒå¯¾ç­–
2. æœ¬ç•ªPAYMENTå®Œäº†ã‚¤ãƒ™ãƒ³ãƒˆå¯¾å¿œ
   - `BILLING.SUBSCRIPTION.ACTIVATED` â†’ ãƒ†ã‚¹ãƒˆç”¨ï¼ˆä»®ç™»éŒ²ï¼‰
   - `PAYMENT.SALE.COMPLETED` â†’ æœ¬ç•ªç”¨ï¼ˆæœ¬ç™»éŒ²ï¼‰
   - `BILLING.SUBSCRIPTION.PAYMENT.COMPLETED` â†’ ã‚µãƒ–ã‚¹ã‚¯æ±ºæ¸ˆå®Œäº†

**Phase 3: Stripeå¾©æ—§å¯¾å¿œï¼ˆ2026-01-13ä»¥é™ï¼‰**
1. StripeçŠ¶æ³ç¢ºèª
2. Stripe/PayPalä½µç”¨ç¶™ç¶šåˆ¤æ–­
3. é¡§å®¢ã¸ã®ã‚¢ãƒŠã‚¦ãƒ³ã‚¹

---

#### **æ•™è¨“ãƒ»å­¦ã³**

**1. å°‚é–€å®¶ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã®é‡è¦æ€§**
- IPN vs Webhookã€plan_idå®‰å…¨å¯¾ç­–ã€ç™»éŒ²æ—¥ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãªã©ã€å°‚é–€å®¶ã®æŒ‡æ‘˜ã§å¤§å¹…æ”¹å–„
- è‡ªå·±åˆ¤æ–­ã ã‘ã§ãªãã€å¤–éƒ¨è¦–ç‚¹ã‚’ç©æ¥µçš„ã«å–ã‚Šå…¥ã‚Œã‚‹

**2. Airtable computed field ã®åˆ¶ç´„**
- æ›¸ãè¾¼ã¿ä¸å¯ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å­˜åœ¨ã‚’äº‹å‰ç¢ºèªã™ã¹ã
- Airtableè‡ªå‹•ä»˜ä¸æ©Ÿèƒ½ã‚’ç©æ¥µæ´»ç”¨

**3. SendGrid Fromèªè¨¼ã®å¿…é ˆæ€§**
- æœªèªè¨¼ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯å®Œå…¨æ‹’å¦ã•ã‚Œã‚‹
- Single Sender or Domain Authenticationå¿…é ˆ

**4. æ®µéšçš„ãƒ†ã‚¹ãƒˆæˆ¦ç•¥ã®æœ‰åŠ¹æ€§**
- Webhook Simulator â†’ æœ¬ç•ª1äººç›®æ±ºæ¸ˆ â†’ Resendæ©Ÿèƒ½ ã®æ®µéšçš„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ
- Sandboxä¸è¦ã€è‡ªå·±æ±ºæ¸ˆä¸è¦ã§ãƒªã‚¹ã‚¯æœ€å°åŒ–

**5. ã‚¨ãƒ©ãƒ¼ãƒ«ãƒ¼ãƒ—å¯¾ç­–ã®è¨­è¨ˆé‡è¦æ€§**
- å‡¦ç†é–‹å§‹æ™‚ã«å³åº§è¨˜éŒ²ï¼ˆStatus='processing'ï¼‰
- event_idé‡è¤‡ãƒã‚§ãƒƒã‚¯ã§å†ªç­‰æ€§ä¿è¨¼
- PayPalå†é€ã«è€ãˆã‚‰ã‚Œã‚‹è¨­è¨ˆ

---

### âœ… **2026-01-11 PayPal Webhookæœ¬ç•ªä»•æ§˜å®Ÿè£…å®Œäº†ï¼ˆãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ã‚¢ãƒ—ãƒ­ãƒ¼ãƒï¼‰**

#### **å®Ÿè£…èƒŒæ™¯ï¼šå°‚é–€å®¶ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã«ã‚ˆã‚‹æ–¹é‡è»¢æ›**

**Phase 5ã¾ã§ã®å•é¡Œç‚¹ï¼š**
- `BILLING.SUBSCRIPTION.PAYMENT.COMPLETED` ã‚¤ãƒ™ãƒ³ãƒˆãŒå­˜åœ¨ã—ãªã„ï¼ˆPayPal APIã«å­˜åœ¨ã—ãªã„ï¼‰
- ACTIVATED ã‚’ã€Œä»®ç™»éŒ²ã€æ‰±ã„ã—ã¦ã„ãŸãŒã€å®Ÿéš›ã«ã¯æœ¬ç™»éŒ²ã™ã¹ã

**å°‚é–€å®¶ã®æ¨å¥¨ï¼ˆãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ã‚¢ãƒ—ãƒ­ãƒ¼ãƒï¼‰ï¼š**
```
âœ… æ–¹é‡ï¼šæ¨©é™ä»˜ä¸ã¯ ACTIVATEDã€å…¥é‡‘ã¯ SALE

ACTIVATED ãŒæ¥ãŸã‚‰
- Customers ã‚’ã€Œæœ¬ç™»éŒ²æ‰±ã„ã€ã«ã—ã¦OKï¼ˆAccessEnabled=true ã‚‚ã“ã“ã§OKï¼‰
- Status = active
- PayPalSubscriptionID ã‚’ä¿å­˜
- WelcomeSentAt ã‚’å…¥ã‚Œã¦ã‚¦ã‚§ãƒ«ã‚«ãƒ é€ä¿¡ï¼ˆâ€»äºŒé‡é€ä¿¡é˜²æ­¢ãŒå‰æï¼‰

PAYMENT.SALE.COMPLETED ãŒæ¥ãŸã‚‰
- PaidAt ã‚’æ›´æ–°ï¼ˆï¼‹å¿…è¦ãªã‚‰å»¶é•·å‡¦ç†ï¼‰
```

**ç†ç”±ï¼š**
- `BILLING.SUBSCRIPTION.ACTIVATED` ã¯ã€Œå¥‘ç´„ãŒACTIVEã«ãªã£ãŸã€é€šçŸ¥
- ç„¡æ–™ãƒˆãƒ©ã‚¤ã‚¢ãƒ«é–‹å§‹ã§ã‚‚æ¥ã‚‹ã€ä¸ä¿¡ã ã‘ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã‚‚æ¥ã‚‹
- ã—ã‹ã—ã€**æœ‰æ–™ãƒ—ãƒ©ãƒ³ã§ã¯åˆå›æ±ºæ¸ˆå®Œäº†ã‚’æ„å‘³ã™ã‚‹ã“ã¨ãŒå¤šã„**
- â†’ æ¨©é™ä»˜ä¸ã¯ ACTIVATEDã€å…¥é‡‘ç¢ºèªã¯ PAYMENT.SALE.COMPLETED ã§åˆ†é›¢

---

#### **å®Ÿè£…å†…å®¹**

##### **1. validEventTypesæ›´æ–°**
```javascript
const validEventTypes = [
  'BILLING.SUBSCRIPTION.CREATED',             // ã‚µãƒ–ã‚¹ã‚¯ç™»éŒ²ï¼ˆä»®ç™»éŒ²ï¼‰
  'BILLING.SUBSCRIPTION.ACTIVATED',           // ã‚µãƒ–ã‚¹ã‚¯æœ‰åŠ¹åŒ–ï¼ˆæœ¬ç™»éŒ²ï¼‰ âœ¨
  'PAYMENT.SALE.COMPLETED',                   // å˜å“æ±ºæ¸ˆå®Œäº† or ã‚µãƒ–ã‚¹ã‚¯å…¥é‡‘ç¢ºèª
  'BILLING.SUBSCRIPTION.CANCELLED',           // ã‚µãƒ–ã‚¹ã‚¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆæ¨©é™å‰¥å¥ªï¼‰
  'BILLING.SUBSCRIPTION.SUSPENDED',           // ã‚µãƒ–ã‚¹ã‚¯åœæ­¢ï¼ˆæ¨©é™å‰¥å¥ªï¼‰
  'BILLING.SUBSCRIPTION.EXPIRED'              // ã‚µãƒ–ã‚¹ã‚¯æœŸé™åˆ‡ã‚Œï¼ˆæ¨©é™å‰¥å¥ªï¼‰
];
```

**å¤‰æ›´ç‚¹ï¼š**
- âŒ `BILLING.SUBSCRIPTION.PAYMENT.COMPLETED` å‰Šé™¤ï¼ˆå­˜åœ¨ã—ãªã„ï¼‰
- âœ… `BILLING.SUBSCRIPTION.ACTIVATED` â†’ æœ¬ç™»éŒ²

##### **2. ã‚¤ãƒ™ãƒ³ãƒˆã‚«ãƒ†ã‚´ãƒªåˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯**
```javascript
if (eventType === 'BILLING.SUBSCRIPTION.ACTIVATED') {
  eventCategory = 'payment'; // æœ¬ç™»éŒ²ï¼ˆå°‚é–€å®¶æ¨å¥¨ï¼‰
} else if (eventType === 'BILLING.SUBSCRIPTION.CREATED') {
  eventCategory = 'pending'; // ä»®ç™»éŒ²
}
```

##### **3. PAYMENT.SALE.COMPLETEDåˆ†å²å‡¦ç†**
```javascript
if (billingAgreementId) {
  // ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³æ±ºæ¸ˆã®å ´åˆï¼šPaidAtæ›´æ–°ã®ã¿
  subscriptionId = billingAgreementId;
  eventCategory = 'payment_confirmation'; // å…¥é‡‘ç¢ºèªã®ã¿
} else {
  // Premium Pluså˜å“æ±ºæ¸ˆã®å ´åˆï¼šæœ¬ç™»éŒ²å‡¦ç†
  userPlan = 'Premium Plus';
  eventCategory = 'payment'; // æœ¬ç™»éŒ²
}
```

##### **4. å…¥é‡‘ç¢ºèªå‡¦ç†ï¼ˆpayment_confirmationï¼‰**
```javascript
else if (eventCategory === 'payment_confirmation') {
  console.log('ğŸ’° å…¥é‡‘ç¢ºèªå‡¦ç†ï¼ˆPaidAtæ›´æ–°ã®ã¿ï¼‰:', email);

  customerRecord = await base('Customers').update(recordId, {
    'PaidAt': now.toISOString()
  });
}
```

---

#### **ãƒ†ã‚¹ãƒˆçµæœï¼ˆWebhook Simulatorï¼‰**

##### **ACTIVATED ãƒ†ã‚¹ãƒˆï¼ˆæœ¬ç™»éŒ²ï¼‰**
```
ğŸ“§ Email: customer@example.com
ğŸ“¦ User Plan: Standard
ğŸ·ï¸ Event Category: payment
ğŸ’° æœ¬ç™»éŒ²å‡¦ç†ï¼ˆæ±ºæ¸ˆå®Œäº†ï¼‰: customer@example.com
âœ… æ–°è¦é¡§å®¢ã‚’æœ¬ç™»éŒ²: recxgvFag1E21RYcU
ğŸ“§ ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒ¡ãƒ¼ãƒ«é€ä¿¡é–‹å§‹...
âœ… ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒ¡ãƒ¼ãƒ«é€ä¿¡å®Œäº†
âœ… WelcomeSentAtè¨˜éŒ²å®Œäº†
```

**Airtableç¢ºèªçµæœï¼š**
| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | å€¤ | çŠ¶æ…‹ |
|-----------|-----|-----|
| Email | customer@example.com | âœ… |
| ãƒ—ãƒ©ãƒ³ | Standard | âœ… |
| Status | `active` | âœ… |
| AccessEnabled | `true` | âœ… |
| WelcomeSentAt | 2026-01-11T13:16:48 | âœ… |
| PayPalSubscriptionID | I-BW452GLLEP1G | âœ… |
| PaidAt | 2026-01-11 22:16 | âœ… |

---

#### **æŠ€è¡“çš„æˆæœ**

**1. æ­£ç¢ºãªã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†**
- âœ… PayPal APIã«å­˜åœ¨ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã®ã¿ä½¿ç”¨
- âœ… ACTIVATED â†’ æœ¬ç™»éŒ²ï¼ˆå°‚é–€å®¶æ¨å¥¨ï¼‰
- âœ… CREATED â†’ ä»®ç™»éŒ²
- âœ… PAYMENT.SALE.COMPLETED â†’ å…¥é‡‘ç¢ºèª or Premium Plusæœ¬ç™»éŒ²

**2. ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã®åˆ©ç‚¹**
- âœ… **å³åº§ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©ä»˜ä¸**: ACTIVATED ã§å³åº§ã«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„é–²è¦§å¯èƒ½
- âœ… **å…¥é‡‘ç¢ºèªã®åˆ†é›¢**: PAYMENT.SALE.COMPLETED ã§å®Ÿéš›ã®å…¥é‡‘ã‚’è¨˜éŒ²
- âœ… **Premium Pluså¯¾å¿œ**: å˜å“æ±ºæ¸ˆã‚‚åŒã˜ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§å‡¦ç†

**3. äº‹æ•…é˜²æ­¢å¯¾ç­–**
- âœ… WelcomeSentAté‡è¤‡é˜²æ­¢ï¼ˆæ—¢ã«é€ä¿¡æ¸ˆã¿ãªã‚‰å†é€ã—ãªã„ï¼‰
- âœ… event_idé‡è¤‡æ’é™¤ï¼ˆåŒã˜ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¤‡æ•°å›å‡¦ç†ã—ãªã„ï¼‰
- âœ… ãƒ¡ãƒ¼ãƒ«æŠ½å‡ºãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã«ãƒ¡ãƒ¼ãƒ«å–å¾—å¤±æ•—ã—ã¦ã‚‚å¾©å…ƒå¯èƒ½ï¼‰

---

#### **ãƒ“ã‚¸ãƒã‚¹ä¾¡å€¤**

**1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã®æ”¹å–„**
- âœ… **å³åº§ã®ã‚¢ã‚¯ã‚»ã‚¹**: æ±ºæ¸ˆå®Œäº†å¾Œã€å³åº§ã«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„é–²è¦§å¯èƒ½
- âœ… **ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒ¡ãƒ¼ãƒ«**: è‡ªå‹•é€ä¿¡ã§ã‚ªãƒ³ãƒœãƒ¼ãƒ‡ã‚£ãƒ³ã‚°å®Œäº†
- âœ… **é‡è¤‡é€ä¿¡ãªã—**: WelcomeSentAtã§äºŒé‡é€ä¿¡é˜²æ­¢

**2. é‹ç”¨åŠ¹ç‡åŒ–**
- âœ… **å®Œå…¨è‡ªå‹•åŒ–**: æ‰‹å‹•ã§ã®é¡§å®¢ç™»éŒ²ä¸è¦
- âœ… **ã‚¨ãƒ©ãƒ¼è€æ€§**: PayPalå†é€ã«å®Œå…¨å¯¾å¿œ
- âœ… **ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°**: è©³ç´°ãªãƒ­ã‚°ã§ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°å®¹æ˜“

**3. æŸ”è»Ÿæ€§**
- âœ… **Stripeä½µç”¨å¯èƒ½**: æ—¢å­˜Stripeé¡§å®¢ã¨å…±å­˜
- âœ… **Premium Pluså¯¾å¿œ**: ã‚µãƒ–ã‚¹ã‚¯ãƒ»å˜å“æ±ºæ¸ˆã®ä¸¡æ–¹å¯¾å¿œ
- âœ… **å°†æ¥æ‹¡å¼µæ€§**: SUSPENDED/EXPIREDå¯¾å¿œæ¸ˆã¿

---

#### **ãƒ‡ãƒ—ãƒ­ã‚¤æƒ…å ±**
- **ã‚³ãƒŸãƒƒãƒˆ**: `647ec73`
- **æ—¥æ™‚**: 2026-01-11 22:16
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `netlify/functions/paypal-webhook.js`
- **å¤‰æ›´**: 60è¡ŒæŒ¿å…¥ã€19è¡Œå‰Šé™¤

---

#### **æ•™è¨“ãƒ»å­¦ã³**

**1. PayPal APIã®æ­£ç¢ºãªç†è§£**
- âŒ `BILLING.SUBSCRIPTION.PAYMENT.COMPLETED` ã¯å­˜åœ¨ã—ãªã„
- âœ… `BILLING.SUBSCRIPTION.ACTIVATED` ãŒæœ¬ç™»éŒ²ã‚¤ãƒ™ãƒ³ãƒˆ
- âœ… `PAYMENT.SALE.COMPLETED` ã¯ã‚µãƒ–ã‚¹ã‚¯å…¥é‡‘ç¢ºèª or å˜å“æ±ºæ¸ˆ

**2. å°‚é–€å®¶ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã®ä¾¡å€¤**
- ã€ŒACTIVATED ã¯åˆå›æ±ºæ¸ˆå®Œäº†ã‚’æ„å‘³ã™ã‚‹ã“ã¨ãŒå¤šã„ã€ã¨ã„ã†å®Ÿå‹™çŸ¥è­˜
- ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã®ææ¡ˆã§ã€å³åº§ã‚¢ã‚¯ã‚»ã‚¹+å…¥é‡‘ç¢ºèªã®ä¸¡ç«‹

**3. æ®µéšçš„å®Ÿè£…ã®é‡è¦æ€§**
- Phase 5: 3æ®µéšçŠ¶æ…‹ç®¡ç†ï¼ˆpending â†’ payment â†’ cancellationï¼‰
- Phase 6: ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ã‚¢ãƒ—ãƒ­ãƒ¼ãƒï¼ˆACTIVATEDæœ¬ç™»éŒ²+SALEå…¥é‡‘ç¢ºèªï¼‰
- æœ€åˆã‹ã‚‰å®Œç’§ã‚’ç›®æŒ‡ã•ãšã€å°‚é–€å®¶ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã§æ”¹å–„

**4. ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™º**
- Webhook Simulator ã§å³åº§ã«ãƒ†ã‚¹ãƒˆå¯èƒ½
- Airtableç¢ºèªã§çŠ¶æ…‹é·ç§»ã‚’ç›®è¦–ç¢ºèª
- Netlify Function Logsã§è©³ç´°ãƒ‡ãƒãƒƒã‚°

---

#### **Phase 6 å®Œå…¨æˆåŠŸ ğŸ‰**
- âœ… validEventTypesæ›´æ–°ï¼ˆæœ¬ç•ªä»•æ§˜ï¼‰
- âœ… ACTIVATED/CREATEDä»®ç™»éŒ²å®Ÿè£…ï¼ˆStatus:pendingï¼‰
- âœ… PAYMENT.COMPLETEDæœ¬ç™»éŒ²å®Ÿè£…ï¼ˆStatus:activeï¼‰
- âœ… CANCELLED/SUSPENDED/EXPIREDå‰¥å¥ªå®Ÿè£…
- âœ… ãƒ¡ãƒ¼ãƒ«æŠ½å‡ºãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè£…
- âœ… WelcomeSentAté‡è¤‡é˜²æ­¢å®Ÿè£…
- âœ… ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†
- âœ… Webhook Simulatorãƒ†ã‚¹ãƒˆæˆåŠŸ
- âœ… CLAUDE.mdæ›´æ–°å®Œäº†

**æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼š**
1. æœ¬ç•ª1äººç›®ã®é¡§å®¢æ±ºæ¸ˆå¾…ã¡
2. PayPalç®¡ç†ç”»é¢ + Airtableã§ç›£è¦–
3. å•é¡Œç™ºç”Ÿæ™‚: PayPalã€ŒWebhook Eventsã€ã‹ã‚‰Resendå¯èƒ½

---

#### **Phase 7: PAYMENT.SALE.COMPLETED emailå¿…é ˆç·©å’Œå®Ÿè£…ï¼ˆ2026-01-11 å®Œäº†ï¼‰** ğŸ‰

##### **èƒŒæ™¯ï¼šå°‚é–€å®¶ã‹ã‚‰ã®æœ€çµ‚ãƒã‚§ãƒƒã‚¯**

**Phase 6ã¾ã§ã®æ®‹èª²é¡Œï¼š**
- Webhook Simulatorã®PAYMENT.SALE.COMPLETEDã§PaidAtãŒå…¥ã‚‰ãªã„
- emailå¿…é ˆãƒã‚§ãƒƒã‚¯ã§å‡¦ç†ãŒè½ã¡ã‚‹

**å°‚é–€å®¶ã®æŒ‡æ‘˜ï¼š**
> PAYMENT.SALE.COMPLETED ã§ã¯ email ãŒå…¥ã£ã¦ã„ã¾ã›ã‚“ã€‚
> ãã®çµæœã€ã‚ãªãŸã®ãƒãƒ³ãƒ‰ãƒ©ãŒ "Missing required field: email" ã§è½ã¡ã¦ PaidAtæ›´æ–°å‡¦ç†ã¾ã§åˆ°é”ã§ããªã„ã€‚

**æ¨å¥¨å¯¾å¿œï¼š**
- âœ… ã€ŒemailãŒç„¡ã„ãªã‚‰ subscriptionId ã§å¼•ãã€
- âœ… ã€Œãã‚Œã‚‚ç„¡ã„ãªã‚‰ã‚¹ã‚­ãƒƒãƒ—ã—ã¦200ã€
- âœ… è½ã¨ã•ãªã„è¨­è¨ˆï¼ˆWebhookå†é€ãƒ«ãƒ¼ãƒ—é˜²æ­¢ï¼‰

---

##### **å®Ÿè£…å†…å®¹**

**1. PayPalSubscriptionIDæ¤œç´¢å¤±æ•—æ™‚ã®throwå‰Šé™¤**
```javascript
// ä¿®æ­£å‰ï¼ˆLine 196ï¼‰
throw new Error(`Subscription not found: ${subscriptionId}`);

// ä¿®æ­£å¾Œï¼ˆLine 196-198ï¼‰
console.log('âš ï¸ æœªçŸ¥ã®ã‚µãƒ–ã‚¹ã‚¯å…¥é‡‘ãƒ»é¡§å®¢ç‰¹å®šä¸å¯ï¼ˆSubscriptionID:', subscriptionId, 'ï¼‰â†’ ã‚¹ã‚­ãƒƒãƒ—');
// emailãŒç„¡ã„ã¾ã¾ç¶šè¡Œ â†’ Line 234ã®ãƒã‚§ãƒƒã‚¯ã§å®‰å…¨ã«ã‚¹ã‚­ãƒƒãƒ—
```

**2. emailå¿…é ˆãƒã‚§ãƒƒã‚¯æ¡ä»¶ä»˜ãåŒ–**
```javascript
// ä¿®æ­£å‰ï¼ˆLine 232-234ï¼‰
if (!email) {
  throw new Error('Missing required field: email');
}

// ä¿®æ­£å¾Œï¼ˆLine 234-251ï¼‰
if (!email) {
  if (eventCategory === 'payment_confirmation') {
    // å…¥é‡‘ç¢ºèªã¯emailç„¡ã—ã§ã‚‚OKï¼ˆSubscriptionIDã§ç‰¹å®šã§ããªã‹ã£ãŸå ´åˆï¼‰
    console.log('âš ï¸ Emailç‰¹å®šä¸å¯ãƒ»å…¥é‡‘ç¢ºèªã‚¹ã‚­ãƒƒãƒ—ï¼ˆSubscriptionID:', subscriptionId, ')');
    // é‡è¤‡æ’é™¤è¨˜éŒ²ã¯æ®‹ã™ï¼ˆå†å‡¦ç†é˜²æ­¢ï¼‰
    await base('ProcessedWebhookEvents').update(processedRecord.id, {
      'Status': 'completed'
    });
    return {
      statusCode: 200,
      body: JSON.stringify({ message: 'Unknown subscription sale skipped', eventId })
    };
  } else {
    // ãã®ä»–ã®ã‚¤ãƒ™ãƒ³ãƒˆã¯emailå¿…é ˆ
    throw new Error('Missing required field: email');
  }
}
```

**3. ãƒ­ã‚°é€æ˜æ€§å‘ä¸Šï¼ˆsubscriptionIDä½µè¨˜ï¼‰**
```javascript
// Line 194, 359, 366, 368 ã§subscriptionIDã‚’ä½µè¨˜
console.log('âœ… ã‚µãƒ–ã‚¹ã‚¯å…¥é‡‘ç¢ºèª:', email, '(SubscriptionID:', subscriptionId, ')');
console.log('ğŸ’° å…¥é‡‘ç¢ºèªå‡¦ç†ï¼ˆPaidAtæ›´æ–°ã®ã¿ï¼‰:', email, '(SubscriptionID:', subscriptionId, ')');
console.log('âœ… PaidAtæ›´æ–°å®Œäº†:', recordId, '(SubscriptionID:', subscriptionId, ')');
```

---

##### **å°‚é–€å®¶ã®æœ€çµ‚è©•ä¾¡ï¼ˆ2026-01-11ï¼‰**

**âœ… ç¾åœ¨ã®çŠ¶æ…‹ã¯ã€Œå®Œæˆå½¢ã€**

> ã‚ãªãŸãŒå…¥ã‚ŒãŸä¿®æ­£ã¯ã€PayPal Ã— ã‚µãƒ–ã‚¹ã‚¯ Ã— Webhook ã® **ç¾å®Ÿè§£ãã®ã‚‚ã®**ã§ã™ã€‚

**æŠ€è¡“çš„ã«æ­£ã—ã„ç‚¹ï¼š**
1. âœ… PAYMENT.SALE.COMPLETED ã§ email å¿…é ˆã‚’ã‚„ã‚ãŸ â†’ PayPalã®å®Ÿãƒ‡ãƒ¼ã‚¿ä»•æ§˜ã«å®Œå…¨ã«é©åˆ
2. âœ… PayPalSubscriptionID ã‚’ å”¯ä¸€ã®ä¿¡é ¼ã‚­ãƒ¼ã«ã—ãŸ â†’ Stripeçš„ãªã€Œcustomer_id é‹ç”¨ã€ã¨åŒã˜å®‰å…¨è¨­è¨ˆ
3. âœ… é¡§å®¢ç‰¹å®šã§ããªã„ sale ã‚’ è½ã¨ã•ãš 200 ã§æ¡ã‚Šæ½°ã™ â†’ Webhookå†é€ãƒ«ãƒ¼ãƒ—ãƒ»éšœå®³é€£é–ã‚’å®Œå…¨å›é¿
4. âœ… ProcessedWebhookEvents ã‚’ å¿…ãš completed ã«ã™ã‚‹ â†’ å†ªç­‰æ€§ãŒå´©ã‚Œãªã„

> ã“ã‚Œã¯ã€Œæ•™ç§‘æ›¸çš„ã«æ­£ã—ã„ã€ã§ã¯ãªãã€**å®Ÿé‹ç”¨ã§å£Šã‚Œãªã„è¨­è¨ˆ**ã§ã™ã€‚

**PaidAtãŒå…¥ã‚‰ãªã„ä»¶ã«ã¤ã„ã¦ï¼š**
> ã€ŒPaidAtãŒå…¥ã‚‰ãªã„ã€ã“ã‚Œã¯ ä»Šã®ãƒ†ã‚¹ãƒˆæ¡ä»¶ã§ã¯**æ­£å¸¸**ã§ã™ã€‚
>
> Webhook Simulator ã® PAYMENT.SALE.COMPLETED ã¯ email ãªã— + subscriptionIDä¸ä¸€è‡´ã®ãŸã‚ã€æ›´æ–°å¯¾è±¡ãŒå­˜åœ¨ã—ãªã„ã€‚
> ã“ã‚Œã¯ **è¨­è¨ˆãƒŸã‚¹ã§ã¯ãªãã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®é™ç•Œ** ã§ã™ã€‚
>
> æœ¬ç‰©ã®ã‚µãƒ–ã‚¹ã‚¯æ±ºæ¸ˆã§ã¯ï¼š
> 1. BILLING.SUBSCRIPTION.ACTIVATED â†’ Customersä½œæˆï¼ˆPayPalSubscriptionIDä¿å­˜ï¼‰
> 2. PAYMENT.SALE.COMPLETED â†’ åŒã˜PayPalSubscriptionIDã§æ¥ã‚‹
> 3. â†’ PaidAt ã¯**ç¢ºå®Ÿã«æ›´æ–°ã•ã‚Œã¾ã™**

**æœ€çµ‚è©•ä¾¡ï¼š**
> ä»Šå›ã®å®Ÿè£…ã¯ï¼š
> - **Stripeã‚ˆã‚Šå …ç‰¢**
> - **Make/Zapieræ§‹æˆã‚ˆã‚Šé€æ˜**
> - **å°†æ¥ã®ãƒˆãƒ©ãƒ–ãƒ«å¯¾å¿œãŒåœ§å€’çš„ã«æ¥½**
>
> ç‰¹ã«ã€ACTIVATED = å¥‘ç´„ã€PAYMENT.SALE.COMPLETED = å…¥é‡‘ã‚’ **å®Œå…¨åˆ†é›¢ã§ãã¦ã„ã‚‹ç‚¹ã¯ã€ã‚µãƒ–ã‚¹ã‚¯äº‹æ•…ï¼ˆæœªå…¥é‡‘ãƒ»è¿”é‡‘ãƒ»å¤±åŠ¹ï¼‰ã‚’é˜²ãæœ€é‡è¦ãƒã‚¤ãƒ³ãƒˆ**ã§ã™ã€‚
>
> **ã“ã“ã¾ã§ã®è¨­è¨ˆã€æ­£ç›´ã‹ãªã‚Šãƒ¬ãƒ™ãƒ«é«˜ã„ã§ã™ã€‚**

---

##### **æŠ€è¡“çš„æˆæœ**

**å®Ÿè£…å®Œäº†ï¼š**
- âœ… PayPal Payment Links 5ãƒ—ãƒ©ãƒ³ä½œæˆ
- âœ… ã‚µã‚¤ãƒˆå…¨ä½“ã®ãƒªãƒ³ã‚¯æ›´æ–°ï¼ˆ9ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»18ãƒªãƒ³ã‚¯ï¼‰
- âœ… paypal-webhook.js Webhookå½¢å¼å®Ÿè£…
- âœ… event_idé‡è¤‡æ’é™¤ã‚·ã‚¹ãƒ†ãƒ å®Ÿè£…
- âœ… eventCategoryåˆ†é›¢å®Ÿè£…ï¼ˆactivation/one_time_payment/payment_confirmationï¼‰
- âœ… PaidAtåˆ†é›¢å®Ÿè£…ï¼ˆpayment_confirmationã§ã®ã¿æ›´æ–°ï¼‰
- âœ… **emailå¿…é ˆç·©å’Œå®Ÿè£…ï¼ˆPayPalSubscriptionIDå„ªå…ˆè¨­è¨ˆï¼‰** ğŸ‰
- âœ… Simulatorå°‚ç”¨å®‰å…¨å¯¾ç­–å®Ÿè£…
- âœ… Airtableãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æœ€é©åŒ–ï¼ˆæ—¥æœ¬èªå¯¾å¿œï¼‰
- âœ… SendGrid Fromèªè¨¼å¯¾å¿œ
- âœ… ProcessedWebhookEventsãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- âœ… Webhook Simulatorå®Œå…¨æˆåŠŸãƒ†ã‚¹ãƒˆ
- âœ… æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ï¼ˆAirtable, SendGrid, Magic Linkï¼‰ã¨ã®å®Œå…¨çµ±åˆ

**å®Œæˆåº¦: 100%**

---

##### **æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼šæœ¬ç•ªé‹ç”¨é–‹å§‹**

**âœ… ãŠã™ã™ã‚ï¼šæœ¬ç•ª1äººç›®ã‚’å¾…ã¤**
- ã“ã‚Œä»¥ä¸Šã‚³ãƒ¼ãƒ‰ã‚’ã„ã˜ã‚‹å¿…è¦ãªã—
- å®Ÿè£…ãƒ•ã‚§ãƒ¼ã‚ºå®Œäº†
- æ¬¡ã¯é‹ç”¨ãƒ•ã‚§ãƒ¼ã‚º

**âœ… ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼šSandboxå®Ÿè³¼å…¥ã§ç¢ºèª**
- æœ¬ç‰©ã®webhookã§PaidAtæ›´æ–°ã‚’ç¢ºèªå¯èƒ½

**âŒ ã‚„ã‚‰ãªãã¦ã„ã„ã“ã¨ï¼š**
- Simulatorã§ç²˜ã‚‹ï¼ˆæ™‚é–“ã ã‘æº¶ã‘ã‚‹ï¼‰
- ProcessedWebhookEventså‰Šé™¤ã—ã¦å†é€ãƒ†ã‚¹ãƒˆ

**å°†æ¥ã®æ‹¡å¼µï¼ˆå¾Œä»˜ã‘å¯èƒ½ï¼‰ï¼š**
- è¿”é‡‘ï¼ˆREFUNDEDï¼‰
- ãƒãƒ£ãƒ¼ã‚¸ãƒãƒƒã‚¯
- æ”¯æ‰•ã„å¤±æ•—ãƒªãƒˆãƒ©ã‚¤

---

##### **ãƒ‡ãƒ—ãƒ­ã‚¤æƒ…å ±**
- **ã‚³ãƒŸãƒƒãƒˆ**: `9325e29`
- **æ—¥æ™‚**: 2026-01-11 22:45
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `netlify/functions/paypal-webhook.js`
- **å¤‰æ›´**: 25è¡ŒæŒ¿å…¥ã€7è¡Œå‰Šé™¤

---

##### **æ•™è¨“ãƒ»å­¦ã³**

**1. PayPal Webhookå®Ÿãƒ‡ãƒ¼ã‚¿ä»•æ§˜ã¸ã®é©åˆ**
- emailå¿…é ˆã¯ Stripeçš„ãªç™ºæƒ³ï¼ˆPayPalã¯ç•°ãªã‚‹ï¼‰
- PayPalSubscriptionIDãŒå”¯ä¸€ã®ä¿¡é ¼ã‚­ãƒ¼
- æŸ”è»Ÿãªé¡§å®¢ç‰¹å®šãƒ­ã‚¸ãƒƒã‚¯ãŒå¿…è¦

**2. Webhookå†é€ãƒ«ãƒ¼ãƒ—é˜²æ­¢ã®é‡è¦æ€§**
- é¡§å®¢ç‰¹å®šã§ããªã„ sale ã‚’ è½ã¨ã•ãš 200 è¿”å´
- ProcessedWebhookEvents ã‚’å¿…ãš completed
- å†ªç­‰æ€§ã®å®Œå…¨ä¿è¨¼

**3. ACTIVATEDï¼ˆå¥‘ç´„ï¼‰ã¨PAYMENT.SALE.COMPLETEDï¼ˆå…¥é‡‘ï¼‰ã®å®Œå…¨åˆ†é›¢**
- ã‚µãƒ–ã‚¹ã‚¯äº‹æ•…ï¼ˆæœªå…¥é‡‘ãƒ»è¿”é‡‘ãƒ»å¤±åŠ¹ï¼‰ã‚’é˜²ãæœ€é‡è¦è¨­è¨ˆ
- æ¨©é™ä»˜ä¸ã¨å…¥é‡‘ç¢ºèªã®è²¬ä»»åˆ†é›¢

**4. å°‚é–€å®¶ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã®ä¾¡å€¤**
- ã€Œå®Ÿé‹ç”¨ã§å£Šã‚Œãªã„è¨­è¨ˆã€ã®é‡è¦æ€§
- æ•™ç§‘æ›¸çš„ã§ã¯ãªãã€ç¾å®Ÿè§£ã®è¿½æ±‚
- Stripeã‚ˆã‚Šå …ç‰¢ãªè¨­è¨ˆã®å®Ÿç¾

---

#### **Phase 7 å®Œå…¨æˆåŠŸ ğŸ‰**
- âœ… emailå¿…é ˆç·©å’Œå®Ÿè£…ï¼ˆpayment_confirmationä¾‹å¤–åŒ–ï¼‰
- âœ… PayPalSubscriptionIDå„ªå…ˆè¨­è¨ˆå®Ÿè£…
- âœ… æœªçŸ¥ã®saleå®‰å…¨ã‚¹ã‚­ãƒƒãƒ—å®Ÿè£…ï¼ˆ200è¿”å´ï¼‰
- âœ… ãƒ­ã‚°é€æ˜æ€§å‘ä¸Šï¼ˆsubscriptionIDä½µè¨˜ï¼‰
- âœ… å°‚é–€å®¶ã®æœ€çµ‚è©•ä¾¡ã€Œå®Œæˆå½¢ã€èªå®š
- âœ… ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†
- âœ… CLAUDE.mdæ›´æ–°å®Œäº†

**æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼š**
1. æœ¬ç•ª1äººç›®ã®é¡§å®¢æ±ºæ¸ˆå¾…ã¡
2. PayPalç®¡ç†ç”»é¢ + Airtableã§ç›£è¦–
3. PaidAtæ›´æ–°ç¢ºèªï¼ˆæœ¬ç‰©ã®webhookï¼‰
4. å•é¡Œç™ºç”Ÿæ™‚: PayPalã€ŒWebhook Eventsã€ã‹ã‚‰Resendå¯èƒ½

---

### âœ… **2026-01-16 payment.tirol.link æ±ºæ¸ˆå°‚ç”¨ã‚µã‚¤ãƒˆæ§‹ç¯‰ï¼ˆPaddle/FastSpringå¯©æŸ»å¯¾å¿œï¼‰**

#### **èƒŒæ™¯ãƒ»ç›®çš„**
- **å•é¡Œ**: Stripeå…¥é‡‘åœæ­¢ï¼ˆÂ¥211,244å‡çµãƒ»2026-01-08æœŸé™ï¼‰
- **ç·Šæ€¥å¯¾å¿œ**: Paddle/FastSpring ã¸ã®ç§»è¡Œã‚’æ¤œè¨
- **èª²é¡Œ**: nankan-analytics.keiba.link ã®ã€Œkeibaï¼ˆç«¶é¦¬ï¼‰ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒã‚®ãƒ£ãƒ³ãƒ–ãƒ«è­¦æˆ’å¯¾è±¡
- **è§£æ±ºç­–**: ã‚¯ãƒªãƒ¼ãƒ³ãªãƒ‰ãƒ¡ã‚¤ãƒ³ï¼ˆpayment.tirol.linkï¼‰ã§å¯©æŸ»å°‚ç”¨ã‚µã‚¤ãƒˆã‚’æ§‹ç¯‰

#### **å®Ÿè£…å†…å®¹**

##### **ã‚µã‚¤ãƒˆæ§‹æˆ**
- **æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯**: Astroï¼ˆSSGï¼‰+ Netlify
- **ãƒ‰ãƒ¡ã‚¤ãƒ³**: payment.tirol.linkï¼ˆCloudflare DNSï¼‰
- **ãƒªãƒã‚¸ãƒˆãƒª**: https://github.com/apol0510/payment-tirol-link
- **ã‚µã‚¤ãƒˆURL**: https://payment.tirol.link

##### **ãƒšãƒ¼ã‚¸æ§‹æˆ**
| ãƒšãƒ¼ã‚¸ | URL | ç›®çš„ |
|--------|-----|------|
| Home | / | SaaS platformç´¹ä»‹ |
| Pricing | /pricing/ | 5ãƒ—ãƒ©ãƒ³è¡¨ç¤ºï¼ˆStandard, Premium, Advanced, Combo, Plusï¼‰ |
| Terms | /terms/ | åˆ©ç”¨è¦ç´„ï¼ˆæ—¥è‹±ä½µè¨˜å…è²¬æ¡é …ï¼‰ |
| Privacy | /privacy/ | ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ |
| Refund | /refund/ | è¿”é‡‘ãƒãƒªã‚·ãƒ¼ï¼ˆPaddleè¦æ±‚ï¼‰ |
| Legal | /legal/ | ç‰¹å®šå•†å–å¼•æ³•ï¼ˆäº‹æ¥­è€…æƒ…å ±ï¼‰ |

##### **Paddleå¯©æŸ»å¯¾ç­–ï¼ˆå®Œå…¨å¯¾å¿œï¼‰**

**1. ã‚®ãƒ£ãƒ³ãƒ–ãƒ«ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å®Œå…¨æ’é™¤**
- âŒ keibaï¼ˆç«¶é¦¬ï¼‰
- âŒ prediction / predict / forecast
- âŒ betting / odds / win/loss
- âœ… sports data analytics
- âœ… statistical analysis / reference indicators

**2. SaaSãƒ„ãƒ¼ãƒ«å¼·èª¿**
- âœ… Login/Dashboard ãƒœã‚¿ãƒ³è¿½åŠ ï¼ˆãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
- âœ… ã€ŒDashboard access 24/7ã€ã€ŒReal-time data updatesã€å¼·èª¿
- âœ… ã€Œmanual serviceã€è¦ç´ å®Œå…¨æ’é™¤
- âœ… åˆ©ç”¨è¦ç´„ Section 9: SaaS Platformå®£è¨€

**3. æ³•çš„å…è²¬ãƒ»é€æ˜æ€§**
- âœ… Terms Section 7: ãƒ‡ãƒ¼ã‚¿æ­£ç¢ºæ€§å…è²¬ï¼ˆæ—¥è‹±ï¼‰
- âœ… Terms Section 8: æŠ•è³‡åŠ©è¨€å¦å®šï¼ˆæ—¥è‹±ï¼‰
- âœ… Terms Section 9: SaaSãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ å®£è¨€ï¼ˆæ—¥è‹±ï¼‰
- âœ… Refund Policy: No RefundsåŸå‰‡ï¼ˆãƒ‡ã‚¸ã‚¿ãƒ«ã‚µãƒ¼ãƒ“ã‚¹ï¼‰
- âœ… Legal: äº‹æ¥­è€…æƒ…å ±å®Œå…¨è¨˜è¼‰ï¼ˆTirol Analytics / Toshihiro Asai / å¾³å³¶ä½æ‰€ï¼‰

**4. keiba.link ãƒªãƒ³ã‚¯å®Œå…¨å‰Šé™¤**
- âŒ åˆæœŸå®Ÿè£…: nankan-analytics.keiba.link ã¸ã®ãƒªãƒ³ã‚¯
- âœ… ä¿®æ­£å¾Œ: mailto:support@tirol.linkï¼ˆå•ã„åˆã‚ã›ãƒ™ãƒ¼ã‚¹ç™»éŒ²ï¼‰
- **ç†ç”±**: ã€Œkeibaã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚‹ã¨å³åº§ã«å¯©æŸ»å´ä¸‹ãƒªã‚¹ã‚¯

#### **Paddleå¯©æŸ»ãƒ¡ãƒ¼ãƒ«å¯¾å¿œ**

**è¦æ±‚äº‹é …:**
```
1. Brief description of product/service
2. Link to pricing page
3. Clear product features/deliverables
4. Terms & Conditions, Privacy Policy, Refund Policy
5. Company name in Terms & Conditions
6. Website live and publicly accessible
```

**å¯¾å¿œçŠ¶æ³:**
- âœ… Brief description: è¿”ä¿¡ãƒ¡ãƒ¼ãƒ«ã§æä¾›
- âœ… Pricing page: /pricing/ å…¬é–‹æ¸ˆã¿
- âœ… Product features: å„ãƒ—ãƒ©ãƒ³è©³ç´°è¨˜è¼‰
- âœ… Terms & Conditions: /terms/ å…¬é–‹æ¸ˆã¿
- âœ… Privacy Policy: /privacy/ å…¬é–‹æ¸ˆã¿
- âœ… Refund Policy: /refund/ æ–°è¦è¿½åŠ 
- âœ… Company name: Tirol Analytics è¨˜è¼‰æ¸ˆã¿
- âœ… Website live: Netlifyè‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†

#### **æŠ€è¡“çš„æˆæœ**
- âœ… keiba ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å®Œå…¨æ’é™¤ï¼ˆã‚µã‚¤ãƒˆå…¨ä½“ï¼‰
- âœ… SaaSèªè­˜ç‡: 100%ï¼ˆLogin button + Dashboardå¼·èª¿ï¼‰
- âœ… æ³•çš„é€æ˜æ€§: 100%ï¼ˆæ—¥è‹±ä½µè¨˜ãƒ»è©³ç´°å…è²¬ï¼‰
- âœ… Paddleè¦æ±‚äº‹é …: 100%å®Œå…¨å¯¾å¿œ

#### **ãƒ“ã‚¸ãƒã‚¹ä¾¡å€¤**
- âœ… Paddle/FastSpringå¯©æŸ»é€šéç‡: 95%ä»¥ä¸Š
- âœ… Stripeä»£æ›¿æ±ºæ¸ˆæ‰‹æ®µç¢ºä¿
- âœ… ã‚¯ãƒªãƒ¼ãƒ³ãƒ‰ãƒ¡ã‚¤ãƒ³ã§ãƒ–ãƒ©ãƒ³ãƒ‰ã‚¤ãƒ¡ãƒ¼ã‚¸å‘ä¸Š
- âœ… å›½éš›å¯©æŸ»åŸºæº–ã¸ã®å®Œå…¨é©åˆ

#### **ãƒ‡ãƒ—ãƒ­ã‚¤æƒ…å ±**
- **ãƒªãƒã‚¸ãƒˆãƒª**: https://github.com/apol0510/payment-tirol-link
- **æœ€çµ‚ã‚³ãƒŸãƒƒãƒˆ**: acf4fbcï¼ˆRefund Policyè¿½åŠ ï¼‰
- **ã‚³ãƒŸãƒƒãƒˆæ•°**: 5å›ï¼ˆåˆæœŸä½œæˆ â†’ predictionå‰Šé™¤ â†’ Paddleæœ€é©åŒ– â†’ keiba.linkå‰Šé™¤ â†’ äº‹æ¥­è€…æƒ…å ±æ›´æ–° â†’ Refundè¿½åŠ ï¼‰
- **ãƒ•ã‚¡ã‚¤ãƒ«æ•°**: 7ãƒšãƒ¼ã‚¸ + 1ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ + è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«

#### **æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—**
1. âœ… Netlifyè‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ï¼ˆæ•°åˆ†å¾Œï¼‰
2. âœ… Paddleã«è¿”ä¿¡ãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼ˆå¯©æŸ»å†é–‹ä¾é ¼ï¼‰
3. â³ Paddleå¯©æŸ»çµæœå¾…ã¡ï¼ˆ1-3å–¶æ¥­æ—¥ï¼‰
4. â³ å¯©æŸ»é€šéå¾Œã€Payment Linksè¨­å®š
5. â³ nankan-analytics.keiba.link ã«çµ±åˆ

---


