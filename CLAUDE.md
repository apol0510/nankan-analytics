# NANKANアナリティクス 開発仕様書

## 【最重要】レース区分定義（絶対厳守・必ず最初に確認）

### ❌ よくある間違い（これは間違いです！）
- **12R（最終レース）を無料対象にする** ← 絶対にダメ！
- **12Rをメインレースとして扱う** ← 違います！
- **12Rにtier: "free"を設定する** ← エラー！

### ✅ 正しいレース区分（12レース開催時）
```
1R-9R: tier: "premium" （プレミアム会員）
10R:   tier: "standard"（スタンダード会員）
11R:   tier: "free"    （無料・メインレース）★★★ ← ここが無料！
12R:   tier: "standard"（スタンダード会員）← 最終だが無料ではない！
```

### ✅ 正しいレース区分（10レース開催時）
```
1R-8R: tier: "premium" （プレミアム会員）
9R:    tier: "free"    （無料・メインレース）★★★
10R:   tier: "standard"（スタンダード会員）
```

### 📋 レース設定チェックリスト（作業前に必ず確認）
- [ ] 11RがisMainRace: true になっている
- [ ] 11Rがtier: "free" になっている
- [ ] 12Rがtier: "standard" になっている（freeではない！）
- [ ] planAccess.free.races: ["11R"] になっている（12Rは含まない！）
- [ ] 編集ボタンが "11R編集 (メイン・free)" になっている
- [ ] JavaScriptのtierMappingで11: 'free', 12: 'standard'になっている

### 🚨 なぜこの仕様なのか
南関競馬では**最終レースの1つ前**がメインレース（重要なレース）として扱われる慣習があります。
最終レースは締めのレースであり、メインではありません。

## プロジェクト概要

### サイト名
**NANKANアナリティクス**

### コンセプト
「AI・機械学習で勝つ。南関競馬の次世代予想プラットフォーム」

### 現在の開発状況
- **フェーズ**: サービス運用中（Phase 3完了）
- **プラットフォーム**: AI予想サービス + 会員制システム
- **メイン機能**: リアルタイム競馬予想、会員制課金システム、管理者ダッシュボード
- **ユーザー層**: 有料会員（Standard/Premium）+ 無料利用者

### サービス構成
- **無料予想**: メインレース（11R）のみ
- **Standard会員**: 10R、12R予想に加え、基礎コンテンツ
- **Premium会員**: 全レース（1R-12R）予想とすべてのコンテンツ
- **管理者機能**: レース結果管理、予想データ更新、統計分析

## 技術要件

### 現在の技術スタック
- **Astro** 4.x 静的サイトジェネレーター（メインフレームワーク）
- **Supabase** バックエンドサービス（認証・データベース）
- **Stripe** 決済処理システム
- **Netlify** ホスティング＋自動デプロイ
- **JavaScript/CSS** フロントエンド開発
- **PostgreSQL** データベース（Supabase経由）

### デプロイメント
- **本番環境**: https://nankan-analytics.keiba.link
- **開発環境**: http://localhost:4321
- **CI/CD**: GitHub → Netlify 自動デプロイ
- **環境変数**: Netlify環境設定で管理

### データベース設計
```sql
-- ユーザープロファイル管理
CREATE TABLE profiles (
    id UUID PRIMARY KEY,
    email TEXT,
    subscription_tier TEXT,
    created_at TIMESTAMP
);

-- 決済情報
CREATE TABLE subscriptions (
    id SERIAL PRIMARY KEY,
    user_id UUID REFERENCES profiles(id),
    stripe_subscription_id TEXT,
    status TEXT,
    plan_id TEXT
);
```

## アーキテクチャ構成

### ディレクトリ構造
```
astro-site/
├── src/
│   ├── components/           # 再利用可能なコンポーネント
│   │   ├── AccessControl.astro
│   │   ├── RaceAccordion.astro
│   │   ├── RaceStrategy.astro
│   │   └── StandardRaceAccordion.astro
│   ├── data/                 # データファイル
│   │   ├── raceResults.json
│   │   └── allRacesPrediction.json
│   ├── layouts/              # レイアウトテンプレート
│   ├── pages/                # ページコンポーネント
│   │   ├── admin/            # 管理者専用ページ
│   │   ├── api/              # APIエンドポイント
│   │   ├── auth/             # 認証関連ページ
│   │   └── payment/          # 決済関連ページ
│   └── lib/                  # ユーティリティ・共通処理
```

### コンポーネント設計思想
- **再利用性**: 共通UIコンポーネントの統一
- **アクセス制御**: 会員レベル別の表示制御
- **モバイル対応**: レスポンシブデザイン優先
- **パフォーマンス**: 静的生成による高速化

## 現在の主要機能

### 1. 予想システム
- **リアルタイム予想**: 各レースのAI予想とオッズ分析
- **投資戦略**: 安全・バランス・攻撃的の3段階戦略
- **進捗バー表示**: 的中確率・期待収益率を視覚化
- **馬券印**: ◎本命、○対抗、▲単穴の表示

### 2. 会員システム
- **認証**: Supabaseによるログイン/登録
- **サブスクリプション**: Stripeによる月額課金
- **アクセス制御**: 会員レベル別コンテンツ制御
- **ダッシュボード**: ユーザー専用管理画面

### 3. 管理システム
- **予想データ更新**: admin/predictions.astroで一括管理
- **結果入力**: admin.astroでレース結果の簡単入力
- **統計管理**: 的中率・回収率の自動計算
- **バックアップ**: 自動データバックアップシステム

### 4. 決済システム
- **Stripe Checkout**: 安全な決済処理
- **Webhook**: 決済状況の自動同期
- **プラン管理**: Standard/Premiumプランの管理
- **顧客ポータル**: 自動請求・キャンセル機能

## UI/UXデザインルール

### カラーテーマ（ダークモード専用）
- **プライマリ**: #3b82f6 (青系)
- **セカンダリ**: #8b5cf6 (紫系)
- **背景**: #0f172a (ダークネイビー)
- **テキスト**: #e2e8f0 (ライトグレー)
- **成功色**: #10b981 (グリーン)
- **警告色**: #f59e0b (オレンジ)
- **エラー色**: #ef4444 (レッド)

### デザイン原則
- **ダークテーマ**: 夜間利用を考慮した目に優しいデザイン
- **グラスモーフィズム**: backdrop-filter: blur()による透明感
- **カード型レイアウト**: 情報の構造化と視認性向上
- **アニメーション**: hover効果による直感的なインタラクション

### アイコン使用規則
- **禁止**: 🎯（ターゲットマーク）は競馬予想に不適切
- **推奨**: ⚡（攻略）、🤖（AI）、📊（データ）、🏇（競馬）
- **馬券印**: ◎（本命）、○（対抗）、▲（単穴）

## 重要な技術仕様

### プログレスバー表示仕様
**必須要件**: 数値は必ず「90%」形式で表示（0.90形式禁止）
```javascript
// 正しい実装
Math.round(value * 100) + '%'

// 間違った実装（禁止）
value.toFixed(2)  // 0.90と表示されてしまう
```

### 馬券印表示仕様
```html
<!-- 正しい馬券印 -->
<span class="horse-mark-main">◎</span>  <!-- 本命 -->
<span class="horse-mark-sub">○</span>   <!-- 対抗 -->  
<span class="horse-mark-sub">▲</span>   <!-- 単穴 -->
```

### アコーディオン制御仕様
- **JavaScript関数**: toggleRace10R(), toggleRace11R(), toggleRace12R()
- **CSS制御**: max-height: 0 → max-height: 2000px
- **アニメーション**: transition: max-height 0.3s ease

## 開発・保守運用

### 開発環境セットアップ
```bash
# 正しいディレクトリに移動
cd "/Users/apolon/Library/Mobile Documents/com~apple~CloudDocs/WorkSpace/nankan-analytics/astro-site"

# 依存関係インストール
npm install

# 開発サーバー起動
npm run dev
```

### トラブルシューティング

#### 1. サーバー混在問題
```bash
# 既存サーバー停止
pkill -f "python.*http.server"
pkill -f "astro dev"

# ポート確認
lsof -i tcp:4321
```

#### 2. ブラウザキャッシュ問題
- **症状**: 更新が反映されない
- **解決**: Cmd+Shift+Delete でキャッシュクリア
- **確認**: プライベートモードで検証

#### 3. 表示不具合
- **プログレスバー**: Math.round(value * 100) + '%' 形式確認
- **馬券印**: ◎○▲の正しい記号確認
- **モバイル表示**: レスポンシブ対応確認

### 更新作業フロー

#### 予想データ更新
1. admin/predictions.astroで予想データ編集
2. 進捗バー数値をパーセンテージ確認
3. 馬券印の正確性確認
4. モバイル表示での検証

#### レース結果更新  
1. admin.astroで結果データ入力
2. JSON自動生成・コピー
3. src/data/raceResults.json更新
4. 統計数値の自動計算確認

#### git管理
```bash
# 標準コミットフロー
git add .
git commit -m "機能改善: プログレスバー表示修正と馬券印正規化

🤖 Generated with Claude Code
Co-Authored-By: Claude <noreply@anthropic.com>"
git push
```

## セキュリティ・運用監視

### セキュリティ要件
- **認証**: Supabase RLS（Row Level Security）
- **決済**: Stripe PCI-DSS準拠
- **API保護**: 環境変数による秘匿情報管理
- **アクセス制御**: 会員レベル別認可システム

### 監視・メンテナンス
- **アップタイム**: Netlify自動監視
- **エラー追跡**: ブラウザコンソールでの確認
- **パフォーマンス**: Lighthouse スコア維持
- **バックアップ**: データの定期バックアップ

## 重要な開発方針

### 既存資産の保護
- **破壊的変更禁止**: 動作中のシステムを優先
- **段階的改善**: 小さな改善の積み重ね
- **後方互換性**: 既存ユーザーへの影響最小化

### コミュニケーション
- **確認重視**: 作業前の意図確認必須
- **具体的質問**: 不明点の具体的な確認
- **推測作業禁止**: 確認なしの推測実装禁止

### 品質基準
- **モバイル最優先**: スマートフォン表示の最適化
- **アクセシビリティ**: 読みやすさ・使いやすさの重視
- **パフォーマンス**: 高速表示の維持

---

**最後更新**: 2025年8月26日  
**プロジェクト状況**: Phase 3完了・運用中  
**次回課題**: ユーザーフィードバックに基づく機能改善