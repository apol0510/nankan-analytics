# Stripe テストモード決済ガイド

## 現在の設定状態
✅ **テストモードが有効になっています**
- テスト用の公開キー（pk_test_）が設定済み
- テスト用の秘密キー（sk_test_）が設定済み

## テスト決済の手順

### 1. サイトにアクセス
http://localhost:4321/ にアクセス

### 2. 料金ページへ移動
http://localhost:4321/pricing にアクセス

### 3. プランを選択
- **スタンダードプラン**: 月額5,980円
- **プレミアムプラン**: 月額9,980円

### 4. テストカード情報を入力

#### 基本テストカード（成功）
- **カード番号**: `4242 4242 4242 4242`
- **有効期限**: 任意の将来の日付（例: 12/34）
- **CVC**: 任意の3桁の数字（例: 123）
- **郵便番号**: 任意の5桁（例: 10001）

#### その他のテストカード

**決済成功するカード:**
- `4000 0025 0000 3155` - 3Dセキュア認証が必要
- `4000 0000 0000 0077` - 決済成功（通常）
- `5555 5555 5554 4444` - Mastercard
- `3782 822463 10005` - American Express

**決済失敗するカード（テスト用）:**
- `4000 0000 0000 9995` - カードが拒否される
- `4000 0000 0000 0002` - カードが拒否される（一般的な拒否）
- `4000 0000 0000 9987` - 残高不足

### 5. メールアドレス
テスト用の任意のメールアドレスを使用可能：
- 例: test@example.com
- 例: user+test@gmail.com

## 確認ポイント

### Stripe Dashboard でテスト決済を確認
1. https://dashboard.stripe.com/test/payments にアクセス
2. テスト決済が表示されることを確認
3. サブスクリプションが作成されることを確認

### ローカルでの確認
1. Supabaseのprofilesテーブルでユーザーのサブスクリプション状態を確認
2. stripe_customer_idが設定されることを確認
3. subscription_tierが更新されることを確認

## トラブルシューティング

### よくある問題と解決方法

1. **「Invalid API Key」エラー**
   - .envファイルのキーが正しく設定されているか確認
   - サーバーを再起動（Ctrl+C → npm run dev）

2. **決済後にリダイレクトされない**
   - success_urlとcancel_urlが正しく設定されているか確認
   - SITE_URLが http://localhost:4321 になっているか確認

3. **Webhookが動作しない**
   - ローカル環境ではStripe CLIを使用してWebhookをテスト
   - `stripe listen --forward-to localhost:4321/api/webhook`

## 本番モードへの切り替え

本番環境にデプロイする前に：
1. .envファイルで本番用のキーのコメントを解除
2. テスト用のキーをコメントアウト
3. Netlifyの環境変数を本番用に更新

## 重要な注意事項
⚠️ **テストモードでは実際の課金は発生しません**
⚠️ **本番キーとテストキーを混在させないでください**
⚠️ **テストデータは定期的に削除することを推奨**