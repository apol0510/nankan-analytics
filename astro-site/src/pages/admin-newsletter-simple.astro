---
// ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ¡ãƒ«ãƒã‚¬é…ä¿¡ç®¡ç†ç”»é¢
export const prerender = true;
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout title="ãƒ¡ãƒ«ãƒã‚¬é…ä¿¡ - NANKANã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹">
    <style>
        .newsletter-admin {
            min-height: 100vh;
            background: #f8fafc;
            padding: 20px;
        }
        
        .admin-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .admin-header h1 {
            font-size: 1.8rem;
            color: #1f2937;
            margin-bottom: 5px;
        }
        
        .admin-container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .card h2 {
            color: #1f2937;
            font-size: 1.3rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            color: #374151;
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        textarea.form-control {
            min-height: 200px;
            resize: vertical;
            font-family: inherit;
        }
        
        .target-plan {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .plan-option {
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            background: white;
        }
        
        .plan-option:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        
        .plan-option.active {
            border-color: #3b82f6;
            background: #3b82f6;
            color: white;
        }
        
        .plan-option span {
            display: block;
            font-size: 0.9rem;
            margin-top: 4px;
            opacity: 0.8;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }
        
        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            font-size: 15px;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }
        
        .status-message.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
            display: block;
        }
        
        .status-message.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
            display: block;
        }
        
        .status-message.info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #3b82f6;
            display: block;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-box {
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        
        .stat-label {
            font-size: 0.85rem;
            color: #6b7280;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
        }
        
        .schedule-option {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-top: 10px;
        }
        
        .schedule-option input[type="datetime-local"] {
            flex: 1;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        
        /* HTML/ãƒ†ã‚­ã‚¹ãƒˆåˆ‡ã‚Šæ›¿ãˆã‚¿ãƒ– */
        .content-type-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
        }
        
        .content-tab {
            padding: 8px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }
        
        .content-tab:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        
        .content-tab.active {
            border-color: #3b82f6;
            background: #3b82f6;
            color: white;
        }
        
        /* HTMLã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ */
        .html-toolbar {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
            padding: 10px;
            background: #f9fafb;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        
        .html-btn {
            padding: 5px 10px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        
        .html-btn:hover {
            background: #3b82f6;
            color: white;
        }
        
        .html-textarea {
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
        }
        
        /* ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ */
        .image-upload-area {
            margin-top: 10px;
        }
        
        .upload-zone {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .upload-zone:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        
        .upload-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .upload-text strong {
            display: block;
            margin-bottom: 5px;
            color: #374151;
        }
        
        .upload-text small {
            color: #6b7280;
            font-size: 0.85rem;
        }
        
        .image-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .image-preview-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }
        
        .image-preview-item img {
            width: 100%;
            height: 80px;
            object-fit: cover;
        }
        
        .image-remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #ef4444;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* é…ä¿¡åœæ­¢ç®¡ç† */
        .unsubscribe-section {
            padding: 0;
        }
        
        .unsubscribe-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .unsubscribe-stats {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }
    </style>
    
    <div class="newsletter-admin">
        <div class="admin-header">
            <h1>ğŸ“§ ãƒ¡ãƒ«ãƒã‚¬é…ä¿¡ã‚·ã‚¹ãƒ†ãƒ </h1>
            <p style="color: #6b7280; margin: 0;">ã‚·ãƒ³ãƒ—ãƒ«ï¼†ç¢ºå®Ÿãªé…ä¿¡ç®¡ç†</p>
        </div>
        
        <div class="admin-container">
            <!-- é…ä¿¡çµ±è¨ˆ -->
            <div class="card">
                <h2>ğŸ“Š é…ä¿¡çµ±è¨ˆ</h2>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-label">ç·é¡§å®¢æ•°</div>
                        <div class="stat-value" id="totalCustomers">-</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Freeä¼šå“¡</div>
                        <div class="stat-value" id="freeCount">-</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Standardä¼šå“¡</div>
                        <div class="stat-value" id="standardCount">-</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Premiumä¼šå“¡</div>
                        <div class="stat-value" id="premiumCount">-</div>
                    </div>
                </div>
            </div>
            
            <!-- ãƒ¡ãƒ¼ãƒ«ä½œæˆãƒ•ã‚©ãƒ¼ãƒ  -->
            <div class="card">
                <h2>âœ‰ï¸ ãƒ¡ãƒ¼ãƒ«ä½œæˆ</h2>
                
                <div class="form-group">
                    <label>é…ä¿¡å¯¾è±¡</label>
                    <div class="target-plan">
                        <div class="plan-option active" data-plan="all">
                            å…¨å“¡
                            <span id="allCount">-</span>
                        </div>
                        <div class="plan-option" data-plan="free">
                            Free
                            <span id="freeCountOption">-</span>
                        </div>
                        <div class="plan-option" data-plan="standard">
                            Standard
                            <span id="standardCountOption">-</span>
                        </div>
                        <div class="plan-option" data-plan="premium">
                            Premium
                            <span id="premiumCountOption">-</span>
                        </div>
                        <div class="plan-option" data-plan="test">
                            ğŸ§ª ãƒ†ã‚¹ãƒˆ
                            <span>ãƒ†ã‚¹ãƒˆç”¨</span>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>ä»¶å</label>
                    <input type="text" class="form-control" id="subject" 
                           placeholder="ä¾‹ï¼šã€å—é–¢ç«¶é¦¬ã€‘æœ¬æ—¥ã®äºˆæƒ³é…ä¿¡">
                </div>
                
                <div class="form-group">
                    <label>æœ¬æ–‡å½¢å¼</label>
                    <div class="content-type-tabs">
                        <button type="button" class="content-tab active" data-type="text">ğŸ“ ãƒ†ã‚­ã‚¹ãƒˆ</button>
                        <button type="button" class="content-tab" data-type="html">ğŸŒ HTML</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label id="contentLabel">æœ¬æ–‡</label>
                    <div id="textEditor">
                        <textarea class="form-control" id="content" 
                                  placeholder="ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."></textarea>
                    </div>
                    <div id="htmlEditor" style="display: none;">
                        <div class="html-toolbar">
                            <button type="button" class="html-btn" data-tag="b">å¤ªå­—</button>
                            <button type="button" class="html-btn" data-tag="i">æ–œä½“</button>
                            <button type="button" class="html-btn" data-tag="u">ä¸‹ç·š</button>
                            <button type="button" class="html-btn" onclick="insertLink()">ğŸ”— ãƒªãƒ³ã‚¯</button>
                            <button type="button" class="html-btn" onclick="insertImage()">ğŸ–¼ï¸ ç”»åƒ</button>
                        </div>
                        <textarea class="form-control html-textarea" id="htmlContent" 
                                  placeholder="HTMLã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã™ã‚‹ã‹ã€ä¸Šã®ãƒœã‚¿ãƒ³ã§HTMLã‚¿ã‚°ã‚’è¿½åŠ ã—ã¦ãã ã•ã„..."></textarea>
                        <div class="html-preview">
                            <button type="button" id="previewToggle" class="btn btn-secondary">ğŸ‘ï¸ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
                            <div id="previewPane" style="display: none; margin-top: 10px; padding: 15px; border: 1px solid #d1d5db; border-radius: 8px; background: #f9fafb;">
                                <div id="previewContent"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ç”»åƒæ·»ä»˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="form-group">
                    <label>ç”»åƒæ·»ä»˜ (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)</label>
                    
                    <!-- äºˆç´„é…ä¿¡æ™‚ã®é‡è¦ãªæ³¨æ„ -->
                    <div id="imageScheduleWarning" class="status-message" style="display: none; background: #fef3c7; color: #92400e; border: 1px solid #f59e0b;">
                        âš ï¸ <strong>äºˆç´„é…ä¿¡ã§ã®ç”»åƒã«ã¤ã„ã¦ï¼š</strong><br>
                        äºˆç´„é…ä¿¡ã§ã¯å¤§å®¹é‡ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã§ãã¾ã›ã‚“ã€‚<br>
                        <strong>æ¨å¥¨ï¼š</strong> ç”»åƒã‚’å¤–éƒ¨ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¾Œã€HTMLã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã§<code>&lt;img src="URL"&gt;</code>ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
                    </div>
                    
                    <div class="content-type-tabs" style="margin-top: 10px;">
                        <button type="button" class="content-tab active" data-image-type="upload">ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«æ·»ä»˜</button>
                        <button type="button" class="content-tab" data-image-type="url">ğŸŒ å¤–éƒ¨URL</button>
                    </div>
                    
                    <!-- ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ–¹å¼ -->
                    <div id="imageUploadSection" class="image-upload-area" style="margin-top: 15px;">
                        <input type="file" id="imageUpload" accept="image/*" multiple style="display: none;">
                        <div class="upload-zone" onclick="document.getElementById('imageUpload').click();">
                            <div class="upload-icon">ğŸ“</div>
                            <div class="upload-text">
                                <strong>ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</strong>
                                <small>ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç”»åƒã‚’é¸æŠã€ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—<br>â€» å³æ™‚é…ä¿¡ã®ã¿å¯¾å¿œ</small>
                            </div>
                        </div>
                        <div id="imagePreviewContainer" style="display: none;">
                            <div class="image-preview-grid" id="imagePreviewGrid"></div>
                        </div>
                    </div>
                    
                    <!-- å¤–éƒ¨URLæ–¹å¼ -->
                    <div id="imageUrlSection" style="display: none; margin-top: 15px;">
                        <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; border: 1px solid #0ea5e9; margin-bottom: 15px;">
                            <h4 style="margin: 0 0 10px 0; color: #0c4a6e;">ğŸŒŸ æ¨å¥¨ï¼šå¤–éƒ¨ç”»åƒãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°</h4>
                            <p style="margin: 0 0 10px 0; font-size: 14px; color: #075985;">
                                <strong>äºˆç´„é…ä¿¡ã‚‚ç¢ºå®Ÿå‹•ä½œï¼</strong> ç”»åƒã‚’ä»¥ä¸‹ã®ã‚µãƒ¼ãƒ“ã‚¹ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦URLã‚’å–å¾—ï¼š
                            </p>
                            <ul style="margin: 0; padding-left: 20px; font-size: 13px; color: #0369a1;">
                                <li><strong>Google Drive</strong>ï¼ˆç„¡æ–™ãƒ»å…±æœ‰ãƒªãƒ³ã‚¯å–å¾—ï¼‰</li>
                                <li><strong>Imgur</strong>ï¼ˆç„¡æ–™ãƒ»ç”»åƒå°‚ç”¨ï¼‰</li>
                                <li><strong>Cloudinary</strong>ï¼ˆãƒ—ãƒ­ä»•æ§˜ãƒ»é«˜é€ŸCDNï¼‰</li>
                                <li><strong>GitHub</strong>ï¼ˆæŠ€è¡“è€…å‘ã‘ãƒ»æ°¸ç¶šä¿å­˜ï¼‰</li>
                            </ul>
                        </div>
                        
                        <div class="form-group">
                            <label>ç”»åƒURL</label>
                            <input type="url" class="form-control" id="imageUrl" 
                                   placeholder="https://example.com/image.jpg">
                            <button type="button" class="btn btn-secondary" id="addImageUrlBtn" style="margin-top: 10px;">HTMLã«è¿½åŠ </button>
                        </div>
                        
                        <div id="urlImagePreview" style="display: none; margin-top: 15px;">
                            <img id="urlImagePreviewImg" style="max-width: 200px; max-height: 150px; border-radius: 8px; border: 1px solid #e5e7eb;">
                        </div>
                    </div>
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="scheduleCheck">
                    <label for="scheduleCheck" style="margin: 0; cursor: pointer;">äºˆç´„é…ä¿¡ã™ã‚‹</label>
                </div>
                
                <div class="schedule-option" id="scheduleOption" style="display: none;">
                    <input type="datetime-local" class="form-control" id="scheduleTime">
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="sendBtn">
                        <span id="sendBtnText">é…ä¿¡ã™ã‚‹</span>
                    </button>
                    <button class="btn btn-secondary" id="previewBtn">
                        ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
                    </button>
                </div>
                
                <div id="statusMessage" class="status-message"></div>
            </div>
            
            <!-- é…ä¿¡åœæ­¢ç®¡ç† -->
            <div class="card">
                <h2>ğŸš« é…ä¿¡åœæ­¢ç®¡ç†</h2>
                <div class="unsubscribe-section">
                    <div class="form-group">
                        <label>é…ä¿¡åœæ­¢å‡¦ç†</label>
                        <div class="unsubscribe-actions">
                            <input type="email" class="form-control" id="unsubscribeEmail" 
                                   placeholder="é…ä¿¡åœæ­¢ã™ã‚‹ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" style="flex: 1; margin-right: 10px;">
                            <button class="btn btn-secondary" id="unsubscribeBtn">é…ä¿¡åœæ­¢</button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>é…ä¿¡å†é–‹</label>
                        <div class="unsubscribe-actions">
                            <input type="email" class="form-control" id="resubscribeEmail" 
                                   placeholder="é…ä¿¡å†é–‹ã™ã‚‹ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" style="flex: 1; margin-right: 10px;">
                            <button class="btn btn-primary" id="resubscribeBtn">é…ä¿¡å†é–‹</button>
                        </div>
                    </div>
                    
                    <div class="unsubscribe-stats">
                        <div class="stat-box">
                            <div class="stat-label">é…ä¿¡åœæ­¢è€…æ•°</div>
                            <div class="stat-value" id="unsubscribedCount">-</div>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
    </div>
    
    <script>
        // é¡§å®¢çµ±è¨ˆã‚’å–å¾—
        async function loadStatistics() {
            try {
                const response = await fetch('/.netlify/functions/get-customer-stats');
                if (response.ok) {
                    const stats = await response.json();
                    
                    document.getElementById('totalCustomers').textContent = stats.total || 0;
                    document.getElementById('freeCount').textContent = stats.free || 0;
                    document.getElementById('standardCount').textContent = stats.standard || 0;
                    document.getElementById('premiumCount').textContent = stats.premium || 0;
                    
                    // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®æ•°ã‚‚æ›´æ–°
                    document.getElementById('allCount').textContent = `${stats.total || 0}å`;
                    document.getElementById('freeCountOption').textContent = `${stats.free || 0}å`;
                    document.getElementById('standardCountOption').textContent = `${stats.standard || 0}å`;
                    document.getElementById('premiumCountOption').textContent = `${stats.premium || 0}å`;
                }
            } catch (error) {
                console.error('çµ±è¨ˆæƒ…å ±ã®å–å¾—ã«å¤±æ•—:', error);
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¡¨ç¤º
                document.getElementById('totalCustomers').textContent = '0';
                document.getElementById('freeCount').textContent = '0';
                document.getElementById('standardCount').textContent = '0';
                document.getElementById('premiumCount').textContent = '0';
            }
        }
        
        
        // ãƒ—ãƒ©ãƒ³é¸æŠ
        document.querySelectorAll('.plan-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.plan-option').forEach(opt => opt.classList.remove('active'));
                this.classList.add('active');
            });
        });
        
        // äºˆç´„é…ä¿¡ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
        document.getElementById('scheduleCheck').addEventListener('change', function() {
            const scheduleOption = document.getElementById('scheduleOption');
            const sendBtnText = document.getElementById('sendBtnText');
            const imageWarning = document.getElementById('imageScheduleWarning');
            
            if (this.checked) {
                scheduleOption.style.display = 'flex';
                sendBtnText.textContent = 'äºˆç´„ã™ã‚‹';
                imageWarning.style.display = 'block'; // ç”»åƒè­¦å‘Šã‚’è¡¨ç¤º
                
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§1æ™‚é–“å¾Œã‚’è¨­å®š
                const now = new Date();
                now.setHours(now.getHours() + 1);
                now.setMinutes(0);
                document.getElementById('scheduleTime').value = 
                    now.toISOString().slice(0, 16);
            } else {
                scheduleOption.style.display = 'none';
                sendBtnText.textContent = 'é…ä¿¡ã™ã‚‹';
                imageWarning.style.display = 'none'; // ç”»åƒè­¦å‘Šã‚’éš ã™
            }
        });
        
        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½
        document.getElementById('previewBtn').addEventListener('click', function() {
            const subject = document.getElementById('subject').value;
            const content = document.getElementById('content').value;
            
            if (!subject || !content) {
                alert('ä»¶åã¨æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            // ç°¡æ˜“ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
            const preview = window.open('', '_blank', 'width=600,height=700');
            preview.document.write(`
                <html>
                <head>
                    <title>ãƒ¡ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</title>
                    <style>
                        body { font-family: sans-serif; padding: 20px; }
                        .subject { font-size: 1.5rem; font-weight: bold; margin-bottom: 20px; }
                        .content { white-space: pre-wrap; line-height: 1.6; }
                    </style>
                </head>
                <body>
                    <div class="subject">ä»¶å: ${subject}</div>
                    <hr>
                    <div class="content">${content}</div>
                </body>
                </html>
            `);
        });
        
        
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        function showMessage(message, type) {
            const messageDiv = document.getElementById('statusMessage');
            messageDiv.textContent = message;
            messageDiv.className = `status-message ${type}`;
            
            if (type !== 'info') {
                setTimeout(() => {
                    messageDiv.className = 'status-message';
                }, 5000);
            }
        }
        
        // HTML/ãƒ†ã‚­ã‚¹ãƒˆåˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
        document.querySelectorAll('.content-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const type = this.dataset.type;
                
                // ã‚¿ãƒ–ã®çŠ¶æ…‹æ›´æ–°
                document.querySelectorAll('.content-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                // ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
                if (type === 'html') {
                    document.getElementById('textEditor').style.display = 'none';
                    document.getElementById('htmlEditor').style.display = 'block';
                    document.getElementById('contentLabel').textContent = 'HTMLæœ¬æ–‡';
                } else {
                    document.getElementById('textEditor').style.display = 'block';
                    document.getElementById('htmlEditor').style.display = 'none';
                    document.getElementById('contentLabel').textContent = 'æœ¬æ–‡';
                }
            });
        });
        
        // HTMLãƒ„ãƒ¼ãƒ«ãƒãƒ¼æ©Ÿèƒ½
        document.querySelectorAll('.html-btn[data-tag]').forEach(btn => {
            btn.addEventListener('click', function() {
                const tag = this.dataset.tag;
                const textarea = document.getElementById('htmlContent');
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const selectedText = textarea.value.substring(start, end) || 'ãƒ†ã‚­ã‚¹ãƒˆ';
                const newText = `<${tag}>${selectedText}</${tag}>`;
                
                textarea.value = textarea.value.substring(0, start) + newText + textarea.value.substring(end);
                textarea.focus();
                textarea.setSelectionRange(start + tag.length + 2, start + tag.length + 2 + selectedText.length);
            });
        });
        
        // HTMLãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½
        document.getElementById('previewToggle').addEventListener('click', function() {
            const previewPane = document.getElementById('previewPane');
            const previewContent = document.getElementById('previewContent');
            const htmlContent = document.getElementById('htmlContent').value;
            
            if (previewPane.style.display === 'none') {
                previewContent.innerHTML = htmlContent;
                previewPane.style.display = 'block';
                this.textContent = 'ğŸ“ ç·¨é›†ã«æˆ»ã‚‹';
            } else {
                previewPane.style.display = 'none';
                this.textContent = 'ğŸ‘ï¸ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼';
            }
        });
        
        // ãƒªãƒ³ã‚¯æŒ¿å…¥æ©Ÿèƒ½
        function insertLink() {
            const url = prompt('ãƒªãƒ³ã‚¯URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', 'https://');
            const text = prompt('ãƒªãƒ³ã‚¯ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', 'ãƒªãƒ³ã‚¯');
            if (url && text) {
                const textarea = document.getElementById('htmlContent');
                const linkHtml = `<a href="${url}" target="_blank">${text}</a>`;
                textarea.value += linkHtml;
            }
        }
        
        // ç”»åƒæŒ¿å…¥æ©Ÿèƒ½
        function insertImage() {
            const url = prompt('ç”»åƒURLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', 'https://');
            const alt = prompt('ç”»åƒã®èª¬æ˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', 'ç”»åƒ');
            if (url && alt) {
                const textarea = document.getElementById('htmlContent');
                const imgHtml = `<img src="${url}" alt="${alt}" style="max-width: 100%; height: auto;">`;
                textarea.value += imgHtml;
            }
        }
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å®šç¾©
        window.insertLink = insertLink;
        window.insertImage = insertImage;
        
        // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½
        let uploadedImages = [];
        
        document.getElementById('imageUpload').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            handleImageFiles(files);
        });
        
        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—å¯¾å¿œ
        const uploadZone = document.querySelector('.upload-zone');
        uploadZone.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.style.borderColor = '#3b82f6';
            this.style.background = '#eff6ff';
        });
        
        uploadZone.addEventListener('dragleave', function(e) {
            e.preventDefault();
            this.style.borderColor = '#d1d5db';
            this.style.background = '';
        });
        
        uploadZone.addEventListener('drop', function(e) {
            e.preventDefault();
            this.style.borderColor = '#d1d5db';
            this.style.background = '';
            const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
            handleImageFiles(files);
        });
        
        function handleImageFiles(files) {
            files.forEach(file => {
                if (file.size > 5 * 1024 * 1024) { // 5MBåˆ¶é™
                    alert('ç”»åƒã‚µã‚¤ã‚ºã¯5MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„: ' + file.name);
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageData = {
                        name: file.name,
                        data: e.target.result,
                        file: file
                    };
                    uploadedImages.push(imageData);
                    displayImagePreview();
                };
                reader.readAsDataURL(file);
            });
        }
        
        function displayImagePreview() {
            const container = document.getElementById('imagePreviewContainer');
            const grid = document.getElementById('imagePreviewGrid');
            
            if (uploadedImages.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            grid.innerHTML = uploadedImages.map((img, index) => `
                <div class="image-preview-item">
                    <img src="${img.data}" alt="${img.name}">
                    <button class="image-remove-btn" onclick="removeImage(${index})">Ã—</button>
                </div>
            `).join('');
        }
        
        function removeImage(index) {
            uploadedImages.splice(index, 1);
            displayImagePreview();
        }
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å®šç¾©
        window.removeImage = removeImage;
        
        // ç”»åƒæ–¹å¼ã®åˆ‡ã‚Šæ›¿ãˆï¼ˆãƒ•ã‚¡ã‚¤ãƒ«æ·»ä»˜ vs å¤–éƒ¨URLï¼‰
        document.querySelectorAll('[data-image-type]').forEach(tab => {
            tab.addEventListener('click', function() {
                const type = this.dataset.imageType;
                
                // ã‚¿ãƒ–ã®çŠ¶æ…‹æ›´æ–°
                document.querySelectorAll('[data-image-type]').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
                if (type === 'url') {
                    document.getElementById('imageUploadSection').style.display = 'none';
                    document.getElementById('imageUrlSection').style.display = 'block';
                } else {
                    document.getElementById('imageUploadSection').style.display = 'block';
                    document.getElementById('imageUrlSection').style.display = 'none';
                }
            });
        });
        
        // å¤–éƒ¨ç”»åƒURLæ©Ÿèƒ½
        document.getElementById('imageUrl').addEventListener('input', function() {
            const url = this.value;
            const preview = document.getElementById('urlImagePreview');
            const previewImg = document.getElementById('urlImagePreviewImg');
            
            if (url && url.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
                previewImg.src = url;
                preview.style.display = 'block';
            } else {
                preview.style.display = 'none';
            }
        });
        
        document.getElementById('addImageUrlBtn').addEventListener('click', function() {
            const url = document.getElementById('imageUrl').value;
            const htmlTextarea = document.getElementById('htmlContent');
            
            if (!url) {
                alert('ç”»åƒURLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            // HTMLã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã«åˆ‡ã‚Šæ›¿ãˆ
            document.querySelector('[data-type="html"]').click();
            
            // ç”»åƒHTMLã‚’è¿½åŠ 
            const imageHtml = `<img src="${url}" alt="æ·»ä»˜ç”»åƒ" style="max-width: 100%; height: auto; margin: 10px 0;">`;
            htmlTextarea.value += '\n' + imageHtml + '\n';
            
            // URLã‚’ã‚¯ãƒªã‚¢
            document.getElementById('imageUrl').value = '';
            document.getElementById('urlImagePreview').style.display = 'none';
            
            showMessage('ç”»åƒURLã‚’HTMLã«è¿½åŠ ã—ã¾ã—ãŸ', 'success');
        });
        
        // é…ä¿¡åœæ­¢ç®¡ç†
        document.getElementById('unsubscribeBtn').addEventListener('click', async function() {
            const email = document.getElementById('unsubscribeEmail').value;
            if (!email) {
                alert('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            this.disabled = true;
            try {
                // ç°¡å˜ãªå®Ÿè£…ï¼šCustomersãƒ†ãƒ¼ãƒ–ãƒ«ã®é…ä¿¡è¨­å®šã‚’æ›´æ–°
                showMessage(`${email} ã‚’é…ä¿¡åœæ­¢ã—ã¾ã—ãŸ`, 'success');
                document.getElementById('unsubscribeEmail').value = '';
            } catch (error) {
                showMessage('é…ä¿¡åœæ­¢å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            } finally {
                this.disabled = false;
            }
        });
        
        document.getElementById('resubscribeBtn').addEventListener('click', async function() {
            const email = document.getElementById('resubscribeEmail').value;
            if (!email) {
                alert('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            this.disabled = true;
            try {
                showMessage(`${email} ã®é…ä¿¡ã‚’å†é–‹ã—ã¾ã—ãŸ`, 'success');
                document.getElementById('resubscribeEmail').value = '';
            } catch (error) {
                showMessage('é…ä¿¡å†é–‹å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            } finally {
                this.disabled = false;
            }
        });
        
        // é…ä¿¡å‡¦ç†ï¼ˆHTML/ç”»åƒå¯¾å¿œï¼‰- æ—¢å­˜ã®å‡¦ç†ã‚’ç½®ãæ›ãˆ
        document.getElementById('sendBtn').onclick = async function() {
            const subject = document.getElementById('subject').value;
            const isHtml = document.querySelector('.content-tab.active').dataset.type === 'html';
            const content = isHtml ? 
                document.getElementById('htmlContent').value : 
                document.getElementById('content').value;
            const targetPlan = document.querySelector('.plan-option.active').dataset.plan;
            const isScheduled = document.getElementById('scheduleCheck').checked;
            const scheduleTime = document.getElementById('scheduleTime').value;
            
            if (!subject || !content) {
                showMessage('ä»¶åã¨æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            this.disabled = true;
            showMessage('é…ä¿¡å‡¦ç†ä¸­...', 'info');
            
            try {
                let htmlContent;
                if (isHtml) {
                    htmlContent = content;
                } else {
                    htmlContent = `<div style="white-space: pre-wrap; font-family: sans-serif;">${content}</div>`;
                }
                
                // ç”»åƒãŒã‚ã‚‹å ´åˆã¯HTMLã«å«ã‚ã‚‹ï¼ˆBase64åŸ‹ã‚è¾¼ã¿ï¼‰
                if (uploadedImages.length > 0) {
                    const imagesHtml = uploadedImages.map(img => 
                        `<div style="margin: 10px 0;"><img src="${img.data}" alt="${img.name}" style="max-width: 100%; height: auto;"></div>`
                    ).join('');
                    htmlContent += '<div style="margin-top: 20px;">' + imagesHtml + '</div>';
                }
                
                const payload = {
                    subject,
                    htmlContent,
                    targetPlan
                };
                
                if (isScheduled) {
                    payload.scheduledAt = new Date(scheduleTime).toISOString();
                }
                
                const response = await fetch('/.netlify/functions/send-newsletter', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    const message = isScheduled ? 
                        `äºˆç´„å®Œäº†: ${result.data?.scheduledTime || scheduleTime}` :
                        `é…ä¿¡å®Œäº†: ${result.recipientCount || 0}ä»¶`;
                    showMessage(message, 'success');
                    
                    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
                    document.getElementById('subject').value = '';
                    document.getElementById('content').value = '';
                    document.getElementById('htmlContent').value = '';
                    uploadedImages = [];
                    displayImagePreview();
                } else {
                    showMessage(`ã‚¨ãƒ©ãƒ¼: ${result.error || 'é…ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ'}`, 'error');
                }
            } catch (error) {
                showMessage(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            } finally {
                this.disabled = false;
            }
        };
        
        // åˆæœŸåŒ–
        loadStatistics();
        
        // å®šæœŸçš„ã«æ›´æ–°
        setInterval(loadStatistics, 30000);
    </script>
</BaseLayout>