---
// ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ¡ãƒ«ãƒã‚¬é…ä¿¡ç®¡ç†ç”»é¢
import BaseLayout from '../layouts/BaseLayout.astro';

// ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§é¡§å®¢çµ±è¨ˆã‚’å–å¾—
let customerStats = {
    total: 0,
    free: 0,
    standard: 0,
    premium: 0,
    test: 0
};

let debugInfo = {
    hasApiKey: false,
    hasBaseId: false,
    apiCallSuccess: false,
    recordCount: 0,
    errorMessage: '',
    sampleRecords: [],
    uniquePlanValues: new Set(),
    planCounts: {}
};

try {
    const AIRTABLE_API_KEY = import.meta.env.AIRTABLE_API_KEY;
    const AIRTABLE_BASE_ID = import.meta.env.AIRTABLE_BASE_ID;

    debugInfo.hasApiKey = !!AIRTABLE_API_KEY;
    debugInfo.hasBaseId = !!AIRTABLE_BASE_ID;

    if (AIRTABLE_API_KEY && AIRTABLE_BASE_ID) {
        // ğŸ”„ ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œ: å…¨ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
        let allRecords = [];
        let offset = null;
        let pageCount = 0;

        do {
            pageCount++;
            let url = `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/Customers?pageSize=100`;
            if (offset) {
                url += `&offset=${offset}`;
            }

            const response = await fetch(url, {
                headers: {
                    'Authorization': `Bearer ${AIRTABLE_API_KEY}`,
                    'Content-Type': 'application/json'
                }
            });

            debugInfo.apiCallSuccess = response.ok;

            if (response.ok) {
                const data = await response.json();
                allRecords.push(...data.records);
                offset = data.offset; // æ¬¡ã®ãƒšãƒ¼ã‚¸ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆ

                console.log(`ğŸ“„ ãƒšãƒ¼ã‚¸ ${pageCount}: ${data.records.length}ä»¶å–å¾—, ç´¯è¨ˆ: ${allRecords.length}ä»¶`);
            } else {
                debugInfo.errorMessage = `API Error: ${response.status} ${response.statusText}`;
                break;
            }
        } while (offset); // offsetãŒå­˜åœ¨ã™ã‚‹é™ã‚Šç¶™ç¶š

        debugInfo.recordCount = allRecords.length;
        console.log(`âœ… å…¨ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†: åˆè¨ˆ ${allRecords.length}ä»¶ (${pageCount}ãƒšãƒ¼ã‚¸)`);

        if (allRecords.length > 0) {

            allRecords.forEach((record, index) => {
                customerStats.total++;

                // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã®ç¢ºèªï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
                const fields = record.fields;

                // å…¨ã¦ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’è©³ç´°åˆ†æï¼ˆæœ€åˆã®10ä»¶ï¼‰
                const planField = fields['ãƒ—ãƒ©ãƒ³'] || fields['Plan'] || fields['plan'] || fields['PLAN'] ||
                                 fields['Subscription'] || fields['ä¼šå“¡ç¨®åˆ¥'];

                if (debugInfo.sampleRecords.length < 10) {
                    debugInfo.sampleRecords.push({
                        index: index + 1,
                        fields: Object.keys(fields),
                        planField: planField,
                        email: fields['Email'] || fields['email'] || 'unknown'
                    });
                }

                // å¯èƒ½ãªãƒ—ãƒ©ãƒ³ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã‚’ç¢ºèªï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¯è¨­å®šã—ãªã„ï¼‰
                const planValue = fields['ãƒ—ãƒ©ãƒ³'] || fields['Plan'] || fields['plan'] || fields['PLAN'] ||
                                 fields['Subscription'] || fields['ä¼šå“¡ç¨®åˆ¥'];

                // å…¨ã¦ã®ãƒ—ãƒ©ãƒ³å€¤ã‚’åé›†
                debugInfo.uniquePlanValues.add(planValue);
                if (debugInfo.planCounts[planValue]) {
                    debugInfo.planCounts[planValue]++;
                } else {
                    debugInfo.planCounts[planValue] = 1;
                }

                // null/undefined/ç©ºæ–‡å­—ã®å ´åˆã¯äº‹å‰ã«Freeåˆ¤å®š
                if (!planValue || planValue === null || planValue === undefined || planValue === '') {
                    customerStats.free++;
                    console.log(`ç©ºã®ãƒ—ãƒ©ãƒ³å€¤: "${planValue}" -> Free`);
                    return; // forEachã§ã¯continueã®ä»£ã‚ã‚Šã«returnã‚’ä½¿ç”¨
                }

                const plan = String(planValue).toLowerCase().trim();

                // Airtableã®å®Ÿéš›ã®ãƒ—ãƒ©ãƒ³å€¤ã«åŸºã¥ãæ­£ç¢ºãªåˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
                if (plan === 'standard' || plan === 'ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰') {
                    customerStats.standard++;
                    console.log(`Standardåˆ¤å®š: "${planValue}"`);
                } else if (plan === 'premium' || plan === 'ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ') {
                    customerStats.premium++;
                    console.log(`Premiumåˆ¤å®š: "${planValue}"`);
                } else if (plan === 'test' || plan === 'ãƒ†ã‚¹ãƒˆ') {
                    customerStats.test++;
                    console.log(`Teståˆ¤å®š: "${planValue}"`);
                } else if (plan === 'free' || plan === 'ãƒ•ãƒªãƒ¼') {
                    customerStats.free++;
                    console.log(`Freeåˆ¤å®š: "${planValue}"`);
                } else {
                    // æœªåˆ†é¡ã®å ´åˆã‚‚è©³ç´°ãƒ­ã‚°ã«è¨˜éŒ²ã—ã¦ã‹ã‚‰Freeã«åˆ†é¡
                    console.log(`æœªåˆ†é¡ãƒ—ãƒ©ãƒ³å€¤: "${planValue}" (type: ${typeof planValue}) -> Freeæ‰±ã„`);
                    customerStats.free++;
                }
            });
        }
    } else {
        debugInfo.errorMessage = 'Missing API credentials';
    }
} catch (error) {
    debugInfo.errorMessage = error.message;
}
---

<BaseLayout title="ãƒ¡ãƒ«ãƒã‚¬é…ä¿¡ - NANKANã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹">
    <style>
        .newsletter-admin {
            min-height: 100vh;
            background: #f8fafc;
            padding: 20px;
        }
        
        .admin-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .admin-header h1 {
            font-size: 1.8rem;
            color: #1f2937;
            margin-bottom: 5px;
        }
        
        .admin-container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .card h2 {
            color: #1f2937;
            font-size: 1.3rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            color: #374151;
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        textarea.form-control {
            min-height: 200px;
            resize: vertical;
            font-family: inherit;
        }
        
        select.form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            font-size: 16px;
            margin-top: 5px;
        }

        select.form-control:focus {
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }
        
        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            font-size: 15px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border: 2px solid #3b82f6;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
            transform: translateY(-1px);
            border-color: #1d4ed8;
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.6);
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
            border: 2px solid #9ca3af;
            box-shadow: 0 4px 15px rgba(107, 114, 128, 0.4);
        }
        
        .btn-secondary:hover {
            background: #4b5563;
            transform: translateY(-1px);
            border-color: #6b7280;
            box-shadow: 0 8px 25px rgba(107, 114, 128, 0.6);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }
        
        .status-message.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
            display: block;
        }
        
        .status-message.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
            display: block;
        }
        
        .status-message.info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #3b82f6;
            display: block;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-box {
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        
        .stat-label {
            font-size: 0.85rem;
            color: #6b7280;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
        }
        
        .schedule-option {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-top: 10px;
        }
        
        .schedule-option input[type="datetime-local"] {
            flex: 1;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        
        /* HTML/ãƒ†ã‚­ã‚¹ãƒˆåˆ‡ã‚Šæ›¿ãˆã‚¿ãƒ– */
        .content-type-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
        }
        
        .content-tab {
            padding: 8px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }
        
        .content-tab:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        
        .content-tab.active {
            border-color: #3b82f6;
            background: #3b82f6;
            color: white;
        }
        
        /* HTMLã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ */
        .html-toolbar {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
            padding: 10px;
            background: #f9fafb;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        
        .html-btn {
            padding: 5px 10px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        
        .html-btn:hover {
            background: #3b82f6;
            color: white;
        }
        
        .html-textarea {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            min-height: 250px;
            white-space: pre-wrap;
            overflow-wrap: break-word;
            word-wrap: break-word;
            tab-size: 4;
        }
        
        /* ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ */
        .image-upload-area {
            margin-top: 10px;
        }
        
        .upload-zone {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .upload-zone:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        
        .upload-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .upload-text strong {
            display: block;
            margin-bottom: 5px;
            color: #374151;
        }
        
        .upload-text small {
            color: #6b7280;
            font-size: 0.85rem;
        }
        
        .image-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .image-preview-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }
        
        .image-preview-item img {
            width: 100%;
            height: 80px;
            object-fit: cover;
        }
        
        .image-remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #ef4444;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* é…ä¿¡åœæ­¢ç®¡ç† */
        .unsubscribe-section {
            padding: 0;
        }
        
        .unsubscribe-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .unsubscribe-stats {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }
    </style>
    
    <div class="newsletter-admin">
        <div class="admin-header">
            <h1>ğŸ“§ ãƒ¡ãƒ«ãƒã‚¬é…ä¿¡ã‚·ã‚¹ãƒ†ãƒ </h1>
            <p style="color: #6b7280; margin: 0;">ã‚·ãƒ³ãƒ—ãƒ«ï¼†ç¢ºå®Ÿãªé…ä¿¡ç®¡ç†</p>
        </div>
        
        <div class="admin-container">
            <!-- é…ä¿¡çµ±è¨ˆ -->
            <div class="card">
                <h2>ğŸ“Š é…ä¿¡çµ±è¨ˆ</h2>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-label">ç·é¡§å®¢æ•°</div>
                        <div class="stat-value" id="totalCustomers">{customerStats.total}</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Freeä¼šå“¡</div>
                        <div class="stat-value" id="freeCount">{customerStats.free}</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Standardä¼šå“¡</div>
                        <div class="stat-value" id="standardCount">{customerStats.standard}</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Premiumä¼šå“¡</div>
                        <div class="stat-value" id="premiumCount">{customerStats.premium}</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">ğŸ§ª ãƒ†ã‚¹ãƒˆä¼šå“¡</div>
                        <div class="stat-value" id="testCount">{customerStats.test}</div>
                    </div>
                </div>

                <!-- é…ä¿¡ç¢ºèªãƒœã‚¿ãƒ³ -->
                <div style="margin-top: 15px; text-align: center;">
                    <button class="btn btn-secondary" id="checkLastDelivery" style="background: #059669; color: white;">
                        ğŸ“§ æœ€æ–°é…ä¿¡æ•°ã‚’ç¢ºèª
                    </button>
                </div>

                <!-- é…ä¿¡çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                <div id="deliveryResult" style="margin-top: 15px; padding: 15px; background: #f0fdf4; border-radius: 8px; border-left: 4px solid #10b981; display: none;">
                    <h4 style="color: #065f46; margin: 0 0 10px 0;">ğŸ“Š é…ä¿¡çµæœ</h4>
                    <div id="deliveryDetails" style="font-family: monospace; font-size: 14px; color: #1f2937;">
                        ç¢ºèªä¸­...
                    </div>
                </div>
            </div>

            <!-- ãƒ¡ãƒ¼ãƒ«ä½œæˆãƒ•ã‚©ãƒ¼ãƒ  -->
            <div class="card">
                <h2>âœ‰ï¸ ãƒ¡ãƒ¼ãƒ«ä½œæˆ</h2>

                <div class="form-group">
                    <label>é…ä¿¡å¯¾è±¡</label>
                    <select id="targetPlan" class="form-control">
                        <option value="all">å…¨å“¡ (${customerStats.total}å)</option>
                        <option value="free">Freeä¼šå“¡ (${customerStats.free}å)</option>
                        <option value="standard">Standardä¼šå“¡ (${customerStats.standard}å)</option>
                        <option value="premium">Premiumä¼šå“¡ (${customerStats.premium}å)</option>
                        <option value="test">ğŸ§ª ãƒ†ã‚¹ãƒˆç”¨</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>ä»¶å</label>
                    <input type="text" class="form-control" id="subject"
                           placeholder="ä¾‹ï¼šã€å—é–¢ç«¶é¦¬ã€‘æœ¬æ—¥ã®äºˆæƒ³é…ä¿¡">
                </div>

                <div class="form-group">
                    <label>æœ¬æ–‡å½¢å¼</label>
                    <div class="content-type-tabs">
                        <button type="button" class="content-tab active" data-type="text">ğŸ“ ãƒ†ã‚­ã‚¹ãƒˆ</button>
                        <button type="button" class="content-tab" data-type="html">ğŸŒ HTML</button>
                        <button type="button" class="content-tab" data-type="template">ğŸ¨ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</button>
                    </div>
                </div>

                <div class="form-group">
                    <label id="contentLabel">æœ¬æ–‡</label>
                    <div id="textEditor">
                        <textarea class="form-control" id="content"
                                  placeholder="ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."></textarea>
                    </div>
                    <div id="htmlEditor" style="display: none;">
                        <div class="html-toolbar">
                            <button type="button" class="html-btn" data-tag="b">å¤ªå­—</button>
                            <button type="button" class="html-btn" data-tag="i">æ–œä½“</button>
                            <button type="button" class="html-btn" data-tag="u">ä¸‹ç·š</button>
                            <button type="button" class="html-btn" onclick="insertLink()">ğŸ”— ãƒªãƒ³ã‚¯</button>
                            <button type="button" class="html-btn" onclick="insertImage()">ğŸ–¼ï¸ ç”»åƒ</button>
                            <button type="button" class="html-btn" onclick="formatHTML()" style="margin-left: 10px; background: #10b981; color: white;">ğŸ“ æ•´å½¢</button>
                        </div>
                        <textarea class="form-control html-textarea" id="htmlContent"
                                  placeholder="HTMLã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã™ã‚‹ã‹ã€ä¸Šã®ãƒœã‚¿ãƒ³ã§HTMLã‚¿ã‚°ã‚’è¿½åŠ ã—ã¦ãã ã•ã„..."></textarea>
                        <div class="html-preview">
                            <button type="button" id="previewToggle" class="btn btn-secondary">ğŸ‘ï¸ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
                            <div id="previewPane" style="display: none; margin-top: 10px; padding: 15px; border: 1px solid #d1d5db; border-radius: 8px; background: #f9fafb;">
                                <div id="previewContent"></div>
                            </div>
                        </div>
                    </div>

                    <!-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ -->
                    <div id="templateEditor" style="display: none;">
                        <div class="template-selector" style="margin-bottom: 15px;">
                            <label>ğŸ“‹ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠ</label>
                            <select class="form-control" id="templateSelect" style="margin-top: 8px;">
                                <option value="">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠ...</option>
                                <option value="newsletter">ğŸ“§ åŸºæœ¬ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ¬ã‚¿ãƒ¼</option>
                                <option value="prediction">ğŸ¯ äºˆæƒ³é…ä¿¡ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</option>
                                <option value="promotion">ğŸ‰ ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³</option>
                                <option value="stripePromo">ğŸ Stripeãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰</option>
                                <option value="welcome">ğŸ‘‹ ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒ¡ãƒ¼ãƒ«</option>
                                <option value="announcement">ğŸ“¢ ãŠçŸ¥ã‚‰ã›</option>
                            </select>
                        </div>

                        <div id="templateDescription" style="display: none; background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #0ea5e9;">
                            <h4 style="margin: 0 0 8px 0; color: #0c4a6e;" id="templateName"></h4>
                            <p style="margin: 0; color: #0369a1; font-size: 14px;" id="templateDesc"></p>
                        </div>

                        <div class="template-content" style="margin-bottom: 15px;">
                            <label>âœï¸ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„</label>
                            <textarea class="form-control" id="templateContent" rows="8"
                                      placeholder="ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠã™ã‚‹ã¨ã€ç·¨é›†å¯èƒ½ãªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒè¡¨ç¤ºã•ã‚Œã¾ã™..."></textarea>
                            <small style="color: #6b7280; font-size: 12px;">
                                ğŸ’¡ ãƒ’ãƒ³ãƒˆ: å‹•çš„ãªå¤‰æ•°ã®ç½®æ›ãŒå¯èƒ½ã§ã™
                            </small>
                        </div>

                        <div class="template-variables" style="margin-bottom: 15px;">
                            <label>ğŸ”§ ã‚«ã‚¹ã‚¿ãƒ å¤‰æ•° (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)</label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 8px;">
                                <input type="text" class="form-control" id="customVar1" placeholder="å¤‰æ•°å (ä¾‹: PRICE)">
                                <input type="text" class="form-control" id="customVal1" placeholder="å€¤ (ä¾‹: 4,990)">
                                <input type="text" class="form-control" id="customVar2" placeholder="å¤‰æ•°å (ä¾‹: DISCOUNT)">
                                <input type="text" class="form-control" id="customVal2" placeholder="å€¤ (ä¾‹: 50)">
                            </div>
                        </div>

                        <div class="template-actions">
                            <button type="button" class="btn btn-secondary" id="templatePreview">ğŸ‘ï¸ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
                            <button type="button" class="btn btn-primary" id="useTemplate">âœ… ã“ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ç”¨</button>
                        </div>

                        <div id="templatePreviewPane" style="display: none; margin-top: 15px; padding: 15px; border: 1px solid #d1d5db; border-radius: 8px; background: #ffffff; max-height: 400px; overflow-y: auto;">
                            <h4 style="margin: 0 0 10px 0; color: #1f2937;">ğŸ“§ ãƒ¡ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h4>
                            <div id="templatePreviewContent"></div>
                        </div>
                    </div>
                </div>

                <!-- ç”»åƒæ·»ä»˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="form-group">
                    <label>ç”»åƒæ·»ä»˜ (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)</label>

                    <!-- äºˆç´„é…ä¿¡æ™‚ã®é‡è¦ãªæ³¨æ„ -->
                    <div id="imageScheduleWarning" class="status-message" style="display: none; background: #fef3c7; color: #92400e; border: 1px solid #f59e0b;">
                        âš ï¸ <strong>äºˆç´„é…ä¿¡ã§ã®ç”»åƒã«ã¤ã„ã¦ï¼š</strong><br>
                        äºˆç´„é…ä¿¡ã§ã¯å¤§å®¹é‡ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã§ãã¾ã›ã‚“ã€‚<br>
                        <strong>æ¨å¥¨ï¼š</strong> ç”»åƒã‚’å¤–éƒ¨ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¾Œã€HTMLã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã§<code>&lt;img src="URL"&gt;</code>ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
                    </div>

                    <div class="content-type-tabs" style="margin-top: 10px;">
                        <button type="button" class="content-tab active" data-image-type="upload">ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«æ·»ä»˜</button>
                        <button type="button" class="content-tab" data-image-type="url">ğŸŒ å¤–éƒ¨URL</button>
                    </div>

                    <!-- ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ–¹å¼ -->
                    <div id="imageUploadSection" class="image-upload-area" style="margin-top: 15px;">
                        <input type="file" id="imageUpload" accept="image/*" multiple style="display: none;">
                        <div class="upload-zone" onclick="document.getElementById('imageUpload').click();">
                            <div class="upload-icon">ğŸ“</div>
                            <div class="upload-text">
                                <strong>ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</strong>
                                <small>ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç”»åƒã‚’é¸æŠã€ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—<br>â€» å³æ™‚é…ä¿¡ã®ã¿å¯¾å¿œ</small>
                            </div>
                        </div>
                        <div id="imagePreviewContainer" style="display: none;">
                            <div class="image-preview-grid" id="imagePreviewGrid"></div>
                        </div>
                    </div>

                    <!-- å¤–éƒ¨URLæ–¹å¼ -->
                    <div id="imageUrlSection" style="display: none; margin-top: 15px;">
                        <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; border: 1px solid #0ea5e9; margin-bottom: 15px;">
                            <h4 style="margin: 0 0 10px 0; color: #0c4a6e;">ğŸŒŸ æ¨å¥¨ï¼šå¤–éƒ¨ç”»åƒãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°</h4>
                            <p style="margin: 0 0 10px 0; font-size: 14px; color: #075985;">
                                <strong>äºˆç´„é…ä¿¡ã‚‚ç¢ºå®Ÿå‹•ä½œï¼</strong> ç”»åƒã‚’ä»¥ä¸‹ã®ã‚µãƒ¼ãƒ“ã‚¹ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦URLã‚’å–å¾—ï¼š
                            </p>
                            <ul style="margin: 0; padding-left: 20px; font-size: 13px; color: #0369a1;">
                                <li><strong>Google Drive</strong>ï¼ˆç„¡æ–™ãƒ»å…±æœ‰ãƒªãƒ³ã‚¯å–å¾—ï¼‰</li>
                                <li><strong>Imgur</strong>ï¼ˆç„¡æ–™ãƒ»ç”»åƒå°‚ç”¨ï¼‰</li>
                                <li><strong>Cloudinary</strong>ï¼ˆãƒ—ãƒ­ä»•æ§˜ãƒ»é«˜é€ŸCDNï¼‰</li>
                                <li><strong>GitHub</strong>ï¼ˆæŠ€è¡“è€…å‘ã‘ãƒ»æ°¸ç¶šä¿å­˜ï¼‰</li>
                            </ul>
                        </div>

                        <div class="form-group">
                            <label>ç”»åƒURL</label>
                            <input type="url" class="form-control" id="imageUrl"
                                   placeholder="https://example.com/image.jpg">
                            <button type="button" class="btn btn-secondary" id="addImageUrlBtn" style="margin-top: 10px;">HTMLã«è¿½åŠ </button>
                        </div>

                        <div id="urlImagePreview" style="display: none; margin-top: 15px;">
                            <img id="urlImagePreviewImg" style="max-width: 200px; max-height: 150px; border-radius: 8px; border: 1px solid #e5e7eb;">
                        </div>
                    </div>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="scheduleCheck">
                    <label for="scheduleCheck" style="margin: 0; cursor: pointer;">äºˆç´„é…ä¿¡ã™ã‚‹</label>
                </div>

                <div class="schedule-option" id="scheduleOption" style="display: none;">
                    <input type="datetime-local" class="form-control" id="scheduleTime">
                </div>

                <div class="action-buttons">
                    <button class="btn btn-primary" id="sendBtn">
                        <span id="sendBtnText">é…ä¿¡ã™ã‚‹</span>
                    </button>
                </div>

                <div id="statusMessage" class="status-message"></div>
            </div>

            <!-- é…ä¿¡åœæ­¢ç®¡ç† -->
            <div class="card">
                <h2>ğŸš« é…ä¿¡åœæ­¢ç®¡ç†</h2>
                <div class="unsubscribe-section">
                    <div class="form-group">
                        <label>é…ä¿¡åœæ­¢å‡¦ç†</label>
                        <div class="unsubscribe-actions">
                            <input type="email" class="form-control" id="unsubscribeEmail"
                                   placeholder="é…ä¿¡åœæ­¢ã™ã‚‹ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" style="flex: 1; margin-right: 10px;">
                            <button class="btn btn-secondary" id="unsubscribeBtn">é…ä¿¡åœæ­¢</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>é…ä¿¡å†é–‹</label>
                        <div class="unsubscribe-actions">
                            <input type="email" class="form-control" id="resubscribeEmail"
                                   placeholder="é…ä¿¡å†é–‹ã™ã‚‹ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" style="flex: 1; margin-right: 10px;">
                            <button class="btn btn-primary" id="resubscribeBtn">é…ä¿¡å†é–‹</button>
                        </div>
                    </div>

                    <div class="unsubscribe-stats">
                        <div class="stat-box">
                            <div class="stat-label">é…ä¿¡åœæ­¢è€…æ•°</div>
                            <div class="stat-value" id="unsubscribedCount">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ãƒ‡ãƒãƒƒã‚°æƒ…å ± -->
            <div class="card" style="background: #ffffff; border: 2px solid #f59e0b; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                    <h2 style="color: #92400e; margin: 0;">ğŸ”§ ãƒ‡ãƒãƒƒã‚°æƒ…å ±</h2>
                    <button type="button" id="debugToggle" style="background: #f59e0b; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 12px; cursor: pointer;">è©³ç´°è¡¨ç¤º</button>
                </div>

                <!-- ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆè¡¨ç¤º -->
                <div id="debugSummary" style="font-family: monospace; font-size: 13px; color: #1f2937;">
                    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                        <span><strong>API:</strong> {debugInfo.hasApiKey && debugInfo.hasBaseId ? 'âœ…' : 'âŒ'}</span>
                        <span><strong>æ¥ç¶š:</strong> {debugInfo.apiCallSuccess ? 'âœ…' : 'âŒ'}</span>
                        <span><strong>ãƒ¬ã‚³ãƒ¼ãƒ‰:</strong> {debugInfo.recordCount}ä»¶</span>
                        {debugInfo.errorMessage && <span style="color: red;"><strong>ã‚¨ãƒ©ãƒ¼æœ‰ã‚Š</strong></span>}
                    </div>
                </div>

                <!-- è©³ç´°è¡¨ç¤ºï¼ˆåˆæœŸéè¡¨ç¤ºï¼‰ -->
                <div id="debugDetails" style="display: none; font-family: monospace; font-size: 14px; color: #1f2937; margin-top: 15px; border-top: 1px solid #e5e7eb; padding-top: 15px;">
                    <p><strong>API Key:</strong> {debugInfo.hasApiKey ? 'âœ… è¨­å®šæ¸ˆã¿' : 'âŒ æœªè¨­å®š'}</p>
                    <p><strong>Base ID:</strong> {debugInfo.hasBaseId ? 'âœ… è¨­å®šæ¸ˆã¿' : 'âŒ æœªè¨­å®š'}</p>
                    <p><strong>API Call:</strong> {debugInfo.apiCallSuccess ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'}</p>
                    <p><strong>Record Count:</strong> {debugInfo.recordCount}</p>
                    {debugInfo.errorMessage && <p style="color: red;"><strong>Error:</strong> {debugInfo.errorMessage}</p>}

                    <div style="margin-top: 15px;">
                        <h4 style="color: #1f2937; margin-bottom: 10px;">ãƒ—ãƒ©ãƒ³å€¤åˆ†æ:</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px;">
                            {Object.entries(debugInfo.planCounts).map(([planValue, count]) => (
                                <div style="padding: 8px; background: #f9fafb; border-radius: 3px; border-left: 3px solid #3b82f6; font-size: 12px;">
                                    <strong>"{planValue}"</strong> ({count}äºº)
                                </div>
                            ))}
                        </div>
                    </div>

                    {debugInfo.sampleRecords.length > 0 && (
                        <div style="margin-top: 15px;">
                            <h4 style="color: #1f2937; margin-bottom: 10px;">ã‚µãƒ³ãƒ—ãƒ«ãƒ¬ã‚³ãƒ¼ãƒ‰ (æœ€åˆã®3ä»¶):</h4>
                            {debugInfo.sampleRecords.slice(0, 3).map(record => (
                                <div style="margin: 5px 0; padding: 8px; background: #f9fafb; border-radius: 3px; font-size: 12px;">
                                    <strong>{record.email}</strong> â†’ ãƒ—ãƒ©ãƒ³: "{record.planField}"
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            </div>

            
            <!-- ğŸ›¡ï¸ ãƒ‰ãƒ¡ã‚¤ãƒ³ä¿è­· & ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆç®¡ç† -->
            <div class="card">
                <h2>ğŸ›¡ï¸ ãƒ‰ãƒ¡ã‚¤ãƒ³ä¿è­·ã‚·ã‚¹ãƒ†ãƒ </h2>

                <!-- ãƒ‰ãƒ¡ã‚¤ãƒ³ä¿è­·çµ±è¨ˆ -->
                <div class="domain-protection-stats" style="margin-bottom: 25px;">
                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-label">ğŸš« ãƒ–ãƒ­ãƒƒã‚¯ä¸­</div>
                            <div class="stat-value" id="blockedEmailsCount">-</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">âš ï¸ è­¦å‘Šãƒ¬ãƒ™ãƒ«</div>
                            <div class="stat-value" id="warningEmailsCount">-</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">ğŸ“Š å¤±æ•—ç‡</div>
                            <div class="stat-value" id="failureRate">-</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">ğŸ¯ ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«</div>
                            <div class="stat-value" id="overallRisk">-</div>
                        </div>
                    </div>
                </div>

                <!-- ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ -->
                <div class="content-type-tabs">
                    <button type="button" class="content-tab active" data-protection-tab="blacklist">ğŸš« ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆ</button>
                    <button type="button" class="content-tab" data-protection-tab="stats">ğŸ“Š çµ±è¨ˆ</button>
                    <button type="button" class="content-tab" data-protection-tab="whitelist">âœ… å¾©æ—§ç®¡ç†</button>
                </div>

                <!-- ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆè¡¨ç¤º -->
                <div id="blacklistTab" class="protection-tab-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3>ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆä¸€è¦§</h3>
                        <button class="btn btn-secondary" id="refreshBlacklistBtn">ğŸ”„ æ›´æ–°</button>
                    </div>

                    <div id="blacklistContainer" style="max-height: 400px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead style="background-color: #f9fafb; position: sticky; top: 0;">
                                <tr>
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb;">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 1px solid #e5e7eb;">å¤±æ•—å›æ•°</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 1px solid #e5e7eb;">ç¨®åˆ¥</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 1px solid #e5e7eb;">æœ€çµ‚å¤±æ•—</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 1px solid #e5e7eb;">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="blacklistTableBody">
                                <tr>
                                    <td colspan="5" style="padding: 20px; text-align: center; color: #6b7280;">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- çµ±è¨ˆã‚¿ãƒ– -->
                <div id="statsTab" class="protection-tab-content" style="display: none;">
                    <h3>è©³ç´°çµ±è¨ˆ</h3>
                    <div id="detailedStats" style="background: #f9fafb; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 14px;">
                        çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...
                    </div>

                    <h3 style="margin-top: 25px;">æ¨å¥¨äº‹é …</h3>
                    <div id="recommendations" style="background: #fef3c7; padding: 15px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                        æ¨å¥¨äº‹é …ã‚’èª­ã¿è¾¼ã¿ä¸­...
                    </div>
                </div>

                <!-- å¾©æ—§ç®¡ç†ã‚¿ãƒ– -->
                <div id="whitelistTab" class="protection-tab-content" style="display: none;">
                    <h3>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å¾©æ—§</h3>
                    <p style="color: #6b7280; margin-bottom: 15px;">ã‚½ãƒ•ãƒˆãƒã‚¦ãƒ³ã‚¹ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ã¿å¾©æ—§å¯èƒ½ã§ã™ã€‚ãƒãƒ¼ãƒ‰ãƒã‚¦ãƒ³ã‚¹ã‚„è‹¦æƒ…ã¯æ‰‹å‹•ã§ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>

                    <div class="form-group">
                        <label>å¾©æ—§å¯¾è±¡ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                        <div class="unsubscribe-actions">
                            <input type="email" class="form-control" id="whitelistEmail"
                                   placeholder="å¾©æ—§ã™ã‚‹ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" style="flex: 1; margin-right: 10px;">
                            <button class="btn btn-primary" id="whitelistBtn">ğŸ”„ å¾©æ—§</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>å¾©æ—§ç†ç”±</label>
                        <select class="form-control" id="whitelistReason">
                            <option value="user-request">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®è¦è«‹</option>
                            <option value="technical-issue">æŠ€è¡“çš„å•é¡Œã®è§£æ±º</option>
                            <option value="admin-review">ç®¡ç†è€…ã«ã‚ˆã‚‹å†è©•ä¾¡</option>
                            <option value="temporary-failure">ä¸€æ™‚çš„ãªå•é¡Œ</option>
                        </select>
                    </div>

                    <div id="whitelistStatus" class="status-message"></div>
                </div>
            </div>
            
        </div>
    </div>
    
    <script is:inline define:vars={{ customerStats }}>
        // ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã‹ã‚‰å–å¾—ã—ãŸé¡§å®¢çµ±è¨ˆã‚’ä½¿ç”¨
        function initializeStatistics() {
            // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®æ•°ã‚’æ›´æ–°
            if (document.getElementById('allCount')) {
                document.getElementById('allCount').textContent = `${customerStats.total}å`;
            }
            if (document.getElementById('freeCountOption')) {
                document.getElementById('freeCountOption').textContent = `${customerStats.free}å`;
            }
            if (document.getElementById('standardCountOption')) {
                document.getElementById('standardCountOption').textContent = `${customerStats.standard}å`;
            }
            if (document.getElementById('premiumCountOption')) {
                document.getElementById('premiumCountOption').textContent = `${customerStats.premium}å`;
            }
        }
        
        
        // ãƒ—ãƒ©ãƒ³é¸æŠï¼ˆã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹å¯¾å¿œï¼‰

        // é…ä¿¡ç¢ºèªãƒœã‚¿ãƒ³
        document.getElementById('checkLastDelivery').addEventListener('click', async function() {
            const resultDiv = document.getElementById('deliveryResult');
            const detailsDiv = document.getElementById('deliveryDetails');

            resultDiv.style.display = 'block';
            detailsDiv.textContent = 'ç¢ºèªä¸­...';
            this.disabled = true;
            this.textContent = 'ç¢ºèªä¸­...';

            try {
                // å„ãƒ—ãƒ©ãƒ³ã®ç¾åœ¨ã®é…ä¿¡å¯¾è±¡è€…æ•°ã‚’ç¢ºèª
                const stats = {
                    all: ${customerStats.total},
                    free: ${customerStats.free},
                    standard: ${customerStats.standard},
                    premium: ${customerStats.premium}
                };

                detailsDiv.innerHTML = \`
<strong>ğŸ“Š ç¾åœ¨ã®é…ä¿¡å¯¾è±¡è€…æ•°:</strong><br>
å…¨ä½“é…ä¿¡: \${stats.all}å<br>
ç„¡æ–™ä¼šå“¡: \${stats.free}å<br>
Standardä¼šå“¡: \${stats.standard}å<br>
Premiumä¼šå“¡: \${stats.premium}å<br><br>

<strong>ğŸ“§ æ³¨æ„:</strong><br>
â€¢ é…ä¿¡åœæ­¢ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªå‹•é™¤å¤–ã•ã‚Œã¾ã™<br>
â€¢ ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªå‹•é™¤å¤–ã•ã‚Œã¾ã™<br>
â€¢ å®Ÿéš›ã®é…ä¿¡æ•°ã¯è‹¥å¹²ç•°ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™
                \`;

            } catch (error) {
                detailsDiv.innerHTML = \`
<span style="color: #dc2626;">âŒ ã‚¨ãƒ©ãƒ¼:</span><br>
\${error.message}
                \`;
            } finally {
                this.disabled = false;
                this.textContent = 'ğŸ“§ æœ€æ–°é…ä¿¡æ•°ã‚’ç¢ºèª';
            }
        });
        
        // äºˆç´„é…ä¿¡ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
        document.getElementById('scheduleCheck').addEventListener('change', function() {
            const scheduleOption = document.getElementById('scheduleOption');
            const sendBtnText = document.getElementById('sendBtnText');
            const imageWarning = document.getElementById('imageScheduleWarning');
            
            if (this.checked) {
                scheduleOption.style.display = 'flex';
                sendBtnText.textContent = 'äºˆç´„ã™ã‚‹';
                imageWarning.style.display = 'block'; // ç”»åƒè­¦å‘Šã‚’è¡¨ç¤º
                
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§1æ™‚é–“å¾Œã‚’è¨­å®š
                const now = new Date();
                now.setHours(now.getHours() + 1);
                now.setMinutes(0);
                document.getElementById('scheduleTime').value = 
                    now.toISOString().slice(0, 16);
            } else {
                scheduleOption.style.display = 'none';
                sendBtnText.textContent = 'é…ä¿¡ã™ã‚‹';
                imageWarning.style.display = 'none'; // ç”»åƒè­¦å‘Šã‚’éš ã™
            }
        });
        
        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½ã¯å‰Šé™¤æ¸ˆã¿
        
        
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        function showMessage(message, type) {
            const messageDiv = document.getElementById('statusMessage');
            messageDiv.textContent = message;
            messageDiv.className = `status-message ${type}`;
            
            if (type !== 'info') {
                setTimeout(() => {
                    messageDiv.className = 'status-message';
                }, 5000);
            }
        }
        
        // HTML/ãƒ†ã‚­ã‚¹ãƒˆ/ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
        document.querySelectorAll('.content-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const type = this.dataset.type;
                
                // ã‚¿ãƒ–ã®çŠ¶æ…‹æ›´æ–°
                document.querySelectorAll('.content-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                // ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
                document.getElementById('textEditor').style.display = 'none';
                document.getElementById('htmlEditor').style.display = 'none';
                document.getElementById('templateEditor').style.display = 'none';
                
                if (type === 'html') {
                    document.getElementById('htmlEditor').style.display = 'block';
                    document.getElementById('contentLabel').textContent = 'HTMLæœ¬æ–‡';
                } else if (type === 'template') {
                    document.getElementById('templateEditor').style.display = 'block';
                    document.getElementById('contentLabel').textContent = 'ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ';
                } else {
                    document.getElementById('textEditor').style.display = 'block';
                    document.getElementById('contentLabel').textContent = 'æœ¬æ–‡';
                }
            });
        });
        
        // HTMLãƒ„ãƒ¼ãƒ«ãƒãƒ¼æ©Ÿèƒ½
        document.querySelectorAll('.html-btn[data-tag]').forEach(btn => {
            btn.addEventListener('click', function() {
                const tag = this.dataset.tag;
                const textarea = document.getElementById('htmlContent');
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const selectedText = textarea.value.substring(start, end) || 'ãƒ†ã‚­ã‚¹ãƒˆ';
                const newText = `<${tag}>${selectedText}</${tag}>`;
                
                textarea.value = textarea.value.substring(0, start) + newText + textarea.value.substring(end);
                textarea.focus();
                textarea.setSelectionRange(start + tag.length + 2, start + tag.length + 2 + selectedText.length);
            });
        });
        
        // HTMLãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½
        document.getElementById('previewToggle').addEventListener('click', function() {
            const previewPane = document.getElementById('previewPane');
            const previewContent = document.getElementById('previewContent');
            const htmlContent = document.getElementById('htmlContent').value;
            
            if (previewPane.style.display === 'none') {
                previewContent.innerHTML = htmlContent;
                previewPane.style.display = 'block';
                this.textContent = 'ğŸ“ ç·¨é›†ã«æˆ»ã‚‹';
            } else {
                previewPane.style.display = 'none';
                this.textContent = 'ğŸ‘ï¸ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼';
            }
        });
        
        // ãƒªãƒ³ã‚¯æŒ¿å…¥æ©Ÿèƒ½
        function insertLink() {
            const url = prompt('ãƒªãƒ³ã‚¯URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', 'https://');
            const text = prompt('ãƒªãƒ³ã‚¯ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', 'ãƒªãƒ³ã‚¯');
            if (url && text) {
                const textarea = document.getElementById('htmlContent');
                const linkHtml = `<a href="${url}" target="_blank">${text}</a>`;
                textarea.value += linkHtml;
            }
        }
        
        // ç”»åƒæŒ¿å…¥æ©Ÿèƒ½
        function insertImage() {
            const url = prompt('ç”»åƒURLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', 'https://');
            const alt = prompt('ç”»åƒã®èª¬æ˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', 'ç”»åƒ');
            if (url && alt) {
                const textarea = document.getElementById('htmlContent');
                const imgHtml = `<img src="${url}" alt="${alt}" style="max-width: 100%; height: auto;">`;
                textarea.value += imgHtml;
            }
        }
        
        // HTMLæ•´å½¢æ©Ÿèƒ½
        function formatHTML() {
            const textarea = document.getElementById('htmlContent');
            const html = textarea.value;
            
            if (!html.trim()) {
                alert('æ•´å½¢ã™ã‚‹HTMLã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            try {
                // HTMLã‚’æ•´å½¢ã™ã‚‹
                let formatted = html
                    // ã‚¿ã‚°ã®å‰å¾Œã«æ”¹è¡Œã‚’è¿½åŠ 
                    .replace(/></g, '>\n<')
                    // é–‹å§‹ã‚¿ã‚°ã®å¾Œã«æ”¹è¡Œ
                    .replace(/(<\/?)(\w+)([^>]*>)/g, '$1$2$3\n')
                    // é–‰ã˜ã‚¿ã‚°ã®å‰ã«æ”¹è¡Œ
                    .replace(/\n<\//g, '\n</')
                    // ä½™åˆ†ãªæ”¹è¡Œã‚’å‰Šé™¤
                    .replace(/\n\s*\n/g, '\n')
                    // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³è¦ç´ ã¯åŒã˜è¡Œã«ä¿æŒ
                    .replace(/(<(?:b|i|u|strong|em|span|a)[^>]*>)\n/g, '$1')
                    .replace(/\n(<\/(?:b|i|u|strong|em|span|a)>)/g, '$1')
                    // pã‚¿ã‚°ã®ä¸­èº«ã¯åŒã˜è¡Œã«
                    .replace(/(<p[^>]*>)\n([^<]+)\n(<\/p>)/g, '$1$2$3')
                    // å…ˆé ­ã¨æœ«å°¾ã®æ”¹è¡Œã‚’ãƒˆãƒªãƒ 
                    .trim();
                
                textarea.value = formatted;
                
                // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                const button = event.target;
                const originalText = button.innerHTML;
                button.innerHTML = 'âœ… å®Œäº†';
                button.style.background = '#059669';
                
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.style.background = '#10b981';
                }, 1500);
                
            } catch (error) {
                alert('HTMLæ•´å½¢ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å®šç¾©
        window.insertLink = insertLink;
        window.insertImage = insertImage;
        window.formatHTML = formatHTML;
        
        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ©Ÿèƒ½
        const emailTemplates = {
            newsletter: {
                name: 'ğŸ“§ åŸºæœ¬ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ¬ã‚¿ãƒ¼',
                description: 'ã‚·ãƒ³ãƒ—ãƒ«ã§èª­ã¿ã‚„ã™ã„åŸºæœ¬ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ',
                content: '<h2>ğŸ¯ ä»Šé€±ã®äºˆæƒ³å®Ÿç¸¾</h2>' +
'<p>å…ˆé€±ã¯6æˆ¦4å‹ã®å¥½æˆç¸¾ï¼çš„ä¸­ç‡66.7%ã‚’è¨˜éŒ²ã—ã¾ã—ãŸã€‚</p>' +
'<div style="background-color: #eff6ff; padding: 15px; border-left: 4px solid #3b82f6; margin: 15px 0;">' +
'<h3>ğŸ“Š é€±é–“ãƒã‚¤ãƒ©ã‚¤ãƒˆ</h3>' +
'<ul>' +
'<li><strong>å·å´11R:</strong> 3é€£è¤‡ Â¥8,460çš„ä¸­ (æ¨å¥¨Â¥500 â†’ åˆ©ç›ŠÂ¥3,730)</li>' +
'<li><strong>å¤§äº•10R:</strong> é¦¬å˜ Â¥3,280çš„ä¸­ (æ¨å¥¨Â¥1,000 â†’ åˆ©ç›ŠÂ¥2,280)</li>' +
'<li><strong>æµ¦å’Œ12R:</strong> 3é€£å˜ Â¥15,890çš„ä¸­ (æ¨å¥¨Â¥200 â†’ åˆ©ç›ŠÂ¥2,978)</li>' +
'</ul>' +
'</div>' +
'<h2>ğŸš€ æ¥é€±ã®æ³¨ç›®ãƒ¬ãƒ¼ã‚¹</h2>' +
'<p>æ¥é€±ã¯<strong>å·å´è¨˜å¿µ</strong>ã®å‰å“¨æˆ¦ãŒé–‹å‚¬äºˆå®šã€‚é‡è³å€™è£œã®å‹•å‘ã«æ³¨ç›®ã§ã™ã€‚</p>'
            },
            prediction: {
                name: 'ğŸ¯ äºˆæƒ³é…ä¿¡ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ',
                description: 'ç«¶é¦¬äºˆæƒ³ã«ç‰¹åŒ–ã—ãŸãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ',
                content: '<h2>ğŸ‡ ä»Šæ—¥ã®å—é–¢ç«¶é¦¬AIäºˆæƒ³</h2>' +
'<div style="background-color: #334155; padding: 20px; border-radius: 12px; margin: 20px 0;">' +
'<h3 style="color: #ffffff; margin: 0 0 15px 0;">å·å´12R ã‚µãƒ©ç³»3æ­³ä»¥ä¸Š</h3>' +
'<div style="color: #94a3b8; font-size: 13px; margin-bottom: 15px;">ğŸ“… æœ¬æ—¥ | â° 20:45ç™ºèµ° | ğŸƒ 1400m</div>' +
'<div style="display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #475569;">' +
'<div style="font-size: 24px; width: 40px; text-align: center;">â—</div>' +
'<div style="flex: 1; margin-left: 15px;">' +
'<h4 style="color: #ffffff; margin: 0;">8ç•ª ã‚­ãƒãƒ§ã‚¦</h4>' +
'<p style="color: #94a3b8; font-size: 13px; margin: 3px 0 0 0;">å‰èµ°å¥½å†…å®¹ã€‚ä»Šå›ã‚‚ä¸Šä½æœŸå¾…ã€‚</p>' +
'</div>' +
'<div style="background-color: #059669; color: #ffffff; padding: 4px 8px; border-radius: 4px; font-size: 12px;">ä¿¡é ¼åº¦ 85%</div>' +
'</div>' +
'<div style="background-color: #065f46; padding: 15px; margin: 15px 0; border-radius: 8px;">' +
'<h3 style="color: #ffffff; margin: 0 0 10px 0;">ğŸ’¡ æ¨å¥¨æŠ•è³‡æˆ¦ç•¥</h3>' +
'<p style="color: #ffffff; margin: 0;"><strong>é¦¬å˜:</strong> 8â†’6 (1,000å††)<br>' +
'<strong>3é€£è¤‡:</strong> 6-8-2 (500å††)<br>' +
'<strong>æœŸå¾…åç›Š:</strong> +2,400å†† (240%)</p>' +
'</div>' +
'</div>'
            },
            promotion: {
                name: 'ğŸ‰ ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³',
                description: 'ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã‚„ç‰¹åˆ¥ã‚ªãƒ•ã‚¡ãƒ¼ç”¨',
                content: '<h2>ğŸŠ æœŸé–“é™å®šç‰¹åˆ¥ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³</h2>' +
'<div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 20px; border-radius: 12px; margin: 20px 0; text-align: center; border: 2px solid #f59e0b;">' +
'<h3 style="color: #92400e; margin: 0 0 10px 0;">ğŸ’ Premiumä¼šå“¡</h3>' +
'<div style="font-size: 36px; color: #dc2626; font-weight: 800; margin: 10px 0;">Â¥4,990/æœˆ</div>' +
'<p style="color: #059669; font-weight: 600; margin: 0;">ğŸ¯ åˆæœˆ50%OFF!</p>' +
'</div>' +
'<h3>ğŸŒŸ ç‰¹å…¸å†…å®¹</h3>' +
'<ul>' +
'<li>ğŸ¤– <strong>AIäºˆæƒ³</strong>: æ©Ÿæ¢°å­¦ç¿’ã«ã‚ˆã‚‹é«˜ç²¾åº¦äºˆæƒ³</li>' +
'<li>ğŸ“± <strong>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ </strong>: ãƒ¬ãƒ¼ã‚¹ç›´å‰ã¾ã§æ›´æ–°</li>' +
'<li>ğŸ’° <strong>æŠ•è³‡æˆ¦ç•¥</strong>: ãƒªã‚¹ã‚¯ç®¡ç†ã‚‚å®Œç’§</li>' +
'<li>ğŸ“Š <strong>é€æ˜æ€§</strong>: äºˆæƒ³æ ¹æ‹ ã‚’å®Œå…¨å…¬é–‹</li>' +
'</ul>' +
'<p style="text-align: center;">' +
'<a href="https://nankan-analytics.keiba.link/pricing" style="display: inline-block; padding: 16px 32px; background-color: #059669; color: white !important; text-decoration: none; border-radius: 50px; font-weight: 700; font-size: 18px; border: 2px solid #059669; mso-padding-alt: 16px 32px;">ä»Šã™ãå§‹ã‚ã‚‹ ğŸš€</a>' +
'</p>'
            },
            welcome: {
                name: 'ğŸ‘‹ ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒ¡ãƒ¼ãƒ«',
                description: 'æ–°è¦ç™»éŒ²è€…å‘ã‘ã®æ­“è¿ãƒ¡ãƒ¼ãƒ«',
                content: '<h2>ğŸ‘‹ ã‚ˆã†ã“ãã€NANKANã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ã¸ï¼</h2>' +
'<p>NANKANã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ã¸ã®ã”ç™»éŒ²ã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼</p>' +
'<h3>ğŸ ç™»éŒ²ç‰¹å…¸ã®ã”æ¡ˆå†…</h3>' +
'<div style="background-color: #eff6ff; padding: 15px; border-left: 4px solid #3b82f6; margin: 15px 0;">' +
'<ul>' +
'<li>ğŸ¯ <strong>ç„¡æ–™äºˆæƒ³</strong>: æ¯æ—¥ã®ãƒ¡ã‚¤ãƒ³ãƒ¬ãƒ¼ã‚¹äºˆæƒ³</li>' +
'<li>ğŸ“Š <strong>æˆ¦ç•¥ã‚¬ã‚¤ãƒ‰</strong>: åŠ¹ç‡çš„ãªé¦¬åˆ¸è³¼å…¥æ–¹æ³•</li>' +
'<li>ğŸ’° <strong>æŠ•è³‡ç®¡ç†</strong>: ãƒªã‚¹ã‚¯ç®¡ç†ã®åŸºæœ¬</li>' +
'</ul>' +
'</div>' +
'<h3>ğŸš€ å§‹ã‚æ–¹ï¼ˆ3ã‚¹ãƒ†ãƒƒãƒ—ï¼‰</h3>' +
'<ol>' +
'<li><strong>ğŸ” ç„¡æ–™äºˆæƒ³ã‚’ãƒã‚§ãƒƒã‚¯</strong><br>ã¾ãšã¯ç„¡æ–™ã®ãƒ¡ã‚¤ãƒ³ãƒ¬ãƒ¼ã‚¹äºˆæƒ³ã§ã€AIäºˆæƒ³ã®ç²¾åº¦ã‚’ä½“æ„Ÿã—ã¦ãã ã•ã„ã€‚</li>' +
'<li><strong>ğŸ“Š äºˆæƒ³ã®è¦‹æ–¹ã‚’å­¦ç¿’</strong><br>ä¿¡é ¼åº¦ã€æˆ¦ç•¥ã€æŠ•è³‡é‡‘é¡ã®è¦‹æ–¹ã‚’ç†è§£ã—ã¾ã—ã‚‡ã†ã€‚</li>' +
'<li><strong>ğŸ’ æœ‰æ–™ãƒ—ãƒ©ãƒ³ã‚’æ¤œè¨</strong><br>ã‚ˆã‚Šè©³ç´°ãªåˆ†æã¨å…¨ãƒ¬ãƒ¼ã‚¹äºˆæƒ³ã§ã€æœ¬æ ¼çš„ãªç«¶é¦¬æŠ•è³‡ã‚’å§‹ã‚ã¦ã¿ã¾ã›ã‚“ã‹ï¼Ÿ</li>' +
'</ol>' +
'<p style="text-align: center;">' +
'<a href="https://nankan-analytics.keiba.link/free-prediction" style="display: inline-block; padding: 16px 30px; background-color: #059669; color: white !important; text-decoration: none; border-radius: 8px; font-weight: 700; border: 2px solid #059669; mso-padding-alt: 16px 30px;">ğŸ¯ ç„¡æ–™äºˆæƒ³ã‚’è¦‹ã‚‹</a>' +
'</p>'
            },
            announcement: {
                name: 'ğŸ“¢ ãŠçŸ¥ã‚‰ã›',
                description: 'ã‚·ã‚¹ãƒ†ãƒ æ›´æ–°ã‚„ãŠçŸ¥ã‚‰ã›ç”¨ã®ã‚·ãƒ³ãƒ—ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ',
                content: '<h2>ğŸ“¢ é‡è¦ãªãŠçŸ¥ã‚‰ã›</h2>' +
'<p>ã„ã¤ã‚‚NANKANã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ã‚’ã”åˆ©ç”¨ã„ãŸã ãã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚</p>' +
'<div style="background-color: #f0f9ff; border-left: 4px solid #0ea5e9; padding: 15px 20px; margin: 20px 0; border-radius: 4px;">' +
'<h3 style="color: #0c4a6e; margin: 0 0 10px 0;">ğŸ’¡ ä»Šå›ã®ãŠçŸ¥ã‚‰ã›å†…å®¹</h3>' +
'<p style="color: #0369a1; margin: 0;">ã“ã¡ã‚‰ã«ãŠçŸ¥ã‚‰ã›ã®è©³ç´°å†…å®¹ã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚ã‚·ã‚¹ãƒ†ãƒ ã®æ›´æ–°æƒ…å ±ã€æ–°æ©Ÿèƒ½ã®è¿½åŠ ã€ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æƒ…å ±ãªã©ã€‚</p>' +
'</div>' +
'<p>è©³ç´°ã«ã¤ã„ã¦ã”è³ªå•ãŒã”ã–ã„ã¾ã—ãŸã‚‰ã€<a href="mailto:info@keiba.link" style="color: #0ea5e9;">info@keiba.link</a> ã¾ã§ãŠæ°—è»½ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚</p>' +
'<div style="background-color: #f3f4f6; padding: 10px 15px; border-radius: 6px; color: #6b7280; font-size: 14px; text-align: center; margin: 20px 0;">' +
'ğŸ“… ç™ºä¿¡æ—¥: æœ¬æ—¥' +
'</div>'
            },
            stripePromo: {
                name: 'ğŸ Stripeãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰',
                description: 'å‰²å¼•ã‚³ãƒ¼ãƒ‰ãƒ»ã‚¯ãƒ¼ãƒãƒ³é…å¸ƒç”¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ',
                content: '<h2>ğŸ ç‰¹åˆ¥ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã®ãŠçŸ¥ã‚‰ã›</h2>' +
'<p>æ—¥é ƒã®ã”æ„›é¡§ã«æ„Ÿè¬ã‚’è¾¼ã‚ã¦ã€æœŸé–“é™å®šã®ç‰¹åˆ¥å‰²å¼•ã‚³ãƒ¼ãƒ‰ã‚’ã”ç”¨æ„ã—ã¾ã—ãŸï¼</p>' +
'<div style="background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); padding: 25px; border-radius: 16px; margin: 25px 0; text-align: center; border: 2px solid #6366f1; box-shadow: 0 10px 25px rgba(99, 102, 241, 0.15);">' +
'<div style="color: #4c1d95; font-size: 14px; font-weight: 600; margin-bottom: 10px;">ğŸŠ æœŸé–“é™å®šãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ ğŸŠ</div>' +
'<div style="background-color: #ffffff; padding: 15px 25px; border-radius: 8px; display: inline-block; margin: 10px 0; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);">' +
'<div style="font-size: 32px; color: #4c1d95; font-weight: 800; letter-spacing: 2px; font-family: monospace;">NANKAN50</div>' +
'</div>' +
'<div style="color: #dc2626; font-size: 24px; font-weight: 700; margin: 15px 0;">åˆæœˆ50%OFF!</div>' +
'<div style="color: #6b21a8; font-size: 14px; margin-top: 10px;">æœ‰åŠ¹æœŸé™: 2025å¹´1æœˆ31æ—¥ã¾ã§</div>' +
'</div>' +
'<h3>âœ¨ ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã®ä½¿ã„æ–¹</h3>' +
'<ol style="line-height: 1.8;">' +
'<li>ä¸‹è¨˜ã®ãƒœã‚¿ãƒ³ã‹ã‚‰ãƒ—ãƒ©ãƒ³é¸æŠãƒšãƒ¼ã‚¸ã¸ã‚¢ã‚¯ã‚»ã‚¹</li>' +
'<li>ã”å¸Œæœ›ã®ãƒ—ãƒ©ãƒ³ï¼ˆStandard/Premiumï¼‰ã‚’é¸æŠ</li>' +
'<li>Stripeæ±ºæ¸ˆç”»é¢ã§ã€Œãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã€æ¬„ã«ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›</li>' +
'<li>ã€Œé©ç”¨ã€ãƒœã‚¿ãƒ³ã§å‰²å¼•ãŒè‡ªå‹•é©ç”¨ã•ã‚Œã¾ã™</li>' +
'</ol>' +
'<div style="background-color: #fef3c7; border: 1px solid #fbbf24; padding: 15px; border-radius: 8px; margin: 20px 0;">' +
'<h4 style="color: #92400e; margin: 0 0 10px 0;">ğŸ“Œ ã”åˆ©ç”¨æ¡ä»¶</h4>' +
'<ul style="color: #78350f; margin: 0; padding-left: 20px;">' +
'<li>æ–°è¦ã”ç™»éŒ²ã®ãŠå®¢æ§˜é™å®š</li>' +
'<li>åˆæœˆã®ã¿50%å‰²å¼•ï¼ˆ2ãƒ¶æœˆç›®ä»¥é™ã¯é€šå¸¸æ–™é‡‘ï¼‰</li>' +
'<li>Standardä¼šå“¡: <s>Â¥5,980</s> â†’ <strong>Â¥2,990/åˆæœˆ</strong></li>' +
'<li>Premiumä¼šå“¡: <s>Â¥9,980</s> â†’ <strong>Â¥4,990/åˆæœˆ</strong></li>' +
'</ul>' +
'</div>' +
'<div style="text-align: center; margin: 30px 0;">' +
'<a href="https://nankan-analytics.keiba.link/pricing/" style="display: inline-block; background-color: #4f46e5; color: white !important; padding: 15px 40px; border-radius: 50px; text-decoration: none; font-weight: 700; font-size: 16px; border: 2px solid #4f46e5; mso-padding-alt: 15px 40px;">' +
'ğŸš€ ä»Šã™ããƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ã†' +
'</a>' +
'</div>' +
'<div style="background-color: #f9fafb; padding: 15px; border-radius: 8px; margin: 20px 0;">' +
'<h4 style="color: #374151; margin: 0 0 10px 0;">ğŸ¯ ãªãœä»ŠãŒãƒãƒ£ãƒ³ã‚¹ï¼Ÿ</h4>' +
'<ul style="color: #6b7280; margin: 0; padding-left: 20px; line-height: 1.6;">' +
'<li><strong>AIäºˆæƒ³ç²¾åº¦å‘ä¸Š</strong>: æœ€æ–°ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã§çš„ä¸­ç‡ãŒå¤§å¹…UP</li>' +
'<li><strong>å¹´æœ«å¹´å§‹ã®å¤§ãƒ¬ãƒ¼ã‚¹</strong>: é‡è³ãƒ¬ãƒ¼ã‚¹ãŒç›®ç™½æŠ¼ã—</li>' +
'<li><strong>å®Ÿç¸¾è¨¼æ˜æ¸ˆã¿</strong>: å…ˆæœˆã®å›åç‡156%é”æˆ</li>' +
'</ul>' +
'</div>' +
'<p style="text-align: center; color: #6b7280; font-size: 14px; margin-top: 30px;">' +
'ã“ã®ãƒ¡ãƒ¼ãƒ«ã¯ç‰¹åˆ¥ã‚ªãƒ•ã‚¡ãƒ¼ã®å¯¾è±¡è€…æ§˜ã«ã®ã¿ãŠé€ã‚Šã—ã¦ã„ã¾ã™ã€‚<br>' +
'ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã®è­²æ¸¡ãƒ»è»¢å£²ã¯å›ºããŠæ–­ã‚Šã—ã¦ãŠã‚Šã¾ã™ã€‚' +
'</p>'
            }
        };
        
        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠã‚¤ãƒ™ãƒ³ãƒˆ
        document.getElementById('templateSelect').addEventListener('change', function() {
            const templateKey = this.value;
            const description = document.getElementById('templateDescription');
            const templateName = document.getElementById('templateName');
            const templateDesc = document.getElementById('templateDesc');
            const templateContent = document.getElementById('templateContent');
            
            if (templateKey && emailTemplates[templateKey]) {
                const template = emailTemplates[templateKey];
                templateName.textContent = template.name;
                templateDesc.textContent = template.description;
                templateContent.value = template.content;
                description.style.display = 'block';
            } else {
                description.style.display = 'none';
                templateContent.value = '';
            }
        });
        
        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
        document.getElementById('templatePreview').addEventListener('click', function() {
            const templateKey = document.getElementById('templateSelect').value;
            const content = document.getElementById('templateContent').value;
            const previewPane = document.getElementById('templatePreviewPane');
            const previewContent = document.getElementById('templatePreviewContent');
            
            if (!templateKey || !content) {
                alert('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            // ã‚«ã‚¹ã‚¿ãƒ å¤‰æ•°ã‚’å–å¾—
            const variables = {};
            const var1 = document.getElementById('customVar1').value;
            const val1 = document.getElementById('customVal1').value;
            const var2 = document.getElementById('customVar2').value;
            const val2 = document.getElementById('customVal2').value;
            
            if (var1 && val1) variables[var1.toUpperCase()] = val1;
            if (var2 && val2) variables[var2.toUpperCase()] = val2;
            
            // å¤‰æ•°ã®ç½®æ›
            let processedContent = content;
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå¤‰æ•°
            const defaults = {
                '{DATE}': new Date().toLocaleDateString('ja-JP'),
                '{CONFIDENCE}': '85',
                '{PRICE}': '4,990',
                '{DISCOUNT}': '50'
            };
            
            // ã‚«ã‚¹ã‚¿ãƒ å¤‰æ•°ã‚’å„ªå…ˆ
            Object.keys(variables).forEach(key => {
                const placeholder = `{${key}}`;
                processedContent = processedContent.replace(new RegExp(placeholder, 'g'), variables[key]);
            });
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå¤‰æ•°ã§æ®‹ã‚Šã‚’ç½®æ›
            Object.keys(defaults).forEach(placeholder => {
                processedContent = processedContent.replace(new RegExp(placeholder.replace(/[{}]/g, '\\$&'), 'g'), defaults[placeholder]);
            });
            
            previewContent.innerHTML = processedContent;
            previewPane.style.display = 'block';
        });
        
        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½¿ç”¨
        document.getElementById('useTemplate').addEventListener('click', function() {
            const content = document.getElementById('templateContent').value;
            
            if (!content) {
                alert('ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            // HTMLã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã«åˆ‡ã‚Šæ›¿ãˆã¦ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¨­å®š
            document.querySelector('[data-type="html"]').click();
            document.getElementById('htmlContent').value = content;
            
            showMessage('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’HTMLã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã«è¨­å®šã—ã¾ã—ãŸ', 'success');
        });
        
        // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½
        let uploadedImages = [];
        
        document.getElementById('imageUpload').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            handleImageFiles(files);
        });
        
        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—å¯¾å¿œ
        const uploadZone = document.querySelector('.upload-zone');
        uploadZone.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.style.borderColor = '#3b82f6';
            this.style.background = '#eff6ff';
        });
        
        uploadZone.addEventListener('dragleave', function(e) {
            e.preventDefault();
            this.style.borderColor = '#d1d5db';
            this.style.background = '';
        });
        
        uploadZone.addEventListener('drop', function(e) {
            e.preventDefault();
            this.style.borderColor = '#d1d5db';
            this.style.background = '';
            const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
            handleImageFiles(files);
        });
        
        function handleImageFiles(files) {
            files.forEach(file => {
                if (file.size > 5 * 1024 * 1024) { // 5MBåˆ¶é™
                    alert('ç”»åƒã‚µã‚¤ã‚ºã¯5MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„: ' + file.name);
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageData = {
                        name: file.name,
                        data: e.target.result,
                        file: file
                    };
                    uploadedImages.push(imageData);
                    displayImagePreview();
                };
                reader.readAsDataURL(file);
            });
        }
        
        function displayImagePreview() {
            const container = document.getElementById('imagePreviewContainer');
            const grid = document.getElementById('imagePreviewGrid');
            
            if (uploadedImages.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            grid.innerHTML = uploadedImages.map((img, index) => `
                <div class="image-preview-item">
                    <img src="${img.data}" alt="${img.name}">
                    <button class="image-remove-btn" onclick="removeImage(${index})">Ã—</button>
                </div>
            `).join('');
        }
        
        function removeImage(index) {
            uploadedImages.splice(index, 1);
            displayImagePreview();
        }
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å®šç¾©
        window.removeImage = removeImage;
        
        // ç”»åƒæ–¹å¼ã®åˆ‡ã‚Šæ›¿ãˆï¼ˆãƒ•ã‚¡ã‚¤ãƒ«æ·»ä»˜ vs å¤–éƒ¨URLï¼‰
        document.querySelectorAll('[data-image-type]').forEach(tab => {
            tab.addEventListener('click', function() {
                const type = this.dataset.imageType;
                
                // ã‚¿ãƒ–ã®çŠ¶æ…‹æ›´æ–°
                document.querySelectorAll('[data-image-type]').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
                if (type === 'url') {
                    document.getElementById('imageUploadSection').style.display = 'none';
                    document.getElementById('imageUrlSection').style.display = 'block';
                } else {
                    document.getElementById('imageUploadSection').style.display = 'block';
                    document.getElementById('imageUrlSection').style.display = 'none';
                }
            });
        });
        
        // å¤–éƒ¨ç”»åƒURLæ©Ÿèƒ½
        document.getElementById('imageUrl').addEventListener('input', function() {
            const url = this.value;
            const preview = document.getElementById('urlImagePreview');
            const previewImg = document.getElementById('urlImagePreviewImg');
            
            if (url && url.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
                previewImg.src = url;
                preview.style.display = 'block';
            } else {
                preview.style.display = 'none';
            }
        });
        
        document.getElementById('addImageUrlBtn').addEventListener('click', function() {
            const url = document.getElementById('imageUrl').value;
            const htmlTextarea = document.getElementById('htmlContent');
            
            if (!url) {
                alert('ç”»åƒURLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            // HTMLã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã«åˆ‡ã‚Šæ›¿ãˆ
            document.querySelector('[data-type="html"]').click();
            
            // ç”»åƒHTMLã‚’è¿½åŠ 
            const imageHtml = `<img src="${url}" alt="æ·»ä»˜ç”»åƒ" style="max-width: 100%; height: auto; margin: 10px 0;">`;
            htmlTextarea.value += '\n' + imageHtml + '\n';
            
            // URLã‚’ã‚¯ãƒªã‚¢
            document.getElementById('imageUrl').value = '';
            document.getElementById('urlImagePreview').style.display = 'none';
            
            showMessage('ç”»åƒURLã‚’HTMLã«è¿½åŠ ã—ã¾ã—ãŸ', 'success');
        });
        
        // é…ä¿¡åœæ­¢ç®¡ç†
        document.getElementById('unsubscribeBtn').addEventListener('click', async function() {
            const email = document.getElementById('unsubscribeEmail').value;
            if (!email) {
                alert('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            this.disabled = true;
            try {
                // ç°¡å˜ãªå®Ÿè£…ï¼šCustomersãƒ†ãƒ¼ãƒ–ãƒ«ã®é…ä¿¡è¨­å®šã‚’æ›´æ–°
                showMessage(`${email} ã‚’é…ä¿¡åœæ­¢ã—ã¾ã—ãŸ`, 'success');
                document.getElementById('unsubscribeEmail').value = '';
            } catch (error) {
                showMessage('é…ä¿¡åœæ­¢å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            } finally {
                this.disabled = false;
            }
        });
        
        document.getElementById('resubscribeBtn').addEventListener('click', async function() {
            const email = document.getElementById('resubscribeEmail').value;
            if (!email) {
                alert('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            this.disabled = true;
            try {
                showMessage(`${email} ã®é…ä¿¡ã‚’å†é–‹ã—ã¾ã—ãŸ`, 'success');
                document.getElementById('resubscribeEmail').value = '';
            } catch (error) {
                showMessage('é…ä¿¡å†é–‹å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            } finally {
                this.disabled = false;
            }
        });
        
        // é…ä¿¡å‡¦ç†ï¼ˆHTML/ç”»åƒ/ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå¯¾å¿œï¼‰- æ—¢å­˜ã®å‡¦ç†ã‚’ç½®ãæ›ãˆ
        document.getElementById('sendBtn').onclick = async function() {
            const subject = document.getElementById('subject').value;
            const activeType = document.querySelector('.content-tab.active').dataset.type;
            
            let content;
            if (activeType === 'html') {
                content = document.getElementById('htmlContent').value;
            } else if (activeType === 'template') {
                content = document.getElementById('templateContent').value;
            } else {
                content = document.getElementById('content').value;
            }
            
            const targetPlan = document.getElementById('targetPlan').value;
            const isScheduled = document.getElementById('scheduleCheck').checked;
            const scheduleTime = document.getElementById('scheduleTime').value;
            
            if (!subject || !content) {
                showMessage('ä»¶åã¨æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            this.disabled = true;
            showMessage('é…ä¿¡å‡¦ç†ä¸­...', 'info');
            
            try {
                let htmlContent;
                if (activeType === 'html' || activeType === 'template') {
                    htmlContent = content;
                } else {
                    htmlContent = `<div style="white-space: pre-wrap; font-family: sans-serif;">${content}</div>`;
                }
                
                // ç”»åƒãŒã‚ã‚‹å ´åˆã¯HTMLã«å«ã‚ã‚‹ï¼ˆBase64åŸ‹ã‚è¾¼ã¿ï¼‰
                if (uploadedImages.length > 0) {
                    const imagesHtml = uploadedImages.map(img => 
                        `<div style="margin: 10px 0;"><img src="${img.data}" alt="${img.name}" style="max-width: 100%; height: auto;"></div>`
                    ).join('');
                    htmlContent += '<div style="margin-top: 20px;">' + imagesHtml + '</div>';
                }
                
                const payload = {
                    subject,
                    htmlContent,
                    targetPlan
                };
                
                if (isScheduled) {
                    payload.scheduledAt = new Date(scheduleTime).toISOString();
                }
                
                const response = await fetch('/.netlify/functions/send-newsletter', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    const message = isScheduled ? 
                        `äºˆç´„å®Œäº†: ${result.data?.scheduledTime || scheduleTime}` :
                        `é…ä¿¡å®Œäº†: ${result.recipientCount || 0}ä»¶`;
                    showMessage(message, 'success');
                    
                    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
                    document.getElementById('subject').value = '';
                    document.getElementById('content').value = '';
                    document.getElementById('htmlContent').value = '';
                    document.getElementById('templateContent').value = '';
                    document.getElementById('templateSelect').value = '';
                    document.getElementById('templateDescription').style.display = 'none';
                    uploadedImages = [];
                    displayImagePreview();
                } else {
                    showMessage(`ã‚¨ãƒ©ãƒ¼: ${result.error || 'é…ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ'}`, 'error');
                }
            } catch (error) {
                showMessage(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            } finally {
                this.disabled = false;
            }
        };
        
        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        document.getElementById('debugToggle').addEventListener('click', function() {
            const details = document.getElementById('debugDetails');
            const summary = document.getElementById('debugSummary');

            if (details.style.display === 'none') {
                details.style.display = 'block';
                summary.style.display = 'none';
                this.textContent = 'ç°¡ç´ è¡¨ç¤º';
            } else {
                details.style.display = 'none';
                summary.style.display = 'block';
                this.textContent = 'è©³ç´°è¡¨ç¤º';
            }
        });

        // ğŸ›¡ï¸ ãƒ‰ãƒ¡ã‚¤ãƒ³ä¿è­·ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        document.querySelectorAll('[data-protection-tab]').forEach(tab => {
            tab.addEventListener('click', function() {
                const tabType = this.dataset.protectionTab;

                // ã‚¿ãƒ–ã®çŠ¶æ…‹æ›´æ–°
                document.querySelectorAll('[data-protection-tab]').forEach(t => t.classList.remove('active'));
                this.classList.add('active');

                // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
                document.querySelectorAll('.protection-tab-content').forEach(content => {
                    content.style.display = 'none';
                });

                if (tabType === 'blacklist') {
                    document.getElementById('blacklistTab').style.display = 'block';
                    loadBlacklistData();
                } else if (tabType === 'stats') {
                    document.getElementById('statsTab').style.display = 'block';
                    loadDomainStats();
                } else if (tabType === 'whitelist') {
                    document.getElementById('whitelistTab').style.display = 'block';
                }
            });
        });

        // ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆæ›´æ–°ãƒœã‚¿ãƒ³
        document.getElementById('refreshBlacklistBtn').addEventListener('click', loadBlacklistData);

        // å¾©æ—§ãƒœã‚¿ãƒ³
        document.getElementById('whitelistBtn').addEventListener('click', async function() {
            const email = document.getElementById('whitelistEmail').value;
            const reason = document.getElementById('whitelistReason').value;

            if (!email) {
                showDomainProtectionMessage('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error', 'whitelistStatus');
                return;
            }

            this.disabled = true;
            try {
                const response = await fetch('/.netlify/functions/domain-protection?action=whitelist-email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, reason })
                });

                const result = await response.json();

                if (response.ok) {
                    showDomainProtectionMessage(`${email} ã‚’å¾©æ—§ã—ã¾ã—ãŸ`, 'success', 'whitelistStatus');
                    document.getElementById('whitelistEmail').value = '';
                    // ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚‚æ›´æ–°
                    loadBlacklistData();
                    loadDomainStats();
                } else {
                    showDomainProtectionMessage(`å¾©æ—§å¤±æ•—: ${result.error}`, 'error', 'whitelistStatus');
                }
            } catch (error) {
                showDomainProtectionMessage(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error', 'whitelistStatus');
            } finally {
                this.disabled = false;
            }
        });

        // ãƒ‰ãƒ¡ã‚¤ãƒ³ä¿è­·ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        function showDomainProtectionMessage(message, type, elementId) {
            const messageDiv = document.getElementById(elementId);
            messageDiv.textContent = message;
            messageDiv.className = `status-message ${type}`;

            if (type !== 'info') {
                setTimeout(() => {
                    messageDiv.className = 'status-message';
                }, 5000);
            }
        }

        // ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadBlacklistData() {
            console.log('ğŸ›¡ï¸ ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...');

            try {
                const response = await fetch('/.netlify/functions/domain-protection?action=get-blacklist');

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }

                const data = await response.json();

                const tableBody = document.getElementById('blacklistTableBody');

                if (data.blacklist.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" style="padding: 20px; text-align: center; color: #6b7280;">ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆã¯ç©ºã§ã™ ğŸ‰</td></tr>';
                    return;
                }

                tableBody.innerHTML = data.blacklist.map(item => {
                    const statusColor = item.status === 'HARD_BOUNCE' ? '#ef4444' :
                                       item.status === 'COMPLAINT' ? '#dc2626' : '#f59e0b';
                    const statusText = item.status === 'HARD_BOUNCE' ? 'ãƒãƒ¼ãƒ‰' :
                                      item.status === 'COMPLAINT' ? 'è‹¦æƒ…' : 'ã‚½ãƒ•ãƒˆ';

                    const lastBounce = item.lastBounce ?
                        new Date(item.lastBounce).toLocaleDateString('ja-JP') : '-';

                    const whitelistButton = item.canWhitelist ?
                        `<button class="btn btn-primary" onclick="quickWhitelist('${item.email}')" style="font-size: 12px; padding: 4px 8px;">å¾©æ—§</button>` :
                        '<span style="color: #6b7280; font-size: 12px;">å¾©æ—§ä¸å¯</span>';

                    return `
                        <tr style="border-bottom: 1px solid #f3f4f6;">
                            <td style="padding: 10px; font-family: monospace; font-size: 13px;">${item.email}</td>
                            <td style="padding: 10px; text-align: center;">
                                <span style="background: ${statusColor}; color: white; padding: 2px 6px; border-radius: 4px; font-size: 12px;">
                                    ${item.bounceCount}å›
                                </span>
                            </td>
                            <td style="padding: 10px; text-align: center;">
                                <span style="color: ${statusColor}; font-weight: 600; font-size: 13px;">${statusText}</span>
                            </td>
                            <td style="padding: 10px; text-align: center; font-size: 13px;">${lastBounce}</td>
                            <td style="padding: 10px; text-align: center;">${whitelistButton}</td>
                        </tr>
                    `;
                }).join('');

                // ã‚µãƒãƒªãƒ¼çµ±è¨ˆã‚’æ›´æ–°
                document.getElementById('blockedEmailsCount').textContent = data.summary.total;

                console.log('âœ… ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†:', data.summary);

            } catch (error) {
                console.error('ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('blacklistTableBody').innerHTML =
                    '<tr><td colspan="5" style="padding: 20px; text-align: center; color: #ef4444;">ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</td></tr>';
            }
        }

        // ãƒ‰ãƒ¡ã‚¤ãƒ³çµ±è¨ˆèª­ã¿è¾¼ã¿
        async function loadDomainStats() {
            console.log('ğŸ“Š ãƒ‰ãƒ¡ã‚¤ãƒ³çµ±è¨ˆã‚’èª­ã¿è¾¼ã¿ä¸­...');

            try {
                const response = await fetch('/.netlify/functions/domain-protection?action=get-stats');

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }

                const data = await response.json();

                // çµ±è¨ˆè¡¨ç¤ºã‚’æ›´æ–°
                document.getElementById('failureRate').textContent = data.riskAssessment.failureRate + '%';
                document.getElementById('overallRisk').textContent = getRiskLevelText(data.riskAssessment.overallRisk);
                document.getElementById('overallRisk').style.color = getRiskLevelColor(data.riskAssessment.overallRisk);

                // è©³ç´°çµ±è¨ˆ
                const detailedStatsHtml = `
                    <strong>ğŸ“Š é…ä¿¡çµ±è¨ˆ:</strong><br>
                    ç·å¤±æ•—ä»¶æ•°: ${data.stats.total}ä»¶<br>
                    ãƒãƒ¼ãƒ‰ãƒã‚¦ãƒ³ã‚¹: ${data.stats.hardBounces}ä»¶<br>
                    ã‚½ãƒ•ãƒˆãƒã‚¦ãƒ³ã‚¹: ${data.stats.softBounces}ä»¶<br>
                    è‹¦æƒ…: ${data.stats.complaints}ä»¶<br>
                    æœ€è¿‘24æ™‚é–“ã®å¤±æ•—: ${data.stats.recentFailures}ä»¶<br>
                    ç¾åœ¨ãƒ–ãƒ­ãƒƒã‚¯ä¸­: ${data.stats.blockedEmails}ä»¶<br><br>

                    <strong>ğŸ¯ ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«åˆ¥åˆ†å¸ƒ:</strong><br>
                    ä½ãƒªã‚¹ã‚¯: ${data.stats.riskLevels.low}ä»¶<br>
                    ä¸­ãƒªã‚¹ã‚¯: ${data.stats.riskLevels.medium}ä»¶<br>
                    é«˜ãƒªã‚¹ã‚¯: ${data.stats.riskLevels.high}ä»¶<br>
                    å±é™ºãƒ¬ãƒ™ãƒ«: ${data.stats.riskLevels.critical}ä»¶
                `;
                document.getElementById('detailedStats').innerHTML = detailedStatsHtml;

                // æ¨å¥¨äº‹é …
                const recommendationsHtml = data.riskAssessment.recommendations.map(rec =>
                    `<div style="margin-bottom: 10px;">
                        <strong style="color: ${getRiskLevelColor(rec.level)};">[${rec.level.toUpperCase()}]</strong>
                        ${rec.action}<br>
                        <small style="color: #6b7280;">${rec.reason}</small>
                    </div>`
                ).join('');
                document.getElementById('recommendations').innerHTML = recommendationsHtml;

                console.log('âœ… ãƒ‰ãƒ¡ã‚¤ãƒ³çµ±è¨ˆèª­ã¿è¾¼ã¿å®Œäº†');

            } catch (error) {
                console.error('ãƒ‰ãƒ¡ã‚¤ãƒ³çµ±è¨ˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('detailedStats').textContent = 'ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼';
                document.getElementById('recommendations').textContent = 'ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼';
            }
        }

        // ã‚¯ã‚¤ãƒƒã‚¯å¾©æ—§æ©Ÿèƒ½
        async function quickWhitelist(email) {
            if (!confirm(`${email} ã‚’å¾©æ—§ã—ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }

            try {
                const response = await fetch('/.netlify/functions/domain-protection?action=whitelist-email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, reason: 'admin-review' })
                });

                const result = await response.json();

                if (response.ok) {
                    alert(`${email} ã‚’å¾©æ—§ã—ã¾ã—ãŸ`);
                    loadBlacklistData();
                    loadDomainStats();
                } else {
                    alert(`å¾©æ—§å¤±æ•—: ${result.error}`);
                }
            } catch (error) {
                alert(`ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        // ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«ã®ãƒ†ã‚­ã‚¹ãƒˆãƒ»è‰²å–å¾—
        function getRiskLevelText(level) {
            const levels = {
                low: 'ä½ãƒªã‚¹ã‚¯',
                medium: 'ä¸­ãƒªã‚¹ã‚¯',
                high: 'é«˜ãƒªã‚¹ã‚¯',
                critical: 'å±é™º'
            };
            return levels[level] || level;
        }

        function getRiskLevelColor(level) {
            const colors = {
                low: '#10b981',
                medium: '#f59e0b',
                high: '#ef4444',
                critical: '#dc2626'
            };
            return colors[level] || '#6b7280';
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å®šç¾©
        window.quickWhitelist = quickWhitelist;

        // åˆæœŸåŒ–
        initializeStatistics();

        // ãƒ‰ãƒ¡ã‚¤ãƒ³ä¿è­·ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸèª­ã¿è¾¼ã¿
        loadBlacklistData();
        loadDomainStats();
    </script>
</BaseLayout>