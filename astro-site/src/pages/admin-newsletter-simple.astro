---
// „Ç∑„É≥„Éó„É´„Å™„É°„É´„Éû„Ç¨ÈÖç‰ø°ÁÆ°ÁêÜÁîªÈù¢
export const prerender = true;
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout title="„É°„É´„Éû„Ç¨ÈÖç‰ø° - NANKAN„Ç¢„Éä„É™„ÉÜ„Ç£„ÇØ„Çπ">
    <style>
        .newsletter-admin {
            min-height: 100vh;
            background: #f8fafc;
            padding: 20px;
        }
        
        .admin-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .admin-header h1 {
            font-size: 1.8rem;
            color: #1f2937;
            margin-bottom: 5px;
        }
        
        .admin-container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .card h2 {
            color: #1f2937;
            font-size: 1.3rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            color: #374151;
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        textarea.form-control {
            min-height: 200px;
            resize: vertical;
            font-family: inherit;
        }
        
        .target-plan {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .plan-option {
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            background: white;
        }
        
        .plan-option:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        
        .plan-option.active {
            border-color: #3b82f6;
            background: #3b82f6;
            color: white;
        }
        
        .plan-option span {
            display: block;
            font-size: 0.9rem;
            margin-top: 4px;
            opacity: 0.8;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }
        
        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            font-size: 15px;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }
        
        .status-message.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
            display: block;
        }
        
        .status-message.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
            display: block;
        }
        
        .status-message.info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #3b82f6;
            display: block;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-box {
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        
        .stat-label {
            font-size: 0.85rem;
            color: #6b7280;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
        }
        
        .schedule-option {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-top: 10px;
        }
        
        .schedule-option input[type="datetime-local"] {
            flex: 1;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        
        /* HTML/„ÉÜ„Ç≠„Çπ„ÉàÂàá„ÇäÊõø„Åà„Çø„Éñ */
        .content-type-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
        }
        
        .content-tab {
            padding: 8px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }
        
        .content-tab:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        
        .content-tab.active {
            border-color: #3b82f6;
            background: #3b82f6;
            color: white;
        }
        
        /* HTML„Ç®„Éá„Ç£„Çø„Éº */
        .html-toolbar {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
            padding: 10px;
            background: #f9fafb;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        
        .html-btn {
            padding: 5px 10px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        
        .html-btn:hover {
            background: #3b82f6;
            color: white;
        }
        
        .html-textarea {
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
        }
        
        /* ÁîªÂÉè„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ */
        .image-upload-area {
            margin-top: 10px;
        }
        
        .upload-zone {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .upload-zone:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        
        .upload-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .upload-text strong {
            display: block;
            margin-bottom: 5px;
            color: #374151;
        }
        
        .upload-text small {
            color: #6b7280;
            font-size: 0.85rem;
        }
        
        .image-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .image-preview-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }
        
        .image-preview-item img {
            width: 100%;
            height: 80px;
            object-fit: cover;
        }
        
        .image-remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #ef4444;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* ÈÖç‰ø°ÂÅúÊ≠¢ÁÆ°ÁêÜ */
        .unsubscribe-section {
            padding: 0;
        }
        
        .unsubscribe-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .unsubscribe-stats {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }
    </style>
    
    <div class="newsletter-admin">
        <div class="admin-header">
            <h1>üìß „É°„É´„Éû„Ç¨ÈÖç‰ø°„Ç∑„Çπ„ÉÜ„É†</h1>
            <p style="color: #6b7280; margin: 0;">„Ç∑„É≥„Éó„É´ÔºÜÁ¢∫ÂÆü„Å™ÈÖç‰ø°ÁÆ°ÁêÜ</p>
        </div>
        
        <div class="admin-container">
            <!-- ÈÖç‰ø°Áµ±Ë®à -->
            <div class="card">
                <h2>üìä ÈÖç‰ø°Áµ±Ë®à</h2>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-label">Á∑èÈ°ßÂÆ¢Êï∞</div>
                        <div class="stat-value" id="totalCustomers">-</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Free‰ºöÂì°</div>
                        <div class="stat-value" id="freeCount">-</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Standard‰ºöÂì°</div>
                        <div class="stat-value" id="standardCount">-</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Premium‰ºöÂì°</div>
                        <div class="stat-value" id="premiumCount">-</div>
                    </div>
                </div>
            </div>
            
            <!-- „É°„Éº„É´‰ΩúÊàê„Éï„Ç©„Éº„É† -->
            <div class="card">
                <h2>‚úâÔ∏è „É°„Éº„É´‰ΩúÊàê</h2>
                
                <div class="form-group">
                    <label>ÈÖç‰ø°ÂØæË±°</label>
                    <div class="target-plan">
                        <div class="plan-option active" data-plan="all">
                            ÂÖ®Âì°
                            <span id="allCount">-</span>
                        </div>
                        <div class="plan-option" data-plan="free">
                            Free
                            <span id="freeCountOption">-</span>
                        </div>
                        <div class="plan-option" data-plan="standard">
                            Standard
                            <span id="standardCountOption">-</span>
                        </div>
                        <div class="plan-option" data-plan="premium">
                            Premium
                            <span id="premiumCountOption">-</span>
                        </div>
                        <div class="plan-option" data-plan="test">
                            üß™ „ÉÜ„Çπ„Éà
                            <span>„ÉÜ„Çπ„ÉàÁî®</span>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>‰ª∂Âêç</label>
                    <input type="text" class="form-control" id="subject" 
                           placeholder="‰æãÔºö„ÄêÂçóÈñ¢Á´∂È¶¨„ÄëÊú¨Êó•„ÅÆ‰∫àÊÉ≥ÈÖç‰ø°">
                </div>
                
                <div class="form-group">
                    <label>Êú¨ÊñáÂΩ¢Âºè</label>
                    <div class="content-type-tabs">
                        <button type="button" class="content-tab active" data-type="text">üìù „ÉÜ„Ç≠„Çπ„Éà</button>
                        <button type="button" class="content-tab" data-type="html">üåê HTML</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label id="contentLabel">Êú¨Êñá</label>
                    <div id="textEditor">
                        <textarea class="form-control" id="content" 
                                  placeholder="„É°„Éº„É´Êú¨Êñá„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ..."></textarea>
                    </div>
                    <div id="htmlEditor" style="display: none;">
                        <div class="html-toolbar">
                            <button type="button" class="html-btn" data-tag="b">Â§™Â≠ó</button>
                            <button type="button" class="html-btn" data-tag="i">Êñú‰Ωì</button>
                            <button type="button" class="html-btn" data-tag="u">‰∏ãÁ∑ö</button>
                            <button type="button" class="html-btn" onclick="insertLink()">üîó „É™„É≥„ÇØ</button>
                            <button type="button" class="html-btn" onclick="insertImage()">üñºÔ∏è ÁîªÂÉè</button>
                        </div>
                        <textarea class="form-control html-textarea" id="htmlContent" 
                                  placeholder="HTML„Ç≥„Éº„Éâ„ÇíÂÖ•Âäõ„Åô„Çã„Åã„ÄÅ‰∏ä„ÅÆ„Éú„Çø„É≥„ÅßHTML„Çø„Ç∞„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ..."></textarea>
                        <div class="html-preview">
                            <button type="button" id="previewToggle" class="btn btn-secondary">üëÅÔ∏è „Éó„É¨„Éì„É•„Éº</button>
                            <div id="previewPane" style="display: none; margin-top: 10px; padding: 15px; border: 1px solid #d1d5db; border-radius: 8px; background: #f9fafb;">
                                <div id="previewContent"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ÁîªÂÉèÊ∑ª‰ªò„Çª„ÇØ„Ç∑„Éß„É≥ -->
                <div class="form-group">
                    <label>ÁîªÂÉèÊ∑ª‰ªò („Ç™„Éó„Ç∑„Éß„É≥)</label>
                    
                    <!-- ‰∫àÁ¥ÑÈÖç‰ø°ÊôÇ„ÅÆÈáçË¶Å„Å™Ê≥®ÊÑè -->
                    <div id="imageScheduleWarning" class="status-message" style="display: none; background: #fef3c7; color: #92400e; border: 1px solid #f59e0b;">
                        ‚ö†Ô∏è <strong>‰∫àÁ¥ÑÈÖç‰ø°„Åß„ÅÆÁîªÂÉè„Å´„Å§„ÅÑ„Å¶Ôºö</strong><br>
                        ‰∫àÁ¥ÑÈÖç‰ø°„Åß„ÅØÂ§ßÂÆπÈáèÁîªÂÉè„Éá„Éº„Çø„Çí‰øùÂ≠ò„Åß„Åç„Åæ„Åõ„Çì„ÄÇ<br>
                        <strong>Êé®Â•®Ôºö</strong> ÁîªÂÉè„ÇíÂ§ñÈÉ®„Å´„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂæå„ÄÅHTML„Ç®„Éá„Ç£„Çø„Éº„Åß<code>&lt;img src="URL"&gt;</code>„Çí‰ΩøÁî®„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
                    </div>
                    
                    <div class="content-type-tabs" style="margin-top: 10px;">
                        <button type="button" class="content-tab active" data-image-type="upload">üìé „Éï„Ç°„Ç§„É´Ê∑ª‰ªò</button>
                        <button type="button" class="content-tab" data-image-type="url">üåê Â§ñÈÉ®URL</button>
                    </div>
                    
                    <!-- „Éï„Ç°„Ç§„É´„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÊñπÂºè -->
                    <div id="imageUploadSection" class="image-upload-area" style="margin-top: 15px;">
                        <input type="file" id="imageUpload" accept="image/*" multiple style="display: none;">
                        <div class="upload-zone" onclick="document.getElementById('imageUpload').click();">
                            <div class="upload-icon">üìé</div>
                            <div class="upload-text">
                                <strong>ÁîªÂÉè„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ</strong>
                                <small>„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶ÁîªÂÉè„ÇíÈÅ∏Êäû„ÄÅ„Åæ„Åü„ÅØ„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó<br>‚Äª Âç≥ÊôÇÈÖç‰ø°„ÅÆ„ÅøÂØæÂøú</small>
                            </div>
                        </div>
                        <div id="imagePreviewContainer" style="display: none;">
                            <div class="image-preview-grid" id="imagePreviewGrid"></div>
                        </div>
                    </div>
                    
                    <!-- Â§ñÈÉ®URLÊñπÂºè -->
                    <div id="imageUrlSection" style="display: none; margin-top: 15px;">
                        <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; border: 1px solid #0ea5e9; margin-bottom: 15px;">
                            <h4 style="margin: 0 0 10px 0; color: #0c4a6e;">üåü Êé®Â•®ÔºöÂ§ñÈÉ®ÁîªÂÉè„Éõ„Çπ„ÉÜ„Ç£„É≥„Ç∞</h4>
                            <p style="margin: 0 0 10px 0; font-size: 14px; color: #075985;">
                                <strong>‰∫àÁ¥ÑÈÖç‰ø°„ÇÇÁ¢∫ÂÆüÂãï‰ΩúÔºÅ</strong> ÁîªÂÉè„Çí‰ª•‰∏ã„ÅÆ„Çµ„Éº„Éì„Çπ„Å´„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„Å¶URL„ÇíÂèñÂæóÔºö
                            </p>
                            <ul style="margin: 0; padding-left: 20px; font-size: 13px; color: #0369a1;">
                                <li><strong>Google Drive</strong>ÔºàÁÑ°Êñô„ÉªÂÖ±Êúâ„É™„É≥„ÇØÂèñÂæóÔºâ</li>
                                <li><strong>Imgur</strong>ÔºàÁÑ°Êñô„ÉªÁîªÂÉèÂ∞ÇÁî®Ôºâ</li>
                                <li><strong>Cloudinary</strong>Ôºà„Éó„É≠‰ªïÊßò„ÉªÈ´òÈÄüCDNÔºâ</li>
                                <li><strong>GitHub</strong>ÔºàÊäÄË°ìËÄÖÂêë„Åë„ÉªÊ∞∏Á∂ö‰øùÂ≠òÔºâ</li>
                            </ul>
                        </div>
                        
                        <div class="form-group">
                            <label>ÁîªÂÉèURL</label>
                            <input type="url" class="form-control" id="imageUrl" 
                                   placeholder="https://example.com/image.jpg">
                            <button type="button" class="btn btn-secondary" id="addImageUrlBtn" style="margin-top: 10px;">HTML„Å´ËøΩÂä†</button>
                        </div>
                        
                        <div id="urlImagePreview" style="display: none; margin-top: 15px;">
                            <img id="urlImagePreviewImg" style="max-width: 200px; max-height: 150px; border-radius: 8px; border: 1px solid #e5e7eb;">
                        </div>
                    </div>
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="scheduleCheck">
                    <label for="scheduleCheck" style="margin: 0; cursor: pointer;">‰∫àÁ¥ÑÈÖç‰ø°„Åô„Çã</label>
                </div>
                
                <div class="schedule-option" id="scheduleOption" style="display: none;">
                    <input type="datetime-local" class="form-control" id="scheduleTime">
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="sendBtn">
                        <span id="sendBtnText">ÈÖç‰ø°„Åô„Çã</span>
                    </button>
                    <button class="btn btn-secondary" id="previewBtn">
                        „Éó„É¨„Éì„É•„Éº
                    </button>
                </div>
                
                <div id="statusMessage" class="status-message"></div>
            </div>
            
            <!-- ÈÖç‰ø°ÂÅúÊ≠¢ÁÆ°ÁêÜ -->
            <div class="card">
                <h2>üö´ ÈÖç‰ø°ÂÅúÊ≠¢ÁÆ°ÁêÜ</h2>
                <div class="unsubscribe-section">
                    <div class="form-group">
                        <label>ÈÖç‰ø°ÂÅúÊ≠¢Âá¶ÁêÜ</label>
                        <div class="unsubscribe-actions">
                            <input type="email" class="form-control" id="unsubscribeEmail" 
                                   placeholder="ÈÖç‰ø°ÂÅúÊ≠¢„Åô„Çã„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ" style="flex: 1; margin-right: 10px;">
                            <button class="btn btn-secondary" id="unsubscribeBtn">ÈÖç‰ø°ÂÅúÊ≠¢</button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>ÈÖç‰ø°ÂÜçÈñã</label>
                        <div class="unsubscribe-actions">
                            <input type="email" class="form-control" id="resubscribeEmail" 
                                   placeholder="ÈÖç‰ø°ÂÜçÈñã„Åô„Çã„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ" style="flex: 1; margin-right: 10px;">
                            <button class="btn btn-primary" id="resubscribeBtn">ÈÖç‰ø°ÂÜçÈñã</button>
                        </div>
                    </div>
                    
                    <div class="unsubscribe-stats">
                        <div class="stat-box">
                            <div class="stat-label">ÈÖç‰ø°ÂÅúÊ≠¢ËÄÖÊï∞</div>
                            <div class="stat-value" id="unsubscribedCount">-</div>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
    </div>
    
    <script>
        // È°ßÂÆ¢Áµ±Ë®à„ÇíÂèñÂæó
        async function loadStatistics() {
            try {
                const response = await fetch('/.netlify/functions/get-customer-stats');
                if (response.ok) {
                    const stats = await response.json();
                    
                    document.getElementById('totalCustomers').textContent = stats.total || 0;
                    document.getElementById('freeCount').textContent = stats.free || 0;
                    document.getElementById('standardCount').textContent = stats.standard || 0;
                    document.getElementById('premiumCount').textContent = stats.premium || 0;
                    
                    // „Ç™„Éó„Ç∑„Éß„É≥„ÅÆÊï∞„ÇÇÊõ¥Êñ∞
                    document.getElementById('allCount').textContent = `${stats.total || 0}Âêç`;
                    document.getElementById('freeCountOption').textContent = `${stats.free || 0}Âêç`;
                    document.getElementById('standardCountOption').textContent = `${stats.standard || 0}Âêç`;
                    document.getElementById('premiumCountOption').textContent = `${stats.premium || 0}Âêç`;
                }
            } catch (error) {
                console.error('Áµ±Ë®àÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó:', error);
                // „Éá„Éï„Ç©„É´„ÉàÂÄ§„ÇíË°®Á§∫
                document.getElementById('totalCustomers').textContent = '0';
                document.getElementById('freeCount').textContent = '0';
                document.getElementById('standardCount').textContent = '0';
                document.getElementById('premiumCount').textContent = '0';
            }
        }
        
        
        // „Éó„É©„É≥ÈÅ∏Êäû
        document.querySelectorAll('.plan-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.plan-option').forEach(opt => opt.classList.remove('active'));
                this.classList.add('active');
            });
        });
        
        // ‰∫àÁ¥ÑÈÖç‰ø°„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ
        document.getElementById('scheduleCheck').addEventListener('change', function() {
            const scheduleOption = document.getElementById('scheduleOption');
            const sendBtnText = document.getElementById('sendBtnText');
            const imageWarning = document.getElementById('imageScheduleWarning');
            
            if (this.checked) {
                scheduleOption.style.display = 'flex';
                sendBtnText.textContent = '‰∫àÁ¥Ñ„Åô„Çã';
                imageWarning.style.display = 'block'; // ÁîªÂÉèË≠¶Âëä„ÇíË°®Á§∫
                
                // „Éá„Éï„Ç©„É´„Éà„Åß1ÊôÇÈñìÂæå„ÇíË®≠ÂÆö
                const now = new Date();
                now.setHours(now.getHours() + 1);
                now.setMinutes(0);
                document.getElementById('scheduleTime').value = 
                    now.toISOString().slice(0, 16);
            } else {
                scheduleOption.style.display = 'none';
                sendBtnText.textContent = 'ÈÖç‰ø°„Åô„Çã';
                imageWarning.style.display = 'none'; // ÁîªÂÉèË≠¶Âëä„ÇíÈö†„Åô
            }
        });
        
        // „Éó„É¨„Éì„É•„ÉºÊ©üËÉΩ
        document.getElementById('previewBtn').addEventListener('click', function() {
            const subject = document.getElementById('subject').value;
            const content = document.getElementById('content').value;
            
            if (!subject || !content) {
                alert('‰ª∂Âêç„Å®Êú¨Êñá„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            // Á∞°Êòì„Éó„É¨„Éì„É•„ÉºË°®Á§∫
            const preview = window.open('', '_blank', 'width=600,height=700');
            preview.document.write(`
                <html>
                <head>
                    <title>„É°„Éº„É´„Éó„É¨„Éì„É•„Éº</title>
                    <style>
                        body { font-family: sans-serif; padding: 20px; }
                        .subject { font-size: 1.5rem; font-weight: bold; margin-bottom: 20px; }
                        .content { white-space: pre-wrap; line-height: 1.6; }
                    </style>
                </head>
                <body>
                    <div class="subject">‰ª∂Âêç: ${subject}</div>
                    <hr>
                    <div class="content">${content}</div>
                </body>
                </html>
            `);
        });
        
        
        // „É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫
        function showMessage(message, type) {
            const messageDiv = document.getElementById('statusMessage');
            messageDiv.textContent = message;
            messageDiv.className = `status-message ${type}`;
            
            if (type !== 'info') {
                setTimeout(() => {
                    messageDiv.className = 'status-message';
                }, 5000);
            }
        }
        
        // HTML/„ÉÜ„Ç≠„Çπ„ÉàÂàá„ÇäÊõø„ÅàÊ©üËÉΩ
        document.querySelectorAll('.content-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const type = this.dataset.type;
                
                // „Çø„Éñ„ÅÆÁä∂ÊÖãÊõ¥Êñ∞
                document.querySelectorAll('.content-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                // „Ç®„Éá„Ç£„Çø„Éº„ÅÆË°®Á§∫Âàá„ÇäÊõø„Åà
                if (type === 'html') {
                    document.getElementById('textEditor').style.display = 'none';
                    document.getElementById('htmlEditor').style.display = 'block';
                    document.getElementById('contentLabel').textContent = 'HTMLÊú¨Êñá';
                } else {
                    document.getElementById('textEditor').style.display = 'block';
                    document.getElementById('htmlEditor').style.display = 'none';
                    document.getElementById('contentLabel').textContent = 'Êú¨Êñá';
                }
            });
        });
        
        // HTML„ÉÑ„Éº„É´„Éê„ÉºÊ©üËÉΩ
        document.querySelectorAll('.html-btn[data-tag]').forEach(btn => {
            btn.addEventListener('click', function() {
                const tag = this.dataset.tag;
                const textarea = document.getElementById('htmlContent');
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const selectedText = textarea.value.substring(start, end) || '„ÉÜ„Ç≠„Çπ„Éà';
                const newText = `<${tag}>${selectedText}</${tag}>`;
                
                textarea.value = textarea.value.substring(0, start) + newText + textarea.value.substring(end);
                textarea.focus();
                textarea.setSelectionRange(start + tag.length + 2, start + tag.length + 2 + selectedText.length);
            });
        });
        
        // HTML„Éó„É¨„Éì„É•„ÉºÊ©üËÉΩ
        document.getElementById('previewToggle').addEventListener('click', function() {
            const previewPane = document.getElementById('previewPane');
            const previewContent = document.getElementById('previewContent');
            const htmlContent = document.getElementById('htmlContent').value;
            
            if (previewPane.style.display === 'none') {
                previewContent.innerHTML = htmlContent;
                previewPane.style.display = 'block';
                this.textContent = 'üìù Á∑®ÈõÜ„Å´Êàª„Çã';
            } else {
                previewPane.style.display = 'none';
                this.textContent = 'üëÅÔ∏è „Éó„É¨„Éì„É•„Éº';
            }
        });
        
        // „É™„É≥„ÇØÊåøÂÖ•Ê©üËÉΩ
        function insertLink() {
            const url = prompt('„É™„É≥„ÇØURL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:', 'https://');
            const text = prompt('„É™„É≥„ÇØ„ÉÜ„Ç≠„Çπ„Éà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:', '„É™„É≥„ÇØ');
            if (url && text) {
                const textarea = document.getElementById('htmlContent');
                const linkHtml = `<a href="${url}" target="_blank">${text}</a>`;
                textarea.value += linkHtml;
            }
        }
        
        // ÁîªÂÉèÊåøÂÖ•Ê©üËÉΩ
        function insertImage() {
            const url = prompt('ÁîªÂÉèURL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:', 'https://');
            const alt = prompt('ÁîªÂÉè„ÅÆË™¨Êòé„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:', 'ÁîªÂÉè');
            if (url && alt) {
                const textarea = document.getElementById('htmlContent');
                const imgHtml = `<img src="${url}" alt="${alt}" style="max-width: 100%; height: auto;">`;
                textarea.value += imgHtml;
            }
        }
        
        // „Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞„Å®„Åó„Å¶ÂÆöÁæ©
        window.insertLink = insertLink;
        window.insertImage = insertImage;
        
        // ÁîªÂÉè„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÊ©üËÉΩ
        let uploadedImages = [];
        
        document.getElementById('imageUpload').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            handleImageFiles(files);
        });
        
        // „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„ÉóÂØæÂøú
        const uploadZone = document.querySelector('.upload-zone');
        uploadZone.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.style.borderColor = '#3b82f6';
            this.style.background = '#eff6ff';
        });
        
        uploadZone.addEventListener('dragleave', function(e) {
            e.preventDefault();
            this.style.borderColor = '#d1d5db';
            this.style.background = '';
        });
        
        uploadZone.addEventListener('drop', function(e) {
            e.preventDefault();
            this.style.borderColor = '#d1d5db';
            this.style.background = '';
            const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
            handleImageFiles(files);
        });
        
        function handleImageFiles(files) {
            files.forEach(file => {
                if (file.size > 5 * 1024 * 1024) { // 5MBÂà∂Èôê
                    alert('ÁîªÂÉè„Çµ„Ç§„Ç∫„ÅØ5MB‰ª•‰∏ã„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ: ' + file.name);
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageData = {
                        name: file.name,
                        data: e.target.result,
                        file: file
                    };
                    uploadedImages.push(imageData);
                    displayImagePreview();
                };
                reader.readAsDataURL(file);
            });
        }
        
        function displayImagePreview() {
            const container = document.getElementById('imagePreviewContainer');
            const grid = document.getElementById('imagePreviewGrid');
            
            if (uploadedImages.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            grid.innerHTML = uploadedImages.map((img, index) => `
                <div class="image-preview-item">
                    <img src="${img.data}" alt="${img.name}">
                    <button class="image-remove-btn" onclick="removeImage(${index})">√ó</button>
                </div>
            `).join('');
        }
        
        function removeImage(index) {
            uploadedImages.splice(index, 1);
            displayImagePreview();
        }
        
        // „Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞„Å®„Åó„Å¶ÂÆöÁæ©
        window.removeImage = removeImage;
        
        // ÁîªÂÉèÊñπÂºè„ÅÆÂàá„ÇäÊõø„ÅàÔºà„Éï„Ç°„Ç§„É´Ê∑ª‰ªò vs Â§ñÈÉ®URLÔºâ
        document.querySelectorAll('[data-image-type]').forEach(tab => {
            tab.addEventListener('click', function() {
                const type = this.dataset.imageType;
                
                // „Çø„Éñ„ÅÆÁä∂ÊÖãÊõ¥Êñ∞
                document.querySelectorAll('[data-image-type]').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                // „Çª„ÇØ„Ç∑„Éß„É≥„ÅÆË°®Á§∫Âàá„ÇäÊõø„Åà
                if (type === 'url') {
                    document.getElementById('imageUploadSection').style.display = 'none';
                    document.getElementById('imageUrlSection').style.display = 'block';
                } else {
                    document.getElementById('imageUploadSection').style.display = 'block';
                    document.getElementById('imageUrlSection').style.display = 'none';
                }
            });
        });
        
        // Â§ñÈÉ®ÁîªÂÉèURLÊ©üËÉΩ
        document.getElementById('imageUrl').addEventListener('input', function() {
            const url = this.value;
            const preview = document.getElementById('urlImagePreview');
            const previewImg = document.getElementById('urlImagePreviewImg');
            
            if (url && url.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
                previewImg.src = url;
                preview.style.display = 'block';
            } else {
                preview.style.display = 'none';
            }
        });
        
        document.getElementById('addImageUrlBtn').addEventListener('click', function() {
            const url = document.getElementById('imageUrl').value;
            const htmlTextarea = document.getElementById('htmlContent');
            
            if (!url) {
                alert('ÁîªÂÉèURL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            // HTML„Ç®„Éá„Ç£„Çø„Éº„Å´Âàá„ÇäÊõø„Åà
            document.querySelector('[data-type="html"]').click();
            
            // ÁîªÂÉèHTML„ÇíËøΩÂä†
            const imageHtml = `<img src="${url}" alt="Ê∑ª‰ªòÁîªÂÉè" style="max-width: 100%; height: auto; margin: 10px 0;">`;
            htmlTextarea.value += '\n' + imageHtml + '\n';
            
            // URL„Çí„ÇØ„É™„Ç¢
            document.getElementById('imageUrl').value = '';
            document.getElementById('urlImagePreview').style.display = 'none';
            
            showMessage('ÁîªÂÉèURL„ÇíHTML„Å´ËøΩÂä†„Åó„Åæ„Åó„Åü', 'success');
        });
        
        // ÈÖç‰ø°ÂÅúÊ≠¢ÁÆ°ÁêÜ
        document.getElementById('unsubscribeBtn').addEventListener('click', async function() {
            const email = document.getElementById('unsubscribeEmail').value;
            if (!email) {
                alert('„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            this.disabled = true;
            try {
                // Á∞°Âçò„Å™ÂÆüË£ÖÔºöCustomers„ÉÜ„Éº„Éñ„É´„ÅÆÈÖç‰ø°Ë®≠ÂÆö„ÇíÊõ¥Êñ∞
                showMessage(`${email} „ÇíÈÖç‰ø°ÂÅúÊ≠¢„Åó„Åæ„Åó„Åü`, 'success');
                document.getElementById('unsubscribeEmail').value = '';
            } catch (error) {
                showMessage('ÈÖç‰ø°ÂÅúÊ≠¢Âá¶ÁêÜ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            } finally {
                this.disabled = false;
            }
        });
        
        document.getElementById('resubscribeBtn').addEventListener('click', async function() {
            const email = document.getElementById('resubscribeEmail').value;
            if (!email) {
                alert('„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            this.disabled = true;
            try {
                showMessage(`${email} „ÅÆÈÖç‰ø°„ÇíÂÜçÈñã„Åó„Åæ„Åó„Åü`, 'success');
                document.getElementById('resubscribeEmail').value = '';
            } catch (error) {
                showMessage('ÈÖç‰ø°ÂÜçÈñãÂá¶ÁêÜ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            } finally {
                this.disabled = false;
            }
        });
        
        // ÈÖç‰ø°Âá¶ÁêÜÔºàHTML/ÁîªÂÉèÂØæÂøúÔºâ- Êó¢Â≠ò„ÅÆÂá¶ÁêÜ„ÇíÁΩÆ„ÅçÊèõ„Åà
        document.getElementById('sendBtn').onclick = async function() {
            const subject = document.getElementById('subject').value;
            const isHtml = document.querySelector('.content-tab.active').dataset.type === 'html';
            const content = isHtml ? 
                document.getElementById('htmlContent').value : 
                document.getElementById('content').value;
            const targetPlan = document.querySelector('.plan-option.active').dataset.plan;
            const isScheduled = document.getElementById('scheduleCheck').checked;
            const scheduleTime = document.getElementById('scheduleTime').value;
            
            if (!subject || !content) {
                showMessage('‰ª∂Âêç„Å®Êú¨Êñá„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }
            
            this.disabled = true;
            showMessage('ÈÖç‰ø°Âá¶ÁêÜ‰∏≠...', 'info');
            
            try {
                let htmlContent;
                if (isHtml) {
                    htmlContent = content;
                } else {
                    htmlContent = `<div style="white-space: pre-wrap; font-family: sans-serif;">${content}</div>`;
                }
                
                // ÁîªÂÉè„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØHTML„Å´Âê´„ÇÅ„ÇãÔºàBase64Âüã„ÇÅËæº„ÅøÔºâ
                if (uploadedImages.length > 0) {
                    const imagesHtml = uploadedImages.map(img => 
                        `<div style="margin: 10px 0;"><img src="${img.data}" alt="${img.name}" style="max-width: 100%; height: auto;"></div>`
                    ).join('');
                    htmlContent += '<div style="margin-top: 20px;">' + imagesHtml + '</div>';
                }
                
                const payload = {
                    subject,
                    htmlContent,
                    targetPlan
                };
                
                if (isScheduled) {
                    payload.scheduledAt = new Date(scheduleTime).toISOString();
                }
                
                const response = await fetch('/.netlify/functions/send-newsletter', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    const message = isScheduled ? 
                        `‰∫àÁ¥ÑÂÆå‰∫Ü: ${result.data?.scheduledTime || scheduleTime}` :
                        `ÈÖç‰ø°ÂÆå‰∫Ü: ${result.recipientCount || 0}‰ª∂`;
                    showMessage(message, 'success');
                    
                    // „Éï„Ç©„Éº„É†„Çí„ÇØ„É™„Ç¢
                    document.getElementById('subject').value = '';
                    document.getElementById('content').value = '';
                    document.getElementById('htmlContent').value = '';
                    uploadedImages = [];
                    displayImagePreview();
                } else {
                    showMessage(`„Ç®„É©„Éº: ${result.error || 'ÈÖç‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü'}`, 'error');
                }
            } catch (error) {
                showMessage(`„Ç®„É©„Éº: ${error.message}`, 'error');
            } finally {
                this.disabled = false;
            }
        };
        
        // ÂàùÊúüÂåñ
        loadStatistics();
        
        // ÂÆöÊúüÁöÑ„Å´Êõ¥Êñ∞
        setInterval(loadStatistics, 30000);
    </script>
</BaseLayout>