---
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout title="ç®¡ç†è€…ãƒ‘ãƒãƒ« | ãƒ¬ãƒ¼ã‚¹çµæœå…¥åŠ›">
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
        }
        .admin-header {
            text-align: center;
            margin-bottom: 40px;
        }
        .admin-title {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #10b981 0%, #3b82f6 50%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }
        .form-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(148, 163, 184, 0.1);
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-label {
            display: block;
            color: var(--body-text-color);
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }
        .form-input {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(148, 163, 184, 0.2);
            border-radius: 8px;
            color: var(--body-text-color);
            font-size: 0.95rem;
            transition: border-color 0.3s;
        }
        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
        }
        .form-select {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(148, 163, 184, 0.2);
            border-radius: 8px;
            color: var(--body-text-color);
            font-size: 0.95rem;
            cursor: pointer;
        }
        .race-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .race-card {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(148, 163, 184, 0.1);
        }
        .race-header {
            text-align: center;
            font-weight: 700;
            font-size: 1.1rem;
            color: #3b82f6;
            margin-bottom: 15px;
        }
        .toggle-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .toggle-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid rgba(148, 163, 184, 0.2);
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--body-text-color);
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            font-weight: 600;
        }
        .toggle-btn.active.hit {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }
        .toggle-btn.active.miss {
            border-color: #ef4444;
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        .payout-group {
            display: none;
        }
        .payout-group.show {
            display: block;
        }
        .submit-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #10b981 0%, #3b82f6 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.3s;
        }
        .submit-btn:hover {
            transform: translateY(-2px);
        }
        .output-section {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 16px;
            padding: 30px;
            border: 1px solid rgba(148, 163, 184, 0.1);
            margin-top: 30px;
        }
        .json-output {
            background: #1e293b;
            border-radius: 8px;
            padding: 20px;
            color: #10b981;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
    </style>

    <div class="admin-container">
        <div class="admin-header">
            <h1 class="admin-title">ğŸ› ï¸ ç®¡ç†è€…ãƒ‘ãƒãƒ«</h1>
            <p style="color: var(--accent-text-color); font-size: 1.1rem;">
                ãƒ¬ãƒ¼ã‚¹çµæœã‚’ç°¡å˜å…¥åŠ› â†’ è‡ªå‹•ã§ã‚µã‚¤ãƒˆæ›´æ–°
            </p>
        </div>

        <form id="raceForm">
            <!-- åŸºæœ¬æƒ…å ±å…¥åŠ› -->
            <div class="form-section">
                <h2 style="color: #3b82f6; font-size: 1.5rem; margin-bottom: 20px;">ğŸ“… åŸºæœ¬æƒ…å ±</h2>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                    <div class="form-group">
                        <label class="form-label">æ—¥ä»˜</label>
                        <input type="text" class="form-input" id="raceDate" placeholder="8/22" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ç«¶é¦¬å ´</label>
                        <select class="form-select" id="track" required>
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="å¤§äº•ç«¶é¦¬">å¤§äº•ç«¶é¦¬</option>
                            <option value="å·å´ç«¶é¦¬">å·å´ç«¶é¦¬</option>
                            <option value="æµ¦å’Œç«¶é¦¬">æµ¦å’Œç«¶é¦¬</option>
                            <option value="èˆ¹æ©‹ç«¶é¦¬">èˆ¹æ©‹ç«¶é¦¬</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ç·ãƒ¬ãƒ¼ã‚¹æ•°</label>
                        <select class="form-select" id="totalRaces" required>
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="8">8ãƒ¬ãƒ¼ã‚¹</option>
                            <option value="10">10ãƒ¬ãƒ¼ã‚¹</option>
                            <option value="12">12ãƒ¬ãƒ¼ã‚¹</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- ä¸€æ‹¬ãƒšãƒ¼ã‚¹ãƒˆæ©Ÿèƒ½ -->
            <div class="form-section">
                <h2 style="color: #10b981; font-size: 1.5rem; margin-bottom: 20px;">ğŸ“‹ ä¸€æ‹¬ãƒšãƒ¼ã‚¹ãƒˆï¼ˆæ¨å¥¨ï¼‰</h2>
                <p style="color: var(--accent-text-color); margin-bottom: 15px;">
                    æ—¢å­˜ã®çµæœãƒ‡ãƒ¼ã‚¿ã‚’ãã®ã¾ã¾è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚è‡ªå‹•ã§è§£æã—ã¦å„ãƒ¬ãƒ¼ã‚¹ã«æŒ¯ã‚Šåˆ†ã‘ã¾ã™ã€‚
                </p>
                
                <div class="form-group">
                    <label class="form-label">ãƒ¬ãƒ¼ã‚¹çµæœãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘</label>
                    <textarea 
                        id="bulkPaste" 
                        class="form-input" 
                        placeholder="ä¾‹:
8/22å·å´ç«¶é¦¬äºˆæƒ³ çµæœ
ï¼‘ï¼² 11-ï¼˜é¦¬å˜ã€€ã€€920å†† çš„ä¸­ï¼
ï¼’ï¼² ï¼’-ï¼‘
ï¼“ï¼² ï¼—-ï¼‘é¦¬å˜ã€€1,330å†† çš„ä¸­ï¼
..."
                        style="height: 200px; resize: vertical;"
                    ></textarea>
                </div>
                
                <div style="display: flex; gap: 15px; margin-top: 15px;">
                    <button type="button" id="parseBtn" style="padding: 12px 24px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                        ğŸ” ãƒ‡ãƒ¼ã‚¿è§£æ
                    </button>
                    <button type="button" id="clearBtn" style="padding: 12px 24px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                        ğŸ—‘ï¸ ã‚¯ãƒªã‚¢
                    </button>
                </div>
            </div>

            <!-- ãƒ¬ãƒ¼ã‚¹çµæœå…¥åŠ› -->
            <div class="form-section">
                <h2 style="color: #3b82f6; font-size: 1.5rem; margin-bottom: 20px;">ğŸ‡ ãƒ¬ãƒ¼ã‚¹çµæœï¼ˆæ‰‹å‹•å…¥åŠ›ï¼‰</h2>
                <p style="color: var(--accent-text-color); margin-bottom: 15px;">
                    ä¸€æ‹¬ãƒšãƒ¼ã‚¹ãƒˆãŒä½¿ãˆãªã„å ´åˆã¯ã€ã“ã¡ã‚‰ã§æ‰‹å‹•å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
                </p>
                
                <div id="raceGrid" class="race-grid">
                    <!-- ãƒ¬ãƒ¼ã‚¹ã‚«ãƒ¼ãƒ‰ã¯å‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
                </div>
            </div>

            <button type="submit" class="submit-btn">
                ğŸš€ JSONãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
            </button>
        </form>

        <!-- ç”Ÿæˆã•ã‚ŒãŸJSONã®è¡¨ç¤º -->
        <div class="output-section">
            <h2 style="color: #10b981; font-size: 1.5rem; margin-bottom: 20px;">ğŸ“‹ ç”Ÿæˆã•ã‚ŒãŸJSON</h2>
            <p style="color: var(--accent-text-color); margin-bottom: 15px;">
                ä¸‹è¨˜ã®JSONã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ <code>src/data/raceResults.json</code> ã® <code>currentResults</code> ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„
            </p>
            <pre id="jsonOutput" class="json-output">ã“ã“ã«JSONãŒç”Ÿæˆã•ã‚Œã¾ã™...</pre>
            <button type="button" id="copyBtn" style="margin-top: 15px; padding: 10px 20px; background: #8b5cf6; color: white; border: none; border-radius: 6px; cursor: pointer;">
                ğŸ“‹ JSONã‚’ã‚³ãƒ”ãƒ¼
            </button>
        </div>
    </div>

    <script is:inline>
    // ãƒ¬ãƒ¼ã‚¹æ•°ã«å¿œã˜ã¦ãƒ¬ãƒ¼ã‚¹ã‚«ãƒ¼ãƒ‰ã‚’å‹•çš„ç”Ÿæˆ
    document.getElementById('totalRaces').addEventListener('change', function() {
        const totalRaces = parseInt(this.value);
        const raceGrid = document.getElementById('raceGrid');
        raceGrid.innerHTML = '';

        for (let i = 1; i <= totalRaces; i++) {
            const raceCard = createRaceCard(i);
            raceGrid.appendChild(raceCard);
        }
    });

    function createRaceCard(raceNum) {
        const card = document.createElement('div');
        card.className = 'race-card';
        card.innerHTML = `
            <div class="race-header">${raceNum}R</div>
            
            <div class="toggle-group">
                <button type="button" class="toggle-btn hit-btn" onclick="toggleResult(${raceNum}, 'hit')">
                    â­• çš„ä¸­
                </button>
                <button type="button" class="toggle-btn miss-btn" onclick="toggleResult(${raceNum}, 'miss')">
                    âŒ ä¸çš„ä¸­
                </button>
            </div>
            
            <div class="payout-group" id="payout-${raceNum}">
                <label class="form-label">é…å½“é‡‘é¡</label>
                <input type="number" class="form-input" id="amount-${raceNum}" placeholder="ä¾‹: 1500" min="0">
            </div>
            
            <input type="hidden" id="status-${raceNum}" value="">
        `;
        return card;
    }

    function toggleResult(raceNum, status) {
        // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
        const card = document.querySelector(`.race-card:nth-child(${raceNum})`);
        const hitBtn = card.querySelector('.hit-btn');
        const missBtn = card.querySelector('.miss-btn');
        const payoutGroup = document.getElementById(`payout-${raceNum}`);
        const statusInput = document.getElementById(`status-${raceNum}`);

        // ãƒªã‚»ãƒƒãƒˆ
        hitBtn.classList.remove('active', 'hit');
        missBtn.classList.remove('active', 'miss');
        
        // é¸æŠã•ã‚ŒãŸçŠ¶æ…‹ã«æ›´æ–°
        if (status === 'hit') {
            hitBtn.classList.add('active', 'hit');
            payoutGroup.classList.add('show');
            statusInput.value = 'hit';
        } else {
            missBtn.classList.add('active', 'miss');
            payoutGroup.classList.remove('show');
            statusInput.value = 'miss';
        }
    }

    // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†
    document.getElementById('raceForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const raceDate = document.getElementById('raceDate').value;
        const track = document.getElementById('track').value;
        const totalRaces = parseInt(document.getElementById('totalRaces').value);
        
        // ãƒ¬ãƒ¼ã‚¹çµæœã‚’åé›†
        const races = [];
        let hits = 0;
        let totalPayout = 0;

        for (let i = 1; i <= totalRaces; i++) {
            const status = document.getElementById(`status-${i}`).value;
            const amountInput = document.getElementById(`amount-${i}`);
            const payout = status === 'hit' ? (parseInt(amountInput.value) || 0) : 0;
            
            if (status === 'hit') {
                hits++;
                totalPayout += payout;
            }
            
            races.push({
                race: `${i}R`,
                status: status,
                betType: "é¦¬å˜",
                payout: payout
            });
        }

        const hitRate = ((hits / totalRaces) * 100).toFixed(1) + '%';
        const returnRate = totalPayout > 0 ? ((totalPayout / (totalRaces * 100)) * 100).toFixed(1) + '%' : '0%';

        // JSONã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç”Ÿæˆ
        const jsonData = {
            date: raceDate,
            track: track,
            totalRaces: totalRaces,
            hits: hits,
            hitRate: hitRate,
            payout: totalPayout,
            returnRate: returnRate,
            races: races
        };

        // JSONè¡¨ç¤º
        const jsonOutput = document.getElementById('jsonOutput');
        jsonOutput.textContent = JSON.stringify(jsonData, null, 2);
    });

    // ä¸€æ‹¬ãƒšãƒ¼ã‚¹ãƒˆè§£ææ©Ÿèƒ½
    document.getElementById('parseBtn').addEventListener('click', function() {
        const bulkText = document.getElementById('bulkPaste').value;
        if (!bulkText.trim()) {
            alert('è§£æã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            return;
        }

        try {
            // åŸºæœ¬æƒ…å ±ã‚’æŠ½å‡º
            const lines = bulkText.split('\n').filter(line => line.trim());
            
            // æ—¥ä»˜ã¨ç«¶é¦¬å ´ã‚’æŠ½å‡º
            const headerMatch = bulkText.match(/(\d+\/\d+)([^\d]*?)ç«¶é¦¬/);
            if (headerMatch) {
                document.getElementById('raceDate').value = headerMatch[1];
                const trackName = headerMatch[2].replace(/[^\u4e00-\u9faf]/g, '') + 'ç«¶é¦¬';
                document.getElementById('track').value = trackName;
            }

            // ãƒ¬ãƒ¼ã‚¹çµæœã‚’è§£æ
            const raceResults = [];
            lines.forEach(line => {
                const raceMatch = line.match(/([ï¼-ï¼™0-9]+)[ï¼²Rr]/);
                if (raceMatch) {
                    const raceNum = convertToHalfWidth(raceMatch[1]);
                    
                    // çš„ä¸­åˆ¤å®šï¼ˆé…å½“é‡‘é¡ãŒã‚ã‚‹ã‹ã©ã†ã‹ - ãƒ‰ãƒƒãƒˆåŒºåˆ‡ã‚Šã«å¯¾å¿œï¼‰
                    const payoutMatch = line.match(/(\d[\d,.]*)[å††]/);
                    const isHit = payoutMatch || line.includes('çš„ä¸­');
                    
                    const payout = payoutMatch ? parseInt(payoutMatch[1].replace(/[,.]/g, '')) : 0;
                    
                    raceResults.push({
                        race: parseInt(raceNum),
                        status: isHit ? 'hit' : 'miss',
                        payout: payout
                    });
                }
            });

            if (raceResults.length === 0) {
                alert('ãƒ¬ãƒ¼ã‚¹çµæœã‚’è§£æã§ãã¾ã›ã‚“ã§ã—ãŸã€‚å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            // ç·ãƒ¬ãƒ¼ã‚¹æ•°ã‚’è¨­å®š
            const maxRace = Math.max(...raceResults.map(r => r.race));
            document.getElementById('totalRaces').value = maxRace.toString();
            
            // ãƒ¬ãƒ¼ã‚¹ã‚«ãƒ¼ãƒ‰ç”Ÿæˆ
            document.getElementById('totalRaces').dispatchEvent(new Event('change'));
            
            // è§£æçµæœã‚’å„ãƒ•ã‚©ãƒ¼ãƒ ã«åæ˜ 
            setTimeout(() => {
                raceResults.forEach(result => {
                    const statusInput = document.getElementById(`status-${result.race}`);
                    const amountInput = document.getElementById(`amount-${result.race}`);
                    
                    if (statusInput && amountInput) {
                        toggleResult(result.race, result.status);
                        if (result.status === 'hit' && result.payout > 0) {
                            amountInput.value = result.payout;
                        }
                    }
                });

                alert(`è§£æå®Œäº†ï¼${raceResults.length}ãƒ¬ãƒ¼ã‚¹ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚`);
            }, 100);

        } catch (error) {
            console.error('è§£æã‚¨ãƒ©ãƒ¼:', error);
            alert('ãƒ‡ãƒ¼ã‚¿ã®è§£æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        }
    });

    // å…¨è§’æ•°å­—ã‚’åŠè§’ã«å¤‰æ›
    function convertToHalfWidth(str) {
        return str.replace(/[ï¼-ï¼™]/g, function(match) {
            return String.fromCharCode(match.charCodeAt(0) - 0xFEE0);
        });
    }

    // ã‚¯ãƒªã‚¢æ©Ÿèƒ½
    document.getElementById('clearBtn').addEventListener('click', function() {
        document.getElementById('bulkPaste').value = '';
        document.getElementById('raceGrid').innerHTML = '';
        document.getElementById('jsonOutput').textContent = 'ã“ã“ã«JSONãŒç”Ÿæˆã•ã‚Œã¾ã™...';
        
        // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
        document.getElementById('raceDate').value = '';
        document.getElementById('track').value = '';
        document.getElementById('totalRaces').value = '';
        
        alert('âœ… ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚');
    });

    // ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½
    document.getElementById('copyBtn').addEventListener('click', function() {
        const jsonText = document.getElementById('jsonOutput').textContent;
        navigator.clipboard.writeText(jsonText).then(() => {
            this.textContent = 'âœ… ã‚³ãƒ”ãƒ¼å®Œäº†!';
            setTimeout(() => {
                this.textContent = 'ğŸ“‹ JSONã‚’ã‚³ãƒ”ãƒ¼';
            }, 2000);
        });
    });
    </script>
</BaseLayout>