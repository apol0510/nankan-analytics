---
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout title="ç®¡ç†è€…ãƒ‘ãƒãƒ« | ãƒ¬ãƒ¼ã‚¹çµæœå…¥åŠ›">
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
        }
        .admin-header {
            text-align: center;
            margin-bottom: 40px;
        }
        .admin-title {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #10b981 0%, #3b82f6 50%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }
        .form-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(148, 163, 184, 0.1);
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-label {
            display: block;
            color: var(--body-text-color);
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }
        .form-input {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(148, 163, 184, 0.2);
            border-radius: 8px;
            color: var(--body-text-color);
            font-size: 0.95rem;
            transition: border-color 0.3s;
        }
        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
        }
        .form-select {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(148, 163, 184, 0.2);
            border-radius: 8px;
            color: var(--body-text-color);
            font-size: 0.95rem;
            cursor: pointer;
        }
        .race-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .race-card {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(148, 163, 184, 0.1);
        }
        .race-header {
            text-align: center;
            font-weight: 700;
            font-size: 1.1rem;
            color: #3b82f6;
            margin-bottom: 15px;
        }
        .toggle-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .toggle-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid rgba(148, 163, 184, 0.2);
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--body-text-color);
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            font-weight: 600;
        }
        .toggle-btn.active.hit {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }
        .toggle-btn.active.miss {
            border-color: #ef4444;
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        .payout-group {
            display: none;
        }
        .payout-group.show {
            display: block;
        }
        .submit-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #10b981 0%, #3b82f6 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.3s;
        }
        .submit-btn:hover {
            transform: translateY(-2px);
        }
        .output-section {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 16px;
            padding: 30px;
            border: 1px solid rgba(148, 163, 184, 0.1);
            margin-top: 30px;
        }
        .json-output {
            background: #1e293b;
            border-radius: 8px;
            padding: 20px;
            color: #10b981;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
    </style>

    <div class="admin-container">
        <div class="admin-header">
            <h1 class="admin-title">ğŸ› ï¸ ç®¡ç†è€…ãƒ‘ãƒãƒ«</h1>
            <p style="color: var(--accent-text-color); font-size: 1.1rem;">
                ãƒ¬ãƒ¼ã‚¹çµæœã‚’ç°¡å˜å…¥åŠ› â†’ è‡ªå‹•ã§ã‚µã‚¤ãƒˆæ›´æ–°
            </p>
        </div>

        <!-- å¤–éƒ¨äºˆæƒ³å¤‰æ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="form-section">
            <h2 style="color: #f59e0b; font-size: 1.5rem; margin-bottom: 20px;">ğŸ“‹ å¤–éƒ¨äºˆæƒ³â†’AIäºˆæƒ³å¤‰æ›</h2>
            <p style="color: var(--accent-text-color); margin-bottom: 20px;">
                æ—¢å­˜ã®äºˆæƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒšãƒ¼ã‚¹ãƒˆã™ã‚‹ã ã‘ã§ã€AIäºˆæƒ³ã®è©³ç´°åˆ†æã«è‡ªå‹•å¤‰æ›ã—ã¾ã™
            </p>
            
            <div class="form-group">
                <label class="form-label">å¤–éƒ¨äºˆæƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒšãƒ¼ã‚¹ãƒˆ</label>
                <textarea 
                    id="externalPrediction" 
                    class="form-input" 
                    placeholder="ä¾‹:
8/20æµ¦å’Œç«¶é¦¬
ï¼‘ï¼‘ï¼²ã€€ãƒ«ãƒ¼ã‚­ãƒ¼ã‚ºã‚µãƒãƒ¼ã‚«ãƒƒãƒ—ï¼ˆï¼³IIIï¼‰

æœ¬å‘½äºˆæƒ³
â—ï¼˜ã‚¢ãƒ³ã‚¸ãƒ¥ãƒ«ãƒŠ
â—‹ï¼‘ã‚¢ãƒ ãƒ¼ãƒ«ãƒ”ã‚¹ã‚±ã‚¹
â–²ï¼•ãƒ­ãƒ¼ãƒ‰ãƒ¬ã‚¤ã‚¸ãƒ³ã‚°
â–³ï¼™ãƒã‚¤ãƒ“ãƒ¼ã‚·ãƒ³ãƒ‡ãƒ¬ãƒ©
â–³ï¼’ã‚­ãƒ³ãƒãƒ£ãƒ³

AIåˆ†æç†ç”±
ï¼˜ã‚¢ãƒ³ã‚¸ãƒ¥ãƒ«ãƒŠ
ï¼˜ï¼ï¼ãƒ¡ãƒ¼ãƒˆãƒ«ã®æ–°é¦¬æˆ¦ã¯å‡ºé…ã‚Œã‚‚éŸ¿ã„ã¦â‘¢ç€ã«çµ‚ã‚ã£ãŸãŒ..."
                    style="height: 300px; resize: vertical; font-family: monospace;"
                ></textarea>
            </div>
            
            <div style="display: flex; gap: 15px; margin-top: 15px;">
                <button type="button" id="convertPredictionBtn" style="padding: 12px 24px; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                    ğŸ”„ AIäºˆæƒ³ã«å¤‰æ›
                </button>
                <button type="button" id="clearPredictionBtn" style="padding: 12px 24px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                    ğŸ—‘ï¸ ã‚¯ãƒªã‚¢
                </button>
            </div>
        </div>

        <!-- AIäºˆæƒ³ç·¨é›†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="form-section">
            <h2 style="color: #8b5cf6; font-size: 1.5rem; margin-bottom: 20px;">ğŸ¤– AIäºˆæƒ³ç·¨é›†ï¼ˆå¤‰æ›å¾Œã®å¾®èª¿æ•´ç”¨ï¼‰</h2>
            <p style="color: var(--accent-text-color); margin-bottom: 20px;">
                ä¸Šè¨˜ã®å¤‰æ›çµæœã‚’å¾®èª¿æ•´ã—ã¦ã€free-prediction/ãƒšãƒ¼ã‚¸ã¨ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ä¸€æ‹¬æ›´æ–°
            </p>
            
            <!-- ãƒ¬ãƒ¼ã‚¹åŸºæœ¬æƒ…å ± -->
            <div style="background: rgba(139, 92, 246, 0.1); padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 1px solid rgba(139, 92, 246, 0.2);">
                <h3 style="color: #8b5cf6; margin-bottom: 15px;">ğŸ“… ãƒ¬ãƒ¼ã‚¹åŸºæœ¬æƒ…å ±</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">
                    <div class="form-group">
                        <label class="form-label">ãƒ¬ãƒ¼ã‚¹å</label>
                        <input type="text" class="form-input" id="aiRaceTitle" placeholder="ä¾‹: èˆ¹æ©‹2R C3é¸æŠœ 1200m" value="èˆ¹æ©‹2R C3é¸æŠœ 1200m">
                    </div>
                    <div class="form-group">
                        <label class="form-label">äºˆæ¸¬ä¿¡é ¼åº¦ï¼ˆ%ï¼‰</label>
                        <input type="number" class="form-input" id="aiConfidence" placeholder="94.2" value="94.2" step="0.1" min="0" max="100">
                    </div>
                    <div class="form-group">
                        <label class="form-label">èƒ½åŠ›æŒ‡æ•°</label>
                        <input type="number" class="form-input" id="aiAbilityIndex" placeholder="87.5" value="87.5" step="0.1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">æ¨å¥¨åº¦</label>
                        <select class="form-select" id="aiRecommendation">
                            <option value="S">S</option>
                            <option value="A+" selected>A+</option>
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">æœŸå¾…å›åç‡ï¼ˆ%ï¼‰</label>
                        <input type="number" class="form-input" id="aiExpectedReturn" placeholder="156" value="156" min="0">
                    </div>
                </div>
            </div>

            <!-- æœ¬å‘½é¦¬æƒ…å ± -->
            <div style="background: rgba(16, 185, 129, 0.1); padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 1px solid rgba(16, 185, 129, 0.2);">
                <h3 style="color: #10b981; margin-bottom: 15px;">ğŸ† æœ¬å‘½é¦¬æƒ…å ±</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div class="form-group">
                        <label class="form-label">é¦¬ç•ª</label>
                        <input type="number" class="form-input" id="mainHorseNumber" value="11" min="1" max="16">
                    </div>
                    <div class="form-group">
                        <label class="form-label">é¦¬å</label>
                        <input type="text" class="form-input" id="mainHorseName" value="ãƒ©ãƒãƒãƒ¼ãƒ¬ã‚¨ãƒ¼ãƒ«">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ä¿¡é ¼åº¦ï¼ˆ%ï¼‰</label>
                        <input type="number" class="form-input" id="mainHorseConfidence" value="92.8" step="0.1">
                    </div>
                </div>
            </div>

            <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æƒ…å ± -->
            <div style="background: rgba(59, 130, 246, 0.1); padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 1px solid rgba(59, 130, 246, 0.2);">
                <h3 style="color: #3b82f6; margin-bottom: 15px;">ğŸ‘ï¸ ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
                <div class="form-group">
                    <label class="form-label">æŠ•è³‡æˆ¦ç•¥ã‚µãƒãƒªãƒ¼</label>
                    <textarea class="form-input" id="previewSummary" style="height: 80px; resize: vertical;" placeholder="æ¨å¥¨æŠ•è³‡æˆ¦ç•¥: é¦¬é€£ãƒ»3é€£è¤‡ä¸­å¿ƒã€æœŸå¾…å€¤+15.7%">æ¨å¥¨æŠ•è³‡æˆ¦ç•¥: é¦¬é€£ãƒ»3é€£è¤‡ä¸­å¿ƒã€æœŸå¾…å€¤+15.7%</textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">ç‰¹å¾´é‡é‡è¦åº¦</label>
                    <textarea class="form-input" id="previewFeatures" style="height: 80px; resize: vertical;" placeholder="ç‰¹å¾´é‡é‡è¦åº¦: å®‰å®šæ€§(0.95)ã€èƒ½åŠ›ä¸Šä½æ€§(0.88)ã€å±•é–‹åˆ©(0.82)">ç‰¹å¾´é‡é‡è¦åº¦: å®‰å®šæ€§(0.95)ã€èƒ½åŠ›ä¸Šä½æ€§(0.88)ã€å±•é–‹åˆ©(0.82)</textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">ãƒªã‚¹ã‚¯åˆ†æ</label>
                    <select class="form-select" id="previewRisk">
                        <option value="ä½ãƒªã‚¹ã‚¯ã€å®‰å®šåç›Šå‹" selected>ä½ãƒªã‚¹ã‚¯ã€å®‰å®šåç›Šå‹</option>
                        <option value="ä¸­ãƒªã‚¹ã‚¯ã€ãƒãƒ©ãƒ³ã‚¹å‹">ä¸­ãƒªã‚¹ã‚¯ã€ãƒãƒ©ãƒ³ã‚¹å‹</option>
                        <option value="é«˜ãƒªã‚¹ã‚¯ã€çˆ†ç™ºåŠ›å‹">é«˜ãƒªã‚¹ã‚¯ã€çˆ†ç™ºåŠ›å‹</option>
                    </select>
                </div>
            </div>

            <!-- ç‰¹å¾´é‡é‡è¦åº¦ãƒãƒ¼ç·¨é›†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div style="background: rgba(245, 158, 11, 0.1); padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 1px solid rgba(245, 158, 11, 0.2);">
                <h3 style="color: #f59e0b; margin-bottom: 15px;">ğŸ“Š ç‰¹å¾´é‡é‡è¦åº¦ãƒãƒ¼ç·¨é›†</h3>
                <p style="color: var(--accent-text-color); margin-bottom: 20px; font-size: 0.9rem;">
                    â—å°ã¨â—‹å°ã®ç‰¹å¾´é‡é‡è¦åº¦ã‚’å€‹åˆ¥è¨­å®šã€‚ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ç¢ºèªã—ãªãŒã‚‰èª¿æ•´å¯èƒ½ã€‚
                </p>
                
                <!-- â—å°ï¼ˆæœ¬å‘½ï¼‰ã®ç‰¹å¾´é‡é‡è¦åº¦ -->
                <div style="background: rgba(16, 185, 129, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="color: #10b981; margin-bottom: 15px;">â— æœ¬å‘½é¦¬ã®ç‰¹å¾´é‡é‡è¦åº¦</h4>
                    <div style="display: grid; gap: 15px;">
                        <div>
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                <label class="form-label" style="margin-bottom: 0; min-width: 100px;">ç‰¹å¾´é‡1:</label>
                                <input type="text" id="mainFeature1Label" value="å®‰å®šæ€§" placeholder="ä¾‹: å®‰å®šæ€§, è¡€çµ±è©•ä¾¡" style="padding: 5px 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.2); border-radius: 4px; color: white; flex: 1;">
                            </div>
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <input type="range" id="mainFeature1" min="0" max="100" value="95" style="flex: 1;">
                                <input type="number" id="mainFeature1Val" min="0" max="1" step="0.01" value="0.95" style="width: 80px; padding: 5px; background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.2); border-radius: 4px; color: white;">
                            </div>
                            <div class="preview-bar" style="margin-top: 8px;">
                                <div class="preview-bar-fill" style="width: 95%; height: 16px; background: linear-gradient(90deg, #3b82f6, #8b5cf6); border-radius: 8px; display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; color: white; font-size: 0.75rem; font-weight: 600;">0.95</div>
                            </div>
                        </div>
                        <div>
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                <label class="form-label" style="margin-bottom: 0; min-width: 100px;">ç‰¹å¾´é‡2:</label>
                                <input type="text" id="mainFeature2Label" value="èƒ½åŠ›ä¸Šä½æ€§" placeholder="ä¾‹: èƒ½åŠ›ä¸Šä½æ€§, èª¿æ•™å†…å®¹" style="padding: 5px 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.2); border-radius: 4px; color: white; flex: 1;">
                            </div>
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <input type="range" id="mainFeature2" min="0" max="100" value="88" style="flex: 1;">
                                <input type="number" id="mainFeature2Val" min="0" max="1" step="0.01" value="0.88" style="width: 80px; padding: 5px; background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.2); border-radius: 4px; color: white;">
                            </div>
                            <div class="preview-bar" style="margin-top: 8px;">
                                <div class="preview-bar-fill" style="width: 88%; height: 16px; background: linear-gradient(90deg, #3b82f6, #8b5cf6); border-radius: 8px; display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; color: white; font-size: 0.75rem; font-weight: 600;">0.88</div>
                            </div>
                        </div>
                        <div>
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                <label class="form-label" style="margin-bottom: 0; min-width: 100px;">ç‰¹å¾´é‡3:</label>
                                <input type="text" id="mainFeature3Label" value="å±•é–‹åˆ©" placeholder="ä¾‹: å±•é–‹åˆ©, é¦¬ä½“è©•ä¾¡" style="padding: 5px 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.2); border-radius: 4px; color: white; flex: 1;">
                            </div>
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <input type="range" id="mainFeature3" min="0" max="100" value="82" style="flex: 1;">
                                <input type="number" id="mainFeature3Val" min="0" max="1" step="0.01" value="0.82" style="width: 80px; padding: 5px; background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.2); border-radius: 4px; color: white;">
                            </div>
                            <div class="preview-bar" style="margin-top: 8px;">
                                <div class="preview-bar-fill" style="width: 82%; height: 16px; background: linear-gradient(90deg, #3b82f6, #8b5cf6); border-radius: 8px; display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; color: white; font-size: 0.75rem; font-weight: 600;">0.82</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- â—‹å°ï¼ˆå¯¾æŠ—ï¼‰ã®ç‰¹å¾´é‡é‡è¦åº¦ -->
                <div style="background: rgba(59, 130, 246, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="color: #3b82f6; margin-bottom: 15px;">â—‹ å¯¾æŠ—é¦¬ã®ç‰¹å¾´é‡é‡è¦åº¦</h4>
                    <div style="display: grid; gap: 15px;">
                        <div>
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                <label class="form-label" style="margin-bottom: 0; min-width: 100px;">ç‰¹å¾´é‡1:</label>
                                <input type="text" id="subFeature1Label" value="å…ˆè¡ŒåŠ›" placeholder="ä¾‹: å…ˆè¡ŒåŠ›, ã‚¹ãƒ”ãƒ¼ãƒ‰æŒ‡æ•°" style="padding: 5px 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.2); border-radius: 4px; color: white; flex: 1;">
                            </div>
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <input type="range" id="subFeature1" min="0" max="100" value="96" style="flex: 1;">
                                <input type="number" id="subFeature1Val" min="0" max="1" step="0.01" value="0.96" style="width: 80px; padding: 5px; background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.2); border-radius: 4px; color: white;">
                            </div>
                            <div class="preview-bar" style="margin-top: 8px;">
                                <div class="preview-bar-fill" style="width: 96%; height: 16px; background: linear-gradient(90deg, #3b82f6, #8b5cf6); border-radius: 8px; display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; color: white; font-size: 0.75rem; font-weight: 600;">0.96</div>
                            </div>
                        </div>
                        <div>
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                <label class="form-label" style="margin-bottom: 0; min-width: 100px;">ç‰¹å¾´é‡2:</label>
                                <input type="text" id="subFeature2Label" value="ã‚¹ãƒ”ãƒ¼ãƒ‰æŒ‡æ•°" placeholder="ä¾‹: ã‚¹ãƒ”ãƒ¼ãƒ‰æŒ‡æ•°, èª¿æ•™å†…å®¹" style="padding: 5px 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.2); border-radius: 4px; color: white; flex: 1;">
                            </div>
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <input type="range" id="subFeature2" min="0" max="100" value="85" style="flex: 1;">
                                <input type="number" id="subFeature2Val" min="0" max="1" step="0.01" value="0.85" style="width: 80px; padding: 5px; background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.2); border-radius: 4px; color: white;">
                            </div>
                            <div class="preview-bar" style="margin-top: 8px;">
                                <div class="preview-bar-fill" style="width: 85%; height: 16px; background: linear-gradient(90deg, #3b82f6, #8b5cf6); border-radius: 8px; display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; color: white; font-size: 0.75rem; font-weight: 600;">0.85</div>
                            </div>
                        </div>
                        <div>
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                <label class="form-label" style="margin-bottom: 0; min-width: 100px;">ç‰¹å¾´é‡3:</label>
                                <input type="text" id="subFeature3Label" value="æ é †å„ªä½" placeholder="ä¾‹: æ é †å„ªä½, é¦¬ä½“è©•ä¾¡" style="padding: 5px 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.2); border-radius: 4px; color: white; flex: 1;">
                            </div>
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <input type="range" id="subFeature3" min="0" max="100" value="79" style="flex: 1;">
                                <input type="number" id="subFeature3Val" min="0" max="1" step="0.01" value="0.79" style="width: 80px; padding: 5px; background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.2); border-radius: 4px; color: white;">
                            </div>
                            <div class="preview-bar" style="margin-top: 8px;">
                                <div class="preview-bar-fill" style="width: 79%; height: 16px; background: linear-gradient(90deg, #3b82f6, #8b5cf6); border-radius: 8px; display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; color: white; font-size: 0.75rem; font-weight: 600;">0.79</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 15px;">
                <button type="button" id="testBtn" style="padding: 12px 24px; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                    ğŸ§ª ãƒ†ã‚¹ãƒˆ
                </button>
                <button type="button" id="generateAIPredictionBtn" class="submit-btn" style="background: linear-gradient(135deg, #8b5cf6 0%, #3b82f6 100%); flex: 1;">
                    ğŸš€ AIäºˆæƒ³JSONãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
                </button>
            </div>
        </div>

        <form id="raceForm">
            <!-- åŸºæœ¬æƒ…å ±å…¥åŠ› -->
            <div class="form-section">
                <h2 style="color: #3b82f6; font-size: 1.5rem; margin-bottom: 20px;">ğŸ“… åŸºæœ¬æƒ…å ±</h2>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                    <div class="form-group">
                        <label class="form-label">æ—¥ä»˜</label>
                        <input type="text" class="form-input" id="raceDate" placeholder="8/22" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ç«¶é¦¬å ´</label>
                        <select class="form-select" id="track" required>
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="å¤§äº•ç«¶é¦¬">å¤§äº•ç«¶é¦¬</option>
                            <option value="å·å´ç«¶é¦¬">å·å´ç«¶é¦¬</option>
                            <option value="æµ¦å’Œç«¶é¦¬">æµ¦å’Œç«¶é¦¬</option>
                            <option value="èˆ¹æ©‹ç«¶é¦¬">èˆ¹æ©‹ç«¶é¦¬</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ç·ãƒ¬ãƒ¼ã‚¹æ•°</label>
                        <select class="form-select" id="totalRaces" required>
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="8">8ãƒ¬ãƒ¼ã‚¹</option>
                            <option value="10">10ãƒ¬ãƒ¼ã‚¹</option>
                            <option value="12">12ãƒ¬ãƒ¼ã‚¹</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- ä¸€æ‹¬ãƒšãƒ¼ã‚¹ãƒˆæ©Ÿèƒ½ -->
            <div class="form-section">
                <h2 style="color: #10b981; font-size: 1.5rem; margin-bottom: 20px;">ğŸ“‹ ä¸€æ‹¬ãƒšãƒ¼ã‚¹ãƒˆï¼ˆæ¨å¥¨ï¼‰</h2>
                <p style="color: var(--accent-text-color); margin-bottom: 15px;">
                    æ—¢å­˜ã®çµæœãƒ‡ãƒ¼ã‚¿ã‚’ãã®ã¾ã¾è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚è‡ªå‹•ã§è§£æã—ã¦å„ãƒ¬ãƒ¼ã‚¹ã«æŒ¯ã‚Šåˆ†ã‘ã¾ã™ã€‚
                </p>
                
                <div class="form-group">
                    <label class="form-label">ãƒ¬ãƒ¼ã‚¹çµæœãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘</label>
                    <textarea 
                        id="bulkPaste" 
                        class="form-input" 
                        placeholder="ä¾‹:
8/22å·å´ç«¶é¦¬äºˆæƒ³ çµæœ
ï¼‘ï¼² 11-ï¼˜é¦¬å˜ã€€ã€€920å†† çš„ä¸­ï¼
ï¼’ï¼² ï¼’-ï¼‘
ï¼“ï¼² ï¼—-ï¼‘é¦¬å˜ã€€1,330å†† çš„ä¸­ï¼
..."
                        style="height: 200px; resize: vertical;"
                    ></textarea>
                </div>
                
                <div style="display: flex; gap: 15px; margin-top: 15px;">
                    <button type="button" id="parseBtn" style="padding: 12px 24px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                        ğŸ” ãƒ‡ãƒ¼ã‚¿è§£æ
                    </button>
                    <button type="button" id="clearBtn" style="padding: 12px 24px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                        ğŸ—‘ï¸ ã‚¯ãƒªã‚¢
                    </button>
                </div>
            </div>

            <!-- ãƒ¬ãƒ¼ã‚¹çµæœå…¥åŠ› -->
            <div class="form-section">
                <h2 style="color: #3b82f6; font-size: 1.5rem; margin-bottom: 20px;">ğŸ‡ ãƒ¬ãƒ¼ã‚¹çµæœï¼ˆæ‰‹å‹•å…¥åŠ›ï¼‰</h2>
                <p style="color: var(--accent-text-color); margin-bottom: 15px;">
                    ä¸€æ‹¬ãƒšãƒ¼ã‚¹ãƒˆãŒä½¿ãˆãªã„å ´åˆã¯ã€ã“ã¡ã‚‰ã§æ‰‹å‹•å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
                </p>
                
                <div id="raceGrid" class="race-grid">
                    <!-- ãƒ¬ãƒ¼ã‚¹ã‚«ãƒ¼ãƒ‰ã¯å‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
                </div>
            </div>

            <button type="submit" class="submit-btn">
                ğŸš€ JSONãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
            </button>
        </form>

        <!-- ç”Ÿæˆã•ã‚ŒãŸJSONã®è¡¨ç¤º -->
        <div class="output-section">
            <h2 style="color: #10b981; font-size: 1.5rem; margin-bottom: 20px;">ğŸ“‹ ç”Ÿæˆã•ã‚ŒãŸJSON</h2>
            <p id="outputDescription" style="color: var(--accent-text-color); margin-bottom: 15px;">
                ä¸‹è¨˜ã®JSONã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ <code>src/data/raceResults.json</code> ã® <code>currentResults</code> ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„
            </p>
            <pre id="jsonOutput" class="json-output">ã“ã“ã«JSONãŒç”Ÿæˆã•ã‚Œã¾ã™...</pre>
            <div style="display: flex; gap: 15px; margin-top: 15px;">
                <button type="button" id="copyBtn" style="padding: 10px 20px; background: #8b5cf6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                    ğŸ“‹ JSONã‚’ã‚³ãƒ”ãƒ¼
                </button>
                <button type="button" id="aiCopyBtn" style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                    ğŸ¤– AIäºˆæƒ³JSONã‚³ãƒ”ãƒ¼
                </button>
            </div>
        </div>
    </div>

    <script is:inline>
    // DOMèª­ã¿è¾¼ã¿å®Œäº†ã‚’å¾…ã¤
    document.addEventListener('DOMContentLoaded', function() {
        console.log('ç®¡ç†è€…ãƒ‘ãƒãƒ«: DOMèª­ã¿è¾¼ã¿å®Œäº†');
        
        // åˆæœŸåŒ–å‡¦ç†
        initializeAdminPanel();
    });

    function initializeAdminPanel() {
        // ãƒœã‚¿ãƒ³ã®å­˜åœ¨ç¢ºèª
        const generateBtn = document.getElementById('generateAIPredictionBtn');
        const testBtn = document.getElementById('testBtn');
        
        if (generateBtn) {
            console.log('AIäºˆæƒ³JSONãƒ‡ãƒ¼ã‚¿ç”Ÿæˆãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ');
        } else {
            console.error('AIäºˆæƒ³JSONãƒ‡ãƒ¼ã‚¿ç”Ÿæˆãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        }
        
        if (testBtn) {
            console.log('ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ');
            
            // ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            testBtn.addEventListener('click', function() {
                alert('âœ… JavaScriptå‹•ä½œç¢ºèªOK!\n\nãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã‚‚ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                console.log('ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ - JavaScriptæ­£å¸¸å‹•ä½œ');
            });
        } else {
            console.error('ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        }
    }

    // ãƒ¬ãƒ¼ã‚¹æ•°ã«å¿œã˜ã¦ãƒ¬ãƒ¼ã‚¹ã‚«ãƒ¼ãƒ‰ã‚’å‹•çš„ç”Ÿæˆ
    document.getElementById('totalRaces').addEventListener('change', function() {
        const totalRaces = parseInt(this.value);
        const raceGrid = document.getElementById('raceGrid');
        raceGrid.innerHTML = '';

        for (let i = 1; i <= totalRaces; i++) {
            const raceCard = createRaceCard(i);
            raceGrid.appendChild(raceCard);
        }
    });

    function createRaceCard(raceNum) {
        const card = document.createElement('div');
        card.className = 'race-card';
        card.innerHTML = `
            <div class="race-header">${raceNum}R</div>
            
            <div class="toggle-group">
                <button type="button" class="toggle-btn hit-btn" onclick="toggleResult(${raceNum}, 'hit')">
                    â­• çš„ä¸­
                </button>
                <button type="button" class="toggle-btn miss-btn" onclick="toggleResult(${raceNum}, 'miss')">
                    âŒ ä¸çš„ä¸­
                </button>
            </div>
            
            <div class="payout-group" id="payout-${raceNum}">
                <label class="form-label">é…å½“é‡‘é¡</label>
                <input type="number" class="form-input" id="amount-${raceNum}" placeholder="ä¾‹: 1500" min="0">
            </div>
            
            <input type="hidden" id="status-${raceNum}" value="">
        `;
        return card;
    }

    function toggleResult(raceNum, status) {
        // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
        const card = document.querySelector(`.race-card:nth-child(${raceNum})`);
        const hitBtn = card.querySelector('.hit-btn');
        const missBtn = card.querySelector('.miss-btn');
        const payoutGroup = document.getElementById(`payout-${raceNum}`);
        const statusInput = document.getElementById(`status-${raceNum}`);

        // ãƒªã‚»ãƒƒãƒˆ
        hitBtn.classList.remove('active', 'hit');
        missBtn.classList.remove('active', 'miss');
        
        // é¸æŠã•ã‚ŒãŸçŠ¶æ…‹ã«æ›´æ–°
        if (status === 'hit') {
            hitBtn.classList.add('active', 'hit');
            payoutGroup.classList.add('show');
            statusInput.value = 'hit';
        } else {
            missBtn.classList.add('active', 'miss');
            payoutGroup.classList.remove('show');
            statusInput.value = 'miss';
        }
    }

    // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†
    document.getElementById('raceForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const raceDate = document.getElementById('raceDate').value;
        const track = document.getElementById('track').value;
        const totalRaces = parseInt(document.getElementById('totalRaces').value);
        
        // ãƒ¬ãƒ¼ã‚¹çµæœã‚’åé›†
        const races = [];
        let hits = 0;
        let totalPayout = 0;

        for (let i = 1; i <= totalRaces; i++) {
            const status = document.getElementById(`status-${i}`).value;
            const amountInput = document.getElementById(`amount-${i}`);
            const payout = status === 'hit' ? (parseInt(amountInput.value) || 0) : 0;
            
            if (status === 'hit') {
                hits++;
                totalPayout += payout;
            }
            
            races.push({
                race: `${i}R`,
                status: status,
                betType: "é¦¬å˜",
                payout: payout
            });
        }

        const hitRate = ((hits / totalRaces) * 100).toFixed(1) + '%';
        const returnRate = totalPayout > 0 ? ((totalPayout / (totalRaces * 100)) * 100).toFixed(1) + '%' : '0%';

        // JSONã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç”Ÿæˆ
        const jsonData = {
            date: raceDate,
            track: track,
            totalRaces: totalRaces,
            hits: hits,
            hitRate: hitRate,
            payout: totalPayout,
            returnRate: returnRate,
            races: races
        };

        // JSONè¡¨ç¤º
        const jsonOutput = document.getElementById('jsonOutput');
        jsonOutput.textContent = JSON.stringify(jsonData, null, 2);
    });

    // ä¸€æ‹¬ãƒšãƒ¼ã‚¹ãƒˆè§£ææ©Ÿèƒ½
    document.getElementById('parseBtn').addEventListener('click', function() {
        const bulkText = document.getElementById('bulkPaste').value;
        if (!bulkText.trim()) {
            alert('è§£æã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            return;
        }

        try {
            // åŸºæœ¬æƒ…å ±ã‚’æŠ½å‡º
            const lines = bulkText.split('\n').filter(line => line.trim());
            
            // æ—¥ä»˜ã¨ç«¶é¦¬å ´ã‚’æŠ½å‡º
            const headerMatch = bulkText.match(/(\d+\/\d+)([^\d]*?)ç«¶é¦¬/);
            if (headerMatch) {
                document.getElementById('raceDate').value = headerMatch[1];
                const trackName = headerMatch[2].replace(/[^\u4e00-\u9faf]/g, '') + 'ç«¶é¦¬';
                document.getElementById('track').value = trackName;
            }

            // ãƒ¬ãƒ¼ã‚¹çµæœã‚’è§£æ
            const raceResults = [];
            lines.forEach(line => {
                const raceMatch = line.match(/([ï¼-ï¼™0-9]+)[ï¼²Rr]/);
                if (raceMatch) {
                    const raceNum = convertToHalfWidth(raceMatch[1]);
                    
                    // çš„ä¸­åˆ¤å®šï¼ˆé…å½“é‡‘é¡ãŒã‚ã‚‹ã‹ã©ã†ã‹ - ãƒ‰ãƒƒãƒˆåŒºåˆ‡ã‚Šã«å¯¾å¿œï¼‰
                    const payoutMatch = line.match(/(\d[\d,.]*)[å††]/);
                    const isHit = payoutMatch || line.includes('çš„ä¸­');
                    
                    const payout = payoutMatch ? parseInt(payoutMatch[1].replace(/[,.]/g, '')) : 0;
                    
                    raceResults.push({
                        race: parseInt(raceNum),
                        status: isHit ? 'hit' : 'miss',
                        payout: payout
                    });
                }
            });

            if (raceResults.length === 0) {
                alert('ãƒ¬ãƒ¼ã‚¹çµæœã‚’è§£æã§ãã¾ã›ã‚“ã§ã—ãŸã€‚å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            // ç·ãƒ¬ãƒ¼ã‚¹æ•°ã‚’è¨­å®š
            const maxRace = Math.max(...raceResults.map(r => r.race));
            document.getElementById('totalRaces').value = maxRace.toString();
            
            // ãƒ¬ãƒ¼ã‚¹ã‚«ãƒ¼ãƒ‰ç”Ÿæˆ
            document.getElementById('totalRaces').dispatchEvent(new Event('change'));
            
            // è§£æçµæœã‚’å„ãƒ•ã‚©ãƒ¼ãƒ ã«åæ˜ 
            setTimeout(() => {
                raceResults.forEach(result => {
                    const statusInput = document.getElementById(`status-${result.race}`);
                    const amountInput = document.getElementById(`amount-${result.race}`);
                    
                    if (statusInput && amountInput) {
                        toggleResult(result.race, result.status);
                        if (result.status === 'hit' && result.payout > 0) {
                            amountInput.value = result.payout;
                        }
                    }
                });

                alert(`è§£æå®Œäº†ï¼${raceResults.length}ãƒ¬ãƒ¼ã‚¹ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚`);
            }, 100);

        } catch (error) {
            console.error('è§£æã‚¨ãƒ©ãƒ¼:', error);
            alert('ãƒ‡ãƒ¼ã‚¿ã®è§£æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        }
    });

    // å…¨è§’æ•°å­—ã‚’åŠè§’ã«å¤‰æ›
    function convertToHalfWidth(str) {
        return str.replace(/[ï¼-ï¼™]/g, function(match) {
            return String.fromCharCode(match.charCodeAt(0) - 0xFEE0);
        });
    }

    // ã‚¯ãƒªã‚¢æ©Ÿèƒ½
    document.getElementById('clearBtn').addEventListener('click', function() {
        document.getElementById('bulkPaste').value = '';
        document.getElementById('raceGrid').innerHTML = '';
        document.getElementById('jsonOutput').textContent = 'ã“ã“ã«JSONãŒç”Ÿæˆã•ã‚Œã¾ã™...';
        
        // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
        document.getElementById('raceDate').value = '';
        document.getElementById('track').value = '';
        document.getElementById('totalRaces').value = '';
        
        alert('âœ… ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚');
    });

    // ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½ï¼ˆãƒ¬ãƒ¼ã‚¹çµæœç”¨ï¼‰
    document.getElementById('copyBtn').addEventListener('click', function() {
        const jsonText = document.getElementById('jsonOutput').textContent;
        navigator.clipboard.writeText(jsonText).then(() => {
            this.textContent = 'âœ… ã‚³ãƒ”ãƒ¼å®Œäº†!';
            setTimeout(() => {
                this.textContent = 'ğŸ“‹ JSONã‚’ã‚³ãƒ”ãƒ¼';
            }, 2000);
        });
    });

    // AIäºˆæƒ³JSONã‚³ãƒ”ãƒ¼æ©Ÿèƒ½
    function setupAICopyButton() {
        const aiCopyBtn = document.getElementById('aiCopyBtn');
        if (aiCopyBtn) {
            aiCopyBtn.addEventListener('click', function() {
                const jsonText = document.getElementById('jsonOutput').textContent;
                if (jsonText && jsonText !== 'ã“ã“ã«JSONãŒç”Ÿæˆã•ã‚Œã¾ã™...') {
                    navigator.clipboard.writeText(jsonText).then(() => {
                        this.textContent = 'âœ… AIäºˆæƒ³ã‚³ãƒ”ãƒ¼å®Œäº†!';
                        setTimeout(() => {
                            this.textContent = 'ğŸ¤– AIäºˆæƒ³JSONã‚³ãƒ”ãƒ¼';
                        }, 2000);
                    }).catch(err => {
                        console.error('ã‚³ãƒ”ãƒ¼å¤±æ•—:', err);
                        alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚');
                    });
                } else {
                    alert('ã‚³ãƒ”ãƒ¼ã§ãã‚‹JSONãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ã€ŒAIäºˆæƒ³JSONãƒ‡ãƒ¼ã‚¿ç”Ÿæˆã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚');
                }
            });
        }
    }

    // åˆæœŸåŒ–æ™‚ã«AIäºˆæƒ³ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³ã‚’è¨­å®š
    setupAICopyButton();

    // è§£ææ¸ˆã¿äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹å¤‰æ•°
    let parsedPredictionData = null;

    // AIäºˆæƒ³JSONç”Ÿæˆæ©Ÿèƒ½
    document.getElementById('generateAIPredictionBtn').addEventListener('click', function() {
        try {
            // ãƒ‡ãƒãƒƒã‚°: ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã‚’ç¢ºèª
            console.log('AIäºˆæƒ³JSONãƒ‡ãƒ¼ã‚¿ç”Ÿæˆãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
            
            // ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ã®å­˜åœ¨ç¢ºèª
            const elements = {
                aiRaceTitle: document.getElementById('aiRaceTitle'),
                aiConfidence: document.getElementById('aiConfidence'),
                aiAbilityIndex: document.getElementById('aiAbilityIndex'),
                aiRecommendation: document.getElementById('aiRecommendation'),
                aiExpectedReturn: document.getElementById('aiExpectedReturn'),
                mainHorseNumber: document.getElementById('mainHorseNumber'),
                mainHorseName: document.getElementById('mainHorseName'),
                mainHorseConfidence: document.getElementById('mainHorseConfidence'),
                previewSummary: document.getElementById('previewSummary'),
                previewFeatures: document.getElementById('previewFeatures'),
                previewRisk: document.getElementById('previewRisk')
            };

            // è¦ç´ ã®å­˜åœ¨ç¢ºèª
            for (const [key, element] of Object.entries(elements)) {
                if (!element) {
                    throw new Error(`è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${key}`);
                }
            }

            // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿å–å¾—
            const raceTitle = elements.aiRaceTitle.value;
            const confidence = parseFloat(elements.aiConfidence.value);
            const abilityIndex = parseFloat(elements.aiAbilityIndex.value);
            const recommendation = elements.aiRecommendation.value;
            const expectedReturn = parseInt(elements.aiExpectedReturn.value);
            
            const mainHorseNumber = parseInt(elements.mainHorseNumber.value);
            const mainHorseName = elements.mainHorseName.value;
            const mainHorseConfidence = parseFloat(elements.mainHorseConfidence.value);
            
            const previewSummary = elements.previewSummary.value;
            const previewFeatures = elements.previewFeatures.value;
            const previewRisk = elements.previewRisk.value;

            // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            if (!raceTitle || isNaN(confidence) || isNaN(abilityIndex) || !mainHorseName) {
                alert('âŒ å¿…é ˆé …ç›®ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\n\nç¢ºèªã—ã¦ãã ã•ã„:\nãƒ»ãƒ¬ãƒ¼ã‚¹å\nãƒ»äºˆæ¸¬ä¿¡é ¼åº¦\nãƒ»èƒ½åŠ›æŒ‡æ•°\nãƒ»æœ¬å‘½é¦¬å');
                return;
            }

        // ç¾åœ¨ã®æ—¥æ™‚ã‚’å–å¾—
        const now = new Date();
        const currentTime = now.toISOString();

        // ãƒ‡ãƒãƒƒã‚°: è§£æãƒ‡ãƒ¼ã‚¿ã®çŠ¶æ…‹ç¢ºèª
        console.log('AIäºˆæƒ³JSONç”Ÿæˆæ™‚ã®è§£æãƒ‡ãƒ¼ã‚¿:', parsedPredictionData);
        if (parsedPredictionData) {
            console.log('æœ¬å‘½é¦¬:', parsedPredictionData.mainHorse);
            console.log('å¯¾æŠ—é¦¬:', parsedPredictionData.subHorse);
            console.log('å˜ç©´é¦¬:', parsedPredictionData.darkHorse);
            console.log(`å…¨å‡ºèµ°é¦¬(${parsedPredictionData.totalHorses}é ­):`, parsedPredictionData.allHorses.map(h => `${h.mark}${h.number}${h.name}`).join(', '));
        }

        // æ—¥ä»˜ã‚’å–å¾—ï¼ˆå¤–éƒ¨äºˆæƒ³å¤‰æ›ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°ä½¿ç”¨ï¼‰
        const aiRaceTitleElement = document.getElementById('aiRaceTitle');
        const storedRaceDate = aiRaceTitleElement.dataset.raceDate;
        const storedTrackName = aiRaceTitleElement.dataset.trackName || raceTitle.split(/[0-9]/)[0] || "èˆ¹æ©‹";
        const storedRaceNumber = aiRaceTitleElement.dataset.raceNumber || (raceTitle.match(/[0-9]+R/) ? raceTitle.match(/[0-9]+R/)[0] : "2R");
        const storedRaceName = aiRaceTitleElement.dataset.raceName || raceTitle.replace(/^.*?[0-9]+R\s*/, '') || "C3é¸æŠœ 1200m";
        
        // æ—¥ä»˜ã‚’YYYY-MM-DDå½¢å¼ã«å¤‰æ›
        let formattedDate = now.toISOString().split('T')[0]; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ä»Šæ—¥
        if (storedRaceDate) {
            const dateParts = storedRaceDate.split('/');
            if (dateParts.length === 2) {
                const currentYear = now.getFullYear();
                const month = dateParts[0].padStart(2, '0');
                const day = dateParts[1].padStart(2, '0');
                formattedDate = `${currentYear}-${month}-${day}`;
            }
        }
        
        // JSONãƒ‡ãƒ¼ã‚¿æ§‹ç¯‰
        const aiPredictionData = {
            raceInfo: {
                title: raceTitle,
                date: formattedDate, // å®Ÿéš›ã®ãƒ¬ãƒ¼ã‚¹æ—¥ä»˜ã‚’ä½¿ç”¨
                track: storedTrackName,
                raceNumber: storedRaceNumber,
                raceName: storedRaceName,
                confidence: confidence.toString(),
                abilityIndex: abilityIndex.toString(),
                recommendation: recommendation,
                expectedReturn: expectedReturn.toString()
            },
            horses: {
                main: {
                    number: mainHorseNumber,
                    name: mainHorseName,
                    type: "æœ¬å‘½",
                    confidence: mainHorseConfidence.toString(),
                    factors: [
                        { icon: "â—", text: `èƒ½åŠ›æŒ‡æ•°: ${abilityIndex} (1ä½)` },
                        { icon: "â—", text: `å®‰å®šæ€§ã‚¹ã‚³ã‚¢: ${mainHorseConfidence}%` },
                        { icon: "â—", text: "å±•é–‹é©æ€§: Sè©•ä¾¡" },
                        { icon: "â—", text: "éå»5èµ°åå·®å€¤: 62.3" }
                    ],
                    importance: [
                        { label: document.getElementById('mainFeature1Label').value || "å®‰å®šæ€§", value: parseFloat(document.getElementById('mainFeature1Val').value) || 0.95 },
                        { label: document.getElementById('mainFeature2Label').value || "èƒ½åŠ›ä¸Šä½æ€§", value: parseFloat(document.getElementById('mainFeature2Val').value) || 0.88 },
                        { label: document.getElementById('mainFeature3Label').value || "å±•é–‹åˆ©", value: parseFloat(document.getElementById('mainFeature3Val').value) || 0.82 }
                    ]
                },
                sub: parsedPredictionData && parsedPredictionData.subHorse ? {
                    number: parsedPredictionData.subHorse.number,
                    name: parsedPredictionData.subHorse.name,
                    type: "å¯¾æŠ—",
                    confidence: parsedPredictionData.subHorse.confidence,
                    factors: [
                        { icon: "â—‹", text: `ã‚¹ãƒ”ãƒ¼ãƒ‰æŒ‡æ•°: ${(Math.random() * 10 + 75).toFixed(1)}` },
                        { icon: "â—‹", text: `å…ˆè¡ŒåŠ›: ${(Math.random() * 15 + 80).toFixed(1)}%` },
                        { icon: "â—‹", text: "æ é †å„ªä½æ€§: Aç´š" },
                        { icon: "â—‹", text: "æŒç¶šåŠ›è©•ä¾¡: B" }
                    ],
                    importance: [
                        { label: document.getElementById('subFeature1Label').value || "å…ˆè¡ŒåŠ›", value: parseFloat(document.getElementById('subFeature1Val').value) || 0.96 },
                        { label: document.getElementById('subFeature2Label').value || "ã‚¹ãƒ”ãƒ¼ãƒ‰æŒ‡æ•°", value: parseFloat(document.getElementById('subFeature2Val').value) || 0.85 },
                        { label: document.getElementById('subFeature3Label').value || "æ é †å„ªä½", value: parseFloat(document.getElementById('subFeature3Val').value) || 0.79 }
                    ]
                } : {
                    number: mainHorseNumber === 11 ? 6 : 11,
                    name: "ãƒãƒ´ã‚§ãƒƒãƒ©",
                    type: "å¯¾æŠ—",
                    confidence: "86.7",
                    factors: [
                        { icon: "â—‹", text: "ã‚¹ãƒ”ãƒ¼ãƒ‰æŒ‡æ•°: 78.4" },
                        { icon: "â—‹", text: "å…ˆè¡ŒåŠ›: 82.3%" },
                        { icon: "â—‹", text: "æ é †å„ªä½æ€§: Aç´š" },
                        { icon: "â—‹", text: "æŒç¶šåŠ›è©•ä¾¡: B" }
                    ],
                    importance: [
                        { label: document.getElementById('subFeature1Label').value || "å…ˆè¡ŒåŠ›", value: parseFloat(document.getElementById('subFeature1Val').value) || 0.96 },
                        { label: document.getElementById('subFeature2Label').value || "ã‚¹ãƒ”ãƒ¼ãƒ‰æŒ‡æ•°", value: parseFloat(document.getElementById('subFeature2Val').value) || 0.85 },
                        { label: document.getElementById('subFeature3Label').value || "æ é †å„ªä½", value: parseFloat(document.getElementById('subFeature3Val').value) || 0.79 }
                    ]
                },
                dark: parsedPredictionData && parsedPredictionData.darkHorse ? {
                    number: parsedPredictionData.darkHorse.number,
                    name: parsedPredictionData.darkHorse.name,
                    type: "å˜ç©´",
                    confidence: parsedPredictionData.darkHorse.confidence,
                    factors: [
                        { icon: "â–²", text: `çˆ†ç™ºåŠ›æŒ‡æ•°: ${(Math.random() * 10 + 85).toFixed(1)}` },
                        { icon: "â–²", text: "ãƒ ãƒ©ä¿‚æ•°: é«˜å¤‰å‹•" },
                        { icon: "â–²", text: `æ–¤é‡å„ªä½: +${Math.floor(Math.random() * 3 + 1)}kg` },
                        { icon: "â–²", text: "å±•é–‹æ¬¡ç¬¬: è¦æ³¨æ„" }
                    ]
                } : {
                    number: mainHorseNumber === 3 ? 8 : 3,
                    name: "ãƒœãƒ³ãƒ–ãƒ¼ãƒªãƒ¼ãƒ—",
                    type: "å˜ç©´",
                    confidence: "72.1",
                    factors: [
                        { icon: "â–²", text: "çˆ†ç™ºåŠ›æŒ‡æ•°: 91.2" },
                        { icon: "â–²", text: "ãƒ ãƒ©ä¿‚æ•°: é«˜å¤‰å‹•" },
                        { icon: "â–²", text: "æ–¤é‡å„ªä½: +2kg" },
                        { icon: "â–²", text: "å±•é–‹æ¬¡ç¬¬: è¦æ³¨æ„" }
                    ]
                }
            },
            strategies: (() => {
                // å®Ÿéš›ã®é¦¬ç•ªã‚’å–å¾—
                const subNum = (parsedPredictionData && parsedPredictionData.subHorse) ? parsedPredictionData.subHorse.number : (mainHorseNumber === 11 ? 6 : 11);
                const darkNum = (parsedPredictionData && parsedPredictionData.darkHorse) ? parsedPredictionData.darkHorse.number : (mainHorseNumber === 3 ? 8 : 3);
                
                // é€£ä¸‹é¦¬ï¼ˆâ–³å°ã®é¦¬ï¼‰ã‚’å–å¾—
                const underHorses = parsedPredictionData && parsedPredictionData.allHorses ? 
                    parsedPredictionData.allHorses.filter(h => h.mark === 'â–³').map(h => h.number) : [];
                const underStr = underHorses.length > 0 ? underHorses.join(',') : '2,3';
                
                return {
                    safe: {
                        title: "æˆ¦ç•¥A: é«˜çš„ä¸­ç‡å‹",
                        recommendation: 5,
                        hitRate: "78.5",
                        returnRate: "132",
                        bets: [
                            { type: "é¦¬é€£", horses: `${mainHorseNumber} - ${subNum},${darkNum}`, points: "2ç‚¹" },
                            { type: "ãƒ¯ã‚¤ãƒ‰", horses: `${mainHorseNumber} - ${subNum},${darkNum},${underStr}`, points: `${2 + underHorses.length}ç‚¹` },
                            { type: "3é€£è¤‡", horses: `${mainHorseNumber}-${subNum},${darkNum} + é€£ä¸‹${underStr}`, points: `${4 + Math.min(underHorses.length, 2)}ç‚¹` }
                        ],
                        expectedPayout: "5-8å€",
                        payoutType: "å …å®Ÿæ±ºç€æƒ³å®š"
                    },
                    balance: {
                        title: "æˆ¦ç•¥B: ãƒãƒ©ãƒ³ã‚¹å‹",
                        recommendation: 3,
                        hitRate: "65.2",
                        returnRate: "148",
                        bets: [
                            { type: "é¦¬é€£", horses: `${mainHorseNumber} - ${subNum},${darkNum},${underStr}`, points: `${2 + underHorses.length}ç‚¹` },
                            { type: "ãƒ¯ã‚¤ãƒ‰", horses: `${mainHorseNumber} - ${subNum},${darkNum},${underStr}`, points: `${3 + underHorses.length}ç‚¹` },
                            { type: "3é€£è¤‡", horses: `${mainHorseNumber}-${subNum},${darkNum} - ${underStr},4,6,7`, points: `${Math.max(12, 8 + underHorses.length * 2)}ç‚¹` }
                        ],
                        expectedPayout: "8-15å€",
                        payoutType: "ä¸­ç©´é…å½“æƒ³å®š"
                    },
                    aggressive: {
                        title: "æˆ¦ç•¥C: é«˜é…å½“è¿½æ±‚å‹",
                        recommendation: 2,
                        hitRate: "42.8",
                        returnRate: "215",
                        bets: [
                            { type: "3é€£è¤‡", horses: `${darkNum}-${subNum},${mainHorseNumber} - ${underStr},4,6,7`, points: `${Math.max(15, 12 + underHorses.length * 2)}ç‚¹` },
                            { type: "é¦¬é€£", horses: `${darkNum} - ${mainHorseNumber},${subNum},${underStr}`, points: `${3 + underHorses.length}ç‚¹` },
                            { type: "ãƒ¯ã‚¤ãƒ‰", horses: `é€£ä¸‹${underStr} - ${mainHorseNumber},${subNum},${darkNum}`, points: `${Math.min(8, 3 + underHorses.length * 2)}ç‚¹` }
                        ],
                        expectedPayout: "20å€ä»¥ä¸Š",
                        payoutType: "å¤§ç©´è¦–é‡"
                    }
                };
            })(),
            analysis: {
                raceExpected: `XGBoostãƒ¢ãƒ‡ãƒ«: â—${mainHorseNumber}${mainHorseName}ã®å®‰å®šæ€§ã‚’æœ€é«˜è©•ä¾¡ï¼ˆã‚¹ã‚³ã‚¢${mainHorseConfidence}ï¼‰`,
                keyIndicators: {
                    accuracy: "87.3",
                    similarRaces: "42ä»¶", 
                    confidenceInterval: "Â±3.2",
                    recommendedInvestment: "è³‡é‡‘ã®3-5%"
                }
            },
            preview: {
                summary: previewSummary,
                features: previewFeatures,
                riskAnalysis: previewRisk
            },
            allHorses: parsedPredictionData && parsedPredictionData.allHorses ? 
                parsedPredictionData.allHorses.map(horse => ({
                    number: horse.number,
                    name: horse.name,
                    mark: horse.mark,
                    confidence: horse.confidence,
                    type: horse.mark === 'â—' ? 'æœ¬å‘½' : 
                          horse.mark === 'â—‹' || horse.mark === 'â—¯' ? 'å¯¾æŠ—' : 
                          horse.mark === 'â–²' ? 'å˜ç©´' : 
                          horse.mark === 'â–³' ? 'é€£ä¸‹' : 'æŠ¼ã•ãˆ',
                    factors: [
                        { icon: horse.mark, text: `ä¿¡é ¼åº¦: ${horse.confidence}%` },
                        { icon: horse.mark, text: horse.mark === 'â—' ? "æœ¬å‘½é©æ€§: Sç´š" : 
                                                 horse.mark === 'â—‹' || horse.mark === 'â—¯' ? "å¯¾æŠ—é©æ€§: Aç´š" :
                                                 horse.mark === 'â–²' ? "ç©´é©æ€§: Bç´š" : "è£œå®Œé©æ€§: Cç´š" },
                        { icon: horse.mark, text: `å±•é–‹è©•ä¾¡: ${Math.floor(Math.random() * 3) + 1}ç•ªæ‰‹æƒ³å®š` }
                    ]
                })) : [],
            totalHorses: parsedPredictionData ? parsedPredictionData.totalHorses || 3 : 3,
            lastUpdated: currentTime
        };

        // JSONè¡¨ç¤º
        const jsonOutput = document.getElementById('jsonOutput');
        jsonOutput.textContent = JSON.stringify(aiPredictionData, null, 2);

        // èª¬æ˜æ–‡æ›´æ–°
        const outputDescription = document.getElementById('outputDescription');
        outputDescription.innerHTML = 'ä¸‹è¨˜ã®JSONã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ <code>src/data/aiPrediction.json</code> ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚<br>ã“ã‚Œã«ã‚ˆã‚Š<strong>free-prediction/</strong>ãƒšãƒ¼ã‚¸ã¨<strong>ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</strong>ãŒè‡ªå‹•æ›´æ–°ã•ã‚Œã¾ã™ã€‚';

        // AIäºˆæƒ³JSONã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³ã®è¡¨ç¤º/æœ‰åŠ¹åŒ–
        const aiCopyBtn = document.getElementById('aiCopyBtn');
        if (aiCopyBtn) {
            aiCopyBtn.style.display = 'block';
            console.log('AIäºˆæƒ³JSONã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–ã—ã¾ã—ãŸ');
        }

        // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        alert('âœ… AIäºˆæƒ³JSONãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¾ã—ãŸï¼\n\nğŸ“‹ ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³ã§å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦\nsrc/data/aiPrediction.json ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚');
        
        } catch (error) {
            console.error('AIäºˆæƒ³JSONç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
            alert('âŒ JSONç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n\nè©³ç´°: ' + error.message + '\n\nãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        }
    });

    // å¤–éƒ¨äºˆæƒ³å¤‰æ›æ©Ÿèƒ½
    document.getElementById('convertPredictionBtn').addEventListener('click', function() {
        const externalText = document.getElementById('externalPrediction').value;
        if (!externalText.trim()) {
            alert('å¤‰æ›ã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            return;
        }

        try {
            console.log('=== å¤–éƒ¨äºˆæƒ³å¤‰æ›é–‹å§‹ ===');
            console.log('å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆ:', externalText);
            
            // ãƒ‡ãƒãƒƒã‚°: æ–‡å­—ã‚³ãƒ¼ãƒ‰ã‚’è©³ç´°ã«ç¢ºèª
            const testLine = 'â—‹ï¼‘ã‚¢ãƒ ãƒ¼ãƒ«ãƒ”ã‚¹ã‚±ã‚¹';
            console.log('ãƒ†ã‚¹ãƒˆè¡Œã®æ–‡å­—ã‚³ãƒ¼ãƒ‰è§£æ:');
            for (let i = 0; i < testLine.length; i++) {
                const char = testLine[i];
                const code = char.charCodeAt(0);
                console.log(`${i}: "${char}" (U+${code.toString(16).toUpperCase().padStart(4, '0')})`);
            }
            
            // å®Ÿéš›ã®å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆã®å„è¡Œã‚’åˆ†æ
            const lines = externalText.split('\n').map(line => line.trim()).filter(line => line);
            console.log('å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆã®è¡Œåˆ†æ:');
            lines.forEach((line, index) => {
                console.log(`è¡Œ${index + 1}: "${line}"`);
                if (line.includes('ã‚¢ãƒ ãƒ¼ãƒ«')) {
                    console.log('  â†’ ã‚¢ãƒ ãƒ¼ãƒ«ã‚’å«ã‚€è¡Œã‚’ç™ºè¦‹!');
                    for (let i = 0; i < Math.min(line.length, 10); i++) {
                        const char = line[i];
                        const code = char.charCodeAt(0);
                        console.log(`  ${i}: "${char}" (U+${code.toString(16).toUpperCase().padStart(4, '0')})`);
                    }
                }
            });
            
            // ãƒ†ã‚­ã‚¹ãƒˆè§£æ
            const parsedData = parseExternalPrediction(externalText);
            
            // è§£æãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ï¼ˆAIäºˆæƒ³JSONç”Ÿæˆæ™‚ã«ä½¿ç”¨ï¼‰
            parsedPredictionData = parsedData;
            console.log('è§£æãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜:', parsedPredictionData);
            
            // AIäºˆæƒ³ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã«è‡ªå‹•å…¥åŠ›
            document.getElementById('aiRaceTitle').value = parsedData.raceTitle;
            document.getElementById('aiConfidence').value = parsedData.confidence;
            document.getElementById('aiAbilityIndex').value = parsedData.abilityIndex;
            document.getElementById('aiRecommendation').value = parsedData.recommendation;
            document.getElementById('aiExpectedReturn').value = parsedData.expectedReturn;
            
            // ãƒ¬ãƒ¼ã‚¹æ—¥ä»˜ã‚’ä¿å­˜ï¼ˆJSONç”Ÿæˆæ™‚ã«ä½¿ç”¨ï¼‰
            if (parsedData.raceDate) {
                document.getElementById('aiRaceTitle').dataset.raceDate = parsedData.raceDate;
                document.getElementById('aiRaceTitle').dataset.trackName = parsedData.trackName;
                document.getElementById('aiRaceTitle').dataset.raceNumber = parsedData.raceNumber;
                document.getElementById('aiRaceTitle').dataset.raceName = parsedData.raceName;
            }
            
            document.getElementById('mainHorseNumber').value = parsedData.mainHorse.number;
            document.getElementById('mainHorseName').value = parsedData.mainHorse.name;
            document.getElementById('mainHorseConfidence').value = parsedData.mainHorse.confidence;
            
            document.getElementById('previewSummary').value = parsedData.previewSummary;
            document.getElementById('previewFeatures').value = parsedData.previewFeatures;
            document.getElementById('previewRisk').value = parsedData.previewRisk;

            alert(`âœ… å¤‰æ›å®Œäº†ï¼\n\nAIäºˆæƒ³ç·¨é›†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«è‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã—ãŸã€‚\nè§£æã—ãŸå‡ºèµ°é¦¬: ${parsedData.totalHorses}é ­\nã€ŒAIäºˆæƒ³JSONãƒ‡ãƒ¼ã‚¿ç”Ÿæˆã€ã§å…¨é¦¬æƒ…å ±ãŒæ­£ã—ãåæ˜ ã•ã‚Œã¾ã™ã€‚\n\næ¤œå‡ºã—ãŸé¦¬:\n${parsedData.allHorses.map(h => `${h.mark}${h.number}${h.name}`).slice(0, 8).join('\n')}${parsedData.allHorses.length > 8 ? '\n...' : ''}`);
            
        } catch (error) {
            console.error('å¤‰æ›ã‚¨ãƒ©ãƒ¼è©³ç´°:', error);
            console.error('ã‚¨ãƒ©ãƒ¼ã‚¹ã‚¿ãƒƒã‚¯:', error.stack);
            alert('ãƒ†ã‚­ã‚¹ãƒˆã®è§£æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n\nè©³ç´°: ' + error.message + '\n\nã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        }
    });

    // å¤–éƒ¨äºˆæƒ³ãƒ†ã‚­ã‚¹ãƒˆè§£æé–¢æ•°
    function parseExternalPrediction(text) {
        const lines = text.split('\n').map(line => line.trim()).filter(line => line);
        
        // ãƒ¬ãƒ¼ã‚¹æƒ…å ±æŠ½å‡ºã‚’æ®µéšçš„ã«å®Ÿè¡Œ
        console.log('ãƒ¬ãƒ¼ã‚¹æƒ…å ±æŠ½å‡ºé–‹å§‹');
        console.log('å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆï¼ˆå…ˆé ­200æ–‡å­—ï¼‰:', text.substring(0, 200));
        
        // æ—¥ä»˜æŠ½å‡º
        const dateMatch = text.match(/(\d+\/\d+)/);
        const raceDate = dateMatch ? dateMatch[1] : null;
        console.log('æ—¥ä»˜æŠ½å‡ºçµæœ:', raceDate);
        
        // ç«¶é¦¬å ´æŠ½å‡ºï¼ˆè¤‡æ•°ãƒ‘ã‚¿ãƒ¼ãƒ³ã§è©¦è¡Œï¼‰
        const trackPatterns = [
            /(\d+\/\d+)([^ç«¶é¦¬\n]*?)ç«¶é¦¬/,
            /([æµ¦å’Œ|å·å´|å¤§äº•|èˆ¹æ©‹])ç«¶é¦¬/,
            /(\d+\/\d+)\s*([^\n]*?)ç«¶é¦¬/
        ];
        
        let trackName = 'ãƒ¬ãƒ¼ã‚¹æƒ…å ±æœªæ¤œå‡º';
        let trackMatch = null;
        
        for (const pattern of trackPatterns) {
            trackMatch = text.match(pattern);
            if (trackMatch) {
                trackName = trackMatch.length > 2 ? trackMatch[2].trim() + 'ç«¶é¦¬' : trackMatch[1] + 'ç«¶é¦¬';
                console.log('ç«¶é¦¬å ´æŠ½å‡ºæˆåŠŸ:', trackName, 'ãƒ‘ã‚¿ãƒ¼ãƒ³:', pattern);
                break;
            }
        }
        console.log('ç«¶é¦¬å ´æŠ½å‡ºçµæœ:', trackName);
        
        // ãƒ¬ãƒ¼ã‚¹ç•ªå·ã¨ãƒ¬ãƒ¼ã‚¹åæŠ½å‡º
        const racePatterns = [
            /([ï¼-ï¼™0-9ï¼‘-ï¼™]+)[ï¼²Rr]\s*([^\n]*?)(?:ï¼ˆ|$)/,
            /([ï¼-ï¼™0-9ï¼‘-ï¼™]+)[ï¼²Rr]\s*([^\n]*)/,
            /([ï¼-ï¼™0-9ï¼‘-ï¼™]+)[ï¼²Rr]/
        ];
        
        let raceNumber = '2R';
        let raceName = 'ãƒ¬ãƒ¼ã‚¹æƒ…å ±æœªæ¤œå‡º';
        let raceMatch = null;
        
        for (const pattern of racePatterns) {
            raceMatch = text.match(pattern);
            if (raceMatch) {
                raceNumber = convertToHalfWidth(raceMatch[1]) + 'R';
                raceName = raceMatch.length > 2 ? raceMatch[2].trim() : 'ãƒ¬ãƒ¼ã‚¹æƒ…å ±æœªæ¤œå‡º';
                console.log('ãƒ¬ãƒ¼ã‚¹æƒ…å ±æŠ½å‡ºæˆåŠŸ:', raceNumber, raceName, 'ãƒ‘ã‚¿ãƒ¼ãƒ³:', pattern);
                break;
            }
        }
        console.log('ãƒ¬ãƒ¼ã‚¹ç•ªå·:', raceNumber, 'ãƒ¬ãƒ¼ã‚¹å:', raceName);
        
        // ã‚¿ã‚¤ãƒˆãƒ«ç”Ÿæˆ
        const raceTitle = (trackName !== 'ãƒ¬ãƒ¼ã‚¹æƒ…å ±æœªæ¤œå‡º') ? 
            `${trackName.replace('ç«¶é¦¬', '')}${raceNumber} ${raceName}` : 
            "ãƒ¬ãƒ¼ã‚¹æƒ…å ±æœªæ¤œå‡º";
        console.log('ç”Ÿæˆã•ã‚ŒãŸãƒ¬ãƒ¼ã‚¹ã‚¿ã‚¤ãƒˆãƒ«:', raceTitle);

        // æœ¬å‘½äºˆæƒ³æŠ½å‡º
        const horses = [];
        let inPredictionSection = false;
        let currentHorse = null;
        let analysisStarted = false;
        
        // ãƒ†ã‚¹ãƒˆç”¨: å˜ä¸€è¡Œã®å ´åˆã¯äºˆæƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¨ã—ã¦æ‰±ã†ï¼ˆä¸¡æ–¹ã®â—‹æ–‡å­—ã«å¯¾å¿œï¼‰
        if (lines.length === 1 && /^[â—â—‹â—¯â–²â–³Ã—]/.test(lines[0])) {
            inPredictionSection = true;
            console.log('å˜ä¸€è¡Œã®é¦¬ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œå‡º: äºˆæƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¨ã—ã¦å‡¦ç†ã—ã¾ã™');
        }

        for (let i = 0; i < lines.length; i++) {
            const line = lines[i];
            
            if (line.includes('æœ¬å‘½äºˆæƒ³') || line.includes('äºˆæƒ³') || line.includes('å°')) {
                inPredictionSection = true;
                console.log('äºˆæƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹:', line);
                continue;
            }
            
            if (line.includes('AIåˆ†æç†ç”±') || line.includes('åˆ†æç†ç”±')) {
                inPredictionSection = false;
                analysisStarted = true;
                console.log('åˆ†æã‚»ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹:', line);
                continue;
            }
            
            // ã€ŒæŠ‘ãˆã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«å…¥ã£ãŸå ´åˆã¯ç¶™ç¶šã—ã¦é¦¬ã‚’æ¤œå‡º
            if (line.includes('æŠ‘ãˆ')) {
                console.log('æŠ‘ãˆã‚»ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹:', line);
                // inPredictionSectionã¯ç¶™ç¶š
                continue;
            }
            
            // æœ¬å½“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³çµ‚äº†æ¡ä»¶
            if (line.includes('AIåˆ†æç†ç”±') || line.includes('åˆ†æçµ‚äº†') || line.includes('ä¸è¦')) {
                inPredictionSection = false;
                analysisStarted = false;
                console.log('ã‚»ã‚¯ã‚·ãƒ§ãƒ³çµ‚äº†:', line);
                continue;
            }
            
            console.log(`è¡Œå‡¦ç†çŠ¶æ³: inPredictionSection=${inPredictionSection}, analysisStarted=${analysisStarted}, line="${line}"`);
            
            if (inPredictionSection) {
                // ãƒ‡ãƒãƒƒã‚°: ç¾åœ¨å‡¦ç†ä¸­ã®è¡Œã‚’ãƒ­ã‚°å‡ºåŠ›
                console.log('äºˆæƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†ä¸­ã®è¡Œ:', line);
                
                // ã‚ˆã‚ŠæŸ”è»Ÿãªãƒ‘ã‚¿ãƒ¼ãƒ³ã§é¦¬ã‚’æ¤œå‡º
                console.log(`è¡Œã®æ–‡å­—ã‚³ãƒ¼ãƒ‰åˆ†æ: "${line}"`);
                
                // è¤‡æ•°ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã§æ®µéšçš„ã«ãƒ†ã‚¹ãƒˆ
                const patterns = [
                    // ãƒ‘ã‚¿ãƒ¼ãƒ³1: åŸºæœ¬ï¼ˆä¸¡æ–¹ã®â—‹æ–‡å­—ã«å¯¾å¿œï¼‰
                    /^([â—â—‹â—¯â–²â–³Ã—])([ï¼-ï¼™0-9]+)([^\r\n]+)$/,
                    // ãƒ‘ã‚¿ãƒ¼ãƒ³2: ã‚ˆã‚ŠæŸ”è»Ÿï¼ˆç©ºç™½ã‚’è¨±å¯ï¼‰
                    /^([â—â—‹â—¯â–²â–³Ã—])\s*([ï¼-ï¼™0-9]+)\s*([^\r\n]+)$/,
                    // ãƒ‘ã‚¿ãƒ¼ãƒ³3: Unicodeç¯„å›²ã‚’æ˜ç¤ºï¼ˆä¸¡æ–¹ã®â—‹æ–‡å­—ï¼‰
                    /^([\u25CE\u25CB\u25EF\u25B2\u25B3\u00D7])([ï¼-ï¼™0-9]+)([^\r\n]+)$/,
                    // ãƒ‘ã‚¿ãƒ¼ãƒ³4: æœ€ã‚‚åºƒç¯„å›²
                    /([â—â—‹â—¯â–²â–³Ã—])([ï¼-ï¼™0-9]+)(.+)/
                ];
                
                let matched = false;
                
                for (let i = 0; i < patterns.length; i++) {
                    const pattern = patterns[i];
                    const horseMatch = line.match(pattern);
                    
                    if (horseMatch) {
                        const mark = horseMatch[1];
                        const number = parseInt(convertToHalfWidth(horseMatch[2]));
                        const name = horseMatch[3].trim();
                        
                        console.log(`ãƒ‘ã‚¿ãƒ¼ãƒ³${i + 1}ã§é¦¬ã‚’æ¤œå‡º: ${mark}${number}${name}`);
                        
                        horses.push({
                            mark: mark,
                            number: number,
                            name: name,
                            confidence: getConfidenceFromMark(mark),
                            analysis: ""
                        });
                        
                        matched = true;
                        break;
                    }
                }
                
                if (!matched) {
                    console.log(`âŒ ã“ã®è¡Œã¯ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ãƒãƒƒãƒã—ã¾ã›ã‚“ã§ã—ãŸ: "${line}"`);
                    console.log(`æ–‡å­—ã‚³ãƒ¼ãƒ‰è©³ç´°:`, Array.from(line).map(char => `${char}(U+${char.charCodeAt(0).toString(16).toUpperCase()})`));
                } else {
                    console.log(`âœ… é¦¬ã‚’æ­£å¸¸ã«æ¤œå‡º: ${line}`);
                }
            }
            
            if (analysisStarted && currentHorse) {
                // ç¾åœ¨ã®é¦¬ã®åˆ†æã«è¿½åŠ 
                currentHorse.analysis += line + " ";
            }
            
            if (analysisStarted) {
                // æ–°ã—ã„é¦¬ã®åˆ†æé–‹å§‹ã‚’æ¤œå‡º
                const analysisHorseMatch = line.match(/([ï¼-ï¼™0-9]+)([^\s]+)/);
                if (analysisHorseMatch) {
                    const number = parseInt(convertToHalfWidth(analysisHorseMatch[1]));
                    const name = analysisHorseMatch[2];
                    
                    // å¯¾å¿œã™ã‚‹é¦¬ã‚’æ¢ã™
                    currentHorse = horses.find(h => h.number === number && h.name === name);
                    if (currentHorse) {
                        currentHorse.analysis = "";
                    }
                }
            }
        }

        console.log(`è§£æçµæœ: ${horses.length}é ­ã®é¦¬ã‚’æ¤œå‡º`);
        console.log('æ¤œå‡ºã—ãŸé¦¬ä¸€è¦§:', horses.map(h => `${h.mark}${h.number}${h.name}`));
        console.log('å°åˆ¥ã®å†…è¨³:');
        console.log('- æœ¬å‘½(â—):', horses.filter(h => h.mark === 'â—').map(h => `${h.number}${h.name}`));
        console.log('- å¯¾æŠ—(â—‹â—¯):', horses.filter(h => h.mark === 'â—‹' || h.mark === 'â—¯').map(h => `${h.number}${h.name}`));  
        console.log('- å˜ç©´(â–²):', horses.filter(h => h.mark === 'â–²').map(h => `${h.number}${h.name}`));
        console.log('- é€£ä¸‹(â–³):', horses.filter(h => h.mark === 'â–³').map(h => `${h.number}${h.name}`));
        console.log('- æŠ‘ãˆ(Ã—):', horses.filter(h => h.mark === 'Ã—').map(h => `${h.number}${h.name}`));
        
        if (horses.length === 0) {
            console.error('é¦¬ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ‡ãƒãƒƒã‚°æƒ…å ±:');
            console.error('- inPredictionSection ãƒ•ãƒ©ã‚°ã®æœ€çµ‚çŠ¶æ…‹:', inPredictionSection);
            console.error('- å‡¦ç†ã—ãŸè¡Œæ•°:', lines.length);
            console.error('- å„è¡Œã®å†…å®¹:', lines);
            throw new Error('é¦¬åˆ¸å¯¾è±¡é¦¬ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚â—â—‹â–²â–³ã®å°ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚');
        }

        // å„å°ã®é¦¬ã‚’å–å¾—ï¼ˆä¸¡æ–¹ã®â—‹æ–‡å­—ã«å¯¾å¿œï¼‰
        const mainHorse = horses.find(h => h.mark === 'â—') || horses[0];
        const subHorse = horses.find(h => h.mark === 'â—‹' || h.mark === 'â—¯') || horses[1] || { number: 6, name: "ãƒãƒ´ã‚§ãƒƒãƒ©", mark: "â—‹", confidence: "86.7" };
        const darkHorse = horses.find(h => h.mark === 'â–²') || horses[2] || { number: 3, name: "ãƒœãƒ³ãƒ–ãƒ¼ãƒªãƒ¼ãƒ—", mark: "â–²", confidence: "72.1" };
        
        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æƒ…å ±ç”Ÿæˆ
        const horseNames = horses.slice(0, Math.min(5, horses.length)).map(h => `${h.number}ç•ª${h.name}`).join('ã€');
        const previewSummary = `æ¨å¥¨æŠ•è³‡æˆ¦ç•¥: ${mainHorse.name}ã‚’ä¸­å¿ƒã¨ã—ãŸé¦¬é€£ãƒ»3é€£è¤‡ã€æœŸå¾…å€¤+${(Math.random() * 20 + 10).toFixed(1)}%`;
        const previewFeatures = `ç‰¹å¾´é‡é‡è¦åº¦: è¿‘èµ°æˆç¸¾(0.${Math.floor(Math.random() * 20 + 80)})ã€è¡€çµ±é©æ€§(0.${Math.floor(Math.random() * 20 + 70)})ã€é¨æ‰‹å®Ÿç¸¾(0.${Math.floor(Math.random() * 20 + 60)})`;
        
        console.log(`è§£æå®Œäº†: ${horses.length}é ­ã®é¦¬ã‚’æ¤œå‡º:`, horses.map(h => `${h.mark}${h.number}${h.name}`).join(', '));
        
        return {
            raceTitle: raceTitle,
            raceDate: raceDate,
            trackName: trackName,
            raceNumber: raceNumber,
            raceName: raceName,
            confidence: mainHorse.confidence,
            abilityIndex: (Math.random() * 10 + 80).toFixed(1),
            recommendation: mainHorse.mark === 'â—' ? 'A+' : (mainHorse.mark === 'â—‹' || mainHorse.mark === 'â—¯') ? 'A' : 'B',
            expectedReturn: Math.floor(Math.random() * 50 + 130),
            mainHorse: {
                number: mainHorse.number,
                name: mainHorse.name,
                confidence: mainHorse.confidence
            },
            subHorse: {
                number: subHorse.number,
                name: subHorse.name,
                confidence: subHorse.confidence
            },
            darkHorse: {
                number: darkHorse.number,
                name: darkHorse.name,
                confidence: darkHorse.confidence
            },
            allHorses: horses, // å…¨ã¦ã®é¦¬æƒ…å ±
            totalHorses: horses.length,
            previewSummary: previewSummary,
            previewFeatures: previewFeatures,
            previewRisk: mainHorse.mark === 'â—' ? 'ä½ãƒªã‚¹ã‚¯ã€å®‰å®šåç›Šå‹' : 'ä¸­ãƒªã‚¹ã‚¯ã€ãƒãƒ©ãƒ³ã‚¹å‹'
        };
    }

    // å°ã‹ã‚‰ä¿¡é ¼åº¦ã‚’è¨ˆç®—ï¼ˆä¸¡æ–¹ã®â—‹æ–‡å­—ã«å¯¾å¿œï¼‰
    function getConfidenceFromMark(mark) {
        const confidenceMap = {
            'â—': (Math.random() * 8 + 90).toFixed(1), // 90-98%
            'â—‹': (Math.random() * 8 + 82).toFixed(1), // 82-90% (U+25CB)
            'â—¯': (Math.random() * 8 + 82).toFixed(1), // 82-90% (U+25EF)
            'â–²': (Math.random() * 8 + 70).toFixed(1), // 70-78%
            'â–³': (Math.random() * 8 + 60).toFixed(1), // 60-68%
            'Ã—': (Math.random() * 8 + 50).toFixed(1)  // 50-58%
        };
        return confidenceMap[mark] || '65.0';
    }

    // ç‰¹å¾´é‡é‡è¦åº¦ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®é€£å‹•æ©Ÿèƒ½
    function setupFeatureSliders() {
        // æœ¬å‘½é¦¬ã®ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼
        ['mainFeature1', 'mainFeature2', 'mainFeature3'].forEach(id => {
            const slider = document.getElementById(id);
            const numberInput = document.getElementById(id + 'Val');
            const previewBar = slider.parentElement.parentElement.querySelector('.preview-bar-fill');
            
            if (slider && numberInput && previewBar) {
                // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®å¤‰æ›´æ™‚
                slider.addEventListener('input', function() {
                    const value = this.value / 100;
                    numberInput.value = value.toFixed(2);
                    previewBar.style.width = this.value + '%';
                    previewBar.textContent = value.toFixed(2);
                });
                
                // æ•°å€¤å…¥åŠ›ã®å¤‰æ›´æ™‚
                numberInput.addEventListener('input', function() {
                    const value = parseFloat(this.value) || 0;
                    const percentage = Math.min(100, Math.max(0, value * 100));
                    slider.value = percentage;
                    previewBar.style.width = percentage + '%';
                    previewBar.textContent = value.toFixed(2);
                });
            }
        });
        
        // å¯¾æŠ—é¦¬ã®ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼
        ['subFeature1', 'subFeature2', 'subFeature3'].forEach(id => {
            const slider = document.getElementById(id);
            const numberInput = document.getElementById(id + 'Val');
            const previewBar = slider.parentElement.parentElement.querySelector('.preview-bar-fill');
            
            if (slider && numberInput && previewBar) {
                // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®å¤‰æ›´æ™‚
                slider.addEventListener('input', function() {
                    const value = this.value / 100;
                    numberInput.value = value.toFixed(2);
                    previewBar.style.width = this.value + '%';
                    previewBar.textContent = value.toFixed(2);
                });
                
                // æ•°å€¤å…¥åŠ›ã®å¤‰æ›´æ™‚
                numberInput.addEventListener('input', function() {
                    const value = parseFloat(this.value) || 0;
                    const percentage = Math.min(100, Math.max(0, value * 100));
                    slider.value = percentage;
                    previewBar.style.width = percentage + '%';
                    previewBar.textContent = value.toFixed(2);
                });
            }
        });
    }
    
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’åˆæœŸåŒ–
    setupFeatureSliders();

    // å¤–éƒ¨äºˆæƒ³ã‚¯ãƒªã‚¢æ©Ÿèƒ½
    document.getElementById('clearPredictionBtn').addEventListener('click', function() {
        document.getElementById('externalPrediction').value = '';
        parsedPredictionData = null; // è§£æãƒ‡ãƒ¼ã‚¿ã‚‚ã‚¯ãƒªã‚¢
        console.log('è§£æãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
        alert('âœ… å¤–éƒ¨äºˆæƒ³ãƒ†ã‚­ã‚¹ãƒˆã¨è§£æãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚');
    });
    </script>
</BaseLayout>