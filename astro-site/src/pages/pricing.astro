---
// æ–™é‡‘ãƒ—ãƒ©ãƒ³ãƒšãƒ¼ã‚¸
const stripePublishableKey = import.meta.env.PUBLIC_STRIPE_PUBLISHABLE_KEY;
---

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="stripe-publishable-key" content={stripePublishableKey}>
    <title>æ–™é‡‘ãƒ—ãƒ©ãƒ³ | NANKANã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e2e8f0;
            min-height: 100vh;
        }

        .navbar {
            background: rgba(30, 41, 59, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(59, 130, 246, 0.3);
            padding: 16px 0;
        }

        .navbar-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }

        .logo {
            color: #3b82f6;
            font-size: 20px;
            font-weight: 700;
            text-decoration: none;
        }

        .nav-right a {
            color: #94a3b8;
            text-decoration: none;
            margin-left: 16px;
        }

        .nav-loading {
            color: #94a3b8;
            font-size: 14px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 60px 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 60px;
        }

        .header h1 {
            font-size: 48px;
            font-weight: 700;
            margin-bottom: 16px;
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            font-size: 20px;
            color: #94a3b8;
        }

        .pricing-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 32px;
            max-width: 800px;
            margin: 0 auto;
        }

        .plan-card {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 16px;
            padding: 32px;
            position: relative;
            transition: all 0.3s ease;
        }

        .plan-card:hover {
            transform: translateY(-4px);
            border-color: rgba(59, 130, 246, 0.6);
            box-shadow: 0 20px 40px -12px rgba(59, 130, 246, 0.3);
        }

        .plan-popular {
            border-color: #8b5cf6;
            background: rgba(139, 92, 246, 0.05);
        }

        .popular-badge {
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #8b5cf6 0%, #3b82f6 100%);
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .plan-name {
            font-size: 24px;
            font-weight: 700;
            color: #f1f5f9;
            margin-bottom: 8px;
        }

        .plan-description {
            color: #94a3b8;
            margin-bottom: 24px;
            line-height: 1.6;
        }

        .plan-price {
            display: flex;
            align-items: baseline;
            margin-bottom: 24px;
        }

        .price-amount {
            font-size: 48px;
            font-weight: 700;
            color: #f1f5f9;
        }

        .price-currency {
            font-size: 20px;
            color: #94a3b8;
            margin-right: 4px;
        }

        .price-period {
            font-size: 16px;
            color: #94a3b8;
            margin-left: 4px;
        }

        .features-list {
            list-style: none;
            margin-bottom: 32px;
        }

        .features-list li {
            display: flex;
            align-items: center;
            padding: 8px 0;
            color: #cbd5e1;
        }

        .features-list li::before {
            content: "âœ“";
            color: #10b981;
            font-weight: bold;
            margin-right: 12px;
            font-size: 16px;
        }

        .subscribe-btn {
            width: 100%;
            padding: 16px 24px;
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .subscribe-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.5);
        }

        .subscribe-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading-spinner {
            display: none;
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top: 2px solid #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .faq-section {
            margin-top: 80px;
            text-align: center;
        }

        .faq-title {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 40px;
            color: #f1f5f9;
        }

        .faq-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            text-align: left;
        }

        .faq-item {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 12px;
            padding: 24px;
        }

        .faq-question {
            font-size: 18px;
            font-weight: 600;
            color: #f1f5f9;
            margin-bottom: 12px;
        }

        .faq-answer {
            color: #94a3b8;
            line-height: 1.6;
        }

        @media (max-width: 768px) {
            .pricing-grid {
                grid-template-columns: 1fr;
                gap: 24px;
            }
            
            .container {
                padding: 40px 16px;
            }
            
            .header h1 {
                font-size: 36px;
            }
        }
    </style>
</head>
<body>
    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ -->
    <nav class="navbar">
        <div class="navbar-content">
            <a href="/" class="logo">ğŸ¤– NANKANã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹</a>
            <div class="nav-right">
                <span class="nav-loading">èª­ã¿è¾¼ã¿ä¸­...</span>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="header">
            <h1>æ–™é‡‘ãƒ—ãƒ©ãƒ³</h1>
            <p>AIã®åŠ›ã§ç«¶é¦¬äºˆæƒ³ã‚’æ¬¡ã®ãƒ¬ãƒ™ãƒ«ã¸</p>
        </div>

        <div class="pricing-grid">
            <!-- ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ãƒ—ãƒ©ãƒ³ -->
            <div class="plan-card">
                <div class="plan-name">ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰</div>
                <div class="plan-description">
                    å¾ŒåŠ3ãƒ¬ãƒ¼ã‚¹äºˆæƒ³ã¨åŸºç¤ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
                </div>
                <div class="plan-price">
                    <span class="price-currency">Â¥</span>
                    <span class="price-amount">5,980</span>
                    <span class="price-period">/æœˆ</span>
                </div>
                <ul class="features-list">
                    <li>10Rãƒ»11Rãƒ»12Räºˆæƒ³é–²è¦§</li>
                    <li>åŸºç¤ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¢ã‚¯ã‚»ã‚¹</li>
                    <li>ãƒ¡ãƒ¼ãƒ«ã‚µãƒãƒ¼ãƒˆ</li>
                    <li>éå»30æ—¥åˆ†ã®ãƒ‡ãƒ¼ã‚¿</li>
                    <li>AIåˆ†æãƒ¬ãƒãƒ¼ãƒˆ</li>
                </ul>
                <button class="subscribe-btn" data-plan="standard">
                    <span class="loading-spinner"></span>
                    ä»Šã™ãå§‹ã‚ã‚‹
                </button>
            </div>

            <!-- ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³ -->
            <div class="plan-card plan-popular">
                <div class="popular-badge">äººæ°—No.1</div>
                <div class="plan-name">ãƒ—ãƒ¬ãƒŸã‚¢ãƒ </div>
                <div class="plan-description">
                    å…¨ãƒ¬ãƒ¼ã‚¹äºˆæƒ³ã¨ã™ã¹ã¦ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¢ã‚¯ã‚»ã‚¹
                </div>
                <div class="plan-price">
                    <span class="price-currency">Â¥</span>
                    <span class="price-amount">9,980</span>
                    <span class="price-period">/æœˆ</span>
                </div>
                <ul class="features-list">
                    <li>1R-12R å…¨ãƒ¬ãƒ¼ã‚¹äºˆæƒ³é–²è¦§</li>
                    <li>å…¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¢ã‚¯ã‚»ã‚¹</li>
                    <li>ç„¡åˆ¶é™ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹</li>
                    <li>å„ªå…ˆã‚µãƒãƒ¼ãƒˆ</li>
                    <li>AIåˆ†æãƒ¬ãƒãƒ¼ãƒˆ</li>
                    <li>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šçŸ¥</li>
                </ul>
                <button class="subscribe-btn" data-plan="premium">
                    <span class="loading-spinner"></span>
                    ä»Šã™ãå§‹ã‚ã‚‹
                </button>
            </div>
        </div>

        <!-- FAQ ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="faq-section">
            <h2 class="faq-title">ã‚ˆãã‚ã‚‹è³ªå•</h2>
            <div class="faq-grid">
                <div class="faq-item">
                    <div class="faq-question">æ”¯æ‰•ã„æ–¹æ³•ã¯ï¼Ÿ</div>
                    <div class="faq-answer">ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ï¼ˆVisaã€MasterCardã€American Expressã€JCBï¼‰ã«å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚</div>
                </div>
                <div class="faq-item">
                    <div class="faq-question">ã„ã¤ã§ã‚‚ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã§ãã¾ã™ã‹ï¼Ÿ</div>
                    <div class="faq-answer">ã¯ã„ã€‚ã„ã¤ã§ã‚‚ã‚­ãƒ£ãƒ³ã‚»ãƒ«å¯èƒ½ã§ã€æ¬¡å›æ›´æ–°æ—¥ã¾ã§åˆ©ç”¨ã§ãã¾ã™ã€‚</div>
                </div>
                <div class="faq-item">
                    <div class="faq-question">ãƒ—ãƒ©ãƒ³å¤‰æ›´ã¯å¯èƒ½ã§ã™ã‹ï¼Ÿ</div>
                    <div class="faq-answer">ã¯ã„ã€‚ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç®¡ç†ç”»é¢ã‹ã‚‰ã„ã¤ã§ã‚‚ãƒ—ãƒ©ãƒ³ã®å¤‰æ›´ãŒå¯èƒ½ã§ã™ã€‚</div>
                </div>
                <div class="faq-item">
                    <div class="faq-question">è¿”é‡‘ä¿è¨¼ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ</div>
                    <div class="faq-answer">åˆå›ç™»éŒ²ã‹ã‚‰7æ—¥é–“ã¯å…¨é¡è¿”é‡‘ä¿è¨¼ã„ãŸã—ã¾ã™ã€‚</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Stripe.js ã‚’é€šå¸¸ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§èª­ã¿è¾¼ã¿ -->
    <script src="https://js.stripe.com/v3/"></script>
    
    <script type="module">
        // Supabaseã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        import { createClient } from 'https://cdn.skypack.dev/@supabase/supabase-js';

        // Stripeè¨­å®šï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ã«èª­ã¿è¾¼ã¾ã‚ŒãŸStripeã‚’ä½¿ç”¨ï¼‰
        const stripePublishableKey = document.querySelector('meta[name="stripe-publishable-key"]')?.content;
        
        const getStripe = () => {
            return window.Stripe ? window.Stripe(stripePublishableKey) : null;
        };

        // æ–™é‡‘ãƒ—ãƒ©ãƒ³è¨­å®š
        const PRICING_PLANS = {
            STANDARD: {
                name: 'ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰',
                description: 'å¾ŒåŠãƒ¬ãƒ¼ã‚¹äºˆæƒ³ãƒ»åŸºç¤ã‚³ãƒ³ãƒ†ãƒ³ãƒ„',
                price: 5980,
                stripePriceId: 'price_1S0YFdFA5w33p4WyJNK6MoRR',
                features: ['10Rãƒ»11Rãƒ»12Räºˆæƒ³é–²è¦§', 'åŸºç¤ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¢ã‚¯ã‚»ã‚¹', 'ãƒ¡ãƒ¼ãƒ«ã‚µãƒãƒ¼ãƒˆ', 'éå»30æ—¥åˆ†ã®ãƒ‡ãƒ¼ã‚¿']
            },
            PREMIUM: {
                name: 'ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ',
                description: 'å…¨ãƒ¬ãƒ¼ã‚¹äºˆæƒ³ãƒ»ã™ã¹ã¦ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„',
                price: 9980,
                stripePriceId: 'price_1S0YUfFA5w33p4WyVImKgx4c',
                features: ['1R-12R å…¨ãƒ¬ãƒ¼ã‚¹äºˆæƒ³é–²è¦§', 'å…¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¢ã‚¯ã‚»ã‚¹', 'ç„¡åˆ¶é™ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹', 'å„ªå…ˆã‚µãƒãƒ¼ãƒˆ', 'AIåˆ†æãƒ¬ãƒãƒ¼ãƒˆ']
            }
        };

        // Checkoutã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆé–¢æ•°
        const createCheckoutSession = async (priceId, userId, customerEmail) => {
            try {
                console.log('Creating checkout session for:', { priceId, userId, customerEmail });
                
                const response = await fetch('/api/create-checkout-session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ priceId, userId, customerEmail })
                });
                
                console.log('API response status:', response.status);
                console.log('API response headers:', [...response.headers.entries()]);
                
                const responseText = await response.text();
                console.log('Raw API response:', responseText);
                
                let session;
                try {
                    session = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('JSON parse error:', parseError);
                    throw new Error('APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + responseText);
                }
                
                if (!response.ok) {
                    console.error('API error response:', session);
                    console.log('Debug details:', session.debug);
                    
                    // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è©³ç´°ã«è¡¨ç¤º
                    if (session.debug) {
                        console.log('Error Type:', session.debug.errorType);
                        console.log('Error Code:', session.debug.errorCode);
                        console.log('Key Prefix:', session.debug.keyPrefix);
                        console.log('Has Stripe Key:', session.debug.hasStripeKey);
                        console.log('Requested Price ID:', session.debug.requestedPriceId);
                        console.log('Site URL:', session.debug.siteUrl);
                    }
                    
                    const error = new Error(session.error || 'ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                    error.debug = session.debug;
                    throw error;
                }
                return session;
            } catch (error) {
                console.error('Checkout session creation error:', error);
                throw error;
            }
        };

        // Supabaseè¨­å®š
        const supabaseUrl = 'https://qysycsrhaatudnksbpqe.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF5c3ljc3JoYWF0dWRua3NicHFlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5MzM3MjcsImV4cCI6MjA3MTUwOTcyN30.UDWi7FYqpJNpMhvMMaZoGMXwuD1R2PNH4Tk6Xs1u1pU';
        const supabase = createClient(supabaseUrl, supabaseAnonKey);
        
        const auth = {
            async getUser() {
                return await supabase.auth.getUser();
            },
            async signOut() {
                return await supabase.auth.signOut();
            }
        };

        // è³¼èª­ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.querySelectorAll('.subscribe-btn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                const planType = e.target.dataset.plan;
                await handleSubscribe(planType, e.target);
            });
        });

        async function handleSubscribe(planType, button) {
            try {
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹é–‹å§‹
                setButtonLoading(button, true);

                // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—ï¼ˆè¤‡æ•°ã®æ–¹æ³•ã§ç¢ºèªï¼‰
                let user = null;
                
                // æ–¹æ³•1: window.currentUserï¼ˆãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«è¨­å®šï¼‰
                if (window.currentUser) {
                    user = window.currentUser;
                    console.log('Using cached user from window.currentUser:', user.email);
                } else {
                    // æ–¹æ³•2: Supabase auth.getUser()
                    const { data: { user: supabaseUser }, error: authError } = await auth.getUser();
                    console.log('Supabase getUser in subscribe:', { user: supabaseUser?.email, error: authError });
                    
                    if (supabaseUser && !authError) {
                        user = supabaseUser;
                    } else {
                        // æ–¹æ³•3: ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ç¢ºèª
                        const session = localStorage.getItem('sb-' + 'qysycsrhaatudnksbpqe' + '-auth-token');
                        if (session) {
                            try {
                                const sessionData = JSON.parse(session);
                                if (sessionData.user) {
                                    user = sessionData.user;
                                    console.log('Using user from localStorage in subscribe:', user.email);
                                }
                            } catch (e) {
                                console.log('Error parsing session in subscribe:', e);
                            }
                        }
                    }
                }
                
                if (!user) {
                    console.log('User not authenticated, redirecting to login');
                    // æœªèªè¨¼ã®å ´åˆã€ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼ˆæ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚‚è€ƒæ…®ï¼‰
                    window.location.href = '/auth/login?redirect=' + encodeURIComponent('/pricing');
                    return;
                }
                
                console.log('Proceeding with subscription for user:', user.email);

                // ãƒ—ãƒ©ãƒ³ã®è©³ç´°å–å¾—
                const planDetails = PRICING_PLANS[planType.toUpperCase()];
                if (!planDetails) {
                    throw new Error('Invalid plan type');
                }

                // é–‹ç™ºç’°å¢ƒã§ã¯ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã‚’ä½¿ç”¨
                const isDevelopment = window.location.hostname === 'localhost';
                
                if (isDevelopment) {
                    // ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰: APIã‚’ä½¿ã‚ãšç›´æ¥å‡¦ç†
                    console.log('Demo mode: Simulating subscription for', user.email);
                    const session = {
                        demo: true,
                        message: `ãƒ‡ãƒ¢è³¼å…¥å®Œäº†ï¼\n\nãƒ—ãƒ©ãƒ³: ${planType}\nãƒ¦ãƒ¼ã‚¶ãƒ¼: ${user.email}\n\nã“ã‚Œã¯é–‹ç™ºç’°å¢ƒã§ã®ãƒ†ã‚¹ãƒˆã§ã™ã€‚`
                    };
                    
                    // ãƒ‡ãƒ¢ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³å‡¦ç†
                    localStorage.setItem('demo_subscription_' + user.id, JSON.stringify({
                        planType: planType,
                        createdAt: new Date().toISOString(),
                        demo: true
                    }));
                    
                    alert(session.message);
                    window.location.href = '/dashboard';
                    return;
                } else {
                    // æœ¬ç•ªç’°å¢ƒ: å®Ÿéš›ã®Stripeå‡¦ç†
                    const session = await createCheckoutSession(
                        planDetails.stripePriceId,
                        user.id,
                        user.email
                    );
                }

                // æœ¬ç•ªç’°å¢ƒã§ã®ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œï¼ˆæ®‹ã—ã¦ãŠãï¼‰
                if (session && session.demo) {
                    // ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³æƒ…å ±ã‚’æ›´æ–°
                    try {
                        const updateResponse = await fetch('/api/update-subscription-demo', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                userId: user.id,
                                planType: planType
                            })
                        });

                        const updateResult = await updateResponse.json();
                        
                        if (updateResponse.ok) {
                            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ãƒ‡ãƒ¢ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³æƒ…å ±ã‚’ä¿å­˜
                            localStorage.setItem('demo_subscription_' + user.id, JSON.stringify({
                                planType: planType,
                                createdAt: new Date().toISOString(),
                                demo: true
                            }));
                            
                            alert(`${session.message}\n\nãƒ—ãƒ©ãƒ³: ${planType}\nãƒ¦ãƒ¼ã‚¶ãƒ¼: ${user.email}\n\nãƒ‡ãƒ¢è³¼å…¥ãŒå®Œäº†ã—ã¾ã—ãŸï¼\n\nä¼šå“¡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸã€‚`);
                        } else {
                            // ã‚¨ãƒ©ãƒ¼ã§ã‚‚ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ã¯ä¿å­˜ï¼ˆãƒ‡ãƒ¢ãªã®ã§ï¼‰
                            localStorage.setItem('demo_subscription_' + user.id, JSON.stringify({
                                planType: planType,
                                createdAt: new Date().toISOString(),
                                demo: true
                            }));
                            
                            alert(`ãƒ‡ãƒ¢è³¼å…¥ã¯å®Œäº†ã—ã¾ã—ãŸï¼\n\nãƒ—ãƒ©ãƒ³: ${planType}\nãƒ¦ãƒ¼ã‚¶ãƒ¼: ${user.email}\n\nâ€»ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã®ãŸã‚ã€ä¼šå“¡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã§ç®¡ç†ã•ã‚Œã¾ã™ã€‚`);
                        }
                    } catch (updateError) {
                        console.error('Subscription update error:', updateError);
                        alert(`ãƒ‡ãƒ¢è³¼å…¥ã¯å®Œäº†ã—ã¾ã—ãŸãŒã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚`);
                    }
                    
                    window.location.href = '/dashboard';
                    return;
                }

                // Stripe Checkout ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                const stripe = getStripe();
                if (!stripe) {
                    throw new Error('Stripe ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                }
                const { error } = await stripe.redirectToCheckout({
                    sessionId: session.id
                });

                if (error) {
                    throw error;
                }

            } catch (error) {
                console.error('Subscription error:', error);
                
                let errorMessage = 'æ±ºæ¸ˆå‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
                if (error.message.includes('network')) {
                    errorMessage = 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
                }
                
                // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ãŒã‚ã‚Œã°è¡¨ç¤º
                if (error.debug) {
                    console.log('Debug info:', error.debug);
                    errorMessage += '\n\nãƒ‡ãƒãƒƒã‚°æƒ…å ±: ' + JSON.stringify(error.debug, null, 2);
                }
                
                alert(errorMessage);
            } finally {
                setButtonLoading(button, false);
            }
        }

        function setButtonLoading(button, isLoading) {
            const spinner = button.querySelector('.loading-spinner');
            const text = button.childNodes[button.childNodes.length - 1];
            
            if (isLoading) {
                button.disabled = true;
                spinner.style.display = 'inline-block';
                text.textContent = 'å‡¦ç†ä¸­...';
            } else {
                button.disabled = false;
                spinner.style.display = 'none';
                text.textContent = 'ä»Šã™ãå§‹ã‚ã‚‹';
            }
        }

        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
        document.addEventListener('DOMContentLoaded', async () => {
            const navRight = document.querySelector('.nav-right');
            
            // ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’è¤‡æ•°ã®æ–¹æ³•ã§ç¢ºèª
            let user = null;
            
            try {
                // æ–¹æ³•1: Supabase auth.getUser()
                const { data: { user: supabaseUser }, error: authError } = await auth.getUser();
                console.log('Supabase getUser result:', { user: supabaseUser?.email, error: authError });
                
                if (supabaseUser && !authError) {
                    user = supabaseUser;
                } else {
                    // æ–¹æ³•2: ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¢ºèª
                    const session = localStorage.getItem('sb-' + 'qysycsrhaatudnksbpqe' + '-auth-token');
                    console.log('LocalStorage session check:', !!session);
                    
                    if (session) {
                        try {
                            const sessionData = JSON.parse(session);
                            if (sessionData.user) {
                                user = sessionData.user;
                                console.log('Found user in localStorage:', user.email);
                            }
                        } catch (e) {
                            console.log('Error parsing session:', e);
                        }
                    }
                }
                
                // ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¢ºèªç”¨ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°è¨­å®šï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
                window.currentUser = user;
                
                if (user) {
                    // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã®å ´åˆã€ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°
                    navRight.innerHTML = `
                        <span style="color: #94a3b8; margin-right: 16px;">${user.email}</span>
                        <a href="/dashboard">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
                        <a href="#" onclick="handleLogout()" style="margin-left: 16px;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
                    `;
                    console.log('Navigation updated for logged in user:', user.email);
                } else {
                    // æœªèªè¨¼ã®å ´åˆã€ãƒ­ã‚°ã‚¤ãƒ³ãƒ»ç™»éŒ²ãƒªãƒ³ã‚¯ã‚’è¡¨ç¤º
                    navRight.innerHTML = `
                        <a href="/auth/login">ãƒ­ã‚°ã‚¤ãƒ³</a>
                        <a href="/auth/signup">æ–°è¦ç™»éŒ²</a>
                    `;
                    console.log('Navigation updated for guest user');
                }
            } catch (error) {
                console.error('Authentication check error:', error);
                // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã€æœªèªè¨¼çŠ¶æ…‹ã¨ã—ã¦å‡¦ç†
                navRight.innerHTML = `
                    <a href="/auth/login">ãƒ­ã‚°ã‚¤ãƒ³</a>
                    <a href="/auth/signup">æ–°è¦ç™»éŒ²</a>
                `;
            }
        });

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
        window.handleLogout = async () => {
            try {
                await auth.signOut();
                window.location.reload();
            } catch (error) {
                console.error('Logout error:', error);
                alert('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
            }
        };
    </script>
</body>
</html>