---
export const prerender = true;
import BaseLayout from '../layouts/BaseLayout.astro';
import allRacesData from '../data/allRacesPrediction.json';

const title = '三連複絞り込み機能 デモ体験 | NANKANアナリティクス';
const description = '購入前に実際の的中レースで体験！AI三連複絞り込み機能のデモ。累積スコアベースの自動戦略選択で、わずか7-9点の少点数買い目を実現。';

// デモとして11Rを使用（メインレース）
const sampleRace = allRacesData.races.find(r => r.raceNumber === 11) || allRacesData.races[0];
const raceDate = allRacesData.raceDate;
const track = allRacesData.track;

// 日付フォーマット
const [year, month, day] = raceDate.split('-');
const formattedDate = `${year}年${parseInt(month)}月${parseInt(day)}日`;

// 馬データ取得
const { main, sub, minor = [], low = [], other = [] } = sampleRace.horses || {};
const allHorses = [main, sub, ...(minor || []), ...(low || []), ...(other || [])].filter(Boolean);

// 累積スコア基準の戦略選択ロジック（premium-sanrenpuku.astroと同じ）
const mainScore = main?.confidence || 0;
let selectedStrategy = 'balance'; // デフォルト
let selectedBetCount = 10;

if (mainScore >= 89) {
    selectedStrategy = 'safe-balance-mix';
    selectedBetCount = 5;
} else if (mainScore === 88) {
    selectedStrategy = 'safe-oriented';
    selectedBetCount = 7;
} else if (mainScore === 87) {
    selectedStrategy = 'balance';
    selectedBetCount = 10;
} else if (mainScore === 86) {
    selectedStrategy = 'balance-aggressive-mix';
    selectedBetCount = 10;
} else {
    selectedStrategy = 'aggressive';
    selectedBetCount = 10;
}

// 戦略別の買い目生成（サンプル表示用）
const strategies = sampleRace.strategies || {};
const { safe, balance, aggressive } = strategies;

// 全戦略の買い目を展開してスコア化（簡略版）
const allBets = [];

// 少点数型
if (safe?.bets && Array.isArray(safe.bets)) {
    safe.bets.forEach(bet => {
        const betString = typeof bet === 'string' ? bet : String(bet);
        const horses = betString.match(/\d+/g) || [];
        const avgScore = horses.reduce((sum, num) => {
            const horse = allHorses.find(h => h.number === parseInt(num));
            return sum + (horse?.confidence || 0);
        }, 0) / (horses.length || 1);
        allBets.push({ betStr: betString, score: avgScore, type: '少点数型' });
    });
}

// バランス型
if (balance?.bets && Array.isArray(balance.bets)) {
    balance.bets.forEach(bet => {
        const betString = typeof bet === 'string' ? bet : String(bet);
        const horses = betString.match(/\d+/g) || [];
        const avgScore = horses.reduce((sum, num) => {
            const horse = allHorses.find(h => h.number === parseInt(num));
            return sum + (horse?.confidence || 0);
        }, 0) / (horses.length || 1);
        allBets.push({ betStr: betString, score: avgScore, type: 'バランス型' });
    });
}

// 高配当型
if (aggressive?.bets && Array.isArray(aggressive.bets)) {
    aggressive.bets.forEach(bet => {
        const betString = typeof bet === 'string' ? bet : String(bet);
        const horses = betString.match(/\d+/g) || [];
        const avgScore = horses.reduce((sum, num) => {
            const horse = allHorses.find(h => h.number === parseInt(num));
            return sum + (horse?.confidence || 0);
        }, 0) / (horses.length || 1);
        allBets.push({ betStr: betString, score: avgScore, type: '高配当型' });
    });
}

// スコア順にソート
allBets.sort((a, b) => b.score - a.score);

// 選択された点数だけ抽出
const selectedBets = allBets.slice(0, selectedBetCount);
---

<BaseLayout title={title} description={description}>
    <div class="sample-page-container">
        <!-- ヘッダー -->
        <div class="sample-header">
            <div class="badge-new">🎯 無料デモ体験</div>
            <h1>AI三連複絞り込み機能 デモ体験</h1>
            <p class="header-description">
                購入前にお試し！実際の的中レースでPremium Sanrenpukuの絞り込み機能を体験できます。
            </p>
        </div>

        <!-- デモレース情報 -->
        <div class="sample-race-info">
            <h2>📅 デモレース情報</h2>
            <div class="race-meta">
                <span class="meta-item">🏇 {track} {sampleRace.raceNumber}R</span>
                <span class="meta-item">📏 {sampleRace.raceInfo.distance}</span>
                <span class="meta-item">🐎 {sampleRace.raceInfo.horseCount}頭立て</span>
                <span class="meta-item">📅 {formattedDate}</span>
            </div>
            <p class="race-name">{sampleRace.raceName}</p>
        </div>

        <!-- AI自動判定の説明 -->
        <div class="auto-selection-explanation">
            <h2>🤖 AI自動判定の仕組み</h2>
            <div class="explanation-content">
                <div class="explanation-step">
                    <span class="step-number">1</span>
                    <div class="step-content">
                        <h3>累積スコアを計算</h3>
                        <p>本命馬の累積スコア: <strong class="highlight">{mainScore}pt</strong></p>
                    </div>
                </div>
                <div class="explanation-step">
                    <span class="step-number">2</span>
                    <div class="step-content">
                        <h3>最適戦略を自動選択</h3>
                        <p>このレースの戦略: <strong class="highlight">{selectedStrategy}</strong></p>
                        <p class="strategy-reason">
                            {mainScore >= 89 && '本命の信頼度が非常に高いため、少点数型+バランス型のミックスで堅実勝負'}
                            {mainScore === 88 && '本命の信頼度が高いため、少点数型寄りの買い目で的中率重視'}
                            {mainScore === 87 && 'バランス型で的中率と配当のバランスを追求'}
                            {mainScore === 86 && 'バランス型+高配当型のミックスで配当を狙う'}
                            {mainScore < 86 && '波乱含みのため、高配当型で穴馬を狙う'}
                        </p>
                    </div>
                </div>
                <div class="explanation-step">
                    <span class="step-number">3</span>
                    <div class="step-content">
                        <h3>買い目を自動絞り込み</h3>
                        <p>目標点数: <strong class="highlight">{selectedBetCount}点</strong></p>
                        <p>3戦略の全買い目から、累積スコア上位{selectedBetCount}点のみを自動抽出</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 出走馬情報 -->
        <div class="horses-section">
            <h2>🐎 出走馬情報</h2>

            <!-- 本命 -->
            {main && (
                <div class="horse-card main-horse">
                    <div class="horse-header">
                        <span class="horse-mark">◎</span>
                        <span class="horse-role">本命</span>
                        <span class="horse-number">{main.number}番</span>
                    </div>
                    <h3 class="horse-name">{main.name}</h3>
                    <div class="horse-score">
                        累積スコア: <strong>{main.confidence}pt</strong>
                    </div>
                </div>
            )}

            <!-- 対抗 -->
            {sub && (
                <div class="horse-card sub-horse">
                    <div class="horse-header">
                        <span class="horse-mark">○</span>
                        <span class="horse-role">対抗</span>
                        <span class="horse-number">{sub.number}番</span>
                    </div>
                    <h3 class="horse-name">{sub.name}</h3>
                    <div class="horse-score">
                        累積スコア: <strong>{sub.confidence}pt</strong>
                    </div>
                </div>
            )}

            <!-- 単穴 -->
            {minor && minor.length > 0 && minor.map(horse => (
                <div class="horse-card minor-horse">
                    <div class="horse-header">
                        <span class="horse-mark">▲</span>
                        <span class="horse-role">単穴</span>
                        <span class="horse-number">{horse.number}番</span>
                    </div>
                    <h3 class="horse-name">{horse.name}</h3>
                    <div class="horse-score">
                        累積スコア: <strong>{horse.confidence}pt</strong>
                    </div>
                </div>
            ))}
        </div>

        <!-- AI絞り込み結果 -->
        <div class="selected-bets-section">
            <h2>✨ AI絞り込み結果（{selectedBets.length}点）</h2>
            <p class="section-description">
                3戦略の全買い目から、累積スコア上位{selectedBetCount}点のみを自動抽出しました。
            </p>
            <div class="bets-grid">
                {selectedBets.map((bet, index) => (
                    <div class="bet-item" data-rank={index + 1}>
                        <span class="bet-rank">#{index + 1}</span>
                        <span class="bet-content">{bet.betStr}</span>
                        <span class="bet-score">{bet.score.toFixed(1)}pt</span>
                        <span class="bet-type-badge">{bet.type}</span>
                    </div>
                ))}
            </div>
        </div>

        <!-- CTA Section -->
        <div class="cta-section">
            <h2>💎 Premium Sanrenpukuなら...</h2>
            <div class="cta-features">
                <div class="cta-feature">
                    <span class="feature-icon">🏇</span>
                    <h3>全レース対応</h3>
                    <p>1R〜12R全てのレースで<br>AI絞り込み機能が使えます</p>
                </div>
                <div class="cta-feature">
                    <span class="feature-icon">📊</span>
                    <h3>驚異の実績</h3>
                    <p>過去1年間<br>的中率78% 回収率178%</p>
                </div>
                <div class="cta-feature">
                    <span class="feature-icon">🎯</span>
                    <h3>少点数買い目</h3>
                    <p>わずか7-9点の少点数で<br>的中率を最大化</p>
                </div>
            </div>

            <div class="cta-buttons">
                <a href="/plan-upgrade-guide" class="btn-detail">
                    📖 詳細を見る
                </a>
                <a href="https://buy.stripe.com/28EcN5fpf58k8O734vdby0P" class="btn-purchase" target="_blank" rel="noopener">
                    💳 Premium Sanrenpuku購入<br>
                    <span class="price">¥19,820/月</span>
                </a>
                <a href="https://buy.stripe.com/6oU28r90R1W8c0jbB1dby0Q" class="btn-purchase combo" target="_blank" rel="noopener">
                    💎 Premium Combo購入<br>
                    <span class="price">¥24,800/月（馬単+三連複）</span>
                </a>
            </div>

            <p class="cta-note">
                ※既存Premium会員の方は、運営側で既存プランを手動キャンセルいたします（二重課金なし）
            </p>
        </div>

        <!-- 戻るリンク -->
        <div class="back-link-container">
            <a href="/premium-predictions" class="back-link">← 予想ページに戻る</a>
        </div>
    </div>
</BaseLayout>

<style>
    .sample-page-container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 40px 20px;
    }

    .sample-header {
        text-align: center;
        margin-bottom: 50px;
        padding-bottom: 30px;
        border-bottom: 2px solid rgba(59, 130, 246, 0.3);
    }

    .badge-new {
        display: inline-block;
        background: linear-gradient(135deg, #f59e0b, #ea580c);
        color: white;
        padding: 8px 20px;
        border-radius: 20px;
        font-weight: 700;
        font-size: 0.9rem;
        margin-bottom: 20px;
    }

    .sample-header h1 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 15px;
        background: linear-gradient(135deg, #3b82f6, #8b5cf6);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .header-description {
        font-size: 1.1rem;
        color: #94a3b8;
    }

    .sample-race-info {
        background: rgba(30, 41, 59, 0.5);
        border: 1px solid rgba(59, 130, 246, 0.2);
        border-radius: 16px;
        padding: 30px;
        margin-bottom: 40px;
        backdrop-filter: blur(10px);
    }

    .sample-race-info h2 {
        color: #3b82f6;
        font-size: 1.5rem;
        margin-bottom: 20px;
    }

    .race-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-bottom: 15px;
    }

    .meta-item {
        background: rgba(59, 130, 246, 0.15);
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 0.95rem;
        font-weight: 600;
        color: #60a5fa;
    }

    .race-name {
        font-size: 1.1rem;
        color: #cbd5e1;
        font-weight: 600;
    }

    .auto-selection-explanation {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1));
        border: 2px solid rgba(59, 130, 246, 0.3);
        border-radius: 16px;
        padding: 40px;
        margin-bottom: 40px;
    }

    .auto-selection-explanation h2 {
        color: #3b82f6;
        font-size: 1.8rem;
        margin-bottom: 30px;
        text-align: center;
    }

    .explanation-content {
        display: flex;
        flex-direction: column;
        gap: 30px;
    }

    .explanation-step {
        display: flex;
        gap: 20px;
        align-items: flex-start;
    }

    .step-number {
        flex-shrink: 0;
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, #3b82f6, #8b5cf6);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        font-weight: 700;
        color: white;
    }

    .step-content h3 {
        color: #60a5fa;
        font-size: 1.2rem;
        margin-bottom: 10px;
    }

    .step-content p {
        color: #cbd5e1;
        line-height: 1.8;
    }

    .highlight {
        color: #fbbf24;
        font-weight: 700;
        font-size: 1.1em;
    }

    .strategy-reason {
        margin-top: 10px;
        padding: 15px;
        background: rgba(59, 130, 246, 0.1);
        border-left: 3px solid #3b82f6;
        border-radius: 8px;
        color: #e2e8f0;
    }

    .horses-section {
        margin-bottom: 40px;
    }

    .horses-section h2 {
        color: #3b82f6;
        font-size: 1.8rem;
        margin-bottom: 25px;
    }

    .horse-card {
        background: rgba(30, 41, 59, 0.5);
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 15px;
        border: 2px solid;
        transition: all 0.3s ease;
    }

    .horse-card.main-horse {
        border-color: rgba(16, 185, 129, 0.4);
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.05));
    }

    .horse-card.sub-horse {
        border-color: rgba(236, 72, 153, 0.4);
        background: linear-gradient(135deg, rgba(236, 72, 153, 0.15), rgba(236, 72, 153, 0.05));
    }

    .horse-card.minor-horse {
        border-color: rgba(251, 191, 36, 0.4);
        background: linear-gradient(135deg, rgba(251, 191, 36, 0.15), rgba(251, 191, 36, 0.05));
    }

    .horse-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 12px;
    }

    .horse-mark {
        font-size: 1.5rem;
        font-weight: 700;
    }

    .main-horse .horse-mark {
        color: #10b981;
    }

    .sub-horse .horse-mark {
        color: #ec4899;
    }

    .minor-horse .horse-mark {
        color: #fbbf24;
    }

    .horse-role {
        background: rgba(59, 130, 246, 0.2);
        padding: 4px 12px;
        border-radius: 6px;
        font-size: 0.85rem;
        font-weight: 600;
        color: #60a5fa;
    }

    .horse-number {
        background: rgba(30, 41, 59, 0.8);
        padding: 4px 12px;
        border-radius: 6px;
        font-weight: 700;
        color: #fbbf24;
    }

    .horse-name {
        font-size: 1.3rem;
        font-weight: 700;
        color: #e2e8f0;
        margin-bottom: 12px;
    }

    .horse-score {
        color: #94a3b8;
        font-size: 0.95rem;
    }

    .horse-score strong {
        color: #fbbf24;
        font-size: 1.1rem;
    }

    .selected-bets-section {
        background: rgba(30, 41, 59, 0.5);
        border: 2px solid rgba(245, 158, 11, 0.3);
        border-radius: 16px;
        padding: 40px;
        margin-bottom: 50px;
    }

    .selected-bets-section h2 {
        color: #f59e0b;
        font-size: 1.8rem;
        margin-bottom: 15px;
    }

    .section-description {
        color: #cbd5e1;
        margin-bottom: 30px;
        font-size: 1.05rem;
    }

    .bets-grid {
        display: grid;
        gap: 15px;
    }

    .bet-item {
        display: grid;
        grid-template-columns: 50px 1fr auto auto;
        gap: 15px;
        align-items: center;
        background: rgba(15, 23, 42, 0.6);
        padding: 20px;
        border-radius: 12px;
        border: 1px solid rgba(245, 158, 11, 0.2);
        transition: all 0.3s ease;
    }

    .bet-item:hover {
        border-color: rgba(245, 158, 11, 0.5);
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(245, 158, 11, 0.2);
    }

    .bet-rank {
        background: linear-gradient(135deg, #f59e0b, #ea580c);
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 1.1rem;
    }

    .bet-content {
        color: #e2e8f0;
        font-weight: 600;
        font-size: 1.1rem;
    }

    .bet-score {
        color: #fbbf24;
        font-weight: 700;
        font-size: 1.1rem;
    }

    .bet-type-badge {
        background: rgba(139, 92, 246, 0.2);
        color: #a78bfa;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .cta-section {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1));
        border: 2px solid rgba(59, 130, 246, 0.3);
        border-radius: 16px;
        padding: 50px;
        margin-bottom: 40px;
        text-align: center;
    }

    .cta-section h2 {
        color: #3b82f6;
        font-size: 2rem;
        margin-bottom: 40px;
    }

    .cta-features {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 30px;
        margin-bottom: 40px;
    }

    .cta-feature {
        background: rgba(30, 41, 59, 0.5);
        padding: 30px;
        border-radius: 12px;
        border: 1px solid rgba(59, 130, 246, 0.2);
    }

    .feature-icon {
        font-size: 3rem;
        display: block;
        margin-bottom: 15px;
    }

    .cta-feature h3 {
        color: #60a5fa;
        font-size: 1.3rem;
        margin-bottom: 12px;
    }

    .cta-feature p {
        color: #cbd5e1;
        line-height: 1.8;
    }

    .cta-buttons {
        display: flex;
        flex-direction: column;
        gap: 20px;
        max-width: 600px;
        margin: 0 auto;
    }

    .btn-detail,
    .btn-purchase {
        padding: 20px 40px;
        border-radius: 12px;
        font-weight: 700;
        font-size: 1.1rem;
        text-decoration: none;
        transition: all 0.3s ease;
        display: block;
    }

    .btn-detail {
        background: rgba(59, 130, 246, 0.2);
        color: #60a5fa;
        border: 2px solid #3b82f6;
    }

    .btn-detail:hover {
        background: rgba(59, 130, 246, 0.3);
        transform: translateY(-3px);
        box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4);
    }

    .btn-purchase {
        background: linear-gradient(135deg, #f59e0b, #ea580c);
        color: white;
        border: 2px solid rgba(245, 158, 11, 0.5);
    }

    .btn-purchase.combo {
        background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        border-color: rgba(139, 92, 246, 0.5);
    }

    .btn-purchase:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 30px rgba(245, 158, 11, 0.5);
    }

    .btn-purchase.combo:hover {
        box-shadow: 0 10px 30px rgba(139, 92, 246, 0.5);
    }

    .price {
        display: block;
        font-size: 1.2rem;
        margin-top: 8px;
        opacity: 0.9;
    }

    .cta-note {
        margin-top: 25px;
        color: #94a3b8;
        font-size: 0.95rem;
    }

    .back-link-container {
        text-align: center;
    }

    .back-link {
        display: inline-block;
        color: #60a5fa;
        text-decoration: none;
        font-weight: 600;
        padding: 12px 24px;
        border-radius: 8px;
        border: 1px solid rgba(59, 130, 246, 0.3);
        transition: all 0.3s ease;
    }

    .back-link:hover {
        background: rgba(59, 130, 246, 0.1);
        border-color: #3b82f6;
    }

    @media (max-width: 768px) {
        .sample-page-container {
            padding: 20px 15px;
        }

        .sample-header h1 {
            font-size: 1.8rem;
        }

        .auto-selection-explanation {
            padding: 25px;
        }

        .explanation-step {
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .bet-item {
            grid-template-columns: 1fr;
            text-align: center;
            gap: 10px;
        }

        .cta-section {
            padding: 30px 20px;
        }

        .cta-features {
            grid-template-columns: 1fr;
        }
    }
</style>
