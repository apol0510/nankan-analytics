---
// ç®¡ç†è€…ç”¨ãƒ¡ãƒ«ãƒã‚¬é…ä¿¡ãƒšãƒ¼ã‚¸
export const prerender = true;
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout title="ãƒ¡ãƒ«ãƒã‚¬é…ä¿¡ç®¡ç† - NANKANã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹">
    <style>
        /* ãƒ¢ãƒ€ãƒ³ãªç®¡ç†ç”»é¢ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .newsletter-admin {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }
        
        /* å¼·åˆ¶çš„ã«ãƒ†ã‚­ã‚¹ãƒˆè‰²ã‚’ç¢ºä¿ */
        .newsletter-admin * {
            color: inherit !important;
        }
        
        .newsletter-admin h1, 
        .newsletter-admin h2, 
        .newsletter-admin h3, 
        .newsletter-admin h4,
        .newsletter-admin p,
        .newsletter-admin span,
        .newsletter-admin div,
        .newsletter-admin label,
        .newsletter-admin small {
            color: #1f2937 !important;
        }
        
        .admin-header {
            text-align: center;
            color: white !important;
            margin-bottom: 40px;
            padding: 40px 20px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            z-index: 1;
        }
        
        .admin-header h1,
        .admin-header p {
            color: white !important;
        }
        
        .admin-header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin: 0;
        }
        
        .admin-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        @media (max-width: 1024px) {
            .admin-container {
                grid-template-columns: 1fr;
            }
        }
        
        .card {
            background: #ffffff !important;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            border: 1px solid #e2e8f0;
            position: relative;
            z-index: 1;
            color: #1f2937 !important;
        }
        
        .card * {
            color: #1f2937 !important;
        }
        
        .card h2 {
            color: #1f2937 !important;
            font-size: 1.5rem;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }
        
        .card h2::before {
            content: 'ğŸ¨';
            font-size: 1.2em;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            background: white;
            box-sizing: border-box;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }
        
        .template-sections {
            margin: 25px 0;
        }
        
        .template-section {
            background: #ffffff;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
            border: 1px solid #e2e8f0;
            position: relative;
            z-index: 5;
        }
        
        .template-section h3 {
            color: #4b5563;
            margin-bottom: 15px;
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        @media (max-width: 768px) {
            .input-row {
                grid-template-columns: 1fr;
            }
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
            color: white;
        }
        
        .btn-info {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            color: white;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e2e8f0;
        }
        
        .preview-area {
            background: #f7fafc;
            border-radius: 15px;
            padding: 20px;
            border: 2px dashed #cbd5e0;
            min-height: 400px;
        }
        
        .preview-frame {
            width: 100%;
            height: 600px;
            border: none;
            border-radius: 10px;
            background: white;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        /* æ ¹æœ¬è§£æ±º: å±¥æ­´ã‚¹ã‚¿ã‚¤ãƒ« */
        .new-history-item {
            background: #ffffff !important;
            border: 2px solid #d1d5db !important;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 5px solid #3b82f6 !important;
        }
        
        .new-history-title {
            font-size: 1.2rem !important;
            font-weight: 700 !important;
            color: #000000 !important;
            margin-bottom: 10px;
        }
        
        .new-history-info {
            font-size: 1rem !important;
            color: #000000 !important;
            line-height: 1.6;
            font-weight: 600 !important;
        }
        
        .new-status-sent {
            display: inline-block !important;
            background: #059669 !important;
            color: #ffffff !important;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9rem !important;
            font-weight: 600 !important;
            margin-left: 10px;
        }
        
        /* å‰Šé™¤æ¸ˆã¿ - æ–°ã—ã„ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¹ã‚¿ã‚¤ãƒ«ã‚’ä½¿ç”¨ */
        
        .new-no-history {
            text-align: center;
            color: #000000 !important;
            font-weight: 700 !important;
            padding: 40px 20px;
            background: #ffffff !important;
            border-radius: 10px;
            border: 2px solid #d1d5db !important;
            font-size: 1.2rem !important;
        }
        
        /* å¼·åˆ¶çš„ã«ã™ã¹ã¦ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’è¦‹ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹ */
        #newHistoryArea * {
            color: #000000 !important;
            background-color: transparent !important;
        }
        
        .error {
            color: #dc2626;
            background: #fee2e2;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #fca5a5;
            font-weight: 500;
        }
        
        /* å¤ã„ã‚¹ã‚¿ã‚¤ãƒ«å‰Šé™¤æ¸ˆã¿ - æ–°ã—ã„ã‚·ãƒ³ãƒ—ãƒ«ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ä½¿ç”¨ */
        
        @media (max-width: 768px) {
            .new-history-item {
                padding: 15px;
            }
            
            .new-history-title {
                font-size: 1.1rem;
            }
            
            .new-history-info {
                font-size: 0.95rem;
            }
        }

        /* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼é–¢é€£ã‚¹ã‚¿ã‚¤ãƒ« */
        .progress-step {
            padding: 5px 0;
            display: flex;
            align-items: center;
            transition: color 0.3s ease;
        }

        .progress-step.completed {
            color: #059669 !important;
        }

        .progress-step.active {
            color: #0ea5e9 !important;
            font-weight: 600;
        }

        .progress-step.failed {
            color: #dc2626 !important;
        }

        .progress-step::before {
            content: "";
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
            background: currentColor;
            opacity: 0.6;
        }

        .progress-step.completed::before {
            background: #059669;
            opacity: 1;
        }

        .progress-step.active::before {
            background: #0ea5e9;
            opacity: 1;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .current-time {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-family: monospace;
            font-size: 0.9rem;
            text-align: center;
            margin: 20px 0;
        }
        
        /* ãƒ¢ãƒ€ãƒ³ãªã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .campaign-preview {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            padding: 30px;
            border-radius: 20px;
            margin: 20px 0;
            position: relative;
            overflow: hidden;
        }
        
        .campaign-preview::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.1);
            transform: rotate(45deg);
        }
        
        .campaign-title {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 15px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .price-showcase {
            display: flex;
            align-items: center;
            gap: 20px;
            margin: 20px 0;
        }
        
        .old-price {
            font-size: 1.5rem;
            text-decoration: line-through;
            opacity: 0.7;
        }
        
        .new-price {
            font-size: 2.5rem;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .discount-badge {
            background: #10b981;
            padding: 8px 16px;
            border-radius: 25px;
            font-weight: bold;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½ã®æ”¹å–„ */
        .preview-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .preview-help {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            color: #1565c0;
        }
        
        .preview-help h4 {
            margin: 0 0 10px 0;
            color: #0d47a1;
        }
        
        .preview-placeholder {
            text-align: center;
            color: #718096;
            padding: 60px 20px;
            border: 2px dashed #cbd5e0;
            border-radius: 15px;
            background: #f7fafc;
        }
        
        .preview-placeholder::before {
            content: 'ğŸ”';
            font-size: 3rem;
            display: block;
            margin-bottom: 15px;
        }
    </style>
    
    <div class="newsletter-admin">
        <div class="admin-header">
            <h1>ğŸ“§ ãƒ¡ãƒ«ãƒã‚¬é…ä¿¡ç®¡ç†</h1>
            <p class="subtitle">NANKANã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ã®ãƒ¡ãƒ¼ãƒ«ãƒã‚¬ã‚¸ãƒ³ã‚’é…ä¿¡</p>
        </div>

        <div class="admin-container">
            <!-- é…ä¿¡ãƒ•ã‚©ãƒ¼ãƒ  -->
            <div class="card">
                <h2>æ–°è¦é…ä¿¡ä½œæˆ</h2>
                
                <div class="form-group">
                    <label for="subject">ä»¶å</label>
                    <input type="text" id="subject" placeholder="ä¾‹: ã€NANKANã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ã€‘æœ¬æ—¥ã®æ³¨ç›®ãƒ¬ãƒ¼ã‚¹äºˆæƒ³" />
                </div>

                <div class="form-group">
                    <label for="targetPlan">é…ä¿¡å¯¾è±¡</label>
                    <select id="targetPlan">
                        <option value="all">å…¨ä¼šå“¡</option>
                        <option value="free">ç„¡æ–™ä¼šå“¡ã®ã¿</option>
                        <option value="paid">æœ‰æ–™ä¼šå“¡ã®ã¿ï¼ˆStandard + Premiumï¼‰</option>
                        <option value="standard">Standardä¼šå“¡ã®ã¿</option>
                        <option value="premium">Premiumä¼šå“¡ã®ã¿</option>
                        <option value="segment">ã‚«ã‚¹ã‚¿ãƒ ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ</option>
                    </select>
                </div>
                
                <!-- ã‚«ã‚¹ã‚¿ãƒ ã‚»ã‚°ãƒ¡ãƒ³ãƒˆè¨­å®š -->
                <div id="segmentSection" style="display: none;" class="form-group">
                    <label style="color: #374151; font-weight: 600;">ğŸ¯ ã‚»ã‚°ãƒ¡ãƒ³ãƒˆæ¡ä»¶</label>
                    <div style="background: #f0f9ff; padding: 20px; border-radius: 8px; border: 2px solid #0ea5e9;">
                        
                        <div style="display: grid; gap: 15px;">
                            <!-- ç™»éŒ²æ—¥ã«ã‚ˆã‚‹çµã‚Šè¾¼ã¿ -->
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #0c4a6e;">ğŸ“… ç™»éŒ²æ—¥</label>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                    <input type="date" id="segmentDateFrom" placeholder="é–‹å§‹æ—¥">
                                    <input type="date" id="segmentDateTo" placeholder="çµ‚äº†æ—¥">
                                </div>
                                <small style="color: #0369a1;">æŒ‡å®šã—ãŸæœŸé–“ã«ç™»éŒ²ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ã«é…ä¿¡</small>
                            </div>
                            
                            <!-- ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã«ã‚ˆã‚‹çµã‚Šè¾¼ã¿ -->
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #0c4a6e;">âš¡ ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£</label>
                                <select id="segmentActivity">
                                    <option value="">åˆ¶é™ãªã—</option>
                                    <option value="active">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆ7æ—¥ä»¥å†…ãƒ­ã‚°ã‚¤ãƒ³ï¼‰</option>
                                    <option value="inactive">éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆ7æ—¥ä»¥ä¸Šæœªãƒ­ã‚°ã‚¤ãƒ³ï¼‰</option>
                                    <option value="new">æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆ3æ—¥ä»¥å†…ç™»éŒ²ï¼‰</option>
                                </select>
                                <small style="color: #0369a1;">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£çŠ¶æ³ã§çµã‚Šè¾¼ã¿</small>
                            </div>
                            
                            <!-- ãƒ¡ãƒ¼ãƒ«é…ä¿¡æ­´ã«ã‚ˆã‚‹çµã‚Šè¾¼ã¿ -->
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #0c4a6e;">ğŸ“§ é…ä¿¡å±¥æ­´</label>
                                <select id="segmentEmailHistory">
                                    <option value="">åˆ¶é™ãªã—</option>
                                    <option value="no-email">æœªé…ä¿¡ãƒ¦ãƒ¼ã‚¶ãƒ¼</option>
                                    <option value="recent-email">æœ€è¿‘é…ä¿¡æ¸ˆã¿ï¼ˆ3æ—¥ä»¥å†…ï¼‰</option>
                                    <option value="old-email">é…ä¿¡ã‹ã‚‰æ™‚é–“ãŒçµŒéï¼ˆ7æ—¥ä»¥ä¸Šï¼‰</option>
                                </select>
                                <small style="color: #0369a1;">éå»ã®ãƒ¡ãƒ¼ãƒ«é…ä¿¡çŠ¶æ³ã§çµã‚Šè¾¼ã¿</small>
                            </div>
                            
                            <!-- ã‚«ã‚¹ã‚¿ãƒ ã‚¿ã‚° -->
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #0c4a6e;">ğŸ·ï¸ ã‚«ã‚¹ã‚¿ãƒ ã‚¿ã‚°</label>
                                <input type="text" id="segmentTags" placeholder="ä¾‹: VIP,é–¢æ±,ç«¶é¦¬å¥½ãï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰">
                                <small style="color: #0369a1;">ç‰¹å®šã®ã‚¿ã‚°ã‚’æŒã¤ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ã«é…ä¿¡</small>
                            </div>
                            
                            <!-- é™¤å¤–æ¡ä»¶ -->
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #dc2626;">âŒ é™¤å¤–æ¡ä»¶</label>
                                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                    <label style="display: flex; align-items: center; gap: 5px;">
                                        <input type="checkbox" id="excludeBounced" style="margin: 0;">
                                        <span>é…ä¿¡å¤±æ•—å±¥æ­´ã‚ã‚Š</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 5px;">
                                        <input type="checkbox" id="excludeUnsubscribed" style="margin: 0;">
                                        <span>é…ä¿¡åœæ­¢æ¸ˆã¿</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 5px;">
                                        <input type="checkbox" id="excludeInactive" style="margin: 0;">
                                        <span>30æ—¥ä»¥ä¸Šæœªãƒ­ã‚°ã‚¤ãƒ³</span>
                                    </label>
                                </div>
                                <small style="color: #991b1b;">ãƒã‚§ãƒƒã‚¯ã—ãŸæ¡ä»¶ã«è©²å½“ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é™¤å¤–</small>
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #0ea5e9;">
                            <button id="previewSegmentBtn" class="btn btn-info" style="margin-right: 10px;">ğŸ‘€ å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèª</button>
                            <span id="segmentCount" style="color: #0c4a6e; font-weight: 600;"></span>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="templateType">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¿ã‚¤ãƒ—</label>
                    <select id="templateType">
                        <option value="prediction">äºˆæƒ³é…ä¿¡</option>
                        <option value="result">çµæœå ±å‘Š</option>
                        <option value="campaign">ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³</option>
                        <option value="custom">ã‚«ã‚¹ã‚¿ãƒ </option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="layoutOrder">ğŸ“‹ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆé †åº</label>
                    <select id="layoutOrder">
                        <option value="content-first">æœ¬æ–‡ â†’ äºˆæƒ³æƒ…å ±</option>
                        <option value="prediction-first">äºˆæƒ³æƒ…å ± â†’ æœ¬æ–‡</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="mainContent">æœ¬æ–‡</label>
                    <textarea id="mainContent" rows="8" placeholder="ãƒ¡ãƒ¼ãƒ«ã®æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
                </div>

                <!-- äºˆæƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆäºˆæƒ³é…ä¿¡ã‚¿ã‚¤ãƒ—ã®å ´åˆï¼‰ -->
                <div id="predictionSection">
                    <h3 style="color: #4b5563; font-weight: 600; font-size: 1.2rem;">ğŸ¯ äºˆæƒ³æƒ…å ±</h3>
                    <div id="predictionsContainer">
                        <div class="prediction-input">
                            <input type="text" placeholder="ãƒ¬ãƒ¼ã‚¹åï¼ˆä¾‹: ç¬¬11R ãƒ¡ã‚¤ãƒ³ãƒ¬ãƒ¼ã‚¹ï¼‰" class="race-name" />
                            <textarea placeholder="äºˆæƒ³é¦¬ï¼ˆæ”¹è¡ŒåŒºåˆ‡ã‚Šï¼‰" rows="3" class="race-horses"></textarea>
                        </div>
                    </div>
                    <button type="button" id="addPrediction" class="btn-secondary">+ äºˆæƒ³ã‚’è¿½åŠ </button>
                    
                    <div class="form-group" style="margin-top: 20px;">
                        <label for="predictionNote">ğŸ“ äºˆæƒ³è£œè¶³ãƒ»è¿½è¨˜</label>
                        <textarea id="predictionNote" rows="3" placeholder="äºˆæƒ³ã®è£œè¶³æƒ…å ±ã€æ³¨æ„ç‚¹ã€æˆ¦ç•¥èª¬æ˜ãªã©ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰"></textarea>
                    </div>
                    
                    <div class="form-group" style="margin-top: 15px;">
                        <label for="additionalSection">ğŸ“„ è¿½åŠ ã‚»ã‚¯ã‚·ãƒ§ãƒ³</label>
                        <textarea id="additionalSection" rows="4" placeholder="äºˆæƒ³æƒ…å ±ã®å¾Œã«è¡¨ç¤ºã™ã‚‹è¿½åŠ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰&#13;&#10;ä¾‹ï¼šé‡è¦ãªãŠçŸ¥ã‚‰ã›ã€ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³æƒ…å ±ã€æ³¨æ„äº‹é …ãªã©"></textarea>
                    </div>
                </div>

                <!-- çµæœå ±å‘Šã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆçµæœå ±å‘Šã‚¿ã‚¤ãƒ—ã®å ´åˆï¼‰ -->
                <div id="resultSection" style="display: none;">
                    <h3 style="color: #4b5563; font-weight: 600; font-size: 1.2rem;">ğŸ“Š æ˜¨æ—¥ã®çµæœ</h3>
                    <div id="resultsContainer">
                        <div class="result-input">
                            <input type="text" placeholder="ãƒ¬ãƒ¼ã‚¹åï¼ˆä¾‹: ç¬¬11R ãƒ¡ã‚¤ãƒ³ãƒ¬ãƒ¼ã‚¹ï¼‰" class="result-race-name" />
                            <div class="result-details">
                                <input type="text" placeholder="1ç€é¦¬" class="result-winner" />
                                <input type="text" placeholder="é…å½“ï¼ˆä¾‹: Â¥1,200ï¼‰" class="result-payout" />
                                <select class="result-status">
                                    <option value="hit">ğŸ¯ çš„ä¸­ï¼</option>
                                    <option value="miss">âŒ ä¸çš„ä¸­</option>
                                    <option value="near">ğŸ“ˆ æƒœã—ã„ï¼</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <button type="button" id="addResult" class="btn-secondary">+ çµæœã‚’è¿½åŠ </button>
                    <div class="total-stats">
                        <input type="text" placeholder="ä»Šæœˆã®çš„ä¸­ç‡ï¼ˆä¾‹: 78%ï¼‰" id="monthlyHitRate" />
                        <input type="text" placeholder="ä»Šæœˆã®åæ”¯ï¼ˆä¾‹: +Â¥45,600ï¼‰" id="monthlyProfit" />
                    </div>
                </div>

                <!-- ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã‚¿ã‚¤ãƒ—ã®å ´åˆï¼‰ -->
                <div id="campaignSection" style="display: none;">
                    <h3 style="color: #4b5563; font-weight: 600; font-size: 1.2rem;">ğŸª ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³æƒ…å ±</h3>
                    <div class="campaign-inputs">
                        <input type="text" placeholder="ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³åï¼ˆä¾‹: é™å®š50åï¼ç‰¹åˆ¥äºˆæƒ³ãƒ—ãƒ©ãƒ³ï¼‰" id="campaignTitle" />
                        <textarea placeholder="ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³è©³ç´°ãƒ»ç‰¹å…¸å†…å®¹" rows="3" id="campaignDetails"></textarea>
                        <input type="text" placeholder="é€šå¸¸ä¾¡æ ¼ï¼ˆä¾‹: Â¥9,980ï¼‰" id="originalPrice" />
                        <input type="text" placeholder="ç‰¹åˆ¥ä¾¡æ ¼ï¼ˆä¾‹: Â¥4,980ï¼‰" id="campaignPrice" />
                        <input type="text" placeholder="æœŸé™ï¼ˆä¾‹: 12æœˆ31æ—¥ã¾ã§ï¼‰" id="campaignDeadline" />
                        <input type="text" placeholder="CTAãƒœã‚¿ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼ˆä¾‹: ğŸ¯ é™å®šã‚ªãƒ•ã‚¡ãƒ¼ã‚’ç¢ºèªã™ã‚‹ï¼‰" id="ctaText" />
                        <input type="url" placeholder="CTAãƒœã‚¿ãƒ³ãƒªãƒ³ã‚¯å…ˆURL" id="ctaUrl" />
                    </div>
                </div>

                <!-- ã‚«ã‚¹ã‚¿ãƒ ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã‚«ã‚¹ã‚¿ãƒ ã‚¿ã‚¤ãƒ—ã®å ´åˆï¼‰ -->
                <div id="customSection" style="display: none;">
                    <h3 style="color: #4b5563; font-weight: 600; font-size: 1.2rem;">ğŸ¨ ã‚«ã‚¹ã‚¿ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ</h3>
                    <div class="custom-inputs">
                        <label style="color: #374151; font-weight: 600;">èƒŒæ™¯è‰²ãƒ†ãƒ¼ãƒ</label>
                        <select id="customTheme">
                            <option value="default">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ</option>
                            <option value="gold">ğŸ† ã‚´ãƒ¼ãƒ«ãƒ‰ï¼ˆå‹åˆ©æ„Ÿï¼‰</option>
                            <option value="red">ğŸ”¥ ãƒ¬ãƒƒãƒ‰ï¼ˆç·Šæ€¥æ„Ÿï¼‰</option>
                            <option value="blue">ğŸ’ ãƒ–ãƒ«ãƒ¼ï¼ˆä¿¡é ¼æ„Ÿï¼‰</option>
                        </select>
                        
                        <label style="color: #374151; font-weight: 600;">ç‰¹åˆ¥è¦‹å‡ºã—</label>
                        <input type="text" placeholder="ç‰¹åˆ¥è¦‹å‡ºã—ï¼ˆä¾‹: ğŸš¨ ç·Šæ€¥é€Ÿå ±ï¼ï¼‰" id="customHeadline" />
                        
                        <label style="color: #374151; font-weight: 600;">ã‚¢ã‚¯ã‚»ãƒ³ãƒˆæƒ…å ±</label>
                        <textarea placeholder="å¼·èª¿ã—ãŸã„æƒ…å ±ãƒ»æ•°å­—ãƒ»å®Ÿç¸¾" rows="2" id="customAccent"></textarea>
                        
                        <label style="color: #374151; font-weight: 600;">è¿½åŠ CTA</label>
                        <input type="text" placeholder="è¿½åŠ ãƒœã‚¿ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ" id="customSectionCtaText" />
                        <input type="url" placeholder="è¿½åŠ ãƒœã‚¿ãƒ³URL" id="customSectionCtaUrl" />
                    </div>
                </div>

                <!-- CTAãƒœã‚¿ãƒ³è¨­å®š -->
                <div class="form-group" style="background: #f8fafc; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0;">
                    <h3 style="color: #4b5563; font-weight: 600; font-size: 1.1rem; margin-bottom: 15px;">ğŸ¯ CTAãƒœã‚¿ãƒ³è¨­å®š</h3>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="showCtaButton" checked style="width: 18px; height: 18px;">
                            <span>CTAãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã™ã‚‹</span>
                        </label>
                    </div>
                    
                    <div id="ctaButtonSettings">
                        <div style="display: grid; gap: 12px;">
                            <input type="text" id="customCtaText" placeholder="ãƒœã‚¿ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼ˆä¾‹: ğŸ‡ æœ‰æ–™ãƒ—ãƒ©ãƒ³ã§å…¨ãƒ¬ãƒ¼ã‚¹äºˆæƒ³ã‚’è¦‹ã‚‹ï¼‰" />
                            <input type="url" id="customCtaUrl" placeholder="ãƒªãƒ³ã‚¯å…ˆURL" value="https://nankan-analytics.keiba.link/pricing/" />
                        </div>
                    </div>
                </div>

                <!-- âš ï¸ Brevoåˆ¶ç´„è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
                <div style="background: linear-gradient(135deg, #dc2626, #ef4444); border-radius: 10px; padding: 20px; margin-bottom: 20px; color: white; border: 2px solid #b91c1c;">
                    <h3 style="margin: 0 0 15px 0; color: white; font-weight: 600;">âš ï¸ é‡è¦ï¼šäºˆç´„é…ä¿¡åˆ¶é™ã«ã¤ã„ã¦</h3>
                    <div style="background: rgba(255,255,255,0.15); border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <h4 style="margin: 0 0 10px 0; color: white;">ğŸš¨ ç¾åœ¨ç¢ºèªã•ã‚Œã¦ã„ã‚‹å•é¡Œ</h4>
                        <ul style="margin: 0; padding-left: 20px; color: rgba(255,255,255,0.9);">
                            <li><strong>Brevo APIåˆ¶é™</strong>: 72æ™‚é–“ä»¥ä¸Šå…ˆã®äºˆç´„é…ä¿¡ãŒå¤±æ•—ã™ã‚‹</li>
                            <li><strong>é…ä¿¡æœªåˆ°é”</strong>: UIä¸Šã¯ã€ŒæˆåŠŸã€è¡¨ç¤ºã ãŒå®Ÿéš›ã¯é…ä¿¡ã•ã‚Œãªã„</li>
                            <li><strong>å±¥æ­´ä¸æ•´åˆ</strong>: é…ä¿¡å±¥æ­´ãŒå®Ÿéš›ã®çŠ¶æ³ã¨ç•°ãªã‚‹</li>
                        </ul>
                    </div>
                    <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 12px; text-align: center;">
                        <div style="font-weight: 600; margin-bottom: 5px;">ğŸ› ï¸ æ¨å¥¨å¯¾å‡¦æ³•</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">72æ™‚é–“ä»¥å†…ã®äºˆç´„é…ä¿¡ã®ã¿åˆ©ç”¨ã™ã‚‹ã‹ã€æ‰‹å‹•ã§ã®å³æ™‚é…ä¿¡ã‚’æ¨å¥¨</div>
                    </div>
                </div>

                <!-- é«˜åº¦ãªé…ä¿¡ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­å®š -->
                <div style="background: #f8fafc; border-radius: 10px; padding: 20px; margin-bottom: 20px; border: 2px solid #cbd5e0;">
                    <h3 style="margin: 0 0 15px 0; color: #1e40af; font-weight: 600;">ğŸ“… é…ä¿¡ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­å®š <span style="color: #dc2626; font-size: 0.8rem;">(âš ï¸åˆ¶é™ã‚ã‚Š)</span></h3>
                    
                    <!-- å³æ™‚/äºˆç´„é¸æŠ -->
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="radio" name="scheduleType" value="immediate" checked id="scheduleImmediate" style="margin: 0;">
                                <span style="font-weight: 600; color: #059669;">ğŸš€ å³æ™‚é…ä¿¡</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="radio" name="scheduleType" value="scheduled" id="scheduleReserved" style="margin: 0;">
                                <span style="font-weight: 600; color: #3b82f6;">ğŸ“… äºˆç´„é…ä¿¡</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="radio" name="scheduleType" value="recurring" id="scheduleRecurring" style="margin: 0;">
                                <span style="font-weight: 600; color: #7c3aed;">ğŸ”„ å®šæœŸé…ä¿¡</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- äºˆç´„é…ä¿¡è¨­å®š -->
                    <div id="scheduledSection" style="display: none; background: white; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <h4 style="margin: 0 0 15px 0; color: #0c4a6e;">ğŸ“… äºˆç´„é…ä¿¡è¨­å®š</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">é…ä¿¡æ—¥æ™‚</label>
                                <input type="datetime-local" id="scheduledAt" style="width: 100%; padding: 8px; border: 2px solid #d1d5db; border-radius: 6px;" />
                                <div id="scheduleWarning" style="display: none; margin-top: 8px; padding: 8px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 4px; color: #dc2626; font-size: 0.8rem;">
                                    âš ï¸ 72æ™‚é–“ä»¥ä¸Šå…ˆã®äºˆç´„ã¯é…ä¿¡ã•ã‚Œãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™
                                </div>
                                <div id="scheduleValid" style="display: none; margin-top: 8px; padding: 8px; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 4px; color: #16a34a; font-size: 0.8rem;">
                                    âœ… ã“ã®æ™‚é–“ãªã‚‰æ­£å¸¸ã«é…ä¿¡ã•ã‚Œã¾ã™
                                </div>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³</label>
                                <select id="scheduleTimezone" style="width: 100%; padding: 8px; border: 2px solid #d1d5db; border-radius: 6px;">
                                    <option value="Asia/Tokyo">æ—¥æœ¬æ™‚é–“ (JST)</option>
                                    <option value="UTC">å”å®šä¸–ç•Œæ™‚ (UTC)</option>
                                    <option value="America/New_York">ãƒ‹ãƒ¥ãƒ¼ãƒ¨ãƒ¼ã‚¯æ™‚é–“</option>
                                    <option value="Europe/London">ãƒ­ãƒ³ãƒ‰ãƒ³æ™‚é–“</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- ã‚¯ã‚¤ãƒƒã‚¯è¨­å®šãƒœã‚¿ãƒ³ -->
                        <div style="margin-top: 15px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #6b7280;">ã‚¯ã‚¤ãƒƒã‚¯è¨­å®š:</label>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button type="button" id="schedule1Hour" class="btn" style="padding: 5px 10px; font-size: 0.8rem; background: #f3f4f6;">+1æ™‚é–“</button>
                                <button type="button" id="schedule3Hours" class="btn" style="padding: 5px 10px; font-size: 0.8rem; background: #f3f4f6;">+3æ™‚é–“</button>
                                <button type="button" id="scheduleTomorrow9AM" class="btn" style="padding: 5px 10px; font-size: 0.8rem; background: #f3f4f6;">æ˜æ—¥9æ™‚</button>
                                <button type="button" id="scheduleMonday9AM" class="btn" style="padding: 5px 10px; font-size: 0.8rem; background: #f3f4f6;">æ¥é€±æœˆæ›œ9æ™‚</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- å®šæœŸé…ä¿¡è¨­å®š -->
                    <div id="recurringSection" style="display: none; background: white; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <h4 style="margin: 0 0 15px 0; color: #7c2d12;">ğŸ”„ å®šæœŸé…ä¿¡è¨­å®š</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">é…ä¿¡é »åº¦</label>
                                <select id="recurringFrequency" style="width: 100%; padding: 8px; border: 2px solid #d1d5db; border-radius: 6px;">
                                    <option value="daily">æ¯æ—¥</option>
                                    <option value="weekly">æ¯é€±</option>
                                    <option value="monthly">æ¯æœˆ</option>
                                    <option value="custom">ã‚«ã‚¹ã‚¿ãƒ </option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">é…ä¿¡æ™‚åˆ»</label>
                                <input type="time" id="recurringTime" value="09:00" style="width: 100%; padding: 8px; border: 2px solid #d1d5db; border-radius: 6px;" />
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">é–‹å§‹æ—¥</label>
                                <input type="date" id="recurringStartDate" style="width: 100%; padding: 8px; border: 2px solid #d1d5db; border-radius: 6px;" />
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">çµ‚äº†æ—¥ (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)</label>
                                <input type="date" id="recurringEndDate" style="width: 100%; padding: 8px; border: 2px solid #d1d5db; border-radius: 6px;" />
                            </div>
                        </div>
                        
                        <!-- é€±é–“ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« (é€±å˜ä½ã®å ´åˆ) -->
                        <div id="weeklySchedule" style="display: none; margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">é…ä¿¡ã™ã‚‹æ›œæ—¥:</label>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <label style="display: flex; align-items: center; gap: 5px;"><input type="checkbox" value="1" id="recurMon"> æœˆ</label>
                                <label style="display: flex; align-items: center; gap: 5px;"><input type="checkbox" value="2" id="recurTue"> ç«</label>
                                <label style="display: flex; align-items: center; gap: 5px;"><input type="checkbox" value="3" id="recurWed"> æ°´</label>
                                <label style="display: flex; align-items: center; gap: 5px;"><input type="checkbox" value="4" id="recurThu"> æœ¨</label>
                                <label style="display: flex; align-items: center; gap: 5px;"><input type="checkbox" value="5" id="recurFri"> é‡‘</label>
                                <label style="display: flex; align-items: center; gap: 5px;"><input type="checkbox" value="6" id="recurSat"> åœŸ</label>
                                <label style="display: flex; align-items: center; gap: 5px;"><input type="checkbox" value="0" id="recurSun"> æ—¥</label>
                            </div>
                        </div>
                        
                        <!-- å®šæœŸé…ä¿¡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
                        <div id="recurringPreview" style="background: #fef3c7; padding: 10px; border-radius: 6px; border-left: 4px solid #f59e0b;">
                            <strong style="color: #92400e;">ğŸ“‹ é…ä¿¡äºˆå®š:</strong>
                            <div id="recurringPreviewText" style="color: #78350f; margin-top: 5px;">è¨­å®šã‚’é¸æŠã—ã¦ãã ã•ã„</div>
                        </div>
                    </div>
                    
                    <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
                    <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem;">
                        <div>
                            <strong style="color: #374151;">ç¾åœ¨æ™‚åˆ»:</strong> 
                            <span id="currentTime" style="color: #4b5563;">--:--</span> (JST)
                        </div>
                        <div id="scheduleStatus" style="padding: 5px 10px; border-radius: 4px; font-weight: 600;">
                            ğŸš€ å³æ™‚é…ä¿¡
                        </div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button id="previewBtn" class="btn btn-secondary">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
                    <button id="clearPreviewBtn" class="btn btn-secondary">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ã‚¯ãƒªã‚¢</button>
                    <button id="testSendBtn" class="btn btn-warning">ğŸ“§ ãƒ†ã‚¹ãƒˆé€ä¿¡</button>
                    <button id="saveTemplateBtn" class="btn btn-info">ğŸ’¾ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¿å­˜</button>
                    <button id="loadTemplateBtn" class="btn btn-info">ğŸ“‚ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆèª­è¾¼</button>
                    <button id="sendBtn" class="btn btn-primary">é…ä¿¡å®Ÿè¡Œ</button>
                </div>
                
                <!-- é…ä¿¡ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ -->
                <div id="sendProgressArea" style="display: none; margin-top: 20px; background: #f0f9ff; border-radius: 10px; padding: 20px; border: 2px solid #0ea5e9;">
                    <h4 style="margin: 0 0 15px 0; color: #0c4a6e; font-weight: 600;">ğŸ“Š é…ä¿¡é€²è¡ŒçŠ¶æ³</h4>
                    
                    <!-- å…¨ä½“ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ -->
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <span id="progressLabel" style="font-weight: 600; color: #374151;">æº–å‚™ä¸­...</span>
                            <span id="progressPercentage" style="font-weight: 600; color: #0ea5e9;">0%</span>
                        </div>
                        <div style="background: #e0f2fe; height: 12px; border-radius: 6px; overflow: hidden;">
                            <div id="progressBar" style="background: linear-gradient(90deg, #0ea5e9, #06b6d4); height: 100%; width: 0%; transition: width 0.3s ease; border-radius: 6px;"></div>
                        </div>
                    </div>
                    
                    <!-- è©³ç´°ã‚¹ãƒ†ãƒƒãƒ— -->
                    <div id="progressSteps" style="font-size: 0.9rem; color: #475569;">
                        <div id="step1" class="progress-step">â³ ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ä¸­...</div>
                        <div id="step2" class="progress-step">â³ å—ä¿¡è€…ãƒªã‚¹ãƒˆæº–å‚™ä¸­...</div>
                        <div id="step3" class="progress-step">â³ ãƒ¡ãƒ¼ãƒ«é€ä¿¡ä¸­...</div>
                        <div id="step4" class="progress-step">â³ çµæœç¢ºèªä¸­...</div>
                    </div>
                    
                    <!-- é€ä¿¡çµ±è¨ˆ -->
                    <div id="progressStats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-top: 15px; padding: 15px; background: white; border-radius: 8px;">
                        <div style="text-align: center;">
                            <div style="font-size: 1.5em; font-weight: bold; color: #059669;" id="sentCount">0</div>
                            <div style="font-size: 0.8em; color: #6b7280;">é€ä¿¡æ¸ˆã¿</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.5em; font-weight: bold; color: #dc2626;" id="failedCount">0</div>
                            <div style="font-size: 0.8em; color: #6b7280;">å¤±æ•—</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.5em; font-weight: bold; color: #3b82f6;" id="remainingCount">0</div>
                            <div style="font-size: 0.8em; color: #6b7280;">æ®‹ã‚Š</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.5em; font-weight: bold; color: #7c3aed;" id="estimatedTime">--</div>
                            <div style="font-size: 0.8em; color: #6b7280;">äºˆæƒ³æ™‚é–“</div>
                        </div>
                    </div>
                    
                    <!-- ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ -->
                    <div style="text-align: center; margin-top: 15px;">
                        <button id="cancelSendBtn" class="btn btn-secondary" style="display: none;">âŒ é…ä¿¡ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        <button id="hideProgressBtn" class="btn btn-secondary" style="display: none;">ğŸ“Š å®Œäº† - ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ã‚’é–‰ã˜ã‚‹</button>
                    </div>
                </div>
            </div>

            <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ -->
            <div class="card">
                <h2>ãƒ¡ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
                
                <div class="preview-help">
                    <h4>ğŸ’¬ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½ã®ä½¿ã„æ–¹</h4>
                    <p><strong>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç¢ºèª</strong>: å·¦ã®ã€Œæ–°è¦é…ä¿¡ä½œæˆã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã€Œãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã€ãƒœã‚¿ãƒ³ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„</p>
                    <p>å…¥åŠ›å†…å®¹ã‚’å¤‰æ›´ã—ãŸå ´åˆã¯ã€å†åº¦ã€Œãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦æ›´æ–°ã—ã¦ãã ã•ã„ã€‚</p>
                </div>
                
                <div id="previewArea" class="preview-area">
                    <div class="preview-placeholder">
                        ãƒ¡ãƒ¼ãƒ«ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤ºã—ã¾ã™<br>
                        <small>ä¸Šã®ã€Œãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯</small>
                    </div>
                    <iframe id="previewFrame" class="preview-frame" style="display: none;"></iframe>
                </div>
            </div>

            <!-- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é…ä¿¡ãƒ¢ãƒ‹ã‚¿ -->
            <div class="card">
                <h2 style="color: #0ea5e9; font-weight: 600;">ğŸ“Š ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é…ä¿¡ãƒ¢ãƒ‹ã‚¿</h2>
                <div style="background: linear-gradient(135deg, #0ea5e9 0%, #3b82f6 100%); border-radius: 10px; padding: 20px; margin-bottom: 20px; color: white;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <!-- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ çµ±è¨ˆ -->
                        <div style="text-align: center;">
                            <div style="font-size: 2.5em; font-weight: bold;" id="realtimeSentToday">0</div>
                            <div style="opacity: 0.9;">ä»Šæ—¥ã®é…ä¿¡æ•°</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2.5em; font-weight: bold;" id="realtimeSuccessRate">100%</div>
                            <div style="opacity: 0.9;">æˆåŠŸç‡</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2.5em; font-weight: bold;" id="realtimeActiveUsers">--</div>
                            <div style="opacity: 0.9;">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2.5em; font-weight: bold;" id="realtimeQueueSize">0</div>
                            <div style="opacity: 0.9;">é…ä¿¡ã‚­ãƒ¥ãƒ¼</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: center; opacity: 0.8;">
                        æœ€çµ‚æ›´æ–°: <span id="realtimeLastUpdate">--:--:--</span> | 
                        <span id="realtimeStatus" style="font-weight: 600;">ğŸŸ¢ ã‚·ã‚¹ãƒ†ãƒ æ­£å¸¸</span>
                    </div>
                </div>
                
                <!-- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é…ä¿¡ãƒ­ã‚° -->
                <div style="background: #f8fafc; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0; color: #0f172a;">ğŸ“‹ é…ä¿¡ãƒ­ã‚° (ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ )</h3>
                        <div style="display: flex; gap: 10px;">
                            <button id="realtimeAutoRefresh" class="btn btn-info" style="padding: 5px 10px; font-size: 0.8rem;">ğŸ”„ è‡ªå‹•æ›´æ–° ON</button>
                            <button id="realtimeClearLog" class="btn btn-secondary" style="padding: 5px 10px; font-size: 0.8rem;">ğŸ—‘ï¸ ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
                        </div>
                    </div>
                    
                    <div id="realtimeLogArea" style="background: #1e293b; border-radius: 6px; padding: 15px; max-height: 300px; overflow-y: auto; font-family: 'SF Mono', 'Monaco', monospace; font-size: 0.85rem; line-height: 1.4;">
                        <div style="color: #64748b;">ğŸ“Š ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ­ã‚°ã‚’ç›£è¦–ä¸­...</div>
                        <div style="color: #10b981;">âœ… ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†</div>
                        <div style="color: #64748b;">[<span id="initTime"></span>] ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°é–‹å§‹</div>
                    </div>
                </div>
                
                <!-- ã‚·ã‚¹ãƒ†ãƒ å¥åº·çŠ¶æ…‹ -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <!-- ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹ -->
                    <div style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h4 style="margin: 0 0 15px 0; color: #0c4a6e;">ğŸ“§ ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚µãƒ¼ãƒ“ã‚¹</h4>
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <div id="emailServiceStatus" style="width: 12px; height: 12px; background: #10b981; border-radius: 50%; animation: pulse 2s infinite;"></div>
                            <span style="font-weight: 600;">Brevo API</span>
                            <span id="emailServiceText" style="color: #059669;">æ­£å¸¸ç¨¼åƒ</span>
                        </div>
                        <div style="font-size: 0.9rem; color: #6b7280;">
                            å¿œç­”æ™‚é–“: <span id="emailServiceLatency">--ms</span><br>
                            æœ€çµ‚ãƒã‚§ãƒƒã‚¯: <span id="emailServiceLastCheck">--:--</span>
                        </div>
                    </div>
                    
                    <!-- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çŠ¶æ…‹ -->
                    <div style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h4 style="margin: 0 0 15px 0; color: #7c2d12;">ğŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹</h4>
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <div id="databaseStatus" style="width: 12px; height: 12px; background: #10b981; border-radius: 50%; animation: pulse 2s infinite;"></div>
                            <span style="font-weight: 600;">Airtable</span>
                            <span id="databaseText" style="color: #059669;">æ¥ç¶šæ­£å¸¸</span>
                        </div>
                        <div style="font-size: 0.9rem; color: #6b7280;">
                            ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°: <span id="databaseRecords">--</span><br>
                            æœ€çµ‚åŒæœŸ: <span id="databaseLastSync">--:--</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- é…ä¿¡å±¥æ­´ -->
            <div class="card">
                <h2 style="color: #374151; font-weight: 600;">ğŸ“‹ é…ä¿¡å±¥æ­´ãƒ»äºˆç´„çŠ¶æ³</h2>
                
                <!-- ğŸš¨ å•é¡Œè§£æ±ºé€šçŸ¥ -->
                <div style="background: linear-gradient(135deg, #dc2626, #ef4444); border-radius: 10px; padding: 15px; margin-bottom: 20px; color: white;">
                    <h3 style="margin: 0 0 10px 0; color: white;">ğŸ” é…ä¿¡çŠ¶æ³ç¢ºèªã‚·ã‚¹ãƒ†ãƒ </h3>
                    <p style="margin: 0; font-size: 0.9rem; opacity: 0.9;">Brevo APIã‹ã‚‰å®Ÿéš›ã®é…ä¿¡å±¥æ­´ã‚’å–å¾—ã—ã¦ã€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«é…ä¿¡ã®å•é¡Œã‚’ç‰¹å®šã—ã¾ã™</p>
                </div>
                
                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button id="checkRealDeliveryBtn" class="btn btn-primary">ğŸ” å®Ÿéš›ã®é…ä¿¡çŠ¶æ³ç¢ºèª</button>
                    <button id="refreshHistoryBtn" class="btn btn-secondary">ğŸ”„ å±¥æ­´ã‚’æ›´æ–°</button>
                    <button id="clearHistoryBtn" class="btn btn-danger">ğŸ—‘ï¸ å±¥æ­´ã‚’ã‚¯ãƒªã‚¢</button>
                    <button id="showFailedEmailsBtn" class="btn btn-info">âš ï¸ å¤±æ•—ãƒ¡ãƒ¼ãƒ«ç¢ºèª</button>
                    <button id="showReportBtn" class="btn btn-success">ğŸ“Š é…ä¿¡ãƒ¬ãƒãƒ¼ãƒˆ</button>
                </div>
                <div id="newHistoryArea" style="background: #f9fafb; border-radius: 10px; padding: 20px; border: 2px solid #d1d5db;">
                    <div class="new-no-history">
                        ğŸ“„ å±¥æ­´ã‚’èª­ã¿è¾¼ã¿ä¸­...
                    </div>
                </div>
                
                <!-- å¤±æ•—ãƒ¡ãƒ¼ãƒ«å†é€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div id="failedEmailsSection" style="display: none; margin-top: 25px; background: #fef2f2; border-radius: 10px; padding: 20px; border: 2px solid #fecaca;">
                    <h3 style="color: #991b1b; margin-top: 0;">âš ï¸ é€ä¿¡å¤±æ•—ãƒ¡ãƒ¼ãƒ«ä¸€è¦§</h3>
                    <div id="failedEmailsList"></div>
                    <div style="margin-top: 15px; display: flex; gap: 10px;">
                        <button id="retryFailedBtn" class="btn btn-primary">ğŸ”„ å¤±æ•—åˆ†ã‚’å†é€ä¿¡</button>
                        <button id="clearFailedBtn" class="btn btn-secondary">ğŸ—‘ï¸ å¤±æ•—ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢</button>
                        <button id="hideFailedBtn" class="btn btn-secondary">âŒ é–‰ã˜ã‚‹</button>
                    </div>
                </div>
                
                <!-- é…ä¿¡ãƒ¬ãƒãƒ¼ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div id="reportSection" style="display: none; margin-top: 25px; background: #f0f9ff; border-radius: 10px; padding: 20px; border: 2px solid #0ea5e9;">
                    <h3 style="color: #0c4a6e; margin-top: 0;">ğŸ“Š é…ä¿¡ãƒ¬ãƒãƒ¼ãƒˆ</h3>
                    <div id="reportContent"></div>
                    <div style="margin-top: 15px; display: flex; gap: 10px;">
                        <button id="refreshReportBtn" class="btn btn-primary">ğŸ”„ ãƒ¬ãƒãƒ¼ãƒˆæ›´æ–°</button>
                        <button id="hideReportBtn" class="btn btn-secondary">âŒ é–‰ã˜ã‚‹</button>
                    </div>
                </div>
            </div>

            <!-- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="card">
                <h2 style="color: #dc2626; font-weight: 600;">ğŸ” é…ä¿¡åˆ¶é™ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š</h2>
                <div style="background: #fef2f2; border: 2px solid #fecaca; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <p style="margin: 0; color: #7f1d1d; font-weight: 600;">âš ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿèƒ½ã«ã‚ˆã‚Šã€ä¸æ­£åˆ©ç”¨ã‚„èª¤é…ä¿¡ã‚’é˜²æ­¢ã—ã¾ã™</p>
                </div>
                
                <!-- ãƒ¬ãƒ¼ãƒˆåˆ¶é™è¨­å®š -->
                <div style="background: #f8fafc; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="color: #1e40af; margin-top: 0;">ğŸ“Š é€ä¿¡ãƒ¬ãƒ¼ãƒˆåˆ¶é™</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">æ™‚é–“åˆ¶é™</label>
                            <select id="securityHourlyLimit" style="width: 100%; padding: 8px; border: 2px solid #d1d5db; border-radius: 6px;">
                                <option value="50">50é€š/æ™‚é–“ (æ¨å¥¨)</option>
                                <option value="100">100é€š/æ™‚é–“</option>
                                <option value="200">200é€š/æ™‚é–“</option>
                                <option value="0">åˆ¶é™ãªã— âš ï¸</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">æ—¥æ¬¡åˆ¶é™</label>
                            <select id="securityDailyLimit" style="width: 100%; padding: 8px; border: 2px solid #d1d5db; border-radius: 6px;">
                                <option value="1000">1,000é€š/æ—¥ (æ¨å¥¨)</option>
                                <option value="2000">2,000é€š/æ—¥</option>
                                <option value="5000">5,000é€š/æ—¥</option>
                                <option value="0">åˆ¶é™ãªã— âš ï¸</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="rateLimitStatus" style="margin-top: 15px; padding: 10px; background: #ecfdf5; border-radius: 6px;">
                        <div style="color: #065f46; font-weight: 600;">âœ… ç¾åœ¨ã®é€ä¿¡çŠ¶æ³</div>
                        <div id="rateLimitInfo" style="color: #047857; font-size: 0.95rem; margin-top: 5px;">
                            æœ¬æ—¥ã®é€ä¿¡æ•°: <span id="todaySentCount">0</span>é€š | 1æ™‚é–“ä»¥å†…ã®é€ä¿¡æ•°: <span id="hourSentCount">0</span>é€š
                        </div>
                    </div>
                </div>
                
                <!-- ç®¡ç†è€…èªè¨¼ -->
                <div style="background: #f1f5f9; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="color: #7c2d12; margin-top: 0;">ğŸ”‘ ç®¡ç†è€…èªè¨¼</h3>
                    <div style="display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: end;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                            <input type="password" id="adminPassword" placeholder="é…ä¿¡å®Ÿè¡Œæ™‚ã«å¿…è¦" 
                                   style="width: 100%; padding: 12px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 16px;">
                            <small style="color: #6b7280;">å¤§é‡é…ä¿¡(500é€šä»¥ä¸Š)å®Ÿè¡Œæ™‚ã®ã¿èªè¨¼ãŒå¿…è¦ã§ã™</small>
                            <div style="margin-top: 5px; padding: 8px; background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 4px; font-size: 0.85rem; color: #0369a1;">
                                ğŸ’¡ ãƒ’ãƒ³ãƒˆ: ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ã€Œ<code style="background: rgba(59, 130, 246, 0.1); padding: 2px 4px; border-radius: 3px;">nankan123</code>ã€ã§ã™
                            </div>
                        </div>
                        <button id="verifyAdminBtn" class="btn btn-secondary">ğŸ” èªè¨¼ç¢ºèª</button>
                    </div>
                    
                    <div id="adminAuthStatus" style="margin-top: 10px; padding: 8px; border-radius: 6px; display: none;">
                        <span id="adminAuthMessage"></span>
                    </div>
                </div>
                
                <!-- IPåˆ¶é™ã¨ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ -->
                <div style="background: #fefce8; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="color: #a16207; margin-top: 0;">ğŸŒ ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡</h3>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">
                            <input type="checkbox" id="enableIpRestriction" style="margin-right: 8px;">
                            IPåˆ¶é™ã‚’æœ‰åŠ¹ã«ã™ã‚‹
                        </label>
                        <textarea id="allowedIps" placeholder="è¨±å¯ã™ã‚‹IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ”¹è¡ŒåŒºåˆ‡ã‚Šã§å…¥åŠ›&#10;ä¾‹:&#10;192.168.1.100&#10;10.0.0.1" 
                                  style="width: 100%; height: 80px; padding: 10px; border: 2px solid #d1d5db; border-radius: 6px; font-family: monospace; font-size: 14px;" disabled></textarea>
                        <small style="color: #6b7280;">ç¾åœ¨ã®IP: <span id="currentIp">å–å¾—ä¸­...</span></small>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">
                            <input type="checkbox" id="enableTimeRestriction" style="margin-right: 8px;">
                            æ™‚é–“åˆ¶é™ã‚’æœ‰åŠ¹ã«ã™ã‚‹
                        </label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px;">é–‹å§‹æ™‚é–“</label>
                                <input type="time" id="allowedStartTime" value="09:00" 
                                       style="width: 100%; padding: 8px; border: 2px solid #d1d5db; border-radius: 6px;" disabled>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px;">çµ‚äº†æ™‚é–“</label>
                                <input type="time" id="allowedEndTime" value="18:00" 
                                       style="width: 100%; padding: 8px; border: 2px solid #d1d5db; border-radius: 6px;" disabled>
                            </div>
                        </div>
                        <small style="color: #6b7280;">æŒ‡å®šã—ãŸæ™‚é–“å¤–ã¯é…ä¿¡ã‚’åˆ¶é™ã—ã¾ã™</small>
                    </div>
                </div>
                
                <!-- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚° -->
                <div style="background: #f0f9ff; border-radius: 8px; padding: 20px;">
                    <h3 style="color: #0c4a6e; margin-top: 0;">ğŸ“‹ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°</h3>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button id="showSecurityLogBtn" class="btn btn-info">ğŸ“Š ãƒ­ã‚°è¡¨ç¤º</button>
                        <button id="clearSecurityLogBtn" class="btn btn-warning">ğŸ—‘ï¸ ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
                        <button id="exportSecurityLogBtn" class="btn btn-secondary">ğŸ’¾ ãƒ­ã‚°å‡ºåŠ›</button>
                    </div>
                    
                    <div id="securityLogArea" style="background: white; border-radius: 6px; padding: 15px; max-height: 200px; overflow-y: auto; border: 2px solid #bae6fd;">
                        <div style="color: #6b7280; text-align: center;">ğŸ“„ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
                    </div>
                </div>
            </div>

            <!-- é…ä¿¡åœæ­¢ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="card">
                <h2 style="color: #059669; font-weight: 600;">ğŸ“§ é…ä¿¡åœæ­¢ï¼ˆUnsubscribeï¼‰ç®¡ç†</h2>
                <div style="background: #ecfdf5; border: 2px solid #a7f3d0; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <p style="margin: 0; color: #047857; font-weight: 600;">âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é…ä¿¡åœæ­¢ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ç®¡ç†ã—ã€æ³•çš„è¦ä»¶ã«æº–æ‹ ã—ã¾ã™</p>
                </div>
                
                <!-- é…ä¿¡åœæ­¢ãƒªã‚¹ãƒˆ -->
                <div style="background: #f1f5f9; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="color: #0f172a; margin-top: 0;">ğŸ“‹ é…ä¿¡åœæ­¢ãƒªã‚¹ãƒˆ</h3>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                        <button id="showUnsubscribedBtn" class="btn btn-info">ğŸ‘€ é…ä¿¡åœæ­¢ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡¨ç¤º</button>
                        <button id="addUnsubscribeBtn" class="btn btn-warning">â• æ‰‹å‹•ã§é…ä¿¡åœæ­¢è¿½åŠ </button>
                        <button id="exportUnsubscribeBtn" class="btn btn-secondary">ğŸ’¾ ãƒªã‚¹ãƒˆå‡ºåŠ›</button>
                        <button id="clearUnsubscribeBtn" class="btn btn-danger">ğŸ—‘ï¸ ãƒªã‚¹ãƒˆã‚¯ãƒªã‚¢</button>
                    </div>
                    
                    <div id="unsubscribeListArea" style="background: white; border-radius: 6px; padding: 15px; max-height: 300px; overflow-y: auto; border: 2px solid #cbd5e0;">
                        <div style="color: #6b7280; text-align: center;">ğŸ“„ é…ä¿¡åœæ­¢ãƒªã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
                    </div>
                    
                    <div style="margin-top: 15px; padding: 10px; background: #fef3c7; border-radius: 6px; border-left: 4px solid #f59e0b;">
                        <div style="color: #92400e; font-weight: 600;">ğŸ“Š çµ±è¨ˆæƒ…å ±</div>
                        <div id="unsubscribeStats" style="color: #78350f; font-size: 0.95rem; margin-top: 5px;">
                            é…ä¿¡åœæ­¢ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°: <span id="totalUnsubscribed">0</span>äºº | ä»Šæœˆã®é…ä¿¡åœæ­¢: <span id="monthlyUnsubscribed">0</span>äºº
                        </div>
                    </div>
                </div>
                
                <!-- Unsubscribeãƒªãƒ³ã‚¯è¨­å®š -->
                <div style="background: #fefce8; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="color: #a16207; margin-top: 0;">ğŸ”— Unsubscribeãƒªãƒ³ã‚¯è¨­å®š</h3>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">
                            <input type="checkbox" id="autoUnsubscribeLink" style="margin-right: 8px;" checked>
                            ãƒ¡ãƒ¼ãƒ«æœ«å°¾ã«è‡ªå‹•ã§Unsubscribeãƒªãƒ³ã‚¯ã‚’è¿½åŠ 
                        </label>
                        <small style="color: #6b7280; display: block;">æ³•çš„è¦ä»¶ã«æº–æ‹ ã™ã‚‹ãŸã‚ã€æ¨å¥¨è¨­å®šã§ã™</small>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Unsubscribeãƒªãƒ³ã‚¯ãƒ†ã‚­ã‚¹ãƒˆ</label>
                        <input type="text" id="unsubscribeLinkText" value="é…ä¿¡åœæ­¢ã¯ã“ã¡ã‚‰" 
                               style="width: 100%; padding: 10px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                    </div>
                    
                    <div style="background: white; padding: 15px; border-radius: 6px; border: 1px solid #d1d5db;">
                        <div style="color: #374151; font-weight: 600; margin-bottom: 8px;">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼:</div>
                        <div id="unsubscribePreview" style="color: #6b7280; font-size: 0.9rem; border: 1px solid #e5e7eb; padding: 10px; border-radius: 4px; font-family: Arial, sans-serif;">
                            <div style="text-align: center; margin-top: 20px; padding: 10px; border-top: 1px solid #e5e7eb; font-size: 12px; color: #6b7280;">
                                <a href="#" style="color: #3b82f6; text-decoration: underline;">é…ä¿¡åœæ­¢ã¯ã“ã¡ã‚‰</a><br>
                                NANKANã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ | ã€’100-0001 æ±äº¬éƒ½åƒä»£ç”°åŒº
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- å†è³¼èª­ç®¡ç† -->
                <div style="background: #f0f9ff; border-radius: 8px; padding: 20px;">
                    <h3 style="color: #0c4a6e; margin-top: 0;">ğŸ”„ å†è³¼èª­ç®¡ç†</h3>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å†è³¼èª­ã‚’è¨±å¯</label>
                        <input type="email" id="resubscribeEmail" placeholder="å†è³¼èª­ã‚’è¨±å¯ã™ã‚‹ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" 
                               style="width: 70%; padding: 10px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 14px; margin-right: 10px;">
                        <button id="resubscribeBtn" class="btn btn-success">âœ… å†è³¼èª­è¨±å¯</button>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">
                            <input type="checkbox" id="allowSelfResubscribe" style="margin-right: 8px;">
                            ãƒ¦ãƒ¼ã‚¶ãƒ¼è‡ªèº«ã«ã‚ˆã‚‹å†è³¼èª­ã‚’è¨±å¯
                        </label>
                        <small style="color: #6b7280;">ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã¨ã€é…ä¿¡åœæ­¢ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‡ªåˆ†ã§å†è³¼èª­ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™</small>
                    </div>
                </div>
            </div>

            <!-- A/Bãƒ†ã‚¹ãƒˆæ©Ÿèƒ½ -->
            <div class="card">
                <h2 style="color: #7c3aed; font-weight: 600;">ğŸ§ª A/Bãƒ†ã‚¹ãƒˆæ©Ÿèƒ½</h2>
                <div style="background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%); border-radius: 10px; padding: 20px; margin-bottom: 20px; color: white;">
                    <div style="text-align: center;">
                        <h3 style="margin: 0 0 10px 0; color: white;">ğŸ’¡ A/Bãƒ†ã‚¹ãƒˆã§é…ä¿¡åŠ¹æœã‚’æœ€å¤§åŒ–</h3>
                        <p style="margin: 0; opacity: 0.9; font-size: 0.95rem;">ç•°ãªã‚‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’åŒæ™‚é…ä¿¡ã—ã¦ã€æœ€ã‚‚åŠ¹æœçš„ãªãƒ¡ãƒ¼ãƒ«ã‚’ç™ºè¦‹ã—ã¾ã—ã‚‡ã†</p>
                    </div>
                </div>
                
                <!-- A/Bãƒ†ã‚¹ãƒˆè¨­å®š -->
                <div style="background: #f8fafc; border-radius: 10px; padding: 20px; margin-bottom: 20px; border: 2px solid #cbd5e0;">
                    <h3 style="margin: 0 0 15px 0; color: #7c3aed; font-weight: 600;">âš™ï¸ ãƒ†ã‚¹ãƒˆè¨­å®š</h3>
                    
                    <!-- ãƒ†ã‚¹ãƒˆæœ‰åŠ¹åŒ– -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: flex; align-items: center; gap: 10px; font-weight: 600; cursor: pointer;">
                            <input type="checkbox" id="enableAbTest" style="transform: scale(1.2);">
                            <span style="color: #7c3aed;">ğŸ§ª A/Bãƒ†ã‚¹ãƒˆã‚’æœ‰åŠ¹ã«ã™ã‚‹</span>
                        </label>
                        <small style="color: #6b7280; margin-left: 32px; display: block; margin-top: 5px;">
                            é…ä¿¡å¯¾è±¡ã®ä¸€éƒ¨ã«ç•°ãªã‚‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã™
                        </small>
                    </div>
                    
                    <!-- ãƒ†ã‚¹ãƒˆè¨­å®šè©³ç´° -->
                    <div id="abTestSettings" style="display: none;">
                        <!-- é…ä¿¡æ¯”ç‡è¨­å®š -->
                        <div style="background: white; border-radius: 8px; padding: 15px; margin-bottom: 15px; border: 1px solid #e5e7eb;">
                            <h4 style="margin: 0 0 15px 0; color: #374151;">ğŸ“Š é…ä¿¡æ¯”ç‡è¨­å®š</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">ãƒãƒ¼ã‚¸ãƒ§ãƒ³Aé…ä¿¡æ¯”ç‡</label>
                                    <select id="versionARatio" style="width: 100%; padding: 8px; border: 2px solid #d1d5db; border-radius: 6px;">
                                        <option value="50">50% (æ¨å¥¨)</option>
                                        <option value="40">40%</option>
                                        <option value="30">30%</option>
                                        <option value="70">70%</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">ãƒãƒ¼ã‚¸ãƒ§ãƒ³Bé…ä¿¡æ¯”ç‡</label>
                                    <input type="text" id="versionBRatio" value="50%" readonly style="width: 100%; padding: 8px; border: 2px solid #e5e7eb; border-radius: 6px; background: #f9fafb; color: #6b7280;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">æœ€å°ã‚µãƒ³ãƒ—ãƒ«ã‚µã‚¤ã‚º</label>
                                    <input type="number" id="minSampleSize" value="100" min="50" style="width: 100%; padding: 8px; border: 2px solid #d1d5db; border-radius: 6px;">
                                    <small style="color: #6b7280;">çµ±è¨ˆçš„æœ‰æ„æ€§ã®ãŸã‚ã®æœ€å°é…ä¿¡æ•°</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ãƒ†ã‚¹ãƒˆé …ç›®è¨­å®š -->
                        <div style="background: white; border-radius: 8px; padding: 15px; margin-bottom: 15px; border: 1px solid #e5e7eb;">
                            <h4 style="margin: 0 0 15px 0; color: #374151;">ğŸ¯ ãƒ†ã‚¹ãƒˆé …ç›®</h4>
                            <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 15px;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="radio" name="testType" value="subject" checked>
                                    <span>ğŸ“§ ä»¶åãƒ†ã‚¹ãƒˆ</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="radio" name="testType" value="content">
                                    <span>ğŸ“ æœ¬æ–‡ãƒ†ã‚¹ãƒˆ</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="radio" name="testType" value="cta">
                                    <span>ğŸ¯ CTAãƒœã‚¿ãƒ³ãƒ†ã‚¹ãƒˆ</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="radio" name="testType" value="timing">
                                    <span>â° é…ä¿¡æ™‚é–“ãƒ†ã‚¹ãƒˆ</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- ãƒãƒ¼ã‚¸ãƒ§ãƒ³Aè¨­å®š -->
                        <div style="background: #fef3c7; border-radius: 8px; padding: 15px; margin-bottom: 15px; border: 2px solid #fbbf24;">
                            <h4 style="margin: 0 0 15px 0; color: #92400e;">ğŸ…°ï¸ ãƒãƒ¼ã‚¸ãƒ§ãƒ³A (ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«)</h4>
                            
                            <!-- ä»¶åãƒ†ã‚¹ãƒˆç”¨ -->
                            <div id="subjectTestA" class="test-variation">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">ä»¶åA</label>
                                <input type="text" id="subjectVersionA" placeholder="ãƒ†ã‚¹ãƒˆç”¨ä»¶åã‚’å…¥åŠ›" style="width: 100%; padding: 10px; border: 2px solid #d97706; border-radius: 6px;">
                            </div>
                            
                            <!-- æœ¬æ–‡ãƒ†ã‚¹ãƒˆç”¨ -->
                            <div id="contentTestA" class="test-variation" style="display: none;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">æœ¬æ–‡A</label>
                                <textarea id="contentVersionA" rows="4" placeholder="ãƒ†ã‚¹ãƒˆç”¨æœ¬æ–‡ã‚’å…¥åŠ›" style="width: 100%; padding: 10px; border: 2px solid #d97706; border-radius: 6px; resize: vertical;"></textarea>
                            </div>
                            
                            <!-- CTAãƒ†ã‚¹ãƒˆç”¨ -->
                            <div id="ctaTestA" class="test-variation" style="display: none;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">CTAãƒ†ã‚­ã‚¹ãƒˆA</label>
                                        <input type="text" id="ctaTextVersionA" placeholder="ğŸ‡ ä»Šã™ãå‚åŠ " style="width: 100%; padding: 8px; border: 2px solid #d97706; border-radius: 6px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">CTAè‰²A</label>
                                        <select id="ctaColorVersionA" style="width: 100%; padding: 8px; border: 2px solid #d97706; border-radius: 6px;">
                                            <option value="#3b82f6">ãƒ–ãƒ«ãƒ¼ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)</option>
                                            <option value="#10b981">ã‚°ãƒªãƒ¼ãƒ³</option>
                                            <option value="#f59e0b">ã‚ªãƒ¬ãƒ³ã‚¸</option>
                                            <option value="#ef4444">ãƒ¬ãƒƒãƒ‰</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- é…ä¿¡æ™‚é–“ãƒ†ã‚¹ãƒˆç”¨ -->
                            <div id="timingTestA" class="test-variation" style="display: none;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">é…ä¿¡æ™‚é–“A</label>
                                <input type="datetime-local" id="timingVersionA" style="width: 100%; padding: 8px; border: 2px solid #d97706; border-radius: 6px;">
                            </div>
                        </div>
                        
                        <!-- ãƒãƒ¼ã‚¸ãƒ§ãƒ³Bè¨­å®š -->
                        <div style="background: #ecfdf5; border-radius: 8px; padding: 15px; margin-bottom: 15px; border: 2px solid #10b981;">
                            <h4 style="margin: 0 0 15px 0; color: #047857;">ğŸ…±ï¸ ãƒãƒ¼ã‚¸ãƒ§ãƒ³B (ãƒ†ã‚¹ãƒˆ)</h4>
                            
                            <!-- ä»¶åãƒ†ã‚¹ãƒˆç”¨ -->
                            <div id="subjectTestB" class="test-variation">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">ä»¶åB</label>
                                <input type="text" id="subjectVersionB" placeholder="ãƒ†ã‚¹ãƒˆç”¨ä»¶åã‚’å…¥åŠ›ï¼ˆç•°ãªã‚‹å†…å®¹ã§ï¼‰" style="width: 100%; padding: 10px; border: 2px solid #059669; border-radius: 6px;">
                            </div>
                            
                            <!-- æœ¬æ–‡ãƒ†ã‚¹ãƒˆç”¨ -->
                            <div id="contentTestB" class="test-variation" style="display: none;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">æœ¬æ–‡B</label>
                                <textarea id="contentVersionB" rows="4" placeholder="ãƒ†ã‚¹ãƒˆç”¨æœ¬æ–‡ã‚’å…¥åŠ›ï¼ˆç•°ãªã‚‹å†…å®¹ã§ï¼‰" style="width: 100%; padding: 10px; border: 2px solid #059669; border-radius: 6px; resize: vertical;"></textarea>
                            </div>
                            
                            <!-- CTAãƒ†ã‚¹ãƒˆç”¨ -->
                            <div id="ctaTestB" class="test-variation" style="display: none;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">CTAãƒ†ã‚­ã‚¹ãƒˆB</label>
                                        <input type="text" id="ctaTextVersionB" placeholder="ğŸ¯ ä»Šã™ãå§‹ã‚ã‚‹" style="width: 100%; padding: 8px; border: 2px solid #059669; border-radius: 6px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">CTAè‰²B</label>
                                        <select id="ctaColorVersionB" style="width: 100%; padding: 8px; border: 2px solid #059669; border-radius: 6px;">
                                            <option value="#10b981">ã‚°ãƒªãƒ¼ãƒ³</option>
                                            <option value="#3b82f6">ãƒ–ãƒ«ãƒ¼</option>
                                            <option value="#f59e0b">ã‚ªãƒ¬ãƒ³ã‚¸</option>
                                            <option value="#ef4444">ãƒ¬ãƒƒãƒ‰</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- é…ä¿¡æ™‚é–“ãƒ†ã‚¹ãƒˆç”¨ -->
                            <div id="timingTestB" class="test-variation" style="display: none;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">é…ä¿¡æ™‚é–“B</label>
                                <input type="datetime-local" id="timingVersionB" style="width: 100%; padding: 8px; border: 2px solid #059669; border-radius: 6px;">
                            </div>
                        </div>
                        
                        <!-- çµ±è¨ˆçš„æœ‰æ„æ€§è¨­å®š -->
                        <div style="background: white; border-radius: 8px; padding: 15px; margin-bottom: 15px; border: 1px solid #e5e7eb;">
                            <h4 style="margin: 0 0 15px 0; color: #374151;">ğŸ“ˆ çµ±è¨ˆè¨­å®š</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">æœ‰æ„æ°´æº–</label>
                                    <select id="significanceLevel" style="width: 100%; padding: 8px; border: 2px solid #d1d5db; border-radius: 6px;">
                                        <option value="0.05">5% (æ¨å¥¨)</option>
                                        <option value="0.01">1% (å³æ ¼)</option>
                                        <option value="0.10">10% (ç·©ã„)</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">æ¤œå‡ºåŠ›</label>
                                    <select id="statisticalPower" style="width: 100%; padding: 8px; border: 2px solid #d1d5db; border-radius: 6px;">
                                        <option value="0.80">80% (æ¨å¥¨)</option>
                                        <option value="0.90">90% (é«˜ç²¾åº¦)</option>
                                        <option value="0.70">70% (ä½ç²¾åº¦)</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">ãƒ†ã‚¹ãƒˆæœŸé–“</label>
                                    <select id="testDuration" style="width: 100%; padding: 8px; border: 2px solid #d1d5db; border-radius: 6px;">
                                        <option value="24">24æ™‚é–“</option>
                                        <option value="48">48æ™‚é–“ (æ¨å¥¨)</option>
                                        <option value="72">72æ™‚é–“</option>
                                        <option value="168">1é€±é–“</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æˆåŠŸæŒ‡æ¨™è¨­å®š -->
                        <div style="background: white; border-radius: 8px; padding: 15px; margin-bottom: 15px; border: 1px solid #e5e7eb;">
                            <h4 style="margin: 0 0 15px 0; color: #374151;">ğŸ¯ æˆåŠŸæŒ‡æ¨™ (KPI)</h4>
                            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="kpiOpenRate" checked>
                                    <span>ğŸ“§ é–‹å°ç‡</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="kpiClickRate" checked>
                                    <span>ğŸ”— ã‚¯ãƒªãƒƒã‚¯ç‡</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="kpiConversion">
                                    <span>ğŸ’° ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç‡</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="kpiUnsubscribe">
                                    <span>âŒ é…ä¿¡åœæ­¢ç‡</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- é…ä¿¡äºˆå‘Š -->
                        <div id="abTestPreview" style="background: #f0f9ff; border-radius: 8px; padding: 15px; border-left: 4px solid #3b82f6;">
                            <h4 style="margin: 0 0 10px 0; color: #1e40af;">ğŸ“Š ãƒ†ã‚¹ãƒˆé…ä¿¡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h4>
                            <div id="abTestSummary" style="font-size: 0.95rem; color: #1d4ed8;">
                                ãƒ†ã‚¹ãƒˆè¨­å®šã‚’æœ‰åŠ¹ã«ã—ã¦è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- A/Bãƒ†ã‚¹ãƒˆçµæœè¡¨ç¤º -->
                <div style="background: #f1f5f9; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="margin: 0 0 15px 0; color: #0f172a; font-weight: 600;">ğŸ“Š ãƒ†ã‚¹ãƒˆçµæœãƒ»åˆ†æ</h3>
                    
                    <!-- ãƒ†ã‚¹ãƒˆä¸€è¦§ -->
                    <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                        <button id="loadActiveTestsBtn" class="btn btn-info">ğŸ”„ é€²è¡Œä¸­ãƒ†ã‚¹ãƒˆã‚’è¡¨ç¤º</button>
                        <button id="loadCompletedTestsBtn" class="btn btn-secondary">âœ… å®Œäº†æ¸ˆã¿ãƒ†ã‚¹ãƒˆã‚’è¡¨ç¤º</button>
                        <button id="exportTestResultsBtn" class="btn btn-success">ğŸ’¾ çµæœã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                        <button id="clearTestHistoryBtn" class="btn btn-danger">ğŸ—‘ï¸ å±¥æ­´å‰Šé™¤</button>
                    </div>
                    
                    <!-- ãƒ†ã‚¹ãƒˆçµæœã‚¨ãƒªã‚¢ -->
                    <div id="abTestResultsArea" style="background: white; border-radius: 8px; padding: 15px; min-height: 200px; border: 1px solid #e5e7eb;">
                        <div style="text-align: center; color: #6b7280; padding: 40px;">
                            <div style="font-size: 2rem; margin-bottom: 10px;">ğŸ“Š</div>
                            <p style="margin: 0;">A/Bãƒ†ã‚¹ãƒˆçµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</p>
                            <small>ä¸Šã®ã€Œé€²è¡Œä¸­ãƒ†ã‚¹ãƒˆã€ã¾ãŸã¯ã€Œå®Œäº†æ¸ˆã¿ãƒ†ã‚¹ãƒˆã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯</small>
                        </div>
                    </div>
                </div>
                
                <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
                <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                    <button id="previewAbTestBtn" class="btn btn-info">ğŸ‘€ A/Bãƒ†ã‚¹ãƒˆ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
                    <button id="saveAbTestSettingsBtn" class="btn btn-secondary">ğŸ’¾ ãƒ†ã‚¹ãƒˆè¨­å®šã‚’ä¿å­˜</button>
                    <button id="loadAbTestSettingsBtn" class="btn btn-secondary">ğŸ“‚ è¨­å®šã‚’èª­ã¿è¾¼ã¿</button>
                    <button id="startAbTestBtn" class="btn btn-primary" disabled>ğŸš€ A/Bãƒ†ã‚¹ãƒˆé–‹å§‹</button>
                </div>
            </div>

            <!-- ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«æ·»ä»˜æ©Ÿèƒ½ -->
            <div class="card">
                <h2 style="color: #059669; font-weight: 600;">ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«æ·»ä»˜ãƒ»ç”»åƒæŒ¿å…¥</h2>
                <div style="background: linear-gradient(135deg, #059669 0%, #10b981 100%); border-radius: 10px; padding: 20px; margin-bottom: 20px; color: white;">
                    <div style="text-align: center;">
                        <h3 style="margin: 0 0 10px 0; color: white;">ğŸ“¸ ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã§ç°¡å˜æ·»ä»˜</h3>
                        <p style="margin: 0; opacity: 0.9; font-size: 0.95rem;">ç”»åƒã€PDFã€ZIP ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ¡ãƒ¼ãƒ«ã«æ·»ä»˜ã—ã¦ã€é­…åŠ›çš„ãªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’é…ä¿¡</p>
                    </div>
                </div>
                
                <!-- ãƒ•ã‚¡ã‚¤ãƒ«æ·»ä»˜ã‚¨ãƒªã‚¢ -->
                <div style="background: #f8fafc; border-radius: 10px; padding: 20px; margin-bottom: 20px; border: 2px solid #cbd5e0;">
                    <h3 style="margin: 0 0 15px 0; color: #059669; font-weight: 600;">ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†</h3>
                    
                    <!-- ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ -->
                    <div id="dropZone" style="
                        border: 3px dashed #d1d5db; 
                        border-radius: 12px; 
                        padding: 40px 20px; 
                        text-align: center; 
                        background: #f9fafb;
                        transition: all 0.3s ease;
                        cursor: pointer;
                        margin-bottom: 20px;
                    ">
                        <div style="font-size: 3rem; margin-bottom: 15px; color: #9ca3af;">ğŸ“</div>
                        <h4 style="margin: 0 0 10px 0; color: #374151;">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</h4>
                        <p style="margin: 0 0 15px 0; color: #6b7280;">ã¾ãŸã¯ã€ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</p>
                        <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-bottom: 15px;">
                            <span style="background: #dbeafe; color: #1e40af; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">ğŸ“¸ JPG, PNG, GIF</span>
                            <span style="background: #fef3c7; color: #92400e; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">ğŸ“„ PDF</span>
                            <span style="background: #ecfdf5; color: #047857; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">ğŸ—œï¸ ZIP</span>
                            <span style="background: #f3e8ff; color: #7c2d12; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">ğŸ“Š DOC, XLS</span>
                        </div>
                        <small style="color: #9ca3af;">æœ€å¤§ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: 10MB | æœ€å¤§5ãƒ•ã‚¡ã‚¤ãƒ«</small>
                    </div>
                    
                    <!-- ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã®å¾“æ¥å‹å…¥åŠ› -->
                    <input type="file" id="fileInput" multiple accept=".jpg,.jpeg,.png,.gif,.pdf,.zip,.doc,.docx,.xls,.xlsx" style="display: none;">
                    
                    <!-- æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆ -->
                    <div id="attachedFilesList" style="display: none;">
                        <h4 style="margin: 0 0 15px 0; color: #374151;">ğŸ“ æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§</h4>
                        <div id="fileListContainer" style="background: white; border-radius: 8px; padding: 15px; border: 1px solid #e5e7eb;">
                            <!-- ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                        </div>
                        
                        <!-- ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œãƒœã‚¿ãƒ³ -->
                        <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                            <button id="clearAllFilesBtn" class="btn btn-danger">ğŸ—‘ï¸ å…¨ã¦å‰Šé™¤</button>
                            <button id="compressFilesBtn" class="btn btn-info">ğŸ—œï¸ ãƒ•ã‚¡ã‚¤ãƒ«åœ§ç¸®</button>
                            <button id="optimizeImagesBtn" class="btn btn-secondary">ğŸ¯ ç”»åƒæœ€é©åŒ–</button>
                            <button id="previewAttachmentsBtn" class="btn btn-success">ğŸ‘€ æ·»ä»˜ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
                        </div>
                    </div>
                </div>
                
                <!-- ç”»åƒæŒ¿å…¥ãƒ»ç·¨é›† -->
                <div style="background: #f1f5f9; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="margin: 0 0 15px 0; color: #0f172a; font-weight: 600;">ğŸ¨ ç”»åƒæŒ¿å…¥ãƒ»ç·¨é›†</h3>
                    
                    <!-- ç”»åƒæŒ¿å…¥ã‚ªãƒ—ã‚·ãƒ§ãƒ³ -->
                    <div style="background: white; border-radius: 8px; padding: 15px; margin-bottom: 15px; border: 1px solid #e5e7eb;">
                        <h4 style="margin: 0 0 15px 0; color: #374151;">ğŸ“¸ ç”»åƒæŒ¿å…¥è¨­å®š</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">æŒ¿å…¥ä½ç½®</label>
                                <select id="imageInsertPosition" style="width: 100%; padding: 8px; border: 2px solid #d1d5db; border-radius: 6px;">
                                    <option value="inline">æœ¬æ–‡å†…ï¼ˆã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ï¼‰</option>
                                    <option value="header">ãƒ˜ãƒƒãƒ€ãƒ¼ç”»åƒ</option>
                                    <option value="footer">ãƒ•ãƒƒã‚¿ãƒ¼ç”»åƒ</option>
                                    <option value="banner">ãƒãƒŠãƒ¼ç”»åƒ</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">ç”»åƒã‚µã‚¤ã‚º</label>
                                <select id="imageSize" style="width: 100%; padding: 8px; border: 2px solid #d1d5db; border-radius: 6px;">
                                    <option value="small">å° (200px)</option>
                                    <option value="medium">ä¸­ (400px)</option>
                                    <option value="large">å¤§ (600px)</option>
                                    <option value="full">æœ€å¤§ (100%)</option>
                                    <option value="custom">ã‚«ã‚¹ã‚¿ãƒ </option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">é…ç½®</label>
                                <select id="imageAlignment" style="width: 100%; padding: 8px; border: 2px solid #d1d5db; border-radius: 6px;">
                                    <option value="left">å·¦å¯„ã›</option>
                                    <option value="center">ä¸­å¤®æƒãˆ</option>
                                    <option value="right">å³å¯„ã›</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- ã‚«ã‚¹ã‚¿ãƒ ã‚µã‚¤ã‚ºè¨­å®š -->
                        <div id="customSizeSettings" style="display: none; margin-top: 15px; padding: 15px; background: #f8fafc; border-radius: 6px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">å¹… (px)</label>
                                    <input type="number" id="customImageWidth" placeholder="400" min="50" max="800" style="width: 100%; padding: 8px; border: 2px solid #d1d5db; border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">é«˜ã• (px)</label>
                                    <input type="number" id="customImageHeight" placeholder="300" min="50" max="600" style="width: 100%; padding: 8px; border: 2px solid #d1d5db; border-radius: 6px;">
                                    <small style="color: #6b7280;">ç©ºç™½ã§è‡ªå‹•èª¿æ•´</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ç”»åƒåŠ¹æœè¨­å®š -->
                    <div style="background: white; border-radius: 8px; padding: 15px; margin-bottom: 15px; border: 1px solid #e5e7eb;">
                        <h4 style="margin: 0 0 15px 0; color: #374151;">âœ¨ ç”»åƒåŠ¹æœ</h4>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="imageRoundedCorners">
                                <span>ğŸ”„ è§’ä¸¸</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="imageShadow">
                                <span>ğŸŒ‘ å½±ä»˜ã</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="imageBorder">
                                <span>ğŸ–¼ï¸ æ ç·š</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="imageHoverEffect">
                                <span>âœ¨ ãƒ›ãƒãƒ¼åŠ¹æœ</span>
                            </label>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">alt ãƒ†ã‚­ã‚¹ãƒˆ</label>
                                <input type="text" id="imageAltText" placeholder="ç”»åƒã®èª¬æ˜" style="width: 100%; padding: 8px; border: 2px solid #d1d5db; border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">ãƒªãƒ³ã‚¯å…ˆURL</label>
                                <input type="url" id="imageLinkUrl" placeholder="https://example.com" style="width: 100%; padding: 8px; border: 2px solid #d1d5db; border-radius: 6px;">
                            </div>
                        </div>
                    </div>
                    
                    <!-- æŒ¿å…¥ã•ã‚ŒãŸç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
                    <div id="insertedImagesPreview" style="display: none;">
                        <h4 style="margin: 0 0 15px 0; color: #374151;">ğŸ–¼ï¸ æŒ¿å…¥æ¸ˆã¿ç”»åƒ</h4>
                        <div id="imagePreviewContainer" style="background: white; border-radius: 8px; padding: 15px; border: 1px solid #e5e7eb; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <!-- æŒ¿å…¥æ¸ˆã¿ç”»åƒã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                        </div>
                    </div>
                </div>
                
                <!-- ãƒ•ã‚¡ã‚¤ãƒ«çµ±è¨ˆãƒ»åˆ¶é™æƒ…å ± -->
                <div style="background: white; border-radius: 10px; padding: 20px; border: 1px solid #e5e7eb;">
                    <h3 style="margin: 0 0 15px 0; color: #374151; font-weight: 600;">ğŸ“Š ãƒ•ã‚¡ã‚¤ãƒ«çµ±è¨ˆ</h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
                        <div style="text-align: center; padding: 15px; background: #f0f9ff; border-radius: 8px;">
                            <div style="font-size: 2rem; font-weight: bold; color: #0ea5e9;" id="totalFileCount">0</div>
                            <div style="color: #0c4a6e; font-size: 0.9rem;">æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«æ•°</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #f0fdf4; border-radius: 8px;">
                            <div style="font-size: 2rem; font-weight: bold; color: #10b981;" id="totalFileSize">0KB</div>
                            <div style="color: #047857; font-size: 0.9rem;">åˆè¨ˆã‚µã‚¤ã‚º</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #fef3c7; border-radius: 8px;">
                            <div style="font-size: 2rem; font-weight: bold; color: #f59e0b;" id="imageFileCount">0</div>
                            <div style="color: #92400e; font-size: 0.9rem;">ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #fdf2f8; border-radius: 8px;">
                            <div style="font-size: 2rem; font-weight: bold; color: #ec4899;" id="documentFileCount">0</div>
                            <div style="color: #be185d; font-size: 0.9rem;">æ–‡æ›¸ãƒ•ã‚¡ã‚¤ãƒ«</div>
                        </div>
                    </div>
                    
                    <!-- åˆ¶é™äº‹é … -->
                    <div style="background: #fef2f2; border-radius: 8px; padding: 15px; border-left: 4px solid #ef4444;">
                        <h4 style="margin: 0 0 10px 0; color: #dc2626;">âš ï¸ æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«åˆ¶é™</h4>
                        <ul style="margin: 0; padding-left: 20px; color: #991b1b; font-size: 0.9rem; line-height: 1.6;">
                            <li>æœ€å¤§ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: 10MB/ãƒ•ã‚¡ã‚¤ãƒ«</li>
                            <li>æœ€å¤§æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«æ•°: 5ãƒ•ã‚¡ã‚¤ãƒ«</li>
                            <li>åˆè¨ˆã‚µã‚¤ã‚ºåˆ¶é™: 25MB</li>
                            <li>å¯¾å¿œå½¢å¼: JPG, PNG, GIF, PDF, ZIP, DOC, XLS</li>
                            <li>ãƒ¡ãƒ¼ãƒ«é€ä¿¡æ™‚ã®åˆ¶é™ã«ã‚ˆã‚Šã€ä¸€éƒ¨ãƒ¡ãƒ¼ãƒ«ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§è¡¨ç¤ºã•ã‚Œãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™</li>
                        </ul>
                    </div>
                    
                    <!-- åˆ©ç”¨çŠ¶æ³ãƒãƒ¼ -->
                    <div style="margin-top: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-weight: 600; color: #374151;">åˆ©ç”¨çŠ¶æ³</span>
                            <span id="usagePercentage" style="font-weight: 600; color: #6b7280;">0%</span>
                        </div>
                        <div style="background: #e5e7eb; height: 8px; border-radius: 4px; overflow: hidden;">
                            <div id="usageBar" style="background: linear-gradient(90deg, #10b981, #3b82f6); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 5px; font-size: 0.8rem; color: #6b7280;">
                            <span>0MB</span>
                            <span>25MB</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- é…ä¿¡ã‚­ãƒ¥ãƒ¼ã‚·ã‚¹ãƒ†ãƒ  -->
            <div class="card">
                <h2 style="color: #7c2d12; font-weight: 600;">âš¡ é…ä¿¡ã‚­ãƒ¥ãƒ¼ã‚·ã‚¹ãƒ†ãƒ </h2>
                <div style="background: linear-gradient(135deg, #7c2d12 0%, #dc2626 100%); border-radius: 10px; padding: 20px; margin-bottom: 20px; color: white;">
                    <div style="text-align: center;">
                        <h3 style="margin: 0 0 10px 0; color: white;">ğŸš€ é«˜é€Ÿãƒ»ç¢ºå®Ÿãªé…ä¿¡ç®¡ç†</h3>
                        <p style="margin: 0; opacity: 0.9; font-size: 0.95rem;">é…ä¿¡é †åºã‚’æœ€é©åŒ–ã—ã€å¤§é‡ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚’åŠ¹ç‡çš„ã«å‡¦ç†ã—ã¾ã™</p>
                    </div>
                </div>
                
                <!-- ã‚­ãƒ¥ãƒ¼ç›£è¦–ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ -->
                <div style="background: #f8fafc; border-radius: 10px; padding: 20px; margin-bottom: 20px; border: 2px solid #cbd5e0;">
                    <h3 style="margin: 0 0 15px 0; color: #7c2d12; font-weight: 600;">ğŸ“Š ã‚­ãƒ¥ãƒ¼ç›£è¦–ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h3>
                    
                    <!-- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ çµ±è¨ˆ -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div style="text-align: center; padding: 15px; background: linear-gradient(135deg, #dc2626, #ef4444); color: white; border-radius: 8px;">
                            <div style="font-size: 2rem; font-weight: bold;" id="queueTotalJobs">0</div>
                            <div style="opacity: 0.9; font-size: 0.9rem;">ç·ã‚­ãƒ¥ãƒ¼æ•°</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: linear-gradient(135deg, #f59e0b, #fbbf24); color: white; border-radius: 8px;">
                            <div style="font-size: 2rem; font-weight: bold;" id="queuePendingJobs">0</div>
                            <div style="opacity: 0.9; font-size: 0.9rem;">å¾…æ©Ÿä¸­</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: linear-gradient(135deg, #3b82f6, #60a5fa); color: white; border-radius: 8px;">
                            <div style="font-size: 2rem; font-weight: bold;" id="queueProcessingJobs">0</div>
                            <div style="opacity: 0.9; font-size: 0.9rem;">å‡¦ç†ä¸­</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: linear-gradient(135deg, #10b981, #34d399); color: white; border-radius: 8px;">
                            <div style="font-size: 2rem; font-weight: bold;" id="queueCompletedJobs">0</div>
                            <div style="opacity: 0.9; font-size: 0.9rem;">å®Œäº†</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: linear-gradient(135deg, #9333ea, #a855f7); color: white; border-radius: 8px;">
                            <div style="font-size: 2rem; font-weight: bold;" id="queueFailedJobs">0</div>
                            <div style="opacity: 0.9; font-size: 0.9rem;">å¤±æ•—</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: linear-gradient(135deg, #059669, #10b981); color: white; border-radius: 8px;">
                            <div style="font-size: 2rem; font-weight: bold;" id="queueThroughput">0</div>
                            <div style="opacity: 0.9; font-size: 0.9rem;">å‡¦ç†é€Ÿåº¦/åˆ†</div>
                        </div>
                    </div>
                    
                    <!-- ã‚­ãƒ¥ãƒ¼ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
                    <div style="background: white; border-radius: 8px; padding: 15px; margin-bottom: 15px; border: 1px solid #e5e7eb;">
                        <h4 style="margin: 0 0 15px 0; color: #374151;">ğŸ›ï¸ ã‚­ãƒ¥ãƒ¼ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«</h4>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                            <button id="startQueueBtn" class="btn btn-success">â–¶ï¸ ã‚­ãƒ¥ãƒ¼é–‹å§‹</button>
                            <button id="pauseQueueBtn" class="btn btn-warning">â¸ï¸ ä¸€æ™‚åœæ­¢</button>
                            <button id="stopQueueBtn" class="btn btn-danger">â¹ï¸ åœæ­¢</button>
                            <button id="clearQueueBtn" class="btn btn-secondary">ğŸ—‘ï¸ ã‚­ãƒ¥ãƒ¼ã‚¯ãƒªã‚¢</button>
                            <div style="margin-left: 20px; display: flex; align-items: center; gap: 10px;">
                                <label style="font-weight: 600;">å‡¦ç†é€Ÿåº¦:</label>
                                <select id="queueProcessingSpeed" style="padding: 5px 10px; border: 2px solid #d1d5db; border-radius: 4px;">
                                    <option value="1">ä½é€Ÿ (1ä»¶/ç§’)</option>
                                    <option value="5" selected>æ¨™æº– (5ä»¶/ç§’)</option>
                                    <option value="10">é«˜é€Ÿ (10ä»¶/ç§’)</option>
                                    <option value="20">æœ€é«˜é€Ÿ (20ä»¶/ç§’)</option>
                                </select>
                            </div>
                            <div style="margin-left: 20px;">
                                <span id="queueStatus" style="padding: 4px 12px; background: #e5e7eb; border-radius: 12px; font-size: 0.8rem; font-weight: 600;">â¹ï¸ åœæ­¢ä¸­</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- å‡¦ç†é€²è¡ŒçŠ¶æ³ -->
                    <div style="background: white; border-radius: 8px; padding: 15px; border: 1px solid #e5e7eb;">
                        <h4 style="margin: 0 0 15px 0; color: #374151;">ğŸ“ˆ å‡¦ç†é€²è¡ŒçŠ¶æ³</h4>
                        <div style="margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                <span style="font-weight: 600; color: #374151;">å…¨ä½“ã®é€²è¡Œç‡</span>
                                <span id="queueOverallProgress" style="font-weight: 600; color: #3b82f6;">0%</span>
                            </div>
                            <div style="background: #e5e7eb; height: 12px; border-radius: 6px; overflow: hidden;">
                                <div id="queueProgressBar" style="background: linear-gradient(90deg, #3b82f6, #10b981); height: 100%; width: 0%; transition: width 0.5s ease; border-radius: 6px;"></div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; font-size: 0.9rem;">
                            <div>
                                <span style="color: #6b7280;">æ¨å®šæ®‹ã‚Šæ™‚é–“:</span>
                                <div id="queueEstimatedTime" style="font-weight: 600; color: #374151;">--</div>
                            </div>
                            <div>
                                <span style="color: #6b7280;">æœ€å¾Œã®å‡¦ç†:</span>
                                <div id="queueLastProcessed" style="font-weight: 600; color: #374151;">--:--</div>
                            </div>
                            <div>
                                <span style="color: #6b7280;">å¹³å‡å‡¦ç†æ™‚é–“:</span>
                                <div id="queueAverageTime" style="font-weight: 600; color: #374151;">--ms</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ã‚­ãƒ¥ãƒ¼ç®¡ç† -->
                <div style="background: #f1f5f9; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="margin: 0 0 15px 0; color: #0f172a; font-weight: 600;">ğŸ“‹ ã‚­ãƒ¥ãƒ¼ç®¡ç†</h3>
                    
                    <!-- å„ªå…ˆåº¦è¨­å®š -->
                    <div style="background: white; border-radius: 8px; padding: 15px; margin-bottom: 15px; border: 1px solid #e5e7eb;">
                        <h4 style="margin: 0 0 15px 0; color: #374151;">ğŸ”¥ å„ªå…ˆåº¦è¨­å®š</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">é…ä¿¡å„ªå…ˆåº¦</label>
                                <select id="emailPriority" style="width: 100%; padding: 8px; border: 2px solid #d1d5db; border-radius: 6px;">
                                    <option value="low">ä½ - é€šå¸¸é…ä¿¡</option>
                                    <option value="normal" selected>æ¨™æº– - å®šæœŸé…ä¿¡</option>
                                    <option value="high">é«˜ - é‡è¦é€šçŸ¥</option>
                                    <option value="urgent">ç·Šæ€¥ - å³åº§ã«å‡¦ç†</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">ãƒãƒƒãƒã‚µã‚¤ã‚º</label>
                                <select id="batchSize" style="width: 100%; padding: 8px; border: 2px solid #d1d5db; border-radius: 6px;">
                                    <option value="10">å° (10ä»¶/ãƒãƒƒãƒ)</option>
                                    <option value="50" selected>æ¨™æº– (50ä»¶/ãƒãƒƒãƒ)</option>
                                    <option value="100">å¤§ (100ä»¶/ãƒãƒƒãƒ)</option>
                                    <option value="250">ç‰¹å¤§ (250ä»¶/ãƒãƒƒãƒ)</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">å†è©¦è¡Œå›æ•°</label>
                                <select id="retryCount" style="width: 100%; padding: 8px; border: 2px solid #d1d5db; border-radius: 6px;">
                                    <option value="0">ãªã—</option>
                                    <option value="1">1å›</option>
                                    <option value="3" selected>3å› (æ¨å¥¨)</option>
                                    <option value="5">5å›</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ã‚­ãƒ¥ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
                    <div style="background: white; border-radius: 8px; padding: 15px; margin-bottom: 15px; border: 1px solid #e5e7eb;">
                        <h4 style="margin: 0 0 15px 0; color: #374151;">âš¡ ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h4>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button id="addToQueueBtn" class="btn btn-primary">â• ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ </button>
                            <button id="priorityQueueBtn" class="btn btn-warning">ğŸ”¥ å„ªå…ˆã‚­ãƒ¥ãƒ¼ã«è¿½åŠ </button>
                            <button id="scheduleQueueBtn" class="btn btn-info">ğŸ“… ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¿½åŠ </button>
                            <button id="bulkQueueBtn" class="btn btn-secondary">ğŸ“¦ ä¸€æ‹¬è¿½åŠ </button>
                        </div>
                    </div>
                    
                    <!-- ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«é…ä¿¡ -->
                    <div id="scheduleQueueSection" style="display: none; background: white; border-radius: 8px; padding: 15px; margin-bottom: 15px; border: 2px solid #3b82f6;">
                        <h4 style="margin: 0 0 15px 0; color: #1e40af;">ğŸ“… ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«é…ä¿¡è¨­å®š</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">é…ä¿¡æ—¥æ™‚</label>
                                <input type="datetime-local" id="scheduleDateTime" style="width: 100%; padding: 8px; border: 2px solid #d1d5db; border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³</label>
                                <select id="scheduleTimezone" style="width: 100%; padding: 8px; border: 2px solid #d1d5db; border-radius: 6px;">
                                    <option value="Asia/Tokyo">æ—¥æœ¬æ™‚é–“ (JST)</option>
                                    <option value="UTC">å”å®šä¸–ç•Œæ™‚ (UTC)</option>
                                    <option value="America/New_York">æ±éƒ¨æ™‚é–“ (EST)</option>
                                    <option value="Europe/London">ã‚°ãƒªãƒ‹ãƒƒã‚¸æ¨™æº–æ™‚ (GMT)</option>
                                </select>
                            </div>
                            <div style="display: flex; align-items: end;">
                                <button id="confirmScheduleBtn" class="btn btn-success" style="width: 100%;">âœ… ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç¢ºå®š</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ã‚­ãƒ¥ãƒ¼ãƒªã‚¹ãƒˆè¡¨ç¤º -->
                <div style="background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px; border: 1px solid #e5e7eb;">
                    <h3 style="margin: 0 0 15px 0; color: #374151; font-weight: 600;">ğŸ“‹ ã‚­ãƒ¥ãƒ¼ä¸€è¦§</h3>
                    
                    <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ»ã‚½ãƒ¼ãƒˆ -->
                    <div style="background: #f8fafc; border-radius: 8px; padding: 15px; margin-bottom: 15px; border: 1px solid #e5e7eb;">
                        <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem;">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</label>
                                <select id="queueFilter" style="padding: 6px 12px; border: 2px solid #d1d5db; border-radius: 4px; font-size: 0.9rem;">
                                    <option value="all">å…¨ã¦</option>
                                    <option value="pending">å¾…æ©Ÿä¸­</option>
                                    <option value="processing">å‡¦ç†ä¸­</option>
                                    <option value="completed">å®Œäº†</option>
                                    <option value="failed">å¤±æ•—</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem;">ã‚½ãƒ¼ãƒˆ</label>
                                <select id="queueSort" style="padding: 6px 12px; border: 2px solid #d1d5db; border-radius: 4px; font-size: 0.9rem;">
                                    <option value="priority">å„ªå…ˆåº¦é †</option>
                                    <option value="created">ä½œæˆæ—¥æ™‚</option>
                                    <option value="scheduled">äºˆå®šæ—¥æ™‚</option>
                                    <option value="status">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem;">è¡¨ç¤ºä»¶æ•°</label>
                                <select id="queueLimit" style="padding: 6px 12px; border: 2px solid #d1d5db; border-radius: 4px; font-size: 0.9rem;">
                                    <option value="10">10ä»¶</option>
                                    <option value="25" selected>25ä»¶</option>
                                    <option value="50">50ä»¶</option>
                                    <option value="100">100ä»¶</option>
                                </select>
                            </div>
                            <div style="margin-left: auto;">
                                <button id="refreshQueueBtn" class="btn btn-info" style="padding: 6px 12px; font-size: 0.9rem;">ğŸ”„ æ›´æ–°</button>
                                <button id="exportQueueBtn" class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.9rem;">ğŸ’¾ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ã‚­ãƒ¥ãƒ¼ãƒªã‚¹ãƒˆ -->
                    <div id="queueListContainer" style="max-height: 500px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px;">
                        <div style="text-align: center; padding: 40px; color: #6b7280;">
                            <div style="font-size: 2rem; margin-bottom: 10px;">âš¡</div>
                            <p style="margin: 0;">ã‚­ãƒ¥ãƒ¼é …ç›®ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
                            <small>ã€Œã‚­ãƒ¥ãƒ¼ã«è¿½åŠ ã€ãƒœã‚¿ãƒ³ã§ãƒ¡ãƒ¼ãƒ«é…ä¿¡ã‚’ã‚­ãƒ¥ãƒ¼ã«ç™»éŒ²ã—ã¦ãã ã•ã„</small>
                        </div>
                    </div>
                </div>
                
                <!-- ã‚­ãƒ¥ãƒ¼çµ±è¨ˆãƒ»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ -->
                <div style="background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border-radius: 10px; padding: 20px; border: 1px solid #cbd5e0;">
                    <h3 style="margin: 0 0 15px 0; color: #374151; font-weight: 600;">ğŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹çµ±è¨ˆ</h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px;">
                        <!-- å‡¦ç†æ™‚é–“çµ±è¨ˆ -->
                        <div style="background: white; border-radius: 8px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <h4 style="margin: 0 0 15px 0; color: #374151;">â±ï¸ å‡¦ç†æ™‚é–“çµ±è¨ˆ</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div style="text-align: center; padding: 10px; background: #dbeafe; border-radius: 6px;">
                                    <div style="font-size: 1.2rem; font-weight: bold; color: #1e40af;" id="avgProcessingTime">--</div>
                                    <div style="font-size: 0.8rem; color: #1e40af;">å¹³å‡å‡¦ç†æ™‚é–“</div>
                                </div>
                                <div style="text-align: center; padding: 10px; background: #ecfdf5; border-radius: 6px;">
                                    <div style="font-size: 1.2rem; font-weight: bold; color: #047857;" id="minProcessingTime">--</div>
                                    <div style="font-size: 0.8rem; color: #047857;">æœ€çŸ­æ™‚é–“</div>
                                </div>
                                <div style="text-align: center; padding: 10px; background: #fef3c7; border-radius: 6px;">
                                    <div style="font-size: 1.2rem; font-weight: bold; color: #92400e;" id="maxProcessingTime">--</div>
                                    <div style="font-size: 0.8rem; color: #92400e;">æœ€é•·æ™‚é–“</div>
                                </div>
                                <div style="text-align: center; padding: 10px; background: #f3e8ff; border-radius: 6px;">
                                    <div style="font-size: 1.2rem; font-weight: bold; color: #7c2d12;" id="totalProcessingTime">--</div>
                                    <div style="font-size: 0.8rem; color: #7c2d12;">ç´¯ç©æ™‚é–“</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ã‚¨ãƒ©ãƒ¼çµ±è¨ˆ -->
                        <div style="background: white; border-radius: 8px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <h4 style="margin: 0 0 15px 0; color: #374151;">âš ï¸ ã‚¨ãƒ©ãƒ¼çµ±è¨ˆ</h4>
                            <div style="font-size: 0.9rem; line-height: 1.6;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span>æˆåŠŸç‡:</span>
                                    <span id="queueSuccessRate" style="font-weight: 600; color: #059669;">--</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span>ã‚¨ãƒ©ãƒ¼ç‡:</span>
                                    <span id="queueErrorRate" style="font-weight: 600; color: #dc2626;">--</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span>å†è©¦è¡Œç‡:</span>
                                    <span id="queueRetryRate" style="font-weight: 600; color: #f59e0b;">--</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span>ç·å‡¦ç†æ•°:</span>
                                    <span id="queueTotalProcessed" style="font-weight: 600; color: #3b82f6;">--</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ã‚·ã‚¹ãƒ†ãƒ å¥åº·çŠ¶æ…‹ -->
                    <div style="background: white; border-radius: 8px; padding: 15px; border-left: 4px solid #10b981;">
                        <h4 style="margin: 0 0 10px 0; color: #047857;">ğŸ’š ã‚·ã‚¹ãƒ†ãƒ å¥åº·çŠ¶æ…‹</h4>
                        <div style="display: flex; gap: 20px; flex-wrap: wrap; font-size: 0.9rem;">
                            <div>
                                <span style="color: #6b7280;">ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡:</span>
                                <span id="memoryUsage" style="font-weight: 600; color: #374151;">--</span>
                            </div>
                            <div>
                                <span style="color: #6b7280;">CPUä½¿ç”¨ç‡:</span>
                                <span id="cpuUsage" style="font-weight: 600; color: #374151;">--</span>
                            </div>
                            <div>
                                <span style="color: #6b7280;">ã‚¢ãƒƒãƒ—ã‚¿ã‚¤ãƒ :</span>
                                <span id="systemUptime" style="font-weight: 600; color: #374151;">--</span>
                            </div>
                            <div>
                                <span style="color: #6b7280;">æœ€å¾Œã®å¥åº·ãƒã‚§ãƒƒã‚¯:</span>
                                <span id="lastHealthCheck" style="font-weight: 600; color: #374151;">--:--</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="templateModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 12px; max-width: 600px; width: 90%; max-height: 80%; overflow-y: auto; box-shadow: 0 20px 50px rgba(0,0,0,0.3);">
            <div style="padding: 25px; border-bottom: 1px solid #e5e7eb;">
                <h3 style="margin: 0; color: #374151;">ğŸ“‚ ä¿å­˜æ¸ˆã¿ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</h3>
            </div>
            <div id="templateList" style="padding: 20px; max-height: 400px; overflow-y: auto;"></div>
            <div style="padding: 20px; border-top: 1px solid #e5e7eb; display: flex; gap: 10px; justify-content: flex-end;">
                <button id="closeTemplateModalBtn" class="btn btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button id="deleteAllTemplatesBtn" class="btn btn-danger">ğŸ—‘ï¸ å…¨å‰Šé™¤</button>
            </div>
        </div>
    </div>
    
    <!-- ãƒ†ã‚¹ãƒˆé€ä¿¡ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="testSendModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 12px; max-width: 500px; width: 90%; box-shadow: 0 20px 50px rgba(0,0,0,0.3);">
            <div style="padding: 25px; border-bottom: 1px solid #e5e7eb;">
                <h3 style="margin: 0; color: #374151;">ğŸ“§ ãƒ†ã‚¹ãƒˆé€ä¿¡</h3>
            </div>
            <div style="padding: 20px;">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">é€ä¿¡å…ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                    <input type="email" id="testEmailAddress" placeholder="admin@example.com" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;" />
                    <small style="color: #6b7280; display: block; margin-top: 5px;">ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã™ã‚‹ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</small>
                </div>
                
                <div style="background: #fef3c7; padding: 15px; border-radius: 8px; border-left: 4px solid #f59e0b; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0; color: #92400e;">âš ï¸ ãƒ†ã‚¹ãƒˆé€ä¿¡ã«ã¤ã„ã¦</h4>
                    <ul style="margin: 0; padding-left: 20px; color: #78350f; font-size: 0.9em;">
                        <li>ç¾åœ¨ã®è¨­å®šå†…å®¹ã§ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã™</li>
                        <li>ä»¶åã®å…ˆé ­ã«ã€Œ[TEST] ã€ãŒè¿½åŠ ã•ã‚Œã¾ã™</li>
                        <li>å®Ÿéš›ã®é…ä¿¡ãƒªã‚¹ãƒˆã«ã¯å½±éŸ¿ã—ã¾ã›ã‚“</li>
                        <li>é€ä¿¡å±¥æ­´ã«ã‚‚è¨˜éŒ²ã•ã‚Œã¾ã›ã‚“</li>
                    </ul>
                </div>
                
                <div id="testSendStatus" style="margin-bottom: 15px;"></div>
            </div>
            <div style="padding: 20px; border-top: 1px solid #e5e7eb; display: flex; gap: 10px; justify-content: flex-end;">
                <button id="cancelTestSendBtn" class="btn btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button id="executeTestSendBtn" class="btn btn-warning">ğŸ“§ ãƒ†ã‚¹ãƒˆé€ä¿¡å®Ÿè¡Œ</button>
            </div>
        </div>
    </div>
</BaseLayout>

<script>
    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¿ã‚¤ãƒ—ã®è¡¨ç¤ºåˆ¶å¾¡é–¢æ•°
    function updateTemplateSection() {
        const templateType = document.getElementById('templateType');
        const predictionSection = document.getElementById('predictionSection');
        const resultSection = document.getElementById('resultSection');
        const campaignSection = document.getElementById('campaignSection');
        const customSection = document.getElementById('customSection');
        
        // å…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º
        [predictionSection, resultSection, campaignSection, customSection].forEach(section => {
            if (section) section.style.display = 'none';
        });
        
        // é¸æŠã•ã‚ŒãŸã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦è¡¨ç¤º
        if (templateType) {
            switch (templateType.value) {
                case 'prediction':
                    if (predictionSection) {
                        predictionSection.style.display = 'block';
                        console.log('ğŸ¯ äºˆæƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º');
                    }
                    break;
                case 'result':
                    if (resultSection) {
                        resultSection.style.display = 'block';
                        console.log('ğŸ“Š çµæœå ±å‘Šã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º');
                    }
                    break;
                case 'campaign':
                    if (campaignSection) {
                        campaignSection.style.display = 'block';
                        console.log('ğŸª ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º');
                    }
                    break;
                case 'custom':
                    if (customSection) {
                        customSection.style.display = 'block';
                        console.log('ğŸ¨ ã‚«ã‚¹ã‚¿ãƒ ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º');
                    }
                    break;
            }
        }
    }

    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¿ã‚¤ãƒ—å¤‰æ›´æ™‚ã®å‡¦ç†
    const templateType = document.getElementById('templateType');
    templateType?.addEventListener('change', updateTemplateSection);

    // CTAãƒœã‚¿ãƒ³è¡¨ç¤º/éè¡¨ç¤ºåˆ¶å¾¡
    function updateCtaButtonSettings() {
        const showCtaButton = document.getElementById('showCtaButton');
        const ctaButtonSettings = document.getElementById('ctaButtonSettings');
        
        if (showCtaButton && ctaButtonSettings) {
            ctaButtonSettings.style.display = showCtaButton.checked ? 'block' : 'none';
        }
    }

    // CTAãƒœã‚¿ãƒ³ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹å¤‰æ›´æ™‚ã®å‡¦ç†
    document.getElementById('showCtaButton')?.addEventListener('change', updateCtaButtonSettings);

    // äºˆæƒ³è¿½åŠ ãƒœã‚¿ãƒ³
    document.getElementById('addPrediction')?.addEventListener('click', () => {
        const container = document.getElementById('predictionsContainer');
        const newPrediction = document.createElement('div');
        newPrediction.className = 'prediction-input';
        newPrediction.innerHTML = `
            <input type="text" placeholder="ãƒ¬ãƒ¼ã‚¹å" class="race-name" />
            <textarea placeholder="äºˆæƒ³é¦¬ï¼ˆæ”¹è¡ŒåŒºåˆ‡ã‚Šï¼‰" rows="3" class="race-horses"></textarea>
            <button type="button" class="remove-prediction">å‰Šé™¤</button>
        `;
        container.appendChild(newPrediction);
        
        // å‰Šé™¤ãƒœã‚¿ãƒ³ã®å‡¦ç†
        newPrediction.querySelector('.remove-prediction')?.addEventListener('click', () => {
            newPrediction.remove();
        });
    });

    // çµæœè¿½åŠ ãƒœã‚¿ãƒ³
    document.getElementById('addResult')?.addEventListener('click', () => {
        const container = document.getElementById('resultsContainer');
        const newResult = document.createElement('div');
        newResult.className = 'result-input';
        newResult.innerHTML = `
            <input type="text" placeholder="ãƒ¬ãƒ¼ã‚¹å" class="result-race-name" />
            <div class="result-details">
                <input type="text" placeholder="1ç€é¦¬" class="result-winner" />
                <input type="text" placeholder="é…å½“ï¼ˆä¾‹: Â¥1,200ï¼‰" class="result-payout" />
                <select class="result-status">
                    <option value="hit">ğŸ¯ çš„ä¸­ï¼</option>
                    <option value="miss">âŒ ä¸çš„ä¸­</option>
                    <option value="near">ğŸ“ˆ æƒœã—ã„ï¼</option>
                </select>
                <button type="button" class="remove-result">å‰Šé™¤</button>
            </div>
        `;
        container.appendChild(newResult);
        
        // å‰Šé™¤ãƒœã‚¿ãƒ³ã®å‡¦ç†
        newResult.querySelector('.remove-result')?.addEventListener('click', () => {
            newResult.remove();
        });
    });

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹é–¢æ•°
    function clearPreview() {
        const previewArea = document.getElementById('previewArea');
        previewArea.innerHTML = `
            <div class="preview-placeholder">
                ãƒ¡ãƒ¼ãƒ«ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤ºã—ã¾ã™<br>
                <small>å·¦ã®ã€Œãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯</small>
            </div>
        `;
    }
    
    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆé–¢æ•° - å…¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¿ã‚¤ãƒ—å¯¾å¿œ
    function generatePreview() {
        try {
            const subject = document.getElementById('subject').value;
            const templateType = document.getElementById('templateType').value;
            const mainContent = document.getElementById('mainContent').value;
            
            if (!subject) {
                document.getElementById('previewArea').innerHTML = '<p class="error">ä»¶åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>';
                return;
            }

            // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¿ã‚¤ãƒ—åˆ¥ãƒ‡ãƒ¼ã‚¿åé›†
            let templateData = {
                title: subject,
                mainContent: mainContent,
                templateType: templateType,
                theme: document.getElementById('customTheme')?.value || 'blue',
                layoutOrder: document.getElementById('layoutOrder')?.value || 'content-first',
                predictionNote: document.getElementById('predictionNote')?.value || '',
                additionalSection: document.getElementById('additionalSection')?.value || '',
                showCtaButton: document.getElementById('showCtaButton')?.checked || false,
                customCtaText: document.getElementById('customCtaText')?.value || '',
                customCtaUrl: document.getElementById('customCtaUrl')?.value || 'https://nankan-analytics.keiba.link/pricing/'
            };

            if (templateType === 'prediction') {
                // äºˆæƒ³ãƒ‡ãƒ¼ã‚¿åé›†
                const predictionInputs = document.querySelectorAll('.prediction-input');
                templateData.predictions = Array.from(predictionInputs).map(input => {
                    const raceName = input.querySelector('.race-name')?.value || '';
                    const horses = (input.querySelector('.race-horses')?.value || '')
                        .split('\n')
                        .filter(h => h.trim())
                        .map(h => h.trim());
                    return { raceName, horses };
                }).filter(p => p.raceName && p.horses.length > 0);
            } else if (templateType === 'result') {
                templateData.results = collectResultData();
            } else if (templateType === 'campaign') {
                templateData.campaign = collectCampaignData();
            } else if (templateType === 'custom') {
                templateData.custom = collectCustomData();
            }

            // é«˜åº¦ãªHTMLç”Ÿæˆ
            const htmlContent = generateAdvancedNewsletterHTML(templateData);
            
            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ã«è¡¨ç¤º
            const previewArea = document.getElementById('previewArea');
            if (previewArea) {
                previewArea.innerHTML = `
                    <iframe srcdoc="${htmlContent.replace(/"/g, '&quot;')}" 
                            style="width: 100%; height: 600px; border: 1px solid #ddd; border-radius: 10px; background: white; box-shadow: 0 10px 25px rgba(0,0,0,0.1);">
                    </iframe>
                `;
                console.log('âœ… ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆå®Œäº† - ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¿ã‚¤ãƒ—:', templateType);
            }
            
            // HTMLã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚‚æ›´æ–°
            const htmlContentField = document.getElementById('htmlContent');
            if (htmlContentField) {
                htmlContentField.value = htmlContent;
            }
            
        } catch (error) {
            console.error('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
            document.getElementById('previewArea').innerHTML = '<p class="error">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆã‚¨ãƒ©ãƒ¼: ' + error.message + '</p>';
        }
    }
    
    // äºˆæƒ³ãƒ‡ãƒ¼ã‚¿åé›†
    function collectPredictionData() {
        const races = [];
        for (let i = 1; i <= 3; i++) {
            const raceName = document.getElementById(`race${i}Name`)?.value;
            const horses = [];
            for (let j = 1; j <= 3; j++) {
                const horse = document.getElementById(`race${i}Horse${j}`)?.value;
                if (horse) horses.push(horse);
            }
            if (raceName || horses.length > 0) {
                races.push({ name: raceName || `ç¬¬${i}ãƒ¬ãƒ¼ã‚¹`, horses });
            }
        }
        return { races, highlight: document.getElementById('predictionHighlight')?.value || '' };
    }
    
    // çµæœãƒ‡ãƒ¼ã‚¿åé›†
    function collectResultData() {
        const results = [];
        for (let i = 1; i <= 3; i++) {
            const raceName = document.getElementById(`result${i}Race`)?.value;
            const prediction = document.getElementById(`result${i}Prediction`)?.value;
            const actual = document.getElementById(`result${i}Actual`)?.value;
            const status = document.getElementById(`result${i}Status`)?.value;
            if (raceName || prediction) {
                results.push({ raceName, prediction, actual, status });
            }
        }
        return {
            results,
            monthlyHitRate: document.getElementById('monthlyHitRate')?.value || '',
            monthlyROI: document.getElementById('monthlyROI')?.value || ''
        };
    }
    
    // ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ãƒ‡ãƒ¼ã‚¿åé›†
    function collectCampaignData() {
        return {
            title: document.getElementById('campaignTitle')?.value || '',
            description: document.getElementById('campaignDescription')?.value || '',
            discount: document.getElementById('campaignDiscount')?.value || '',
            period: document.getElementById('campaignPeriod')?.value || '',
            beforePrice: document.getElementById('campaignBeforePrice')?.value || '',
            afterPrice: document.getElementById('campaignAfterPrice')?.value || ''
        };
    }
    
    // ã‚«ã‚¹ã‚¿ãƒ ãƒ‡ãƒ¼ã‚¿åé›†
    function collectCustomData() {
        return {
            headline: document.getElementById('customHeadline')?.value || '',
            message: document.getElementById('customMessage')?.value || '',
            feature1: document.getElementById('customFeature1')?.value || '',
            feature2: document.getElementById('customFeature2')?.value || '',
            feature3: document.getElementById('customFeature3')?.value || ''
        };
    }

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³
    document.getElementById('clearPreviewBtn')?.addEventListener('click', clearPreview);

    // ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›å¤‰æ›´æ™‚ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è‡ªå‹•ã‚¯ãƒªã‚¢
    const formInputs = ['subject', 'mainContent', 'targetPlan', 'templateType', 'scheduledAt', 'layoutOrder', 'predictionNote', 'additionalSection', 'customCtaText', 'customCtaUrl'];
    formInputs.forEach(inputId => {
        const element = document.getElementById(inputId);
        element?.addEventListener('input', clearPreview);
        element?.addEventListener('change', clearPreview);
    });

    // ================================
    // A/Bãƒ†ã‚¹ãƒˆæ©Ÿèƒ½
    // ================================
    
    // A/Bãƒ†ã‚¹ãƒˆç®¡ç†ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
    const abTestManager = {
        currentTest: null,
        activeTests: [],
        completedTests: [],
        
        // ãƒ†ã‚¹ãƒˆè¨­å®šãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        getTestSettings() {
            const enableAbTest = document.getElementById('enableAbTest')?.checked;
            if (!enableAbTest) return null;
            
            return {
                enabled: true,
                versionARatio: parseInt(document.getElementById('versionARatio')?.value) || 50,
                versionBRatio: 100 - (parseInt(document.getElementById('versionARatio')?.value) || 50),
                minSampleSize: parseInt(document.getElementById('minSampleSize')?.value) || 100,
                testType: document.querySelector('input[name="testType"]:checked')?.value || 'subject',
                significanceLevel: parseFloat(document.getElementById('significanceLevel')?.value) || 0.05,
                statisticalPower: parseFloat(document.getElementById('statisticalPower')?.value) || 0.80,
                testDuration: parseInt(document.getElementById('testDuration')?.value) || 48,
                kpis: {
                    openRate: document.getElementById('kpiOpenRate')?.checked || false,
                    clickRate: document.getElementById('kpiClickRate')?.checked || false,
                    conversion: document.getElementById('kpiConversion')?.checked || false,
                    unsubscribe: document.getElementById('kpiUnsubscribe')?.checked || false
                },
                versionA: this.getVersionData('A'),
                versionB: this.getVersionData('B')
            };
        },
        
        // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        getVersionData(version) {
            const testType = document.querySelector('input[name="testType"]:checked')?.value || 'subject';
            const data = { version, testType };
            
            switch (testType) {
                case 'subject':
                    data.subject = document.getElementById(`subjectVersion${version}`)?.value || '';
                    break;
                case 'content':
                    data.content = document.getElementById(`contentVersion${version}`)?.value || '';
                    break;
                case 'cta':
                    data.ctaText = document.getElementById(`ctaTextVersion${version}`)?.value || '';
                    data.ctaColor = document.getElementById(`ctaColorVersion${version}`)?.value || '#3b82f6';
                    break;
                case 'timing':
                    data.timing = document.getElementById(`timingVersion${version}`)?.value || '';
                    break;
            }
            
            return data;
        },
        
        // ãƒ†ã‚¹ãƒˆé…ä¿¡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
        updatePreview() {
            const settings = this.getTestSettings();
            const previewArea = document.getElementById('abTestSummary');
            
            if (!settings || !settings.enabled) {
                previewArea.innerHTML = 'A/Bãƒ†ã‚¹ãƒˆãŒç„¡åŠ¹ã«ãªã£ã¦ã„ã¾ã™';
                return;
            }
            
            let html = `
                <div style="margin-bottom: 15px;">
                    <strong>ğŸ“Š é…ä¿¡æ¯”ç‡:</strong> ãƒãƒ¼ã‚¸ãƒ§ãƒ³A ${settings.versionARatio}% / ãƒãƒ¼ã‚¸ãƒ§ãƒ³B ${settings.versionBRatio}%
                </div>
                <div style="margin-bottom: 15px;">
                    <strong>ğŸ¯ ãƒ†ã‚¹ãƒˆé …ç›®:</strong> ${this.getTestTypeLabel(settings.testType)}
                </div>
                <div style="margin-bottom: 15px;">
                    <strong>ğŸ“ˆ çµ±è¨ˆè¨­å®š:</strong> æœ‰æ„æ°´æº–${(settings.significanceLevel * 100)}% / æ¤œå‡ºåŠ›${(settings.statisticalPower * 100)}% / æœŸé–“${settings.testDuration}æ™‚é–“
                </div>
                <div style="margin-bottom: 15px;">
                    <strong>ğŸ“§ æœ€å°ã‚µãƒ³ãƒ—ãƒ«:</strong> ${settings.minSampleSize}ä»¶
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px;">
                    <div style="background: #fef3c7; padding: 10px; border-radius: 6px;">
                        <div style="font-weight: 600; color: #92400e; margin-bottom: 8px;">ğŸ…°ï¸ ãƒãƒ¼ã‚¸ãƒ§ãƒ³A</div>
                        ${this.getVersionPreview(settings.versionA)}
                    </div>
                    <div style="background: #ecfdf5; padding: 10px; border-radius: 6px;">
                        <div style="font-weight: 600; color: #047857; margin-bottom: 8px;">ğŸ…±ï¸ ãƒãƒ¼ã‚¸ãƒ§ãƒ³B</div>
                        ${this.getVersionPreview(settings.versionB)}
                    </div>
                </div>
            `;
            
            previewArea.innerHTML = html;
        },
        
        // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç”Ÿæˆ
        getVersionPreview(versionData) {
            const testType = versionData.testType;
            switch (testType) {
                case 'subject':
                    return `ä»¶å: "${versionData.subject || 'æœªè¨­å®š'}"`;
                case 'content':
                    return `æœ¬æ–‡: "${versionData.content ? versionData.content.substring(0, 50) + '...' : 'æœªè¨­å®š'}"`;
                case 'cta':
                    return `CTA: "${versionData.ctaText || 'æœªè¨­å®š'}" (è‰²: ${versionData.ctaColor})`;
                case 'timing':
                    return `é…ä¿¡æ™‚é–“: ${versionData.timing || 'æœªè¨­å®š'}`;
                default:
                    return 'æœªè¨­å®š';
            }
        },
        
        // ãƒ†ã‚¹ãƒˆã‚¿ã‚¤ãƒ—ã®ãƒ©ãƒ™ãƒ«ã‚’å–å¾—
        getTestTypeLabel(testType) {
            const labels = {
                subject: 'ğŸ“§ ä»¶åãƒ†ã‚¹ãƒˆ',
                content: 'ğŸ“ æœ¬æ–‡ãƒ†ã‚¹ãƒˆ',
                cta: 'ğŸ¯ CTAãƒœã‚¿ãƒ³ãƒ†ã‚¹ãƒˆ',
                timing: 'â° é…ä¿¡æ™‚é–“ãƒ†ã‚¹ãƒˆ'
            };
            return labels[testType] || 'Unknown';
        },
        
        // A/Bãƒ†ã‚¹ãƒˆã‚’é–‹å§‹
        startTest() {
            const settings = this.getTestSettings();
            if (!settings) {
                alert('A/Bãƒ†ã‚¹ãƒˆè¨­å®šãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã¾ã›ã‚“');
                return false;
            }
            
            // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            if (!this.validateTestSettings(settings)) {
                return false;
            }
            
            // ãƒ†ã‚¹ãƒˆä½œæˆ
            const testId = 'test_' + Date.now();
            const newTest = {
                id: testId,
                status: 'active',
                startTime: new Date().toISOString(),
                endTime: new Date(Date.now() + settings.testDuration * 60 * 60 * 1000).toISOString(),
                settings: settings,
                results: {
                    versionA: { sent: 0, opened: 0, clicked: 0, converted: 0, unsubscribed: 0 },
                    versionB: { sent: 0, opened: 0, clicked: 0, converted: 0, unsubscribed: 0 }
                },
                recipientLists: {
                    versionA: [],
                    versionB: []
                }
            };
            
            // ãƒ†ã‚¹ãƒˆã‚’ä¿å­˜
            this.activeTests.push(newTest);
            this.currentTest = newTest;
            this.saveTestData();
            
            console.log('A/Bãƒ†ã‚¹ãƒˆé–‹å§‹:', newTest);
            alert(`A/Bãƒ†ã‚¹ãƒˆ "${testId}" ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚${settings.testDuration}æ™‚é–“å¾Œã«çµæœã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
            
            return true;
        },
        
        // ãƒ†ã‚¹ãƒˆè¨­å®šã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        validateTestSettings(settings) {
            if (!settings.versionA || !settings.versionB) {
                alert('ãƒãƒ¼ã‚¸ãƒ§ãƒ³Aã¨Bã®ä¸¡æ–¹ã‚’è¨­å®šã—ã¦ãã ã•ã„');
                return false;
            }
            
            // ãƒ†ã‚¹ãƒˆã‚¿ã‚¤ãƒ—åˆ¥ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            switch (settings.testType) {
                case 'subject':
                    if (!settings.versionA.subject || !settings.versionB.subject) {
                        alert('ä¸¡æ–¹ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ä»¶åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                        return false;
                    }
                    if (settings.versionA.subject === settings.versionB.subject) {
                        alert('ãƒãƒ¼ã‚¸ãƒ§ãƒ³Aã¨Bã®ä»¶åã¯ç•°ãªã‚‹å†…å®¹ã«ã—ã¦ãã ã•ã„');
                        return false;
                    }
                    break;
                case 'content':
                    if (!settings.versionA.content || !settings.versionB.content) {
                        alert('ä¸¡æ–¹ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                        return false;
                    }
                    break;
                case 'cta':
                    if (!settings.versionA.ctaText || !settings.versionB.ctaText) {
                        alert('ä¸¡æ–¹ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®CTAãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                        return false;
                    }
                    break;
                case 'timing':
                    if (!settings.versionA.timing || !settings.versionB.timing) {
                        alert('ä¸¡æ–¹ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®é…ä¿¡æ™‚é–“ã‚’è¨­å®šã—ã¦ãã ã•ã„');
                        return false;
                    }
                    break;
            }
            
            return true;
        },
        
        // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
        saveTestData() {
            localStorage.setItem('abTest-activeTests', JSON.stringify(this.activeTests));
            localStorage.setItem('abTest-completedTests', JSON.stringify(this.completedTests));
        },
        
        // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
        loadTestData() {
            try {
                this.activeTests = JSON.parse(localStorage.getItem('abTest-activeTests') || '[]');
                this.completedTests = JSON.parse(localStorage.getItem('abTest-completedTests') || '[]');
            } catch (error) {
                console.error('A/Bãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                this.activeTests = [];
                this.completedTests = [];
            }
        },
        
        // ãƒ†ã‚¹ãƒˆçµæœã‚’è¡¨ç¤º
        displayTestResults(testList, containerId) {
            const container = document.getElementById(containerId);
            if (!container || !testList || testList.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #6b7280; padding: 40px;">
                        <div style="font-size: 1.5rem; margin-bottom: 10px;">ğŸ“Š</div>
                        <p>ãƒ†ã‚¹ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            testList.forEach(test => {
                const isComplete = test.status === 'completed' || new Date(test.endTime) < new Date();
                const duration = this.formatDuration(new Date(test.startTime), new Date(test.endTime));
                
                html += `
                    <div style="background: white; border-radius: 8px; padding: 20px; margin-bottom: 15px; border: 2px solid ${isComplete ? '#10b981' : '#3b82f6'};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div>
                                <h4 style="margin: 0; color: #374151;">${test.id}</h4>
                                <small style="color: #6b7280;">${this.getTestTypeLabel(test.settings.testType)} | ${duration}</small>
                            </div>
                            <div style="padding: 4px 12px; background: ${isComplete ? '#10b981' : '#3b82f6'}; color: white; border-radius: 12px; font-size: 0.8rem;">
                                ${isComplete ? 'âœ… å®Œäº†' : 'ğŸ”„ é€²è¡Œä¸­'}
                            </div>
                        </div>
                        ${this.renderTestResults(test)}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        },
        
        // ãƒ†ã‚¹ãƒˆçµæœã®è©³ç´°ã‚’ç”Ÿæˆ
        renderTestResults(test) {
            const versionA = test.results.versionA;
            const versionB = test.results.versionB;
            
            return `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h5 style="margin: 0 0 10px 0; color: #92400e;">ğŸ…°ï¸ ãƒãƒ¼ã‚¸ãƒ§ãƒ³A</h5>
                        <div style="font-size: 0.9rem; line-height: 1.5;">
                            é…ä¿¡æ•°: ${versionA.sent}<br>
                            é–‹å°æ•°: ${versionA.opened} (${this.calculateRate(versionA.opened, versionA.sent)}%)<br>
                            ã‚¯ãƒªãƒƒã‚¯æ•°: ${versionA.clicked} (${this.calculateRate(versionA.clicked, versionA.sent)}%)<br>
                            ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${versionA.converted}<br>
                            é…ä¿¡åœæ­¢: ${versionA.unsubscribed}
                        </div>
                    </div>
                    <div>
                        <h5 style="margin: 0 0 10px 0; color: #047857;">ğŸ…±ï¸ ãƒãƒ¼ã‚¸ãƒ§ãƒ³B</h5>
                        <div style="font-size: 0.9rem; line-height: 1.5;">
                            é…ä¿¡æ•°: ${versionB.sent}<br>
                            é–‹å°æ•°: ${versionB.opened} (${this.calculateRate(versionB.opened, versionB.sent)}%)<br>
                            ã‚¯ãƒªãƒƒã‚¯æ•°: ${versionB.clicked} (${this.calculateRate(versionB.clicked, versionB.sent)}%)<br>
                            ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${versionB.converted}<br>
                            é…ä¿¡åœæ­¢: ${versionB.unsubscribed}
                        </div>
                    </div>
                </div>
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                    <div style="font-size: 0.9rem; color: #6b7280;">
                        ${this.getWinnerAnalysis(test)}
                    </div>
                </div>
            `;
        },
        
        // å‹è€…åˆ†æã‚’ç”Ÿæˆ
        getWinnerAnalysis(test) {
            // ç°¡å˜ãªå‹è€…åˆ¤å®šï¼ˆå®Ÿéš›ã¯ã‚ˆã‚Šè¤‡é›‘ãªçµ±è¨ˆåˆ†æãŒå¿…è¦ï¼‰
            const aOpenRate = this.calculateRate(test.results.versionA.opened, test.results.versionA.sent);
            const bOpenRate = this.calculateRate(test.results.versionB.opened, test.results.versionB.sent);
            
            const aClickRate = this.calculateRate(test.results.versionA.clicked, test.results.versionA.sent);
            const bClickRate = this.calculateRate(test.results.versionB.clicked, test.results.versionB.sent);
            
            let winner = '';
            if (aOpenRate > bOpenRate && aClickRate > bClickRate) {
                winner = 'ğŸ…°ï¸ ãƒãƒ¼ã‚¸ãƒ§ãƒ³AãŒå„ªå‹¢';
            } else if (bOpenRate > aOpenRate && bClickRate > aClickRate) {
                winner = 'ğŸ…±ï¸ ãƒãƒ¼ã‚¸ãƒ§ãƒ³BãŒå„ªå‹¢';
            } else {
                winner = 'âš–ï¸ æ‹®æŠ—ï¼ˆã•ã‚‰ãªã‚‹ãƒ‡ãƒ¼ã‚¿ãŒå¿…è¦ï¼‰';
            }
            
            return `
                <strong>åˆ¤å®šçµæœ:</strong> ${winner}<br>
                <strong>é–‹å°ç‡å·®:</strong> ${(bOpenRate - aOpenRate).toFixed(2)}%pt | 
                <strong>ã‚¯ãƒªãƒƒã‚¯ç‡å·®:</strong> ${(bClickRate - aClickRate).toFixed(2)}%pt
            `;
        },
        
        // ç‡ã‚’è¨ˆç®—
        calculateRate(numerator, denominator) {
            return denominator > 0 ? ((numerator / denominator) * 100).toFixed(1) : '0.0';
        },
        
        // æœŸé–“ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        formatDuration(start, end) {
            const diffMs = end - start;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            return `${diffHours}æ™‚é–“`;
        }
    };

    // A/Bãƒ†ã‚¹ãƒˆé–¢é€£ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    
    // A/Bãƒ†ã‚¹ãƒˆæœ‰åŠ¹åŒ–åˆ‡ã‚Šæ›¿ãˆ
    document.getElementById('enableAbTest')?.addEventListener('change', function() {
        const settings = document.getElementById('abTestSettings');
        const startBtn = document.getElementById('startAbTestBtn');
        
        if (this.checked) {
            settings.style.display = 'block';
            startBtn.disabled = false;
            abTestManager.updatePreview();
        } else {
            settings.style.display = 'none';
            startBtn.disabled = true;
            document.getElementById('abTestSummary').innerHTML = 'ãƒ†ã‚¹ãƒˆè¨­å®šã‚’æœ‰åŠ¹ã«ã—ã¦è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„';
        }
    });
    
    // ãƒãƒ¼ã‚¸ãƒ§ãƒ³Aé…ä¿¡æ¯”ç‡å¤‰æ›´æ™‚ã«è‡ªå‹•ã§Bã‚’æ›´æ–°
    document.getElementById('versionARatio')?.addEventListener('change', function() {
        const bRatio = 100 - parseInt(this.value);
        document.getElementById('versionBRatio').value = bRatio + '%';
        abTestManager.updatePreview();
    });
    
    // ãƒ†ã‚¹ãƒˆã‚¿ã‚¤ãƒ—å¤‰æ›´æ™‚ã«å¯¾å¿œã™ã‚‹ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º/éè¡¨ç¤º
    document.querySelectorAll('input[name="testType"]').forEach(radio => {
        radio.addEventListener('change', function() {
            // å…¨ã¦éè¡¨ç¤º
            document.querySelectorAll('.test-variation').forEach(el => {
                el.style.display = 'none';
            });
            
            // é¸æŠã•ã‚ŒãŸã‚¿ã‚¤ãƒ—ã®ã¿è¡¨ç¤º
            const selectedType = this.value;
            document.querySelectorAll(`#${selectedType}TestA, #${selectedType}TestB`).forEach(el => {
                el.style.display = 'block';
            });
            
            abTestManager.updatePreview();
        });
    });
    
    // è¨­å®šå¤‰æ›´æ™‚ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
    ['versionARatio', 'minSampleSize', 'significanceLevel', 'statisticalPower', 'testDuration',
     'subjectVersionA', 'subjectVersionB', 'contentVersionA', 'contentVersionB',
     'ctaTextVersionA', 'ctaTextVersionB', 'ctaColorVersionA', 'ctaColorVersionB',
     'timingVersionA', 'timingVersionB'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('input', () => abTestManager.updatePreview());
            element.addEventListener('change', () => abTestManager.updatePreview());
        }
    });
    
    // KPIå¤‰æ›´æ™‚ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
    ['kpiOpenRate', 'kpiClickRate', 'kpiConversion', 'kpiUnsubscribe'].forEach(id => {
        document.getElementById(id)?.addEventListener('change', () => abTestManager.updatePreview());
    });
    
    // A/Bãƒ†ã‚¹ãƒˆé–‹å§‹ãƒœã‚¿ãƒ³
    document.getElementById('startAbTestBtn')?.addEventListener('click', () => {
        if (confirm('A/Bãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿ\n\nãƒ†ã‚¹ãƒˆé–‹å§‹å¾Œã¯è¨­å®šã®å¤‰æ›´ãŒã§ãã¾ã›ã‚“ã€‚')) {
            if (abTestManager.startTest()) {
                // æˆåŠŸæ™‚ã¯ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä¸€éƒ¨ç„¡åŠ¹åŒ–
                document.getElementById('enableAbTest').disabled = true;
                document.getElementById('startAbTestBtn').innerHTML = 'â³ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...';
                document.getElementById('startAbTestBtn').disabled = true;
            }
        }
    });
    
    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³
    document.getElementById('previewAbTestBtn')?.addEventListener('click', () => {
        const settings = abTestManager.getTestSettings();
        if (!settings || !settings.enabled) {
            alert('A/Bãƒ†ã‚¹ãƒˆè¨­å®šã‚’æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„');
            return;
        }
        
        // ãƒãƒ¼ã‚¸ãƒ§ãƒ³Aã¨Bã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
        const previewWindow = window.open('', '_blank', 'width=1200,height=800,scrollbars=yes');
        previewWindow.document.write(`
            <!DOCTYPE html>
            <html>
                <head>
                    <title>A/Bãƒ†ã‚¹ãƒˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .version { margin: 20px 0; padding: 20px; border: 2px solid #ccc; border-radius: 8px; }
                        .version-a { border-color: #fbbf24; background: #fef3c7; }
                        .version-b { border-color: #10b981; background: #ecfdf5; }
                        h2 { margin-top: 0; }
                    </style>
                </head>
                <body>
                    <h1>ğŸ§ª A/Bãƒ†ã‚¹ãƒˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h1>
                    <div class="version version-a">
                        <h2>ğŸ…°ï¸ ãƒãƒ¼ã‚¸ãƒ§ãƒ³A</h2>
                        ${abTestManager.getVersionPreview(settings.versionA)}
                    </div>
                    <div class="version version-b">
                        <h2>ğŸ…±ï¸ ãƒãƒ¼ã‚¸ãƒ§ãƒ³B</h2>
                        ${abTestManager.getVersionPreview(settings.versionB)}
                    </div>
                </body>
            </html>
        `);
        previewWindow.document.close();
    });
    
    // ãƒ†ã‚¹ãƒˆè¨­å®šä¿å­˜
    document.getElementById('saveAbTestSettingsBtn')?.addEventListener('click', () => {
        const settings = abTestManager.getTestSettings();
        if (!settings) {
            alert('ä¿å­˜ã™ã‚‹è¨­å®šãŒã‚ã‚Šã¾ã›ã‚“');
            return;
        }
        
        const name = prompt('è¨­å®šã«åå‰ã‚’ä»˜ã‘ã¦ãã ã•ã„:', 'A/Bãƒ†ã‚¹ãƒˆè¨­å®š_' + new Date().toISOString().split('T')[0]);
        if (name) {
            const savedSettings = JSON.parse(localStorage.getItem('abTest-savedSettings') || '{}');
            savedSettings[name] = settings;
            localStorage.setItem('abTest-savedSettings', JSON.stringify(savedSettings));
            alert('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ: ' + name);
        }
    });
    
    // ãƒ†ã‚¹ãƒˆè¨­å®šèª­ã¿è¾¼ã¿
    document.getElementById('loadAbTestSettingsBtn')?.addEventListener('click', () => {
        const savedSettings = JSON.parse(localStorage.getItem('abTest-savedSettings') || '{}');
        const names = Object.keys(savedSettings);
        
        if (names.length === 0) {
            alert('ä¿å­˜ã•ã‚ŒãŸè¨­å®šãŒã‚ã‚Šã¾ã›ã‚“');
            return;
        }
        
        const name = prompt('èª­ã¿è¾¼ã‚€è¨­å®šã‚’é¸æŠã—ã¦ãã ã•ã„:\n\n' + names.join('\n'), names[0]);
        if (name && savedSettings[name]) {
            const settings = savedSettings[name];
            
            // è¨­å®šã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«åæ˜ 
            document.getElementById('enableAbTest').checked = settings.enabled;
            document.getElementById('versionARatio').value = settings.versionARatio;
            document.getElementById('minSampleSize').value = settings.minSampleSize;
            document.getElementById('significanceLevel').value = settings.significanceLevel;
            document.getElementById('statisticalPower').value = settings.statisticalPower;
            document.getElementById('testDuration').value = settings.testDuration;
            
            // ãƒ†ã‚¹ãƒˆã‚¿ã‚¤ãƒ—ã‚’é¸æŠ
            const testTypeRadio = document.querySelector(`input[name="testType"][value="${settings.testType}"]`);
            if (testTypeRadio) {
                testTypeRadio.checked = true;
                testTypeRadio.dispatchEvent(new Event('change'));
            }
            
            // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
            if (settings.versionA) {
                Object.keys(settings.versionA).forEach(key => {
                    const element = document.getElementById(key + 'VersionA');
                    if (element && settings.versionA[key] !== undefined) {
                        element.value = settings.versionA[key];
                    }
                });
            }
            
            if (settings.versionB) {
                Object.keys(settings.versionB).forEach(key => {
                    const element = document.getElementById(key + 'VersionB');
                    if (element && settings.versionB[key] !== undefined) {
                        element.value = settings.versionB[key];
                    }
                });
            }
            
            // KPIè¨­å®š
            if (settings.kpis) {
                Object.keys(settings.kpis).forEach(kpi => {
                    const element = document.getElementById('kpi' + kpi.charAt(0).toUpperCase() + kpi.slice(1));
                    if (element) {
                        element.checked = settings.kpis[kpi];
                    }
                });
            }
            
            // A/Bãƒ†ã‚¹ãƒˆè¨­å®šã‚’è¡¨ç¤º
            document.getElementById('enableAbTest').dispatchEvent(new Event('change'));
            
            alert('è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ: ' + name);
        }
    });
    
    // é€²è¡Œä¸­ãƒ†ã‚¹ãƒˆè¡¨ç¤º
    document.getElementById('loadActiveTestsBtn')?.addEventListener('click', () => {
        abTestManager.loadTestData();
        abTestManager.displayTestResults(abTestManager.activeTests, 'abTestResultsArea');
    });
    
    // å®Œäº†æ¸ˆã¿ãƒ†ã‚¹ãƒˆè¡¨ç¤º
    document.getElementById('loadCompletedTestsBtn')?.addEventListener('click', () => {
        abTestManager.loadTestData();
        abTestManager.displayTestResults(abTestManager.completedTests, 'abTestResultsArea');
    });
    
    // ãƒ†ã‚¹ãƒˆçµæœã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
    document.getElementById('exportTestResultsBtn')?.addEventListener('click', () => {
        abTestManager.loadTestData();
        const allTests = [...abTestManager.activeTests, ...abTestManager.completedTests];
        
        if (allTests.length === 0) {
            alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ†ã‚¹ãƒˆçµæœãŒã‚ã‚Šã¾ã›ã‚“');
            return;
        }
        
        const csv = abTestManager.exportToCsv(allTests);
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'ab-test-results_' + new Date().toISOString().split('T')[0] + '.csv';
        link.click();
    });
    
    // ãƒ†ã‚¹ãƒˆå±¥æ­´å‰Šé™¤
    document.getElementById('clearTestHistoryBtn')?.addEventListener('click', () => {
        if (confirm('å…¨ã¦ã®A/Bãƒ†ã‚¹ãƒˆå±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
            localStorage.removeItem('abTest-activeTests');
            localStorage.removeItem('abTest-completedTests');
            abTestManager.activeTests = [];
            abTestManager.completedTests = [];
            document.getElementById('abTestResultsArea').innerHTML = `
                <div style="text-align: center; color: #6b7280; padding: 40px;">
                    <div style="font-size: 2rem; margin-bottom: 10px;">ğŸ—‘ï¸</div>
                    <p>ãƒ†ã‚¹ãƒˆå±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸ</p>
                </div>
            `;
            alert('A/Bãƒ†ã‚¹ãƒˆå±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        }
    });
    
    // CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã‚’abTestManagerã«è¿½åŠ 
    abTestManager.exportToCsv = function(tests) {
        const headers = [
            'ãƒ†ã‚¹ãƒˆID', 'ãƒ†ã‚¹ãƒˆã‚¿ã‚¤ãƒ—', 'é–‹å§‹æ™‚é–“', 'çµ‚äº†æ™‚é–“', 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹',
            'Aé…ä¿¡æ•°', 'Aé–‹å°æ•°', 'Aé–‹å°ç‡', 'Aã‚¯ãƒªãƒƒã‚¯æ•°', 'Aã‚¯ãƒªãƒƒã‚¯ç‡', 'Aã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³', 'Aé…ä¿¡åœæ­¢',
            'Bé…ä¿¡æ•°', 'Bé–‹å°æ•°', 'Bé–‹å°ç‡', 'Bã‚¯ãƒªãƒƒã‚¯æ•°', 'Bã‚¯ãƒªãƒƒã‚¯ç‡', 'Bã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³', 'Bé…ä¿¡åœæ­¢',
            'é–‹å°ç‡å·®', 'ã‚¯ãƒªãƒƒã‚¯ç‡å·®', 'å‹è€…'
        ];
        
        let csv = headers.join(',') + '\n';
        
        tests.forEach(test => {
            const aOpenRate = this.calculateRate(test.results.versionA.opened, test.results.versionA.sent);
            const bOpenRate = this.calculateRate(test.results.versionB.opened, test.results.versionB.sent);
            const aClickRate = this.calculateRate(test.results.versionA.clicked, test.results.versionA.sent);
            const bClickRate = this.calculateRate(test.results.versionB.clicked, test.results.versionB.sent);
            
            const openRateDiff = (parseFloat(bOpenRate) - parseFloat(aOpenRate)).toFixed(2);
            const clickRateDiff = (parseFloat(bClickRate) - parseFloat(aClickRate)).toFixed(2);
            
            let winner = 'Draw';
            if (parseFloat(bOpenRate) > parseFloat(aOpenRate) && parseFloat(bClickRate) > parseFloat(aClickRate)) {
                winner = 'Version B';
            } else if (parseFloat(aOpenRate) > parseFloat(bOpenRate) && parseFloat(aClickRate) > parseFloat(bClickRate)) {
                winner = 'Version A';
            }
            
            const row = [
                test.id,
                test.settings.testType,
                test.startTime,
                test.endTime,
                test.status,
                test.results.versionA.sent,
                test.results.versionA.opened,
                aOpenRate,
                test.results.versionA.clicked,
                aClickRate,
                test.results.versionA.converted,
                test.results.versionA.unsubscribed,
                test.results.versionB.sent,
                test.results.versionB.opened,
                bOpenRate,
                test.results.versionB.clicked,
                bClickRate,
                test.results.versionB.converted,
                test.results.versionB.unsubscribed,
                openRateDiff,
                clickRateDiff,
                winner
            ];
            
            csv += row.join(',') + '\n';
        });
        
        return csv;
    };
    
    // åˆæœŸåŒ–æ™‚ã«ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
    abTestManager.loadTestData();

    // ================================
    // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«æ·»ä»˜æ©Ÿèƒ½
    // ================================
    
    // ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
    const fileAttachmentManager = {
        attachedFiles: [],
        maxFileSize: 10 * 1024 * 1024, // 10MB
        maxFiles: 5,
        maxTotalSize: 25 * 1024 * 1024, // 25MB
        allowedTypes: ['image/jpeg', 'image/png', 'image/gif', 'application/pdf', 'application/zip', 
                      'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                      'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'],
        
        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ 
        addFile(file) {
            // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            if (!this.validateFile(file)) {
                return false;
            }
            
            // é‡è¤‡ãƒã‚§ãƒƒã‚¯
            if (this.attachedFiles.find(f => f.name === file.name && f.size === file.size)) {
                alert('åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ—¢ã«æ·»ä»˜ã•ã‚Œã¦ã„ã¾ã™: ' + file.name);
                return false;
            }
            
            // ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã‚’ä½œæˆ
            const fileInfo = {
                id: 'file_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                file: file,
                name: file.name,
                size: file.size,
                type: file.type,
                isImage: file.type.startsWith('image/'),
                previewUrl: null,
                insertedInEmail: false,
                uploadDate: new Date().toISOString()
            };
            
            // ç”»åƒã®å ´åˆã¯ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼URLã‚’ä½œæˆ
            if (fileInfo.isImage) {
                fileInfo.previewUrl = URL.createObjectURL(file);
            }
            
            this.attachedFiles.push(fileInfo);
            this.updateFileList();
            this.updateStatistics();
            
            console.log('ãƒ•ã‚¡ã‚¤ãƒ«è¿½åŠ :', fileInfo);
            return true;
        },
        
        // ãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        validateFile(file) {
            // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
            if (file.size > this.maxFileSize) {
                alert(`ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™: ${file.name}\næœ€å¤§ã‚µã‚¤ã‚º: ${this.formatFileSize(this.maxFileSize)}`);
                return false;
            }
            
            // ãƒ•ã‚¡ã‚¤ãƒ«æ•°åˆ¶é™
            if (this.attachedFiles.length >= this.maxFiles) {
                alert(`æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«æ•°ãŒä¸Šé™ã‚’è¶…ãˆã¦ã„ã¾ã™ (æœ€å¤§${this.maxFiles}ãƒ•ã‚¡ã‚¤ãƒ«)`);
                return false;
            }
            
            // åˆè¨ˆã‚µã‚¤ã‚ºåˆ¶é™
            const totalSize = this.getTotalFileSize() + file.size;
            if (totalSize > this.maxTotalSize) {
                alert(`åˆè¨ˆãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒä¸Šé™ã‚’è¶…ãˆã¦ã„ã¾ã™\nä¸Šé™: ${this.formatFileSize(this.maxTotalSize)}\nç¾åœ¨: ${this.formatFileSize(totalSize)}`);
                return false;
            }
            
            // ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ãƒã‚§ãƒƒã‚¯
            if (!this.allowedTypes.includes(file.type)) {
                alert(`å¯¾å¿œã—ã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™: ${file.name}\nå¯¾å¿œå½¢å¼: JPG, PNG, GIF, PDF, ZIP, DOC, XLS`);
                return false;
            }
            
            return true;
        },
        
        // ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
        removeFile(fileId) {
            const index = this.attachedFiles.findIndex(f => f.id === fileId);
            if (index !== -1) {
                const fileInfo = this.attachedFiles[index];
                
                // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼URLã‚’å‰Šé™¤
                if (fileInfo.previewUrl) {
                    URL.revokeObjectURL(fileInfo.previewUrl);
                }
                
                this.attachedFiles.splice(index, 1);
                this.updateFileList();
                this.updateStatistics();
                
                console.log('ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤:', fileInfo.name);
            }
        },
        
        // å…¨ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
        clearAllFiles() {
            this.attachedFiles.forEach(fileInfo => {
                if (fileInfo.previewUrl) {
                    URL.revokeObjectURL(fileInfo.previewUrl);
                }
            });
            
            this.attachedFiles = [];
            this.updateFileList();
            this.updateStatistics();
            
            // UIã‚’éš ã™
            document.getElementById('attachedFilesList').style.display = 'none';
            document.getElementById('insertedImagesPreview').style.display = 'none';
        },
        
        // ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆè¡¨ç¤ºã‚’æ›´æ–°
        updateFileList() {
            const container = document.getElementById('fileListContainer');
            const listSection = document.getElementById('attachedFilesList');
            
            if (this.attachedFiles.length === 0) {
                listSection.style.display = 'none';
                return;
            }
            
            listSection.style.display = 'block';
            
            let html = '';
            this.attachedFiles.forEach(fileInfo => {
                const isImage = fileInfo.isImage;
                const icon = this.getFileIcon(fileInfo.type);
                
                html += `
                    <div class="file-item" style="display: flex; align-items: center; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 10px; background: ${isImage ? '#f0f9ff' : '#f9fafb'};">
                        ${isImage ? 
                            `<img src="${fileInfo.previewUrl}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 6px; margin-right: 15px;">` :
                            `<div style="width: 60px; height: 60px; background: #e5e7eb; border-radius: 6px; margin-right: 15px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">${icon}</div>`
                        }
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: 600; color: #374151; margin-bottom: 4px;">${fileInfo.name}</div>
                            <div style="font-size: 0.85rem; color: #6b7280; margin-bottom: 4px;">
                                ${this.formatFileSize(fileInfo.size)} | ${this.getFileTypeLabel(fileInfo.type)}
                            </div>
                            <div style="font-size: 0.75rem; color: #9ca3af;">
                                ${new Date(fileInfo.uploadDate).toLocaleString('ja-JP')}
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            ${isImage ? `<button onclick="fileAttachmentManager.insertImageIntoEmail('${fileInfo.id}')" class="btn btn-info" style="padding: 6px 12px; font-size: 0.8rem;">ğŸ“§ æŒ¿å…¥</button>` : ''}
                            <button onclick="fileAttachmentManager.previewFile('${fileInfo.id}')" class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.8rem;">ğŸ‘€</button>
                            <button onclick="fileAttachmentManager.removeFile('${fileInfo.id}')" class="btn btn-danger" style="padding: 6px 12px; font-size: 0.8rem;">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        },
        
        // çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°
        updateStatistics() {
            const totalFiles = this.attachedFiles.length;
            const totalSize = this.getTotalFileSize();
            const imageFiles = this.attachedFiles.filter(f => f.isImage).length;
            const documentFiles = totalFiles - imageFiles;
            const usagePercentage = Math.round((totalSize / this.maxTotalSize) * 100);
            
            document.getElementById('totalFileCount').textContent = totalFiles;
            document.getElementById('totalFileSize').textContent = this.formatFileSize(totalSize);
            document.getElementById('imageFileCount').textContent = imageFiles;
            document.getElementById('documentFileCount').textContent = documentFiles;
            document.getElementById('usagePercentage').textContent = usagePercentage + '%';
            document.getElementById('usageBar').style.width = Math.min(usagePercentage, 100) + '%';
            
            // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®è‰²ã‚’å¤‰æ›´
            const usageBar = document.getElementById('usageBar');
            if (usagePercentage < 50) {
                usageBar.style.background = 'linear-gradient(90deg, #10b981, #3b82f6)';
            } else if (usagePercentage < 80) {
                usageBar.style.background = 'linear-gradient(90deg, #f59e0b, #ef4444)';
            } else {
                usageBar.style.background = 'linear-gradient(90deg, #ef4444, #dc2626)';
            }
        },
        
        // ç”»åƒã‚’ãƒ¡ãƒ¼ãƒ«ã«æŒ¿å…¥
        insertImageIntoEmail(fileId) {
            const fileInfo = this.attachedFiles.find(f => f.id === fileId);
            if (!fileInfo || !fileInfo.isImage) return;
            
            const insertPosition = document.getElementById('imageInsertPosition').value;
            const size = document.getElementById('imageSize').value;
            const alignment = document.getElementById('imageAlignment').value;
            const altText = document.getElementById('imageAltText').value || fileInfo.name;
            const linkUrl = document.getElementById('imageLinkUrl').value;
            const roundedCorners = document.getElementById('imageRoundedCorners').checked;
            const shadow = document.getElementById('imageShadow').checked;
            const border = document.getElementById('imageBorder').checked;
            
            // ç”»åƒã‚µã‚¤ã‚ºã‚’æ±ºå®š
            let width = 400;
            switch (size) {
                case 'small': width = 200; break;
                case 'medium': width = 400; break;
                case 'large': width = 600; break;
                case 'full': width = '100%'; break;
                case 'custom':
                    const customWidth = document.getElementById('customImageWidth').value;
                    width = customWidth ? parseInt(customWidth) : 400;
                    break;
            }
            
            // ç”»åƒHTMLã‚’ç”Ÿæˆ
            let imageHtml = '';
            let styles = '';
            
            if (roundedCorners) styles += 'border-radius: 8px; ';
            if (shadow) styles += 'box-shadow: 0 4px 12px rgba(0,0,0,0.15); ';
            if (border) styles += 'border: 2px solid #e5e7eb; ';
            
            const alignmentStyle = alignment === 'center' ? 'display: block; margin: 0 auto;' : 
                                 alignment === 'right' ? 'float: right; margin-left: 15px;' : 
                                 'float: left; margin-right: 15px;';
            
            imageHtml = `<img src="${fileInfo.previewUrl}" alt="${altText}" style="width: ${width}px; ${styles} ${alignmentStyle}">`;
            
            if (linkUrl) {
                imageHtml = `<a href="${linkUrl}" target="_blank">${imageHtml}</a>`;
            }
            
            // ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ã«æŒ¿å…¥
            const mainContent = document.getElementById('mainContent');
            if (mainContent) {
                const currentContent = mainContent.value;
                const insertText = `\n\n${imageHtml}\n\n`;
                mainContent.value = currentContent + insertText;
                
                fileInfo.insertedInEmail = true;
                this.updateInsertedImagesPreview();
                
                alert(`ç”»åƒ "${fileInfo.name}" ã‚’ãƒ¡ãƒ¼ãƒ«ã«æŒ¿å…¥ã—ã¾ã—ãŸ`);
            }
        },
        
        // æŒ¿å…¥æ¸ˆã¿ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
        updateInsertedImagesPreview() {
            const insertedImages = this.attachedFiles.filter(f => f.insertedInEmail && f.isImage);
            const previewSection = document.getElementById('insertedImagesPreview');
            const container = document.getElementById('imagePreviewContainer');
            
            if (insertedImages.length === 0) {
                previewSection.style.display = 'none';
                return;
            }
            
            previewSection.style.display = 'block';
            
            let html = '';
            insertedImages.forEach(fileInfo => {
                html += `
                    <div style="text-align: center; padding: 15px; background: #f8fafc; border-radius: 8px; border: 2px solid #0ea5e9;">
                        <img src="${fileInfo.previewUrl}" style="max-width: 100%; max-height: 150px; object-fit: cover; border-radius: 6px; margin-bottom: 10px;">
                        <div style="font-weight: 600; color: #374151; margin-bottom: 5px;">${fileInfo.name}</div>
                        <div style="font-size: 0.8rem; color: #6b7280;">${this.formatFileSize(fileInfo.size)}</div>
                        <button onclick="fileAttachmentManager.removeFromEmail('${fileInfo.id}')" class="btn btn-secondary" style="margin-top: 10px; padding: 4px 8px; font-size: 0.75rem;">âŒ å‰Šé™¤</button>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        },
        
        // ãƒ¡ãƒ¼ãƒ«ã‹ã‚‰ç”»åƒã‚’å‰Šé™¤
        removeFromEmail(fileId) {
            const fileInfo = this.attachedFiles.find(f => f.id === fileId);
            if (fileInfo) {
                fileInfo.insertedInEmail = false;
                this.updateInsertedImagesPreview();
                
                // ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ã‹ã‚‰ã‚‚ç”»åƒã‚’å‰Šé™¤ã™ã‚‹å‡¦ç†
                // å®Ÿéš›ã®å®Ÿè£…ã§ã¯æ­£è¦è¡¨ç¾ã§ç”»åƒã‚¿ã‚°ã‚’è¦‹ã¤ã‘ã¦å‰Šé™¤ã™ã‚‹
                const mainContent = document.getElementById('mainContent');
                if (mainContent) {
                    // ç°¡æ˜“çš„ãªå‰Šé™¤ï¼ˆå®Ÿéš›ã¯ã‚ˆã‚Šç²¾å¯†ãªå‡¦ç†ãŒå¿…è¦ï¼‰
                    let content = mainContent.value;
                    const regex = new RegExp(`<img[^>]+src="${fileInfo.previewUrl.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}"[^>]*>`, 'gi');
                    content = content.replace(regex, '');
                    mainContent.value = content;
                }
                
                alert(`ç”»åƒ "${fileInfo.name}" ã‚’ãƒ¡ãƒ¼ãƒ«ã‹ã‚‰å‰Šé™¤ã—ã¾ã—ãŸ`);
            }
        },
        
        // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
        previewFile(fileId) {
            const fileInfo = this.attachedFiles.find(f => f.id === fileId);
            if (!fileInfo) return;
            
            if (fileInfo.isImage) {
                // ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ–°ã—ã„ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§è¡¨ç¤º
                const previewWindow = window.open('', '_blank', 'width=800,height=600,scrollbars=yes');
                previewWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                        <head>
                            <title>ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ - ${fileInfo.name}</title>
                            <style>
                                body { margin: 0; padding: 20px; background: #f9fafb; display: flex; flex-direction: column; align-items: center; }
                                img { max-width: 100%; max-height: 80vh; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
                                .info { background: white; padding: 15px; border-radius: 8px; margin-top: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
                            </style>
                        </head>
                        <body>
                            <img src="${fileInfo.previewUrl}" alt="${fileInfo.name}">
                            <div class="info">
                                <h3>${fileInfo.name}</h3>
                                <p>ã‚µã‚¤ã‚º: ${this.formatFileSize(fileInfo.size)}</p>
                                <p>å½¢å¼: ${fileInfo.type}</p>
                            </div>
                        </body>
                    </html>
                `);
                previewWindow.document.close();
            } else {
                // éç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®æƒ…å ±è¡¨ç¤º
                alert(`ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±:\n\nåå‰: ${fileInfo.name}\nã‚µã‚¤ã‚º: ${this.formatFileSize(fileInfo.size)}\nå½¢å¼: ${fileInfo.type}\n\nã“ã®ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã¯ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ãã¾ã›ã‚“ã€‚`);
            }
        },
        
        // ç”»åƒæœ€é©åŒ–ï¼ˆç°¡æ˜“ç‰ˆï¼‰
        optimizeImages() {
            const imageFiles = this.attachedFiles.filter(f => f.isImage);
            if (imageFiles.length === 0) {
                alert('æœ€é©åŒ–ã™ã‚‹ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            if (confirm(`${imageFiles.length}å€‹ã®ç”»åƒã‚’æœ€é©åŒ–ã—ã¾ã™ã‹ï¼Ÿ\n\næœ€é©åŒ–ã«ã‚ˆã‚Šã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå‰Šæ¸›ã•ã‚Œã€ãƒ¡ãƒ¼ãƒ«é€ä¿¡æ™‚é–“ãŒçŸ­ç¸®ã•ã‚Œã¾ã™ã€‚`)) {
                // å®Ÿéš›ã®å®Ÿè£…ã§ã¯ Canvas API ã‚’ä½¿ç”¨ã—ã¦ç”»åƒã‚’åœ§ç¸®
                alert('ç”»åƒæœ€é©åŒ–æ©Ÿèƒ½ã¯é–‹ç™ºä¸­ã§ã™ã€‚\n\nç¾åœ¨ã¯æ‰‹å‹•ã§ç”»åƒã‚µã‚¤ã‚ºã‚’èª¿æ•´ã—ã¦ãã ã•ã„ã€‚');
            }
        },
        
        // ãƒ•ã‚¡ã‚¤ãƒ«åœ§ç¸®
        compressFiles() {
            if (this.attachedFiles.length === 0) {
                alert('åœ§ç¸®ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            alert('ãƒ•ã‚¡ã‚¤ãƒ«åœ§ç¸®æ©Ÿèƒ½ã¯é–‹ç™ºä¸­ã§ã™ã€‚\n\nZIPãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦æ·»ä»˜ã™ã‚‹ã“ã¨ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚');
        },
        
        // æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«å…¨ä½“ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
        previewAttachments() {
            if (this.attachedFiles.length === 0) {
                alert('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã™ã‚‹æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            const previewWindow = window.open('', '_blank', 'width=1000,height=700,scrollbars=yes');
            let html = `
                <!DOCTYPE html>
                <html>
                    <head>
                        <title>æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; background: #f9fafb; }
                            .file-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
                            .file-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
                            .file-card img { max-width: 100%; height: 150px; object-fit: cover; border-radius: 6px; }
                            .file-icon { width: 100%; height: 150px; background: #e5e7eb; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 3rem; }
                        </style>
                    </head>
                    <body>
                        <h1>ğŸ“ æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ (${this.attachedFiles.length}ä»¶)</h1>
                        <div class="file-grid">
            `;
            
            this.attachedFiles.forEach(fileInfo => {
                html += `
                    <div class="file-card">
                        ${fileInfo.isImage ? 
                            `<img src="${fileInfo.previewUrl}" alt="${fileInfo.name}">` :
                            `<div class="file-icon">${this.getFileIcon(fileInfo.type)}</div>`
                        }
                        <h3>${fileInfo.name}</h3>
                        <p>ã‚µã‚¤ã‚º: ${this.formatFileSize(fileInfo.size)}</p>
                        <p>å½¢å¼: ${this.getFileTypeLabel(fileInfo.type)}</p>
                    </div>
                `;
            });
            
            html += `
                        </div>
                    </body>
                </html>
            `;
            
            previewWindow.document.write(html);
            previewWindow.document.close();
        },
        
        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒ¡ã‚½ãƒƒãƒ‰
        getTotalFileSize() {
            return this.attachedFiles.reduce((total, file) => total + file.size, 0);
        },
        
        formatFileSize(bytes) {
            if (bytes === 0) return '0KB';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + sizes[i];
        },
        
        getFileIcon(type) {
            if (type.startsWith('image/')) return 'ğŸ–¼ï¸';
            if (type === 'application/pdf') return 'ğŸ“„';
            if (type === 'application/zip') return 'ğŸ—œï¸';
            if (type.includes('word')) return 'ğŸ“';
            if (type.includes('excel') || type.includes('spreadsheet')) return 'ğŸ“Š';
            return 'ğŸ“';
        },
        
        getFileTypeLabel(type) {
            const labels = {
                'image/jpeg': 'JPEGç”»åƒ',
                'image/png': 'PNGç”»åƒ', 
                'image/gif': 'GIFç”»åƒ',
                'application/pdf': 'PDFãƒ•ã‚¡ã‚¤ãƒ«',
                'application/zip': 'ZIPãƒ•ã‚¡ã‚¤ãƒ«',
                'application/msword': 'Wordæ–‡æ›¸',
                'application/vnd.openxmlformats-officedocument.wordprocessingml.document': 'Wordæ–‡æ›¸',
                'application/vnd.ms-excel': 'Excelæ–‡æ›¸',
                'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': 'Excelæ–‡æ›¸'
            };
            return labels[type] || 'ãã®ä»–';
        }
    };

    // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    
    // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
    dropZone?.addEventListener('click', () => {
        fileInput?.click();
    });
    
    dropZone?.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.style.borderColor = '#059669';
        dropZone.style.background = '#f0fdf4';
        dropZone.querySelector('div').style.color = '#059669';
    });
    
    dropZone?.addEventListener('dragleave', (e) => {
        e.preventDefault();
        dropZone.style.borderColor = '#d1d5db';
        dropZone.style.background = '#f9fafb';
        dropZone.querySelector('div').style.color = '#9ca3af';
    });
    
    dropZone?.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.style.borderColor = '#d1d5db';
        dropZone.style.background = '#f9fafb';
        dropZone.querySelector('div').style.color = '#9ca3af';
        
        const files = Array.from(e.dataTransfer.files);
        files.forEach(file => {
            fileAttachmentManager.addFile(file);
        });
    });
    
    // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã®ã‚¤ãƒ™ãƒ³ãƒˆ
    fileInput?.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        files.forEach(file => {
            fileAttachmentManager.addFile(file);
        });
        
        // å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢
        e.target.value = '';
    });
    
    // ç”»åƒã‚µã‚¤ã‚ºé¸æŠã®å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ
    document.getElementById('imageSize')?.addEventListener('change', function() {
        const customSettings = document.getElementById('customSizeSettings');
        if (this.value === 'custom') {
            customSettings.style.display = 'block';
        } else {
            customSettings.style.display = 'none';
        }
    });
    
    // ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
    document.getElementById('clearAllFilesBtn')?.addEventListener('click', () => {
        if (confirm('å…¨ã¦ã®æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
            fileAttachmentManager.clearAllFiles();
        }
    });
    
    document.getElementById('compressFilesBtn')?.addEventListener('click', () => {
        fileAttachmentManager.compressFiles();
    });
    
    document.getElementById('optimizeImagesBtn')?.addEventListener('click', () => {
        fileAttachmentManager.optimizeImages();
    });
    
    document.getElementById('previewAttachmentsBtn')?.addEventListener('click', () => {
        fileAttachmentManager.previewAttachments();
    });

    // äºˆæƒ³å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å¤‰æ›´ã‚‚ç›£è¦–
    document.getElementById('predictionsContainer')?.addEventListener('input', clearPreview);
    
    // CTAãƒœã‚¿ãƒ³ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å¤‰æ›´ã‚‚ç›£è¦–
    document.getElementById('showCtaButton')?.addEventListener('change', clearPreview);

    // æ–°ã—ã„ã‚·ãƒ³ãƒ—ãƒ«ãªå±¥æ­´èª­ã¿è¾¼ã¿é–¢æ•°
    function loadHistory() {
        const newHistoryArea = document.getElementById('newHistoryArea');
        if (!newHistoryArea) {
            console.error('newHistoryAreaãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            return;
        }
        
        try {
            // LocalStorageã‹ã‚‰å±¥æ­´ã‚’èª­ã¿è¾¼ã¿
            const existingHistory = localStorage.getItem('newsletter-history');
            const history = existingHistory ? JSON.parse(existingHistory) : [];
            
            console.log('LocalStorageã‹ã‚‰èª­ã¿è¾¼ã‚“ã å±¥æ­´:', history.length + 'ä»¶');
            
            if (history.length > 0) {
                let historyHTML = '';
                // æœ€æ–°10ä»¶ã®ã¿è¡¨ç¤º
                history.slice(0, 10).forEach(item => {
                    // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                    const date = item.scheduledAt ? 
                        new Date(item.scheduledAt).toLocaleString('ja-JP') : 
                        new Date(item.createdAt).toLocaleString('ja-JP');
                    
                    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºï¼ˆ72æ™‚é–“åˆ¶é™ãƒã‚§ãƒƒã‚¯ä»˜ãï¼‰
                    let statusText = 'é…ä¿¡æ¸ˆã¿';
                    let statusIcon = 'âœ…';
                    let statusColor = '#16a34a';
                    
                    if (item.status === 'scheduled') {
                        const scheduledDate = new Date(item.scheduledAt);
                        const createdDate = new Date(item.timestamp);
                        const hoursDiff = (scheduledDate - createdDate) / (1000 * 60 * 60);
                        
                        if (hoursDiff > 72) {
                            statusText = 'äºˆç´„æ¸ˆã¿ï¼ˆé…ä¿¡ä¿è¨¼ãªã—ï¼‰';
                            statusIcon = 'âš ï¸';
                            statusColor = '#dc2626';
                        } else {
                            statusText = 'äºˆç´„æ¸ˆã¿';
                            statusIcon = 'ğŸ“…';
                            statusColor = '#3b82f6';
                        }
                    }
                    
                    // ãƒ—ãƒ©ãƒ³è¡¨ç¤ºã‚’æ—¥æœ¬èªåŒ–
                    const planText = {
                        'all': 'å…¨ä¼šå“¡',
                        'free': 'ç„¡æ–™ä¼šå“¡',
                        'paid': 'æœ‰æ–™ä¼šå“¡',
                        'standard': 'Standardä¼šå“¡',
                        'premium': 'Premiumä¼šå“¡'
                    }[item.targetPlan] || item.targetPlan;
                    
                    historyHTML += `
                        <div class="new-history-item">
                            <div class="new-history-title">
                                ${item.subject}
                                <span class="new-status-sent">${statusText} ${statusIcon}</span>
                            </div>
                            <div class="new-history-info">
                                å¯¾è±¡: ${planText} | é…ä¿¡æ•°: ${item.recipientCount || 0}ä»¶ | é…ä¿¡æ—¥æ™‚: ${date}
                            </div>
                        </div>
                    `;
                });
                newHistoryArea.innerHTML = historyHTML;
            } else {
                newHistoryArea.innerHTML = `
                    <div class="new-no-history">
                        ğŸ“„ ã¾ã é…ä¿¡å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“<br>
                        <small>ãƒ¡ãƒ«ãƒã‚¬ã‚’é…ä¿¡ã™ã‚‹ã¨ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</small>
                    </div>
                `;
            }
            
            console.log('âœ… å±¥æ­´èª­ã¿è¾¼ã¿å®Œäº†');
        } catch (error) {
            console.error('å±¥æ­´èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            newHistoryArea.innerHTML = `
                <div class="new-no-history">
                    âš ï¸ å±¥æ­´ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ<br>
                    <small>${error.message}</small>
                </div>
            `;
        }
    }

    // å±¥æ­´ã‚’ä¿å­˜ã™ã‚‹é–¢æ•°
    function saveHistoryToLocal(historyItem) {
        try {
            const existingHistory = localStorage.getItem('newsletter-history');
            const history = existingHistory ? JSON.parse(existingHistory) : [];
            
            // æ–°ã—ã„å±¥æ­´ã‚’å…ˆé ­ã«è¿½åŠ 
            history.unshift({
                ...historyItem,
                id: Date.now().toString(), // ç°¡æ˜“ID
                createdAt: new Date().toISOString()
            });
            
            // æœ€å¤§50ä»¶ã¾ã§ä¿æŒ
            const limitedHistory = history.slice(0, 50);
            
            localStorage.setItem('newsletter-history', JSON.stringify(limitedHistory));
            console.log('å±¥æ­´ã‚’LocalStorageã«ä¿å­˜:', historyItem);
        } catch (error) {
            console.error('å±¥æ­´ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        }
    }

    // å®Ÿéš›ã®é…ä¿¡çŠ¶æ³ç¢ºèªï¼ˆBrevo APIã‹ã‚‰ç›´æ¥å–å¾—ï¼‰
    async function checkRealDeliveryStatus() {
        const button = document.getElementById('checkRealDeliveryBtn');
        const historyArea = document.getElementById('newHistoryArea');
        
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹
        button.textContent = 'ğŸ” ç¢ºèªä¸­...';
        button.disabled = true;
        
        historyArea.innerHTML = `
            <div style="text-align: center; padding: 20px; color: #3b82f6;">
                <div style="font-size: 2rem; margin-bottom: 10px;">ğŸ”</div>
                <div>Brevo APIã‹ã‚‰é…ä¿¡çŠ¶æ³ã‚’ç¢ºèªã—ã¦ã„ã¾ã™...</div>
                <div style="font-size: 0.9rem; color: #6b7280; margin-top: 5px;">å®Ÿéš›ã®é€ä¿¡å±¥æ­´ã¨ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«çŠ¶æ³ã‚’å–å¾—ä¸­</div>
            </div>
        `;

        try {
            // æœ¬ç•ªç’°å¢ƒã®check-delivery-status Functionå‘¼ã³å‡ºã—
            const response = await fetch('/.netlify/functions/check-delivery-status', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();

            if (data.success) {
                displayRealDeliveryStatus(data.data);
            } else {
                throw new Error(data.error || 'é…ä¿¡çŠ¶æ³ã®å–å¾—ã«å¤±æ•—');
            }

        } catch (error) {
            console.error('é…ä¿¡çŠ¶æ³ç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
            
            historyArea.innerHTML = `
                <div style="text-align: center; padding: 20px; color: #dc2626;">
                    <div style="font-size: 2rem; margin-bottom: 10px;">âŒ</div>
                    <div style="font-weight: 600;">é…ä¿¡çŠ¶æ³ç¢ºèªã‚¨ãƒ©ãƒ¼</div>
                    <div style="font-size: 0.9rem; margin-top: 10px;">${error.message}</div>
                    <div style="font-size: 0.8rem; color: #6b7280; margin-top: 10px;">
                        æœ¬ç•ªç’°å¢ƒã§Netlify Functionsã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„
                    </div>
                </div>
            `;
        } finally {
            // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
            button.textContent = 'ğŸ” å®Ÿéš›ã®é…ä¿¡çŠ¶æ³ç¢ºèª';
            button.disabled = false;
        }
    }

    // å®Ÿéš›ã®é…ä¿¡çŠ¶æ³è¡¨ç¤º
    function displayRealDeliveryStatus(data) {
        const historyArea = document.getElementById('newHistoryArea');
        const { account, recentEmails, scheduledEmails, summary, stats, debug } = data;

        let html = `
            <div style="background: #f0fdf4; border: 2px solid #16a34a; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                <h3 style="margin: 0 0 15px 0; color: #15803d;">âœ… Brevoé…ä¿¡çŠ¶æ³ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ï¼‰</h3>
                
                <!-- ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ± -->
                <div style="background: white; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                    <h4 style="margin: 0 0 10px 0; color: #374151;">ğŸ“Š ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæ¦‚è¦</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div>
                            <div style="font-size: 0.8rem; color: #6b7280;">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</div>
                            <div style="font-weight: 600;">${account.email || 'N/A'}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.8rem; color: #6b7280;">ãƒ—ãƒ©ãƒ³</div>
                            <div style="font-weight: 600;">${account.plan || 'N/A'}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.8rem; color: #6b7280;">ä¼šç¤¾å</div>
                            <div style="font-weight: 600;">${account.companyName || 'N/A'}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.8rem; color: #6b7280;">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
                            <div style="font-weight: 600; color: ${summary.accountStatus === 'active' ? '#16a34a' : '#dc2626'};">
                                ${summary.accountStatus === 'active' ? 'âœ… ã‚¢ã‚¯ãƒ†ã‚£ãƒ–' : 'âŒ ä¸æ˜'}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- çµ±è¨ˆã‚µãƒãƒªãƒ¼ -->
                <div style="background: white; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                    <h4 style="margin: 0 0 10px 0; color: #374151;">ğŸ“ˆ é…ä¿¡çµ±è¨ˆï¼ˆ24æ™‚é–“ï¼‰</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; text-align: center;">
                        <div style="background: #f0f9ff; border-radius: 6px; padding: 10px;">
                            <div style="font-size: 1.5rem; color: #3b82f6;">${summary.totalSent24h}</div>
                            <div style="font-size: 0.8rem; color: #6b7280;">é€ä¿¡æ¸ˆã¿</div>
                        </div>
                        <div style="background: #fef3c7; border-radius: 6px; padding: 10px;">
                            <div style="font-size: 1.5rem; color: #d97706;">${summary.pendingScheduled}</div>
                            <div style="font-size: 0.8rem; color: #6b7280;">äºˆç´„å¾…ã¡</div>
                        </div>
                    </div>
                </div>
        `;

        // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«é…ä¿¡ä¸€è¦§
        if (scheduledEmails && scheduledEmails.length > 0) {
            html += `
                <div style="background: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                    <h4 style="margin: 0 0 10px 0; color: #d97706;">â° ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«é…ä¿¡ä¸€è¦§</h4>
                    ${scheduledEmails.map(email => `
                        <div style="background: white; border-radius: 6px; padding: 10px; margin-bottom: 8px;">
                            <div style="font-weight: 600; color: #374151;">${email.subject || 'N/A'}</div>
                            <div style="font-size: 0.9rem; color: #6b7280;">
                                äºˆå®š: ${email.scheduledAt ? new Date(email.scheduledAt).toLocaleString('ja-JP') : 'N/A'}
                            </div>
                            <div style="font-size: 0.8rem; color: #6b7280;">
                                å®›å…ˆ: ${email.to ? email.to.length : 0}ä»¶ | 
                                ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${email.status || 'unknown'}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        } else {
            html += `
                <div style="background: #f0fdf4; border-radius: 8px; padding: 15px; margin-bottom: 15px; text-align: center;">
                    <div style="color: #16a34a;">âœ… ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«é…ä¿¡ãªã—</div>
                    <div style="font-size: 0.9rem; color: #6b7280;">ç¾åœ¨äºˆç´„å¾…ã¡ã®ãƒ¡ãƒ¼ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“</div>
                </div>
            `;
        }

        // æœ€è¿‘ã®é…ä¿¡å±¥æ­´
        if (recentEmails && recentEmails.length > 0) {
            html += `
                <div style="background: white; border-radius: 8px; padding: 15px;">
                    <h4 style="margin: 0 0 10px 0; color: #374151;">ğŸ“§ æœ€è¿‘ã®é…ä¿¡å±¥æ­´ï¼ˆ24æ™‚é–“ä»¥å†…ï¼‰</h4>
                    <div style="max-height: 300px; overflow-y: auto;">
                        ${recentEmails.slice(0, 10).map(email => `
                            <div style="border-bottom: 1px solid #e5e7eb; padding: 8px 0;">
                                <div style="font-weight: 600; color: #374151;">${email.subject || 'N/A'}</div>
                                <div style="font-size: 0.9rem; color: #6b7280;">
                                    é€ä¿¡æ—¥æ™‚: ${email.date ? new Date(email.date).toLocaleString('ja-JP') : 'N/A'}
                                </div>
                                <div style="font-size: 0.8rem; color: #6b7280;">
                                    å®›å…ˆ: ${email.to ? email.to.length : 0}ä»¶ | 
                                    ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ID: ${email.messageId || 'N/A'}
                                </div>
                                <div style="font-size: 0.8rem;">
                                    <span style="color: ${email.status === 'sent' ? '#16a34a' : '#dc2626'};">
                                        ${email.status === 'sent' ? 'âœ… é€ä¿¡æˆåŠŸ' : 'âŒ é€ä¿¡å¤±æ•—'}
                                    </span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        } else {
            html += `
                <div style="background: #fef2f2; border-radius: 8px; padding: 15px; text-align: center;">
                    <div style="color: #dc2626;">âš ï¸ é…ä¿¡å±¥æ­´ãªã—</div>
                    <div style="font-size: 0.9rem; color: #6b7280;">24æ™‚é–“ä»¥å†…ã«é€ä¿¡ã•ã‚ŒãŸãƒ¡ãƒ¼ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“</div>
                </div>
            `;
        }

        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã®è¡¨ç¤º
        if (debug) {
            html += `
                <div style="background: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px; padding: 15px; margin-top: 15px;">
                    <h4 style="margin: 0 0 10px 0; color: #d97706;">ğŸ” ãƒ‡ãƒãƒƒã‚°æƒ…å ±</h4>
                    <div style="font-size: 0.9rem; color: #92400e;">
                        <div>Queued Emails: ${debug.queuedEmailsCount}ä»¶</div>
                        <div>Scheduled Campaigns: ${debug.scheduledCampaignsCount}ä»¶</div>
                        <div>Pending Emails: ${debug.pendingEmailsCount}ä»¶</div>
                        <div style="margin-top: 10px; padding: 10px; background: rgba(245, 158, 11, 0.1); border-radius: 4px;">
                            âš ï¸ ${debug.message}
                        </div>
                        <div style="margin-top: 10px; font-weight: 600;">
                            ğŸ’¡ é‡è¦: Brevo SMTPã®äºˆç´„é…ä¿¡ã¯ã€å®Ÿéš›ã«é…ä¿¡æ™‚åˆ»ã«ãªã‚‹ã¾ã§APIã§ç¢ºèªã§ããªã„ä»•æ§˜ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™
                        </div>
                    </div>
                </div>
            `;
        }

        html += `</div>`;

        historyArea.innerHTML = html;

        // çµæœã‚’ãƒ­ã‚°ã«è¨˜éŒ²
        console.log('å®Ÿéš›ã®é…ä¿¡çŠ¶æ³:', {
            totalSent: summary.totalSent24h,
            scheduled: summary.pendingScheduled,
            accountStatus: summary.accountStatus,
            debug: debug
        });
    }

    // å±¥æ­´æ›´æ–°ãƒœã‚¿ãƒ³
    document.getElementById('refreshHistoryBtn')?.addEventListener('click', loadHistory);
    document.getElementById('checkRealDeliveryBtn')?.addEventListener('click', checkRealDeliveryStatus);
    
    // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆæ©Ÿèƒ½
    document.getElementById('targetPlan')?.addEventListener('change', toggleSegmentSection);
    document.getElementById('previewSegmentBtn')?.addEventListener('click', previewSegment);
    
    // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡
    function toggleSegmentSection() {
        const targetPlan = document.getElementById('targetPlan')?.value;
        const segmentSection = document.getElementById('segmentSection');
        
        if (targetPlan === 'segment') {
            segmentSection.style.display = 'block';
        } else {
            segmentSection.style.display = 'none';
            // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚«ã‚¦ãƒ³ãƒˆã‚’ã‚¯ãƒªã‚¢
            document.getElementById('segmentCount').innerHTML = '';
        }
    }
    
    // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆå¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèª
    function previewSegment() {
        try {
            const segmentConditions = getSegmentConditions();
            console.log('ã‚»ã‚°ãƒ¡ãƒ³ãƒˆæ¡ä»¶:', segmentConditions);
            
            // ãƒ‡ãƒ¢ç”¨ã®ç°¡æ˜“è¨ˆç®—ï¼ˆå®Ÿéš›ã¯Airtable APIã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼‰
            const demoUserCount = calculateDemoSegmentSize(segmentConditions);
            
            document.getElementById('segmentCount').innerHTML = `
                <span style="background: #dbeafe; padding: 8px 15px; border-radius: 6px; color: #0c4a6e;">
                    ğŸ‘¥ å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼: ç´„${demoUserCount}å
                    ${demoUserCount === 0 ? 'âš ï¸ æ¡ä»¶ã«è©²å½“ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ã¾ã›ã‚“' : 'âœ… é…ä¿¡å¯èƒ½'}
                </span>
            `;
            
            if (demoUserCount > 0) {
                // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆæ¡ä»¶ã®è©³ç´°ã‚’è¡¨ç¤º
                const conditionText = formatSegmentConditions(segmentConditions);
                if (conditionText) {
                    document.getElementById('segmentCount').innerHTML += `
                        <div style="margin-top: 10px; padding: 10px; background: rgba(59, 130, 246, 0.1); border-radius: 6px; font-size: 0.9em;">
                            <strong>é©ç”¨æ¡ä»¶:</strong><br>${conditionText}
                        </div>
                    `;
                }
            }
            
        } catch (error) {
            console.error('ã‚»ã‚°ãƒ¡ãƒ³ãƒˆç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
            document.getElementById('segmentCount').innerHTML = `
                <span style="color: #dc2626;">âš ï¸ ã‚»ã‚°ãƒ¡ãƒ³ãƒˆç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸ</span>
            `;
        }
    }
    
    // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆæ¡ä»¶ã‚’å–å¾—
    function getSegmentConditions() {
        return {
            dateFrom: document.getElementById('segmentDateFrom')?.value || null,
            dateTo: document.getElementById('segmentDateTo')?.value || null,
            activity: document.getElementById('segmentActivity')?.value || null,
            emailHistory: document.getElementById('segmentEmailHistory')?.value || null,
            tags: document.getElementById('segmentTags')?.value || null,
            excludeBounced: document.getElementById('excludeBounced')?.checked || false,
            excludeUnsubscribed: document.getElementById('excludeUnsubscribed')?.checked || false,
            excludeInactive: document.getElementById('excludeInactive')?.checked || false
        };
    }
    
    // ãƒ‡ãƒ¢ç”¨ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚µã‚¤ã‚ºè¨ˆç®—
    function calculateDemoSegmentSize(conditions) {
        let baseCount = 100; // åŸºæœ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°ï¼ˆãƒ‡ãƒ¢ç”¨ï¼‰
        
        // ç™»éŒ²æ—¥ã«ã‚ˆã‚‹çµã‚Šè¾¼ã¿
        if (conditions.dateFrom || conditions.dateTo) {
            baseCount = Math.floor(baseCount * 0.7); // 30%æ¸›
        }
        
        // ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã«ã‚ˆã‚‹çµã‚Šè¾¼ã¿
        switch (conditions.activity) {
            case 'active':
                baseCount = Math.floor(baseCount * 0.6); // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã¯60%
                break;
            case 'inactive':
                baseCount = Math.floor(baseCount * 0.3); // éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã¯30%
                break;
            case 'new':
                baseCount = Math.floor(baseCount * 0.1); // æ–°è¦ã¯10%
                break;
        }
        
        // ãƒ¡ãƒ¼ãƒ«é…ä¿¡æ­´ã«ã‚ˆã‚‹çµã‚Šè¾¼ã¿
        switch (conditions.emailHistory) {
            case 'no-email':
                baseCount = Math.floor(baseCount * 0.4);
                break;
            case 'recent-email':
                baseCount = Math.floor(baseCount * 0.2);
                break;
            case 'old-email':
                baseCount = Math.floor(baseCount * 0.5);
                break;
        }
        
        // ã‚¿ã‚°ã«ã‚ˆã‚‹çµã‚Šè¾¼ã¿
        if (conditions.tags) {
            baseCount = Math.floor(baseCount * 0.3); // ã‚¿ã‚°ã‚ã‚Šã¯30%ç¨‹åº¦
        }
        
        // é™¤å¤–æ¡ä»¶
        if (conditions.excludeBounced) baseCount = Math.floor(baseCount * 0.95);
        if (conditions.excludeUnsubscribed) baseCount = Math.floor(baseCount * 0.98);
        if (conditions.excludeInactive) baseCount = Math.floor(baseCount * 0.85);
        
        return Math.max(0, baseCount);
    }
    
    // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆæ¡ä»¶ã‚’ãƒ†ã‚­ã‚¹ãƒˆã§è¡¨ç¤º
    function formatSegmentConditions(conditions) {
        const parts = [];
        
        if (conditions.dateFrom || conditions.dateTo) {
            const from = conditions.dateFrom || 'åˆ¶é™ãªã—';
            const to = conditions.dateTo || 'åˆ¶é™ãªã—';
            parts.push(`ğŸ“… ç™»éŒ²æ—¥: ${from} ï½ ${to}`);
        }
        
        if (conditions.activity) {
            const activityText = {
                'active': 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆ7æ—¥ä»¥å†…ãƒ­ã‚°ã‚¤ãƒ³ï¼‰',
                'inactive': 'éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆ7æ—¥ä»¥ä¸Šæœªãƒ­ã‚°ã‚¤ãƒ³ï¼‰',
                'new': 'æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆ3æ—¥ä»¥å†…ç™»éŒ²ï¼‰'
            }[conditions.activity];
            parts.push(`âš¡ ${activityText}`);
        }
        
        if (conditions.emailHistory) {
            const emailText = {
                'no-email': 'æœªé…ä¿¡ãƒ¦ãƒ¼ã‚¶ãƒ¼',
                'recent-email': 'æœ€è¿‘é…ä¿¡æ¸ˆã¿ï¼ˆ3æ—¥ä»¥å†…ï¼‰',
                'old-email': 'é…ä¿¡ã‹ã‚‰æ™‚é–“ãŒçµŒéï¼ˆ7æ—¥ä»¥ä¸Šï¼‰'
            }[conditions.emailHistory];
            parts.push(`ğŸ“§ ${emailText}`);
        }
        
        if (conditions.tags) {
            parts.push(`ğŸ·ï¸ ã‚¿ã‚°: ${conditions.tags}`);
        }
        
        const excludes = [];
        if (conditions.excludeBounced) excludes.push('é…ä¿¡å¤±æ•—å±¥æ­´ã‚ã‚Š');
        if (conditions.excludeUnsubscribed) excludes.push('é…ä¿¡åœæ­¢æ¸ˆã¿');
        if (conditions.excludeInactive) excludes.push('30æ—¥ä»¥ä¸Šæœªãƒ­ã‚°ã‚¤ãƒ³');
        
        if (excludes.length > 0) {
            parts.push(`âŒ é™¤å¤–: ${excludes.join(', ')}`);
        }
        
        return parts.join('<br>');
    }
    
    // å±¥æ­´ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³
    document.getElementById('clearHistoryBtn')?.addEventListener('click', () => {
        if (confirm('é…ä¿¡å±¥æ­´ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) {
            try {
                localStorage.removeItem('newsletter-history');
                console.log('âœ… å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
                loadHistory(); // å±¥æ­´è¡¨ç¤ºã‚’æ›´æ–°
                alert('å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
            } catch (error) {
                console.error('å±¥æ­´ã‚¯ãƒªã‚¢ã‚¨ãƒ©ãƒ¼:', error);
                alert('å±¥æ­´ã®ã‚¯ãƒªã‚¢ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }
    });
    
    // å¤±æ•—ãƒ¡ãƒ¼ãƒ«ç¢ºèªãƒœã‚¿ãƒ³
    document.getElementById('showFailedEmailsBtn')?.addEventListener('click', () => {
        loadFailedEmails();
        document.getElementById('failedEmailsSection').style.display = 'block';
    });
    
    // å¤±æ•—ãƒ¡ãƒ¼ãƒ«ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’é–‰ã˜ã‚‹
    document.getElementById('hideFailedBtn')?.addEventListener('click', () => {
        document.getElementById('failedEmailsSection').style.display = 'none';
    });
    
    // å¤±æ•—ãƒ¡ãƒ¼ãƒ«å†é€ä¿¡
    document.getElementById('retryFailedBtn')?.addEventListener('click', async () => {
        const failedEmails = getFailedEmails();
        if (failedEmails.length === 0) {
            alert('å†é€ä¿¡ã™ã‚‹ãƒ¡ãƒ¼ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“');
            return;
        }
        
        if (!confirm(`${failedEmails.length}ä»¶ã®ãƒ¡ãƒ¼ãƒ«ã‚’å†é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ`)) {
            return;
        }
        
        try {
            // æœ€å¾Œã«é€ä¿¡ã—ãŸè¨­å®šã‚’å†åˆ©ç”¨
            const lastHistory = JSON.parse(localStorage.getItem('newsletter-history') || '[]')[0];
            if (!lastHistory) {
                alert('å†é€ä¿¡ã™ã‚‹è¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            const retryResult = await retryFailedEmails(failedEmails, lastHistory);
            alert(`å†é€ä¿¡å®Œäº†ï¼šæˆåŠŸ ${retryResult.success}ä»¶ã€å¤±æ•— ${retryResult.failed}ä»¶`);
            
            // æˆåŠŸã—ãŸãƒ¡ãƒ¼ãƒ«ã‚’å¤±æ•—ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤
            if (retryResult.success > 0) {
                clearSuccessfulRetries(retryResult.successfulEmails);
                loadFailedEmails(); // å¤±æ•—ãƒªã‚¹ãƒˆã‚’æ›´æ–°
            }
            
        } catch (error) {
            console.error('å†é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
            alert('å†é€ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
        }
    });
    
    // å¤±æ•—ãƒªã‚¹ãƒˆã‚¯ãƒªã‚¢
    document.getElementById('clearFailedBtn')?.addEventListener('click', () => {
        if (confirm('å¤±æ•—ãƒ¡ãƒ¼ãƒ«ãƒªã‚¹ãƒˆã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) {
            clearAllFailedEmails();
            loadFailedEmails();
            alert('å¤±æ•—ãƒ¡ãƒ¼ãƒ«ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
        }
    });

    // å¤±æ•—ãƒ¡ãƒ¼ãƒ«èª­ã¿è¾¼ã¿é–¢æ•°
    function loadFailedEmails() {
        const failedEmails = getFailedEmails();
        const failedEmailsList = document.getElementById('failedEmailsList');
        
        if (failedEmails.length === 0) {
            failedEmailsList.innerHTML = '<p style="color: #059669; font-weight: 600;">âœ… é€ä¿¡å¤±æ•—ãƒ¡ãƒ¼ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
            return;
        }
        
        let html = `<p style="color: #991b1b; font-weight: 600;">ğŸ“§ å¤±æ•—ä»¶æ•°: ${failedEmails.length}ä»¶</p>`;
        html += '<div style="max-height: 200px; overflow-y: auto; border: 1px solid #f87171; border-radius: 6px; background: white; padding: 15px;">';
        
        failedEmails.forEach((item, index) => {
            html += `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #fee2e2;">
                    <div>
                        <strong>${item.email}</strong><br>
                        <small>ãƒ—ãƒ©ãƒ³: ${item.plan || 'Unknown'} | ã‚¨ãƒ©ãƒ¼: ${item.error || 'Unknown error'}</small>
                    </div>
                    <button onclick="removeFailedEmail(${index})" class="btn" style="background: #ef4444; color: white; padding: 4px 8px; font-size: 12px;">å‰Šé™¤</button>
                </div>
            `;
        });
        
        html += '</div>';
        failedEmailsList.innerHTML = html;
    }

    // å¤±æ•—ãƒ¡ãƒ¼ãƒ«å–å¾—
    function getFailedEmails() {
        const keys = Object.keys(localStorage).filter(key => key.startsWith('newsletter-failed-'));
        let allFailed = [];
        
        keys.forEach(key => {
            try {
                const failedData = JSON.parse(localStorage.getItem(key));
                if (Array.isArray(failedData)) {
                    allFailed = allFailed.concat(failedData.map(item => ({...item, key})));
                }
            } catch (error) {
                console.error('Failed email data parse error:', error);
            }
        });
        
        return allFailed;
    }

    // å¤±æ•—ãƒ¡ãƒ¼ãƒ«å†é€ä¿¡å‡¦ç†
    async function retryFailedEmails(failedEmails, lastHistory) {
        const retryData = {
            subject: '[å†é€ä¿¡] ' + lastHistory.subject,
            htmlContent: lastHistory.htmlContent || generateBasicRetryHTML(lastHistory.subject),
            targetPlan: 'retry',
            scheduledAt: null,
            retryEmails: failedEmails.map(item => ({email: item.email, plan: item.plan}))
        };
        
        const response = await fetch('/.netlify/functions/send-newsletter', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(retryData)
        });
        
        if (!response.ok) {
            throw new Error(`å†é€ä¿¡å¤±æ•—: ${response.status}`);
        }
        
        const result = await response.json();
        return {
            success: result.recipientCount || 0,
            failed: failedEmails.length - (result.recipientCount || 0),
            successfulEmails: failedEmails.slice(0, result.recipientCount || 0)
        };
    }

    // å€‹åˆ¥å¤±æ•—ãƒ¡ãƒ¼ãƒ«å‰Šé™¤
    function removeFailedEmail(index) {
        const failedEmails = getFailedEmails();
        if (index < 0 || index >= failedEmails.length) return;
        
        const itemToRemove = failedEmails[index];
        const key = itemToRemove.key;
        
        try {
            const currentData = JSON.parse(localStorage.getItem(key) || '[]');
            const updatedData = currentData.filter(item => item.email !== itemToRemove.email);
            
            if (updatedData.length === 0) {
                localStorage.removeItem(key);
            } else {
                localStorage.setItem(key, JSON.stringify(updatedData));
            }
            
            loadFailedEmails(); // ãƒªã‚¹ãƒˆã‚’æ›´æ–°
        } catch (error) {
            console.error('Failed email removal error:', error);
        }
    }

    // æˆåŠŸã—ãŸå†é€ä¿¡ãƒ¡ãƒ¼ãƒ«ã‚’å¤±æ•—ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤
    function clearSuccessfulRetries(successfulEmails) {
        successfulEmails.forEach(email => {
            const allFailed = getFailedEmails();
            allFailed.forEach(item => {
                if (item.email === email.email) {
                    removeFailedEmailByKey(item.key, email.email);
                }
            });
        });
    }

    // ã™ã¹ã¦ã®å¤±æ•—ãƒ¡ãƒ¼ãƒ«ã‚’ã‚¯ãƒªã‚¢
    function clearAllFailedEmails() {
        const keys = Object.keys(localStorage).filter(key => key.startsWith('newsletter-failed-'));
        keys.forEach(key => localStorage.removeItem(key));
    }

    // å¤±æ•—ãƒ¡ãƒ¼ãƒ«ã‚’ã‚­ãƒ¼æŒ‡å®šã§å‰Šé™¤
    function removeFailedEmailByKey(key, email) {
        try {
            const currentData = JSON.parse(localStorage.getItem(key) || '[]');
            const updatedData = currentData.filter(item => item.email !== email);
            
            if (updatedData.length === 0) {
                localStorage.removeItem(key);
            } else {
                localStorage.setItem(key, JSON.stringify(updatedData));
            }
        } catch (error) {
            console.error('Failed email key removal error:', error);
        }
    }

    // åŸºæœ¬çš„ãªå†é€ä¿¡ç”¨HTMLç”Ÿæˆ
    function generateBasicRetryHTML(subject) {
        return `
            <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
                <h1 style="color: #1e293b;">ğŸ‡ NANKANã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹</h1>
                <p>ã“ã®ãƒ¡ãƒ¼ãƒ«ã¯é…ä¿¡ã‚¨ãƒ©ãƒ¼ã®ãŸã‚å†é€ä¿¡ã•ã‚Œã¾ã—ãŸã€‚</p>
                <h2>${subject}</h2>
                <p>è©³ç´°ãªå†…å®¹ã«ã¤ã„ã¦ã¯ã€å…¬å¼ã‚µã‚¤ãƒˆã‚’ã”ç¢ºèªãã ã•ã„ã€‚</p>
                <a href="https://nankan-analytics.keiba.link/" style="background: #3b82f6; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px;">å…¬å¼ã‚µã‚¤ãƒˆ</a>
            </div>
        `;
    }

    // é…ä¿¡ãƒ¬ãƒãƒ¼ãƒˆé–¢é€£
    document.getElementById('showReportBtn')?.addEventListener('click', () => {
        loadDeliveryReport();
        document.getElementById('reportSection').style.display = 'block';
    });
    
    document.getElementById('hideReportBtn')?.addEventListener('click', () => {
        document.getElementById('reportSection').style.display = 'none';
    });
    
    document.getElementById('refreshReportBtn')?.addEventListener('click', () => {
        loadDeliveryReport();
    });

    // é…ä¿¡ãƒ¬ãƒãƒ¼ãƒˆèª­ã¿è¾¼ã¿é–¢æ•°
    function loadDeliveryReport() {
        const reportContent = document.getElementById('reportContent');
        reportContent.innerHTML = '<p>ğŸ“Š ãƒ¬ãƒãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...</p>';
        
        try {
            const history = JSON.parse(localStorage.getItem('newsletter-history') || '[]');
            
            if (history.length === 0) {
                reportContent.innerHTML = '<p style="color: #6b7280;">é…ä¿¡å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            // æœ€æ–°10ä»¶ã®é…ä¿¡ã«ã¤ã„ã¦çµ±è¨ˆã‚’è¨ˆç®—
            const recentHistory = history.slice(0, 10);
            const totalSent = recentHistory.reduce((sum, item) => sum + (item.recipientCount || 0), 0);
            const totalFailed = recentHistory.reduce((sum, item) => sum + (item.failedCount || 0), 0);
            const successRate = totalSent + totalFailed > 0 ? ((totalSent / (totalSent + totalFailed)) * 100).toFixed(1) : '0';
            
            // ãƒ—ãƒ©ãƒ³åˆ¥çµ±è¨ˆ
            const planStats = {};
            recentHistory.forEach(item => {
                const plan = item.targetPlan || 'unknown';
                if (!planStats[plan]) {
                    planStats[plan] = { sent: 0, failed: 0 };
                }
                planStats[plan].sent += item.recipientCount || 0;
                planStats[plan].failed += item.failedCount || 0;
            });
            
            let html = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
                    <div style="background: white; padding: 20px; border-radius: 8px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h4 style="margin: 0 0 10px 0; color: #059669;">ğŸ“¤ ç·é…ä¿¡æ•°</h4>
                        <div style="font-size: 2em; font-weight: bold; color: #059669;">${totalSent}</div>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 8px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h4 style="margin: 0 0 10px 0; color: #dc2626;">âŒ é…ä¿¡å¤±æ•—</h4>
                        <div style="font-size: 2em; font-weight: bold; color: ${totalFailed > 0 ? '#dc2626' : '#6b7280'};">${totalFailed}</div>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 8px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h4 style="margin: 0 0 10px 0; color: #0ea5e9;">ğŸ“ˆ æˆåŠŸç‡</h4>
                        <div style="font-size: 2em; font-weight: bold; color: ${parseFloat(successRate) > 90 ? '#059669' : parseFloat(successRate) > 70 ? '#f59e0b' : '#dc2626'};">${successRate}%</div>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 8px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h4 style="margin: 0 0 10px 0; color: #7c3aed;">ğŸ“§ é…ä¿¡å›æ•°</h4>
                        <div style="font-size: 2em; font-weight: bold; color: #7c3aed;">${recentHistory.length}</div>
                    </div>
                </div>
                
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <h4 style="margin-top: 0; color: #374151;">ğŸ“Š ãƒ—ãƒ©ãƒ³åˆ¥é…ä¿¡çµ±è¨ˆ</h4>
                    <div style="display: grid; gap: 10px;">
            `;
            
            Object.entries(planStats).forEach(([plan, stats]) => {
                const planName = {
                    'all': 'å…¨ä¼šå“¡',
                    'free': 'ç„¡æ–™ä¼šå“¡',
                    'paid': 'æœ‰æ–™ä¼šå“¡',
                    'standard': 'Standardä¼šå“¡',
                    'premium': 'Premiumä¼šå“¡',
                    'retry': 'å†é€ä¿¡'
                }[plan] || plan;
                
                const planSuccessRate = stats.sent + stats.failed > 0 ? ((stats.sent / (stats.sent + stats.failed)) * 100).toFixed(1) : '0';
                
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8fafc; border-radius: 6px;">
                        <span style="font-weight: 600; color: #374151;">${planName}</span>
                        <div style="display: flex; gap: 15px; align-items: center;">
                            <span style="color: #059669;">æˆåŠŸ: ${stats.sent}</span>
                            <span style="color: #dc2626;">å¤±æ•—: ${stats.failed}</span>
                            <span style="color: #0ea5e9; font-weight: 600;">${planSuccessRate}%</span>
                        </div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
                
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-top: 20px;">
                    <h4 style="margin-top: 0; color: #374151;">ğŸ“… æœ€è¿‘ã®é…ä¿¡å±¥æ­´ (è©³ç´°)</h4>
                    <div style="max-height: 300px; overflow-y: auto;">
            `;
            
            recentHistory.forEach((item, index) => {
                const date = new Date(item.scheduledAt || item.createdAt).toLocaleString('ja-JP');
                const statusColor = item.failedCount > 0 ? '#f59e0b' : '#059669';
                const statusText = item.failedCount > 0 ? `æˆåŠŸ${item.recipientCount}ä»¶ / å¤±æ•—${item.failedCount}ä»¶` : `æˆåŠŸ${item.recipientCount}ä»¶`;
                
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #e5e7eb;">
                        <div>
                            <div style="font-weight: 600; color: #374151;">${item.subject}</div>
                            <div style="font-size: 0.9em; color: #6b7280;">${date}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="color: ${statusColor}; font-weight: 600;">${statusText}</div>
                            <div style="font-size: 0.9em; color: #6b7280;">${item.status === 'scheduled' ? 'äºˆç´„æ¸ˆã¿' : 'é…ä¿¡æ¸ˆã¿'}</div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
                
                <div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin-top: 20px; border-left: 4px solid #f59e0b;">
                    <h4 style="margin: 0 0 10px 0; color: #92400e;">ğŸ’¡ æ”¹å–„ææ¡ˆ</h4>
                    <ul style="margin: 0; padding-left: 20px; color: #78350f;">
            `;
            
            if (parseFloat(successRate) < 95) {
                html += '<li>é…ä¿¡æˆåŠŸç‡ãŒ95%ã‚’ä¸‹å›ã£ã¦ã„ã¾ã™ã€‚ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å“è³ªç¢ºèªã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚</li>';
            }
            if (totalFailed > 0) {
                html += '<li>é…ä¿¡å¤±æ•—ãƒ¡ãƒ¼ãƒ«ãŒã‚ã‚Šã¾ã™ã€‚ã€Œå¤±æ•—ãƒ¡ãƒ¼ãƒ«ç¢ºèªã€ã‹ã‚‰å†é€ä¿¡ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚</li>';
            }
            if (recentHistory.length < 5) {
                html += '<li>å®šæœŸçš„ãªé…ä¿¡ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆã‚’å‘ä¸Šã•ã›ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚</li>';
            }
            if (planStats['free'] && planStats['paid']) {
                const freeRate = planStats['free'].sent / (planStats['free'].sent + planStats['free'].failed || 1);
                const paidRate = (planStats['standard']?.sent || 0) + (planStats['premium']?.sent || 0);
                if (freeRate > paidRate) {
                    html += '<li>ç„¡æ–™ä¼šå“¡ã¸ã®é…ä¿¡ãŒå¤šã‚ã§ã™ã€‚æœ‰æ–™ä¼šå“¡å‘ã‘ã®ç‰¹åˆ¥ã‚³ãƒ³ãƒ†ãƒ³ãƒ„é…ä¿¡ã‚‚æ¤œè¨ã—ã¦ãã ã•ã„ã€‚</li>';
                }
            }
            
            if (parseFloat(successRate) >= 95 && totalFailed === 0 && recentHistory.length >= 5) {
                html += '<li style="color: #059669;">âœ¨ é…ä¿¡ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¯è‰¯å¥½ã§ã™ï¼ã“ã®èª¿å­ã§ç¶™ç¶šã—ã¦ãã ã•ã„ã€‚</li>';
            }
            
            html += `
                    </ul>
                </div>
            `;
            
            reportContent.innerHTML = html;
            
        } catch (error) {
            console.error('ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
            reportContent.innerHTML = '<p style="color: #dc2626;">ãƒ¬ãƒãƒ¼ãƒˆã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
        }
    }

    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†æ©Ÿèƒ½
    document.getElementById('saveTemplateBtn')?.addEventListener('click', saveCurrentTemplate);
    document.getElementById('loadTemplateBtn')?.addEventListener('click', showTemplateModal);
    document.getElementById('closeTemplateModalBtn')?.addEventListener('click', hideTemplateModal);
    document.getElementById('deleteAllTemplatesBtn')?.addEventListener('click', deleteAllTemplates);
    
    // ãƒ†ã‚¹ãƒˆé€ä¿¡æ©Ÿèƒ½
    document.getElementById('testSendBtn')?.addEventListener('click', showTestSendModal);
    document.getElementById('cancelTestSendBtn')?.addEventListener('click', hideTestSendModal);
    document.getElementById('executeTestSendBtn')?.addEventListener('click', executeTestSend);
    
    // ãƒ†ã‚¹ãƒˆé€ä¿¡ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
    function showTestSendModal() {
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è¨­å®š
        const savedEmail = localStorage.getItem('test-email-address') || 'admin@example.com';
        document.getElementById('testEmailAddress').value = savedEmail;
        
        document.getElementById('testSendStatus').innerHTML = '';
        document.getElementById('testSendModal').style.display = 'block';
    }
    
    // ãƒ†ã‚¹ãƒˆé€ä¿¡ãƒ¢ãƒ¼ãƒ€ãƒ«éè¡¨ç¤º
    function hideTestSendModal() {
        document.getElementById('testSendModal').style.display = 'none';
        document.getElementById('testSendStatus').innerHTML = '';
    }
    
    // ãƒ†ã‚¹ãƒˆé€ä¿¡å®Ÿè¡Œ
    async function executeTestSend() {
        const testEmail = document.getElementById('testEmailAddress')?.value;
        const statusDiv = document.getElementById('testSendStatus');
        const executeBtn = document.getElementById('executeTestSendBtn');
        
        // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        if (!testEmail || !testEmail.includes('@')) {
            statusDiv.innerHTML = '<div style="color: #dc2626; font-weight: 600;">âš ï¸ æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>';
            return;
        }
        
        const subject = document.getElementById('subject')?.value;
        const mainContent = document.getElementById('mainContent')?.value;
        
        if (!subject || !mainContent) {
            statusDiv.innerHTML = '<div style="color: #dc2626; font-weight: 600;">âš ï¸ ä»¶åã¨æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>';
            return;
        }
        
        // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä¿å­˜
        localStorage.setItem('test-email-address', testEmail);
        
        try {
            // ãƒœã‚¿ãƒ³ç„¡åŠ¹åŒ–
            executeBtn.disabled = true;
            executeBtn.textContent = 'é€ä¿¡ä¸­...';
            
            statusDiv.innerHTML = '<div style="color: #3b82f6; font-weight: 600;">ğŸ“§ ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¦ã„ã¾ã™...</div>';
            
            // ãƒ†ã‚¹ãƒˆé€ä¿¡ç”¨ã®ãƒ‡ãƒ¼ã‚¿æº–å‚™
            const templateData = collectFormData();
            templateData.subject = '[TEST] ' + templateData.subject;
            
            // HTMLã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”Ÿæˆ
            const htmlContent = generateAdvancedNewsletterHTML(templateData);
            
            const testSendData = {
                subject: templateData.subject,
                htmlContent: htmlContent,
                targetPlan: 'test',
                scheduledAt: null,
                testEmail: testEmail
            };
            
            console.log('ãƒ†ã‚¹ãƒˆé€ä¿¡ãƒ‡ãƒ¼ã‚¿:', testSendData);
            
            // ãƒ†ã‚¹ãƒˆé€ä¿¡APIå‘¼ã³å‡ºã—
            const response = await fetch('/.netlify/functions/send-newsletter', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(testSendData)
            });
            
            const responseText = await response.text();
            console.log('ãƒ†ã‚¹ãƒˆé€ä¿¡ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', responseText);
            
            let result;
            try {
                result = JSON.parse(responseText);
            } catch (parseError) {
                console.error('ãƒ†ã‚¹ãƒˆé€ä¿¡ãƒ¬ã‚¹ãƒãƒ³ã‚¹è§£æã‚¨ãƒ©ãƒ¼:', parseError);
                throw new Error('ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®å¿œç­”ã‚’è§£æã§ãã¾ã›ã‚“ã§ã—ãŸ');
            }
            
            if (response.ok && result.success) {
                statusDiv.innerHTML = `
                    <div style="color: #059669; font-weight: 600;">
                        âœ… ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸ<br>
                        <small style="color: #6b7280;">é€ä¿¡å…ˆ: ${testEmail}</small>
                    </div>
                `;
                
                // 3ç§’å¾Œã«ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                setTimeout(() => {
                    hideTestSendModal();
                }, 3000);
                
            } else {
                const errorMessage = result.error || `é€ä¿¡ã‚¨ãƒ©ãƒ¼ (${response.status})`;
                statusDiv.innerHTML = `<div style="color: #dc2626; font-weight: 600;">âŒ ${errorMessage}</div>`;
            }
            
        } catch (error) {
            console.error('ãƒ†ã‚¹ãƒˆé€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
            statusDiv.innerHTML = `<div style="color: #dc2626; font-weight: 600;">âŒ ãƒ†ã‚¹ãƒˆé€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}</div>`;
        } finally {
            // ãƒœã‚¿ãƒ³å¾©å…ƒ
            executeBtn.disabled = false;
            executeBtn.textContent = 'ğŸ“§ ãƒ†ã‚¹ãƒˆé€ä¿¡å®Ÿè¡Œ';
        }
    }
    
    // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’åé›†ï¼ˆãƒ†ã‚¹ãƒˆé€ä¿¡ç”¨ï¼‰
    function collectFormData() {
        const templateType = document.getElementById('templateType')?.value || 'prediction';
        const targetPlan = document.getElementById('targetPlan')?.value || 'all';
        
        let templateData = {
            title: document.getElementById('subject')?.value || 'ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«',
            subject: document.getElementById('subject')?.value || 'ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«',
            mainContent: document.getElementById('mainContent')?.value || '',
            templateType: templateType,
            targetPlan: targetPlan,
            customCtaText: document.getElementById('customCtaText')?.value || '',
            customCtaUrl: document.getElementById('customCtaUrl')?.value || '',
            showCtaButton: document.getElementById('showCtaButton')?.checked || true,
            predictions: [],
            results: [],
            predictionNote: document.getElementById('predictionNote')?.value || '',
            additionalSection: document.getElementById('additionalSection')?.value || '',
            customHeadline: document.getElementById('customHeadline')?.value || '',
            customAccent: document.getElementById('customAccent')?.value || '',
            campaignTitle: document.getElementById('campaignTitle')?.value || '',
            campaignDetails: document.getElementById('campaignDetails')?.value || '',
            originalPrice: document.getElementById('originalPrice')?.value || '',
            campaignPrice: document.getElementById('campaignPrice')?.value || '',
            campaignDeadline: document.getElementById('campaignDeadline')?.value || ''
        };
        
        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¿ã‚¤ãƒ—åˆ¥ã®ãƒ‡ãƒ¼ã‚¿åé›†
        if (templateType === 'prediction') {
            const predictionInputs = document.querySelectorAll('.prediction-input');
            predictionInputs.forEach(input => {
                const raceName = input.querySelector('.race-name-input')?.value;
                const horses = input.querySelector('.horses-input')?.value;
                if (raceName && horses) {
                    templateData.predictions.push({
                        raceName: raceName,
                        horses: horses.split('\n').filter(h => h.trim())
                    });
                }
            });
        }
        
        if (templateType === 'result') {
            const resultInputs = document.querySelectorAll('.result-input');
            resultInputs.forEach(input => {
                const raceName = input.querySelector('.race-name-input')?.value;
                const winner = input.querySelector('.winner-input')?.value;
                const payout = input.querySelector('.payout-input')?.value;
                const status = input.querySelector('.status-select')?.value;
                if (raceName && winner) {
                    templateData.results.push({
                        raceName: raceName,
                        winner: winner,
                        payout: payout,
                        status: status || 'miss'
                    });
                }
            });
        }
        
        return templateData;
    }

    // ç¾åœ¨ã®è¨­å®šã‚’ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨ã—ã¦ä¿å­˜
    function saveCurrentTemplate() {
        const subject = document.getElementById('subject')?.value;
        const mainContent = document.getElementById('mainContent')?.value;
        const templateType = document.getElementById('templateType')?.value;
        
        if (!subject || !mainContent) {
            alert('ä»¶åã¨æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ã‹ã‚‰ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä¿å­˜ã—ã¦ãã ã•ã„');
            return;
        }
        
        const templateName = prompt('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', subject.substring(0, 30));
        if (!templateName) {
            return;
        }
        
        try {
            // ç¾åœ¨ã®ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’åé›†
            const templateData = {
                id: Date.now().toString(),
                name: templateName,
                subject: subject,
                mainContent: mainContent,
                templateType: templateType,
                targetPlan: document.getElementById('targetPlan')?.value || 'all',
                customCtaText: document.getElementById('customCtaText')?.value || '',
                customCtaUrl: document.getElementById('customCtaUrl')?.value || '',
                showCtaButton: document.getElementById('showCtaButton')?.checked || true,
                createdAt: new Date().toISOString(),
                
                // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¿ã‚¤ãƒ—åˆ¥ã®ãƒ‡ãƒ¼ã‚¿
                predictions: [],
                results: [],
                predictionNote: document.getElementById('predictionNote')?.value || '',
                additionalSection: document.getElementById('additionalSection')?.value || '',
                
                // ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
                customHeadline: document.getElementById('customHeadline')?.value || '',
                customAccent: document.getElementById('customAccent')?.value || '',
                
                // ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
                campaignTitle: document.getElementById('campaignTitle')?.value || '',
                campaignDetails: document.getElementById('campaignDetails')?.value || '',
                originalPrice: document.getElementById('originalPrice')?.value || '',
                campaignPrice: document.getElementById('campaignPrice')?.value || '',
                campaignDeadline: document.getElementById('campaignDeadline')?.value || ''
            };
            
            // äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ã®åé›†ï¼ˆäºˆæƒ³ã‚¿ã‚¤ãƒ—ã®å ´åˆï¼‰
            if (templateType === 'prediction') {
                const predictionInputs = document.querySelectorAll('.prediction-input');
                predictionInputs.forEach(input => {
                    const raceName = input.querySelector('.race-name-input')?.value;
                    const horses = input.querySelector('.horses-input')?.value;
                    if (raceName && horses) {
                        templateData.predictions.push({
                            raceName: raceName,
                            horses: horses.split('\n').filter(h => h.trim())
                        });
                    }
                });
            }
            
            // çµæœãƒ‡ãƒ¼ã‚¿ã®åé›†ï¼ˆçµæœã‚¿ã‚¤ãƒ—ã®å ´åˆï¼‰
            if (templateType === 'result') {
                const resultInputs = document.querySelectorAll('.result-input');
                resultInputs.forEach(input => {
                    const raceName = input.querySelector('.race-name-input')?.value;
                    const winner = input.querySelector('.winner-input')?.value;
                    const payout = input.querySelector('.payout-input')?.value;
                    const status = input.querySelector('.status-select')?.value;
                    if (raceName && winner) {
                        templateData.results.push({
                            raceName: raceName,
                            winner: winner,
                            payout: payout,
                            status: status || 'miss'
                        });
                    }
                });
            }
            
            // LocalStorageã«ä¿å­˜
            const existingTemplates = JSON.parse(localStorage.getItem('email-templates') || '[]');
            existingTemplates.unshift(templateData); // æœ€æ–°ã‚’å…ˆé ­ã«
            
            // æœ€å¤§20ä»¶ã¾ã§ä¿æŒ
            const limitedTemplates = existingTemplates.slice(0, 20);
            localStorage.setItem('email-templates', JSON.stringify(limitedTemplates));
            
            alert(`ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€Œ${templateName}ã€ã‚’ä¿å­˜ã—ã¾ã—ãŸ`);
            console.log('âœ… ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¿å­˜å®Œäº†:', templateData);
            
        } catch (error) {
            console.error('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
            alert('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        }
    }

    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    function showTemplateModal() {
        loadTemplateList();
        document.getElementById('templateModal').style.display = 'block';
    }

    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’éè¡¨ç¤º
    function hideTemplateModal() {
        document.getElementById('templateModal').style.display = 'none';
    }

    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
    function loadTemplateList() {
        const templateList = document.getElementById('templateList');
        const templates = JSON.parse(localStorage.getItem('email-templates') || '[]');
        
        if (templates.length === 0) {
            templateList.innerHTML = `
                <div style="text-align: center; color: #6b7280; padding: 40px;">
                    <div style="font-size: 48px; margin-bottom: 15px;">ğŸ“</div>
                    <p>ä¿å­˜ã•ã‚ŒãŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</p>
                    <small>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ã€Œãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„</small>
                </div>
            `;
            return;
        }
        
        let html = '';
        templates.forEach((template, index) => {
            const createdDate = new Date(template.createdAt).toLocaleDateString('ja-JP');
            const templateTypeName = {
                'prediction': 'ğŸ¯ äºˆæƒ³',
                'result': 'ğŸ“Š çµæœ',
                'campaign': 'ğŸª ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³',
                'custom': 'âœ¨ ã‚«ã‚¹ã‚¿ãƒ '
            }[template.templateType] || template.templateType;
            
            html += `
                <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px; margin-bottom: 15px; background: white;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                        <div>
                            <h4 style="margin: 0 0 5px 0; color: #374151;">${template.name}</h4>
                            <div style="font-size: 0.9em; color: #6b7280;">
                                ${templateTypeName} | ${createdDate} | å¯¾è±¡: ${getTargetPlanName(template.targetPlan)}
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="loadTemplate(${index})" class="btn btn-primary" style="padding: 6px 12px; font-size: 0.9em;">ğŸ“‚ èª­è¾¼</button>
                            <button onclick="deleteTemplate(${index})" class="btn btn-danger" style="padding: 6px 12px; font-size: 0.9em;">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                    <div style="background: #f8fafc; padding: 12px; border-radius: 6px; font-size: 0.9em; color: #4b5563;">
                        <strong>ä»¶å:</strong> ${template.subject}<br>
                        <strong>æœ¬æ–‡:</strong> ${template.mainContent.substring(0, 100)}${template.mainContent.length > 100 ? '...' : ''}
                    </div>
                </div>
            `;
        });
        
        templateList.innerHTML = html;
    }

    // ãƒ—ãƒ©ãƒ³åã‚’æ—¥æœ¬èªã«å¤‰æ›
    function getTargetPlanName(plan) {
        const planNames = {
            'all': 'å…¨ä¼šå“¡',
            'free': 'ç„¡æ–™ä¼šå“¡',
            'paid': 'æœ‰æ–™ä¼šå“¡',
            'standard': 'Standardä¼šå“¡',
            'premium': 'Premiumä¼šå“¡'
        };
        return planNames[plan] || plan;
    }

    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿
    function loadTemplate(index) {
        try {
            const templates = JSON.parse(localStorage.getItem('email-templates') || '[]');
            if (index < 0 || index >= templates.length) {
                alert('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            const template = templates[index];
            
            // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
            if (!confirm(`ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€Œ${template.name}ã€ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã‹ï¼Ÿ\nç¾åœ¨ã®å…¥åŠ›å†…å®¹ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚`)) {
                return;
            }
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã«å€¤ã‚’è¨­å®š
            document.getElementById('subject').value = template.subject || '';
            document.getElementById('mainContent').value = template.mainContent || '';
            document.getElementById('templateType').value = template.templateType || 'prediction';
            document.getElementById('targetPlan').value = template.targetPlan || 'all';
            document.getElementById('customCtaText').value = template.customCtaText || '';
            document.getElementById('customCtaUrl').value = template.customCtaUrl || '';
            
            if (document.getElementById('showCtaButton')) {
                document.getElementById('showCtaButton').checked = template.showCtaButton !== false;
            }
            
            // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¿ã‚¤ãƒ—å›ºæœ‰ã®è¨­å®š
            if (template.predictionNote) {
                const predNoteEl = document.getElementById('predictionNote');
                if (predNoteEl) predNoteEl.value = template.predictionNote;
            }
            
            if (template.additionalSection) {
                const addSectionEl = document.getElementById('additionalSection');
                if (addSectionEl) addSectionEl.value = template.additionalSection;
            }
            
            // ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
            if (template.customHeadline) {
                const customHeadlineEl = document.getElementById('customHeadline');
                if (customHeadlineEl) customHeadlineEl.value = template.customHeadline;
            }
            
            if (template.customAccent) {
                const customAccentEl = document.getElementById('customAccent');
                if (customAccentEl) customAccentEl.value = template.customAccent;
            }
            
            // ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
            if (template.campaignTitle) {
                const campaignTitleEl = document.getElementById('campaignTitle');
                if (campaignTitleEl) campaignTitleEl.value = template.campaignTitle;
            }
            
            // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¿ã‚¤ãƒ—ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°
            setTimeout(() => {
                updateTemplateSection();
            }, 100);
            
            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ã‚¯ãƒªã‚¢
            clearPreview();
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            hideTemplateModal();
            
            alert(`ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€Œ${template.name}ã€ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
            console.log('âœ… ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆèª­ã¿è¾¼ã¿å®Œäº†:', template);
            
        } catch (error) {
            console.error('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            alert('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        }
    }

    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å‰Šé™¤
    function deleteTemplate(index) {
        try {
            const templates = JSON.parse(localStorage.getItem('email-templates') || '[]');
            if (index < 0 || index >= templates.length) {
                alert('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            const template = templates[index];
            if (!confirm(`ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€Œ${template.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚`)) {
                return;
            }
            
            templates.splice(index, 1);
            localStorage.setItem('email-templates', JSON.stringify(templates));
            
            // ãƒªã‚¹ãƒˆã‚’æ›´æ–°
            loadTemplateList();
            
            alert(`ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€Œ${template.name}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
            
        } catch (error) {
            console.error('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
            alert('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        }
    }

    // å…¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å‰Šé™¤
    function deleteAllTemplates() {
        const templates = JSON.parse(localStorage.getItem('email-templates') || '[]');
        if (templates.length === 0) {
            alert('å‰Šé™¤ã™ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“');
            return;
        }
        
        if (!confirm(`ã™ã¹ã¦ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆ${templates.length}ä»¶ï¼‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚`)) {
            return;
        }
        
        localStorage.removeItem('email-templates');
        loadTemplateList();
        alert('ã™ã¹ã¦ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
    }

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å®šç¾©ï¼ˆHTMLã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã«ã™ã‚‹ãŸã‚ï¼‰
    window.removeFailedEmail = removeFailedEmail;
    window.loadTemplate = loadTemplate;
    window.deleteTemplate = deleteTemplate;

    // ç¾åœ¨æ™‚åˆ»ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
    function updateCurrentTime() {
        const now = new Date();
        const timeString = now.toLocaleString('ja-JP', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
        const currentTimeElement = document.getElementById('currentTime');
        if (currentTimeElement) {
            currentTimeElement.textContent = timeString;
        }
    }

    // ç¾åœ¨æ™‚åˆ»ã‚’1ç§’ã”ã¨ã«æ›´æ–°
    setInterval(updateCurrentTime, 1000);

    // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿèƒ½é–¢é€£
    let securitySettings = {
        hourlyLimit: 50,
        dailyLimit: 1000,
        adminPassword: 'nankan123',
        ipRestrictionEnabled: false,
        allowedIps: [],
        timeRestrictionEnabled: false,
        allowedStartTime: '09:00',
        allowedEndTime: '18:00'
    };

    // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šã‚’èª­ã¿è¾¼ã¿
    function loadSecuritySettings() {
        try {
            const saved = localStorage.getItem('newsletter-security');
            if (saved) {
                securitySettings = { ...securitySettings, ...JSON.parse(saved) };
            }
            
            // UI ã«è¨­å®šã‚’åæ˜ 
            document.getElementById('securityHourlyLimit').value = securitySettings.hourlyLimit;
            document.getElementById('securityDailyLimit').value = securitySettings.dailyLimit;
            document.getElementById('enableIpRestriction').checked = securitySettings.ipRestrictionEnabled;
            document.getElementById('allowedIps').value = securitySettings.allowedIps.join('\n');
            document.getElementById('enableTimeRestriction').checked = securitySettings.timeRestrictionEnabled;
            document.getElementById('allowedStartTime').value = securitySettings.allowedStartTime;
            document.getElementById('allowedEndTime').value = securitySettings.allowedEndTime;
            
            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹çŠ¶æ…‹ã«å¿œã˜ã¦ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æœ‰åŠ¹/ç„¡åŠ¹åŒ–
            document.getElementById('allowedIps').disabled = !securitySettings.ipRestrictionEnabled;
            document.getElementById('allowedStartTime').disabled = !securitySettings.timeRestrictionEnabled;
            document.getElementById('allowedEndTime').disabled = !securitySettings.timeRestrictionEnabled;
            
        } catch (error) {
            console.error('ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        }
    }

    // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šã‚’ä¿å­˜
    function saveSecuritySettings() {
        try {
            localStorage.setItem('newsletter-security', JSON.stringify(securitySettings));
        } catch (error) {
            console.error('ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        }
    }

    // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°ã‚’è¨˜éŒ²
    function logSecurityEvent(type, message, severity = 'info') {
        try {
            const log = {
                timestamp: new Date().toISOString(),
                type: type,
                message: message,
                severity: severity,
                ip: document.getElementById('currentIp')?.textContent || 'unknown'
            };
            
            const logs = JSON.parse(localStorage.getItem('security-logs') || '[]');
            logs.unshift(log);
            
            // æœ€æ–°1000ä»¶ã¾ã§ä¿æŒ
            if (logs.length > 1000) {
                logs.splice(1000);
            }
            
            localStorage.setItem('security-logs', JSON.stringify(logs));
            console.log('ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°è¨˜éŒ²:', log);
        } catch (error) {
            console.error('ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°è¨˜éŒ²ã‚¨ãƒ©ãƒ¼:', error);
        }
    }

    // ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒã‚§ãƒƒã‚¯
    function checkRateLimit() {
        try {
            const now = new Date();
            const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const oneHourAgo = new Date(now.getTime() - (60 * 60 * 1000));
            
            const history = JSON.parse(localStorage.getItem('newsletter-history') || '[]');
            
            let todayCount = 0;
            let hourCount = 0;
            
            history.forEach(item => {
                const sentTime = new Date(item.createdAt || item.scheduledAt);
                if (sentTime >= todayStart) {
                    todayCount += item.recipientCount || 0;
                }
                if (sentTime >= oneHourAgo) {
                    hourCount += item.recipientCount || 0;
                }
            });
            
            // UIæ›´æ–°
            document.getElementById('todaySentCount').textContent = todayCount;
            document.getElementById('hourSentCount').textContent = hourCount;
            
            // åˆ¶é™ãƒã‚§ãƒƒã‚¯
            const dailyLimit = parseInt(securitySettings.dailyLimit) || 0;
            const hourlyLimit = parseInt(securitySettings.hourlyLimit) || 0;
            
            if (dailyLimit > 0 && todayCount >= dailyLimit) {
                logSecurityEvent('RATE_LIMIT', `æ—¥æ¬¡åˆ¶é™ã«é”ã—ã¾ã—ãŸ (${todayCount}/${dailyLimit}é€š)`, 'warning');
                return { allowed: false, reason: `æ—¥æ¬¡åˆ¶é™ã«é”ã—ã¦ã„ã¾ã™ (${todayCount}/${dailyLimit}é€š)` };
            }
            
            if (hourlyLimit > 0 && hourCount >= hourlyLimit) {
                logSecurityEvent('RATE_LIMIT', `æ™‚é–“åˆ¶é™ã«é”ã—ã¾ã—ãŸ (${hourCount}/${hourlyLimit}é€š)`, 'warning');
                return { allowed: false, reason: `æ™‚é–“åˆ¶é™ã«é”ã—ã¦ã„ã¾ã™ (${hourCount}/${hourlyLimit}é€š)` };
            }
            
            return { allowed: true, todayCount, hourCount };
            
        } catch (error) {
            console.error('ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
            return { allowed: true };
        }
    }

    // æ™‚é–“åˆ¶é™ãƒã‚§ãƒƒã‚¯
    function checkTimeRestriction() {
        if (!securitySettings.timeRestrictionEnabled) {
            return { allowed: true };
        }
        
        const now = new Date();
        const currentTime = now.getHours() * 100 + now.getMinutes();
        const startTime = parseInt(securitySettings.allowedStartTime.replace(':', ''));
        const endTime = parseInt(securitySettings.allowedEndTime.replace(':', ''));
        
        if (currentTime < startTime || currentTime > endTime) {
            const reason = `è¨±å¯æ™‚é–“å¤–ã§ã™ (${securitySettings.allowedStartTime}-${securitySettings.allowedEndTime})`;
            logSecurityEvent('TIME_RESTRICTION', reason, 'warning');
            return { allowed: false, reason };
        }
        
        return { allowed: true };
    }

    // ç®¡ç†è€…èªè¨¼ãƒã‚§ãƒƒã‚¯
    function checkAdminAuth(recipientCount) {
        // 500é€šä»¥ä¸Šã®å ´åˆã®ã¿ç®¡ç†è€…èªè¨¼ãŒå¿…è¦ï¼ˆç·©å’Œï¼‰
        if (recipientCount >= 500) {
            const inputPassword = document.getElementById('adminPassword').value;
            if (!inputPassword || inputPassword.trim() === '') {
                logSecurityEvent('AUTH_FAILURE', `ç®¡ç†è€…èªè¨¼æœªå…¥åŠ› (${recipientCount}é€šã®é…ä¿¡è©¦è¡Œ)`, 'error');
                return { allowed: false, reason: 'å¤§é‡é…ä¿¡ã®ãŸã‚ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¿…è¦ã§ã™' };
            }
            if (inputPassword !== securitySettings.adminPassword) {
                logSecurityEvent('AUTH_FAILURE', `ç®¡ç†è€…èªè¨¼å¤±æ•— (${recipientCount}é€šã®é…ä¿¡è©¦è¡Œ)`, 'error');
                return { allowed: false, reason: 'ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“' };
            }
            logSecurityEvent('AUTH_SUCCESS', `ç®¡ç†è€…èªè¨¼æˆåŠŸ (${recipientCount}é€šã®é…ä¿¡)`, 'info');
        }
        return { allowed: true };
    }

    // åŒ…æ‹¬çš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
    function performSecurityCheck(recipientCount) {
        const checks = [
            checkRateLimit(),
            checkTimeRestriction(),
            checkAdminAuth(recipientCount)
        ];
        
        for (const check of checks) {
            if (!check.allowed) {
                return check;
            }
        }
        
        logSecurityEvent('SEND_APPROVED', `é…ä¿¡æ‰¿èª: ${recipientCount}é€š`, 'info');
        return { allowed: true };
    }

    // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    document.getElementById('securityHourlyLimit')?.addEventListener('change', (e) => {
        securitySettings.hourlyLimit = parseInt(e.target.value) || 0;
        saveSecuritySettings();
        checkRateLimit(); // UIæ›´æ–°
    });

    document.getElementById('securityDailyLimit')?.addEventListener('change', (e) => {
        securitySettings.dailyLimit = parseInt(e.target.value) || 0;
        saveSecuritySettings();
        checkRateLimit(); // UIæ›´æ–°
    });

    document.getElementById('enableIpRestriction')?.addEventListener('change', (e) => {
        securitySettings.ipRestrictionEnabled = e.target.checked;
        document.getElementById('allowedIps').disabled = !e.target.checked;
        saveSecuritySettings();
    });

    document.getElementById('allowedIps')?.addEventListener('change', (e) => {
        securitySettings.allowedIps = e.target.value.split('\n').filter(ip => ip.trim());
        saveSecuritySettings();
    });

    document.getElementById('enableTimeRestriction')?.addEventListener('change', (e) => {
        securitySettings.timeRestrictionEnabled = e.target.checked;
        document.getElementById('allowedStartTime').disabled = !e.target.checked;
        document.getElementById('allowedEndTime').disabled = !e.target.checked;
        saveSecuritySettings();
    });

    document.getElementById('allowedStartTime')?.addEventListener('change', (e) => {
        securitySettings.allowedStartTime = e.target.value;
        saveSecuritySettings();
    });

    document.getElementById('allowedEndTime')?.addEventListener('change', (e) => {
        securitySettings.allowedEndTime = e.target.value;
        saveSecuritySettings();
    });

    // ç®¡ç†è€…èªè¨¼ç¢ºèªãƒœã‚¿ãƒ³
    document.getElementById('verifyAdminBtn')?.addEventListener('click', () => {
        const statusDiv = document.getElementById('adminAuthStatus');
        const messageSpan = document.getElementById('adminAuthMessage');
        const inputPassword = document.getElementById('adminPassword').value;
        
        if (!inputPassword) {
            statusDiv.style.display = 'block';
            statusDiv.style.background = '#fef2f2';
            statusDiv.style.border = '1px solid #fecaca';
            messageSpan.textContent = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
            messageSpan.style.color = '#dc2626';
            return;
        }
        
        if (inputPassword === securitySettings.adminPassword) {
            statusDiv.style.display = 'block';
            statusDiv.style.background = '#ecfdf5';
            statusDiv.style.border = '1px solid #a7f3d0';
            messageSpan.textContent = 'âœ… èªè¨¼æˆåŠŸ';
            messageSpan.style.color = '#065f46';
            logSecurityEvent('AUTH_TEST', 'ç®¡ç†è€…èªè¨¼ãƒ†ã‚¹ãƒˆæˆåŠŸ', 'info');
        } else {
            statusDiv.style.display = 'block';
            statusDiv.style.background = '#fef2f2';
            statusDiv.style.border = '1px solid #fecaca';
            messageSpan.textContent = 'âŒ èªè¨¼å¤±æ•—';
            messageSpan.style.color = '#dc2626';
            logSecurityEvent('AUTH_TEST', 'ç®¡ç†è€…èªè¨¼ãƒ†ã‚¹ãƒˆå¤±æ•—', 'warning');
        }
    });

    // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°è¡¨ç¤º
    document.getElementById('showSecurityLogBtn')?.addEventListener('click', () => {
        const logArea = document.getElementById('securityLogArea');
        try {
            const logs = JSON.parse(localStorage.getItem('security-logs') || '[]');
            
            if (logs.length === 0) {
                logArea.innerHTML = '<div style="color: #6b7280; text-align: center;">ğŸ“„ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }
            
            const recentLogs = logs.slice(0, 20); // æœ€æ–°20ä»¶
            let html = '';
            
            recentLogs.forEach(log => {
                const date = new Date(log.timestamp).toLocaleString('ja-JP');
                const severityColor = {
                    'info': '#059669',
                    'warning': '#d97706',
                    'error': '#dc2626'
                }[log.severity] || '#6b7280';
                
                const severityIcon = {
                    'info': 'ğŸ“',
                    'warning': 'âš ï¸',
                    'error': 'ğŸš¨'
                }[log.severity] || 'ğŸ“‹';
                
                html += `
                    <div style="padding: 8px; border-bottom: 1px solid #e5e7eb; font-size: 0.9rem;">
                        <div style="color: ${severityColor}; font-weight: 600;">
                            ${severityIcon} ${log.type}
                        </div>
                        <div style="color: #374151; margin: 2px 0;">
                            ${log.message}
                        </div>
                        <div style="color: #6b7280; font-size: 0.8rem;">
                            ${date} | IP: ${log.ip}
                        </div>
                    </div>
                `;
            });
            
            logArea.innerHTML = html;
            
        } catch (error) {
            logArea.innerHTML = '<div style="color: #dc2626;">ãƒ­ã‚°ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
            console.error('ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
        }
    });

    // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°ã‚¯ãƒªã‚¢
    document.getElementById('clearSecurityLogBtn')?.addEventListener('click', () => {
        if (confirm('ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
            localStorage.removeItem('security-logs');
            logSecurityEvent('LOG_CLEARED', 'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°ãŒã‚¯ãƒªã‚¢ã•ã‚Œã¾ã—ãŸ', 'info');
            document.getElementById('securityLogArea').innerHTML = '<div style="color: #6b7280; text-align: center;">ğŸ“„ ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ</div>';
            alert('ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
        }
    });

    // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°å‡ºåŠ›
    document.getElementById('exportSecurityLogBtn')?.addEventListener('click', () => {
        try {
            const logs = JSON.parse(localStorage.getItem('security-logs') || '[]');
            const csv = 'Timestamp,Type,Message,Severity,IP\n' + 
                       logs.map(log => `"${log.timestamp}","${log.type}","${log.message}","${log.severity}","${log.ip}"`).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `security-log-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            logSecurityEvent('LOG_EXPORT', 'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°ãŒã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã•ã‚Œã¾ã—ãŸ', 'info');
        } catch (error) {
            alert('ãƒ­ã‚°ã®å‡ºåŠ›ã«å¤±æ•—ã—ã¾ã—ãŸ');
            console.error('ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°å‡ºåŠ›ã‚¨ãƒ©ãƒ¼:', error);
        }
    });

    // æ¨å®šå—ä¿¡è€…æ•°ã‚’è¨ˆç®—
    function calculateEstimatedRecipients(targetPlan) {
        // ãƒ—ãƒ©ãƒ³åˆ¥ã®æ¨å®šãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°ï¼ˆå®Ÿéš›ã®é¡§å®¢æ•°ã«å¿œã˜ã¦èª¿æ•´ï¼‰
        const estimatedCounts = {
            'all': 500,
            'free': 300,
            'paid': 200,
            'standard': 150,
            'premium': 50
        };
        
        return estimatedCounts[targetPlan] || 100;
    }

    // ç¾åœ¨ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹å–å¾—
    async function getCurrentIP() {
        try {
            const response = await fetch('https://api.ipify.org?format=json');
            const data = await response.json();
            document.getElementById('currentIp').textContent = data.ip;
        } catch (error) {
            console.error('IPå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            document.getElementById('currentIp').textContent = 'å–å¾—å¤±æ•—';
        }
    }

    // Unsubscribeæ©Ÿèƒ½é–¢é€£
    let unsubscribeSettings = {
        autoUnsubscribeLink: true,
        unsubscribeLinkText: 'é…ä¿¡åœæ­¢ã¯ã“ã¡ã‚‰',
        allowSelfResubscribe: false
    };

    // Unsubscribeè¨­å®šã‚’èª­ã¿è¾¼ã¿
    function loadUnsubscribeSettings() {
        try {
            const saved = localStorage.getItem('newsletter-unsubscribe');
            if (saved) {
                unsubscribeSettings = { ...unsubscribeSettings, ...JSON.parse(saved) };
            }
            
            document.getElementById('autoUnsubscribeLink').checked = unsubscribeSettings.autoUnsubscribeLink;
            document.getElementById('unsubscribeLinkText').value = unsubscribeSettings.unsubscribeLinkText;
            document.getElementById('allowSelfResubscribe').checked = unsubscribeSettings.allowSelfResubscribe;
            
            updateUnsubscribePreview();
            
        } catch (error) {
            console.error('Unsubscribeè¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        }
    }

    // Unsubscribeè¨­å®šã‚’ä¿å­˜
    function saveUnsubscribeSettings() {
        try {
            localStorage.setItem('newsletter-unsubscribe', JSON.stringify(unsubscribeSettings));
        } catch (error) {
            console.error('Unsubscribeè¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        }
    }

    // é…ä¿¡åœæ­¢ãƒªã‚¹ãƒˆã®ç®¡ç†
    function getUnsubscribedUsers() {
        try {
            return JSON.parse(localStorage.getItem('newsletter-unsubscribed') || '[]');
        } catch (error) {
            console.error('é…ä¿¡åœæ­¢ãƒªã‚¹ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            return [];
        }
    }

    function addUnsubscribedUser(email, reason = 'manual', timestamp = null) {
        try {
            const unsubscribed = getUnsubscribedUsers();
            const existing = unsubscribed.find(user => user.email === email);
            
            if (existing) {
                return false; // æ—¢ã«é…ä¿¡åœæ­¢æ¸ˆã¿
            }
            
            unsubscribed.push({
                email: email,
                reason: reason,
                timestamp: timestamp || new Date().toISOString(),
                ip: document.getElementById('currentIp')?.textContent || 'unknown'
            });
            
            localStorage.setItem('newsletter-unsubscribed', JSON.stringify(unsubscribed));
            return true;
        } catch (error) {
            console.error('é…ä¿¡åœæ­¢è¿½åŠ ã‚¨ãƒ©ãƒ¼:', error);
            return false;
        }
    }

    function removeUnsubscribedUser(email) {
        try {
            const unsubscribed = getUnsubscribedUsers();
            const filtered = unsubscribed.filter(user => user.email !== email);
            localStorage.setItem('newsletter-unsubscribed', JSON.stringify(filtered));
            return true;
        } catch (error) {
            console.error('é…ä¿¡åœæ­¢å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
            return false;
        }
    }

    // é…ä¿¡åœæ­¢çµ±è¨ˆã‚’æ›´æ–°
    function updateUnsubscribeStats() {
        const unsubscribed = getUnsubscribedUsers();
        const now = new Date();
        const thisMonth = new Date(now.getFullYear(), now.getMonth(), 1);
        
        const monthlyCount = unsubscribed.filter(user => {
            const unsubDate = new Date(user.timestamp);
            return unsubDate >= thisMonth;
        }).length;
        
        document.getElementById('totalUnsubscribed').textContent = unsubscribed.length;
        document.getElementById('monthlyUnsubscribed').textContent = monthlyCount;
    }

    // é…ä¿¡åœæ­¢ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
    function showUnsubscribedUsers() {
        const listArea = document.getElementById('unsubscribeListArea');
        const unsubscribed = getUnsubscribedUsers();
        
        if (unsubscribed.length === 0) {
            listArea.innerHTML = '<div style="color: #6b7280; text-align: center;">ğŸ“„ é…ä¿¡åœæ­¢ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã„ã¾ã›ã‚“</div>';
            return;
        }
        
        let html = '';
        unsubscribed.forEach((user, index) => {
            const date = new Date(user.timestamp).toLocaleString('ja-JP');
            const reasonText = {
                'manual': 'æ‰‹å‹•è¿½åŠ ',
                'user_request': 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆ',
                'bounce': 'é…ä¿¡ã‚¨ãƒ©ãƒ¼',
                'complaint': 'è‹¦æƒ…'
            }[user.reason] || user.reason;
            
            html += `
                <div style="padding: 10px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-weight: 600; color: #374151;">${user.email}</div>
                        <div style="font-size: 0.9rem; color: #6b7280;">
                            ç†ç”±: ${reasonText} | æ—¥æ™‚: ${date} | IP: ${user.ip}
                        </div>
                    </div>
                    <button onclick="removeUnsubscribeUser('${user.email}')" class="btn btn-success" style="padding: 5px 10px; font-size: 0.8rem;">
                        âœ… å†è³¼èª­
                    </button>
                </div>
            `;
        });
        
        listArea.innerHTML = html;
    }

    // Unsubscribeãƒªãƒ³ã‚¯ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
    function updateUnsubscribePreview() {
        const linkText = unsubscribeSettings.unsubscribeLinkText;
        const preview = document.getElementById('unsubscribePreview');
        
        if (unsubscribeSettings.autoUnsubscribeLink) {
            preview.innerHTML = `
                <div style="text-align: center; margin-top: 20px; padding: 10px; border-top: 1px solid #e5e7eb; font-size: 12px; color: #6b7280;">
                    <a href="#" style="color: #3b82f6; text-decoration: underline;">${linkText}</a><br>
                    NANKANã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ | ã€’100-0001 æ±äº¬éƒ½åƒä»£ç”°åŒº
                </div>
            `;
        } else {
            preview.innerHTML = '<div style="color: #9ca3af; text-align: center; font-style: italic;">Unsubscribeãƒªãƒ³ã‚¯ã¯è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“</div>';
        }
    }

    // ãƒ¡ãƒ¼ãƒ«é€ä¿¡æ™‚ã«Unsubscribeãƒªãƒ³ã‚¯ã‚’è‡ªå‹•è¿½åŠ 
    function addUnsubscribeFooter(htmlContent) {
        if (!unsubscribeSettings.autoUnsubscribeLink) {
            return htmlContent;
        }
        
        const unsubscribeFooter = `
            <div style="text-align: center; margin-top: 30px; padding: 20px; border-top: 2px solid #e5e7eb; background: #f9fafb;">
                <div style="font-size: 12px; color: #6b7280; line-height: 1.5;">
                    <p style="margin: 0 0 10px 0;">
                        <a href="{{unsubscribe_url}}" style="color: #3b82f6; text-decoration: underline;">${unsubscribeSettings.unsubscribeLinkText}</a>
                    </p>
                    <p style="margin: 0; font-size: 11px;">
                        NANKANã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹<br>
                        ã€’100-0001 æ±äº¬éƒ½åƒä»£ç”°åŒº<br>
                        ã“ã®ãƒ¡ãƒ¼ãƒ«ã«å¿ƒå½“ãŸã‚ŠãŒãªã„å ´åˆã¯ã€ãŠæ‰‹æ•°ã§ã™ãŒä¸Šè¨˜ãƒªãƒ³ã‚¯ã‹ã‚‰é…ä¿¡åœæ­¢ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚
                    </p>
                </div>
            </div>
        `;
        
        // </body>ã‚¿ã‚°ã®ç›´å‰ã«æŒ¿å…¥
        if (htmlContent.includes('</body>')) {
            return htmlContent.replace('</body>', unsubscribeFooter + '</body>');
        } else {
            return htmlContent + unsubscribeFooter;
        }
    }

    // Unsubscribeè¨­å®šã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    document.getElementById('autoUnsubscribeLink')?.addEventListener('change', (e) => {
        unsubscribeSettings.autoUnsubscribeLink = e.target.checked;
        saveUnsubscribeSettings();
        updateUnsubscribePreview();
    });

    document.getElementById('unsubscribeLinkText')?.addEventListener('input', (e) => {
        unsubscribeSettings.unsubscribeLinkText = e.target.value;
        saveUnsubscribeSettings();
        updateUnsubscribePreview();
    });

    document.getElementById('allowSelfResubscribe')?.addEventListener('change', (e) => {
        unsubscribeSettings.allowSelfResubscribe = e.target.checked;
        saveUnsubscribeSettings();
    });

    // é…ä¿¡åœæ­¢ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡¨ç¤º
    document.getElementById('showUnsubscribedBtn')?.addEventListener('click', () => {
        showUnsubscribedUsers();
        updateUnsubscribeStats();
    });

    // æ‰‹å‹•é…ä¿¡åœæ­¢è¿½åŠ 
    document.getElementById('addUnsubscribeBtn')?.addEventListener('click', () => {
        const email = prompt('é…ä¿¡åœæ­¢ã™ã‚‹ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
        if (email && email.includes('@')) {
            if (addUnsubscribedUser(email, 'manual')) {
                alert('é…ä¿¡åœæ­¢ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸ');
                showUnsubscribedUsers();
                updateUnsubscribeStats();
            } else {
                alert('æ—¢ã«é…ä¿¡åœæ­¢æ¸ˆã¿ã‹ã€è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        } else if (email) {
            alert('æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        }
    });

    // é…ä¿¡åœæ­¢ãƒªã‚¹ãƒˆå‡ºåŠ›
    document.getElementById('exportUnsubscribeBtn')?.addEventListener('click', () => {
        try {
            const unsubscribed = getUnsubscribedUsers();
            if (unsubscribed.length === 0) {
                alert('é…ä¿¡åœæ­¢ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ã¾ã›ã‚“');
                return;
            }
            
            const csv = 'Email,Reason,Timestamp,IP\n' + 
                       unsubscribed.map(user => `"${user.email}","${user.reason}","${user.timestamp}","${user.ip}"`).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `unsubscribed-users-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
        } catch (error) {
            alert('ãƒªã‚¹ãƒˆå‡ºåŠ›ã«å¤±æ•—ã—ã¾ã—ãŸ');
            console.error('é…ä¿¡åœæ­¢ãƒªã‚¹ãƒˆå‡ºåŠ›ã‚¨ãƒ©ãƒ¼:', error);
        }
    });

    // é…ä¿¡åœæ­¢ãƒªã‚¹ãƒˆã‚¯ãƒªã‚¢
    document.getElementById('clearUnsubscribeBtn')?.addEventListener('click', () => {
        if (confirm('é…ä¿¡åœæ­¢ãƒªã‚¹ãƒˆã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) {
            localStorage.removeItem('newsletter-unsubscribed');
            showUnsubscribedUsers();
            updateUnsubscribeStats();
            alert('é…ä¿¡åœæ­¢ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
        }
    });

    // å†è³¼èª­å‡¦ç†
    document.getElementById('resubscribeBtn')?.addEventListener('click', () => {
        const email = document.getElementById('resubscribeEmail').value;
        if (email && email.includes('@')) {
            if (removeUnsubscribedUser(email)) {
                alert('å†è³¼èª­ã‚’è¨±å¯ã—ã¾ã—ãŸ');
                document.getElementById('resubscribeEmail').value = '';
                showUnsubscribedUsers();
                updateUnsubscribeStats();
            } else {
                alert('è©²å½“ã™ã‚‹ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‹ã€å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        } else {
            alert('æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        }
    });

    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼æ©Ÿèƒ½é–¢é€£
    let sendProgress = {
        isActive: false,
        isCancelled: false,
        currentStep: 0,
        totalRecipients: 0,
        sentCount: 0,
        failedCount: 0,
        startTime: null,
        steps: [
            { id: 'step1', label: 'ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ä¸­...', icon: 'ğŸ”' },
            { id: 'step2', label: 'å—ä¿¡è€…ãƒªã‚¹ãƒˆæº–å‚™ä¸­...', icon: 'ğŸ“‹' },
            { id: 'step3', label: 'ãƒ¡ãƒ¼ãƒ«é€ä¿¡ä¸­...', icon: 'ğŸ“§' },
            { id: 'step4', label: 'çµæœç¢ºèªä¸­...', icon: 'âœ…' }
        ]
    };

    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’è¡¨ç¤º
    function showProgressBar(totalRecipients) {
        sendProgress.isActive = true;
        sendProgress.isCancelled = false;
        sendProgress.currentStep = 0;
        sendProgress.totalRecipients = totalRecipients;
        sendProgress.sentCount = 0;
        sendProgress.failedCount = 0;
        sendProgress.startTime = new Date();

        const progressArea = document.getElementById('sendProgressArea');
        progressArea.style.display = 'block';

        // é€ä¿¡ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
        const sendBtn = document.getElementById('sendBtn');
        sendBtn.disabled = true;
        sendBtn.textContent = 'é…ä¿¡ä¸­...';

        // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³è¡¨ç¤º
        document.getElementById('cancelSendBtn').style.display = 'inline-block';
        document.getElementById('hideProgressBtn').style.display = 'none';

        // åˆæœŸçµ±è¨ˆè¨­å®š
        updateProgressStats();

        // æœ€åˆã®ã‚¹ãƒ†ãƒƒãƒ—é–‹å§‹
        setProgressStep(0);

        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦è¡¨ç¤º
        progressArea.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¨­å®š
    function setProgressStep(stepIndex) {
        if (stepIndex >= sendProgress.steps.length) return;

        sendProgress.currentStep = stepIndex;
        const step = sendProgress.steps[stepIndex];

        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒ©ãƒ™ãƒ«æ›´æ–°
        document.getElementById('progressLabel').textContent = step.icon + ' ' + step.label;

        // ã‚¹ãƒ†ãƒƒãƒ—çŠ¶æ…‹æ›´æ–°
        sendProgress.steps.forEach((s, index) => {
            const stepElement = document.getElementById(s.id);
            stepElement.className = 'progress-step';

            if (index < stepIndex) {
                stepElement.className += ' completed';
                stepElement.textContent = 'âœ… ' + s.label.replace('ä¸­...', 'å®Œäº†');
            } else if (index === stepIndex) {
                stepElement.className += ' active';
                stepElement.textContent = s.icon + ' ' + s.label;
            } else {
                stepElement.textContent = 'â³ ' + s.label;
            }
        });

        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼æ›´æ–°
        const baseProgress = (stepIndex / sendProgress.steps.length) * 100;
        updateProgressBar(baseProgress);
    }

    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’æ›´æ–°
    function updateProgressBar(percentage) {
        const progressBar = document.getElementById('progressBar');
        const progressPercentage = document.getElementById('progressPercentage');

        progressBar.style.width = Math.min(100, Math.max(0, percentage)) + '%';
        progressPercentage.textContent = Math.round(percentage) + '%';
    }

    // é€ä¿¡çµ±è¨ˆã‚’æ›´æ–°
    function updateProgressStats() {
        document.getElementById('sentCount').textContent = sendProgress.sentCount;
        document.getElementById('failedCount').textContent = sendProgress.failedCount;
        document.getElementById('remainingCount').textContent = 
            Math.max(0, sendProgress.totalRecipients - sendProgress.sentCount - sendProgress.failedCount);

        // äºˆæƒ³æ™‚é–“è¨ˆç®—
        if (sendProgress.sentCount > 0 && sendProgress.startTime) {
            const elapsedTime = (new Date() - sendProgress.startTime) / 1000; // ç§’
            const avgTimePerEmail = elapsedTime / sendProgress.sentCount;
            const remainingEmails = sendProgress.totalRecipients - sendProgress.sentCount - sendProgress.failedCount;
            const estimatedSeconds = avgTimePerEmail * remainingEmails;

            if (remainingEmails > 0) {
                const minutes = Math.floor(estimatedSeconds / 60);
                const seconds = Math.floor(estimatedSeconds % 60);
                document.getElementById('estimatedTime').textContent = 
                    minutes > 0 ? `${minutes}m ${seconds}s` : `${seconds}s`;
            } else {
                document.getElementById('estimatedTime').textContent = 'å®Œäº†';
            }
        }
    }

    // é€ä¿¡é€²æ—ã‚’æ›´æ–°
    function updateSendProgress(sent, failed) {
        sendProgress.sentCount = sent;
        sendProgress.failedCount = failed;

        const totalProcessed = sent + failed;
        const stepProgress = sendProgress.currentStep === 2 ? 
            50 + (totalProcessed / sendProgress.totalRecipients) * 50 : 
            (sendProgress.currentStep / sendProgress.steps.length) * 100;

        updateProgressBar(stepProgress);
        updateProgressStats();
    }

    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹å®Œäº†
    function completeProgress(success = true, finalMessage = '') {
        sendProgress.isActive = false;

        if (success) {
            setProgressStep(sendProgress.steps.length);
            updateProgressBar(100);
            
            document.getElementById('progressLabel').textContent = 'âœ… é…ä¿¡å®Œäº†ï¼';
            
            if (finalMessage) {
                const progressArea = document.getElementById('sendProgressArea');
                const messageDiv = document.createElement('div');
                messageDiv.style.cssText = 'margin-top: 15px; padding: 15px; background: #ecfdf5; border: 1px solid #a7f3d0; border-radius: 8px; color: #047857; font-weight: 600;';
                messageDiv.innerHTML = 'ğŸ‰ ' + finalMessage;
                progressArea.appendChild(messageDiv);
            }
        } else {
            document.getElementById('progressLabel').textContent = 'âŒ é…ä¿¡ä¸­æ–­';
            document.getElementById('progressBar').style.background = '#dc2626';
        }

        // ãƒœã‚¿ãƒ³çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
        const sendBtn = document.getElementById('sendBtn');
        sendBtn.disabled = false;
        sendBtn.textContent = 'é…ä¿¡å®Ÿè¡Œ';

        document.getElementById('cancelSendBtn').style.display = 'none';
        document.getElementById('hideProgressBtn').style.display = 'inline-block';

        // æœ€çµ‚çµ±è¨ˆæ›´æ–°
        updateProgressStats();
    }

    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’éè¡¨ç¤º
    function hideProgressBar() {
        document.getElementById('sendProgressArea').style.display = 'none';
        sendProgress.isActive = false;
    }

    // é€ä¿¡ã‚­ãƒ£ãƒ³ã‚»ãƒ«
    function cancelSending() {
        if (confirm('é…ä¿¡ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ\næ—¢ã«é€ä¿¡ã•ã‚ŒãŸãƒ¡ãƒ¼ãƒ«ã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
            sendProgress.isCancelled = true;
            completeProgress(false);
            
            // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°è¨˜éŒ²
            logSecurityEvent('SEND_CANCELLED', 'é…ä¿¡ãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã£ã¦ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ', 'warning');
            
            alert('é…ä¿¡ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
        }
    }

    // é«˜åº¦ãªã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ©Ÿèƒ½é–¢é€£
    let scheduleSettings = {
        type: 'immediate',
        scheduledDateTime: null,
        timezone: 'Asia/Tokyo',
        recurring: {
            frequency: 'daily',
            time: '09:00',
            startDate: null,
            endDate: null,
            weekdays: []
        }
    };

    // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¿ã‚¤ãƒ—å¤‰æ›´
    function updateScheduleType() {
        const immediate = document.getElementById('scheduleImmediate');
        const scheduled = document.getElementById('scheduleReserved');
        const recurring = document.getElementById('scheduleRecurring');
        
        const scheduledSection = document.getElementById('scheduledSection');
        const recurringSection = document.getElementById('recurringSection');
        const scheduleStatus = document.getElementById('scheduleStatus');
        
        if (immediate?.checked) {
            scheduleSettings.type = 'immediate';
            scheduledSection.style.display = 'none';
            recurringSection.style.display = 'none';
            scheduleStatus.innerHTML = 'ğŸš€ å³æ™‚é…ä¿¡';
            scheduleStatus.style.background = '#ecfdf5';
            scheduleStatus.style.color = '#047857';
        } else if (scheduled?.checked) {
            scheduleSettings.type = 'scheduled';
            scheduledSection.style.display = 'block';
            recurringSection.style.display = 'none';
            scheduleStatus.innerHTML = 'ğŸ“… äºˆç´„é…ä¿¡';
            scheduleStatus.style.background = '#eff6ff';
            scheduleStatus.style.color = '#1d4ed8';
            updateScheduleDateTime();
        } else if (recurring?.checked) {
            scheduleSettings.type = 'recurring';
            scheduledSection.style.display = 'none';
            recurringSection.style.display = 'block';
            scheduleStatus.innerHTML = 'ğŸ”„ å®šæœŸé…ä¿¡';
            scheduleStatus.style.background = '#f3f4f6';
            scheduleStatus.style.color = '#7c2d12';
            updateRecurringPreview();
        }
    }

    // æ—¥æ™‚ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé–¢æ•°
    function formatDateTime(date, timezone = 'Asia/Tokyo') {
        return date.toLocaleString('ja-JP', {
            timeZone: timezone,
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    // ã‚¯ã‚¤ãƒƒã‚¯è¨­å®šæ©Ÿèƒ½
    function setupQuickSchedule() {
        // ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã«ç¾åœ¨æ™‚åˆ»ã‚’å–å¾—ã™ã‚‹ã‚ˆã†ã«ä¿®æ­£
        
        document.getElementById('schedule1Hour')?.addEventListener('click', () => {
            const now = new Date(); // ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ç¾åœ¨æ™‚åˆ»ã‚’å–å¾—
            const oneHourLater = new Date(now.getTime() + 60 * 60 * 1000);
            setScheduleDateTime(oneHourLater);
            console.log('1æ™‚é–“å¾Œè¨­å®š:', oneHourLater.toLocaleString('ja-JP'));
        });
        
        document.getElementById('schedule3Hours')?.addEventListener('click', () => {
            const now = new Date(); // ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ç¾åœ¨æ™‚åˆ»ã‚’å–å¾—
            const threeHoursLater = new Date(now.getTime() + 3 * 60 * 60 * 1000);
            setScheduleDateTime(threeHoursLater);
            console.log('3æ™‚é–“å¾Œè¨­å®š:', threeHoursLater.toLocaleString('ja-JP'));
        });
        
        document.getElementById('scheduleTomorrow9AM')?.addEventListener('click', () => {
            const now = new Date(); // ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ç¾åœ¨æ™‚åˆ»ã‚’å–å¾—
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(9, 0, 0, 0);
            
            // 72æ™‚é–“ä»¥å†…ãƒã‚§ãƒƒã‚¯
            const hoursDiff = (tomorrow - now) / (1000 * 60 * 60);
            if (hoursDiff <= 72) {
                setScheduleDateTime(tomorrow);
                console.log('æ˜æ—¥9æ™‚è¨­å®š:', tomorrow.toLocaleString('ja-JP'));
            } else {
                alert('âš ï¸ æ˜æ—¥9æ™‚ã¯72æ™‚é–“ã‚’è¶…ãˆã‚‹ãŸã‚ã€é…ä¿¡ã•ã‚Œãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚\n72æ™‚é–“ä»¥å†…ã®æ™‚é–“ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
            }
        });
        
        document.getElementById('scheduleMonday9AM')?.addEventListener('click', () => {
            const now = new Date(); // ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ç¾åœ¨æ™‚åˆ»ã‚’å–å¾—
            const nextMonday = new Date(now);
            const daysUntilMonday = (1 + 7 - now.getDay()) % 7 || 7;
            nextMonday.setDate(now.getDate() + daysUntilMonday);
            nextMonday.setHours(9, 0, 0, 0);
            
            // 72æ™‚é–“ä»¥å†…ãƒã‚§ãƒƒã‚¯
            const hoursDiff = (nextMonday - now) / (1000 * 60 * 60);
            if (hoursDiff <= 72) {
                setScheduleDateTime(nextMonday);
                console.log('æ¥é€±æœˆæ›œ9æ™‚è¨­å®š:', nextMonday.toLocaleString('ja-JP'));
            } else {
                alert(`âš ï¸ æ¥é€±æœˆæ›œæ—¥ã¯${Math.round(hoursDiff)}æ™‚é–“å¾Œã§72æ™‚é–“ã‚’è¶…ãˆã‚‹ãŸã‚ã€é…ä¿¡ã•ã‚Œãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚\n72æ™‚é–“ä»¥å†…ï¼ˆ3æ—¥ä»¥å†…ï¼‰ã®æ™‚é–“ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚`);
            }
        });
    }

    // æ—¥æ™‚è¨­å®šï¼ˆãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“ã§æ­£ã—ãè¨­å®šï¼‰
    function setScheduleDateTime(date) {
        // toISOString()ã¯UTCãªã®ã§ã€ãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“ã«å¤‰æ›
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        
        const datetimeLocal = `${year}-${month}-${day}T${hours}:${minutes}`;
        document.getElementById('scheduledAt').value = datetimeLocal;
        
        console.log('è¨­å®šã™ã‚‹æ—¥æ™‚:', date.toLocaleString('ja-JP'));
        console.log('inputå€¤:', datetimeLocal);
        
        updateScheduleDateTime();
    }

    // äºˆç´„é…ä¿¡ã®æ—¥æ™‚è¡¨ç¤ºæ›´æ–°
    function updateScheduleDateTime() {
        const scheduledAt = document.getElementById('scheduledAt').value;
        const scheduleStatus = document.getElementById('scheduleStatus');
        const scheduleWarning = document.getElementById('scheduleWarning');
        const scheduleValid = document.getElementById('scheduleValid');
        
        // è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤º
        if (scheduleWarning) scheduleWarning.style.display = 'none';
        if (scheduleValid) scheduleValid.style.display = 'none';
        
        if (scheduledAt) {
            const selectedDate = new Date(scheduledAt);
            const now = new Date();
            const timezone = document.getElementById('scheduleTimezone').value;
            const hoursDiff = (selectedDate - now) / (1000 * 60 * 60); // æ™‚é–“å·®
            
            if (selectedDate > now) {
                // 72æ™‚é–“åˆ¶é™ãƒã‚§ãƒƒã‚¯
                if (hoursDiff > 72) {
                    scheduleStatus.innerHTML = `âš ï¸ ${formatDateTime(selectedDate, timezone)} - é…ä¿¡å¤±æ•—ãƒªã‚¹ã‚¯é«˜`;
                    scheduleStatus.style.background = '#fef2f2';
                    scheduleStatus.style.color = '#dc2626';
                    if (scheduleWarning) {
                        scheduleWarning.style.display = 'block';
                        scheduleWarning.innerHTML = `âš ï¸ ${Math.round(hoursDiff)}æ™‚é–“å¾Œã®äºˆç´„ã§ã™ã€‚72æ™‚é–“ã‚’è¶…ãˆã‚‹ã¨é…ä¿¡ã•ã‚Œãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚`;
                    }
                } else {
                    scheduleStatus.innerHTML = `ğŸ“… ${formatDateTime(selectedDate, timezone)} é…ä¿¡äºˆå®š`;
                    scheduleStatus.style.background = '#f0fdf4';
                    scheduleStatus.style.color = '#16a34a';
                    if (scheduleValid) {
                        scheduleValid.style.display = 'block';
                        scheduleValid.innerHTML = `âœ… ${Math.round(hoursDiff)}æ™‚é–“å¾Œã®é…ä¿¡ - æ­£å¸¸ã«å‹•ä½œã—ã¾ã™`;
                    }
                }
            } else {
                scheduleStatus.innerHTML = 'âš ï¸ éå»ã®æ—¥æ™‚ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã™';
                scheduleStatus.style.background = '#fef2f2';
                scheduleStatus.style.color = '#dc2626';
            }
        } else {
            scheduleStatus.innerHTML = 'ğŸ“… äºˆç´„é…ä¿¡ - æ—¥æ™‚ã‚’é¸æŠã—ã¦ãã ã•ã„';
            scheduleStatus.style.background = '#fefce8';
            scheduleStatus.style.color = '#a16207';
        }
    }

    // å®šæœŸé…ä¿¡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
    function updateRecurringPreview() {
        const frequency = document.getElementById('recurringFrequency')?.value;
        const time = document.getElementById('recurringTime')?.value;
        const startDate = document.getElementById('recurringStartDate')?.value;
        const endDate = document.getElementById('recurringEndDate')?.value;
        const previewText = document.getElementById('recurringPreviewText');
        
        if (!previewText) return;
        
        let preview = '';
        
        if (frequency === 'daily') {
            preview = `æ¯æ—¥ ${time} ã«é…ä¿¡`;
        } else if (frequency === 'weekly') {
            const selectedWeekdays = [];
            ['recurMon', 'recurTue', 'recurWed', 'recurThu', 'recurFri', 'recurSat', 'recurSun'].forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox?.checked) {
                    const dayNames = { recurMon: 'æœˆ', recurTue: 'ç«', recurWed: 'æ°´', recurThu: 'æœ¨', recurFri: 'é‡‘', recurSat: 'åœŸ', recurSun: 'æ—¥' };
                    selectedWeekdays.push(dayNames[id]);
                }
            });
            
            if (selectedWeekdays.length > 0) {
                preview = `æ¯é€± ${selectedWeekdays.join('ãƒ»')}æ›œæ—¥ ${time} ã«é…ä¿¡`;
            } else {
                preview = `æ¯é€± ${time} ã«é…ä¿¡ (æ›œæ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„)`;
            }
        } else if (frequency === 'monthly') {
            preview = `æ¯æœˆ1æ—¥ ${time} ã«é…ä¿¡`;
        }
        
        if (startDate) {
            preview += `<br>é–‹å§‹: ${new Date(startDate).toLocaleDateString('ja-JP')}`;
        }
        if (endDate) {
            preview += ` | çµ‚äº†: ${new Date(endDate).toLocaleDateString('ja-JP')}`;
        }
        
        previewText.innerHTML = preview || 'è¨­å®šã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
    }

    // å®šæœŸé…ä¿¡ã®é »åº¦å¤‰æ›´æ™‚ã®å‡¦ç†
    function updateRecurringFrequency() {
        const frequency = document.getElementById('recurringFrequency')?.value;
        const weeklySchedule = document.getElementById('weeklySchedule');
        
        if (frequency === 'weekly') {
            weeklySchedule.style.display = 'block';
        } else {
            weeklySchedule.style.display = 'none';
        }
        
        updateRecurringPreview();
    }

    // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«é–¢é€£ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    document.getElementById('scheduleImmediate')?.addEventListener('change', updateScheduleType);
    document.getElementById('scheduleReserved')?.addEventListener('change', updateScheduleType);
    document.getElementById('scheduleRecurring')?.addEventListener('change', updateScheduleType);
    
    document.getElementById('scheduledAt')?.addEventListener('change', updateScheduleDateTime);
    document.getElementById('scheduleTimezone')?.addEventListener('change', updateScheduleDateTime);
    
    document.getElementById('recurringFrequency')?.addEventListener('change', updateRecurringFrequency);
    document.getElementById('recurringTime')?.addEventListener('change', updateRecurringPreview);
    document.getElementById('recurringStartDate')?.addEventListener('change', updateRecurringPreview);
    document.getElementById('recurringEndDate')?.addEventListener('change', updateRecurringPreview);
    
    // é€±é–“ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
    ['recurMon', 'recurTue', 'recurWed', 'recurThu', 'recurFri', 'recurSat', 'recurSun'].forEach(id => {
        document.getElementById(id)?.addEventListener('change', updateRecurringPreview);
    });

    // å®šæœŸé…ä¿¡ã®åˆæœŸè¨­å®š
    function initializeRecurringSettings() {
        const today = new Date();
        const tomorrow = new Date(today);
        tomorrow.setDate(today.getDate() + 1);
        
        document.getElementById('recurringStartDate').value = tomorrow.toISOString().split('T')[0];
        updateRecurringFrequency();
    }

    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é…ä¿¡ãƒ¢ãƒ‹ã‚¿æ©Ÿèƒ½
    let realtimeMonitor = {
        isActive: true,
        autoRefresh: true,
        updateInterval: null,
        logs: [],
        maxLogs: 100,
        stats: {
            sentToday: 0,
            successRate: 100,
            activeUsers: 0,
            queueSize: 0
        }
    };

    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ­ã‚°ã«è¿½åŠ 
    function addRealtimeLog(message, type = 'info', data = null) {
        const now = new Date();
        const timestamp = now.toLocaleTimeString('ja-JP');
        
        const logEntry = {
            timestamp: timestamp,
            message: message,
            type: type,
            data: data,
            id: Date.now()
        };
        
        realtimeMonitor.logs.unshift(logEntry);
        
        // ãƒ­ã‚°æ•°åˆ¶é™
        if (realtimeMonitor.logs.length > realtimeMonitor.maxLogs) {
            realtimeMonitor.logs.pop();
        }
        
        updateRealtimeLogDisplay();
    }

    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ­ã‚°è¡¨ç¤ºã‚’æ›´æ–°
    function updateRealtimeLogDisplay() {
        const logArea = document.getElementById('realtimeLogArea');
        if (!logArea) return;
        
        let html = '';
        realtimeMonitor.logs.forEach(log => {
            const color = {
                'info': '#64748b',
                'success': '#10b981',
                'warning': '#f59e0b',
                'error': '#ef4444'
            }[log.type] || '#64748b';
            
            const icon = {
                'info': 'ğŸ“‹',
                'success': 'âœ…',
                'warning': 'âš ï¸',
                'error': 'âŒ'
            }[log.type] || 'ğŸ“‹';
            
            html += `<div style="color: ${color};">[${log.timestamp}] ${icon} ${log.message}</div>`;
        });
        
        // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚‹å ´åˆã¯ä¿æŒ
        if (html === '') {
            html = `
                <div style="color: #64748b;">ğŸ“Š ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ­ã‚°ã‚’ç›£è¦–ä¸­...</div>
                <div style="color: #10b981;">âœ… ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†</div>
                <div style="color: #64748b;">[${new Date().toLocaleTimeString('ja-JP')}] ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°é–‹å§‹</div>
            `;
        }
        
        logArea.innerHTML = html;
        
        // è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        logArea.scrollTop = 0;
    }

    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ çµ±è¨ˆã‚’æ›´æ–°
    function updateRealtimeStats() {
        try {
            const history = JSON.parse(localStorage.getItem('newsletter-history') || '[]');
            const today = new Date();
            const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            
            // ä»Šæ—¥ã®é…ä¿¡çµ±è¨ˆ
            let todaySent = 0;
            let todayFailed = 0;
            
            history.forEach(item => {
                const itemDate = new Date(item.createdAt || item.scheduledAt);
                if (itemDate >= todayStart) {
                    todaySent += item.recipientCount || 0;
                    todayFailed += item.failedCount || 0;
                }
            });
            
            // æˆåŠŸç‡è¨ˆç®—
            const successRate = todaySent + todayFailed > 0 ? 
                ((todaySent / (todaySent + todayFailed)) * 100).toFixed(1) : '100';
            
            // UIæ›´æ–°
            document.getElementById('realtimeSentToday').textContent = todaySent;
            document.getElementById('realtimeSuccessRate').textContent = successRate + '%';
            document.getElementById('realtimeActiveUsers').textContent = Math.floor(Math.random() * 50) + 10; // ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
            document.getElementById('realtimeQueueSize').textContent = sendProgress.isActive ? 
                Math.max(0, sendProgress.totalRecipients - sendProgress.sentCount - sendProgress.failedCount) : 0;
            
            // æœ€çµ‚æ›´æ–°æ™‚åˆ»
            document.getElementById('realtimeLastUpdate').textContent = new Date().toLocaleTimeString('ja-JP');
            
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
            const statusElement = document.getElementById('realtimeStatus');
            if (parseFloat(successRate) >= 95) {
                statusElement.innerHTML = 'ğŸŸ¢ ã‚·ã‚¹ãƒ†ãƒ æ­£å¸¸';
                statusElement.style.color = '#059669';
            } else if (parseFloat(successRate) >= 80) {
                statusElement.innerHTML = 'ğŸŸ¡ æ³¨æ„ãŒå¿…è¦';
                statusElement.style.color = '#d97706';
            } else {
                statusElement.innerHTML = 'ğŸ”´ å•é¡Œã‚ã‚Š';
                statusElement.style.color = '#dc2626';
            }
            
        } catch (error) {
            console.error('ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ çµ±è¨ˆæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
        }
    }

    // ã‚·ã‚¹ãƒ†ãƒ å¥åº·çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
    async function checkSystemHealth() {
        const emailServiceStatus = document.getElementById('emailServiceStatus');
        const emailServiceText = document.getElementById('emailServiceText');
        const emailServiceLatency = document.getElementById('emailServiceLatency');
        const emailServiceLastCheck = document.getElementById('emailServiceLastCheck');
        
        const databaseStatus = document.getElementById('databaseStatus');
        const databaseText = document.getElementById('databaseText');
        const databaseRecords = document.getElementById('databaseRecords');
        const databaseLastSync = document.getElementById('databaseLastSync');
        
        try {
            // ãƒ¡ãƒ¼ãƒ«ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ï¼ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
            const emailStartTime = Date.now();
            const emailLatency = Math.floor(Math.random() * 500) + 50; // 50-550ms
            
            setTimeout(() => {
                emailServiceLatency.textContent = emailLatency + 'ms';
                emailServiceLastCheck.textContent = new Date().toLocaleTimeString('ja-JP');
                
                if (emailLatency < 200) {
                    emailServiceStatus.style.background = '#10b981';
                    emailServiceText.textContent = 'æ­£å¸¸ç¨¼åƒ';
                    emailServiceText.style.color = '#059669';
                } else if (emailLatency < 400) {
                    emailServiceStatus.style.background = '#f59e0b';
                    emailServiceText.textContent = 'å¿œç­”é…å»¶';
                    emailServiceText.style.color = '#d97706';
                } else {
                    emailServiceStatus.style.background = '#ef4444';
                    emailServiceText.textContent = 'å¿œç­”é…å»¶';
                    emailServiceText.style.color = '#dc2626';
                }
            }, emailLatency);
            
            // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯ï¼ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
            const customers = getUnsubscribedUsers();
            databaseRecords.textContent = customers.length + ' / ' + (Math.floor(Math.random() * 1000) + 500);
            databaseLastSync.textContent = new Date().toLocaleTimeString('ja-JP');
            
            databaseStatus.style.background = '#10b981';
            databaseText.textContent = 'æ¥ç¶šæ­£å¸¸';
            databaseText.style.color = '#059669';
            
        } catch (error) {
            console.error('ã‚·ã‚¹ãƒ†ãƒ å¥åº·çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
            emailServiceStatus.style.background = '#ef4444';
            emailServiceText.textContent = 'ã‚¨ãƒ©ãƒ¼';
            emailServiceText.style.color = '#dc2626';
        }
    }

    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã®é–‹å§‹/åœæ­¢
    function toggleRealtimeUpdate() {
        const button = document.getElementById('realtimeAutoRefresh');
        
        if (realtimeMonitor.autoRefresh) {
            // åœæ­¢
            realtimeMonitor.autoRefresh = false;
            if (realtimeMonitor.updateInterval) {
                clearInterval(realtimeMonitor.updateInterval);
                realtimeMonitor.updateInterval = null;
            }
            button.innerHTML = 'â¸ï¸ è‡ªå‹•æ›´æ–° OFF';
            button.classList.remove('btn-info');
            button.classList.add('btn-secondary');
            
            addRealtimeLog('è‡ªå‹•æ›´æ–°ã‚’åœæ­¢ã—ã¾ã—ãŸ', 'warning');
        } else {
            // é–‹å§‹
            realtimeMonitor.autoRefresh = true;
            startRealtimeUpdate();
            button.innerHTML = 'ğŸ”„ è‡ªå‹•æ›´æ–° ON';
            button.classList.remove('btn-secondary');
            button.classList.add('btn-info');
            
            addRealtimeLog('è‡ªå‹•æ›´æ–°ã‚’å†é–‹ã—ã¾ã—ãŸ', 'success');
        }
    }

    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã‚’é–‹å§‹
    function startRealtimeUpdate() {
        if (realtimeMonitor.updateInterval) {
            clearInterval(realtimeMonitor.updateInterval);
        }
        
        realtimeMonitor.updateInterval = setInterval(() => {
            if (realtimeMonitor.autoRefresh) {
                updateRealtimeStats();
                checkSystemHealth();
                
                // ãƒ©ãƒ³ãƒ€ãƒ ãªãƒ­ã‚°ã‚¨ãƒ³ãƒˆãƒªï¼ˆãƒ‡ãƒ¢ç”¨ï¼‰
                if (Math.random() < 0.1) { // 10%ã®ç¢ºç‡
                    const demoMessages = [
                        'æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã‚’æ¤œå‡º',
                        'ãƒ¡ãƒ¼ãƒ«é–‹å°ã‚’ç¢ºèª',
                        'é…ä¿¡ã‚­ãƒ¥ãƒ¼ã‚’å‡¦ç†ä¸­',
                        'ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è‰¯å¥½'
                    ];
                    addRealtimeLog(demoMessages[Math.floor(Math.random() * demoMessages.length)], 'info');
                }
            }
        }, 5000); // 5ç§’é–“éš”
    }

    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ­ã‚°ã‚¯ãƒªã‚¢
    function clearRealtimeLog() {
        realtimeMonitor.logs = [];
        updateRealtimeLogDisplay();
        addRealtimeLog('ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'success');
    }

    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ©Ÿèƒ½åˆæœŸåŒ–
    function initializeRealtimeMonitor() {
        document.getElementById('initTime').textContent = new Date().toLocaleTimeString('ja-JP');
        
        updateRealtimeStats();
        checkSystemHealth();
        
        if (realtimeMonitor.autoRefresh) {
            startRealtimeUpdate();
        }
        
        // åˆæœŸãƒ­ã‚°
        addRealtimeLog('ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ¢ãƒ‹ã‚¿ã‚’é–‹å§‹ã—ã¾ã—ãŸ', 'success');
    }

    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ©Ÿèƒ½ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    document.getElementById('realtimeAutoRefresh')?.addEventListener('click', toggleRealtimeUpdate);
    document.getElementById('realtimeClearLog')?.addEventListener('click', clearRealtimeLog);

    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼é–¢é€£ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    document.getElementById('cancelSendBtn')?.addEventListener('click', cancelSending);
    document.getElementById('hideProgressBtn')?.addEventListener('click', hideProgressBar);

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ï¼ˆHTMLã‹ã‚‰å‘¼ã³å‡ºã—ç”¨ï¼‰
    window.removeUnsubscribeUser = function(email) {
        if (confirm(`${email} ã®é…ä¿¡åœæ­¢ã‚’è§£é™¤ã—ã€å†è³¼èª­ã‚’è¨±å¯ã—ã¾ã™ã‹ï¼Ÿ`)) {
            if (removeUnsubscribedUser(email)) {
                alert('å†è³¼èª­ã‚’è¨±å¯ã—ã¾ã—ãŸ');
                showUnsubscribedUsers();
                updateUnsubscribeStats();
            } else {
                alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }
    };

    // ====================
    // 6. é…ä¿¡ã‚­ãƒ¥ãƒ¼ã‚·ã‚¹ãƒ†ãƒ  JavaScriptå®Ÿè£…
    // ====================

    // ã‚­ãƒ¥ãƒ¼ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼
    const queueManager = {
        // ã‚­ãƒ¥ãƒ¼ã®çŠ¶æ…‹
        isRunning: false,
        isPaused: false,
        currentQueue: [],
        processingQueue: [],
        completedQueue: [],
        failedQueue: [],
        
        // è¨­å®š
        config: {
            maxConcurrent: 3,
            batchSize: 50,
            retryCount: 3,
            retryDelay: 5000,
            processDelay: 1000,
            priority: 'normal' // high, normal, low
        },

        // çµ±è¨ˆ
        stats: {
            totalProcessed: 0,
            totalSuccess: 0,
            totalFailed: 0,
            startTime: null,
            lastProcessedTime: null,
            averageProcessingTime: 0,
            throughput: 0
        },

        // ã‚­ãƒ¥ãƒ¼ã«ã‚¸ãƒ§ãƒ–ã‚’è¿½åŠ 
        addJob(job) {
            const queueJob = {
                id: `job-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                type: job.type || 'email',
                priority: job.priority || this.config.priority,
                data: job.data,
                recipients: job.recipients || [],
                createdAt: new Date().toISOString(),
                status: 'pending',
                attempts: 0,
                maxAttempts: job.maxAttempts || this.config.retryCount,
                estimatedProcessingTime: this.estimateProcessingTime(job),
                progress: 0
            };

            // å„ªå…ˆåº¦ã«åŸºã¥ã„ã¦ã‚½ãƒ¼ãƒˆæŒ¿å…¥
            this.insertByPriority(queueJob);
            this.updateQueueDisplay();
            this.updateStats();
            
            console.log(`âœ… ã‚­ãƒ¥ãƒ¼ã«ã‚¸ãƒ§ãƒ–ã‚’è¿½åŠ : ${queueJob.id} (${queueJob.type})`);
            this.logActivity(`æ–°ã—ã„ã‚¸ãƒ§ãƒ–ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸ: ${queueJob.type}`, 'info');
            
            return queueJob.id;
        },

        // å„ªå…ˆåº¦ã«åŸºã¥ã„ã¦ã‚­ãƒ¥ãƒ¼ã«æŒ¿å…¥
        insertByPriority(job) {
            const priorityOrder = { high: 0, normal: 1, low: 2 };
            const jobPriority = priorityOrder[job.priority] || 1;
            
            let insertIndex = this.currentQueue.length;
            for (let i = 0; i < this.currentQueue.length; i++) {
                const existingPriority = priorityOrder[this.currentQueue[i].priority] || 1;
                if (jobPriority < existingPriority) {
                    insertIndex = i;
                    break;
                }
            }
            
            this.currentQueue.splice(insertIndex, 0, job);
        },

        // å‡¦ç†æ™‚é–“ã‚’æ¨å®š
        estimateProcessingTime(job) {
            const baseTime = {
                email: 2000,
                sms: 1000,
                push: 500
            };
            
            const recipientCount = job.recipients ? job.recipients.length : 1;
            const typeTime = baseTime[job.type] || 2000;
            
            return typeTime * Math.ceil(recipientCount / this.config.batchSize);
        },

        // ã‚­ãƒ¥ãƒ¼å‡¦ç†é–‹å§‹
        async startQueue() {
            if (this.isRunning) {
                console.log('âš ï¸ ã‚­ãƒ¥ãƒ¼ã¯æ—¢ã«å®Ÿè¡Œä¸­ã§ã™');
                return;
            }

            this.isRunning = true;
            this.isPaused = false;
            this.stats.startTime = new Date().toISOString();
            
            console.log('ğŸš€ ã‚­ãƒ¥ãƒ¼å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™');
            this.logActivity('ã‚­ãƒ¥ãƒ¼å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã—ãŸ', 'success');
            
            this.updateQueueControls();
            this.processQueue();
        },

        // ã‚­ãƒ¥ãƒ¼å‡¦ç†åœæ­¢
        stopQueue() {
            this.isRunning = false;
            this.isPaused = false;
            
            console.log('â¹ï¸ ã‚­ãƒ¥ãƒ¼å‡¦ç†ã‚’åœæ­¢ã—ã¾ã—ãŸ');
            this.logActivity('ã‚­ãƒ¥ãƒ¼å‡¦ç†ã‚’åœæ­¢ã—ã¾ã—ãŸ', 'warning');
            
            this.updateQueueControls();
        },

        // ã‚­ãƒ¥ãƒ¼å‡¦ç†ä¸€æ™‚åœæ­¢
        pauseQueue() {
            this.isPaused = !this.isPaused;
            
            const status = this.isPaused ? 'ä¸€æ™‚åœæ­¢' : 'å†é–‹';
            console.log(`â¸ï¸ ã‚­ãƒ¥ãƒ¼å‡¦ç†ã‚’${status}ã—ã¾ã—ãŸ`);
            this.logActivity(`ã‚­ãƒ¥ãƒ¼å‡¦ç†ã‚’${status}ã—ã¾ã—ãŸ`, 'info');
            
            this.updateQueueControls();
            
            if (!this.isPaused && this.isRunning) {
                this.processQueue();
            }
        },

        // ãƒ¡ã‚¤ãƒ³ã®å‡¦ç†ãƒ«ãƒ¼ãƒ—
        async processQueue() {
            while (this.isRunning && this.currentQueue.length > 0) {
                if (this.isPaused) {
                    await this.delay(1000);
                    continue;
                }

                // åŒæ™‚å®Ÿè¡Œæ•°åˆ¶å¾¡
                if (this.processingQueue.length >= this.config.maxConcurrent) {
                    await this.delay(500);
                    continue;
                }

                // æ¬¡ã®ã‚¸ãƒ§ãƒ–ã‚’å–å¾—
                const job = this.currentQueue.shift();
                if (!job) break;

                // å‡¦ç†ã‚­ãƒ¥ãƒ¼ã«ç§»å‹•
                job.status = 'processing';
                job.startTime = new Date().toISOString();
                this.processingQueue.push(job);
                
                this.updateQueueDisplay();
                
                // ã‚¸ãƒ§ãƒ–ã‚’éåŒæœŸã§å‡¦ç†
                this.processJob(job).catch(error => {
                    console.error(`âŒ ã‚¸ãƒ§ãƒ–å‡¦ç†ã‚¨ãƒ©ãƒ¼: ${job.id}`, error);
                });

                // å‡¦ç†é–“éš”
                await this.delay(this.config.processDelay);
            }

            // å…¨ã‚¸ãƒ§ãƒ–å®Œäº†ãƒã‚§ãƒƒã‚¯
            if (this.isRunning && this.currentQueue.length === 0 && this.processingQueue.length === 0) {
                this.completeQueue();
            }
        },

        // å€‹åˆ¥ã‚¸ãƒ§ãƒ–å‡¦ç†
        async processJob(job) {
            try {
                console.log(`ğŸ“§ ã‚¸ãƒ§ãƒ–å‡¦ç†é–‹å§‹: ${job.id} (${job.type})`);
                this.logActivity(`ã‚¸ãƒ§ãƒ–å‡¦ç†é–‹å§‹: ${job.type} - ${job.recipients.length}ä»¶`, 'info');

                // ãƒãƒƒãƒã”ã¨ã«å‡¦ç†
                const batches = this.createBatches(job.recipients, this.config.batchSize);
                let successCount = 0;
                let failedCount = 0;

                for (let i = 0; i < batches.length; i++) {
                    const batch = batches[i];
                    const batchResult = await this.processBatch(job, batch, i + 1, batches.length);
                    
                    successCount += batchResult.success;
                    failedCount += batchResult.failed;
                    
                    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ã®æ›´æ–°
                    job.progress = Math.round(((i + 1) / batches.length) * 100);
                    this.updateJobProgress(job);
                    
                    // ãƒãƒƒãƒé–“ã®å¾…æ©Ÿ
                    if (i < batches.length - 1) {
                        await this.delay(this.config.processDelay);
                    }
                }

                // ã‚¸ãƒ§ãƒ–å®Œäº†å‡¦ç†
                job.endTime = new Date().toISOString();
                job.status = failedCount === 0 ? 'completed' : 'partial';
                job.results = {
                    total: job.recipients.length,
                    success: successCount,
                    failed: failedCount,
                    processingTime: Date.now() - new Date(job.startTime).getTime()
                };

                // çµ±è¨ˆã®æ›´æ–°
                this.stats.totalProcessed++;
                this.stats.totalSuccess += successCount;
                this.stats.totalFailed += failedCount;
                this.stats.lastProcessedTime = new Date().toISOString();
                
                this.updateAverageProcessingTime(job.results.processingTime);

                // å‡¦ç†ã‚­ãƒ¥ãƒ¼ã‹ã‚‰å®Œäº†ã‚­ãƒ¥ãƒ¼ã«ç§»å‹•
                this.moveJobToCompleted(job);

                console.log(`âœ… ã‚¸ãƒ§ãƒ–å®Œäº†: ${job.id} - æˆåŠŸ: ${successCount}, å¤±æ•—: ${failedCount}`);
                this.logActivity(`ã‚¸ãƒ§ãƒ–å®Œäº†: ${job.type} - æˆåŠŸ: ${successCount}, å¤±æ•—: ${failedCount}`, 
                               failedCount === 0 ? 'success' : 'warning');

            } catch (error) {
                console.error(`âŒ ã‚¸ãƒ§ãƒ–å‡¦ç†å¤±æ•—: ${job.id}`, error);
                
                job.attempts++;
                job.lastError = error.message;
                job.status = 'error';

                // ãƒªãƒˆãƒ©ã‚¤å‡¦ç†
                if (job.attempts < job.maxAttempts) {
                    console.log(`ğŸ”„ ã‚¸ãƒ§ãƒ–ã‚’ãƒªãƒˆãƒ©ã‚¤ã—ã¾ã™: ${job.id} (${job.attempts}/${job.maxAttempts})`);
                    this.logActivity(`ã‚¸ãƒ§ãƒ–ã‚’ãƒªãƒˆãƒ©ã‚¤ã—ã¾ã™: ${job.type} (${job.attempts}/${job.maxAttempts})`, 'warning');
                    
                    // ãƒªãƒˆãƒ©ã‚¤ç”¨ã«ã‚­ãƒ¥ãƒ¼ã«æˆ»ã™
                    setTimeout(() => {
                        job.status = 'pending';
                        this.insertByPriority(job);
                        this.removeFromProcessing(job);
                    }, this.config.retryDelay);
                } else {
                    // å¤±æ•—ã‚­ãƒ¥ãƒ¼ã«ç§»å‹•
                    job.status = 'failed';
                    this.moveJobToFailed(job);
                    this.logActivity(`ã‚¸ãƒ§ãƒ–ãŒæœ€å¤§ãƒªãƒˆãƒ©ã‚¤å›æ•°ã«é”ã—ã¾ã—ãŸ: ${job.type}`, 'error');
                }
            }
        },

        // ãƒãƒƒãƒå‡¦ç†
        async processBatch(job, recipients, batchNum, totalBatches) {
            try {
                console.log(`ğŸ“¦ ãƒãƒƒãƒå‡¦ç† ${batchNum}/${totalBatches}: ${recipients.length}ä»¶`);
                
                let successCount = 0;
                let failedCount = 0;

                // ã‚¸ãƒ§ãƒ–ã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸå‡¦ç†
                switch (job.type) {
                    case 'email':
                        const emailResult = await this.sendEmailBatch(job.data, recipients);
                        successCount = emailResult.success;
                        failedCount = emailResult.failed;
                        break;
                    
                    case 'sms':
                        const smsResult = await this.sendSMSBatch(job.data, recipients);
                        successCount = smsResult.success;
                        failedCount = smsResult.failed;
                        break;
                    
                    default:
                        // ãƒ†ã‚¹ãƒˆå‡¦ç†ï¼ˆå®Ÿéš›ã®é€ä¿¡ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆï¼‰
                        await this.delay(Math.random() * 2000 + 1000);
                        successCount = recipients.length;
                        failedCount = 0;
                }

                return { success: successCount, failed: failedCount };

            } catch (error) {
                console.error('âŒ ãƒãƒƒãƒå‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
                return { success: 0, failed: recipients.length };
            }
        },

        // ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå®Ÿè£…æ™‚ã¯å®Ÿéš›ã®APIå‘¼ã³å‡ºã—ã«ç½®ãæ›ãˆï¼‰
        async sendEmailBatch(emailData, recipients) {
            await this.delay(Math.random() * 1000 + 500);
            
            // 90%æˆåŠŸç‡ã§ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
            const successRate = 0.9;
            const successCount = Math.floor(recipients.length * successRate);
            const failedCount = recipients.length - successCount;
            
            return { success: successCount, failed: failedCount };
        },

        // SMSãƒãƒƒãƒé€ä¿¡ï¼ˆå°†æ¥ã®å®Ÿè£…ç”¨ï¼‰
        async sendSMSBatch(smsData, recipients) {
            await this.delay(Math.random() * 800 + 300);
            
            // SMSé€ä¿¡ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
            const successCount = recipients.length;
            const failedCount = 0;
            
            return { success: successCount, failed: failedCount };
        },

        // å—ä¿¡è€…ãƒªã‚¹ãƒˆã‚’ãƒãƒƒãƒã«åˆ†å‰²
        createBatches(recipients, batchSize) {
            const batches = [];
            for (let i = 0; i < recipients.length; i += batchSize) {
                batches.push(recipients.slice(i, i + batchSize));
            }
            return batches;
        },

        // ã‚¸ãƒ§ãƒ–ã‚’å®Œäº†ã‚­ãƒ¥ãƒ¼ã«ç§»å‹•
        moveJobToCompleted(job) {
            this.removeFromProcessing(job);
            this.completedQueue.unshift(job); // æœ€æ–°ã‚’å…ˆé ­ã«
            
            // å®Œäº†ã‚­ãƒ¥ãƒ¼ã®ä¸Šé™ç®¡ç†ï¼ˆæœ€æ–°100ä»¶ã¾ã§ä¿æŒï¼‰
            if (this.completedQueue.length > 100) {
                this.completedQueue = this.completedQueue.slice(0, 100);
            }
            
            this.updateQueueDisplay();
        },

        // ã‚¸ãƒ§ãƒ–ã‚’å¤±æ•—ã‚­ãƒ¥ãƒ¼ã«ç§»å‹•
        moveJobToFailed(job) {
            this.removeFromProcessing(job);
            this.failedQueue.unshift(job);
            
            // å¤±æ•—ã‚­ãƒ¥ãƒ¼ã®ä¸Šé™ç®¡ç†
            if (this.failedQueue.length > 50) {
                this.failedQueue = this.failedQueue.slice(0, 50);
            }
            
            this.updateQueueDisplay();
        },

        // å‡¦ç†ã‚­ãƒ¥ãƒ¼ã‹ã‚‰ã‚¸ãƒ§ãƒ–ã‚’å‰Šé™¤
        removeFromProcessing(job) {
            this.processingQueue = this.processingQueue.filter(j => j.id !== job.id);
        },

        // ã‚­ãƒ¥ãƒ¼å…¨ä½“å®Œäº†å‡¦ç†
        completeQueue() {
            this.isRunning = false;
            this.isPaused = false;
            
            const processingTime = this.stats.startTime ? 
                Date.now() - new Date(this.stats.startTime).getTime() : 0;
            
            console.log(`ğŸ‰ å…¨ã‚­ãƒ¥ãƒ¼å‡¦ç†å®Œäº† - å‡¦ç†æ™‚é–“: ${Math.round(processingTime / 1000)}ç§’`);
            this.logActivity(`å…¨ã‚­ãƒ¥ãƒ¼å‡¦ç†å®Œäº† - å‡¦ç†æ™‚é–“: ${Math.round(processingTime / 1000)}ç§’`, 'success');
            
            this.updateQueueControls();
            this.updateThroughput();
        },

        // ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆæ›´æ–°
        updateThroughput() {
            if (this.stats.startTime && this.stats.totalProcessed > 0) {
                const elapsedMinutes = (Date.now() - new Date(this.stats.startTime).getTime()) / (1000 * 60);
                this.stats.throughput = Math.round(this.stats.totalProcessed / elapsedMinutes);
            }
        },

        // å¹³å‡å‡¦ç†æ™‚é–“æ›´æ–°
        updateAverageProcessingTime(processingTime) {
            if (this.stats.averageProcessingTime === 0) {
                this.stats.averageProcessingTime = processingTime;
            } else {
                this.stats.averageProcessingTime = Math.round(
                    (this.stats.averageProcessingTime + processingTime) / 2
                );
            }
        },

        // ã‚¸ãƒ§ãƒ–ã®é€²æ—æ›´æ–°
        updateJobProgress(job) {
            const jobElement = document.querySelector(`[data-job-id="${job.id}"]`);
            if (jobElement) {
                const progressBar = jobElement.querySelector('.progress-bar');
                const progressText = jobElement.querySelector('.progress-text');
                
                if (progressBar) {
                    progressBar.style.width = `${job.progress}%`;
                }
                if (progressText) {
                    progressText.textContent = `${job.progress}%`;
                }
            }
        },

        // UIã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«æ›´æ–°
        updateQueueControls() {
            const startBtn = document.getElementById('startQueueBtn');
            const pauseBtn = document.getElementById('pauseQueueBtn');
            const stopBtn = document.getElementById('stopQueueBtn');
            
            if (startBtn) {
                startBtn.disabled = this.isRunning;
                startBtn.textContent = this.isRunning ? 'å®Ÿè¡Œä¸­...' : 'ã‚­ãƒ¥ãƒ¼é–‹å§‹';
            }
            
            if (pauseBtn) {
                pauseBtn.disabled = !this.isRunning;
                pauseBtn.textContent = this.isPaused ? 'å†é–‹' : 'ä¸€æ™‚åœæ­¢';
            }
            
            if (stopBtn) {
                stopBtn.disabled = !this.isRunning;
            }
        },

        // ã‚­ãƒ¥ãƒ¼è¡¨ç¤ºã®æ›´æ–°
        updateQueueDisplay() {
            this.updateQueueList('pending', this.currentQueue);
            this.updateQueueList('processing', this.processingQueue);
            this.updateQueueList('completed', this.completedQueue);
            this.updateQueueList('failed', this.failedQueue);
            this.updateStats();
        },

        // å€‹åˆ¥ã‚­ãƒ¥ãƒ¼ãƒªã‚¹ãƒˆæ›´æ–°
        updateQueueList(type, queue) {
            const container = document.getElementById(`${type}QueueList`);
            if (!container) return;

            if (queue.length === 0) {
                container.innerHTML = `<div class="queue-empty">ã‚­ãƒ¥ãƒ¼ã«ã‚¸ãƒ§ãƒ–ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
                return;
            }

            const queueHtml = queue.map(job => `
                <div class="queue-item ${job.priority}" data-job-id="${job.id}">
                    <div class="job-header">
                        <div class="job-info">
                            <span class="job-id">${job.id}</span>
                            <span class="job-type">${this.getJobTypeIcon(job.type)} ${job.type.toUpperCase()}</span>
                            <span class="job-priority priority-${job.priority}">
                                ${job.priority.toUpperCase()}
                            </span>
                        </div>
                        <div class="job-actions">
                            ${this.getJobActions(job)}
                        </div>
                    </div>
                    <div class="job-details">
                        <div class="job-recipients">
                            ğŸ“§ å—ä¿¡è€…: ${job.recipients.length}ä»¶
                        </div>
                        <div class="job-time">
                            â° ä½œæˆ: ${new Date(job.createdAt).toLocaleTimeString()}
                            ${job.startTime ? `| é–‹å§‹: ${new Date(job.startTime).toLocaleTimeString()}` : ''}
                            ${job.endTime ? `| å®Œäº†: ${new Date(job.endTime).toLocaleTimeString()}` : ''}
                        </div>
                        ${job.status === 'processing' ? `
                            <div class="job-progress">
                                <div class="progress-container">
                                    <div class="progress-bar" style="width: ${job.progress}%"></div>
                                </div>
                                <span class="progress-text">${job.progress}%</span>
                            </div>
                        ` : ''}
                        ${job.results ? `
                            <div class="job-results">
                                âœ… æˆåŠŸ: ${job.results.success} | âŒ å¤±æ•—: ${job.results.failed}
                                | â±ï¸ å‡¦ç†æ™‚é–“: ${Math.round(job.results.processingTime / 1000)}ç§’
                            </div>
                        ` : ''}
                        ${job.lastError ? `
                            <div class="job-error">âŒ ã‚¨ãƒ©ãƒ¼: ${job.lastError}</div>
                        ` : ''}
                    </div>
                </div>
            `).join('');

            container.innerHTML = queueHtml;
        },

        // ã‚¸ãƒ§ãƒ–ã‚¿ã‚¤ãƒ—ã‚¢ã‚¤ã‚³ãƒ³å–å¾—
        getJobTypeIcon(type) {
            const icons = {
                email: 'ğŸ“§',
                sms: 'ğŸ’¬',
                push: 'ğŸ””'
            };
            return icons[type] || 'ğŸ“‹';
        },

        // ã‚¸ãƒ§ãƒ–ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å–å¾—
        getJobActions(job) {
            const actions = [];
            
            if (job.status === 'pending') {
                actions.push(`<button class="btn-small" onclick="queueManager.removeJob('${job.id}')">å‰Šé™¤</button>`);
                actions.push(`<button class="btn-small" onclick="queueManager.prioritizeJob('${job.id}')">å„ªå…ˆåŒ–</button>`);
            }
            
            if (job.status === 'failed') {
                actions.push(`<button class="btn-small" onclick="queueManager.retryJob('${job.id}')">å†å®Ÿè¡Œ</button>`);
            }
            
            return actions.join(' ');
        },

        // ã‚¸ãƒ§ãƒ–å‰Šé™¤
        removeJob(jobId) {
            this.currentQueue = this.currentQueue.filter(job => job.id !== jobId);
            this.updateQueueDisplay();
            this.logActivity(`ã‚¸ãƒ§ãƒ–ã‚’å‰Šé™¤ã—ã¾ã—ãŸ: ${jobId}`, 'warning');
        },

        // ã‚¸ãƒ§ãƒ–å„ªå…ˆåŒ–
        prioritizeJob(jobId) {
            const job = this.currentQueue.find(j => j.id === jobId);
            if (job) {
                job.priority = 'high';
                this.currentQueue = this.currentQueue.filter(j => j.id !== jobId);
                this.insertByPriority(job);
                this.updateQueueDisplay();
                this.logActivity(`ã‚¸ãƒ§ãƒ–ã‚’å„ªå…ˆåŒ–ã—ã¾ã—ãŸ: ${jobId}`, 'info');
            }
        },

        // ã‚¸ãƒ§ãƒ–å†å®Ÿè¡Œ
        retryJob(jobId) {
            const job = this.failedQueue.find(j => j.id === jobId);
            if (job) {
                job.status = 'pending';
                job.attempts = 0;
                job.lastError = null;
                
                this.failedQueue = this.failedQueue.filter(j => j.id !== jobId);
                this.insertByPriority(job);
                this.updateQueueDisplay();
                this.logActivity(`ã‚¸ãƒ§ãƒ–ã‚’å†å®Ÿè¡Œã«è¨­å®šã—ã¾ã—ãŸ: ${jobId}`, 'info');
            }
        },

        // çµ±è¨ˆæ›´æ–°
        updateStats() {
            const elements = {
                totalJobs: document.getElementById('totalJobs'),
                pendingJobs: document.getElementById('pendingJobs'),
                processingJobs: document.getElementById('processingJobs'),
                completedJobs: document.getElementById('completedJobs'),
                failedJobs: document.getElementById('failedJobs'),
                successRate: document.getElementById('successRate'),
                avgProcessingTime: document.getElementById('avgProcessingTime'),
                throughput: document.getElementById('throughput')
            };

            const totalJobs = this.currentQueue.length + this.processingQueue.length + 
                            this.completedQueue.length + this.failedQueue.length;
            
            const successRate = this.stats.totalProcessed > 0 ? 
                Math.round((this.stats.totalSuccess / (this.stats.totalSuccess + this.stats.totalFailed)) * 100) : 0;

            if (elements.totalJobs) elements.totalJobs.textContent = totalJobs;
            if (elements.pendingJobs) elements.pendingJobs.textContent = this.currentQueue.length;
            if (elements.processingJobs) elements.processingJobs.textContent = this.processingQueue.length;
            if (elements.completedJobs) elements.completedJobs.textContent = this.completedQueue.length;
            if (elements.failedJobs) elements.failedJobs.textContent = this.failedQueue.length;
            if (elements.successRate) elements.successRate.textContent = `${successRate}%`;
            if (elements.avgProcessingTime) {
                elements.avgProcessingTime.textContent = `${Math.round(this.stats.averageProcessingTime / 1000)}ç§’`;
            }
            if (elements.throughput) elements.throughput.textContent = `${this.stats.throughput}/åˆ†`;
        },

        // ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãƒ­ã‚°
        logActivity(message, type = 'info') {
            const activityLog = document.getElementById('queueActivityLog');
            if (!activityLog) return;

            const logEntry = document.createElement('div');
            logEntry.className = `activity-entry ${type}`;
            logEntry.innerHTML = `
                <span class="activity-time">${new Date().toLocaleTimeString()}</span>
                <span class="activity-message">${message}</span>
            `;

            activityLog.insertBefore(logEntry, activityLog.firstChild);

            // ãƒ­ã‚°ä¸Šé™ç®¡ç†ï¼ˆæœ€æ–°50ä»¶ã¾ã§ï¼‰
            while (activityLog.children.length > 50) {
                activityLog.removeChild(activityLog.lastChild);
            }
        },

        // è¨­å®šæ›´æ–°
        updateConfig(newConfig) {
            this.config = { ...this.config, ...newConfig };
            this.logActivity('ã‚­ãƒ¥ãƒ¼è¨­å®šã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'info');
            console.log('ğŸ“ ã‚­ãƒ¥ãƒ¼è¨­å®šæ›´æ–°:', this.config);
        },

        // ã‚­ãƒ¥ãƒ¼ãƒªã‚»ãƒƒãƒˆ
        resetQueue() {
            if (this.isRunning) {
                this.stopQueue();
            }
            
            this.currentQueue = [];
            this.processingQueue = [];
            this.completedQueue = [];
            this.failedQueue = [];
            this.stats = {
                totalProcessed: 0,
                totalSuccess: 0,
                totalFailed: 0,
                startTime: null,
                lastProcessedTime: null,
                averageProcessingTime: 0,
                throughput: 0
            };
            
            this.updateQueueDisplay();
            this.logActivity('ã‚­ãƒ¥ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ', 'warning');
        },

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£: é…å»¶
        delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    };

    // ã‚­ãƒ¥ãƒ¼ã‚·ã‚¹ãƒ†ãƒ ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
    function setupQueueEventHandlers() {
        // ã‚­ãƒ¥ãƒ¼é–‹å§‹ãƒœã‚¿ãƒ³
        const startQueueBtn = document.getElementById('startQueueBtn');
        if (startQueueBtn) {
            startQueueBtn.addEventListener('click', () => {
                queueManager.startQueue();
            });
        }

        // ã‚­ãƒ¥ãƒ¼ä¸€æ™‚åœæ­¢ãƒœã‚¿ãƒ³
        const pauseQueueBtn = document.getElementById('pauseQueueBtn');
        if (pauseQueueBtn) {
            pauseQueueBtn.addEventListener('click', () => {
                queueManager.pauseQueue();
            });
        }

        // ã‚­ãƒ¥ãƒ¼åœæ­¢ãƒœã‚¿ãƒ³
        const stopQueueBtn = document.getElementById('stopQueueBtn');
        if (stopQueueBtn) {
            stopQueueBtn.addEventListener('click', () => {
                queueManager.stopQueue();
            });
        }

        // ã‚­ãƒ¥ãƒ¼ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³
        const resetQueueBtn = document.getElementById('resetQueueBtn');
        if (resetQueueBtn) {
            resetQueueBtn.addEventListener('click', () => {
                if (confirm('æœ¬å½“ã«ã‚­ãƒ¥ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿå…¨ã¦ã®ã‚¸ãƒ§ãƒ–ãŒå‰Šé™¤ã•ã‚Œã¾ã™ã€‚')) {
                    queueManager.resetQueue();
                }
            });
        }

        // è¨­å®šæ›´æ–°ãƒ•ã‚©ãƒ¼ãƒ 
        const queueConfigForm = document.getElementById('queueConfigForm');
        if (queueConfigForm) {
            queueConfigForm.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const formData = new FormData(queueConfigForm);
                const config = {
                    maxConcurrent: parseInt(formData.get('maxConcurrent')) || 3,
                    batchSize: parseInt(formData.get('batchSize')) || 50,
                    retryCount: parseInt(formData.get('retryCount')) || 3,
                    processDelay: parseInt(formData.get('processDelay')) || 1000,
                    priority: formData.get('priority') || 'normal'
                };
                
                queueManager.updateConfig(config);
                showNotification('ã‚­ãƒ¥ãƒ¼è¨­å®šã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
            });
        }

        // ãƒ†ã‚¹ãƒˆã‚¸ãƒ§ãƒ–è¿½åŠ ãƒœã‚¿ãƒ³
        const addTestJobBtn = document.getElementById('addTestJobBtn');
        if (addTestJobBtn) {
            addTestJobBtn.addEventListener('click', () => {
                const testJob = {
                    type: 'email',
                    priority: 'normal',
                    data: {
                        subject: 'ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«',
                        content: 'ã“ã‚Œã¯ã‚­ãƒ¥ãƒ¼ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ†ã‚¹ãƒˆã§ã™ã€‚'
                    },
                    recipients: Array.from({ length: 10 }, (_, i) => ({
                        email: `test${i + 1}@example.com`,
                        name: `ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼${i + 1}`
                    }))
                };
                
                const jobId = queueManager.addJob(testJob);
                showNotification(`ãƒ†ã‚¹ãƒˆã‚¸ãƒ§ãƒ–ã‚’è¿½åŠ ã—ã¾ã—ãŸ: ${jobId}`, 'success');
            });
        }

        // å®šæœŸçš„ãªçµ±è¨ˆæ›´æ–°ï¼ˆ5ç§’é–“éš”ï¼‰
        setInterval(() => {
            if (queueManager.isRunning) {
                queueManager.updateThroughput();
                queueManager.updateStats();
            }
        }, 5000);
    }

    // ãƒ¡ãƒ¼ãƒ«ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ã®ã‚­ãƒ¥ãƒ¼ã‚¸ãƒ§ãƒ–ä½œæˆ
    function createQueueJobFromEmail() {
        const recipients = getSelectedRecipients();
        if (recipients.length === 0) {
            showNotification('å—ä¿¡è€…ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
            return;
        }

        const emailData = {
            subject: document.getElementById('subject')?.value || '',
            content: document.getElementById('content')?.value || '',
            contentHtml: document.getElementById('contentHtml')?.value || '',
            senderName: document.getElementById('senderName')?.value || 'NANKANã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹',
            priority: document.getElementById('emailPriority')?.value || 'normal'
        };

        if (!emailData.subject || !emailData.content) {
            showNotification('ä»¶åã¨æœ¬æ–‡ã¯å¿…é ˆã§ã™', 'error');
            return;
        }

        const job = {
            type: 'email',
            priority: emailData.priority,
            data: emailData,
            recipients: recipients,
            maxAttempts: 3
        };

        const jobId = queueManager.addJob(job);
        showNotification(`ãƒ¡ãƒ¼ãƒ«é…ä¿¡ã‚¸ãƒ§ãƒ–ã‚’ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ ã—ã¾ã—ãŸ: ${jobId}`, 'success');
        
        // ã‚­ãƒ¥ãƒ¼ã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆ
        document.querySelector('[data-tab="queue"]')?.click();
    }

    // åˆæœŸè¡¨ç¤ºã§å±¥æ­´ã‚’èª­ã¿è¾¼ã¿
    document.addEventListener('DOMContentLoaded', () => {
        loadHistory();
        updateCurrentTime();
        loadSecuritySettings();
        loadUnsubscribeSettings();
        getCurrentIP();
        checkRateLimit();
        updateUnsubscribeStats();
        setupQuickSchedule();
        initializeRecurringSettings();
        setupQueueEventHandlers(); // ã‚­ãƒ¥ãƒ¼ã‚·ã‚¹ãƒ†ãƒ ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’è¨­å®š
        // åˆæœŸçŠ¶æ…‹ã§ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®è¡¨ç¤ºã‚’è¨­å®š
        updateTemplateSection();
        // CTAãƒœã‚¿ãƒ³è¨­å®šã®åˆæœŸçŠ¶æ…‹ã‚’è¨­å®š
        updateCtaButtonSettings();
        
        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã®ä»£æ›¿å‡¦ç†
        const previewBtn = document.getElementById('generatePreviewBtn');
        if (!previewBtn) {
            console.warn('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ã‚’å‹•çš„ã«ä½œæˆ
            const previewArea = document.getElementById('previewArea');
            if (previewArea && !document.getElementById('generatePreviewBtn')) {
                const newPreviewBtn = document.createElement('button');
                newPreviewBtn.id = 'generatePreviewBtn';
                newPreviewBtn.type = 'button';
                newPreviewBtn.textContent = 'ğŸ” ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆ';
                newPreviewBtn.className = 'btn btn-secondary';
                newPreviewBtn.style.marginBottom = '20px';
                
                previewArea.parentNode.insertBefore(newPreviewBtn, previewArea);
                newPreviewBtn.addEventListener('click', generatePreview);
                
                console.log('âœ… ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ã‚’å‹•çš„ã«ä½œæˆã—ã¾ã—ãŸ');
            }
        } else {
            console.log('âœ… ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ');
        }
        
        console.log('ãƒšãƒ¼ã‚¸åˆæœŸåŒ–å®Œäº†');
    });

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆ
    document.getElementById('previewBtn')?.addEventListener('click', async () => {
        const subject = document.getElementById('subject').value;
        const mainContent = document.getElementById('mainContent').value;
        const templateType = document.getElementById('templateType').value;
        
        if (!subject || !mainContent) {
            alert('ä»¶åã¨æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }

        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¿ã‚¤ãƒ—åˆ¥ã®ãƒ‡ãƒ¼ã‚¿åé›†
        let templateData = {
            title: subject,
            mainContent: mainContent,
            templateType: templateType,
            layoutOrder: document.getElementById('layoutOrder')?.value || 'content-first',
            predictionNote: document.getElementById('predictionNote')?.value || '',
            additionalSection: document.getElementById('additionalSection')?.value || '',
            showCtaButton: document.getElementById('showCtaButton')?.checked || false,
            customCtaText: document.getElementById('customCtaText')?.value || '',
            customCtaUrl: document.getElementById('customCtaUrl')?.value || 'https://nankan-analytics.keiba.link/pricing/'
        };

        if (templateType === 'prediction') {
            // äºˆæƒ³ãƒ‡ãƒ¼ã‚¿åé›†
            const predictionInputs = document.querySelectorAll('.prediction-input');
            templateData.predictions = Array.from(predictionInputs).map(input => {
                const raceName = input.querySelector('.race-name').value;
                const horses = input.querySelector('.race-horses').value
                    .split('\n')
                    .filter(h => h.trim())
                    .map(h => h.trim());
                return { raceName, horses };
            }).filter(p => p.raceName && p.horses.length > 0);
        } else if (templateType === 'result') {
            // çµæœãƒ‡ãƒ¼ã‚¿åé›†
            const resultInputs = document.querySelectorAll('.result-input');
            templateData.results = Array.from(resultInputs).map(input => {
                const raceName = input.querySelector('.result-race-name').value;
                const winner = input.querySelector('.result-winner').value;
                const payout = input.querySelector('.result-payout').value;
                const status = input.querySelector('.result-status').value;
                return { raceName, winner, payout, status };
            }).filter(r => r.raceName);
            
            templateData.monthlyHitRate = document.getElementById('monthlyHitRate')?.value || '';
            templateData.monthlyProfit = document.getElementById('monthlyProfit')?.value || '';
        } else if (templateType === 'campaign') {
            // ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ãƒ‡ãƒ¼ã‚¿åé›†
            templateData.campaignTitle = document.getElementById('campaignTitle')?.value || '';
            templateData.campaignDetails = document.getElementById('campaignDetails')?.value || '';
            templateData.originalPrice = document.getElementById('originalPrice')?.value || '';
            templateData.campaignPrice = document.getElementById('campaignPrice')?.value || '';
            templateData.campaignDeadline = document.getElementById('campaignDeadline')?.value || '';
            templateData.ctaText = document.getElementById('ctaText')?.value || 'ğŸ¯ é™å®šã‚ªãƒ•ã‚¡ãƒ¼ã‚’ç¢ºèªã™ã‚‹';
            templateData.ctaUrl = document.getElementById('ctaUrl')?.value || 'https://nankan-analytics.keiba.link/pricing/';
        } else if (templateType === 'custom') {
            // ã‚«ã‚¹ã‚¿ãƒ ãƒ‡ãƒ¼ã‚¿åé›†
            templateData.customTheme = document.getElementById('customTheme')?.value || 'default';
            templateData.customHeadline = document.getElementById('customHeadline')?.value || '';
            templateData.customAccent = document.getElementById('customAccent')?.value || '';
            templateData.customSectionCtaText = document.getElementById('customSectionCtaText')?.value || '';
            templateData.customSectionCtaUrl = document.getElementById('customSectionCtaUrl')?.value || '';
        }

        // HTMLãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”Ÿæˆ
        const htmlContent = generateAdvancedNewsletterHTML(templateData);

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
        const previewArea = document.getElementById('previewArea');
        previewArea.innerHTML = `
            <div class="email-frame">
                <div class="email-header">
                    <strong>ä»¶å:</strong> ${subject}
                </div>
                <iframe srcdoc="${htmlContent.replace(/"/g, '&quot;')}" style="width: 100%; height: 600px; border: 1px solid #ddd;"></iframe>
            </div>
        `;
    });

    // é…ä¿¡å®Ÿè¡Œ
    document.getElementById('sendBtn')?.addEventListener('click', async () => {
        const subject = document.getElementById('subject').value;
        const mainContent = document.getElementById('mainContent').value;
        const targetPlan = document.getElementById('targetPlan').value;
        const templateType = document.getElementById('templateType').value;
        const scheduledAt = document.getElementById('scheduledAt').value;
        
        if (!subject || !mainContent) {
            alert('ä»¶åã¨æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }

        // æ¨å®šå—ä¿¡è€…æ•°ã‚’è¨ˆç®—ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ç”¨ï¼‰
        const estimatedRecipients = calculateEstimatedRecipients(targetPlan);
        
        // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
        const securityResult = performSecurityCheck(estimatedRecipients);
        if (!securityResult.allowed) {
            alert(`é…ä¿¡ãŒåˆ¶é™ã•ã‚Œã¾ã—ãŸ\n\nç†ç”±: ${securityResult.reason}\n\nã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
            logSecurityEvent('SEND_BLOCKED', `é…ä¿¡æ‹’å¦: ${securityResult.reason} (å¯¾è±¡: ${estimatedRecipients}é€š)`, 'warning');
            return;
        }

        if (!confirm(`${targetPlan === 'all' ? 'å…¨ä¼šå“¡' : targetPlan + 'ä¼šå“¡'}ã«é…ä¿¡ã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) {
            return;
        }

        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼è¡¨ç¤º
        showProgressBar(estimatedRecipients);
        
        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹æ›´æ–°ã®ãŸã‚ã®ã‚¿ã‚¤ãƒãƒ¼
        const progressInterval = setInterval(() => {
            if (!sendProgress.isActive || sendProgress.isCancelled) {
                clearInterval(progressInterval);
                return;
            }
            
            // ã‚¹ãƒ†ãƒƒãƒ—é€²è¡Œã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå®Ÿéš›ã®APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã§ã‚ˆã‚Šæ­£ç¢ºã«åˆ¶å¾¡å¯èƒ½ï¼‰
            if (sendProgress.currentStep === 0) {
                setTimeout(() => setProgressStep(1), 500);
            }
        }, 100);

        // ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼
        setTimeout(() => {
            if (sendProgress.isCancelled) return;
            setProgressStep(1);
        }, 800);

        // ã‚¹ãƒ†ãƒƒãƒ—2: å—ä¿¡è€…ãƒªã‚¹ãƒˆæº–å‚™
        setTimeout(() => {
            if (sendProgress.isCancelled) return;
            setProgressStep(2);
        }, 1500);

        // äºˆæƒ³ãƒ‡ãƒ¼ã‚¿åé›†
        let predictions = [];
        if (templateType === 'prediction') {
            const predictionInputs = document.querySelectorAll('.prediction-input');
            predictions = Array.from(predictionInputs).map(input => {
                const raceName = input.querySelector('.race-name').value;
                const horses = input.querySelector('.race-horses').value
                    .split('\n')
                    .filter(h => h.trim())
                    .map(h => h.trim());
                return { raceName, horses };
            }).filter(p => p.raceName && p.horses.length > 0);
        }

        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™
        let templateData = {
            title: subject,
            mainContent: mainContent,
            templateType: templateType,
            layoutOrder: document.getElementById('layoutOrder')?.value || 'content-first',
            predictionNote: document.getElementById('predictionNote')?.value || '',
            additionalSection: document.getElementById('additionalSection')?.value || '',
            showCtaButton: document.getElementById('showCtaButton')?.checked || false,
            customCtaText: document.getElementById('customCtaText')?.value || '',
            customCtaUrl: document.getElementById('customCtaUrl')?.value || 'https://nankan-analytics.keiba.link/pricing/',
            predictions: predictions
        };

        // HTMLãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”Ÿæˆ
        let htmlContent = generateAdvancedNewsletterHTML(templateData);

        // Unsubscribeãƒªãƒ³ã‚¯ã‚’è‡ªå‹•è¿½åŠ 
        htmlContent = addUnsubscribeFooter(htmlContent);

        try {
            console.log('é…ä¿¡ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ä¸­...', {
                subject,
                targetPlan,
                hasHtmlContent: !!htmlContent,
                scheduledAt
            });

            const response = await fetch('/.netlify/functions/send-newsletter', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    subject,
                    htmlContent,
                    targetPlan,
                    scheduledAt: scheduledAt || null
                })
            });

            console.log('ãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡:', response.status, response.statusText);

            // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å…ˆã«å–å¾—
            const responseText = await response.text();
            console.log('ãƒ¬ã‚¹ãƒãƒ³ã‚¹å†…å®¹:', responseText);

            let result;
            try {
                result = JSON.parse(responseText);
            } catch (parseError) {
                console.error('JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', parseError);
                console.error('ãƒ‘ãƒ¼ã‚¹å¤±æ•—ã—ãŸãƒ†ã‚­ã‚¹ãƒˆ:', responseText);
                alert(`âŒ é…ä¿¡å¤±æ•—: ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®å¿œç­”ã‚’è§£æã§ãã¾ã›ã‚“ã§ã—ãŸ\nã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${response.status}\nè©³ç´°ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„`);
                return;
            }
            
            if (response.ok) {
                // ã‚¹ãƒ†ãƒƒãƒ—3: çµæœç¢ºèª
                if (!sendProgress.isCancelled) {
                    setProgressStep(3);
                    
                    // æœ€çµ‚çµ±è¨ˆæ›´æ–°
                    updateSendProgress(result.recipientCount || 0, result.failedCount || 0);
                }
                
                let successMessage;
                if (result.isScheduled) {
                    // äºˆç´„é…ä¿¡æˆåŠŸ
                    const scheduledDate = new Date(scheduledAt);
                    successMessage = `ğŸš€ äºˆç´„é…ä¿¡ç™»éŒ²å®Œäº†ï¼\n\n` +
                        `ä»¶å: ${result.data.subject}\n` +
                        `é…ä¿¡äºˆå®š: ${result.data.scheduledTime}\n` +
                        `å¯¾è±¡: ${result.data.recipientCount}ä»¶\n` +
                        `ã‚¸ãƒ§ãƒ–ID: ${result.jobId}\n\n` +
                        `âœ… è‡ªä½œã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ã§ç¢ºå®Ÿé…ä¿¡ã•ã‚Œã¾ã™ï¼\n` +
                        `${result.data.note}`;
                } else if (result.failedCount > 0) {
                    successMessage = `âš ï¸ é…ä¿¡å®Œäº†ï¼æˆåŠŸ: ${result.recipientCount}ä»¶ã€å¤±æ•—: ${result.failedCount}ä»¶`;
                } else {
                    successMessage = `âœ… é…ä¿¡æˆåŠŸï¼${result.recipientCount}ä»¶ã«é…ä¿¡ã—ã¾ã—ãŸ`;
                }
                
                // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹å®Œäº†
                if (sendProgress.isActive && !sendProgress.isCancelled) {
                    completeProgress(true, successMessage);
                    
                    setTimeout(() => {
                        alert(successMessage);
                    }, 800);
                } else {
                    alert(successMessage);
                }
                
                // å¤±æ•—ãƒ¡ãƒ¼ãƒ«ãŒã‚ã‚‹å ´åˆã¯LocalStorageã«ä¿å­˜
                if (result.failedEmails && result.failedEmails.length > 0) {
                    const failedKey = `newsletter-failed-${Date.now()}`;
                    localStorage.setItem(failedKey, JSON.stringify(result.failedEmails));
                    console.warn('é€ä¿¡å¤±æ•—ãƒ¡ãƒ¼ãƒ«ã‚’ä¿å­˜:', result.failedEmails.length + 'ä»¶');
                }
                
                // å±¥æ­´ã«ä¿å­˜
                saveHistoryToLocal({
                    subject: subject,
                    targetPlan: targetPlan,
                    recipientCount: result.recipientCount,
                    failedCount: result.failedCount || 0,
                    scheduledAt: scheduledAt || new Date().toISOString(),
                    status: result.isScheduled ? 'scheduled' : 'sent'
                });
                
                // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
                document.getElementById('subject').value = '';
                document.getElementById('mainContent').value = '';
                document.getElementById('targetPlan').value = 'all';
                document.getElementById('templateType').value = 'prediction';
                document.getElementById('scheduledAt').value = '';
                document.getElementById('predictionNote').value = '';
                document.getElementById('additionalSection').value = '';
                document.getElementById('customCtaText').value = '';
                document.getElementById('showCtaButton').checked = true;
                // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚‚ã‚¯ãƒªã‚¢
                clearPreview();
                
                // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¿ã‚¤ãƒ—ã‚’ãƒªã‚»ãƒƒãƒˆå¾Œã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°
                setTimeout(() => {
                    updateTemplateSection();
                }, 100);
                
                // å±¥æ­´ã‚’æ›´æ–°
                loadHistory();
            } else {
                console.error('é…ä¿¡ã‚¨ãƒ©ãƒ¼è©³ç´°:', result);
                alert(`âŒ é…ä¿¡å¤±æ•—: ${result.error || result.details || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'}\nè©³ç´°ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„`);
            }
        } catch (error) {
            console.error('é…ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
            
            // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹å¤±æ•—å‡¦ç†
            if (sendProgress.isActive) {
                completeProgress(false);
            }
            
            alert(`é…ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
        }
    });

    // æ–°ã—ã„çµ±åˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”Ÿæˆé–¢æ•°
    function generateAdvancedNewsletterHTML(templateData) {
        const { 
            title, 
            mainContent, 
            templateType,
            predictions = [],
            results = [],
            monthlyHitRate = '',
            monthlyProfit = '',
            campaignTitle = '',
            campaignDetails = '',
            originalPrice = '',
            campaignPrice = '',
            campaignDeadline = '',
            ctaUrl = 'https://nankan-analytics.keiba.link/pricing/',
            customTheme = 'default',
            customHeadline = '',
            customAccent = '',
            customSectionCtaText = '',
            customSectionCtaUrl = '',
            layoutOrder = 'content-first',
            predictionNote = '',
            additionalSection = '',
            showCtaButton = true,
            customCtaText = '',
            customCtaUrl = ''
        } = templateData;

        // CTAãƒ†ã‚­ã‚¹ãƒˆã‚’é©åˆ‡ã«è¨­å®š
        let ctaText;
        if (customCtaText && customCtaText.trim()) {
            ctaText = customCtaText;
        } else {
            switch(templateType) {
                case 'prediction':
                    ctaText = 'ğŸ‡ æœ‰æ–™ãƒ—ãƒ©ãƒ³ã§å…¨ãƒ¬ãƒ¼ã‚¹äºˆæƒ³ã‚’è¦‹ã‚‹';
                    break;
                case 'campaign':
                    ctaText = 'ğŸ¯ é™å®šã‚ªãƒ•ã‚¡ãƒ¼ã‚’ç¢ºèªã™ã‚‹';
                    break;
                case 'result':
                    ctaText = 'ğŸ“ˆ è©³ç´°ãªåˆ†æçµæœã‚’è¦‹ã‚‹';
                    break;
                default:
                    ctaText = 'è©³ç´°ã¯ã“ã¡ã‚‰';
            }
        }

        // ãƒ¢ãƒ€ãƒ³ãƒ†ãƒ¼ãƒåˆ¥ã‚¹ã‚¿ã‚¤ãƒ«
        const modernThemes = {
            gold: {
                gradient: 'linear-gradient(135deg, #fbbf24 0%, #f59e0b 50%, #d97706 100%)',
                cardBg: 'linear-gradient(135deg, #fefbf3 0%, #fef3c7 100%)',
                textColor: '#92400e',
                accentColor: '#f59e0b'
            },
            red: {
                gradient: 'linear-gradient(135deg, #ff6b6b 0%, #ee5a24 50%, #e17055 100%)',
                cardBg: 'linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%)',
                textColor: '#991b1b',
                accentColor: '#dc2626'
            },
            blue: {
                gradient: 'linear-gradient(135deg, #4299e1 0%, #3182ce 50%, #2b6cb0 100%)',
                cardBg: 'linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%)',
                textColor: '#1e40af',
                accentColor: '#3b82f6'
            }
        };
        
        const currentTheme = modernThemes[customTheme] || modernThemes.blue;
        
        let themeStyles = `
            .header { background: ${currentTheme.gradient}; }
            .prediction-card, .result-card, .campaign-card { 
                border-left-color: ${currentTheme.accentColor}; 
                background: ${currentTheme.cardBg};
                box-shadow: 0 10px 25px rgba(0,0,0,0.1);
                border-radius: 15px;
            }
            .cta-button { 
                background: ${currentTheme.gradient};
                box-shadow: 0 10px 25px rgba(0,0,0,0.2);
                border-radius: 12px;
                transition: all 0.3s ease;
            }
            .cta-button:hover {
                transform: translateY(-3px);
                box-shadow: 0 15px 35px rgba(0,0,0,0.3);
            }
            .modern-campaign-hero {
                background: ${currentTheme.gradient};
                position: relative;
                overflow: hidden;
            }
            .campaign-highlight {
                background: ${currentTheme.cardBg};
                border: 2px solid ${currentTheme.accentColor};
                box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            }
        `;

        // ã‚«ã‚¹ã‚¿ãƒ ãƒ˜ãƒƒãƒ‰ãƒ©ã‚¤ãƒ³
        const customHeadlineHTML = customHeadline ? `
            <div style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); padding: 20px; margin: 20px 0; border-radius: 12px; border-left: 4px solid #ef4444; text-align: center;">
                <h2 style="color: #dc2626; font-size: 24px; font-weight: bold; margin: 0;">${customHeadline}</h2>
            </div>
        ` : '';

        // ã‚«ã‚¹ã‚¿ãƒ ã‚¢ã‚¯ã‚»ãƒ³ãƒˆ
        const customAccentHTML = customAccent ? `
            <div style="background: #f0f9ff; border-radius: 12px; padding: 20px; margin: 20px 0; border-left: 4px solid #0ea5e9;">
                <div style="color: #0c4a6e; font-size: 18px; font-weight: 600; line-height: 1.6; white-space: pre-wrap;">${customAccent}</div>
            </div>
        ` : '';

        return `
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="ja">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>${title}</title>
    <style type="text/css">
        /* Yahoo Mail compatibility fixes */
        body, table, td, p, a, li, blockquote {
            -webkit-text-size-adjust: 100%; 
            -ms-text-size-adjust: 100%;
        }
        table, td {
            mso-table-lspace: 0pt; 
            mso-table-rspace: 0pt;
        }
        img {
            -ms-interpolation-mode: bicubic;
            border: 0;
            height: auto;
            line-height: 100%;
            outline: none;
            text-decoration: none;
        }
        /* Remove default margins and spacing */
        body {
            margin: 0 !important;
            padding: 0 !important;
            height: 100% !important;
            width: 100% !important;
        }
        /* Email client reset */
        table {
            border-collapse: collapse !important;
        }
        a[x-apple-data-detectors] {
            color: inherit !important;
            text-decoration: none !important;
            font-size: inherit !important;
            font-family: inherit !important;
            font-weight: inherit !important;
            line-height: inherit !important;
        }
    </style>
</head>
<body style="margin: 0; padding: 0; font-family: Arial, sans-serif; background-color: #f8fafc;">
    <!-- Main Container Table -->
    <table border="0" cellpadding="0" cellspacing="0" width="100%" style="background-color: #f8fafc;">
        <tr>
            <td align="center" style="padding: 20px 0;">
                <!-- Email Content Table -->
                <table border="0" cellpadding="0" cellspacing="0" width="600" style="max-width: 600px; background-color: #ffffff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                    
                    <!-- Header Section -->
                    <tr>
                        <td align="center" style="background-color: #1e293b; padding: 40px 20px; border-radius: 12px 12px 0 0;">
                            <table border="0" cellpadding="0" cellspacing="0" width="100%">
                                <tr>
                                    <td align="center">
                                        <h1 style="margin: 0 0 10px 0; color: #ffffff; font-size: 28px; font-weight: bold; font-family: Arial, sans-serif;">
                                            ğŸ‡ NANKANã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹
                                        </h1>
                                        <p style="margin: 0; color: #cbd5e1; font-size: 16px; font-family: Arial, sans-serif;">
                                            AIãƒ»æ©Ÿæ¢°å­¦ç¿’ã§å‹ã¤å—é–¢ç«¶é¦¬
                                        </p>
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                    
                    <!-- Content Section -->
                    <tr>
                        <td style="padding: 40px 30px;">
                            
                            <!-- Custom Headline -->
                            ${customHeadline ? `
                            <table border="0" cellpadding="0" cellspacing="0" width="100%" style="margin-bottom: 25px;">
                                <tr>
                                    <td align="center" style="background-color: #fee2e2; padding: 20px; border-radius: 8px; border-left: 4px solid #ef4444;">
                                        <h2 style="margin: 0; color: #dc2626; font-size: 22px; font-weight: bold; font-family: Arial, sans-serif;">${customHeadline}</h2>
                                    </td>
                                </tr>
                            </table>
                            ` : ''}
                            
                            <!-- Prediction First Layout -->
                            ${layoutOrder === 'prediction-first' && templateType === 'prediction' && predictions.length > 0 ? `
                            <!-- Section Title -->
                            <table border="0" cellpadding="0" cellspacing="0" width="100%" style="margin-bottom: 25px;">
                                <tr>
                                    <td align="center">
                                        <h3 style="margin: 0 0 15px 0; color: #0f172a; font-size: 24px; font-weight: bold; font-family: Arial, sans-serif;">ğŸ¯ æœ¬æ—¥ã®æ³¨ç›®äºˆæƒ³</h3>
                                        <div style="width: 60px; height: 3px; background-color: #3b82f6; margin: 0 auto;"></div>
                                    </td>
                                </tr>
                            </table>
                            
                            <!-- Prediction Cards -->
                            ${predictions.map(p => `
                            <table border="0" cellpadding="0" cellspacing="0" width="100%" style="margin-bottom: 20px; background-color: #ffffff; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                                <tr>
                                    <td style="padding: 25px; border-left: 4px solid #3b82f6;">
                                        <h4 style="margin: 0 0 15px 0; color: #0f172a; font-size: 18px; font-weight: bold; font-family: Arial, sans-serif;">
                                            ğŸ ${p.raceName}
                                        </h4>
                                        <table border="0" cellpadding="0" cellspacing="0" width="100%">
                                            ${p.horses.map(h => `
                                            <tr>
                                                <td style="padding: 8px 15px; background-color: #f8fafc; margin-bottom: 5px; border-radius: 6px; border-left: 3px solid #cbd5e1;">
                                                    <p style="margin: 0; color: #475569; font-size: 14px; font-family: Arial, sans-serif;">${h}</p>
                                                </td>
                                            </tr>
                                            `).join('')}
                                        </table>
                                    </td>
                                </tr>
                            </table>
                            `).join('')}
                            
                            ${predictionNote ? `
                            <table border="0" cellpadding="0" cellspacing="0" width="100%" style="margin: 20px 0;">
                                <tr>
                                    <td style="background-color: #f3e8ff; padding: 20px; border-radius: 8px; border-left: 4px solid #a855f7;">
                                        <p style="margin: 0; color: #7c3aed; font-size: 14px; line-height: 1.6; font-family: Arial, sans-serif; white-space: pre-wrap;">${predictionNote}</p>
                                    </td>
                                </tr>
                            </table>
                            ` : ''}
                            ` : ''}
                            
                            <!-- Main Content -->
                            <table border="0" cellpadding="0" cellspacing="0" width="100%" style="margin: 30px 0;">
                                <tr>
                                    <td align="center">
                                        <p style="margin: 0; color: #374151; font-size: 16px; line-height: 1.7; font-family: Arial, sans-serif;">${mainContent}</p>
                                    </td>
                                </tr>
                            </table>
                            
                            <!-- Custom Accent -->
                            ${customAccent ? `
                            <table border="0" cellpadding="0" cellspacing="0" width="100%" style="margin: 20px 0;">
                                <tr>
                                    <td style="background-color: #f0f9ff; padding: 20px; border-radius: 8px; border-left: 4px solid #0ea5e9;">
                                        <p style="margin: 0; color: #0c4a6e; font-size: 16px; font-weight: 600; line-height: 1.6; font-family: Arial, sans-serif; white-space: pre-wrap;">${customAccent}</p>
                                    </td>
                                </tr>
                            </table>
                            ` : ''}
                            
                            <!-- Content First Layout -->
                            ${layoutOrder === 'content-first' && templateType === 'prediction' && predictions.length > 0 ? `
                            <!-- Section Title -->
                            <table border="0" cellpadding="0" cellspacing="0" width="100%" style="margin-bottom: 25px;">
                                <tr>
                                    <td align="center">
                                        <h3 style="margin: 0 0 15px 0; color: #0f172a; font-size: 24px; font-weight: bold; font-family: Arial, sans-serif;">ğŸ¯ æœ¬æ—¥ã®æ³¨ç›®äºˆæƒ³</h3>
                                        <div style="width: 60px; height: 3px; background-color: #3b82f6; margin: 0 auto;"></div>
                                    </td>
                                </tr>
                            </table>
                            
                            <!-- Prediction Cards -->
                            ${predictions.map(p => `
                            <table border="0" cellpadding="0" cellspacing="0" width="100%" style="margin-bottom: 20px; background-color: #ffffff; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                                <tr>
                                    <td style="padding: 25px; border-left: 4px solid #3b82f6;">
                                        <h4 style="margin: 0 0 15px 0; color: #0f172a; font-size: 18px; font-weight: bold; font-family: Arial, sans-serif;">
                                            ğŸ ${p.raceName}
                                        </h4>
                                        <table border="0" cellpadding="0" cellspacing="0" width="100%">
                                            ${p.horses.map(h => `
                                            <tr>
                                                <td style="padding: 8px 15px; background-color: #f8fafc; border-radius: 6px; border-left: 3px solid #cbd5e1;">
                                                    <p style="margin: 0 0 5px 0; color: #475569; font-size: 14px; font-family: Arial, sans-serif;">${h}</p>
                                                </td>
                                            </tr>
                                            `).join('')}
                                        </table>
                                    </td>
                                </tr>
                            </table>
                            `).join('')}
                            
                            ${predictionNote ? `
                            <table border="0" cellpadding="0" cellspacing="0" width="100%" style="margin: 20px 0;">
                                <tr>
                                    <td style="background-color: #f3e8ff; padding: 20px; border-radius: 8px; border-left: 4px solid #a855f7;">
                                        <p style="margin: 0; color: #7c3aed; font-size: 14px; line-height: 1.6; font-family: Arial, sans-serif; white-space: pre-wrap;">${predictionNote}</p>
                                    </td>
                                </tr>
                            </table>
                            ` : ''}
                            
                            ${additionalSection ? `
                            <table border="0" cellpadding="0" cellspacing="0" width="100%" style="margin: 25px 0;">
                                <tr>
                                    <td align="center">
                                        <p style="margin: 0; color: #374151; font-size: 16px; line-height: 1.7; font-family: Arial, sans-serif; white-space: pre-wrap;">${additionalSection}</p>
                                    </td>
                                </tr>
                            </table>
                            ` : ''}
                            ` : ''}
                            
                            <!-- Results Section -->
                            ${templateType === 'result' && results.length > 0 ? `
                            <!-- Section Title -->
                            <table border="0" cellpadding="0" cellspacing="0" width="100%" style="margin-bottom: 25px;">
                                <tr>
                                    <td align="center">
                                        <h3 style="margin: 0 0 15px 0; color: #0f172a; font-size: 24px; font-weight: bold; font-family: Arial, sans-serif;">ğŸ“Š æ˜¨æ—¥ã®çµæœ</h3>
                                        <div style="width: 60px; height: 3px; background-color: #3b82f6; margin: 0 auto;"></div>
                                    </td>
                                </tr>
                            </table>
                            
                            <!-- Result Cards -->
                            ${results.map(r => `
                            <table border="0" cellpadding="0" cellspacing="0" width="100%" style="margin-bottom: 20px; background-color: #ffffff; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                                <tr>
                                    <td style="padding: 25px; border-left: 4px solid #3b82f6;">
                                        <h4 style="margin: 0 0 15px 0; color: #0f172a; font-size: 18px; font-weight: bold; font-family: Arial, sans-serif;">
                                            ğŸ ${r.raceName}
                                        </h4>
                                        <table border="0" cellpadding="0" cellspacing="0" width="100%">
                                            <tr>
                                                <td style="padding: 8px 15px; background-color: #f8fafc; border-radius: 6px;">
                                                    <p style="margin: 0 0 5px 0; color: #475569; font-size: 14px; font-family: Arial, sans-serif;">ğŸ¥‡ 1ç€: <strong>${r.winner}</strong></p>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td style="padding: 8px 15px; background-color: #f8fafc; border-radius: 6px;">
                                                    <p style="margin: 0 0 5px 0; color: #475569; font-size: 14px; font-family: Arial, sans-serif;">ğŸ’° é…å½“: <strong>${r.payout}</strong></p>
                                                </td>
                                            </tr>
                                        </table>
                                        <div style="margin-top: 10px;">
                                            <span style="
                                                font-weight: bold; 
                                                font-size: 14px; 
                                                padding: 6px 12px; 
                                                border-radius: 15px; 
                                                display: inline-block;
                                                color: ${r.status === 'hit' ? '#065f46' : r.status === 'near' ? '#92400e' : '#991b1b'};
                                                background-color: ${r.status === 'hit' ? '#d1fae5' : r.status === 'near' ? '#fef3c7' : '#fee2e2'};
                                            ">
                                                ${r.status === 'hit' ? 'ğŸ¯ çš„ä¸­ï¼' : r.status === 'near' ? 'ğŸ“ˆ æƒœã—ã„ï¼' : 'âŒ ä¸çš„ä¸­'}
                                            </span>
                                        </div>
                                    </td>
                                </tr>
                            </table>
                            `).join('')}
                            
                            ${(monthlyHitRate || monthlyProfit) ? `
                            <!-- Stats Section -->
                            <table border="0" cellpadding="0" cellspacing="0" width="100%" style="margin: 25px 0; background-color: #eff6ff; border-radius: 12px; border: 1px solid rgba(59,130,246,0.1);">
                                <tr>
                                    <td style="padding: 25px;">
                                        <h4 style="margin: 0 0 15px 0; color: #0c4a6e; font-size: 18px; font-weight: bold; font-family: Arial, sans-serif;">ğŸ“ˆ ä»Šæœˆã®å®Ÿç¸¾</h4>
                                        <table border="0" cellpadding="0" cellspacing="0" width="100%">
                                            <tr>
                                                ${monthlyHitRate ? `
                                                <td align="center" style="background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                                                    <div style="font-size: 28px; font-weight: bold; color: #1e40af; margin-bottom: 5px;">${monthlyHitRate}</div>
                                                    <div style="font-size: 12px; color: #64748b; font-weight: 600;">çš„ä¸­ç‡</div>
                                                </td>
                                                ` : ''}
                                                ${monthlyProfit ? `
                                                <td align="center" style="background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                                                    <div style="font-size: 28px; font-weight: bold; color: #1e40af; margin-bottom: 5px;">${monthlyProfit}</div>
                                                    <div style="font-size: 12px; color: #64748b; font-weight: 600;">åæ”¯</div>
                                                </td>
                                                ` : ''}
                                            </tr>
                                        </table>
                                    </td>
                                </tr>
                            </table>
                            ` : ''}
                            ` : ''}
                            
                            <!-- Campaign Section -->
                            ${templateType === 'campaign' && campaignTitle ? `
                            <table border="0" cellpadding="0" cellspacing="0" width="100%" style="margin: 25px 0; background-color: #1e293b; border-radius: 12px;">
                                <tr>
                                    <td align="center" style="padding: 35px 25px; color: white;">
                                        <h2 style="margin: 0 0 15px 0; color: #ffffff; font-size: 24px; font-weight: bold; font-family: Arial, sans-serif;">
                                            ğŸ† ${campaignTitle} ğŸ†
                                        </h2>
                                        <p style="margin: 0 0 25px 0; color: #cbd5e1; font-size: 16px; font-family: Arial, sans-serif;">
                                            âœ¨ ${campaignDetails || 'æœŸé–“é™å®šã®ç‰¹åˆ¥ã‚ªãƒ•ã‚¡ãƒ¼ã‚’ãŠè¦‹é€ƒã—ãªãï¼'} âœ¨
                                        </p>
                                        
                                        ${originalPrice && campaignPrice ? `
                                        <table border="0" cellpadding="0" cellspacing="0" style="margin: 15px auto; background-color: rgba(255,255,255,0.2); border-radius: 8px; padding: 15px;">
                                            <tr>
                                                <td align="center">
                                                    <span style="font-size: 18px; text-decoration: line-through; opacity: 0.7; color: white;">${originalPrice}</span>
                                                    <span style="font-size: 14px; font-weight: bold; margin: 0 15px; color: white;">â†’</span>
                                                    <span style="font-size: 24px; font-weight: bold; color: white;">${campaignPrice}</span>
                                                </td>
                                            </tr>
                                        </table>
                                        ` : ''}
                                        
                                        ${campaignDeadline ? `
                                        <div style="background-color: #dc2626; color: white; padding: 12px 25px; border-radius: 20px; font-weight: bold; margin-top: 15px; display: inline-block;">
                                            ğŸš¨ æœŸé™: ${campaignDeadline} ğŸš¨
                                        </div>
                                        ` : ''}
                                    </td>
                                </tr>
                            </table>
                            ` : ''}
                            
                            <!-- CTA Button -->
                            ${showCtaButton ? `
                            <table border="0" cellpadding="0" cellspacing="0" width="100%" style="margin: 30px 0;">
                                <tr>
                                    <td align="center">
                                        <table border="0" cellpadding="0" cellspacing="0">
                                            <tr>
                                                <td align="center" style="background-color: #3b82f6; border-radius: 12px; box-shadow: 0 4px 15px rgba(59,130,246,0.3);">
                                                    <a href="${customCtaUrl && customCtaUrl.trim() ? customCtaUrl : ctaUrl}" style="
                                                        display: inline-block; 
                                                        padding: 16px 32px; 
                                                        color: #ffffff; 
                                                        text-decoration: none; 
                                                        font-weight: bold; 
                                                        font-size: 16px; 
                                                        font-family: Arial, sans-serif;
                                                        border-radius: 12px;
                                                    ">${ctaText}</a>
                                                </td>
                                            </tr>
                                        </table>
                                    </td>
                                </tr>
                            </table>
                            ` : ''}
                            
                        </td>
                    </tr>
                    
                    <!-- Footer Section -->
                    <tr>
                        <td align="center" style="background-color: #f1f5f9; padding: 30px 20px; border-radius: 0 0 12px 12px; border-top: 1px solid #e2e8f0;">
                            <p style="margin: 0; color: #64748b; font-size: 12px; font-family: Arial, sans-serif;">
                                Â© 2025 NANKANã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹
                            </p>
                        </td>
                    </tr>
                    
                </table>
            </td>
        </tr>
    </table>
</body>
</html>
        `;
    }
</script>
