---
// ç®¡ç†è€…ç”¨ãƒ¡ãƒ«ãƒã‚¬é…ä¿¡ãƒšãƒ¼ã‚¸
export const prerender = true;
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout title="ãƒ¡ãƒ«ãƒã‚¬é…ä¿¡ç®¡ç† - NANKANã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹">
    <div class="newsletter-admin">
        <div class="admin-header">
            <h1>ğŸ“§ ãƒ¡ãƒ«ãƒã‚¬é…ä¿¡ç®¡ç†</h1>
            <p class="subtitle">NANKANã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ã®ãƒ¡ãƒ¼ãƒ«ãƒã‚¬ã‚¸ãƒ³ã‚’é…ä¿¡</p>
        </div>

        <div class="admin-container">
            <!-- é…ä¿¡ãƒ•ã‚©ãƒ¼ãƒ  -->
            <div class="card">
                <h2>æ–°è¦é…ä¿¡ä½œæˆ</h2>
                
                <div class="form-group">
                    <label for="subject">ä»¶å</label>
                    <input type="text" id="subject" placeholder="ä¾‹: ã€NANKANã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ã€‘æœ¬æ—¥ã®æ³¨ç›®ãƒ¬ãƒ¼ã‚¹äºˆæƒ³" />
                </div>

                <div class="form-group">
                    <label for="targetPlan">é…ä¿¡å¯¾è±¡</label>
                    <select id="targetPlan">
                        <option value="all">å…¨ä¼šå“¡</option>
                        <option value="free">ç„¡æ–™ä¼šå“¡ã®ã¿</option>
                        <option value="paid">æœ‰æ–™ä¼šå“¡ã®ã¿ï¼ˆStandard + Premiumï¼‰</option>
                        <option value="standard">Standardä¼šå“¡ã®ã¿</option>
                        <option value="premium">Premiumä¼šå“¡ã®ã¿</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="templateType">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¿ã‚¤ãƒ—</label>
                    <select id="templateType">
                        <option value="prediction">äºˆæƒ³é…ä¿¡</option>
                        <option value="result">çµæœå ±å‘Š</option>
                        <option value="campaign">ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³</option>
                        <option value="custom">ã‚«ã‚¹ã‚¿ãƒ </option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="mainContent">æœ¬æ–‡</label>
                    <textarea id="mainContent" rows="10" placeholder="ãƒ¡ãƒ¼ãƒ«ã®æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
                </div>

                <!-- äºˆæƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆäºˆæƒ³é…ä¿¡ã‚¿ã‚¤ãƒ—ã®å ´åˆï¼‰ -->
                <div id="predictionSection">
                    <h3>ğŸ¯ äºˆæƒ³æƒ…å ±</h3>
                    <div id="predictionsContainer">
                        <div class="prediction-input">
                            <input type="text" placeholder="ãƒ¬ãƒ¼ã‚¹åï¼ˆä¾‹: ç¬¬11R ãƒ¡ã‚¤ãƒ³ãƒ¬ãƒ¼ã‚¹ï¼‰" class="race-name" />
                            <textarea placeholder="äºˆæƒ³é¦¬ï¼ˆæ”¹è¡ŒåŒºåˆ‡ã‚Šï¼‰" rows="3" class="race-horses"></textarea>
                        </div>
                    </div>
                    <button type="button" id="addPrediction" class="btn-secondary">+ äºˆæƒ³ã‚’è¿½åŠ </button>
                </div>

                <!-- çµæœå ±å‘Šã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆçµæœå ±å‘Šã‚¿ã‚¤ãƒ—ã®å ´åˆï¼‰ -->
                <div id="resultSection" style="display: none;">
                    <h3>ğŸ“Š æ˜¨æ—¥ã®çµæœ</h3>
                    <div id="resultsContainer">
                        <div class="result-input">
                            <input type="text" placeholder="ãƒ¬ãƒ¼ã‚¹åï¼ˆä¾‹: ç¬¬11R ãƒ¡ã‚¤ãƒ³ãƒ¬ãƒ¼ã‚¹ï¼‰" class="result-race-name" />
                            <div class="result-details">
                                <input type="text" placeholder="1ç€é¦¬" class="result-winner" />
                                <input type="text" placeholder="é…å½“ï¼ˆä¾‹: Â¥1,200ï¼‰" class="result-payout" />
                                <select class="result-status">
                                    <option value="hit">ğŸ¯ çš„ä¸­ï¼</option>
                                    <option value="miss">âŒ ä¸çš„ä¸­</option>
                                    <option value="near">ğŸ“ˆ æƒœã—ã„ï¼</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <button type="button" id="addResult" class="btn-secondary">+ çµæœã‚’è¿½åŠ </button>
                    <div class="total-stats">
                        <input type="text" placeholder="ä»Šæœˆã®çš„ä¸­ç‡ï¼ˆä¾‹: 78%ï¼‰" id="monthlyHitRate" />
                        <input type="text" placeholder="ä»Šæœˆã®åæ”¯ï¼ˆä¾‹: +Â¥45,600ï¼‰" id="monthlyProfit" />
                    </div>
                </div>

                <!-- ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã‚¿ã‚¤ãƒ—ã®å ´åˆï¼‰ -->
                <div id="campaignSection" style="display: none;">
                    <h3>ğŸª ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³æƒ…å ±</h3>
                    <div class="campaign-inputs">
                        <input type="text" placeholder="ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³åï¼ˆä¾‹: é™å®š50åï¼ç‰¹åˆ¥äºˆæƒ³ãƒ—ãƒ©ãƒ³ï¼‰" id="campaignTitle" />
                        <textarea placeholder="ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³è©³ç´°ãƒ»ç‰¹å…¸å†…å®¹" rows="3" id="campaignDetails"></textarea>
                        <input type="text" placeholder="é€šå¸¸ä¾¡æ ¼ï¼ˆä¾‹: Â¥9,980ï¼‰" id="originalPrice" />
                        <input type="text" placeholder="ç‰¹åˆ¥ä¾¡æ ¼ï¼ˆä¾‹: Â¥4,980ï¼‰" id="campaignPrice" />
                        <input type="text" placeholder="æœŸé™ï¼ˆä¾‹: 12æœˆ31æ—¥ã¾ã§ï¼‰" id="campaignDeadline" />
                        <input type="text" placeholder="CTAãƒœã‚¿ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼ˆä¾‹: ä»Šã™ãç”³ã—è¾¼ã‚€ï¼‰" id="ctaText" />
                        <input type="url" placeholder="CTAãƒœã‚¿ãƒ³ãƒªãƒ³ã‚¯å…ˆURL" id="ctaUrl" />
                    </div>
                </div>

                <!-- ã‚«ã‚¹ã‚¿ãƒ ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã‚«ã‚¹ã‚¿ãƒ ã‚¿ã‚¤ãƒ—ã®å ´åˆï¼‰ -->
                <div id="customSection" style="display: none;">
                    <h3>ğŸ¨ ã‚«ã‚¹ã‚¿ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ</h3>
                    <div class="custom-inputs">
                        <label>èƒŒæ™¯è‰²ãƒ†ãƒ¼ãƒ</label>
                        <select id="customTheme">
                            <option value="default">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ</option>
                            <option value="gold">ğŸ† ã‚´ãƒ¼ãƒ«ãƒ‰ï¼ˆå‹åˆ©æ„Ÿï¼‰</option>
                            <option value="red">ğŸ”¥ ãƒ¬ãƒƒãƒ‰ï¼ˆç·Šæ€¥æ„Ÿï¼‰</option>
                            <option value="blue">ğŸ’ ãƒ–ãƒ«ãƒ¼ï¼ˆä¿¡é ¼æ„Ÿï¼‰</option>
                        </select>
                        
                        <label>ç‰¹åˆ¥è¦‹å‡ºã—</label>
                        <input type="text" placeholder="ç‰¹åˆ¥è¦‹å‡ºã—ï¼ˆä¾‹: ğŸš¨ ç·Šæ€¥é€Ÿå ±ï¼ï¼‰" id="customHeadline" />
                        
                        <label>ã‚¢ã‚¯ã‚»ãƒ³ãƒˆæƒ…å ±</label>
                        <textarea placeholder="å¼·èª¿ã—ãŸã„æƒ…å ±ãƒ»æ•°å­—ãƒ»å®Ÿç¸¾" rows="2" id="customAccent"></textarea>
                        
                        <label>è¿½åŠ CTA</label>
                        <input type="text" placeholder="è¿½åŠ ãƒœã‚¿ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ" id="customCtaText" />
                        <input type="url" placeholder="è¿½åŠ ãƒœã‚¿ãƒ³URL" id="customCtaUrl" />
                    </div>
                </div>

                <div class="form-group">
                    <label for="scheduledAt">é…ä¿¡äºˆç´„ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</label>
                    <input type="datetime-local" id="scheduledAt" />
                    <small>
                        ç©ºæ¬„ã®å ´åˆã¯å³æ™‚é…ä¿¡ã•ã‚Œã¾ã™<br>
                        <strong>ç¾åœ¨æ™‚åˆ»: <span id="currentTime">--:--</span></strong> (æ—¥æœ¬æ™‚é–“)<br>
                        <span style="color: #f59e0b;">âš ï¸ äºˆç´„é…ä¿¡ã¯5-10åˆ†ç¨‹åº¦ã®é…å»¶ãŒç™ºç”Ÿã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™</span>
                    </small>
                </div>

                <div class="button-group">
                    <button id="previewBtn" class="btn-secondary">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
                    <button id="clearPreviewBtn" class="btn-secondary">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ã‚¯ãƒªã‚¢</button>
                    <button id="sendBtn" class="btn-primary">é…ä¿¡å®Ÿè¡Œ</button>
                </div>
            </div>

            <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ -->
            <div class="card">
                <h2>ãƒ¡ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
                <div id="previewArea" class="preview-container">
                    <p class="preview-placeholder">é…ä¿¡å†…å®¹ã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã™ã‚‹ã«ã¯ã€Œãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„</p>
                </div>
            </div>

            <!-- é…ä¿¡å±¥æ­´ -->
            <div class="card">
                <h2>é…ä¿¡å±¥æ­´ãƒ»äºˆç´„çŠ¶æ³</h2>
                <div class="history-controls">
                    <button id="refreshHistoryBtn" class="btn-secondary">å±¥æ­´ã‚’æ›´æ–°</button>
                </div>
                <div id="historyArea">
                    <p class="loading">èª­ã¿è¾¼ã¿ä¸­...</p>
                </div>
            </div>
        </div>
    </div>
</BaseLayout>

<script>
    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¿ã‚¤ãƒ—ã®è¡¨ç¤ºåˆ¶å¾¡é–¢æ•°
    function updateTemplateSection() {
        const templateType = document.getElementById('templateType');
        const predictionSection = document.getElementById('predictionSection');
        const resultSection = document.getElementById('resultSection');
        const campaignSection = document.getElementById('campaignSection');
        const customSection = document.getElementById('customSection');
        
        // å…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º
        [predictionSection, resultSection, campaignSection, customSection].forEach(section => {
            if (section) section.style.display = 'none';
        });
        
        // é¸æŠã•ã‚ŒãŸã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦è¡¨ç¤º
        if (templateType) {
            switch (templateType.value) {
                case 'prediction':
                    if (predictionSection) {
                        predictionSection.style.display = 'block';
                        console.log('ğŸ¯ äºˆæƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º');
                    }
                    break;
                case 'result':
                    if (resultSection) {
                        resultSection.style.display = 'block';
                        console.log('ğŸ“Š çµæœå ±å‘Šã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º');
                    }
                    break;
                case 'campaign':
                    if (campaignSection) {
                        campaignSection.style.display = 'block';
                        console.log('ğŸª ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º');
                    }
                    break;
                case 'custom':
                    if (customSection) {
                        customSection.style.display = 'block';
                        console.log('ğŸ¨ ã‚«ã‚¹ã‚¿ãƒ ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º');
                    }
                    break;
            }
        }
    }

    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¿ã‚¤ãƒ—å¤‰æ›´æ™‚ã®å‡¦ç†
    const templateType = document.getElementById('templateType');
    templateType?.addEventListener('change', updateTemplateSection);

    // äºˆæƒ³è¿½åŠ ãƒœã‚¿ãƒ³
    document.getElementById('addPrediction')?.addEventListener('click', () => {
        const container = document.getElementById('predictionsContainer');
        const newPrediction = document.createElement('div');
        newPrediction.className = 'prediction-input';
        newPrediction.innerHTML = `
            <input type="text" placeholder="ãƒ¬ãƒ¼ã‚¹å" class="race-name" />
            <textarea placeholder="äºˆæƒ³é¦¬ï¼ˆæ”¹è¡ŒåŒºåˆ‡ã‚Šï¼‰" rows="3" class="race-horses"></textarea>
            <button type="button" class="remove-prediction">å‰Šé™¤</button>
        `;
        container.appendChild(newPrediction);
        
        // å‰Šé™¤ãƒœã‚¿ãƒ³ã®å‡¦ç†
        newPrediction.querySelector('.remove-prediction')?.addEventListener('click', () => {
            newPrediction.remove();
        });
    });

    // çµæœè¿½åŠ ãƒœã‚¿ãƒ³
    document.getElementById('addResult')?.addEventListener('click', () => {
        const container = document.getElementById('resultsContainer');
        const newResult = document.createElement('div');
        newResult.className = 'result-input';
        newResult.innerHTML = `
            <input type="text" placeholder="ãƒ¬ãƒ¼ã‚¹å" class="result-race-name" />
            <div class="result-details">
                <input type="text" placeholder="1ç€é¦¬" class="result-winner" />
                <input type="text" placeholder="é…å½“ï¼ˆä¾‹: Â¥1,200ï¼‰" class="result-payout" />
                <select class="result-status">
                    <option value="hit">ğŸ¯ çš„ä¸­ï¼</option>
                    <option value="miss">âŒ ä¸çš„ä¸­</option>
                    <option value="near">ğŸ“ˆ æƒœã—ã„ï¼</option>
                </select>
                <button type="button" class="remove-result">å‰Šé™¤</button>
            </div>
        `;
        container.appendChild(newResult);
        
        // å‰Šé™¤ãƒœã‚¿ãƒ³ã®å‡¦ç†
        newResult.querySelector('.remove-result')?.addEventListener('click', () => {
            newResult.remove();
        });
    });

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹é–¢æ•°
    function clearPreview() {
        const previewArea = document.getElementById('previewArea');
        previewArea.innerHTML = '<p class="preview-placeholder">é…ä¿¡å†…å®¹ã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã™ã‚‹ã«ã¯ã€Œãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„</p>';
    }
    
    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆé–¢æ•° - å…¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¿ã‚¤ãƒ—å¯¾å¿œ
    function generatePreview() {
        try {
            const subject = document.getElementById('subject').value;
            const templateType = document.getElementById('templateType').value;
            const mainContent = document.getElementById('mainContent').value;
            
            if (!subject) {
                document.getElementById('previewArea').innerHTML = '<p class="error">ä»¶åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>';
                return;
            }

            // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¿ã‚¤ãƒ—åˆ¥ãƒ‡ãƒ¼ã‚¿åé›†
            let templateData = {
                subject: subject,
                templateType: templateType,
                theme: document.getElementById('customTheme')?.value || 'blue'
            };

            if (templateType === 'prediction') {
                templateData.predictions = collectPredictionData();
            } else if (templateType === 'result') {
                templateData.results = collectResultData();
            } else if (templateType === 'campaign') {
                templateData.campaign = collectCampaignData();
            } else if (templateType === 'custom') {
                templateData.custom = collectCustomData();
            }

            // é«˜åº¦ãªHTMLç”Ÿæˆ
            const htmlContent = generateAdvancedNewsletterHTML(templateData);
            
            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ã«è¡¨ç¤º
            const previewFrame = document.getElementById('previewFrame');
            if (previewFrame) {
                previewFrame.srcdoc = htmlContent;
                console.log('âœ… ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆå®Œäº† - ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¿ã‚¤ãƒ—:', templateType);
            }
            
            // HTMLã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚‚æ›´æ–°
            const htmlContentField = document.getElementById('htmlContent');
            if (htmlContentField) {
                htmlContentField.value = htmlContent;
            }
            
        } catch (error) {
            console.error('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
            document.getElementById('previewArea').innerHTML = '<p class="error">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆã‚¨ãƒ©ãƒ¼: ' + error.message + '</p>';
        }
    }
    
    // äºˆæƒ³ãƒ‡ãƒ¼ã‚¿åé›†
    function collectPredictionData() {
        const races = [];
        for (let i = 1; i <= 3; i++) {
            const raceName = document.getElementById(`race${i}Name`)?.value;
            const horses = [];
            for (let j = 1; j <= 3; j++) {
                const horse = document.getElementById(`race${i}Horse${j}`)?.value;
                if (horse) horses.push(horse);
            }
            if (raceName || horses.length > 0) {
                races.push({ name: raceName || `ç¬¬${i}ãƒ¬ãƒ¼ã‚¹`, horses });
            }
        }
        return { races, highlight: document.getElementById('predictionHighlight')?.value || '' };
    }
    
    // çµæœãƒ‡ãƒ¼ã‚¿åé›†
    function collectResultData() {
        const results = [];
        for (let i = 1; i <= 3; i++) {
            const raceName = document.getElementById(`result${i}Race`)?.value;
            const prediction = document.getElementById(`result${i}Prediction`)?.value;
            const actual = document.getElementById(`result${i}Actual`)?.value;
            const status = document.getElementById(`result${i}Status`)?.value;
            if (raceName || prediction) {
                results.push({ raceName, prediction, actual, status });
            }
        }
        return {
            results,
            monthlyHitRate: document.getElementById('monthlyHitRate')?.value || '',
            monthlyROI: document.getElementById('monthlyROI')?.value || ''
        };
    }
    
    // ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ãƒ‡ãƒ¼ã‚¿åé›†
    function collectCampaignData() {
        return {
            title: document.getElementById('campaignTitle')?.value || '',
            description: document.getElementById('campaignDescription')?.value || '',
            discount: document.getElementById('campaignDiscount')?.value || '',
            period: document.getElementById('campaignPeriod')?.value || '',
            beforePrice: document.getElementById('campaignBeforePrice')?.value || '',
            afterPrice: document.getElementById('campaignAfterPrice')?.value || ''
        };
    }
    
    // ã‚«ã‚¹ã‚¿ãƒ ãƒ‡ãƒ¼ã‚¿åé›†
    function collectCustomData() {
        return {
            headline: document.getElementById('customHeadline')?.value || '',
            message: document.getElementById('customMessage')?.value || '',
            feature1: document.getElementById('customFeature1')?.value || '',
            feature2: document.getElementById('customFeature2')?.value || '',
            feature3: document.getElementById('customFeature3')?.value || ''
        };
    }

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³
    document.getElementById('clearPreviewBtn')?.addEventListener('click', clearPreview);

    // ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›å¤‰æ›´æ™‚ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è‡ªå‹•ã‚¯ãƒªã‚¢
    const formInputs = ['subject', 'mainContent', 'targetPlan', 'templateType', 'scheduledAt'];
    formInputs.forEach(inputId => {
        const element = document.getElementById(inputId);
        element?.addEventListener('input', clearPreview);
        element?.addEventListener('change', clearPreview);
    });

    // äºˆæƒ³å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å¤‰æ›´ã‚‚ç›£è¦–
    document.getElementById('predictionsContainer')?.addEventListener('input', clearPreview);

    // é…ä¿¡å±¥æ­´ã‚’èª­ã¿è¾¼ã‚€é–¢æ•°ï¼ˆLocalStorageä½¿ç”¨ï¼‰
    function loadHistory() {
        const historyArea = document.getElementById('historyArea');
        historyArea.innerHTML = '<p class="loading">èª­ã¿è¾¼ã¿ä¸­...</p>';
        
        try {
            // LocalStorageã‹ã‚‰å±¥æ­´ã‚’å–å¾—
            const historyData = localStorage.getItem('newsletter-history');
            const history = historyData ? JSON.parse(historyData) : [];
            
            if (history.length > 0) {
                const now = new Date();
                
                // æœ€æ–°10ä»¶ã®ã¿è¡¨ç¤º
                const recentHistory = history.slice(0, 10);
                
                const historyHTML = recentHistory.map(item => {
                    const scheduledDate = new Date(item.scheduledAt);
                    const isScheduled = item.status === 'scheduled' && scheduledDate > now;
                    const isCompleted = item.status === 'sent' || (item.status === 'scheduled' && scheduledDate <= now);
                    
                    let statusBadge = '';
                    let statusClass = '';
                    
                    if (isScheduled) {
                        statusBadge = `<span class="status-badge status-scheduled">äºˆç´„ä¸­ ğŸ“…</span>`;
                        statusClass = 'history-scheduled';
                    } else if (isCompleted) {
                        statusBadge = `<span class="status-badge status-sent">é…ä¿¡æ¸ˆã¿ âœ…</span>`;
                        statusClass = 'history-sent';
                    } else {
                        statusBadge = `<span class="status-badge status-unknown">ä¸æ˜</span>`;
                        statusClass = 'history-unknown';
                    }
                    
                    const formatDate = (dateStr) => {
                        const date = new Date(dateStr);
                        return date.toLocaleString('ja-JP', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    };
                    
                    return `
                        <div class="history-item ${statusClass}">
                            <div class="history-header">
                                <h4 class="history-subject">${item.subject}</h4>
                                ${statusBadge}
                            </div>
                            <div class="history-details">
                                <span class="history-plan">å¯¾è±¡: ${item.targetPlan}</span>
                                <span class="history-count">é…ä¿¡æ•°: ${item.recipientCount}ä»¶</span>
                                <span class="history-date">
                                    ${isScheduled ? 'äºˆç´„æ—¥æ™‚' : 'é…ä¿¡æ—¥æ™‚'}: ${formatDate(item.scheduledAt)}
                                </span>
                            </div>
                        </div>
                    `;
                }).join('');
                
                historyArea.innerHTML = `
                    <div class="history-list">
                        ${historyHTML}
                    </div>
                `;
            } else {
                historyArea.innerHTML = '<p class="no-history">é…ä¿¡å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>';
            }
        } catch (error) {
            console.error('å±¥æ­´èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            historyArea.innerHTML = '<p class="error">å±¥æ­´ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
        }
    }

    // å±¥æ­´ã‚’ä¿å­˜ã™ã‚‹é–¢æ•°
    function saveHistoryToLocal(historyItem) {
        try {
            const existingHistory = localStorage.getItem('newsletter-history');
            const history = existingHistory ? JSON.parse(existingHistory) : [];
            
            // æ–°ã—ã„å±¥æ­´ã‚’å…ˆé ­ã«è¿½åŠ 
            history.unshift({
                ...historyItem,
                id: Date.now().toString(), // ç°¡æ˜“ID
                createdAt: new Date().toISOString()
            });
            
            // æœ€å¤§50ä»¶ã¾ã§ä¿æŒ
            const limitedHistory = history.slice(0, 50);
            
            localStorage.setItem('newsletter-history', JSON.stringify(limitedHistory));
            console.log('å±¥æ­´ã‚’LocalStorageã«ä¿å­˜:', historyItem);
        } catch (error) {
            console.error('å±¥æ­´ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        }
    }

    // å±¥æ­´æ›´æ–°ãƒœã‚¿ãƒ³
    document.getElementById('refreshHistoryBtn')?.addEventListener('click', loadHistory);
    
    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³
    document.getElementById('generatePreviewBtn')?.addEventListener('click', generatePreview);

    // ç¾åœ¨æ™‚åˆ»ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
    function updateCurrentTime() {
        const now = new Date();
        const timeString = now.toLocaleString('ja-JP', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
        const currentTimeElement = document.getElementById('currentTime');
        if (currentTimeElement) {
            currentTimeElement.textContent = timeString;
        }
    }

    // ç¾åœ¨æ™‚åˆ»ã‚’1ç§’ã”ã¨ã«æ›´æ–°
    setInterval(updateCurrentTime, 1000);

    // åˆæœŸè¡¨ç¤ºã§å±¥æ­´ã‚’èª­ã¿è¾¼ã¿
    document.addEventListener('DOMContentLoaded', () => {
        loadHistory();
        updateCurrentTime();
        // åˆæœŸçŠ¶æ…‹ã§ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®è¡¨ç¤ºã‚’è¨­å®š
        updateTemplateSection();
        
        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã®ä»£æ›¿å‡¦ç†
        const previewBtn = document.getElementById('generatePreviewBtn');
        if (!previewBtn) {
            console.warn('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ã‚’å‹•çš„ã«ä½œæˆ
            const previewArea = document.getElementById('previewArea');
            if (previewArea && !document.getElementById('generatePreviewBtn')) {
                const newPreviewBtn = document.createElement('button');
                newPreviewBtn.id = 'generatePreviewBtn';
                newPreviewBtn.type = 'button';
                newPreviewBtn.textContent = 'ğŸ” ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆ';
                newPreviewBtn.className = 'btn btn-secondary';
                newPreviewBtn.style.marginBottom = '20px';
                
                previewArea.parentNode.insertBefore(newPreviewBtn, previewArea);
                newPreviewBtn.addEventListener('click', generatePreview);
                
                console.log('âœ… ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ã‚’å‹•çš„ã«ä½œæˆã—ã¾ã—ãŸ');
            }
        } else {
            console.log('âœ… ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ');
        }
        
        console.log('ãƒšãƒ¼ã‚¸åˆæœŸåŒ–å®Œäº†');
    });

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆ
    document.getElementById('previewBtn')?.addEventListener('click', async () => {
        const subject = document.getElementById('subject').value;
        const mainContent = document.getElementById('mainContent').value;
        const templateType = document.getElementById('templateType').value;
        
        if (!subject || !mainContent) {
            alert('ä»¶åã¨æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }

        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¿ã‚¤ãƒ—åˆ¥ã®ãƒ‡ãƒ¼ã‚¿åé›†
        let templateData = {
            title: subject,
            mainContent: mainContent,
            templateType: templateType
        };

        if (templateType === 'prediction') {
            // äºˆæƒ³ãƒ‡ãƒ¼ã‚¿åé›†
            const predictionInputs = document.querySelectorAll('.prediction-input');
            templateData.predictions = Array.from(predictionInputs).map(input => {
                const raceName = input.querySelector('.race-name').value;
                const horses = input.querySelector('.race-horses').value
                    .split('\n')
                    .filter(h => h.trim())
                    .map(h => h.trim());
                return { raceName, horses };
            }).filter(p => p.raceName && p.horses.length > 0);
        } else if (templateType === 'result') {
            // çµæœãƒ‡ãƒ¼ã‚¿åé›†
            const resultInputs = document.querySelectorAll('.result-input');
            templateData.results = Array.from(resultInputs).map(input => {
                const raceName = input.querySelector('.result-race-name').value;
                const winner = input.querySelector('.result-winner').value;
                const payout = input.querySelector('.result-payout').value;
                const status = input.querySelector('.result-status').value;
                return { raceName, winner, payout, status };
            }).filter(r => r.raceName);
            
            templateData.monthlyHitRate = document.getElementById('monthlyHitRate')?.value || '';
            templateData.monthlyProfit = document.getElementById('monthlyProfit')?.value || '';
        } else if (templateType === 'campaign') {
            // ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ãƒ‡ãƒ¼ã‚¿åé›†
            templateData.campaignTitle = document.getElementById('campaignTitle')?.value || '';
            templateData.campaignDetails = document.getElementById('campaignDetails')?.value || '';
            templateData.originalPrice = document.getElementById('originalPrice')?.value || '';
            templateData.campaignPrice = document.getElementById('campaignPrice')?.value || '';
            templateData.campaignDeadline = document.getElementById('campaignDeadline')?.value || '';
            templateData.ctaText = document.getElementById('ctaText')?.value || 'ä»Šã™ãç”³ã—è¾¼ã‚€';
            templateData.ctaUrl = document.getElementById('ctaUrl')?.value || 'https://nankan-analytics.keiba.link/pricing/';
        } else if (templateType === 'custom') {
            // ã‚«ã‚¹ã‚¿ãƒ ãƒ‡ãƒ¼ã‚¿åé›†
            templateData.customTheme = document.getElementById('customTheme')?.value || 'default';
            templateData.customHeadline = document.getElementById('customHeadline')?.value || '';
            templateData.customAccent = document.getElementById('customAccent')?.value || '';
            templateData.customCtaText = document.getElementById('customCtaText')?.value || '';
            templateData.customCtaUrl = document.getElementById('customCtaUrl')?.value || '';
        }

        // HTMLãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”Ÿæˆ
        const htmlContent = generateAdvancedNewsletterHTML(templateData);

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
        const previewArea = document.getElementById('previewArea');
        previewArea.innerHTML = `
            <div class="email-frame">
                <div class="email-header">
                    <strong>ä»¶å:</strong> ${subject}
                </div>
                <iframe srcdoc="${htmlContent.replace(/"/g, '&quot;')}" style="width: 100%; height: 600px; border: 1px solid #ddd;"></iframe>
            </div>
        `;
    });

    // é…ä¿¡å®Ÿè¡Œ
    document.getElementById('sendBtn')?.addEventListener('click', async () => {
        const subject = document.getElementById('subject').value;
        const mainContent = document.getElementById('mainContent').value;
        const targetPlan = document.getElementById('targetPlan').value;
        const templateType = document.getElementById('templateType').value;
        const scheduledAt = document.getElementById('scheduledAt').value;
        
        if (!subject || !mainContent) {
            alert('ä»¶åã¨æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }

        if (!confirm(`${targetPlan === 'all' ? 'å…¨ä¼šå“¡' : targetPlan + 'ä¼šå“¡'}ã«é…ä¿¡ã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) {
            return;
        }

        // äºˆæƒ³ãƒ‡ãƒ¼ã‚¿åé›†
        let predictions = [];
        if (templateType === 'prediction') {
            const predictionInputs = document.querySelectorAll('.prediction-input');
            predictions = Array.from(predictionInputs).map(input => {
                const raceName = input.querySelector('.race-name').value;
                const horses = input.querySelector('.race-horses').value
                    .split('\n')
                    .filter(h => h.trim())
                    .map(h => h.trim());
                return { raceName, horses };
            }).filter(p => p.raceName && p.horses.length > 0);
        }

        // HTMLãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”Ÿæˆ
        const htmlContent = generateNewsletterHTML({
            title: subject,
            mainContent: mainContent,
            predictions: predictions
        });

        try {
            console.log('é…ä¿¡ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ä¸­...', {
                subject,
                targetPlan,
                hasHtmlContent: !!htmlContent,
                scheduledAt
            });

            const response = await fetch('/.netlify/functions/send-newsletter', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    subject,
                    htmlContent,
                    targetPlan,
                    scheduledAt: scheduledAt || null
                })
            });

            console.log('ãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡:', response.status, response.statusText);

            // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å…ˆã«å–å¾—
            const responseText = await response.text();
            console.log('ãƒ¬ã‚¹ãƒãƒ³ã‚¹å†…å®¹:', responseText);

            let result;
            try {
                result = JSON.parse(responseText);
            } catch (parseError) {
                console.error('JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', parseError);
                console.error('ãƒ‘ãƒ¼ã‚¹å¤±æ•—ã—ãŸãƒ†ã‚­ã‚¹ãƒˆ:', responseText);
                alert(`âŒ é…ä¿¡å¤±æ•—: ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®å¿œç­”ã‚’è§£æã§ãã¾ã›ã‚“ã§ã—ãŸ\nã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${response.status}\nè©³ç´°ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„`);
                return;
            }
            
            if (response.ok) {
                const successMessage = result.isScheduled 
                    ? `âœ… é…ä¿¡äºˆç´„å®Œäº†ï¼${result.recipientCount}ä»¶ã®é…ä¿¡ã‚’äºˆç´„ã—ã¾ã—ãŸ`
                    : `âœ… é…ä¿¡æˆåŠŸï¼${result.recipientCount}ä»¶ã«é…ä¿¡ã—ã¾ã—ãŸ`;
                    
                alert(successMessage);
                
                // å±¥æ­´ã«ä¿å­˜
                saveHistoryToLocal({
                    subject: subject,
                    targetPlan: targetPlan,
                    recipientCount: result.recipientCount,
                    scheduledAt: scheduledAt || new Date().toISOString(),
                    status: result.isScheduled ? 'scheduled' : 'sent'
                });
                
                // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
                document.getElementById('subject').value = '';
                document.getElementById('mainContent').value = '';
                document.getElementById('targetPlan').value = 'all';
                document.getElementById('templateType').value = 'prediction';
                document.getElementById('scheduledAt').value = '';
                // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚‚ã‚¯ãƒªã‚¢
                clearPreview();
                
                // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¿ã‚¤ãƒ—ã‚’ãƒªã‚»ãƒƒãƒˆå¾Œã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°
                setTimeout(() => {
                    updateTemplateSection();
                }, 100);
                
                // å±¥æ­´ã‚’æ›´æ–°
                loadHistory();
            } else {
                console.error('é…ä¿¡ã‚¨ãƒ©ãƒ¼è©³ç´°:', result);
                alert(`âŒ é…ä¿¡å¤±æ•—: ${result.error || result.details || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'}\nè©³ç´°ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„`);
            }
        } catch (error) {
            console.error('é…ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
            alert(`é…ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
        }
    });

    // æ–°ã—ã„çµ±åˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”Ÿæˆé–¢æ•°
    function generateAdvancedNewsletterHTML(templateData) {
        const { 
            title, 
            mainContent, 
            templateType,
            predictions = [],
            results = [],
            monthlyHitRate = '',
            monthlyProfit = '',
            campaignTitle = '',
            campaignDetails = '',
            originalPrice = '',
            campaignPrice = '',
            campaignDeadline = '',
            ctaText = 'ä»Šã™ãç”³ã—è¾¼ã‚€',
            ctaUrl = 'https://nankan-analytics.keiba.link/pricing/',
            customTheme = 'default',
            customHeadline = '',
            customAccent = '',
            customCtaText = '',
            customCtaUrl = ''
        } = templateData;

        // ãƒ†ãƒ¼ãƒåˆ¥ã®ã‚¹ã‚¿ã‚¤ãƒ«
        let themeStyles = '';
        let headerClass = 'header';
        
        if (customTheme === 'gold') {
            themeStyles = `
                .header { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
                .prediction-card, .result-card, .campaign-card { border-left-color: #f59e0b; background: #fefbf3; }
                .cta-button { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
            `;
        } else if (customTheme === 'red') {
            themeStyles = `
                .header { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
                .prediction-card, .result-card, .campaign-card { border-left-color: #ef4444; background: #fef2f2; }
                .cta-button { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
            `;
        } else if (customTheme === 'blue') {
            themeStyles = `
                .header { background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); }
                .prediction-card, .result-card, .campaign-card { border-left-color: #3b82f6; background: #eff6ff; }
                .cta-button { background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); }
            `;
        }

        // ã‚«ã‚¹ã‚¿ãƒ ãƒ˜ãƒƒãƒ‰ãƒ©ã‚¤ãƒ³
        const customHeadlineHTML = customHeadline ? `
            <div style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); padding: 20px; margin: 20px 0; border-radius: 12px; border-left: 4px solid #ef4444; text-align: center;">
                <h2 style="color: #dc2626; font-size: 24px; font-weight: bold; margin: 0;">${customHeadline}</h2>
            </div>
        ` : '';

        // ã‚«ã‚¹ã‚¿ãƒ ã‚¢ã‚¯ã‚»ãƒ³ãƒˆ
        const customAccentHTML = customAccent ? `
            <div style="background: #f0f9ff; border-radius: 12px; padding: 20px; margin: 20px 0; border-left: 4px solid #0ea5e9;">
                <div style="color: #0c4a6e; font-size: 18px; font-weight: 600; line-height: 1.6; white-space: pre-wrap;">${customAccent}</div>
            </div>
        ` : '';

        return `
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${title}</title>
    <style>
        body { margin: 0; padding: 0; font-family: 'Helvetica Neue', Arial, sans-serif; background-color: #f5f5f5; }
        .container { max-width: 600px; margin: 0 auto; background-color: #ffffff; }
        .header { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: white; padding: 40px 30px; text-align: center; }
        .logo { font-size: 28px; font-weight: bold; margin-bottom: 10px; }
        .tagline { font-size: 14px; color: #94a3b8; }
        .content { padding: 40px 30px; }
        .prediction-card, .result-card, .campaign-card { background: #f8fafc; border-radius: 12px; padding: 20px; margin-bottom: 20px; border-left: 4px solid #3b82f6; }
        .race-title { font-size: 18px; font-weight: bold; color: #1e293b; margin-bottom: 10px; }
        .horses, .result-details { margin: 10px 0; }
        .horse-item, .result-item { padding: 5px 0; color: #475569; }
        .hit-status { font-weight: bold; }
        .hit-status.hit { color: #059669; }
        .hit-status.miss { color: #dc2626; }
        .hit-status.near { color: #d97706; }
        .campaign-highlight { background: #fef3c7; border-radius: 8px; padding: 15px; margin: 15px 0; border-left: 4px solid #f59e0b; }
        .price-comparison { display: flex; align-items: center; gap: 15px; margin: 15px 0; }
        .original-price { text-decoration: line-through; color: #6b7280; font-size: 18px; }
        .campaign-price { color: #dc2626; font-size: 24px; font-weight: bold; }
        .deadline { background: #fee2e2; color: #dc2626; padding: 8px 12px; border-radius: 6px; font-weight: bold; }
        .cta-button { display: inline-block; background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; padding: 15px 40px; text-decoration: none; border-radius: 8px; font-weight: bold; margin: 30px 0; }
        .stats-section { background: #f0f9ff; border-radius: 12px; padding: 20px; margin: 20px 0; border-left: 4px solid #0ea5e9; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
        .stat-item { text-align: center; background: white; padding: 15px; border-radius: 8px; }
        .stat-number { font-size: 24px; font-weight: bold; color: #0c4a6e; }
        .stat-label { font-size: 14px; color: #64748b; }
        .footer { background: #f1f5f9; padding: 30px; text-align: center; color: #64748b; font-size: 12px; }
        ${themeStyles}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">ğŸ‡ NANKANã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹</div>
            <div class="tagline">AIãƒ»æ©Ÿæ¢°å­¦ç¿’ã§å‹ã¤å—é–¢ç«¶é¦¬</div>
        </div>
        
        <div class="content">
            ${customHeadlineHTML}
            
            <div style="color: #475569; line-height: 1.8; white-space: pre-wrap;">
${mainContent}
            </div>
            
            ${customAccentHTML}
            
            ${templateType === 'prediction' && predictions.length > 0 ? `
            <h3 style="color: #1e293b; margin-top: 40px; margin-bottom: 20px;">ğŸ¯ æœ¬æ—¥ã®æ³¨ç›®äºˆæƒ³</h3>
            ${predictions.map(p => `
            <div class="prediction-card">
                <div class="race-title">ğŸ ${p.raceName}</div>
                <div class="horses">
                    ${p.horses.map(h => `<div class="horse-item">â— ${h}</div>`).join('')}
                </div>
            </div>
            `).join('')}
            ` : ''}
            
            ${templateType === 'result' && results.length > 0 ? `
            <h3 style="color: #1e293b; margin-top: 40px; margin-bottom: 20px;">ğŸ“Š æ˜¨æ—¥ã®çµæœ</h3>
            ${results.map(r => `
            <div class="result-card">
                <div class="race-title">ğŸ ${r.raceName}</div>
                <div class="result-details">
                    <div class="result-item">1ç€: <strong>${r.winner}</strong></div>
                    <div class="result-item">é…å½“: <strong>${r.payout}</strong></div>
                    <div class="result-item hit-status ${r.status}">${r.status === 'hit' ? 'ğŸ¯ çš„ä¸­ï¼' : r.status === 'near' ? 'ğŸ“ˆ æƒœã—ã„ï¼' : 'âŒ ä¸çš„ä¸­'}</div>
                </div>
            </div>
            `).join('')}
            ${(monthlyHitRate || monthlyProfit) ? `
            <div class="stats-section">
                <h4 style="color: #0c4a6e; margin-top: 0;">ğŸ“ˆ ä»Šæœˆã®å®Ÿç¸¾</h4>
                <div class="stats-grid">
                    ${monthlyHitRate ? `
                    <div class="stat-item">
                        <div class="stat-number">${monthlyHitRate}</div>
                        <div class="stat-label">çš„ä¸­ç‡</div>
                    </div>` : ''}
                    ${monthlyProfit ? `
                    <div class="stat-item">
                        <div class="stat-number">${monthlyProfit}</div>
                        <div class="stat-label">åæ”¯</div>
                    </div>` : ''}
                </div>
            </div>
            ` : ''}
            ` : ''}
            
            ${templateType === 'campaign' && campaignTitle ? `
            <div class="campaign-highlight">
                <h3 style="color: #92400e; margin-top: 0;">ğŸª ${campaignTitle}</h3>
                <p style="color: #78350f; line-height: 1.6;">${campaignDetails}</p>
                ${originalPrice && campaignPrice ? `
                <div class="price-comparison">
                    <span class="original-price">${originalPrice}</span>
                    <span style="color: #dc2626;">â†’</span>
                    <span class="campaign-price">${campaignPrice}</span>
                </div>
                ` : ''}
                ${campaignDeadline ? `<div class="deadline">æœŸé™: ${campaignDeadline}</div>` : ''}
            </div>
            ` : ''}
            
            <div style="text-align: center;">
                <a href="${ctaUrl}" class="cta-button">${ctaText}</a>
                ${customCtaText && customCtaUrl ? `
                <br><a href="${customCtaUrl}" class="cta-button" style="margin-top: 10px;">${customCtaText}</a>
                ` : ''}
            </div>
        </div>
        
        <div class="footer">
            <p>Â© 2025 NANKANã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹</p>
        </div>
    </div>
</body>
</html>
        `;
    }

    // æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨ã®äº’æ›æ€§ã®ãŸã‚ã®é–¢æ•°
    // é«˜åº¦ãªãƒ‹ãƒ¥ãƒ¼ã‚ºãƒ¬ã‚¿ãƒ¼HTMLç”Ÿæˆ - å…¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¿ã‚¤ãƒ—å¯¾å¿œ
    function generateAdvancedNewsletterHTML(data) {
        const themeColors = {
            gold: { primary: '#f59e0b', secondary: '#fbbf24', background: '#fef3c7', text: '#92400e' },
            red: { primary: '#dc2626', secondary: '#ef4444', background: '#fee2e2', text: '#991b1b' },
            blue: { primary: '#3b82f6', secondary: '#60a5fa', background: '#dbeafe', text: '#1e40af' }
        };
        const theme = themeColors[data.theme] || themeColors.blue;
        
        let contentSection = '';
        
        if (data.templateType === 'prediction' && data.predictions) {
            contentSection = generatePredictionContent(data.predictions, theme);
        } else if (data.templateType === 'result' && data.results) {
            contentSection = generateResultContent(data.results, theme);
        } else if (data.templateType === 'campaign' && data.campaign) {
            contentSection = generateCampaignContent(data.campaign, theme);
        } else if (data.templateType === 'custom' && data.custom) {
            contentSection = generateCustomContent(data.custom, theme);
        }
        
        return `
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${data.subject}</title>
    <style>
        body { margin: 0; padding: 0; font-family: 'Helvetica Neue', Arial, sans-serif; background-color: #f5f5f5; }
        .container { max-width: 600px; margin: 0 auto; background-color: #ffffff; }
        .header { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: white; padding: 40px 30px; text-align: center; }
        .logo { font-size: 28px; font-weight: bold; margin-bottom: 10px; }
        .tagline { font-size: 14px; color: #94a3b8; }
        .content { padding: 40px 30px; }
        .section-title { font-size: 24px; color: #0f172a; margin-bottom: 20px; font-weight: bold; }
        .themed-card { background: ${theme.background}; border-radius: 12px; padding: 20px; margin-bottom: 20px; border-left: 4px solid ${theme.primary}; }
        .themed-text { color: ${theme.text}; }
        .themed-button { display: inline-block; background: linear-gradient(135deg, ${theme.primary} 0%, ${theme.secondary} 100%); color: white; padding: 15px 40px; text-decoration: none; border-radius: 8px; font-weight: bold; margin: 10px 5px; }
        .footer { background: #f1f5f9; padding: 30px; text-align: center; color: #64748b; font-size: 12px; }
        .highlight-box { background: linear-gradient(135deg, ${theme.primary}20 0%, ${theme.secondary}20 100%); padding: 20px; border-radius: 8px; margin: 20px 0; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">ğŸ‡ NANKANã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹</div>
            <div class="tagline">AIãƒ»æ©Ÿæ¢°å­¦ç¿’ã§å‹ã¤å—é–¢ç«¶é¦¬</div>
        </div>
        
        <div class="content">
            <h2 class="section-title">${data.subject}</h2>
            ${contentSection}
            
            <div style="text-align: center; margin-top: 40px;">
                <a href="https://nankan-analytics.keiba.link/pricing/" class="themed-button">æœ‰æ–™ãƒ—ãƒ©ãƒ³ã§å…¨ãƒ¬ãƒ¼ã‚¹äºˆæƒ³ã‚’è¦‹ã‚‹</a>
            </div>
        </div>
        
        <div class="footer">
            <p>ã“ã®ãƒ¡ãƒ¼ãƒ«ã¯ NANKANã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ ã‹ã‚‰é…ä¿¡ã•ã‚Œã¦ã„ã¾ã™ã€‚</p>
            <p>Â© 2025 NANKANã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ All Rights Reserved.</p>
        </div>
    </div>
</body>
</html>
        `;
    }
    
    // äºˆæƒ³ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”Ÿæˆ
    function generatePredictionContent(predictions, theme) {
        let content = `
            <div class="highlight-box">
                <h3 style="color: ${theme.text}; margin-top: 0;">ğŸ¯ AIè§£æã«ã‚ˆã‚‹æœ¬æ—¥ã®å³é¸äºˆæƒ³</h3>
                <p style="color: ${theme.text};">æ©Ÿæ¢°å­¦ç¿’ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ãŒå°ãå‡ºã—ãŸé«˜ç¢ºç‡äºˆæƒ³ã‚’ãŠå±Šã‘ã—ã¾ã™ã€‚</p>
            </div>
        `;
        
        if (predictions.highlight) {
            content += `
                <div class="themed-card">
                    <h4 class="themed-text">âœ¨ æœ¬æ—¥ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ</h4>
                    <p class="themed-text">${predictions.highlight}</p>
                </div>
            `;
        }
        
        if (predictions.races && predictions.races.length > 0) {
            content += '<h3 style="margin-top: 30px;">ğŸ ãƒ¬ãƒ¼ã‚¹äºˆæƒ³</h3>';
            predictions.races.forEach(race => {
                content += `
                    <div class="themed-card">
                        <h4 class="themed-text">ğŸ‡ ${race.name}</h4>
                        ${race.horses.map(horse => `<p class="themed-text">â€¢ ${horse}</p>`).join('')}
                    </div>
                `;
            });
        }
        
        return content;
    }
    
    // çµæœå ±å‘Šãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”Ÿæˆ
    function generateResultContent(results, theme) {
        let content = `
            <div class="highlight-box">
                <h3 style="color: ${theme.text}; margin-top: 0;">ğŸ“Š æ˜¨æ—¥ã®äºˆæƒ³çµæœå ±å‘Š</h3>
                <p style="color: ${theme.text};">é€æ˜æ€§ã®ã‚ã‚‹çµæœå ±å‘Šã§ä¿¡é ¼ã‚’ãŠå±Šã‘ã—ã¾ã™ã€‚</p>
            </div>
        `;
        
        if (results.monthlyHitRate || results.monthlyROI) {
            content += `
                <div class="themed-card">
                    <h4 class="themed-text">ğŸ“ˆ ä»Šæœˆã®å®Ÿç¸¾ã‚µãƒãƒªãƒ¼</h4>
                    ${results.monthlyHitRate ? `<p class="themed-text">çš„ä¸­ç‡: <strong>${results.monthlyHitRate}</strong></p>` : ''}
                    ${results.monthlyROI ? `<p class="themed-text">æŠ•è³‡åç›Šç‡: <strong>${results.monthlyROI}</strong></p>` : ''}
                </div>
            `;
        }
        
        if (results.results && results.results.length > 0) {
            content += '<h3 style="margin-top: 30px;">ğŸ¯ å€‹åˆ¥ãƒ¬ãƒ¼ã‚¹çµæœ</h3>';
            results.results.forEach(result => {
                const statusIcon = result.status === 'hit' ? 'âœ…' : result.status === 'miss' ? 'âŒ' : 'â³';
                const statusText = result.status === 'hit' ? 'çš„ä¸­' : result.status === 'miss' ? 'ä¸çš„ä¸­' : 'æœªç¢ºå®š';
                content += `
                    <div class="themed-card">
                        <h4 class="themed-text">${statusIcon} ${result.raceName || 'äºˆæƒ³ãƒ¬ãƒ¼ã‚¹'}</h4>
                        <p class="themed-text">äºˆæƒ³: ${result.prediction}</p>
                        ${result.actual ? `<p class="themed-text">çµæœ: ${result.actual}</p>` : ''}
                        <p class="themed-text">åˆ¤å®š: <strong>${statusText}</strong></p>
                    </div>
                `;
            });
        }
        
        return content;
    }
    
    // ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”Ÿæˆ
    function generateCampaignContent(campaign, theme) {
        let content = `
            <div class="highlight-box">
                <h3 style="color: ${theme.text}; margin-top: 0;">ğŸª ${campaign.title || 'ç‰¹åˆ¥ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³é–‹å‚¬ä¸­'}</h3>
                <p style="color: ${theme.text};">æœŸé–“é™å®šã®ç‰¹åˆ¥ã‚ªãƒ•ã‚¡ãƒ¼ã‚’ãŠè¦‹é€ƒã—ãªãï¼</p>
            </div>
        `;
        
        if (campaign.description) {
            content += `
                <div class="themed-card">
                    <h4 class="themed-text">ğŸ“‹ ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³è©³ç´°</h4>
                    <p class="themed-text">${campaign.description}</p>
                </div>
            `;
        }
        
        if (campaign.beforePrice && campaign.afterPrice) {
            content += `
                <div class="themed-card">
                    <h4 class="themed-text">ğŸ’° ç‰¹åˆ¥ä¾¡æ ¼</h4>
                    <p class="themed-text">é€šå¸¸ä¾¡æ ¼: <span style="text-decoration: line-through; color: #6b7280;">${campaign.beforePrice}</span></p>
                    <p class="themed-text">ç‰¹åˆ¥ä¾¡æ ¼: <strong style="color: ${theme.primary}; font-size: 1.2em;">${campaign.afterPrice}</strong></p>
                    ${campaign.discount ? `<p class="themed-text">å‰²å¼•é¡: <strong>${campaign.discount}</strong></p>` : ''}
                </div>
            `;
        }
        
        if (campaign.period) {
            content += `
                <div class="themed-card">
                    <h4 class="themed-text">â° ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³æœŸé–“</h4>
                    <p class="themed-text">${campaign.period}</p>
                </div>
            `;
        }
        
        return content;
    }
    
    // ã‚«ã‚¹ã‚¿ãƒ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”Ÿæˆ
    function generateCustomContent(custom, theme) {
        let content = '';
        
        if (custom.headline) {
            content += `
                <div class="highlight-box">
                    <h3 style="color: ${theme.text}; margin-top: 0;">${custom.headline}</h3>
                </div>
            `;
        }
        
        if (custom.message) {
            content += `
                <div class="themed-card">
                    <p class="themed-text">${custom.message}</p>
                </div>
            `;
        }
        
        const features = [custom.feature1, custom.feature2, custom.feature3].filter(f => f);
        if (features.length > 0) {
            content += `
                <div class="themed-card">
                    <h4 class="themed-text">âœ¨ ç‰¹å¾´ãƒ»ãƒ¡ãƒªãƒƒãƒˆ</h4>
                    ${features.map(feature => `<p class="themed-text">â€¢ ${feature}</p>`).join('')}
                </div>
            `;
        }
        
        return content;
    }
    
    function generateNewsletterHTML({ title, mainContent, predictions = [] }) {
        return generateAdvancedNewsletterHTML({
            title,
            mainContent,
            templateType: 'prediction',
            predictions
        });
    }
        return `
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${title}</title>
    <style>
        body { margin: 0; padding: 0; font-family: 'Helvetica Neue', Arial, sans-serif; background-color: #f5f5f5; }
        .container { max-width: 600px; margin: 0 auto; background-color: #ffffff; }
        .header { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: white; padding: 40px 30px; text-align: center; }
        .logo { font-size: 28px; font-weight: bold; margin-bottom: 10px; }
        .tagline { font-size: 14px; color: #94a3b8; }
        .content { padding: 40px 30px; }
        .section-title { font-size: 24px; color: #0f172a; margin-bottom: 20px; font-weight: bold; }
        .prediction-card { background: #f8fafc; border-radius: 12px; padding: 20px; margin-bottom: 20px; border-left: 4px solid #3b82f6; }
        .race-title { font-size: 18px; font-weight: bold; color: #1e293b; margin-bottom: 10px; }
        .horses { margin: 10px 0; }
        .horse-item { padding: 5px 0; color: #475569; }
        .cta-button { display: inline-block; background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; padding: 15px 40px; text-decoration: none; border-radius: 8px; font-weight: bold; margin: 30px 0; }
        .footer { background: #f1f5f9; padding: 30px; text-align: center; color: #64748b; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">ğŸ‡ NANKANã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹</div>
            <div class="tagline">AIãƒ»æ©Ÿæ¢°å­¦ç¿’ã§å‹ã¤å—é–¢ç«¶é¦¬</div>
        </div>
        
        <div class="content">
            <div style="color: #475569; line-height: 1.8; white-space: pre-wrap;">
${mainContent}
            </div>
            
            ${predictions.length > 0 ? `
            <h3 style="color: #1e293b; margin-top: 40px; margin-bottom: 20px;">ğŸ¯ æœ¬æ—¥ã®æ³¨ç›®äºˆæƒ³</h3>
            ${predictions.map(p => `
            <div class="prediction-card">
                <div class="race-title">ğŸ ${p.raceName}</div>
                <div class="horses">
                    ${p.horses.map(h => `<div class="horse-item">â— ${h}</div>`).join('')}
                </div>
            </div>
            `).join('')}
            ` : ''}
            
            <div style="text-align: center;">
                <a href="https://nankan-analytics.keiba.link/pricing/" class="cta-button">
                    æœ‰æ–™ãƒ—ãƒ©ãƒ³ã§å…¨ãƒ¬ãƒ¼ã‚¹äºˆæƒ³ã‚’è¦‹ã‚‹
                </a>
            </div>
        </div>
        
        <div class="footer">
            <p>Â© 2025 NANKANã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹</p>
        </div>
    </div>
</body>
</html>
        `;
    }
</script>

<style>
    .newsletter-admin {
        min-height: 100vh;
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        color: #e2e8f0;
        padding: 2rem;
    }

    .admin-header {
        text-align: center;
        margin-bottom: 3rem;
    }

    .admin-header h1 {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
    }

    .subtitle {
        color: #94a3b8;
        font-size: 1.125rem;
    }

    .admin-container {
        max-width: 1200px;
        margin: 0 auto;
        display: grid;
        gap: 2rem;
    }

    .card {
        background: rgba(30, 41, 59, 0.9);
        border-radius: 1rem;
        padding: 2rem;
        border: 1px solid rgba(51, 65, 85, 0.5);
    }

    .card h2 {
        margin-top: 0;
        color: #f1f5f9;
        margin-bottom: 1.5rem;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        color: #cbd5e1;
        font-weight: 500;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 0.75rem;
        background: rgba(15, 23, 42, 0.5);
        border: 1px solid rgba(51, 65, 85, 0.5);
        border-radius: 0.5rem;
        color: #e2e8f0;
        font-size: 1rem;
    }

    .form-group small {
        display: block;
        margin-top: 0.25rem;
        color: #64748b;
    }

    .prediction-input {
        background: rgba(15, 23, 42, 0.3);
        padding: 1rem;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
        display: grid;
        gap: 0.5rem;
    }

    .prediction-input input,
    .prediction-input textarea {
        width: 100%;
        padding: 0.5rem;
        background: rgba(30, 41, 59, 0.8);
        border: 1px solid rgba(51, 65, 85, 0.5);
        border-radius: 0.25rem;
        color: #e2e8f0;
    }

    .remove-prediction {
        background: #ef4444;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 0.25rem;
        cursor: pointer;
        font-size: 0.875rem;
    }

    .button-group {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
    }

    .btn-primary,
    .btn-secondary {
        padding: 0.75rem 2rem;
        border: none;
        border-radius: 0.5rem;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-primary {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        color: white;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
    }

    .btn-secondary {
        background: #475569;
        color: #e2e8f0;
    }

    .btn-secondary:hover {
        background: #64748b;
    }

    .preview-container {
        background: rgba(15, 23, 42, 0.5);
        border-radius: 0.5rem;
        padding: 1rem;
        min-height: 200px;
    }

    .preview-placeholder {
        color: #64748b;
        text-align: center;
        padding: 3rem;
    }

    .email-frame {
        background: white;
        border-radius: 0.5rem;
        overflow: hidden;
    }

    .email-header {
        background: #f1f5f9;
        padding: 1rem;
        color: #1e293b;
        border-bottom: 1px solid #e2e8f0;
    }

    .loading {
        color: #64748b;
        text-align: center;
        padding: 2rem;
    }

    /* é…ä¿¡å±¥æ­´ã‚¹ã‚¿ã‚¤ãƒ« */
    .history-controls {
        margin-bottom: 1rem;
        text-align: right;
    }

    .history-list {
        max-height: 600px;
        overflow-y: auto;
        border-radius: 0.5rem;
        border: 1px solid rgba(51, 65, 85, 0.3);
    }

    .history-item {
        padding: 1rem;
        border-bottom: 1px solid rgba(51, 65, 85, 0.2);
        transition: background-color 0.2s ease;
    }

    .history-item:last-child {
        border-bottom: none;
    }

    .history-item:hover {
        background: rgba(59, 130, 246, 0.1);
    }

    .history-scheduled {
        background: rgba(251, 191, 36, 0.1);
        border-left: 4px solid #f59e0b;
    }

    .history-sent {
        background: rgba(16, 185, 129, 0.1);
        border-left: 4px solid #10b981;
    }

    .history-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 0.5rem;
    }

    .history-subject {
        margin: 0;
        color: #f1f5f9;
        font-size: 1.125rem;
        font-weight: 600;
        flex: 1;
        margin-right: 1rem;
    }

    .status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.875rem;
        font-weight: 500;
        white-space: nowrap;
    }

    .status-scheduled {
        background: #fbbf24;
        color: #92400e;
    }

    .status-sent {
        background: #10b981;
        color: #065f46;
    }

    .status-unknown {
        background: #6b7280;
        color: #f3f4f6;
    }

    .history-details {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        font-size: 0.875rem;
        color: #94a3b8;
    }

    .history-plan {
        color: #3b82f6;
        font-weight: 500;
    }

    .history-count {
        color: #8b5cf6;
        font-weight: 500;
    }

    .history-date {
        color: #64748b;
    }

    .no-history, .error {
        text-align: center;
        padding: 3rem;
        color: #64748b;
    }

    .error {
        color: #ef4444;
    }

    /* å„ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
    #predictionSection,
    #resultSection,
    #campaignSection,
    #customSection {
        display: block; /* JavaScriptã§åˆ¶å¾¡ */
        margin-top: 1.5rem;
        padding: 1.5rem;
        background: rgba(15, 23, 42, 0.3);
        border-radius: 0.75rem;
        border: 1px solid rgba(51, 65, 85, 0.3);
    }

    #predictionSection h3,
    #resultSection h3,
    #campaignSection h3,
    #customSection h3 {
        margin-top: 0;
        color: #f1f5f9;
        margin-bottom: 1rem;
    }

    /* çµæœå ±å‘Šã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .result-input {
        background: rgba(30, 41, 59, 0.8);
        padding: 1rem;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
        display: grid;
        gap: 0.75rem;
    }

    .result-details {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr auto;
        gap: 0.5rem;
        align-items: center;
    }

    .total-stats {
        margin-top: 1.5rem;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        padding: 1rem;
        background: rgba(59, 130, 246, 0.1);
        border-radius: 0.5rem;
        border-left: 4px solid #3b82f6;
    }

    /* ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .campaign-inputs {
        display: grid;
        gap: 1rem;
    }

    .campaign-inputs input,
    .campaign-inputs textarea {
        padding: 0.75rem;
        background: rgba(30, 41, 59, 0.8);
        border: 1px solid rgba(51, 65, 85, 0.5);
        border-radius: 0.5rem;
        color: #e2e8f0;
    }

    /* ã‚«ã‚¹ã‚¿ãƒ ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .custom-inputs {
        display: grid;
        gap: 1rem;
    }

    .custom-inputs label {
        color: #cbd5e1;
        font-weight: 500;
        margin-bottom: 0.25rem;
        display: block;
    }

    .custom-inputs input,
    .custom-inputs textarea,
    .custom-inputs select {
        padding: 0.75rem;
        background: rgba(30, 41, 59, 0.8);
        border: 1px solid rgba(51, 65, 85, 0.5);
        border-radius: 0.5rem;
        color: #e2e8f0;
    }

    .remove-result {
        background: #ef4444;
        color: white;
        border: none;
        padding: 0.5rem;
        border-radius: 0.25rem;
        cursor: pointer;
        font-size: 0.875rem;
    }

    .remove-result:hover {
        background: #dc2626;
    }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
    @media (max-width: 768px) {
        .history-header {
            flex-direction: column;
            align-items: flex-start;
        }

        .history-subject {
            margin-right: 0;
            margin-bottom: 0.5rem;
        }

        .history-details {
            flex-direction: column;
            gap: 0.25rem;
        }

        .status-badge {
            align-self: flex-start;
        }
    }
</style>