---
// ç®¡ç†è€…ç”¨ãƒ¡ãƒ«ãƒã‚¬é…ä¿¡ãƒšãƒ¼ã‚¸
export const prerender = true;
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout title="ãƒ¡ãƒ«ãƒã‚¬é…ä¿¡ç®¡ç† - NANKANã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹">
    <style>
        /* ãƒ¢ãƒ€ãƒ³ãªç®¡ç†ç”»é¢ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .newsletter-admin {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }
        
        /* å¼·åˆ¶çš„ã«ãƒ†ã‚­ã‚¹ãƒˆè‰²ã‚’ç¢ºä¿ */
        .newsletter-admin * {
            color: inherit !important;
        }
        
        .newsletter-admin h1, 
        .newsletter-admin h2, 
        .newsletter-admin h3, 
        .newsletter-admin h4,
        .newsletter-admin p,
        .newsletter-admin span,
        .newsletter-admin div,
        .newsletter-admin label,
        .newsletter-admin small {
            color: #1f2937 !important;
        }
        
        .admin-header {
            text-align: center;
            color: white !important;
            margin-bottom: 40px;
            padding: 40px 20px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            z-index: 1;
        }
        
        .admin-header h1,
        .admin-header p {
            color: white !important;
        }
        
        .admin-header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin: 0;
        }
        
        .admin-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        @media (max-width: 1024px) {
            .admin-container {
                grid-template-columns: 1fr;
            }
        }
        
        .card {
            background: #ffffff !important;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            border: 1px solid #e2e8f0;
            position: relative;
            z-index: 1;
            color: #1f2937 !important;
        }
        
        .card * {
            color: #1f2937 !important;
        }
        
        .card h2 {
            color: #1f2937 !important;
            font-size: 1.5rem;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }
        
        .card h2::before {
            content: 'ğŸ¨';
            font-size: 1.2em;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            background: white;
            box-sizing: border-box;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }
        
        .template-sections {
            margin: 25px 0;
        }
        
        .template-section {
            background: #ffffff;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
            border: 1px solid #e2e8f0;
            position: relative;
            z-index: 5;
        }
        
        .template-section h3 {
            color: #4b5563;
            margin-bottom: 15px;
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        @media (max-width: 768px) {
            .input-row {
                grid-template-columns: 1fr;
            }
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
            color: white;
        }
        
        .btn-info {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            color: white;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e2e8f0;
        }
        
        .preview-area {
            background: #f7fafc;
            border-radius: 15px;
            padding: 20px;
            border: 2px dashed #cbd5e0;
            min-height: 400px;
        }
        
        .preview-frame {
            width: 100%;
            height: 600px;
            border: none;
            border-radius: 10px;
            background: white;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        /* æ ¹æœ¬è§£æ±º: å±¥æ­´ã‚¹ã‚¿ã‚¤ãƒ« */
        .new-history-item {
            background: #ffffff !important;
            border: 2px solid #d1d5db !important;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 5px solid #3b82f6 !important;
        }
        
        .new-history-title {
            font-size: 1.2rem !important;
            font-weight: 700 !important;
            color: #000000 !important;
            margin-bottom: 10px;
        }
        
        .new-history-info {
            font-size: 1rem !important;
            color: #000000 !important;
            line-height: 1.6;
            font-weight: 600 !important;
        }
        
        .new-status-sent {
            display: inline-block !important;
            background: #059669 !important;
            color: #ffffff !important;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9rem !important;
            font-weight: 600 !important;
            margin-left: 10px;
        }
        
        /* å‰Šé™¤æ¸ˆã¿ - æ–°ã—ã„ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¹ã‚¿ã‚¤ãƒ«ã‚’ä½¿ç”¨ */
        
        .new-no-history {
            text-align: center;
            color: #000000 !important;
            font-weight: 700 !important;
            padding: 40px 20px;
            background: #ffffff !important;
            border-radius: 10px;
            border: 2px solid #d1d5db !important;
            font-size: 1.2rem !important;
        }
        
        /* å¼·åˆ¶çš„ã«ã™ã¹ã¦ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’è¦‹ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹ */
        #newHistoryArea * {
            color: #000000 !important;
            background-color: transparent !important;
        }
        
        .error {
            color: #dc2626;
            background: #fee2e2;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #fca5a5;
            font-weight: 500;
        }
        
        /* å¤ã„ã‚¹ã‚¿ã‚¤ãƒ«å‰Šé™¤æ¸ˆã¿ - æ–°ã—ã„ã‚·ãƒ³ãƒ—ãƒ«ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ä½¿ç”¨ */
        
        @media (max-width: 768px) {
            .new-history-item {
                padding: 15px;
            }
            
            .new-history-title {
                font-size: 1.1rem;
            }
            
            .new-history-info {
                font-size: 0.95rem;
            }
        }
        
        .current-time {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-family: monospace;
            font-size: 0.9rem;
            text-align: center;
            margin: 20px 0;
        }
        
        /* ãƒ¢ãƒ€ãƒ³ãªã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .campaign-preview {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            padding: 30px;
            border-radius: 20px;
            margin: 20px 0;
            position: relative;
            overflow: hidden;
        }
        
        .campaign-preview::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.1);
            transform: rotate(45deg);
        }
        
        .campaign-title {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 15px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .price-showcase {
            display: flex;
            align-items: center;
            gap: 20px;
            margin: 20px 0;
        }
        
        .old-price {
            font-size: 1.5rem;
            text-decoration: line-through;
            opacity: 0.7;
        }
        
        .new-price {
            font-size: 2.5rem;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .discount-badge {
            background: #10b981;
            padding: 8px 16px;
            border-radius: 25px;
            font-weight: bold;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½ã®æ”¹å–„ */
        .preview-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .preview-help {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            color: #1565c0;
        }
        
        .preview-help h4 {
            margin: 0 0 10px 0;
            color: #0d47a1;
        }
        
        .preview-placeholder {
            text-align: center;
            color: #718096;
            padding: 60px 20px;
            border: 2px dashed #cbd5e0;
            border-radius: 15px;
            background: #f7fafc;
        }
        
        .preview-placeholder::before {
            content: 'ğŸ”';
            font-size: 3rem;
            display: block;
            margin-bottom: 15px;
        }
    </style>
    
    <div class="newsletter-admin">
        <div class="admin-header">
            <h1>ğŸ“§ ãƒ¡ãƒ«ãƒã‚¬é…ä¿¡ç®¡ç†</h1>
            <p class="subtitle">NANKANã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ã®ãƒ¡ãƒ¼ãƒ«ãƒã‚¬ã‚¸ãƒ³ã‚’é…ä¿¡</p>
        </div>

        <div class="admin-container">
            <!-- é…ä¿¡ãƒ•ã‚©ãƒ¼ãƒ  -->
            <div class="card">
                <h2>æ–°è¦é…ä¿¡ä½œæˆ</h2>
                
                <div class="form-group">
                    <label for="subject">ä»¶å</label>
                    <input type="text" id="subject" placeholder="ä¾‹: ã€NANKANã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ã€‘æœ¬æ—¥ã®æ³¨ç›®ãƒ¬ãƒ¼ã‚¹äºˆæƒ³" />
                </div>

                <div class="form-group">
                    <label for="targetPlan">é…ä¿¡å¯¾è±¡</label>
                    <select id="targetPlan">
                        <option value="all">å…¨ä¼šå“¡</option>
                        <option value="free">ç„¡æ–™ä¼šå“¡ã®ã¿</option>
                        <option value="paid">æœ‰æ–™ä¼šå“¡ã®ã¿ï¼ˆStandard + Premiumï¼‰</option>
                        <option value="standard">Standardä¼šå“¡ã®ã¿</option>
                        <option value="premium">Premiumä¼šå“¡ã®ã¿</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="templateType">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¿ã‚¤ãƒ—</label>
                    <select id="templateType">
                        <option value="prediction">äºˆæƒ³é…ä¿¡</option>
                        <option value="result">çµæœå ±å‘Š</option>
                        <option value="campaign">ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³</option>
                        <option value="custom">ã‚«ã‚¹ã‚¿ãƒ </option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="mainContent">æœ¬æ–‡</label>
                    <textarea id="mainContent" rows="10" placeholder="ãƒ¡ãƒ¼ãƒ«ã®æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
                </div>

                <!-- äºˆæƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆäºˆæƒ³é…ä¿¡ã‚¿ã‚¤ãƒ—ã®å ´åˆï¼‰ -->
                <div id="predictionSection">
                    <h3 style="color: #4b5563; font-weight: 600; font-size: 1.2rem;">ğŸ¯ äºˆæƒ³æƒ…å ±</h3>
                    <div id="predictionsContainer">
                        <div class="prediction-input">
                            <input type="text" placeholder="ãƒ¬ãƒ¼ã‚¹åï¼ˆä¾‹: ç¬¬11R ãƒ¡ã‚¤ãƒ³ãƒ¬ãƒ¼ã‚¹ï¼‰" class="race-name" />
                            <textarea placeholder="äºˆæƒ³é¦¬ï¼ˆæ”¹è¡ŒåŒºåˆ‡ã‚Šï¼‰" rows="3" class="race-horses"></textarea>
                        </div>
                    </div>
                    <button type="button" id="addPrediction" class="btn-secondary">+ äºˆæƒ³ã‚’è¿½åŠ </button>
                </div>

                <!-- çµæœå ±å‘Šã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆçµæœå ±å‘Šã‚¿ã‚¤ãƒ—ã®å ´åˆï¼‰ -->
                <div id="resultSection" style="display: none;">
                    <h3 style="color: #4b5563; font-weight: 600; font-size: 1.2rem;">ğŸ“Š æ˜¨æ—¥ã®çµæœ</h3>
                    <div id="resultsContainer">
                        <div class="result-input">
                            <input type="text" placeholder="ãƒ¬ãƒ¼ã‚¹åï¼ˆä¾‹: ç¬¬11R ãƒ¡ã‚¤ãƒ³ãƒ¬ãƒ¼ã‚¹ï¼‰" class="result-race-name" />
                            <div class="result-details">
                                <input type="text" placeholder="1ç€é¦¬" class="result-winner" />
                                <input type="text" placeholder="é…å½“ï¼ˆä¾‹: Â¥1,200ï¼‰" class="result-payout" />
                                <select class="result-status">
                                    <option value="hit">ğŸ¯ çš„ä¸­ï¼</option>
                                    <option value="miss">âŒ ä¸çš„ä¸­</option>
                                    <option value="near">ğŸ“ˆ æƒœã—ã„ï¼</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <button type="button" id="addResult" class="btn-secondary">+ çµæœã‚’è¿½åŠ </button>
                    <div class="total-stats">
                        <input type="text" placeholder="ä»Šæœˆã®çš„ä¸­ç‡ï¼ˆä¾‹: 78%ï¼‰" id="monthlyHitRate" />
                        <input type="text" placeholder="ä»Šæœˆã®åæ”¯ï¼ˆä¾‹: +Â¥45,600ï¼‰" id="monthlyProfit" />
                    </div>
                </div>

                <!-- ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã‚¿ã‚¤ãƒ—ã®å ´åˆï¼‰ -->
                <div id="campaignSection" style="display: none;">
                    <h3 style="color: #4b5563; font-weight: 600; font-size: 1.2rem;">ğŸª ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³æƒ…å ±</h3>
                    <div class="campaign-inputs">
                        <input type="text" placeholder="ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³åï¼ˆä¾‹: é™å®š50åï¼ç‰¹åˆ¥äºˆæƒ³ãƒ—ãƒ©ãƒ³ï¼‰" id="campaignTitle" />
                        <textarea placeholder="ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³è©³ç´°ãƒ»ç‰¹å…¸å†…å®¹" rows="3" id="campaignDetails"></textarea>
                        <input type="text" placeholder="é€šå¸¸ä¾¡æ ¼ï¼ˆä¾‹: Â¥9,980ï¼‰" id="originalPrice" />
                        <input type="text" placeholder="ç‰¹åˆ¥ä¾¡æ ¼ï¼ˆä¾‹: Â¥4,980ï¼‰" id="campaignPrice" />
                        <input type="text" placeholder="æœŸé™ï¼ˆä¾‹: 12æœˆ31æ—¥ã¾ã§ï¼‰" id="campaignDeadline" />
                        <input type="text" placeholder="CTAãƒœã‚¿ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼ˆä¾‹: ä»Šã™ãç”³ã—è¾¼ã‚€ï¼‰" id="ctaText" />
                        <input type="url" placeholder="CTAãƒœã‚¿ãƒ³ãƒªãƒ³ã‚¯å…ˆURL" id="ctaUrl" />
                    </div>
                </div>

                <!-- ã‚«ã‚¹ã‚¿ãƒ ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã‚«ã‚¹ã‚¿ãƒ ã‚¿ã‚¤ãƒ—ã®å ´åˆï¼‰ -->
                <div id="customSection" style="display: none;">
                    <h3 style="color: #4b5563; font-weight: 600; font-size: 1.2rem;">ğŸ¨ ã‚«ã‚¹ã‚¿ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ</h3>
                    <div class="custom-inputs">
                        <label style="color: #374151; font-weight: 600;">èƒŒæ™¯è‰²ãƒ†ãƒ¼ãƒ</label>
                        <select id="customTheme">
                            <option value="default">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ</option>
                            <option value="gold">ğŸ† ã‚´ãƒ¼ãƒ«ãƒ‰ï¼ˆå‹åˆ©æ„Ÿï¼‰</option>
                            <option value="red">ğŸ”¥ ãƒ¬ãƒƒãƒ‰ï¼ˆç·Šæ€¥æ„Ÿï¼‰</option>
                            <option value="blue">ğŸ’ ãƒ–ãƒ«ãƒ¼ï¼ˆä¿¡é ¼æ„Ÿï¼‰</option>
                        </select>
                        
                        <label style="color: #374151; font-weight: 600;">ç‰¹åˆ¥è¦‹å‡ºã—</label>
                        <input type="text" placeholder="ç‰¹åˆ¥è¦‹å‡ºã—ï¼ˆä¾‹: ğŸš¨ ç·Šæ€¥é€Ÿå ±ï¼ï¼‰" id="customHeadline" />
                        
                        <label style="color: #374151; font-weight: 600;">ã‚¢ã‚¯ã‚»ãƒ³ãƒˆæƒ…å ±</label>
                        <textarea placeholder="å¼·èª¿ã—ãŸã„æƒ…å ±ãƒ»æ•°å­—ãƒ»å®Ÿç¸¾" rows="2" id="customAccent"></textarea>
                        
                        <label style="color: #374151; font-weight: 600;">è¿½åŠ CTA</label>
                        <input type="text" placeholder="è¿½åŠ ãƒœã‚¿ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ" id="customCtaText" />
                        <input type="url" placeholder="è¿½åŠ ãƒœã‚¿ãƒ³URL" id="customCtaUrl" />
                    </div>
                </div>

                <div class="form-group">
                    <label for="scheduledAt">é…ä¿¡äºˆç´„ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</label>
                    <input type="datetime-local" id="scheduledAt" />
                    <small style="color: #6b7280; font-size: 0.9rem; font-weight: 500; display: block; margin-top: 8px;">
                        ç©ºæ¬„ã®å ´åˆã¯å³æ™‚é…ä¿¡ã•ã‚Œã¾ã™<br>
                        <strong style="color: #374151; font-size: 0.95rem;">ç¾åœ¨æ™‚åˆ»: <span id="currentTime" style="color: #4b5563;">--:--</span></strong> (æ—¥æœ¬æ™‚é–“)<br>
                        <span style="color: #f59e0b; font-weight: 600;">âš ï¸ äºˆç´„é…ä¿¡ã¯5-10åˆ†ç¨‹åº¦ã®é…å»¶ãŒç™ºç”Ÿã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™</span>
                    </small>
                </div>

                <div class="action-buttons">
                    <button id="previewBtn" class="btn btn-secondary">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
                    <button id="clearPreviewBtn" class="btn btn-secondary">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ã‚¯ãƒªã‚¢</button>
                    <button id="sendBtn" class="btn btn-primary">é…ä¿¡å®Ÿè¡Œ</button>
                </div>
            </div>

            <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ -->
            <div class="card">
                <h2>ãƒ¡ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
                
                <div class="preview-help">
                    <h4>ğŸ’¬ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½ã®ä½¿ã„æ–¹</h4>
                    <p><strong>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°</strong>: å…¥åŠ›å†…å®¹ã‚’å…ƒã«ãƒ¡ãƒ¼ãƒ«ã®è¦‹ãŸç›®ã‚’ç¢ºèªã§ãã¾ã™</p>
                    <p>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¿ã‚¤ãƒ—ã‚„å…¥åŠ›å†…å®¹ã‚’å¤‰æ›´ã—ãŸå ´åˆã¯ã€å†åº¦ã€Œãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚</p>
                </div>
                
                <div class="preview-controls">
                    <button type="button" id="generatePreviewBtn2" class="btn btn-info">ğŸ”„ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°</button>
                    <button type="button" id="clearPreviewBtn2" class="btn btn-secondary">ğŸ´ ã‚¯ãƒªã‚¢</button>
                </div>
                
                <div id="previewArea" class="preview-area">
                    <div class="preview-placeholder">
                        ãƒ¡ãƒ¼ãƒ«ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤ºã—ã¾ã™<br>
                        <small>ä¸Šã®ã€Œãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯</small>
                    </div>
                    <iframe id="previewFrame" class="preview-frame" style="display: none;"></iframe>
                </div>
            </div>

            <!-- é…ä¿¡å±¥æ­´ -->
            <div class="card">
                <h2 style="color: #374151; font-weight: 600;">ğŸ“‹ é…ä¿¡å±¥æ­´ãƒ»äºˆç´„çŠ¶æ³</h2>
                <button id="refreshHistoryBtn" class="btn btn-secondary" style="margin-bottom: 20px;">å±¥æ­´ã‚’æ›´æ–°</button>
                <div id="newHistoryArea" style="background: #f9fafb; border-radius: 10px; padding: 20px; border: 2px solid #d1d5db;">
                    <div class="simple-loading" style="text-align: center; color: #6b7280; font-weight: 500; font-size: 1rem; padding: 20px;">
                        ğŸ“„ èª­ã¿è¾¼ã¿ä¸­...
                    </div>
                </div>
            </div>
        </div>
    </div>
</BaseLayout>

<script>
    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¿ã‚¤ãƒ—ã®è¡¨ç¤ºåˆ¶å¾¡é–¢æ•°
    function updateTemplateSection() {
        const templateType = document.getElementById('templateType');
        const predictionSection = document.getElementById('predictionSection');
        const resultSection = document.getElementById('resultSection');
        const campaignSection = document.getElementById('campaignSection');
        const customSection = document.getElementById('customSection');
        
        // å…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º
        [predictionSection, resultSection, campaignSection, customSection].forEach(section => {
            if (section) section.style.display = 'none';
        });
        
        // é¸æŠã•ã‚ŒãŸã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦è¡¨ç¤º
        if (templateType) {
            switch (templateType.value) {
                case 'prediction':
                    if (predictionSection) {
                        predictionSection.style.display = 'block';
                        console.log('ğŸ¯ äºˆæƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º');
                    }
                    break;
                case 'result':
                    if (resultSection) {
                        resultSection.style.display = 'block';
                        console.log('ğŸ“Š çµæœå ±å‘Šã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º');
                    }
                    break;
                case 'campaign':
                    if (campaignSection) {
                        campaignSection.style.display = 'block';
                        console.log('ğŸª ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º');
                    }
                    break;
                case 'custom':
                    if (customSection) {
                        customSection.style.display = 'block';
                        console.log('ğŸ¨ ã‚«ã‚¹ã‚¿ãƒ ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º');
                    }
                    break;
            }
        }
    }

    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¿ã‚¤ãƒ—å¤‰æ›´æ™‚ã®å‡¦ç†
    const templateType = document.getElementById('templateType');
    templateType?.addEventListener('change', updateTemplateSection);

    // äºˆæƒ³è¿½åŠ ãƒœã‚¿ãƒ³
    document.getElementById('addPrediction')?.addEventListener('click', () => {
        const container = document.getElementById('predictionsContainer');
        const newPrediction = document.createElement('div');
        newPrediction.className = 'prediction-input';
        newPrediction.innerHTML = `
            <input type="text" placeholder="ãƒ¬ãƒ¼ã‚¹å" class="race-name" />
            <textarea placeholder="äºˆæƒ³é¦¬ï¼ˆæ”¹è¡ŒåŒºåˆ‡ã‚Šï¼‰" rows="3" class="race-horses"></textarea>
            <button type="button" class="remove-prediction">å‰Šé™¤</button>
        `;
        container.appendChild(newPrediction);
        
        // å‰Šé™¤ãƒœã‚¿ãƒ³ã®å‡¦ç†
        newPrediction.querySelector('.remove-prediction')?.addEventListener('click', () => {
            newPrediction.remove();
        });
    });

    // çµæœè¿½åŠ ãƒœã‚¿ãƒ³
    document.getElementById('addResult')?.addEventListener('click', () => {
        const container = document.getElementById('resultsContainer');
        const newResult = document.createElement('div');
        newResult.className = 'result-input';
        newResult.innerHTML = `
            <input type="text" placeholder="ãƒ¬ãƒ¼ã‚¹å" class="result-race-name" />
            <div class="result-details">
                <input type="text" placeholder="1ç€é¦¬" class="result-winner" />
                <input type="text" placeholder="é…å½“ï¼ˆä¾‹: Â¥1,200ï¼‰" class="result-payout" />
                <select class="result-status">
                    <option value="hit">ğŸ¯ çš„ä¸­ï¼</option>
                    <option value="miss">âŒ ä¸çš„ä¸­</option>
                    <option value="near">ğŸ“ˆ æƒœã—ã„ï¼</option>
                </select>
                <button type="button" class="remove-result">å‰Šé™¤</button>
            </div>
        `;
        container.appendChild(newResult);
        
        // å‰Šé™¤ãƒœã‚¿ãƒ³ã®å‡¦ç†
        newResult.querySelector('.remove-result')?.addEventListener('click', () => {
            newResult.remove();
        });
    });

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹é–¢æ•°
    function clearPreview() {
        const previewArea = document.getElementById('previewArea');
        previewArea.innerHTML = '<p class="preview-placeholder">é…ä¿¡å†…å®¹ã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã™ã‚‹ã«ã¯ã€Œãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„</p>';
    }
    
    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆé–¢æ•° - å…¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¿ã‚¤ãƒ—å¯¾å¿œ
    function generatePreview() {
        try {
            const subject = document.getElementById('subject').value;
            const templateType = document.getElementById('templateType').value;
            const mainContent = document.getElementById('mainContent').value;
            
            if (!subject) {
                document.getElementById('previewArea').innerHTML = '<p class="error">ä»¶åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>';
                return;
            }

            // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¿ã‚¤ãƒ—åˆ¥ãƒ‡ãƒ¼ã‚¿åé›†
            let templateData = {
                subject: subject,
                templateType: templateType,
                theme: document.getElementById('customTheme')?.value || 'blue'
            };

            if (templateType === 'prediction') {
                templateData.predictions = collectPredictionData();
            } else if (templateType === 'result') {
                templateData.results = collectResultData();
            } else if (templateType === 'campaign') {
                templateData.campaign = collectCampaignData();
            } else if (templateType === 'custom') {
                templateData.custom = collectCustomData();
            }

            // é«˜åº¦ãªHTMLç”Ÿæˆ
            const htmlContent = generateAdvancedNewsletterHTML(templateData);
            
            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ã«è¡¨ç¤º
            const previewFrame = document.getElementById('previewFrame');
            if (previewFrame) {
                previewFrame.srcdoc = htmlContent;
                console.log('âœ… ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆå®Œäº† - ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¿ã‚¤ãƒ—:', templateType);
            }
            
            // HTMLã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚‚æ›´æ–°
            const htmlContentField = document.getElementById('htmlContent');
            if (htmlContentField) {
                htmlContentField.value = htmlContent;
            }
            
        } catch (error) {
            console.error('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
            document.getElementById('previewArea').innerHTML = '<p class="error">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆã‚¨ãƒ©ãƒ¼: ' + error.message + '</p>';
        }
    }
    
    // äºˆæƒ³ãƒ‡ãƒ¼ã‚¿åé›†
    function collectPredictionData() {
        const races = [];
        for (let i = 1; i <= 3; i++) {
            const raceName = document.getElementById(`race${i}Name`)?.value;
            const horses = [];
            for (let j = 1; j <= 3; j++) {
                const horse = document.getElementById(`race${i}Horse${j}`)?.value;
                if (horse) horses.push(horse);
            }
            if (raceName || horses.length > 0) {
                races.push({ name: raceName || `ç¬¬${i}ãƒ¬ãƒ¼ã‚¹`, horses });
            }
        }
        return { races, highlight: document.getElementById('predictionHighlight')?.value || '' };
    }
    
    // çµæœãƒ‡ãƒ¼ã‚¿åé›†
    function collectResultData() {
        const results = [];
        for (let i = 1; i <= 3; i++) {
            const raceName = document.getElementById(`result${i}Race`)?.value;
            const prediction = document.getElementById(`result${i}Prediction`)?.value;
            const actual = document.getElementById(`result${i}Actual`)?.value;
            const status = document.getElementById(`result${i}Status`)?.value;
            if (raceName || prediction) {
                results.push({ raceName, prediction, actual, status });
            }
        }
        return {
            results,
            monthlyHitRate: document.getElementById('monthlyHitRate')?.value || '',
            monthlyROI: document.getElementById('monthlyROI')?.value || ''
        };
    }
    
    // ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ãƒ‡ãƒ¼ã‚¿åé›†
    function collectCampaignData() {
        return {
            title: document.getElementById('campaignTitle')?.value || '',
            description: document.getElementById('campaignDescription')?.value || '',
            discount: document.getElementById('campaignDiscount')?.value || '',
            period: document.getElementById('campaignPeriod')?.value || '',
            beforePrice: document.getElementById('campaignBeforePrice')?.value || '',
            afterPrice: document.getElementById('campaignAfterPrice')?.value || ''
        };
    }
    
    // ã‚«ã‚¹ã‚¿ãƒ ãƒ‡ãƒ¼ã‚¿åé›†
    function collectCustomData() {
        return {
            headline: document.getElementById('customHeadline')?.value || '',
            message: document.getElementById('customMessage')?.value || '',
            feature1: document.getElementById('customFeature1')?.value || '',
            feature2: document.getElementById('customFeature2')?.value || '',
            feature3: document.getElementById('customFeature3')?.value || ''
        };
    }

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³
    document.getElementById('clearPreviewBtn')?.addEventListener('click', clearPreview);

    // ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›å¤‰æ›´æ™‚ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è‡ªå‹•ã‚¯ãƒªã‚¢
    const formInputs = ['subject', 'mainContent', 'targetPlan', 'templateType', 'scheduledAt'];
    formInputs.forEach(inputId => {
        const element = document.getElementById(inputId);
        element?.addEventListener('input', clearPreview);
        element?.addEventListener('change', clearPreview);
    });

    // äºˆæƒ³å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å¤‰æ›´ã‚‚ç›£è¦–
    document.getElementById('predictionsContainer')?.addEventListener('input', clearPreview);

    // æ–°ã—ã„ã‚·ãƒ³ãƒ—ãƒ«ãªå±¥æ­´èª­ã¿è¾¼ã¿é–¢æ•°
    function loadHistory() {
        const newHistoryArea = document.getElementById('newHistoryArea');
        if (!newHistoryArea) {
            console.error('newHistoryAreaãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            return;
        }
        
        // ã‚·ãƒ³ãƒ—ãƒ«ãªã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿
        const sampleHistory = [
            {
                subject: '9æœˆ2æ—¥ å¤§äº•ç«¶é¦¬äºˆæƒ³',
                status: 'é…ä¿¡æ¸ˆã¿',
                targetPlan: 'free',
                recipientCount: 3,
                date: '2025/09/09 12:52'
            },
            {
                subject: 'é€±æœ«ç‰¹åˆ¥ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã®ãŠçŸ¥ã‚‰ã›',
                status: 'é…ä¿¡æ¸ˆã¿',
                targetPlan: 'all',
                recipientCount: 15,
                date: '2025/09/08 18:00'
            }
        ];
        
        if (sampleHistory.length > 0) {
            let historyHTML = '';
            sampleHistory.forEach(item => {
                historyHTML += `
                    <div class="new-history-item">
                        <div class="new-history-title">
                            ${item.subject}
                            <span class="new-status-sent">${item.status} âœ…</span>
                        </div>
                        <div class="new-history-info">
                            å¯¾è±¡: ${item.targetPlan} | é…ä¿¡æ•°: ${item.recipientCount}ä»¶ | é…ä¿¡æ—¥æ™‚: ${item.date}
                        </div>
                    </div>
                `;
            });
            newHistoryArea.innerHTML = historyHTML;
        } else {
            newHistoryArea.innerHTML = `
                <div class="new-no-history">
                    ğŸ“„ ã¾ã é…ä¿¡å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“<br>
                    <small>ãƒ¡ãƒ«ãƒã‚¬ã‚’é…ä¿¡ã™ã‚‹ã¨ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</small>
                </div>
            `;
        }
        
        console.log('âœ… æ–°ã—ã„å±¥æ­´èª­ã¿è¾¼ã¿å®Œäº†');
    }

    // å±¥æ­´ã‚’ä¿å­˜ã™ã‚‹é–¢æ•°
    function saveHistoryToLocal(historyItem) {
        try {
            const existingHistory = localStorage.getItem('newsletter-history');
            const history = existingHistory ? JSON.parse(existingHistory) : [];
            
            // æ–°ã—ã„å±¥æ­´ã‚’å…ˆé ­ã«è¿½åŠ 
            history.unshift({
                ...historyItem,
                id: Date.now().toString(), // ç°¡æ˜“ID
                createdAt: new Date().toISOString()
            });
            
            // æœ€å¤§50ä»¶ã¾ã§ä¿æŒ
            const limitedHistory = history.slice(0, 50);
            
            localStorage.setItem('newsletter-history', JSON.stringify(limitedHistory));
            console.log('å±¥æ­´ã‚’LocalStorageã«ä¿å­˜:', historyItem);
        } catch (error) {
            console.error('å±¥æ­´ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        }
    }

    // å±¥æ­´æ›´æ–°ãƒœã‚¿ãƒ³
    document.getElementById('refreshHistoryBtn')?.addEventListener('click', loadHistory);
    
    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ (ãƒ¡ã‚¤ãƒ³)
    document.getElementById('generatePreviewBtn')?.addEventListener('click', generatePreview);
    
    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ (ã‚µãƒ–)
    document.getElementById('generatePreviewBtn2')?.addEventListener('click', generatePreview);
    
    // ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ (ã‚µãƒ–)
    document.getElementById('clearPreviewBtn2')?.addEventListener('click', clearPreview);

    // ç¾åœ¨æ™‚åˆ»ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
    function updateCurrentTime() {
        const now = new Date();
        const timeString = now.toLocaleString('ja-JP', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
        const currentTimeElement = document.getElementById('currentTime');
        if (currentTimeElement) {
            currentTimeElement.textContent = timeString;
        }
    }

    // ç¾åœ¨æ™‚åˆ»ã‚’1ç§’ã”ã¨ã«æ›´æ–°
    setInterval(updateCurrentTime, 1000);

    // åˆæœŸè¡¨ç¤ºã§å±¥æ­´ã‚’èª­ã¿è¾¼ã¿
    document.addEventListener('DOMContentLoaded', () => {
        loadHistory();
        updateCurrentTime();
        // åˆæœŸçŠ¶æ…‹ã§ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®è¡¨ç¤ºã‚’è¨­å®š
        updateTemplateSection();
        
        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã®ä»£æ›¿å‡¦ç†
        const previewBtn = document.getElementById('generatePreviewBtn');
        if (!previewBtn) {
            console.warn('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ã‚’å‹•çš„ã«ä½œæˆ
            const previewArea = document.getElementById('previewArea');
            if (previewArea && !document.getElementById('generatePreviewBtn')) {
                const newPreviewBtn = document.createElement('button');
                newPreviewBtn.id = 'generatePreviewBtn';
                newPreviewBtn.type = 'button';
                newPreviewBtn.textContent = 'ğŸ” ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆ';
                newPreviewBtn.className = 'btn btn-secondary';
                newPreviewBtn.style.marginBottom = '20px';
                
                previewArea.parentNode.insertBefore(newPreviewBtn, previewArea);
                newPreviewBtn.addEventListener('click', generatePreview);
                
                console.log('âœ… ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ã‚’å‹•çš„ã«ä½œæˆã—ã¾ã—ãŸ');
            }
        } else {
            console.log('âœ… ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ');
        }
        
        console.log('ãƒšãƒ¼ã‚¸åˆæœŸåŒ–å®Œäº†');
    });

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆ
    document.getElementById('previewBtn')?.addEventListener('click', async () => {
        const subject = document.getElementById('subject').value;
        const mainContent = document.getElementById('mainContent').value;
        const templateType = document.getElementById('templateType').value;
        
        if (!subject || !mainContent) {
            alert('ä»¶åã¨æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }

        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¿ã‚¤ãƒ—åˆ¥ã®ãƒ‡ãƒ¼ã‚¿åé›†
        let templateData = {
            title: subject,
            mainContent: mainContent,
            templateType: templateType
        };

        if (templateType === 'prediction') {
            // äºˆæƒ³ãƒ‡ãƒ¼ã‚¿åé›†
            const predictionInputs = document.querySelectorAll('.prediction-input');
            templateData.predictions = Array.from(predictionInputs).map(input => {
                const raceName = input.querySelector('.race-name').value;
                const horses = input.querySelector('.race-horses').value
                    .split('\n')
                    .filter(h => h.trim())
                    .map(h => h.trim());
                return { raceName, horses };
            }).filter(p => p.raceName && p.horses.length > 0);
        } else if (templateType === 'result') {
            // çµæœãƒ‡ãƒ¼ã‚¿åé›†
            const resultInputs = document.querySelectorAll('.result-input');
            templateData.results = Array.from(resultInputs).map(input => {
                const raceName = input.querySelector('.result-race-name').value;
                const winner = input.querySelector('.result-winner').value;
                const payout = input.querySelector('.result-payout').value;
                const status = input.querySelector('.result-status').value;
                return { raceName, winner, payout, status };
            }).filter(r => r.raceName);
            
            templateData.monthlyHitRate = document.getElementById('monthlyHitRate')?.value || '';
            templateData.monthlyProfit = document.getElementById('monthlyProfit')?.value || '';
        } else if (templateType === 'campaign') {
            // ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ãƒ‡ãƒ¼ã‚¿åé›†
            templateData.campaignTitle = document.getElementById('campaignTitle')?.value || '';
            templateData.campaignDetails = document.getElementById('campaignDetails')?.value || '';
            templateData.originalPrice = document.getElementById('originalPrice')?.value || '';
            templateData.campaignPrice = document.getElementById('campaignPrice')?.value || '';
            templateData.campaignDeadline = document.getElementById('campaignDeadline')?.value || '';
            templateData.ctaText = document.getElementById('ctaText')?.value || 'ä»Šã™ãç”³ã—è¾¼ã‚€';
            templateData.ctaUrl = document.getElementById('ctaUrl')?.value || 'https://nankan-analytics.keiba.link/pricing/';
        } else if (templateType === 'custom') {
            // ã‚«ã‚¹ã‚¿ãƒ ãƒ‡ãƒ¼ã‚¿åé›†
            templateData.customTheme = document.getElementById('customTheme')?.value || 'default';
            templateData.customHeadline = document.getElementById('customHeadline')?.value || '';
            templateData.customAccent = document.getElementById('customAccent')?.value || '';
            templateData.customCtaText = document.getElementById('customCtaText')?.value || '';
            templateData.customCtaUrl = document.getElementById('customCtaUrl')?.value || '';
        }

        // HTMLãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”Ÿæˆ
        const htmlContent = generateAdvancedNewsletterHTML(templateData);

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
        const previewArea = document.getElementById('previewArea');
        previewArea.innerHTML = `
            <div class="email-frame">
                <div class="email-header">
                    <strong>ä»¶å:</strong> ${subject}
                </div>
                <iframe srcdoc="${htmlContent.replace(/"/g, '&quot;')}" style="width: 100%; height: 600px; border: 1px solid #ddd;"></iframe>
            </div>
        `;
    });

    // é…ä¿¡å®Ÿè¡Œ
    document.getElementById('sendBtn')?.addEventListener('click', async () => {
        const subject = document.getElementById('subject').value;
        const mainContent = document.getElementById('mainContent').value;
        const targetPlan = document.getElementById('targetPlan').value;
        const templateType = document.getElementById('templateType').value;
        const scheduledAt = document.getElementById('scheduledAt').value;
        
        if (!subject || !mainContent) {
            alert('ä»¶åã¨æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }

        if (!confirm(`${targetPlan === 'all' ? 'å…¨ä¼šå“¡' : targetPlan + 'ä¼šå“¡'}ã«é…ä¿¡ã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) {
            return;
        }

        // äºˆæƒ³ãƒ‡ãƒ¼ã‚¿åé›†
        let predictions = [];
        if (templateType === 'prediction') {
            const predictionInputs = document.querySelectorAll('.prediction-input');
            predictions = Array.from(predictionInputs).map(input => {
                const raceName = input.querySelector('.race-name').value;
                const horses = input.querySelector('.race-horses').value
                    .split('\n')
                    .filter(h => h.trim())
                    .map(h => h.trim());
                return { raceName, horses };
            }).filter(p => p.raceName && p.horses.length > 0);
        }

        // HTMLãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”Ÿæˆ
        const htmlContent = generateNewsletterHTML({
            title: subject,
            mainContent: mainContent,
            predictions: predictions
        });

        try {
            console.log('é…ä¿¡ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ä¸­...', {
                subject,
                targetPlan,
                hasHtmlContent: !!htmlContent,
                scheduledAt
            });

            const response = await fetch('/.netlify/functions/send-newsletter', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    subject,
                    htmlContent,
                    targetPlan,
                    scheduledAt: scheduledAt || null
                })
            });

            console.log('ãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡:', response.status, response.statusText);

            // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å…ˆã«å–å¾—
            const responseText = await response.text();
            console.log('ãƒ¬ã‚¹ãƒãƒ³ã‚¹å†…å®¹:', responseText);

            let result;
            try {
                result = JSON.parse(responseText);
            } catch (parseError) {
                console.error('JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', parseError);
                console.error('ãƒ‘ãƒ¼ã‚¹å¤±æ•—ã—ãŸãƒ†ã‚­ã‚¹ãƒˆ:', responseText);
                alert(`âŒ é…ä¿¡å¤±æ•—: ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®å¿œç­”ã‚’è§£æã§ãã¾ã›ã‚“ã§ã—ãŸ\nã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${response.status}\nè©³ç´°ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„`);
                return;
            }
            
            if (response.ok) {
                const successMessage = result.isScheduled 
                    ? `âœ… é…ä¿¡äºˆç´„å®Œäº†ï¼${result.recipientCount}ä»¶ã®é…ä¿¡ã‚’äºˆç´„ã—ã¾ã—ãŸ`
                    : `âœ… é…ä¿¡æˆåŠŸï¼${result.recipientCount}ä»¶ã«é…ä¿¡ã—ã¾ã—ãŸ`;
                    
                alert(successMessage);
                
                // å±¥æ­´ã«ä¿å­˜
                saveHistoryToLocal({
                    subject: subject,
                    targetPlan: targetPlan,
                    recipientCount: result.recipientCount,
                    scheduledAt: scheduledAt || new Date().toISOString(),
                    status: result.isScheduled ? 'scheduled' : 'sent'
                });
                
                // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
                document.getElementById('subject').value = '';
                document.getElementById('mainContent').value = '';
                document.getElementById('targetPlan').value = 'all';
                document.getElementById('templateType').value = 'prediction';
                document.getElementById('scheduledAt').value = '';
                // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚‚ã‚¯ãƒªã‚¢
                clearPreview();
                
                // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¿ã‚¤ãƒ—ã‚’ãƒªã‚»ãƒƒãƒˆå¾Œã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°
                setTimeout(() => {
                    updateTemplateSection();
                }, 100);
                
                // å±¥æ­´ã‚’æ›´æ–°
                loadHistory();
            } else {
                console.error('é…ä¿¡ã‚¨ãƒ©ãƒ¼è©³ç´°:', result);
                alert(`âŒ é…ä¿¡å¤±æ•—: ${result.error || result.details || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'}\nè©³ç´°ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„`);
            }
        } catch (error) {
            console.error('é…ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
            alert(`é…ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
        }
    });

    // æ–°ã—ã„çµ±åˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”Ÿæˆé–¢æ•°
    function generateAdvancedNewsletterHTML(templateData) {
        const { 
            title, 
            mainContent, 
            templateType,
            predictions = [],
            results = [],
            monthlyHitRate = '',
            monthlyProfit = '',
            campaignTitle = '',
            campaignDetails = '',
            originalPrice = '',
            campaignPrice = '',
            campaignDeadline = '',
            ctaText = 'ä»Šã™ãç”³ã—è¾¼ã‚€',
            ctaUrl = 'https://nankan-analytics.keiba.link/pricing/',
            customTheme = 'default',
            customHeadline = '',
            customAccent = '',
            customCtaText = '',
            customCtaUrl = ''
        } = templateData;

        // ãƒ¢ãƒ€ãƒ³ãƒ†ãƒ¼ãƒåˆ¥ã‚¹ã‚¿ã‚¤ãƒ«
        const modernThemes = {
            gold: {
                gradient: 'linear-gradient(135deg, #fbbf24 0%, #f59e0b 50%, #d97706 100%)',
                cardBg: 'linear-gradient(135deg, #fefbf3 0%, #fef3c7 100%)',
                textColor: '#92400e',
                accentColor: '#f59e0b'
            },
            red: {
                gradient: 'linear-gradient(135deg, #ff6b6b 0%, #ee5a24 50%, #e17055 100%)',
                cardBg: 'linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%)',
                textColor: '#991b1b',
                accentColor: '#dc2626'
            },
            blue: {
                gradient: 'linear-gradient(135deg, #4299e1 0%, #3182ce 50%, #2b6cb0 100%)',
                cardBg: 'linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%)',
                textColor: '#1e40af',
                accentColor: '#3b82f6'
            }
        };
        
        const currentTheme = modernThemes[customTheme] || modernThemes.blue;
        
        let themeStyles = `
            .header { background: ${currentTheme.gradient}; }
            .prediction-card, .result-card, .campaign-card { 
                border-left-color: ${currentTheme.accentColor}; 
                background: ${currentTheme.cardBg};
                box-shadow: 0 10px 25px rgba(0,0,0,0.1);
                border-radius: 15px;
            }
            .cta-button { 
                background: ${currentTheme.gradient};
                box-shadow: 0 10px 25px rgba(0,0,0,0.2);
                border-radius: 12px;
                transition: all 0.3s ease;
            }
            .cta-button:hover {
                transform: translateY(-3px);
                box-shadow: 0 15px 35px rgba(0,0,0,0.3);
            }
            .modern-campaign-hero {
                background: ${currentTheme.gradient};
                position: relative;
                overflow: hidden;
            }
            .campaign-highlight {
                background: ${currentTheme.cardBg};
                border: 2px solid ${currentTheme.accentColor};
                box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            }
        `;

        // ã‚«ã‚¹ã‚¿ãƒ ãƒ˜ãƒƒãƒ‰ãƒ©ã‚¤ãƒ³
        const customHeadlineHTML = customHeadline ? `
            <div style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); padding: 20px; margin: 20px 0; border-radius: 12px; border-left: 4px solid #ef4444; text-align: center;">
                <h2 style="color: #dc2626; font-size: 24px; font-weight: bold; margin: 0;">${customHeadline}</h2>
            </div>
        ` : '';

        // ã‚«ã‚¹ã‚¿ãƒ ã‚¢ã‚¯ã‚»ãƒ³ãƒˆ
        const customAccentHTML = customAccent ? `
            <div style="background: #f0f9ff; border-radius: 12px; padding: 20px; margin: 20px 0; border-left: 4px solid #0ea5e9;">
                <div style="color: #0c4a6e; font-size: 18px; font-weight: 600; line-height: 1.6; white-space: pre-wrap;">${customAccent}</div>
            </div>
        ` : '';

        return `
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${title}</title>
    <style>
        body { margin: 0; padding: 0; font-family: 'Helvetica Neue', Arial, sans-serif; background-color: #f5f5f5; }
        .container { max-width: 600px; margin: 0 auto; background-color: #ffffff; }
        .header { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: white; padding: 40px 30px; text-align: center; }
        .logo { font-size: 28px; font-weight: bold; margin-bottom: 10px; }
        .tagline { font-size: 14px; color: #94a3b8; }
        .content { padding: 40px 30px; }
        .prediction-card, .result-card, .campaign-card { background: #f8fafc; border-radius: 12px; padding: 20px; margin-bottom: 20px; border-left: 4px solid #3b82f6; }
        .race-title { font-size: 18px; font-weight: bold; color: #1e293b; margin-bottom: 10px; }
        .horses, .result-details { margin: 10px 0; }
        .horse-item, .result-item { padding: 5px 0; color: #475569; }
        .hit-status { font-weight: bold; }
        .hit-status.hit { color: #059669; }
        .hit-status.miss { color: #dc2626; }
        .hit-status.near { color: #d97706; }
        .campaign-highlight { background: #fef3c7; border-radius: 8px; padding: 15px; margin: 15px 0; border-left: 4px solid #f59e0b; }
        .price-comparison { display: flex; align-items: center; gap: 15px; margin: 15px 0; }
        .original-price { text-decoration: line-through; color: #6b7280; font-size: 18px; }
        .campaign-price { color: #dc2626; font-size: 24px; font-weight: bold; }
        .deadline { background: #fee2e2; color: #dc2626; padding: 8px 12px; border-radius: 6px; font-weight: bold; }
        .cta-button { display: inline-block; background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; padding: 15px 40px; text-decoration: none; border-radius: 8px; font-weight: bold; margin: 30px 0; }
        .stats-section { background: #f0f9ff; border-radius: 12px; padding: 20px; margin: 20px 0; border-left: 4px solid #0ea5e9; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
        .stat-item { text-align: center; background: white; padding: 15px; border-radius: 8px; }
        .stat-number { font-size: 24px; font-weight: bold; color: #0c4a6e; }
        .stat-label { font-size: 14px; color: #64748b; }
        .footer { background: #f1f5f9; padding: 30px; text-align: center; color: #64748b; font-size: 12px; }
        ${themeStyles}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">ğŸ‡ NANKANã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹</div>
            <div class="tagline">AIãƒ»æ©Ÿæ¢°å­¦ç¿’ã§å‹ã¤å—é–¢ç«¶é¦¬</div>
        </div>
        
        <div class="content">
            ${customHeadlineHTML}
            
            <div style="color: #475569; line-height: 1.8; white-space: pre-wrap;">
${mainContent}
            </div>
            
            ${customAccentHTML}
            
            ${templateType === 'prediction' && predictions.length > 0 ? `
            <h3 style="color: #1e293b; margin-top: 40px; margin-bottom: 20px;">ğŸ¯ æœ¬æ—¥ã®æ³¨ç›®äºˆæƒ³</h3>
            ${predictions.map(p => `
            <div class="prediction-card">
                <div class="race-title">ğŸ ${p.raceName}</div>
                <div class="horses">
                    ${p.horses.map(h => `<div class="horse-item">${h}</div>`).join('')}
                </div>
            </div>
            `).join('')}
            ` : ''}
            
            ${templateType === 'result' && results.length > 0 ? `
            <h3 style="color: #1e293b; margin-top: 40px; margin-bottom: 20px;">ğŸ“Š æ˜¨æ—¥ã®çµæœ</h3>
            ${results.map(r => `
            <div class="result-card">
                <div class="race-title">ğŸ ${r.raceName}</div>
                <div class="result-details">
                    <div class="result-item">1ç€: <strong>${r.winner}</strong></div>
                    <div class="result-item">é…å½“: <strong>${r.payout}</strong></div>
                    <div class="result-item hit-status ${r.status}">${r.status === 'hit' ? 'ğŸ¯ çš„ä¸­ï¼' : r.status === 'near' ? 'ğŸ“ˆ æƒœã—ã„ï¼' : 'âŒ ä¸çš„ä¸­'}</div>
                </div>
            </div>
            `).join('')}
            ${(monthlyHitRate || monthlyProfit) ? `
            <div class="stats-section">
                <h4 style="color: #0c4a6e; margin-top: 0;">ğŸ“ˆ ä»Šæœˆã®å®Ÿç¸¾</h4>
                <div class="stats-grid">
                    ${monthlyHitRate ? `
                    <div class="stat-item">
                        <div class="stat-number">${monthlyHitRate}</div>
                        <div class="stat-label">çš„ä¸­ç‡</div>
                    </div>` : ''}
                    ${monthlyProfit ? `
                    <div class="stat-item">
                        <div class="stat-number">${monthlyProfit}</div>
                        <div class="stat-label">åæ”¯</div>
                    </div>` : ''}
                </div>
            </div>
            ` : ''}
            ` : ''}
            
            ${templateType === 'campaign' && campaignTitle ? `
            <div class="modern-campaign-hero" style="
                background: ${currentTheme.gradient};
                color: white;
                padding: 40px;
                border-radius: 20px;
                margin: 30px 0;
                position: relative;
                overflow: hidden;
                box-shadow: 0 20px 40px rgba(0,0,0,0.2);
                text-align: center;
            ">
                <div style="position: absolute; top: -20px; right: -20px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%; animation: float 3s ease-in-out infinite;"></div>
                <div style="position: absolute; bottom: -30px; left: -30px; width: 80px; height: 80px; background: rgba(255,255,255,0.08); border-radius: 50%; animation: float 4s ease-in-out infinite reverse;"></div>
                
                <h2 style="font-size: 2.5rem; margin-bottom: 20px; text-shadow: 0 4px 8px rgba(0,0,0,0.3); animation: pulse 2s infinite;">
                    ğŸ† ${campaignTitle} ğŸ†
                </h2>
                
                <p style="font-size: 1.3rem; margin-bottom: 30px; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">
                    âœ¨ ${campaignDetails || 'æœŸé–“é™å®šã®ç‰¹åˆ¥ã‚ªãƒ•ã‚¡ãƒ¼ã‚’ãŠè¦‹é€ƒã—ãªãï¼'} âœ¨
                </p>
                
                ${originalPrice && campaignPrice ? `
                <div style="background: rgba(255,255,255,0.2); border-radius: 15px; padding: 20px; margin: 20px 0; backdrop-filter: blur(10px);">
                    <div style="display: flex; align-items: center; justify-content: center; gap: 20px;">
                        <span style="font-size: 1.8rem; text-decoration: line-through; opacity: 0.7;">${originalPrice}</span>
                        <span style="font-size: 1.2rem; font-weight: bold;">â†’</span>
                        <span style="font-size: 2.8rem; font-weight: bold; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">${campaignPrice}</span>
                    </div>
                </div>
                ` : ''}
                
                ${campaignDeadline ? `
                <div style="background: rgba(220, 38, 38, 0.9); color: white; padding: 15px 30px; border-radius: 25px; font-weight: bold; margin-top: 20px; animation: urgency 2s infinite;">
                    ğŸš¨ æœŸé™: ${campaignDeadline} ğŸš¨
                </div>
                ` : ''}
                
                <style>
                    @keyframes float {
                        0%, 100% { transform: translateY(0px) rotate(0deg); }
                        50% { transform: translateY(-10px) rotate(5deg); }
                    }
                    @keyframes pulse {
                        0%, 100% { transform: scale(1); }
                        50% { transform: scale(1.02); }
                    }
                    @keyframes urgency {
                        0%, 100% { transform: scale(1); }
                        50% { transform: scale(1.05); }
                    }
                </style>
            </div>
            ` : ''}
            
            <div style="text-align: center;">
                <a href="${ctaUrl}" class="cta-button">${ctaText}</a>
                ${customCtaText && customCtaUrl ? `
                <br><a href="${customCtaUrl}" class="cta-button" style="margin-top: 10px;">${customCtaText}</a>
                ` : ''}
            </div>
        </div>
        
        <div class="footer">
            <p>Â© 2025 NANKANã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹</p>
        </div>
    </div>
</body>
</html>
        `;
    }
</script>
