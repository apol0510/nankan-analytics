---
// ç®¡ç†è€…ç”¨ãƒ¡ãƒ«ãƒã‚¬é…ä¿¡ãƒšãƒ¼ã‚¸
export const prerender = false;
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout title="ãƒ¡ãƒ«ãƒã‚¬é…ä¿¡ç®¡ç† - NANKANã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹">
    <div class="newsletter-admin">
        <div class="admin-header">
            <h1>ğŸ“§ ãƒ¡ãƒ«ãƒã‚¬é…ä¿¡ç®¡ç†</h1>
            <p class="subtitle">NANKANã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ã®ãƒ¡ãƒ¼ãƒ«ãƒã‚¬ã‚¸ãƒ³ã‚’é…ä¿¡</p>
        </div>

        <div class="admin-container">
            <!-- é…ä¿¡ãƒ•ã‚©ãƒ¼ãƒ  -->
            <div class="card">
                <h2>æ–°è¦é…ä¿¡ä½œæˆ</h2>
                
                <div class="form-group">
                    <label for="subject">ä»¶å</label>
                    <input type="text" id="subject" placeholder="ä¾‹: ã€NANKANã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ã€‘æœ¬æ—¥ã®æ³¨ç›®ãƒ¬ãƒ¼ã‚¹äºˆæƒ³" />
                </div>

                <div class="form-group">
                    <label for="targetPlan">é…ä¿¡å¯¾è±¡</label>
                    <select id="targetPlan">
                        <option value="all">å…¨ä¼šå“¡</option>
                        <option value="free">ç„¡æ–™ä¼šå“¡ã®ã¿</option>
                        <option value="paid">æœ‰æ–™ä¼šå“¡ã®ã¿ï¼ˆStandard + Premiumï¼‰</option>
                        <option value="standard">Standardä¼šå“¡ã®ã¿</option>
                        <option value="premium">Premiumä¼šå“¡ã®ã¿</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="templateType">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¿ã‚¤ãƒ—</label>
                    <select id="templateType">
                        <option value="prediction">äºˆæƒ³é…ä¿¡</option>
                        <option value="result">çµæœå ±å‘Š</option>
                        <option value="campaign">ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³</option>
                        <option value="custom">ã‚«ã‚¹ã‚¿ãƒ </option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="mainContent">æœ¬æ–‡</label>
                    <textarea id="mainContent" rows="10" placeholder="ãƒ¡ãƒ¼ãƒ«ã®æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
                </div>

                <!-- äºˆæƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆäºˆæƒ³é…ä¿¡ã‚¿ã‚¤ãƒ—ã®å ´åˆï¼‰ -->
                <div id="predictionSection" style="display: none;">
                    <h3>äºˆæƒ³æƒ…å ±</h3>
                    <div id="predictionsContainer">
                        <div class="prediction-input">
                            <input type="text" placeholder="ãƒ¬ãƒ¼ã‚¹åï¼ˆä¾‹: ç¬¬11R ãƒ¡ã‚¤ãƒ³ãƒ¬ãƒ¼ã‚¹ï¼‰" class="race-name" />
                            <textarea placeholder="äºˆæƒ³é¦¬ï¼ˆæ”¹è¡ŒåŒºåˆ‡ã‚Šï¼‰" rows="3" class="race-horses"></textarea>
                        </div>
                    </div>
                    <button type="button" id="addPrediction" class="btn-secondary">+ äºˆæƒ³ã‚’è¿½åŠ </button>
                </div>

                <div class="form-group">
                    <label for="scheduledAt">é…ä¿¡äºˆç´„ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</label>
                    <input type="datetime-local" id="scheduledAt" />
                    <small>ç©ºæ¬„ã®å ´åˆã¯å³æ™‚é…ä¿¡ã•ã‚Œã¾ã™</small>
                </div>

                <div class="button-group">
                    <button id="previewBtn" class="btn-secondary">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
                    <button id="sendBtn" class="btn-primary">é…ä¿¡å®Ÿè¡Œ</button>
                </div>
            </div>

            <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ -->
            <div class="card">
                <h2>ãƒ¡ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
                <div id="previewArea" class="preview-container">
                    <p class="preview-placeholder">é…ä¿¡å†…å®¹ã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã™ã‚‹ã«ã¯ã€Œãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„</p>
                </div>
            </div>

            <!-- é…ä¿¡å±¥æ­´ -->
            <div class="card">
                <h2>æœ€è¿‘ã®é…ä¿¡</h2>
                <div id="historyArea">
                    <p class="loading">èª­ã¿è¾¼ã¿ä¸­...</p>
                </div>
            </div>
        </div>
    </div>
</BaseLayout>

<script>
    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¿ã‚¤ãƒ—å¤‰æ›´æ™‚ã®å‡¦ç†
    const templateType = document.getElementById('templateType');
    const predictionSection = document.getElementById('predictionSection');
    
    templateType?.addEventListener('change', () => {
        if (templateType.value === 'prediction') {
            predictionSection.style.display = 'block';
        } else {
            predictionSection.style.display = 'none';
        }
    });

    // äºˆæƒ³è¿½åŠ ãƒœã‚¿ãƒ³
    document.getElementById('addPrediction')?.addEventListener('click', () => {
        const container = document.getElementById('predictionsContainer');
        const newPrediction = document.createElement('div');
        newPrediction.className = 'prediction-input';
        newPrediction.innerHTML = `
            <input type="text" placeholder="ãƒ¬ãƒ¼ã‚¹å" class="race-name" />
            <textarea placeholder="äºˆæƒ³é¦¬ï¼ˆæ”¹è¡ŒåŒºåˆ‡ã‚Šï¼‰" rows="3" class="race-horses"></textarea>
            <button type="button" class="remove-prediction">å‰Šé™¤</button>
        `;
        container.appendChild(newPrediction);
        
        // å‰Šé™¤ãƒœã‚¿ãƒ³ã®å‡¦ç†
        newPrediction.querySelector('.remove-prediction')?.addEventListener('click', () => {
            newPrediction.remove();
        });
    });

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆ
    document.getElementById('previewBtn')?.addEventListener('click', async () => {
        const subject = document.getElementById('subject').value;
        const mainContent = document.getElementById('mainContent').value;
        const templateType = document.getElementById('templateType').value;
        
        if (!subject || !mainContent) {
            alert('ä»¶åã¨æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }

        // äºˆæƒ³ãƒ‡ãƒ¼ã‚¿åé›†
        let predictions = [];
        if (templateType === 'prediction') {
            const predictionInputs = document.querySelectorAll('.prediction-input');
            predictions = Array.from(predictionInputs).map(input => {
                const raceName = input.querySelector('.race-name').value;
                const horses = input.querySelector('.race-horses').value
                    .split('\n')
                    .filter(h => h.trim())
                    .map(h => h.trim());
                return { raceName, horses };
            }).filter(p => p.raceName && p.horses.length > 0);
        }

        // HTMLãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”Ÿæˆ
        const htmlContent = generateNewsletterHTML({
            title: subject,
            mainContent: mainContent,
            predictions: predictions
        });

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
        const previewArea = document.getElementById('previewArea');
        previewArea.innerHTML = `
            <div class="email-frame">
                <div class="email-header">
                    <strong>ä»¶å:</strong> ${subject}
                </div>
                <iframe srcdoc="${htmlContent.replace(/"/g, '&quot;')}" style="width: 100%; height: 600px; border: 1px solid #ddd;"></iframe>
            </div>
        `;
    });

    // é…ä¿¡å®Ÿè¡Œ
    document.getElementById('sendBtn')?.addEventListener('click', async () => {
        const subject = document.getElementById('subject').value;
        const mainContent = document.getElementById('mainContent').value;
        const targetPlan = document.getElementById('targetPlan').value;
        const templateType = document.getElementById('templateType').value;
        const scheduledAt = document.getElementById('scheduledAt').value;
        
        if (!subject || !mainContent) {
            alert('ä»¶åã¨æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }

        if (!confirm(`${targetPlan === 'all' ? 'å…¨ä¼šå“¡' : targetPlan + 'ä¼šå“¡'}ã«é…ä¿¡ã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) {
            return;
        }

        // äºˆæƒ³ãƒ‡ãƒ¼ã‚¿åé›†
        let predictions = [];
        if (templateType === 'prediction') {
            const predictionInputs = document.querySelectorAll('.prediction-input');
            predictions = Array.from(predictionInputs).map(input => {
                const raceName = input.querySelector('.race-name').value;
                const horses = input.querySelector('.race-horses').value
                    .split('\n')
                    .filter(h => h.trim())
                    .map(h => h.trim());
                return { raceName, horses };
            }).filter(p => p.raceName && p.horses.length > 0);
        }

        // HTMLãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”Ÿæˆ
        const htmlContent = generateNewsletterHTML({
            title: subject,
            mainContent: mainContent,
            predictions: predictions
        });

        try {
            const response = await fetch('/.netlify/functions/send-newsletter', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    subject,
                    htmlContent,
                    targetPlan,
                    scheduledAt: scheduledAt || null
                })
            });

            const result = await response.json();
            
            if (response.ok) {
                alert(`âœ… é…ä¿¡æˆåŠŸï¼${result.message}`);
                // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
                document.getElementById('subject').value = '';
                document.getElementById('mainContent').value = '';
                document.getElementById('targetPlan').value = 'all';
                document.getElementById('templateType').value = 'prediction';
                document.getElementById('scheduledAt').value = '';
            } else {
                alert(`âŒ é…ä¿¡å¤±æ•—: ${result.error}`);
            }
        } catch (error) {
            console.error('é…ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
            alert('é…ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        }
    });

    // HTMLãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”Ÿæˆé–¢æ•°
    function generateNewsletterHTML({ title, mainContent, predictions = [] }) {
        return `
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${title}</title>
    <style>
        body { margin: 0; padding: 0; font-family: 'Helvetica Neue', Arial, sans-serif; background-color: #f5f5f5; }
        .container { max-width: 600px; margin: 0 auto; background-color: #ffffff; }
        .header { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: white; padding: 40px 30px; text-align: center; }
        .logo { font-size: 28px; font-weight: bold; margin-bottom: 10px; }
        .tagline { font-size: 14px; color: #94a3b8; }
        .content { padding: 40px 30px; }
        .section-title { font-size: 24px; color: #0f172a; margin-bottom: 20px; font-weight: bold; }
        .prediction-card { background: #f8fafc; border-radius: 12px; padding: 20px; margin-bottom: 20px; border-left: 4px solid #3b82f6; }
        .race-title { font-size: 18px; font-weight: bold; color: #1e293b; margin-bottom: 10px; }
        .horses { margin: 10px 0; }
        .horse-item { padding: 5px 0; color: #475569; }
        .cta-button { display: inline-block; background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; padding: 15px 40px; text-decoration: none; border-radius: 8px; font-weight: bold; margin: 30px 0; }
        .footer { background: #f1f5f9; padding: 30px; text-align: center; color: #64748b; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">ğŸ‡ NANKANã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹</div>
            <div class="tagline">AIãƒ»æ©Ÿæ¢°å­¦ç¿’ã§å‹ã¤å—é–¢ç«¶é¦¬</div>
        </div>
        
        <div class="content">
            <div style="color: #475569; line-height: 1.8; white-space: pre-wrap;">
${mainContent}
            </div>
            
            ${predictions.length > 0 ? `
            <h3 style="color: #1e293b; margin-top: 40px; margin-bottom: 20px;">ğŸ¯ æœ¬æ—¥ã®æ³¨ç›®äºˆæƒ³</h3>
            ${predictions.map(p => `
            <div class="prediction-card">
                <div class="race-title">ğŸ ${p.raceName}</div>
                <div class="horses">
                    ${p.horses.map(h => `<div class="horse-item">â— ${h}</div>`).join('')}
                </div>
            </div>
            `).join('')}
            ` : ''}
            
            <div style="text-align: center;">
                <a href="https://nankan-analytics.keiba.link/pricing/" class="cta-button">
                    æœ‰æ–™ãƒ—ãƒ©ãƒ³ã§å…¨ãƒ¬ãƒ¼ã‚¹äºˆæƒ³ã‚’è¦‹ã‚‹
                </a>
            </div>
        </div>
        
        <div class="footer">
            <p>Â© 2025 NANKANã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹</p>
        </div>
    </div>
</body>
</html>
        `;
    }
</script>

<style>
    .newsletter-admin {
        min-height: 100vh;
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        color: #e2e8f0;
        padding: 2rem;
    }

    .admin-header {
        text-align: center;
        margin-bottom: 3rem;
    }

    .admin-header h1 {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
    }

    .subtitle {
        color: #94a3b8;
        font-size: 1.125rem;
    }

    .admin-container {
        max-width: 1200px;
        margin: 0 auto;
        display: grid;
        gap: 2rem;
    }

    .card {
        background: rgba(30, 41, 59, 0.9);
        border-radius: 1rem;
        padding: 2rem;
        border: 1px solid rgba(51, 65, 85, 0.5);
    }

    .card h2 {
        margin-top: 0;
        color: #f1f5f9;
        margin-bottom: 1.5rem;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        color: #cbd5e1;
        font-weight: 500;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 0.75rem;
        background: rgba(15, 23, 42, 0.5);
        border: 1px solid rgba(51, 65, 85, 0.5);
        border-radius: 0.5rem;
        color: #e2e8f0;
        font-size: 1rem;
    }

    .form-group small {
        display: block;
        margin-top: 0.25rem;
        color: #64748b;
    }

    .prediction-input {
        background: rgba(15, 23, 42, 0.3);
        padding: 1rem;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
        display: grid;
        gap: 0.5rem;
    }

    .prediction-input input,
    .prediction-input textarea {
        width: 100%;
        padding: 0.5rem;
        background: rgba(30, 41, 59, 0.8);
        border: 1px solid rgba(51, 65, 85, 0.5);
        border-radius: 0.25rem;
        color: #e2e8f0;
    }

    .remove-prediction {
        background: #ef4444;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 0.25rem;
        cursor: pointer;
        font-size: 0.875rem;
    }

    .button-group {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
    }

    .btn-primary,
    .btn-secondary {
        padding: 0.75rem 2rem;
        border: none;
        border-radius: 0.5rem;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-primary {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        color: white;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
    }

    .btn-secondary {
        background: #475569;
        color: #e2e8f0;
    }

    .btn-secondary:hover {
        background: #64748b;
    }

    .preview-container {
        background: rgba(15, 23, 42, 0.5);
        border-radius: 0.5rem;
        padding: 1rem;
        min-height: 200px;
    }

    .preview-placeholder {
        color: #64748b;
        text-align: center;
        padding: 3rem;
    }

    .email-frame {
        background: white;
        border-radius: 0.5rem;
        overflow: hidden;
    }

    .email-header {
        background: #f1f5f9;
        padding: 1rem;
        color: #1e293b;
        border-bottom: 1px solid #e2e8f0;
    }

    .loading {
        color: #64748b;
        text-align: center;
        padding: 2rem;
    }
</style>