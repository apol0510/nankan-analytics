---
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout title="ãƒ—ãƒ©ãƒ³ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ | NANKANã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹" description="ã‚ˆã‚Šé«˜åº¦ãªAIäºˆæƒ³ã¨è©³ç´°ãªåˆ†æãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã€‚ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³ã§å…¨ãƒ¬ãƒ¼ã‚¹äºˆæƒ³ã‚’ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™ã€‚">
    <div class="upgrade-container">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="upgrade-header">
            <h1>ğŸš€ ãƒ—ãƒ©ãƒ³ã‚’ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰</h1>
            <p class="subtitle">ã‚ˆã‚Šè©³ç´°ãªäºˆæƒ³ã¨é«˜åº¦ãªåˆ†æã§ã•ã‚‰ãªã‚‹çš„ä¸­ã‚’</p>
        </div>

        <!-- ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³è¡¨ç¤º -->
        <div id="current-plan-info" class="current-plan">
            <h3>ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³</h3>
            <div id="plan-display" class="plan-display">
                <div class="loading">
                    <div class="spinner"></div>
                    <span>ãƒ—ãƒ©ãƒ³æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...</span>
                </div>
            </div>
        </div>

        <!-- ãƒ—ãƒ©ãƒ³æ¯”è¼ƒè¡¨ -->
        <div class="plans-comparison">
            <h2 class="section-title">ãƒ—ãƒ©ãƒ³æ¯”è¼ƒ</h2>
            
            <div class="plans-grid">
                <!-- ç„¡æ–™ãƒ—ãƒ©ãƒ³ -->
                <div class="plan-card free">
                    <div class="plan-header">
                        <span class="plan-icon">ğŸ¯</span>
                        <h3>ç„¡æ–™ãƒ—ãƒ©ãƒ³</h3>
                        <div class="price">
                            <span class="amount">Â¥0</span>
                            <span class="period">/æœˆ</span>
                        </div>
                    </div>
                    
                    <ul class="features">
                        <li class="included">âœ… ãƒ¡ã‚¤ãƒ³ãƒ¬ãƒ¼ã‚¹ï¼ˆ11Rï¼‰äºˆæƒ³</li>
                        <li class="included">âœ… åŸºæœ¬çš„ãªåˆ†æãƒ‡ãƒ¼ã‚¿</li>
                        <li class="included">âœ… é€±1å›ã®ãƒ¡ãƒ¼ãƒ«ãƒã‚¬ã‚¸ãƒ³</li>
                        <li class="not-included">âŒ å…¨ãƒ¬ãƒ¼ã‚¹äºˆæƒ³</li>
                        <li class="not-included">âŒ è©³ç´°ãªç‰¹å¾´é‡åˆ†æ</li>
                        <li class="not-included">âŒ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°</li>
                    </ul>
                    
                    <div class="plan-footer">
                        <button class="plan-btn disabled" disabled>ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³</button>
                    </div>
                </div>

                <!-- ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ãƒ—ãƒ©ãƒ³ -->
                <div class="plan-card standard recommended">
                    <div class="recommended-badge">äººæ°—No.1</div>
                    <div class="plan-header">
                        <span class="plan-icon">â­</span>
                        <h3>ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰</h3>
                        <div class="price">
                            <span class="amount">Â¥2,980</span>
                            <span class="period">/æœˆ</span>
                        </div>
                    </div>
                    
                    <ul class="features">
                        <li class="included">âœ… å¾ŒåŠ3ãƒ¬ãƒ¼ã‚¹ï¼ˆ10-12Rï¼‰äºˆæƒ³</li>
                        <li class="included">âœ… AIä¿¡é ¼åº¦ã‚¹ã‚³ã‚¢è¡¨ç¤º</li>
                        <li class="included">âœ… éå»30æ—¥é–“ã®ãƒ‡ãƒ¼ã‚¿</li>
                        <li class="included">âœ… é€±2å›ã®ãƒ¡ãƒ¼ãƒ«ãƒã‚¬ã‚¸ãƒ³</li>
                        <li class="included">âœ… è²·ã„ç›®è‡ªå‹•ç”Ÿæˆ</li>
                        <li class="not-included">âŒ å‰åŠãƒ¬ãƒ¼ã‚¹äºˆæƒ³</li>
                    </ul>
                    
                    <div class="plan-footer">
                        <a href="/pricing?plan=standard" class="plan-btn primary">
                            ã“ã®ãƒ—ãƒ©ãƒ³ã‚’é¸ã¶
                        </a>
                    </div>
                </div>

                <!-- ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³ -->
                <div class="plan-card premium">
                    <div class="plan-header">
                        <span class="plan-icon">ğŸ‘‘</span>
                        <h3>ãƒ—ãƒ¬ãƒŸã‚¢ãƒ </h3>
                        <div class="price">
                            <span class="amount">Â¥5,980</span>
                            <span class="period">/æœˆ</span>
                        </div>
                    </div>
                    
                    <ul class="features">
                        <li class="included">âœ… å…¨12ãƒ¬ãƒ¼ã‚¹å®Œå…¨äºˆæƒ³</li>
                        <li class="included">âœ… XGBoostÃ—LSTMè©³ç´°åˆ†æ</li>
                        <li class="included">âœ… å…¨æœŸé–“ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹</li>
                        <li class="included">âœ… æ¯æ—¥ã®ãƒ¡ãƒ¼ãƒ«ãƒã‚¬ã‚¸ãƒ³</li>
                        <li class="included">âœ… ç‰¹åˆ¥ãƒ¬ãƒãƒ¼ãƒˆé…ä¿¡</li>
                        <li class="included">âœ… å„ªå…ˆã‚µãƒãƒ¼ãƒˆ</li>
                    </ul>
                    
                    <div class="plan-footer">
                        <a href="/pricing?plan=premium" class="plan-btn premium-btn">
                            æœ€ä¸Šä½ãƒ—ãƒ©ãƒ³ã‚’é¸ã¶
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç‰¹å…¸ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="benefits-section">
            <h2 class="section-title">ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ç‰¹å…¸</h2>
            <div class="benefits-grid">
                <div class="benefit">
                    <span class="benefit-icon">ğŸ“Š</span>
                    <h4>é«˜ç²¾åº¦AIäºˆæƒ³</h4>
                    <p>çš„ä¸­ç‡87%ã€å›åç‡156%ã®å®Ÿç¸¾</p>
                </div>
                <div class="benefit">
                    <span class="benefit-icon">âš¡</span>
                    <h4>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°</h4>
                    <p>æœ€æ–°ã®ã‚ªãƒƒã‚ºã¨æƒ…å ±ã‚’å³åº§ã«åæ˜ </p>
                </div>
                <div class="benefit">
                    <span class="benefit-icon">ğŸ¯</span>
                    <h4>è²·ã„ç›®æœ€é©åŒ–</h4>
                    <p>è³‡é‡‘é…åˆ†ã¾ã§å«ã‚ãŸæˆ¦ç•¥ææ¡ˆ</p>
                </div>
                <div class="benefit">
                    <span class="benefit-icon">ğŸ’°</span>
                    <h4>30æ—¥é–“è¿”é‡‘ä¿è¨¼</h4>
                    <p>æº€è¶³ã„ãŸã ã‘ãªã„å ´åˆã¯å…¨é¡è¿”é‡‘</p>
                </div>
            </div>
        </div>

        <!-- FAQ -->
        <div class="faq-section">
            <h2 class="section-title">ã‚ˆãã‚ã‚‹è³ªå•</h2>
            <div class="faq-list">
                <details class="faq-item">
                    <summary>ãƒ—ãƒ©ãƒ³ã¯ã„ã¤ã§ã‚‚å¤‰æ›´ã§ãã¾ã™ã‹ï¼Ÿ</summary>
                    <p>ã¯ã„ã€ã„ã¤ã§ã‚‚å¤‰æ›´å¯èƒ½ã§ã™ã€‚ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã¯å³åº§ã«åæ˜ ã•ã‚Œã€ãƒ€ã‚¦ãƒ³ã‚°ãƒ¬ãƒ¼ãƒ‰ã¯æ¬¡å›è«‹æ±‚ã‚µã‚¤ã‚¯ãƒ«ã‹ã‚‰é©ç”¨ã•ã‚Œã¾ã™ã€‚</p>
                </details>
                <details class="faq-item">
                    <summary>æ”¯æ‰•ã„æ–¹æ³•ã¯ä½•ãŒä½¿ãˆã¾ã™ã‹ï¼Ÿ</summary>
                    <p>ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ï¼ˆVisaã€MasterCardã€JCBã€AMEXï¼‰ãŠã‚ˆã³ãƒ‡ãƒ“ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ãŒã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™ã€‚</p>
                </details>
                <details class="faq-item">
                    <summary>è§£ç´„ã¯ã„ã¤ã§ã‚‚ã§ãã¾ã™ã‹ï¼Ÿ</summary>
                    <p>ã¯ã„ã€ã„ã¤ã§ã‚‚è§£ç´„å¯èƒ½ã§ã™ã€‚è§£ç´„å¾Œã‚‚è«‹æ±‚æœŸé–“ã®çµ‚äº†ã¾ã§ã¯ã‚µãƒ¼ãƒ“ã‚¹ã‚’ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™ã€‚</p>
                </details>
            </div>
        </div>
    </div>
</BaseLayout>

<style>
    .upgrade-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 40px 20px;
    }

    .upgrade-header {
        text-align: center;
        margin-bottom: 60px;
    }

    .upgrade-header h1 {
        font-size: 48px;
        font-weight: 700;
        margin-bottom: 16px;
        background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .subtitle {
        font-size: 20px;
        color: #94a3b8;
    }

    .current-plan {
        background: rgba(30, 41, 59, 0.8);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(59, 130, 246, 0.3);
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 60px;
        text-align: center;
    }

    .current-plan h3 {
        color: #cbd5e1;
        margin-bottom: 16px;
    }

    .plan-display {
        font-size: 18px;
        color: #f1f5f9;
    }

    .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        color: #94a3b8;
    }

    .spinner {
        width: 24px;
        height: 24px;
        border: 2px solid rgba(59, 130, 246, 0.2);
        border-top: 2px solid #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .section-title {
        font-size: 32px;
        font-weight: 700;
        text-align: center;
        margin-bottom: 40px;
        color: #f1f5f9;
    }

    .plans-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 30px;
        margin-bottom: 60px;
    }

    .plan-card {
        background: rgba(30, 41, 59, 0.8);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(59, 130, 246, 0.3);
        border-radius: 16px;
        padding: 32px;
        position: relative;
        transition: transform 0.3s, box-shadow 0.3s;
    }

    .plan-card.recommended {
        border: 2px solid #10b981;
        transform: scale(1.05);
        box-shadow: 0 20px 40px rgba(16, 185, 129, 0.2);
    }

    .recommended-badge {
        position: absolute;
        top: -12px;
        right: 20px;
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        padding: 4px 16px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
    }

    .plan-header {
        text-align: center;
        margin-bottom: 32px;
    }

    .plan-icon {
        font-size: 48px;
        display: block;
        margin-bottom: 16px;
    }

    .plan-card h3 {
        font-size: 24px;
        margin-bottom: 16px;
        color: #f1f5f9;
    }

    .price {
        display: flex;
        align-items: baseline;
        justify-content: center;
        gap: 4px;
    }

    .amount {
        font-size: 36px;
        font-weight: 700;
        color: #3b82f6;
    }

    .period {
        color: #94a3b8;
        font-size: 16px;
    }

    .features {
        list-style: none;
        margin-bottom: 32px;
    }

    .features li {
        padding: 12px 0;
        border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        font-size: 15px;
    }

    .features li.included {
        color: #10b981;
    }

    .features li.not-included {
        color: #64748b;
    }

    .plan-btn {
        display: block;
        width: 100%;
        padding: 14px 24px;
        border-radius: 8px;
        text-align: center;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.3s;
        cursor: pointer;
        border: none;
    }

    .plan-btn.disabled {
        background: rgba(148, 163, 184, 0.2);
        color: #64748b;
        cursor: not-allowed;
    }

    .plan-btn.primary {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
    }

    .plan-btn.premium-btn {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
    }

    .plan-btn:not(.disabled):hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
    }

    .benefits-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 30px;
        margin-bottom: 60px;
    }

    .benefit {
        text-align: center;
    }

    .benefit-icon {
        font-size: 48px;
        display: block;
        margin-bottom: 16px;
    }

    .benefit h4 {
        font-size: 20px;
        margin-bottom: 8px;
        color: #f1f5f9;
    }

    .benefit p {
        color: #94a3b8;
    }

    .faq-section {
        margin-top: 60px;
    }

    .faq-item {
        background: rgba(30, 41, 59, 0.8);
        border: 1px solid rgba(59, 130, 246, 0.3);
        border-radius: 8px;
        margin-bottom: 16px;
        padding: 20px;
    }

    .faq-item summary {
        cursor: pointer;
        font-weight: 600;
        color: #f1f5f9;
    }

    .faq-item p {
        margin-top: 16px;
        color: #cbd5e1;
        line-height: 1.6;
    }

    @media (max-width: 768px) {
        .plans-grid {
            grid-template-columns: 1fr;
        }
        
        .plan-card.recommended {
            transform: scale(1);
        }
    }
</style>

<script type="module">
    // Supabaseã‚’CDNã‹ã‚‰ç›´æ¥ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
    import { createClient } from 'https://cdn.skypack.dev/@supabase/supabase-js@2';
    
    const supabaseUrl = 'https://qysycsrhaatudnksbpqe.supabase.co';
    const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF5c3ljc3JoYWF0dWRua3NicHFlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5MzM3MjcsImV4cCI6MjA3MTUwOTcyN30.UDWi7FYqpJNpMhvMMaZoGMXwuD1R2PNH4Tk6Xs1u1pU';
    const supabase = createClient(supabaseUrl, supabaseAnonKey);

    // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    async function getUserWithPlan() {
        const { data: { user }, error } = await supabase.auth.getUser();
        if (error || !user) return { user: null, plan: 'free' };

        // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‹ã‚‰ãƒ—ãƒ©ãƒ³æƒ…å ±ã‚’å–å¾—
        try {
            const { data: profile, error } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', user.id)
                .maybeSingle();

            if (error) {
                console.warn('Profile fetch error:', error);
                return { user, plan: 'free' };
            }

            // æ—¢å­˜ã®ã‚«ãƒ©ãƒ åã‚’è©¦ã™
            const planName = profile?.subscription_tier?.toLowerCase() || 
                           profile?.subscription_plan?.toLowerCase() || 
                           profile?.subscription_status?.toLowerCase() ||
                           profile?.plan?.toLowerCase();

            let plan = 'free';
            if (planName?.includes('premium')) plan = 'premium';
            else if (planName?.includes('standard')) plan = 'standard';

            return { user, plan };
        } catch (error) {
            console.warn('Profile query error:', error);
            return { user, plan: 'free' };
        }
    }

    function getPlanDisplayName(plan) {
        const names = {
            free: 'Free',
            standard: 'Standard',
            premium: 'Premium'
        };
        return names[plan] || 'Free';
    }

    function getPlanIcon(plan) {
        const icons = {
            free: 'ğŸ‘€',
            standard: 'â­',
            premium: 'ğŸ’'
        };
        return icons[plan] || 'ğŸ‘€';
    }

    async function displayCurrentPlan() {
        const planDisplay = document.getElementById('plan-display');
        
        try {
            const { user, plan } = await getUserWithPlan();
            
            if (user) {
                const planName = getPlanDisplayName(plan);
                const planIcon = getPlanIcon(plan);
                
                planDisplay.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; gap: 12px;">
                        <span style="font-size: 32px;">${planIcon}</span>
                        <span style="font-size: 24px; font-weight: 600;">${planName}</span>
                    </div>
                    <p style="color: #94a3b8; margin-top: 12px;">
                        ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹: ${user.email}
                    </p>
                `;
                
                // ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³ã®ãƒœã‚¿ãƒ³ã‚’æ›´æ–°
                if (plan === 'standard') {
                    const standardBtn = document.querySelector('.plan-card.standard .plan-btn');
                    standardBtn.textContent = 'ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³';
                    standardBtn.classList.add('disabled');
                    standardBtn.setAttribute('disabled', 'true');
                } else if (plan === 'premium') {
                    const premiumBtn = document.querySelector('.plan-card.premium .plan-btn');
                    premiumBtn.textContent = 'ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³';
                    premiumBtn.classList.add('disabled');
                    premiumBtn.setAttribute('disabled', 'true');
                }
            } else {
                planDisplay.innerHTML = `
                    <div>
                        <p style="color: #94a3b8;">ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“</p>
                        <a href="/auth/login" style="color: #3b82f6; text-decoration: underline; margin-top: 12px; display: inline-block;">
                            ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³ã‚’ç¢ºèª
                        </a>
                    </div>
                `;
            }
        } catch (error) {
            console.error('Error loading plan info:', error);
            planDisplay.innerHTML = '<p style="color: #ef4444;">ãƒ—ãƒ©ãƒ³æƒ…å ±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        displayCurrentPlan();
    });
</script>