---
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout title="プランアップグレード | NANKANアナリティクス" description="より高度なAI予想と詳細な分析データにアクセス。プレミアムプランで全レース予想をご利用いただけます。">
    <div class="upgrade-container">
        <!-- ヘッダー -->
        <div class="upgrade-header">
            <h1>🚀 プランをアップグレード</h1>
            <p class="subtitle">より詳細な予想と高度な分析でさらなる的中を</p>
        </div>

        <!-- 現在のプラン表示 -->
        <div id="current-plan-info" class="current-plan">
            <h3>現在のプラン</h3>
            <div id="plan-display" class="plan-display">
                <div class="loading">
                    <div class="spinner"></div>
                    <span>プラン情報を読み込み中...</span>
                </div>
            </div>
        </div>

        <!-- プラン比較表 -->
        <div class="plans-comparison">
            <h2 class="section-title">プラン比較</h2>
            
            <div class="plans-grid">
                <!-- 無料プラン -->
                <div class="plan-card free">
                    <div class="plan-header">
                        <span class="plan-icon">🎯</span>
                        <h3>無料プラン</h3>
                        <div class="price">
                            <span class="amount">¥0</span>
                            <span class="period">/月</span>
                        </div>
                    </div>
                    
                    <ul class="features">
                        <li class="included">✅ メインレース（11R）予想</li>
                        <li class="included">✅ 基本的な分析データ</li>
                        <li class="included">✅ 週1回のメールマガジン</li>
                        <li class="not-included">❌ 全レース予想</li>
                        <li class="not-included">❌ 詳細な特徴量分析</li>
                        <li class="not-included">❌ リアルタイム更新</li>
                    </ul>
                    
                    <div class="plan-footer">
                        <button class="plan-btn disabled" disabled>現在のプラン</button>
                    </div>
                </div>

                <!-- スタンダードプラン -->
                <div class="plan-card standard recommended">
                    <div class="recommended-badge">人気No.1</div>
                    <div class="plan-header">
                        <span class="plan-icon">⭐</span>
                        <h3>スタンダード</h3>
                        <div class="price">
                            <span class="amount">¥2,980</span>
                            <span class="period">/月</span>
                        </div>
                    </div>
                    
                    <ul class="features">
                        <li class="included">✅ 後半3レース（10-12R）予想</li>
                        <li class="included">✅ AI信頼度スコア表示</li>
                        <li class="included">✅ 過去30日間のデータ</li>
                        <li class="included">✅ 週2回のメールマガジン</li>
                        <li class="included">✅ 買い目自動生成</li>
                        <li class="not-included">❌ 前半レース予想</li>
                    </ul>
                    
                    <div class="plan-footer">
                        <a href="/pricing?plan=standard" class="plan-btn primary">
                            このプランを選ぶ
                        </a>
                    </div>
                </div>

                <!-- プレミアムプラン -->
                <div class="plan-card premium">
                    <div class="plan-header">
                        <span class="plan-icon">👑</span>
                        <h3>プレミアム</h3>
                        <div class="price">
                            <span class="amount">¥5,980</span>
                            <span class="period">/月</span>
                        </div>
                    </div>
                    
                    <ul class="features">
                        <li class="included">✅ 全12レース完全予想</li>
                        <li class="included">✅ XGBoost×LSTM詳細分析</li>
                        <li class="included">✅ 全期間データアクセス</li>
                        <li class="included">✅ 毎日のメールマガジン</li>
                        <li class="included">✅ 特別レポート配信</li>
                        <li class="included">✅ 優先サポート</li>
                    </ul>
                    
                    <div class="plan-footer">
                        <a href="/pricing?plan=premium" class="plan-btn premium-btn">
                            最上位プランを選ぶ
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- 特典セクション -->
        <div class="benefits-section">
            <h2 class="section-title">アップグレード特典</h2>
            <div class="benefits-grid">
                <div class="benefit">
                    <span class="benefit-icon">📊</span>
                    <h4>高精度AI予想</h4>
                    <p>的中率87%、回収率156%の実績</p>
                </div>
                <div class="benefit">
                    <span class="benefit-icon">⚡</span>
                    <h4>リアルタイム更新</h4>
                    <p>最新のオッズと情報を即座に反映</p>
                </div>
                <div class="benefit">
                    <span class="benefit-icon">🎯</span>
                    <h4>買い目最適化</h4>
                    <p>資金配分まで含めた戦略提案</p>
                </div>
                <div class="benefit">
                    <span class="benefit-icon">💰</span>
                    <h4>30日間返金保証</h4>
                    <p>満足いただけない場合は全額返金</p>
                </div>
            </div>
        </div>

        <!-- FAQ -->
        <div class="faq-section">
            <h2 class="section-title">よくある質問</h2>
            <div class="faq-list">
                <details class="faq-item">
                    <summary>プランはいつでも変更できますか？</summary>
                    <p>はい、いつでも変更可能です。アップグレードは即座に反映され、ダウングレードは次回請求サイクルから適用されます。</p>
                </details>
                <details class="faq-item">
                    <summary>支払い方法は何が使えますか？</summary>
                    <p>クレジットカード（Visa、MasterCard、JCB、AMEX）およびデビットカードがご利用いただけます。</p>
                </details>
                <details class="faq-item">
                    <summary>解約はいつでもできますか？</summary>
                    <p>はい、いつでも解約可能です。解約後も請求期間の終了まではサービスをご利用いただけます。</p>
                </details>
            </div>
        </div>
    </div>
</BaseLayout>

<style>
    .upgrade-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 40px 20px;
    }

    .upgrade-header {
        text-align: center;
        margin-bottom: 60px;
    }

    .upgrade-header h1 {
        font-size: 48px;
        font-weight: 700;
        margin-bottom: 16px;
        background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .subtitle {
        font-size: 20px;
        color: #94a3b8;
    }

    .current-plan {
        background: rgba(30, 41, 59, 0.8);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(59, 130, 246, 0.3);
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 60px;
        text-align: center;
    }

    .current-plan h3 {
        color: #cbd5e1;
        margin-bottom: 16px;
    }

    .plan-display {
        font-size: 18px;
        color: #f1f5f9;
    }

    .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        color: #94a3b8;
    }

    .spinner {
        width: 24px;
        height: 24px;
        border: 2px solid rgba(59, 130, 246, 0.2);
        border-top: 2px solid #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .section-title {
        font-size: 32px;
        font-weight: 700;
        text-align: center;
        margin-bottom: 40px;
        color: #f1f5f9;
    }

    .plans-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 30px;
        margin-bottom: 60px;
    }

    .plan-card {
        background: rgba(30, 41, 59, 0.8);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(59, 130, 246, 0.3);
        border-radius: 16px;
        padding: 32px;
        position: relative;
        transition: transform 0.3s, box-shadow 0.3s;
    }

    .plan-card.recommended {
        border: 2px solid #10b981;
        transform: scale(1.05);
        box-shadow: 0 20px 40px rgba(16, 185, 129, 0.2);
    }

    .recommended-badge {
        position: absolute;
        top: -12px;
        right: 20px;
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        padding: 4px 16px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
    }

    .plan-header {
        text-align: center;
        margin-bottom: 32px;
    }

    .plan-icon {
        font-size: 48px;
        display: block;
        margin-bottom: 16px;
    }

    .plan-card h3 {
        font-size: 24px;
        margin-bottom: 16px;
        color: #f1f5f9;
    }

    .price {
        display: flex;
        align-items: baseline;
        justify-content: center;
        gap: 4px;
    }

    .amount {
        font-size: 36px;
        font-weight: 700;
        color: #3b82f6;
    }

    .period {
        color: #94a3b8;
        font-size: 16px;
    }

    .features {
        list-style: none;
        margin-bottom: 32px;
    }

    .features li {
        padding: 12px 0;
        border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        font-size: 15px;
    }

    .features li.included {
        color: #10b981;
    }

    .features li.not-included {
        color: #64748b;
    }

    .plan-btn {
        display: block;
        width: 100%;
        padding: 14px 24px;
        border-radius: 8px;
        text-align: center;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.3s;
        cursor: pointer;
        border: none;
    }

    .plan-btn.disabled {
        background: rgba(148, 163, 184, 0.2);
        color: #64748b;
        cursor: not-allowed;
    }

    .plan-btn.primary {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
    }

    .plan-btn.premium-btn {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
    }

    .plan-btn:not(.disabled):hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
    }

    .benefits-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 30px;
        margin-bottom: 60px;
    }

    .benefit {
        text-align: center;
    }

    .benefit-icon {
        font-size: 48px;
        display: block;
        margin-bottom: 16px;
    }

    .benefit h4 {
        font-size: 20px;
        margin-bottom: 8px;
        color: #f1f5f9;
    }

    .benefit p {
        color: #94a3b8;
    }

    .faq-section {
        margin-top: 60px;
    }

    .faq-item {
        background: rgba(30, 41, 59, 0.8);
        border: 1px solid rgba(59, 130, 246, 0.3);
        border-radius: 8px;
        margin-bottom: 16px;
        padding: 20px;
    }

    .faq-item summary {
        cursor: pointer;
        font-weight: 600;
        color: #f1f5f9;
    }

    .faq-item p {
        margin-top: 16px;
        color: #cbd5e1;
        line-height: 1.6;
    }

    @media (max-width: 768px) {
        .plans-grid {
            grid-template-columns: 1fr;
        }
        
        .plan-card.recommended {
            transform: scale(1);
        }
    }
</style>

<script type="module">
    // SupabaseをCDNから直接インポート
    import { createClient } from 'https://cdn.skypack.dev/@supabase/supabase-js@2';
    
    const supabaseUrl = 'https://qysycsrhaatudnksbpqe.supabase.co';
    const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF5c3ljc3JoYWF0dWRua3NicHFlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5MzM3MjcsImV4cCI6MjA3MTUwOTcyN30.UDWi7FYqpJNpMhvMMaZoGMXwuD1R2PNH4Tk6Xs1u1pU';
    const supabase = createClient(supabaseUrl, supabaseAnonKey);

    // ヘルパー関数
    async function getUserWithPlan() {
        const { data: { user }, error } = await supabase.auth.getUser();
        if (error || !user) return { user: null, plan: 'free' };

        // プロフィールからプラン情報を取得
        try {
            const { data: profile, error } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', user.id)
                .maybeSingle();

            if (error) {
                console.warn('Profile fetch error:', error);
                return { user, plan: 'free' };
            }

            // 既存のカラム名を試す
            const planName = profile?.subscription_tier?.toLowerCase() || 
                           profile?.subscription_plan?.toLowerCase() || 
                           profile?.subscription_status?.toLowerCase() ||
                           profile?.plan?.toLowerCase();

            let plan = 'free';
            if (planName?.includes('premium')) plan = 'premium';
            else if (planName?.includes('standard')) plan = 'standard';

            return { user, plan };
        } catch (error) {
            console.warn('Profile query error:', error);
            return { user, plan: 'free' };
        }
    }

    function getPlanDisplayName(plan) {
        const names = {
            free: 'Free',
            standard: 'Standard',
            premium: 'Premium'
        };
        return names[plan] || 'Free';
    }

    function getPlanIcon(plan) {
        const icons = {
            free: '👀',
            standard: '⭐',
            premium: '💎'
        };
        return icons[plan] || '👀';
    }

    async function displayCurrentPlan() {
        const planDisplay = document.getElementById('plan-display');
        
        try {
            const { user, plan } = await getUserWithPlan();
            
            if (user) {
                const planName = getPlanDisplayName(plan);
                const planIcon = getPlanIcon(plan);
                
                planDisplay.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; gap: 12px;">
                        <span style="font-size: 32px;">${planIcon}</span>
                        <span style="font-size: 24px; font-weight: 600;">${planName}</span>
                    </div>
                    <p style="color: #94a3b8; margin-top: 12px;">
                        メールアドレス: ${user.email}
                    </p>
                `;
                
                // 現在のプランのボタンを更新
                if (plan === 'standard') {
                    const standardBtn = document.querySelector('.plan-card.standard .plan-btn');
                    standardBtn.textContent = '現在のプラン';
                    standardBtn.classList.add('disabled');
                    standardBtn.setAttribute('disabled', 'true');
                } else if (plan === 'premium') {
                    const premiumBtn = document.querySelector('.plan-card.premium .plan-btn');
                    premiumBtn.textContent = '現在のプラン';
                    premiumBtn.classList.add('disabled');
                    premiumBtn.setAttribute('disabled', 'true');
                }
            } else {
                planDisplay.innerHTML = `
                    <div>
                        <p style="color: #94a3b8;">ログインしていません</p>
                        <a href="/auth/login" style="color: #3b82f6; text-decoration: underline; margin-top: 12px; display: inline-block;">
                            ログインして現在のプランを確認
                        </a>
                    </div>
                `;
            }
        } catch (error) {
            console.error('Error loading plan info:', error);
            planDisplay.innerHTML = '<p style="color: #ef4444;">プラン情報の読み込みに失敗しました</p>';
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        displayCurrentPlan();
    });
</script>