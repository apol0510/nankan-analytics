---
import BaseLayout from '../../layouts/BaseLayout.astro';
import ProgressBarConfidence from '../../components/ProgressBarConfidence.astro';
import { processRaceData, processUnifiedRaceData, normalizeHorseData, getRoleDisplayConfig, validateDataIntegrity, getHorseConfidenceFromMark, calculateMarkBasedConfidence, convertToStarRating, getRecommendationStars, generateStandardizedBets, calculateScoreBasedStats, getPredictionDataWithStrategies } from '../../lib/shared-prediction-logic.js';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  // src/data/free-predictions/ å†…ã®å…¨JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
  const freePredictions = import.meta.glob('/src/data/free-predictions/*.json', { eager: true });

  return Object.entries(freePredictions).map(([path, data]) => {
    // ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰æ—¥ä»˜ã‚’æŠ½å‡º (ä¾‹: /src/data/free-predictions/2026-01-07.json â†’ 2026-01-07)
    const fileName = path.split('/').pop().replace('.json', '');
    const [year, month, day] = fileName.split('-');

    return {
      params: { slug: `${year}/${month}/${day}` },
      props: { allRacesData: data }
    };
  });
}

const { allRacesData } = Astro.props;

// å…±æœ‰ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†
const { mainRace, race12R: originalRace12R, sortedRaces } = processRaceData(allRacesData);

if (!mainRace) {
    throw new Error('ãƒ¡ã‚¤ãƒ³ãƒ¬ãƒ¼ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
}

// æ—¥ä»˜ã¨ä¼šå ´ã‚’å–å¾—
const raceDate = allRacesData.raceDate; // "2026-01-07"
const track = allRacesData.track; // "æµ¦å’Œç«¶é¦¬"

// æ—¥ä»˜ã‚’æ—¥æœ¬èªå½¢å¼ã«å¤‰æ›
const [year, month, day] = raceDate.split('-');
const formattedDate = `${parseInt(month)}æœˆ${parseInt(day)}æ—¥`;

// ãƒ¡ã‚¤ãƒ³ãƒ¬ãƒ¼ã‚¹ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
const { raceInfo, horses, analysis, preview = '', allHorses, totalHorses } = mainRace;

// æ­£è¦åŒ–ã•ã‚ŒãŸãƒ›ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ¡ã‚¤ãƒ³ãƒ¬ãƒ¼ã‚¹ç”¨ï¼‰
const normalizedHorses = normalizeHorseData(mainRace);

// çµ±ä¸€ã‚·ã‚¹ãƒ†ãƒ ã§æˆ¦ç•¥ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆï¼ˆJSONãƒ‡ãƒ¼ã‚¿å„ªå…ˆã€å‹•çš„è²·ã„ç›®å¯¾å¿œï¼‰
const raceData = processUnifiedRaceData(mainRace);

// JSONãƒ‡ãƒ¼ã‚¿ã«strategiesãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯å„ªå…ˆä½¿ç”¨
let strategies;
if (mainRace.strategies && mainRace.strategies.safe && mainRace.strategies.balance && mainRace.strategies.aggressive) {
    console.log(`âœ… Archive ${allRacesData.raceDate}: Using JSON strategies data`);

    // JSONãƒ‡ãƒ¼ã‚¿ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã‚’ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆtitleâ†’name, riskâ†’descriptionï¼‰
    const mapStrategy = (s) => ({
        ...s,
        name: s.title || s.name,
        description: s.risk || s.description
    });

    strategies = {
        safe: mapStrategy(mainRace.strategies.safe),
        balance: mapStrategy(mainRace.strategies.balance),
        aggressive: mapStrategy(mainRace.strategies.aggressive)
    };
} else {
    console.log(`âš ï¸ Archive ${allRacesData.raceDate}: Using dynamic strategies`);
    strategies = {
        safe: raceData.strategies.safe,
        balance: raceData.strategies.balance,
        aggressive: raceData.strategies.aggressive
    };
}

// ã‚¹ã‚³ã‚¢è¡¨ç¤ºç”¨ã®ã‚¹ã‚³ã‚¢å¤‰æ•°ã‚’å®šç¾©
const mainHorseScore = getHorseConfidenceFromMark(mainRace.horses.main);
const subHorseScore = getHorseConfidenceFromMark(mainRace.horses.sub);

// ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒšãƒ¼ã‚¸ç”¨ã®ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±
const isArchive = true;
const archiveDate = formattedDate;
---

<BaseLayout title={`ã€${formattedDate}ã€‘ç„¡æ–™äºˆæƒ³ã‚¢ãƒ¼ã‚«ã‚¤ãƒ– | ${raceInfo.title}`} description={`${formattedDate} ${track}ç«¶é¦¬${raceInfo.raceName}ã®AIäºˆæƒ³ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã€‚æ©Ÿæ¢°å­¦ç¿’ãƒ¢ãƒ‡ãƒ«ã«ã‚ˆã‚‹é«˜ç²¾åº¦äºˆæƒ³ã®éå»ãƒ‡ãƒ¼ã‚¿ã€‚`}>
    <div class="container">
        <!-- ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–é€šçŸ¥ãƒãƒŠãƒ¼ -->
        <div class="archive-banner">
            <div class="archive-icon">ğŸ“…</div>
            <div class="archive-text">
                <div class="archive-title">éå»ã®äºˆæƒ³ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–</div>
                <div class="archive-date">{year}å¹´{parseInt(month)}æœˆ{parseInt(day)}æ—¥ ({track})</div>
            </div>
            <a href="/free-prediction/" class="btn-latest">æœ€æ–°ã®äºˆæƒ³ã‚’è¦‹ã‚‹ â†’</a>
        </div>

        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="header-section">
            <div class="ai-badge">
                <span class="pulse"></span>
                <span class="ai-status">AIåˆ†æå®Œäº†</span>
            </div>
            <h1 class="main-title">{formattedDate} {track} ãƒ¡ã‚¤ãƒ³ãƒ¬ãƒ¼ã‚¹ AIäºˆæƒ³</h1>
            <p class="race-title">{raceInfo.raceName}</p>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">èƒ½åŠ›æŒ‡æ•°</div>
                    <div class="stat-value highlight-value">{raceInfo.abilityIndex}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">æœŸå¾…å›åç‡</div>
                    <div class="stat-value">{raceInfo.expectedReturn}%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">è·é›¢</div>
                    <div class="stat-value">{raceInfo.distance}</div>
                </div>
            </div>
        </div>

        <!-- ãƒ¬ãƒ¼ã‚¹ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        {preview && (
            <section class="preview-section">
                <h2 class="section-title">
                    <span class="icon">ğŸ”</span>
                    ãƒ¬ãƒ¼ã‚¹å±•æœ›
                </h2>
                <div class="preview-card">
                    {preview.split('\n').map(paragraph => paragraph.trim() && <p>{paragraph.trim()}</p>)}
                </div>
            </section>
        )}

        <!-- æœ¬å‘½ãƒ»å¯¾æŠ—é¦¬ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <section class="horses-section">
            <h2 class="section-title">
                <span class="icon">ğŸ¯</span>
                æ¨å¥¨é¦¬
            </h2>

            <!-- æœ¬å‘½é¦¬ -->
            <div class="horse-card main-horse">
                <div class="horse-header">
                    <div class="horse-mark">â—</div>
                    <div class="horse-info-header">
                        <div class="horse-number">
                            {horses.main.number}
                            <span class="horse-name">{horses.main.name}</span>
                        </div>
                        <div class="confidence-badge main-badge">
                            ä¿¡é ¼åº¦ {mainHorseScore}%
                        </div>
                    </div>
                </div>

                <div class="analysis-text">
                    {horses.main.reason && horses.main.reason.split('\n').map(paragraph => paragraph.trim() && <p>{paragraph.trim()}</p>)}
                </div>
            </div>

            <!-- å¯¾æŠ—é¦¬ -->
            <div class="horse-card sub-horse">
                <div class="horse-header">
                    <div class="horse-mark sub-mark">â—‹</div>
                    <div class="horse-info-header">
                        <div class="horse-number">
                            {horses.sub.number}
                            <span class="horse-name">{horses.sub.name}</span>
                        </div>
                        <div class="confidence-badge sub-badge">
                            ä¿¡é ¼åº¦ {subHorseScore}%
                        </div>
                    </div>
                </div>

                <div class="analysis-text">
                    {horses.sub.reason && horses.sub.reason.split('\n').map(paragraph => paragraph.trim() && <p>{paragraph.trim()}</p>)}
                </div>
            </div>
        </section>

        <!-- æˆ¦ç•¥ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <section class="strategy-section">
            <h2 class="section-title">
                <span class="icon">ğŸ“Š</span>
                æ¨å¥¨æˆ¦ç•¥
            </h2>

            <div class="strategies-grid">
                <!-- å …å®Ÿæˆ¦ç•¥ -->
                <div class="strategy-card safe">
                    <div class="strategy-header">
                        <div class="strategy-badge">å …å®Ÿå‹</div>
                        <div class="strategy-name">{strategies.safe.name}</div>
                    </div>
                    <div class="strategy-description">{strategies.safe.description}</div>
                    <div class="strategy-stats">
                        <div class="stat">
                            <span class="stat-label">çš„ä¸­ç‡</span>
                            <span class="stat-value-small">{strategies.safe.hitRate}</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">å›åç‡</span>
                            <span class="stat-value-small">{strategies.safe.recoveryRate}</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">æ¨å¥¨é¡</span>
                            <span class="stat-value-small">{strategies.safe.betAmount}</span>
                        </div>
                    </div>
                </div>

                <!-- ãƒãƒ©ãƒ³ã‚¹æˆ¦ç•¥ -->
                <div class="strategy-card balance">
                    <div class="strategy-header">
                        <div class="strategy-badge">ãƒãƒ©ãƒ³ã‚¹å‹</div>
                        <div class="strategy-name">{strategies.balance.name}</div>
                    </div>
                    <div class="strategy-description">{strategies.balance.description}</div>
                    <div class="strategy-stats">
                        <div class="stat">
                            <span class="stat-label">çš„ä¸­ç‡</span>
                            <span class="stat-value-small">{strategies.balance.hitRate}</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">å›åç‡</span>
                            <span class="stat-value-small">{strategies.balance.recoveryRate}</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">æ¨å¥¨é¡</span>
                            <span class="stat-value-small">{strategies.balance.betAmount}</span>
                        </div>
                    </div>
                </div>

                <!-- æ”»æ’ƒçš„æˆ¦ç•¥ -->
                <div class="strategy-card aggressive">
                    <div class="strategy-header">
                        <div class="strategy-badge">æ”»æ’ƒå‹</div>
                        <div class="strategy-name">{strategies.aggressive.name}</div>
                    </div>
                    <div class="strategy-description">{strategies.aggressive.description}</div>
                    <div class="strategy-stats">
                        <div class="stat">
                            <span class="stat-label">çš„ä¸­ç‡</span>
                            <span class="stat-value-small">{strategies.aggressive.hitRate}</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">å›åç‡</span>
                            <span class="stat-value-small">{strategies.aggressive.recoveryRate}</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">æ¨å¥¨é¡</span>
                            <span class="stat-value-small">{strategies.aggressive.betAmount}</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ç”¨CTA -->
        <section class="cta-section">
            <div class="cta-card">
                <h3>æœ€æ–°ã®äºˆæƒ³ã‚’ä»Šã™ããƒã‚§ãƒƒã‚¯</h3>
                <p>æœ€æ–°ãƒ¬ãƒ¼ã‚¹ã®AIäºˆæƒ³ãƒ»è²·ã„ç›®æƒ…å ±ã‚’ç„¡æ–™ã§å…¬é–‹ä¸­</p>
                <div class="cta-buttons">
                    <a href="/free-prediction/" class="btn btn-primary">æœ€æ–°ã®ç„¡æ–™äºˆæƒ³ã‚’è¦‹ã‚‹</a>
                    <a href="/free-prediction/archive/" class="btn btn-secondary">ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ä¸€è¦§ã‚’è¦‹ã‚‹</a>
                </div>
            </div>
        </section>
    </div>
</BaseLayout>

<style>
/* ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒãƒŠãƒ¼ */
.archive-banner {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    border-radius: 16px;
    padding: 20px 30px;
    margin-bottom: 30px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 20px;
    box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
}

.archive-icon {
    font-size: 40px;
}

.archive-text {
    flex: 1;
}

.archive-title {
    color: #ffffff;
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 4px;
}

.archive-date {
    color: #fef3c7;
    font-size: 14px;
}

.btn-latest {
    background-color: #ffffff;
    color: #d97706;
    padding: 12px 24px;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 600;
    white-space: nowrap;
    transition: all 0.3s ease;
}

.btn-latest:hover {
    background-color: #fef3c7;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

/* ãã®ä»–ã®ã‚¹ã‚¿ã‚¤ãƒ«ã¯free-prediction.astroã¨å…±é€š */
.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.header-section {
    text-align: center;
    margin-bottom: 40px;
}

.ai-badge {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 16px;
}

.pulse {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: #ffffff;
    animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(1.2); }
}

.main-title {
    font-size: 32px;
    font-weight: 800;
    margin-bottom: 8px;
    color: #1f2937;
}

.race-title {
    font-size: 18px;
    color: #6b7280;
    margin-bottom: 24px;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 16px;
    max-width: 800px;
    margin: 0 auto;
}

.stat-card {
    background-color: #f9fafb;
    padding: 16px;
    border-radius: 12px;
    text-align: center;
}

.stat-label {
    font-size: 12px;
    color: #6b7280;
    margin-bottom: 8px;
}

.stat-value {
    font-size: 24px;
    font-weight: 700;
    color: #1f2937;
}

.highlight-value {
    color: #3b82f6;
}

.stars-value {
    color: #f59e0b;
}

/* ãƒ¬ãƒ¼ã‚¹ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */
.preview-section, .horses-section, .strategy-section, .cta-section {
    margin-bottom: 40px;
}

.section-title {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 12px;
    color: #1f2937;
}

.icon {
    font-size: 28px;
}

.preview-card {
    background-color: #ffffff;
    border: 2px solid #e5e7eb;
    border-radius: 16px;
    padding: 24px;
    line-height: 1.8;
}

.preview-card p {
    margin-bottom: 12px;
    color: #4b5563;
}

/* é¦¬æƒ…å ±ã‚«ãƒ¼ãƒ‰ */
.horse-card {
    background-color: #ffffff;
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 20px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.main-horse {
    border: 3px solid #3b82f6;
}

.sub-horse {
    border: 3px solid #10b981;
}

.horse-header {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 16px;
}

.horse-mark {
    font-size: 48px;
    color: #3b82f6;
}

.sub-mark {
    color: #10b981;
}

.horse-info-header {
    flex: 1;
}

.horse-number {
    font-size: 24px;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 8px;
}

.horse-name {
    font-size: 20px;
    font-weight: 600;
    margin-left: 12px;
    color: #4b5563;
}

.confidence-badge {
    display: inline-block;
    padding: 6px 12px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
}

.main-badge {
    background-color: #eff6ff;
    color: #3b82f6;
}

.sub-badge {
    background-color: #f0fdf4;
    color: #10b981;
}

.analysis-text {
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid #e5e7eb;
}

.analysis-text p {
    margin-bottom: 12px;
    color: #4b5563;
    line-height: 1.8;
}

/* æˆ¦ç•¥ã‚«ãƒ¼ãƒ‰ */
.strategies-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
}

.strategy-card {
    background-color: #ffffff;
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.strategy-card.safe {
    border-left: 6px solid #3b82f6;
}

.strategy-card.balance {
    border-left: 6px solid #10b981;
}

.strategy-card.aggressive {
    border-left: 6px solid #f59e0b;
}

.strategy-header {
    margin-bottom: 16px;
}

.strategy-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    margin-bottom: 8px;
}

.safe .strategy-badge {
    background-color: #eff6ff;
    color: #3b82f6;
}

.balance .strategy-badge {
    background-color: #f0fdf4;
    color: #10b981;
}

.aggressive .strategy-badge {
    background-color: #fef3c7;
    color: #f59e0b;
}

.strategy-name {
    font-size: 18px;
    font-weight: 700;
    color: #1f2937;
}

.strategy-description {
    color: #6b7280;
    margin-bottom: 16px;
    line-height: 1.6;
}

.strategy-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    padding-top: 16px;
    border-top: 1px solid #e5e7eb;
}

.stat {
    text-align: center;
}

.stat-label {
    font-size: 11px;
    color: #9ca3af;
    display: block;
    margin-bottom: 4px;
}

.stat-value-small {
    font-size: 16px;
    font-weight: 700;
    color: #1f2937;
}

/* CTA */
.cta-card {
    background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
    border-radius: 16px;
    padding: 40px;
    text-align: center;
    color: white;
}

.cta-card h3 {
    font-size: 28px;
    font-weight: 700;
    margin-bottom: 12px;
}

.cta-card p {
    font-size: 16px;
    color: #e0e7ff;
    margin-bottom: 24px;
}

.cta-buttons {
    display: flex;
    gap: 16px;
    justify-content: center;
    flex-wrap: wrap;
}

.btn {
    display: inline-block;
    padding: 14px 28px;
    border-radius: 10px;
    text-decoration: none;
    font-weight: 600;
    font-size: 16px;
    transition: all 0.3s ease;
}

.btn-primary {
    background-color: #ffffff;
    color: #3b82f6;
}

.btn-primary:hover {
    background-color: #eff6ff;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.btn-secondary {
    background-color: transparent;
    color: #ffffff;
    border: 2px solid #ffffff;
}

.btn-secondary:hover {
    background-color: rgba(255, 255, 255, 0.1);
    transform: translateY(-2px);
}

/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
@media (max-width: 768px) {
    .archive-banner {
        flex-direction: column;
        text-align: center;
    }

    .main-title {
        font-size: 24px;
    }

    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }

    .strategies-grid {
        grid-template-columns: 1fr;
    }

    .cta-buttons {
        flex-direction: column;
    }

    .btn {
        width: 100%;
    }
}
</style>
