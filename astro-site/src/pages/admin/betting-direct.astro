---
export const prerender = true;
import BaseLayout from '../../layouts/BaseLayout.astro';
---

<BaseLayout title="買い目直接入力システム" description="マコちゃん専用 - 完成データ直接反映システム">
    <div class="container">
        <div class="header-section">
            <div class="ai-badge">
                <span class="pulse"></span>
                <span class="ai-status">100%確実システム</span>
            </div>
            <h1>🎯 買い目直接入力システム</h1>
            <p class="subtitle">マコちゃんの完成データ → 即座に本番反映</p>
            <div class="guarantee-box">
                <h3>💖 マコちゃん保証事項</h3>
                <ul>
                    <li>✅ premium-predictions/ のデザイン <strong>100%保持</strong></li>
                    <li>✅ 馬情報・スコア・特徴量 <strong>完全更新</strong></li>
                    <li>✅ 買い目・候補馬 <strong>確実更新</strong></li>
                    <li>✅ 全データ一括反映 <strong>完全対応</strong></li>
                    <li>✅ 半角全角・スペース <strong>柔軟対応</strong></li>
                </ul>
            </div>
        </div>

        <div class="form-section">
            <div class="input-section">
                <h2>📝 完成データ入力</h2>
                <div class="format-guide">
                    <p><strong>入力例：</strong> 1R、１R、1 R など柔軟に対応します</p>
                </div>
                <textarea
                    id="complete-data"
                    placeholder="マコちゃんの完成データをそのまま貼り付けてください...

例：
1R
◎ 11 オールスターズ 本命 総合評価:★★★ 累積スコア: 88pt 特徴量重要度 安定性91% 能力上位性90% 展開利81%
○ 5 シャークウォーニン 対抗 総合評価:★★★ 累積スコア: 87pt 特徴量重要度 安定性85% 能力上位性82% 展開利79%
▲ 9 フェアクラウド 単穴 累積スコア: 82pt 特徴量重要度 安定性77% 能力上位性87% 展開利82%
▲ 6 パンオショコラ 単穴2 累積スコア: 76pt

△ 連下候補馬: 4,7,10,13,14
× 押さえ候補馬: 2,12

買い目
少点数的中型モデル 馬単 11 → 5,6,9　3点 AI予測58%
バランス型モデル 馬単 5,6,9 → 11　3点 馬単 11 ⇔ 4,7,10,13,14　8点...
高配当追求型モデル 馬単 11 → 2,12　3点 馬単 5 ⇔ 2,4,7,10,12,13,14　14点...

2R
..."
                    rows="25"></textarea>
            </div>

            <div class="action-buttons">
                <button type="button" id="parse-btn" class="btn-primary">📋 解析・プレビュー</button>
                <button type="button" id="update-json-btn" class="btn-success" style="display: none;">🚀 JSON更新実行</button>
                <a href="/premium-predictions" id="check-result-btn" class="btn-check" style="display: none;">👀 結果確認</a>
            </div>
        </div>

        <div id="preview-section" class="preview-section" style="display: none;">
            <h2>📋 解析結果プレビュー</h2>
            <div id="preview-content"></div>
        </div>

        <div id="success-section" class="success-section" style="display: none;">
            <h2>✅ 更新完了</h2>
            <p>買い目データが正常に更新されました！</p>
            <p><strong>premium-predictions/</strong> で結果をご確認ください。</p>
        </div>
    </div>

    <script>
        let parsedData = null;

        // 解析処理
        document.getElementById('parse-btn').addEventListener('click', function() {
            const inputData = document.getElementById('complete-data').value;

            if (!inputData.trim()) {
                alert('データを入力してください');
                return;
            }

            try {
                parsedData = parseCompleteData(inputData);
                displayPreview(parsedData);

                document.getElementById('preview-section').style.display = 'block';
                document.getElementById('update-json-btn').style.display = 'inline-block';
            } catch (error) {
                alert('データの解析に失敗しました: ' + error.message);
                console.error('Parse error:', error);
            }
        });

        // JSON更新処理
        document.getElementById('update-json-btn').addEventListener('click', function() {
            if (!parsedData) {
                alert('先に解析を実行してください');
                return;
            }

            try {
                updateJsonData(parsedData);
                document.getElementById('success-section').style.display = 'block';
                document.getElementById('check-result-btn').style.display = 'inline-block';

                // 少し下にスクロール
                document.getElementById('success-section').scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                alert('JSON更新に失敗しました: ' + error.message);
                console.error('Update error:', error);
            }
        });

        // 完成データ解析関数（全馬データ対応版）
        function parseCompleteData(data) {
            const lines = data.split('\n').map(line => line.trim()).filter(line => line);
            const raceData = {};

            let currentRace = null;
            let currentSection = null;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];

                // レース番号検出（柔軟対応）1R、１R、1 R、02R、2R など
                const raceMatch = line.match(/^([0１２３４５６７８９０123456789]{1,2})\s*[rRレース]$/);
                if (raceMatch) {
                    // 全角数字を半角に変換
                    const raceNum = raceMatch[1]
                        .replace(/[０１２３４５６７８９]/g, (match) =>
                            String.fromCharCode(match.charCodeAt(0) - 0xFF10 + 0x30))
                        .replace(/[^0-9]/g, '');

                    currentRace = parseInt(raceNum);
                    raceData[currentRace] = {
                        horses: {},
                        candidates: { renka: [], osae: [] },
                        strategies: {}
                    };
                    currentSection = null;
                    console.log(`🎯 レース検出: ${currentRace}R`);
                    continue;
                }

                if (currentRace) {
                    // 馬情報パース（◎○▲△×印対応）
                    const horseMatch = line.match(/^([◎○▲△×])\s*([0-9]+)\s+([^\s]+)\s+(本命|対抗|単穴|単穴2|連下|押さえ)(?:\s+総合評価:([★]+))?(?:\s+累積スコア:?\s*([0-9]+)pt)?(?:\s+特徴量重要度\s+安定性([0-9]+)%\s+能力上位性([0-9]+)%\s+展開利([0-9]+)%)?/);
                    if (horseMatch) {
                        const [, mark, number, name, type, stars, score, stability, ability, development] = horseMatch;

                        const horseData = {
                            number: parseInt(number),
                            name: name,
                            mark: mark,
                            type: type,
                            factors: [],
                            importance: []
                        };

                        // 星評価追加
                        if (stars) {
                            horseData.factors.push({
                                icon: "★",
                                text: `総合評価:${stars}`
                            });
                        }

                        // 累積スコア追加
                        if (score) {
                            horseData.factors.push({
                                icon: "★",
                                text: `累積スコア: ${score}pt`
                            });
                        }

                        // 特徴量重要度追加
                        if (stability && ability && development) {
                            horseData.importance = [
                                { label: "安定性", value: parseInt(stability) / 100 },
                                { label: "能力上位性", value: parseInt(ability) / 100 },
                                { label: "展開利", value: parseInt(development) / 100 }
                            ];
                        }

                        // 馬タイプ別にセット
                        if (type === '本命') {
                            raceData[currentRace].horses.main = horseData;
                        } else if (type === '対抗') {
                            raceData[currentRace].horses.sub = horseData;
                        } else if (type === '単穴') {
                            raceData[currentRace].horses.sub1 = horseData;
                        } else if (type === '単穴2') {
                            raceData[currentRace].horses.sub2 = horseData;
                        }

                        console.log(`🐎 ${currentRace}R ${mark}${number}${name} (${type}) 解析完了`);
                        continue;
                    }

                    // 連下候補馬パース
                    const renkaMatch = line.match(/^[△]\s*連下候補馬[:：]?\s*([0-9,，、\s]+)/);
                    if (renkaMatch) {
                        const numbers = renkaMatch[1]
                            .replace(/[，、]/g, ',')
                            .split(',')
                            .map(n => parseInt(n.trim()))
                            .filter(n => !isNaN(n));

                        raceData[currentRace].candidates.renka = numbers;
                        console.log(`🎯 ${currentRace}R 連下候補馬: ${numbers.join(',')}`);
                        continue;
                    }

                    // 押さえ候補馬パース
                    const osaeMatch = line.match(/^[×]\s*押さえ候補馬[:：]?\s*([0-9,，、\s]+)/);
                    if (osaeMatch) {
                        const numbers = osaeMatch[1]
                            .replace(/[，、]/g, ',')
                            .split(',')
                            .map(n => parseInt(n.trim()))
                            .filter(n => !isNaN(n));

                        raceData[currentRace].candidates.osae = numbers;
                        console.log(`🎯 ${currentRace}R 押さえ候補馬: ${numbers.join(',')}`);
                        continue;
                    }

                    // 買い目セクション検出
                    if (line.includes('買い目') || line.includes('かいめ')) {
                        currentSection = 'betting';
                        continue;
                    }

                    // 戦略別買い目抽出（改良版）
                    if (line.includes('少点数的中型') || line.includes('少点数')) {
                        let fullStrategyText = line;

                        // 次の戦略または次のレースまでの全ての行を結合
                        for (let j = i + 1; j < lines.length; j++) {
                            const nextLine = lines[j];
                            if (nextLine.includes('バランス型') || nextLine.includes('高配当') ||
                                nextLine.match(/^([0１２３４５６７８９０123456789]{1,2})\s*[rRレース]$/)) {
                                break;
                            }
                            fullStrategyText += ' ' + nextLine;
                        }

                        const bets = extractBets(fullStrategyText);
                        if (bets.length > 0) {
                            raceData[currentRace].strategies.safe = bets;
                            console.log(`🎯 ${currentRace}R 戦略A: ${bets.join(', ')}`);
                        }
                    }

                    // バランス型
                    if (line.includes('バランス型') || line.includes('バランス')) {
                        let fullStrategyText = line;

                        for (let j = i + 1; j < lines.length; j++) {
                            const nextLine = lines[j];
                            if (nextLine.includes('高配当') ||
                                nextLine.match(/^([0１２３４５６７８９０123456789]{1,2})\s*[rRレース]$/)) {
                                break;
                            }
                            fullStrategyText += ' ' + nextLine;
                        }

                        const bets = extractBets(fullStrategyText);
                        if (bets.length > 0) {
                            raceData[currentRace].strategies.balance = bets;
                            console.log(`⚖️ ${currentRace}R 戦略B: ${bets.join(', ')}`);
                        }
                    }

                    // 高配当追求型
                    if (line.includes('高配当追求型') || line.includes('高配当')) {
                        let fullStrategyText = line;

                        for (let j = i + 1; j < lines.length; j++) {
                            const nextLine = lines[j];
                            if (nextLine.match(/^([0１２３４５６７８９０123456789]{1,2})\s*[rRレース]$/)) {
                                break;
                            }
                            fullStrategyText += ' ' + nextLine;
                        }

                        const bets = extractBets(fullStrategyText);
                        if (bets.length > 0) {
                            raceData[currentRace].strategies.aggressive = bets;
                            console.log(`🚀 ${currentRace}R 戦略C: ${bets.join(', ')}`);
                        }
                    }
                }
            }

            console.log('📊 解析完了:', raceData);
            return raceData;
        }

        // 買い目抽出関数（完全修正版）
        function extractBets(line) {
            const bets = [];

            // 全角を半角に正規化
            const normalized = line
                .replace(/[０１２３４５６７８９]/g, (char) =>
                    String.fromCharCode(char.charCodeAt(0) - 0xFF10 + 0x30))
                .replace(/，/g, ',')
                .replace(/[↔←]/g, '⇔')
                .trim();

            console.log(`🔍 正規化後のライン: "${normalized}"`);

            // 改良版: 点数を除外した馬単パターン抽出
            // 「馬単 11 → 5,6,9 3点」から「馬単 11 → 5,6,9」を抽出
            const betPattern = /(馬単)\s+([0-9,]+)\s*([→⇔])\s*([0-9,]+)(?:\s+[0-9]+点)?/g;
            let match;

            while ((match = betPattern.exec(normalized)) !== null) {
                const [fullMatch, type, from, arrow, to] = match;

                // スペースを除去してクリーンアップ
                const cleanFrom = from.replace(/\s/g, '');
                const cleanTo = to.replace(/\s/g, '');

                const cleanBet = `馬単 ${cleanFrom} ${arrow} ${cleanTo}`;
                bets.push(cleanBet);
                console.log(`🎯 抽出した買い目: "${cleanBet}"`);
            }

            return bets;
        }

        // プレビュー表示（全データ対応版）
        function displayPreview(data) {
            const previewContent = document.getElementById('preview-content');
            let html = '<div class="race-grid">';

            for (let raceNum = 1; raceNum <= 12; raceNum++) {
                const raceInfo = data[raceNum];
                if (!raceInfo) continue;

                html += `
                    <div class="race-preview">
                        <h3>${raceNum}R</h3>

                        <!-- 馬情報セクション -->
                        <div class="horse-section">
                            <h4>🐎 馬情報</h4>
                            <div class="horse-list">`;

                // 各馬の情報表示
                if (raceInfo.horses) {
                    Object.values(raceInfo.horses).forEach(horse => {
                        if (horse) {
                            html += `
                                <div class="horse-item">
                                    <span class="horse-mark">${horse.mark || '?'}</span>
                                    <span class="horse-info">${horse.number}${horse.name} (${horse.type})</span>
                                    ${horse.factors ? horse.factors.map(f => `<span class="factor">${f.text}</span>`).join(' ') : ''}
                                </div>`;
                        }
                    });
                }

                // 候補馬情報
                if (raceInfo.candidates?.renka?.length > 0) {
                    html += `<div class="candidate-item">△ 連下候補馬: ${raceInfo.candidates.renka.join(',')}</div>`;
                }
                if (raceInfo.candidates?.osae?.length > 0) {
                    html += `<div class="candidate-item">× 押さえ候補馬: ${raceInfo.candidates.osae.join(',')}</div>`;
                }

                html += `
                            </div>
                        </div>

                        <!-- 戦略セクション -->
                        <div class="strategy-preview">
                            <div class="strategy-item">
                                <h4>🎯 少点数的中型</h4>
                                <div>${raceInfo?.strategies?.safe?.join('<br>') || '未設定'}</div>
                            </div>
                            <div class="strategy-item">
                                <h4>⚖️ バランス型</h4>
                                <div>${raceInfo?.strategies?.balance?.join('<br>') || '未設定'}</div>
                            </div>
                            <div class="strategy-item">
                                <h4>🚀 高配当追求型</h4>
                                <div>${raceInfo?.strategies?.aggressive?.join('<br>') || '未設定'}</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            html += '</div>';
            previewContent.innerHTML = html;
        }

        // JSON更新実行（全データ対応版）
        async function updateJsonData(data) {
            try {
                const response = await fetch('/.netlify/functions/update-complete-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        completeData: data
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log('✅ 更新成功:', result);

                if (result.success) {
                    console.log(`🎯 ${result.updatedRaces}レースの全データを更新しました`);
                    return result;
                } else {
                    throw new Error(result.error || '更新に失敗しました');
                }

            } catch (error) {
                console.error('❌ 更新エラー:', error);
                throw error;
            }
        }
    </script>

    <style>
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header-section {
            text-align: center;
            margin-bottom: 40px;
        }

        .ai-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }

        .pulse {
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        h1 {
            color: #3b82f6;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #64748b;
            font-size: 1.1rem;
        }

        .guarantee-box {
            background: linear-gradient(135deg, #fef3c7 0%, #fbbf24 10%, #fef3c7 100%);
            border: 2px solid #f59e0b;
            border-radius: 15px;
            padding: 20px;
            margin: 30px auto;
            max-width: 600px;
            text-align: left;
        }

        .guarantee-box h3 {
            color: #92400e;
            margin-bottom: 15px;
            text-align: center;
        }

        .guarantee-box ul {
            list-style: none;
            padding: 0;
        }

        .guarantee-box li {
            margin: 8px 0;
            font-weight: 500;
        }

        .form-section {
            background: #1e293b;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .input-section h2 {
            color: #3b82f6;
            margin-bottom: 15px;
        }

        .format-guide {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .format-guide p {
            margin: 0;
            color: #94a3b8;
        }

        #complete-data {
            width: 100%;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 15px;
            color: #e2e8f0;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
            resize: vertical;
        }

        #complete-data::placeholder {
            color: #64748b;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn-success:hover {
            transform: translateY(-2px);
        }

        .btn-check {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            text-decoration: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            transition: transform 0.2s;
            display: inline-block;
        }

        .btn-check:hover {
            transform: translateY(-2px);
        }

        .preview-section, .success-section {
            background: #1e293b;
            border-radius: 15px;
            padding: 30px;
            margin-top: 30px;
        }

        .preview-section h2, .success-section h2 {
            color: #3b82f6;
            margin-bottom: 20px;
        }

        .race-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .race-preview {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 10px;
            padding: 20px;
        }

        .race-preview h3 {
            color: #f59e0b;
            margin-bottom: 15px;
            text-align: center;
        }

        .strategy-item {
            margin-bottom: 15px;
            padding: 10px;
            background: #1e293b;
            border-radius: 8px;
        }

        .strategy-item h4 {
            margin: 0 0 8px 0;
            font-size: 0.9rem;
        }

        .strategy-item div {
            color: #e2e8f0;
            font-size: 0.8rem;
            line-height: 1.4;
        }

        .success-section {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            text-align: center;
        }

        .success-section h2 {
            color: white;
        }

        /* 馬情報表示スタイル */
        .horse-section {
            margin-bottom: 20px;
            padding: 15px;
            background: #1e293b;
            border-radius: 8px;
        }

        .horse-section h4 {
            color: #3b82f6;
            margin-bottom: 10px;
        }

        .horse-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .horse-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: #0f172a;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .horse-mark {
            font-weight: bold;
            font-size: 1.1rem;
            min-width: 20px;
        }

        .horse-info {
            font-weight: 600;
            color: #e2e8f0;
            min-width: 120px;
        }

        .factor {
            font-size: 0.8rem;
            color: #94a3b8;
            margin-right: 8px;
        }

        .candidate-item {
            padding: 6px 8px;
            background: #374151;
            border-radius: 4px;
            font-size: 0.85rem;
            color: #d1d5db;
            margin-top: 8px;
        }
    </style>
</BaseLayout>