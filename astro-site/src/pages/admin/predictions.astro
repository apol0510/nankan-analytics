---
// ç°¡ç•¥åŒ–ã•ã‚ŒãŸç®¡ç†è€…ç”¨äºˆæƒ³å…¥åŠ›ãƒšãƒ¼ã‚¸
import { getRaceTier, isMainRace, getRaceDisplayName, getMainRaceNumber } from '../../lib/race-config.js';
---

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨ãƒ¬ãƒ¼ã‚¹äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ç®¡ç† | NANKANã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ç®¡ç†ç”»é¢</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e2e8f0;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .header {
            background: rgba(30, 41, 59, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .page-title {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-links {
            display: flex;
            gap: 16px;
        }

        .nav-link {
            color: #94a3b8;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .nav-link:hover {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
        }

        .form-section {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            color: #f1f5f9;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(107, 114, 128, 0.3);
        }

        .alert {
            padding: 16px 20px;
            border-radius: 8px;
            margin: 16px 0;
            font-weight: 500;
            display: none;
        }

        .alert.success {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(5, 150, 105, 0.2) 100%);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: #10b981;
        }

        .alert.error {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, rgba(220, 38, 38, 0.2) 100%);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }

        .feature-importance-controls {
            background: rgba(15, 23, 42, 0.5);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .slider {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: rgba(71, 85, 105, 0.5);
            outline: none;
            cursor: pointer;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            cursor: pointer;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-weight: 600;
            color: #f1f5f9;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 8px;
            background: rgba(30, 41, 59, 0.5);
            color: #e2e8f0;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }


        .race-card {
            background: rgba(15, 23, 42, 0.7);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .race-card:hover {
            border-color: rgba(59, 130, 246, 0.5);
            background: rgba(30, 41, 59, 0.7);
        }

        .race-status {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-complete {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .status-incomplete {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }

        .status-empty {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        #loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #94a3b8;
        }

        .operation-log {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 8px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            color: #94a3b8;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="page-title">ğŸ‡ å…¨ãƒ¬ãƒ¼ã‚¹äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h1>
            <div class="nav-links">
                <a href="/" class="nav-link">ğŸ  ãƒ›ãƒ¼ãƒ </a>
                <a href="/admin" class="nav-link">âš™ï¸ ç®¡ç†ç”»é¢</a>
            </div>
        </div>

        <div id="alert" class="alert"></div>

        <!-- å¤–éƒ¨äºˆæƒ³ â†’ AIäºˆæƒ³å¤‰æ›ï¼ˆ1ã€œ12ãƒ¬ãƒ¼ã‚¹ä¸€æ‹¬å‡¦ç†ï¼‰ -->
        <div class="form-section" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(59, 130, 246, 0.1) 100%); border: 2px solid rgba(16, 185, 129, 0.3);">
            <h2 class="section-title">âš¡ å¤–éƒ¨äºˆæƒ³ â†’ AIäºˆæƒ³å¤‰æ›ï¼ˆ1ã€œ12ãƒ¬ãƒ¼ã‚¹ä¸€æ‹¬å‡¦ç†ï¼‰</h2>
            <p style="color: #94a3b8; margin-bottom: 16px;">
                1ã€œ12ãƒ¬ãƒ¼ã‚¹å…¨ã¦ã®å¤–éƒ¨äºˆæƒ³ã‚’ä¸€åº¦ã«è²¼ã‚Šä»˜ã‘ã‚‹ã¨ã€å…¨ãƒ¬ãƒ¼ã‚¹åˆ†ã®AIäºˆæƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ‹¬ç”Ÿæˆã—ã¾ã™ã€‚<br>
                allRacesPrediction.jsonå½¢å¼ã§å‡ºåŠ›ã•ã‚Œã‚‹ã®ã§ã€ãã®ã¾ã¾ç½®ãæ›ãˆå¯èƒ½ã§ã™ã€‚
            </p>
            
            <div class="form-group">
                <label class="form-label">å…¨ãƒ¬ãƒ¼ã‚¹äºˆæƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’è²¼ã‚Šä»˜ã‘ï¼ˆ1Rã€œ12Rï¼‰</label>
                <textarea id="external_prediction" class="form-textarea" rows="18" 
                    placeholder="ä¾‹:
8/24å·å´1R 1,400mï¼ˆ11é ­ï¼‰ç™ºèµ°æ™‚åˆ»14:45 ãƒ„ã‚¯ãƒ„ã‚¯ãƒœã‚¦ã‚·è³ ï¼’æ­³(å››)
â—ï¼’ãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã‚¹ã‚¿ãƒ¼ãƒˆï¼ˆæœ¬å‘½ 1é ­å›ºå®šï¼‰
â—‹ï¼•ãƒ¤ãƒ³ã‚°ãƒ•ã‚¡ã‚¤ã‚¿ãƒ¼ï¼ˆå¯¾æŠ— 1é ­å›ºå®šï¼‰
â–²ï¼“ãƒ«ãƒ¼ã‚­ãƒ¼ãƒãƒ£ãƒ³ã‚¹ï¼ˆå˜ç©´ æœ€å¤§2é ­ã¾ã§ï¼‰
â–²ï¼—ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚­ãƒ³ã‚°
â–³ï¼”ãƒ€ãƒ¼ã‚¯ãƒ›ãƒ¼ã‚¹ï¼ˆé€£ä¸‹ æœ€å¤§4é ­ã¾ã§ï¼‰
â–³ï¼–ã‚¢ã‚¦ãƒˆã‚µã‚¤ãƒ€ãƒ¼
Ã—ï¼‘ãƒ­ãƒ³ã‚°ã‚·ãƒ§ãƒƒãƒˆï¼ˆæŠ¼ã•ãˆ æœ€å¤§6é ­ã¾ã§ãƒ»é«˜é…å½“ç‹™ã„ç”¨ï¼‰
Ã—ï¼˜ãƒŸãƒ©ã‚¯ãƒ«ãƒ©ãƒ³

8/24å·å´2R 1,200mï¼ˆ10é ­ï¼‰ç™ºèµ°æ™‚åˆ»15:20 ã‚µãƒ©ç³»3æ­³
â—ï¼”ãƒ­ã‚±ãƒƒãƒˆãƒãƒ³
â—‹ï¼‘ãƒ•ã‚¡ã‚¤ãƒŠãƒ«ãƒãƒ£ãƒ³ã‚¹
â–²ï¼–ã‚µãƒ—ãƒ©ã‚¤ã‚ºã‚·ãƒ§ãƒƒãƒˆ

...ï¼ˆä»¥ä¸‹12Rã¾ã§åŒæ§˜ã«ï¼‰

â€»ãƒ¬ãƒ¼ã‚¹æƒ…å ±: è·é›¢ãƒ»é ­æ•°ãƒ»ç™ºèµ°æ™‚åˆ»ãƒ»è³åãƒ»æ¡ä»¶ã‚’è‡ªå‹•æŠ½å‡º
â€»å°ã®å¯¾å¿œ: â—1é ­ã€â—‹1é ­ã€â–²æœ€å¤§2é ­ã€â–³æœ€å¤§4é ­ã€Ã—æœ€å¤§6é ­
â€»Ã—å°ã¯æˆ¦ç•¥Cã®é«˜é…å½“ç‹™ã„ã§æ´»ç”¨ã•ã‚Œã¾ã™"></textarea>
            </div>
            
            <div style="display: flex; gap: 12px; margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="convertAllRaces()">ğŸ¤– å…¨ãƒ¬ãƒ¼ã‚¹ä¸€æ‹¬å¤‰æ›ãƒ»JSONç”Ÿæˆ</button>
                <button class="btn btn-secondary" onclick="clearConversion()">ã‚¯ãƒªã‚¢</button>
            </div>

            <!-- å‡¦ç†çŠ¶æ³è¡¨ç¤º -->
            <div id="conversion-progress" style="background: rgba(15, 23, 42, 0.8); padding: 15px; border-radius: 8px; display: none; font-family: monospace; font-size: 12px; color: #94a3b8; max-height: 150px; overflow-y: auto;">
                <!-- å‡¦ç†ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã‚‹ -->
            </div>
        </div>


        <!-- å…¨ãƒ¬ãƒ¼ã‚¹äºˆæƒ³ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  -->
        <div class="form-section" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(59, 130, 246, 0.1) 100%); border: 2px solid rgba(16, 185, 129, 0.3);">
            <h2 class="section-title">ğŸ‡ å…¨ãƒ¬ãƒ¼ã‚¹äºˆæƒ³ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h2>
            <p style="color: #94a3b8; margin-bottom: 20px;">
                allRacesPrediction.jsonã®å…¨ãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ‹¬ç®¡ç†ã—ã¾ã™ã€‚<br>
                1ã¤ã®æ›´æ–°ã§ ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ»ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ãƒ»ç„¡æ–™ã®å…¨ãƒšãƒ¼ã‚¸ã«è‡ªå‹•åæ˜ ã•ã‚Œã¾ã™ã€‚
            </p>
            
            <!-- ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿çŠ¶æ³ -->
            <div style="background: rgba(15, 23, 42, 0.5); padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid rgba(71, 85, 105, 0.3);">
                <h3 style="color: #10b981; margin-bottom: 15px;">ğŸ“Š ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿çŠ¶æ³</h3>
                <div id="all-races-status" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                    <!-- JavaScriptã§ç”Ÿæˆ -->
                </div>
            </div>
            
            <!-- æ“ä½œãƒœã‚¿ãƒ³ -->
            <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="loadAllRaces()">ğŸ“¥ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿</button>
                <button class="btn btn-success" onclick="saveAllRaces()">ğŸ’¾ JSONã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼</button>
                <button class="btn btn-secondary" onclick="validateAllRaces()">ğŸ” ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼</button>
                <button class="btn btn-secondary" onclick="generatePreview()">ğŸ‘ï¸ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆ</button>
            </div>
            
            <!-- ãƒ¬ãƒ¼ã‚¹åˆ¥ã‚¯ã‚¤ãƒƒã‚¯ç·¨é›† -->
            <div style="background: rgba(15, 23, 42, 0.5); padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid rgba(71, 85, 105, 0.3);">
                <h3 style="color: #3b82f6; margin-bottom: 15px;">ğŸ¯ ãƒ¬ãƒ¼ã‚¹åˆ¥ã‚¯ã‚¤ãƒƒã‚¯ç·¨é›†</h3>
                <p style="color: #94a3b8; margin-bottom: 15px; font-size: 0.9rem;">
                    å€‹åˆ¥ãƒ¬ãƒ¼ã‚¹èª¿æ•´ãŒå¿…è¦ãªå ´åˆã¯ã€è©²å½“ãƒ¬ãƒ¼ã‚¹ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦è©³ç´°ç·¨é›†ã‚’é–‹å§‹
                </p>
                <div id="raceEditButtons" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                    <!-- ãƒœã‚¿ãƒ³ã¯å‹•çš„ã«ç”Ÿæˆ -->
                </div>
            </div>
            
            <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
            <div style="background: rgba(15, 23, 42, 0.5); padding: 15px; border-radius: 8px; border: 1px solid rgba(71, 85, 105, 0.3);">
                <h3 style="color: #8b5cf6; margin-bottom: 10px;">ğŸ“‹ æ“ä½œãƒ­ã‚°</h3>
                <div id="all-races-log" class="operation-log">
                    <!-- ãƒ­ã‚°å†…å®¹ -->
                    ãƒ­ã‚°: ã‚·ã‚¹ãƒ†ãƒ æº–å‚™å®Œäº†
                </div>
            </div>
        </div>

        <!-- ç‰¹å¾´é‡é‡è¦åº¦ãƒãƒ¼ç·¨é›† -->
        <div class="form-section" style="background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.2);">
            <h2 class="section-title">ğŸ“Š ç‰¹å¾´é‡é‡è¦åº¦ãƒãƒ¼ç·¨é›†</h2>
            <p style="color: #94a3b8; margin-bottom: 20px; font-size: 0.9rem;">
                â—å°ã¨â—‹å°ã®ç‰¹å¾´é‡é‡è¦åº¦ã‚’å€‹åˆ¥è¨­å®šã€‚ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ç¢ºèªã—ãªãŒã‚‰èª¿æ•´å¯èƒ½ã€‚
            </p>
            
            <!-- â—å°ï¼ˆæœ¬å‘½ï¼‰ã®ç‰¹å¾´é‡é‡è¦åº¦ -->
            <div class="feature-importance-controls" style="background: rgba(16, 185, 129, 0.1);">
                <h4 style="color: #10b981; margin-bottom: 15px;">â— æœ¬å‘½é¦¬ã®ç‰¹å¾´é‡é‡è¦åº¦</h4>
                <div class="slider-container">
                    <label style="min-width: 80px; font-size: 0.9rem;">ç‰¹å¾´é‡1:</label>
                    <input type="text" id="mainFeature1Label" value="å®‰å®šæ€§" placeholder="ç‰¹å¾´é‡å" style="width: 120px; padding: 5px 8px; font-size: 0.8rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.2); border-radius: 4px; color: white;">
                    <input type="range" id="mainFeature1" class="slider" min="0" max="1" step="0.01" value="0.95" onchange="updateImportanceBars()">
                    <span id="mainFeature1Value" style="min-width: 40px; font-size: 0.9rem;">95%</span>
                </div>
                <div class="slider-container">
                    <label style="min-width: 80px; font-size: 0.9rem;">ç‰¹å¾´é‡2:</label>
                    <input type="text" id="mainFeature2Label" value="èƒ½åŠ›ä¸Šä½æ€§" placeholder="ç‰¹å¾´é‡å" style="width: 120px; padding: 5px 8px; font-size: 0.8rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.2); border-radius: 4px; color: white;">
                    <input type="range" id="mainFeature2" class="slider" min="0" max="1" step="0.01" value="0.88" onchange="updateImportanceBars()">
                    <span id="mainFeature2Value" style="min-width: 40px; font-size: 0.9rem;">88%</span>
                </div>
                <div class="slider-container">
                    <label style="min-width: 80px; font-size: 0.9rem;">ç‰¹å¾´é‡3:</label>
                    <input type="text" id="mainFeature3Label" value="å±•é–‹åˆ©" placeholder="ç‰¹å¾´é‡å" style="width: 120px; padding: 5px 8px; font-size: 0.8rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.2); border-radius: 4px; color: white;">
                    <input type="range" id="mainFeature3" class="slider" min="0" max="1" step="0.01" value="0.82" onchange="updateImportanceBars()">
                    <span id="mainFeature3Value" style="min-width: 40px; font-size: 0.9rem;">82%</span>
                </div>
            </div>

            <!-- â—‹å°ï¼ˆå¯¾æŠ—ï¼‰ã®ç‰¹å¾´é‡é‡è¦åº¦ -->
            <div class="feature-importance-controls" style="background: rgba(59, 130, 246, 0.1);">
                <h4 style="color: #3b82f6; margin-bottom: 15px;">â—‹ å¯¾æŠ—é¦¬ã®ç‰¹å¾´é‡é‡è¦åº¦</h4>
                <div class="slider-container">
                    <label style="min-width: 80px; font-size: 0.9rem;">ç‰¹å¾´é‡1:</label>
                    <input type="text" id="subFeature1Label" value="å…ˆè¡ŒåŠ›" placeholder="ç‰¹å¾´é‡å" style="width: 120px; padding: 5px 8px; font-size: 0.8rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.2); border-radius: 4px; color: white;">
                    <input type="range" id="subFeature1" class="slider" min="0" max="1" step="0.01" value="0.96" onchange="updateImportanceBars()">
                    <span id="subFeature1Value" style="min-width: 40px; font-size: 0.9rem;">96%</span>
                </div>
                <div class="slider-container">
                    <label style="min-width: 80px; font-size: 0.9rem;">ç‰¹å¾´é‡2:</label>
                    <input type="text" id="subFeature2Label" value="ã‚¹ãƒ”ãƒ¼ãƒ‰æŒ‡æ•°" placeholder="ç‰¹å¾´é‡å" style="width: 120px; padding: 5px 8px; font-size: 0.8rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.2); border-radius: 4px; color: white;">
                    <input type="range" id="subFeature2" class="slider" min="0" max="1" step="0.01" value="0.85" onchange="updateImportanceBars()">
                    <span id="subFeature2Value" style="min-width: 40px; font-size: 0.9rem;">85%</span>
                </div>
                <div class="slider-container">
                    <label style="min-width: 80px; font-size: 0.9rem;">ç‰¹å¾´é‡3:</label>
                    <input type="text" id="subFeature3Label" value="æ é †å„ªä½" placeholder="ç‰¹å¾´é‡å" style="width: 120px; padding: 5px 8px; font-size: 0.8rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.2); border-radius: 4px; color: white;">
                    <input type="range" id="subFeature3" class="slider" min="0" max="1" step="0.01" value="0.79" onchange="updateImportanceBars()">
                    <span id="subFeature3Value" style="min-width: 40px; font-size: 0.9rem;">79%</span>
                </div>
            </div>

            <div style="margin-top: 20px; text-align: center;">
                <button class="btn btn-primary" onclick="applyImportanceToSelectedRace()">
                    ğŸ¯ é¸æŠä¸­ãƒ¬ãƒ¼ã‚¹ã«é©ç”¨
                </button>
                <button class="btn btn-secondary" onclick="previewImportanceBars()" style="margin-left: 10px;">
                    ğŸ‘ï¸ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
                </button>
            </div>
        </div>

        <!-- å€‹åˆ¥ãƒ¬ãƒ¼ã‚¹è©³ç´°ç·¨é›† -->
        <div class="form-section" id="race-edit-section" style="display: none; background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3);">
            <h2 class="section-title">ğŸ¯ å€‹åˆ¥ãƒ¬ãƒ¼ã‚¹è©³ç´°ç·¨é›†</h2>
            <div id="race-edit-header" style="margin-bottom: 20px; padding: 15px; background: rgba(15, 23, 42, 0.5); border-radius: 8px;">
                <h3 id="race-edit-title" style="color: #8b5cf6; margin-bottom: 10px;">ç·¨é›†ä¸­: -</h3>
                <p style="color: #94a3b8; font-size: 0.9rem;">ã“ã¡ã‚‰ã§å€‹åˆ¥ãƒ¬ãƒ¼ã‚¹ã®è©³ç´°è¨­å®šã‚’è¡Œã„ã¾ã™ã€‚å¤‰æ›´å¾Œã¯ã€Œé©ç”¨ã€ãƒœã‚¿ãƒ³ã§ä¿å­˜ã—ã¦ãã ã•ã„ã€‚</p>
            </div>

            <!-- ãƒ¬ãƒ¼ã‚¹åŸºæœ¬æƒ…å ± -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 25px;">
                <!-- ãƒ¬ãƒ¼ã‚¹æƒ…å ± -->
                <div style="background: rgba(15, 23, 42, 0.5); padding: 15px; border-radius: 8px;">
                    <h4 style="color: #10b981; margin-bottom: 15px;">ğŸ“Š ãƒ¬ãƒ¼ã‚¹åŸºæœ¬æƒ…å ±</h4>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <input type="text" id="edit-race-name" placeholder="ãƒ¬ãƒ¼ã‚¹å" 
                               style="padding: 8px 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.2); border-radius: 6px; color: white;">
                        <input type="text" id="edit-confidence" placeholder="ä¿¡é ¼åº¦ (%)" 
                               style="padding: 8px 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.2); border-radius: 6px; color: white;">
                        <input type="text" id="edit-ability-index" placeholder="èƒ½åŠ›æŒ‡æ•°" 
                               style="padding: 8px 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.2); border-radius: 6px; color: white;">
                        <select id="edit-recommendation" 
                                style="padding: 8px 12px; background: rgba(15,23,42,0.8); border: 1px solid rgba(148,163,184,0.2); border-radius: 6px; color: white;">
                            <option value="A+">A+ (æœ€å¼·æ¨å¥¨)</option>
                            <option value="A">A (å¼·æ¨å¥¨)</option>
                            <option value="B+">B+ (æ¨å¥¨)</option>
                            <option value="B">B (ã‚„ã‚„æ¨å¥¨)</option>
                            <option value="C+">C+ (æ¡ä»¶ä»˜ã)</option>
                            <option value="C">C (æ³¨æ„)</option>
                        </select>
                        <input type="text" id="edit-expected-return" placeholder="æœŸå¾…å›åç‡ (%)" 
                               style="padding: 8px 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.2); border-radius: 6px; color: white;">
                    </div>
                </div>

                <!-- äºˆæƒ³é¦¬æƒ…å ± -->
                <div style="background: rgba(15, 23, 42, 0.5); padding: 15px; border-radius: 8px;">
                    <h4 style="color: #3b82f6; margin-bottom: 15px;">ğŸ‡ äºˆæƒ³é¦¬æƒ…å ±</h4>
                    
                    <!-- æœ¬å‘½é¦¬ -->
                    <div style="margin-bottom: 15px; padding: 10px; background: rgba(16, 185, 129, 0.1); border-radius: 6px;">
                        <h5 style="color: #10b981; margin-bottom: 8px;">â— æœ¬å‘½</h5>
                        <div style="display: flex; gap: 10px;">
                            <input type="number" id="edit-main-number" placeholder="é¦¬ç•ª" min="1" max="16" 
                                   style="width: 70px; padding: 6px 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.2); border-radius: 4px; color: white;">
                            <input type="text" id="edit-main-name" placeholder="é¦¬å" 
                                   style="flex: 1; padding: 6px 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.2); border-radius: 4px; color: white;">
                            <input type="text" id="edit-main-confidence" placeholder="ä¿¡é ¼åº¦" 
                                   style="width: 80px; padding: 6px 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.2); border-radius: 4px; color: white;">
                        </div>
                    </div>

                    <!-- å¯¾æŠ—é¦¬ -->
                    <div style="margin-bottom: 15px; padding: 10px; background: rgba(59, 130, 246, 0.1); border-radius: 6px;">
                        <h5 style="color: #3b82f6; margin-bottom: 8px;">â—‹ å¯¾æŠ—</h5>
                        <div style="display: flex; gap: 10px;">
                            <input type="number" id="edit-sub1-number" placeholder="é¦¬ç•ª" min="1" max="16" 
                                   style="width: 70px; padding: 6px 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.2); border-radius: 4px; color: white;">
                            <input type="text" id="edit-sub1-name" placeholder="é¦¬å" 
                                   style="flex: 1; padding: 6px 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.2); border-radius: 4px; color: white;">
                            <input type="text" id="edit-sub1-confidence" placeholder="ä¿¡é ¼åº¦" 
                                   style="width: 80px; padding: 6px 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.2); border-radius: 4px; color: white;">
                        </div>
                    </div>

                    <!-- å˜ç©´é¦¬ -->
                    <div style="margin-bottom: 10px; padding: 10px; background: rgba(245, 158, 11, 0.1); border-radius: 6px;">
                        <h5 style="color: #f59e0b; margin-bottom: 8px;">â–² å˜ç©´</h5>
                        <div style="display: flex; gap: 10px;">
                            <input type="number" id="edit-sub2-number" placeholder="é¦¬ç•ª" min="1" max="16" 
                                   style="width: 70px; padding: 6px 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.2); border-radius: 4px; color: white;">
                            <input type="text" id="edit-sub2-name" placeholder="é¦¬å" 
                                   style="flex: 1; padding: 6px 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.2); border-radius: 4px; color: white;">
                            <input type="text" id="edit-sub2-confidence" placeholder="ä¿¡é ¼åº¦" 
                                   style="width: 80px; padding: 6px 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.2); border-radius: 4px; color: white;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ“ä½œãƒœã‚¿ãƒ³ -->
            <div style="display: flex; gap: 12px; justify-content: center;">
                <button class="btn btn-success" onclick="saveRaceEdit()">âœ… å¤‰æ›´ã‚’é©ç”¨</button>
                <button class="btn btn-secondary" onclick="cancelRaceEdit()">âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn btn-warning" onclick="resetRaceToDefault()">ğŸ”„ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™</button>
            </div>
        </div>

        <div id="loading">
            <p>ğŸ”„ å‡¦ç†ä¸­...</p>
        </div>

        <!-- ç”Ÿæˆã•ã‚ŒãŸJSONã®è¡¨ç¤º -->
        <div class="form-section" style="display: none;" id="json-output-section">
            <h2 class="section-title">ğŸ“„ ç”ŸæˆJSON</h2>
            <textarea id="json-output" class="form-textarea" rows="20" readonly 
                style="font-family: 'Monaco', 'Menlo', monospace; font-size: 12px; background: rgba(15, 23, 42, 0.8);"></textarea>
            <div style="margin-top: 12px; display: flex; gap: 12px;">
                <button class="btn btn-primary" onclick="copyToClipboard('json-output')">ğŸ“‹ JSONã‚’ã‚³ãƒ”ãƒ¼</button>
                <button class="btn btn-secondary" onclick="downloadJson()">ğŸ’¾ JSONãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
            </div>
        </div>
    </div>

    <script>
        // ===== ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° =====
        let allRacesData = null;
        let currentEditingRace = null;
        
        // ãƒ¬ãƒ¼ã‚¹è¨­å®šï¼ˆrace-config.jsã¨åŒã˜å®šç¾©ï¼‰
        const RACE_TIERS = {
            1: 'premium', 2: 'premium', 3: 'premium',
            4: 'premium', 5: 'premium', 6: 'premium',
            7: 'premium', 8: 'premium', 9: 'premium',
            10: 'standard',
            11: 'free',     // ãƒ¡ã‚¤ãƒ³ãƒ¬ãƒ¼ã‚¹
            12: 'standard'
        };
        
        // race-config.jsäº’æ›ã®é–¢æ•°
        function getRaceTier(raceNumber) {
            return RACE_TIERS[raceNumber] || 'premium';
        }
        
        function isMainRace(raceNumber) {
            return raceNumber === 11;
        }
        
        function getRaceDisplayName(raceNumber) {
            const tier = getRaceTier(raceNumber);
            const isMain = isMainRace(raceNumber);
            
            if (isMain) {
                return `${raceNumber}Rç·¨é›† (ãƒ¡ã‚¤ãƒ³ãƒ»free)`;
            } else if (tier === 'standard') {
                return `${raceNumber}Rç·¨é›† (standard)`;
            } else {
                return `${raceNumber}Rç·¨é›† (premium)`;
            }
        }
        let parsedPredictionData = null;

        // ãƒ¬ãƒ¼ã‚¹ç·¨é›†ãƒœã‚¿ãƒ³ã‚’å‹•çš„ç”Ÿæˆ
        function generateRaceEditButtons() {
            const container = document.getElementById('raceEditButtons');
            if (!container) return;
            
            container.innerHTML = '';
            for (let i = 1; i <= 12; i++) {
                const button = document.createElement('button');
                button.className = 'btn btn-secondary';
                button.textContent = getRaceDisplayName(i);
                button.style.justifyContent = 'center';
                
                // ãƒ¡ã‚¤ãƒ³ãƒ¬ãƒ¼ã‚¹ï¼ˆ11Rï¼‰ã¯ç‰¹åˆ¥ãªã‚¹ã‚¿ã‚¤ãƒ«
                if (isMainRace(i)) {
                    button.style.background = 'linear-gradient(135deg, rgba(16, 185, 129, 0.3) 0%, rgba(59, 130, 246, 0.3) 100%)';
                    button.style.border = '2px solid rgba(16, 185, 129, 0.5)';
                }
                
                button.onclick = () => editRace(`${i}R`);
                container.appendChild(button);
            }
        }
        
        // ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° =====
        function showAlert(message, type = 'success') {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = `alert ${type}`;
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }

        function logAllRaces(message) {
            const log = document.getElementById('all-races-log');
            const timestamp = new Date().toLocaleTimeString();
            log.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            log.scrollTop = log.scrollHeight;
        }

        // ===== å…¨ãƒ¬ãƒ¼ã‚¹äºˆæƒ³ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  =====
        window.loadAllRaces = async function() {
            try {
                logAllRaces('ğŸ“¥ ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã—ã¾ã™...');
                
                // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
                const sampleData = {
                    raceDate: "2025-08-22",
                    track: "å·å´ç«¶é¦¬",
                    totalRaces: 12,
                    races: []
                };

                // 1R-12Rã®ã‚µãƒ³ãƒ—ãƒ«ãƒ¬ãƒ¼ã‚¹ä½œæˆ
                for (let i = 1; i <= 12; i++) {
                    sampleData.races.push({
                        raceNumber: `${i}R`,
                        raceName: "ã‚µãƒ©ç³»3æ­³ä»¥ä¸Š",
                        // race-config.jsã‹ã‚‰ä¸€å…ƒç®¡ç†ã•ã‚ŒãŸè¨­å®šã‚’ä½¿ç”¨
                        tier: getRaceTier(i),
                        isMainRace: isMainRace(i),
                        raceInfo: {
                            confidence: (Math.random() * 30 + 60).toFixed(1),
                            abilityIndex: (Math.random() * 40 + 40).toFixed(1),
                            recommendation: ["A+", "A", "B+", "B", "C+", "C"][Math.floor(Math.random() * 6)]
                        },
                        horses: {
                            main: {
                                number: Math.floor(Math.random() * 12) + 1,
                                name: `ã‚µãƒ³ãƒ—ãƒ«é¦¬${i}`,
                                type: "æœ¬å‘½",
                                confidence: (Math.random() * 30 + 60).toFixed(1)
                            }
                        }
                    });
                }

                allRacesData = sampleData;
                updateRaceStatus();
                logAllRaces('âœ… ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†');
                
                // ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼
                validateRaceConfiguration(allRacesData);
                showAlert('ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã—ã¾ã—ãŸã€‚å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã¯ allRacesPrediction.json ã‹ã‚‰èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚', 'success');
                
            } catch (error) {
                logAllRaces(`âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                showAlert(`ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        };

        window.validateAllRaces = function() {
            if (!allRacesData) {
                showAlert('å…ˆã«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„', 'error');
                return;
            }

            logAllRaces('ğŸ” ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’æ¤œè¨¼ä¸­...');
            
            const validation = {
                totalRaces: allRacesData.races?.length || 0,
                premiumRaces: 0,
                standardRaces: 0,
                freeRaces: 0,
                mainRace: null,
                errors: []
            };

            if (allRacesData.races) {
                allRacesData.races.forEach(race => {
                    switch(race.tier) {
                        case 'premium': validation.premiumRaces++; break;
                        case 'standard': validation.standardRaces++; break;
                        case 'free': validation.freeRaces++; break;
                    }
                    
                    if (race.isMainRace) {
                        validation.mainRace = race.raceNumber;
                    }
                });
            }

            logAllRaces(`ğŸ“Š æ¤œè¨¼çµæœ: ${validation.totalRaces}ãƒ¬ãƒ¼ã‚¹ (ãƒ—ãƒ¬ãƒŸã‚¢ãƒ :${validation.premiumRaces}, ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰:${validation.standardRaces}, ç„¡æ–™:${validation.freeRaces})`);
            logAllRaces(`ğŸ¯ ãƒ¡ã‚¤ãƒ³ãƒ¬ãƒ¼ã‚¹: ${validation.mainRace || 'æœªè¨­å®š'}`);
            
            showAlert(`ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼å®Œäº†: ${validation.totalRaces}ãƒ¬ãƒ¼ã‚¹ã‚’ç¢ºèªã—ã¾ã—ãŸ`, 'success');
        };

        window.saveAllRaces = function() {
            if (!allRacesData) {
                showAlert('ä¿å­˜ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }

            try {
                const jsonString = JSON.stringify(allRacesData, null, 2);
                
                // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
                navigator.clipboard.writeText(jsonString).then(() => {
                    logAllRaces('ğŸ“‹ JSONãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
                    showAlert('JSONãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚allRacesPrediction.jsonã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚', 'success');
                    
                    // JSONè¡¨ç¤ºã‚¨ãƒªã‚¢ã«ã‚‚å‡ºåŠ›
                    document.getElementById('json-output').value = jsonString;
                    document.getElementById('json-output-section').style.display = 'block';
                    
                }).catch(() => {
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«è¡¨ç¤º
                    document.getElementById('json-output').value = jsonString;
                    document.getElementById('json-output-section').style.display = 'block';
                    showAlert('JSONãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚', 'success');
                });
                
            } catch (error) {
                logAllRaces(`âŒ ä¿å­˜ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                showAlert(`ä¿å­˜ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        };

        window.generatePreview = function() {
            if (!allRacesData) {
                showAlert('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }

            logAllRaces('ğŸ‘ï¸ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç”Ÿæˆä¸­...');
            
            const preview = {
                æ¦‚è¦: `${allRacesData.track} ${allRacesData.raceDate}`,
                å…¨ãƒ¬ãƒ¼ã‚¹æ•°: allRacesData.races?.length || 0,
                ãƒ—ãƒ¬ãƒŸã‚¢ãƒ : allRacesData.races?.filter(r => r.tier === 'premium').length || 0,
                ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰: allRacesData.races?.filter(r => r.tier === 'standard').length || 0,
                ç„¡æ–™: allRacesData.races?.filter(r => r.tier === 'free').length || 0,
                ãƒ¡ã‚¤ãƒ³ãƒ¬ãƒ¼ã‚¹: allRacesData.races?.find(r => r.isMainRace)?.raceNumber || 'æœªè¨­å®š'
            };

            logAllRaces('âœ… ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆå®Œäº†');
            showAlert(`ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼: ${preview.æ¦‚è¦} - å…¨${preview.å…¨ãƒ¬ãƒ¼ã‚¹æ•°}ãƒ¬ãƒ¼ã‚¹ (ãƒ—ãƒ¬ãƒŸã‚¢ãƒ :${preview.ãƒ—ãƒ¬ãƒŸã‚¢ãƒ }, ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰:${preview.ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰}, ç„¡æ–™:${preview.ç„¡æ–™})`, 'success');
        };

        window.editRace = function(raceNumber) {
            currentEditingRace = raceNumber;
            logAllRaces(`ğŸ¯ ${raceNumber}ã®ç·¨é›†ã‚’é–‹å§‹`);
            showAlert(`${raceNumber}ãŒé¸æŠã•ã‚Œã¾ã—ãŸã€‚ç‰¹å¾´é‡é‡è¦åº¦ãƒãƒ¼ç·¨é›†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§èª¿æ•´ã—ã¦ãã ã•ã„ã€‚`, 'success');
            
            // ãƒ¬ãƒ¼ã‚¹é¸æŠçŠ¶æ…‹ã‚’è¦–è¦šçš„ã«è¡¨ç¤º
            document.querySelectorAll('.btn-secondary').forEach(btn => {
                btn.style.background = 'linear-gradient(135deg, #6b7280 0%, #4b5563 100%)';
            });
            
            event.target.style.background = 'linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%)';
        };

        function updateRaceStatus() {
            const statusContainer = document.getElementById('all-races-status');
            if (!allRacesData?.races) {
                statusContainer.innerHTML = '<div style="color: #ef4444;">ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“</div>';
                return;
            }

            statusContainer.innerHTML = '';
            
            allRacesData.races.forEach(race => {
                const hasDetailedData = race.horses?.main?.importance && race.strategies && race.analysis;
                const statusClass = hasDetailedData ? 'status-complete' : 'status-incomplete';
                const statusText = hasDetailedData ? 'å®Œäº†' : 'åŸºæœ¬ã®ã¿';
                
                const card = document.createElement('div');
                card.className = 'race-card';
                card.innerHTML = `
                    <div style="font-weight: 600; color: #f1f5f9; margin-bottom: 8px;">${race.raceNumber}</div>
                    <div style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 8px;">${race.raceName}</div>
                    <div class="race-status ${statusClass}">${statusText}</div>
                `;
                statusContainer.appendChild(card);
            });
        }

        // ===== ç‰¹å¾´é‡é‡è¦åº¦ãƒãƒ¼ç·¨é›†æ©Ÿèƒ½ =====
        window.updateImportanceBars = function() {
            // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å€¤æ›´æ–°ï¼ˆãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆè¡¨ç¤ºï¼‰
            document.getElementById('mainFeature1Value').textContent = Math.round(document.getElementById('mainFeature1').value * 100) + '%';
            document.getElementById('mainFeature2Value').textContent = Math.round(document.getElementById('mainFeature2').value * 100) + '%';
            document.getElementById('mainFeature3Value').textContent = Math.round(document.getElementById('mainFeature3').value * 100) + '%';
            document.getElementById('subFeature1Value').textContent = Math.round(document.getElementById('subFeature1').value * 100) + '%';
            document.getElementById('subFeature2Value').textContent = Math.round(document.getElementById('subFeature2').value * 100) + '%';
            document.getElementById('subFeature3Value').textContent = Math.round(document.getElementById('subFeature3').value * 100) + '%';
        };

        window.applyImportanceToSelectedRace = function() {
            if (!currentEditingRace) {
                showAlert('å…ˆã«ãƒ¬ãƒ¼ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            if (!allRacesData?.races) {
                showAlert('å…ˆã«ãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„', 'error');
                return;
            }

            const race = allRacesData.races.find(r => r.raceNumber === currentEditingRace);
            if (!race) {
                showAlert('é¸æŠã•ã‚ŒãŸãƒ¬ãƒ¼ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                return;
            }

            // ç‰¹å¾´é‡é‡è¦åº¦ãƒ‡ãƒ¼ã‚¿ã‚’é©ç”¨
            if (!race.horses) race.horses = {};
            
            // æœ¬å‘½é¦¬ã®ç‰¹å¾´é‡é‡è¦åº¦
            if (!race.horses.main) race.horses.main = {};
            race.horses.main.importance = [
                { 
                    label: document.getElementById('mainFeature1Label').value || 'ç‰¹å¾´é‡1', 
                    value: parseFloat(document.getElementById('mainFeature1').value) 
                },
                { 
                    label: document.getElementById('mainFeature2Label').value || 'ç‰¹å¾´é‡2', 
                    value: parseFloat(document.getElementById('mainFeature2').value) 
                },
                { 
                    label: document.getElementById('mainFeature3Label').value || 'ç‰¹å¾´é‡3', 
                    value: parseFloat(document.getElementById('mainFeature3').value) 
                }
            ];

            // å¯¾æŠ—é¦¬ã®ç‰¹å¾´é‡é‡è¦åº¦
            if (!race.horses.sub) race.horses.sub = {};
            race.horses.sub.importance = [
                { 
                    label: document.getElementById('subFeature1Label').value || 'ç‰¹å¾´é‡1', 
                    value: parseFloat(document.getElementById('subFeature1').value) 
                },
                { 
                    label: document.getElementById('subFeature2Label').value || 'ç‰¹å¾´é‡2', 
                    value: parseFloat(document.getElementById('subFeature2').value) 
                },
                { 
                    label: document.getElementById('subFeature3Label').value || 'ç‰¹å¾´é‡3', 
                    value: parseFloat(document.getElementById('subFeature3').value) 
                }
            ];

            logAllRaces(`âœ… ${currentEditingRace}ã«ç‰¹å¾´é‡é‡è¦åº¦ã‚’é©ç”¨ã—ã¾ã—ãŸ`);
            showAlert(`${currentEditingRace}ã«ç‰¹å¾´é‡é‡è¦åº¦ã‚’é©ç”¨ã—ã¾ã—ãŸ`, 'success');
            updateRaceStatus();
        };

        window.previewImportanceBars = function() {
            const preview = {
                'æœ¬å‘½é¦¬': [
                    `${document.getElementById('mainFeature1Label').value}: ${document.getElementById('mainFeature1').value}`,
                    `${document.getElementById('mainFeature2Label').value}: ${document.getElementById('mainFeature2').value}`,
                    `${document.getElementById('mainFeature3Label').value}: ${document.getElementById('mainFeature3').value}`
                ],
                'å¯¾æŠ—é¦¬': [
                    `${document.getElementById('subFeature1Label').value}: ${document.getElementById('subFeature1').value}`,
                    `${document.getElementById('subFeature2Label').value}: ${document.getElementById('subFeature2').value}`,
                    `${document.getElementById('subFeature3Label').value}: ${document.getElementById('subFeature3').value}`
                ]
            };
            
            logAllRaces('ğŸ‘ï¸ ç‰¹å¾´é‡é‡è¦åº¦ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼:');
            logAllRaces(`æœ¬å‘½: ${preview['æœ¬å‘½é¦¬'].join(', ')}`);
            logAllRaces(`å¯¾æŠ—: ${preview['å¯¾æŠ—é¦¬'].join(', ')}`);
            
            showAlert('ç‰¹å¾´é‡é‡è¦åº¦ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãƒ­ã‚°ã«è¡¨ç¤ºã—ã¾ã—ãŸ', 'success');
        };

        // ===== å…¨ãƒ¬ãƒ¼ã‚¹ä¸€æ‹¬å¤‰æ›æ©Ÿèƒ½ =====
        window.convertAllRaces = async function() {
            const externalText = document.getElementById('external_prediction').value;
            if (!externalText.trim()) {
                showAlert('å¤‰æ›ã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            const progressDiv = document.getElementById('conversion-progress');
            progressDiv.style.display = 'block';
            progressDiv.innerHTML = '';

            function logProgress(message) {
                const timestamp = new Date().toLocaleTimeString();
                progressDiv.innerHTML += `<div>[${timestamp}] ${message}</div>`;
                progressDiv.scrollTop = progressDiv.scrollHeight;
            }

            try {
                logProgress('ğŸ” å…¨ãƒ¬ãƒ¼ã‚¹ãƒ†ã‚­ã‚¹ãƒˆã‚’è§£æä¸­...');
                
                // å…¨ãƒ¬ãƒ¼ã‚¹åˆ†ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’è§£æ
                const allRacesData = parseAllRacesPrediction(externalText);
                
                logProgress(`âœ… ${allRacesData.races.length}ãƒ¬ãƒ¼ã‚¹ã‚’æ¤œå‡ºã—ã¾ã—ãŸ`);
                logProgress('ğŸ¤– å„ãƒ¬ãƒ¼ã‚¹ã®AIäºˆæƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆä¸­...');

                // å„ãƒ¬ãƒ¼ã‚¹ã®AIäºˆæƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
                const races = [];
                for (let i = 0; i < allRacesData.races.length; i++) {
                    const raceData = allRacesData.races[i];
                    logProgress(`å‡¦ç†ä¸­: ${raceData.raceNumber}R (${raceData.horses.length}é ­)`);
                    
                    const aiRaceData = generateRaceData(raceData, allRacesData);
                    races.push(aiRaceData);
                }

                // allRacesPrediction.jsonå½¢å¼ã§å‡ºåŠ›
                const finalData = {
                    raceDate: allRacesData.raceDate,
                    track: allRacesData.track,
                    totalRaces: races.length,
                    races: races,
                    planAccess: {
                        free: {
                            races: ["11R"],
                            description: "ãƒ¡ã‚¤ãƒ³ãƒ¬ãƒ¼ã‚¹ã®ã¿ï¼ˆæœ€çµ‚ãƒ¬ãƒ¼ã‚¹ã®1ã¤å‰ï¼‰"
                        },
                        standard: {
                            races: ["10R", "11R", "12R"],
                            description: "å¾ŒåŠ3ãƒ¬ãƒ¼ã‚¹"
                        },
                        premium: {
                            races: ["1R", "2R", "3R", "4R", "5R", "6R", "7R", "8R", "9R", "10R", "11R", "12R"],
                            description: "å…¨ãƒ¬ãƒ¼ã‚¹"
                        }
                    }
                };

                // ãƒ¡ã‚¤ãƒ³ãƒ¬ãƒ¼ã‚¹è¨­å®šï¼ˆ11Rã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
                const mainRaceIndex = races.findIndex(r => r.raceNumber === '11R');
                if (mainRaceIndex !== -1) {
                    races[mainRaceIndex].isMainRace = true;
                }

                // JSONã‚’è¡¨ç¤º
                const jsonString = JSON.stringify(finalData, null, 2);
                document.getElementById('json-output').value = jsonString;
                document.getElementById('json-output-section').style.display = 'block';

                logProgress(`ğŸ‰ å®Œäº†ï¼å…¨${races.length}ãƒ¬ãƒ¼ã‚¹ã®AIäºˆæƒ³JSONã‚’ç”Ÿæˆã—ã¾ã—ãŸ`);
                showAlert(`âœ… å…¨ãƒ¬ãƒ¼ã‚¹å¤‰æ›å®Œäº†ï¼${races.length}ãƒ¬ãƒ¼ã‚¹ã®AIäºˆæƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¾ã—ãŸ`, 'success');

            } catch (error) {
                console.error('å¤‰æ›ã‚¨ãƒ©ãƒ¼:', error);
                logProgress(`âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                showAlert('å¤‰æ›ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
            }
        }

        window.clearConversion = function() {
            document.getElementById('external_prediction').value = '';
            document.getElementById('conversion-progress').style.display = 'none';
            document.getElementById('json-output-section').style.display = 'none';
            parsedPredictionData = null;
            showAlert('ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'success');
        }

        // å…¨ãƒ¬ãƒ¼ã‚¹è§£æï¼ˆè¤‡æ•°ãƒ¬ãƒ¼ã‚¹å¯¾å¿œï¼‰
        function parseAllRacesPrediction(text) {
            const sections = text.split(/\n\s*\n/).filter(section => section.trim());
            const result = {
                races: [],
                raceDate: null,
                track: null
            };

            let globalDate = null;
            let globalTrack = null;

            for (const section of sections) {
                try {
                    const raceData = parseExternalPrediction(section);
                    if (raceData.horses.length > 0) {
                        // æœ€åˆã«è¦‹ã¤ã‘ãŸæ—¥ä»˜ãƒ»ç«¶é¦¬å ´ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«è¨­å®š
                        if (!globalDate && raceData.raceDate) globalDate = raceData.raceDate;
                        if (!globalTrack && raceData.trackName) globalTrack = raceData.trackName;
                        
                        result.races.push(raceData);
                    }
                } catch (error) {
                    console.warn('ãƒ¬ãƒ¼ã‚¹ã‚»ã‚¯ã‚·ãƒ§ãƒ³è§£æã‚¨ãƒ©ãƒ¼:', section, error);
                }
            }

            // æ—¥ä»˜ãƒ»ç«¶é¦¬å ´è¨­å®š
            result.raceDate = globalDate || new Date().toISOString().split('T')[0];
            result.track = globalTrack || 'å·å´ç«¶é¦¬';

            // ãƒ¬ãƒ¼ã‚¹ç•ªå·é †ã«ã‚½ãƒ¼ãƒˆ
            result.races.sort((a, b) => (a.raceNumber || 99) - (b.raceNumber || 99));

            return result;
        }

        // ãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆï¼ˆçµ±ä¸€é–¢æ•°ï¼‰
        function generateRaceData(raceData, allRacesData) {
            // race-config.jsã‹ã‚‰ä¸€å…ƒç®¡ç†ã•ã‚ŒãŸè¨­å®šã‚’ä½¿ç”¨
            const raceNum = raceData.raceNumber || 1;
            
            return {
                raceNumber: raceNum + 'R',
                raceName: raceData.raceName || `ã‚µãƒ©ç³»${raceNum <= 5 ? '3æ­³' : '3æ­³ä»¥ä¸Š'}`,
                tier: getRaceTier(raceNum),
                isMainRace: false, // å¾Œã§è¨­å®š
                displayOrder: raceData.raceNumber,
                raceInfo: {
                    title: `${allRacesData.track.replace('ç«¶é¦¬', '')}${raceData.raceNumber || 1}R ${raceData.raceName || 'ã‚µãƒ©ç³»'}`,
                    date: allRacesData.raceDate,
                    track: allRacesData.track,
                    raceNumber: (raceData.raceNumber || 1) + 'R',
                    raceName: raceData.raceName || `ã‚µãƒ©ç³»${raceData.raceNumber <= 5 ? '3æ­³' : '3æ­³ä»¥ä¸Š'}`,
                    confidence: raceData.confidence.toFixed(1),
                    abilityIndex: (50 + Math.random() * 40).toFixed(1),
                    recommendation: raceData.confidence > 90 ? "A+" : 
                                  raceData.confidence > 85 ? "A" : 
                                  raceData.confidence > 80 ? "B+" : 
                                  raceData.confidence > 75 ? "B" : 
                                  raceData.confidence > 70 ? "C+" : "C",
                    expectedReturn: (70 + Math.random() * 80).toFixed(0),
                    // æ–°è¦è¿½åŠ ï¼šãƒ¬ãƒ¼ã‚¹è©³ç´°æƒ…å ±
                    distance: raceData.raceDistance ? raceData.raceDistance + 'm' : '',
                    horseCount: raceData.horseCount || 0,
                    startTime: raceData.startTime || '',
                    raceCondition: raceData.raceCondition || '',
                    // è¡¨ç¤ºç”¨çµ±åˆæ–‡å­—åˆ—
                    raceDetails: `${allRacesData.track || 'å·å´'}${raceData.raceNumber}R ${raceData.raceDistance ? raceData.raceDistance + 'm' : ''} ${raceData.horseCount ? 'ï¼ˆ' + raceData.horseCount + 'é ­ï¼‰' : ''} ${raceData.startTime ? 'ç™ºèµ°æ™‚åˆ»' + raceData.startTime : ''} ${raceData.raceName || 'ã‚µãƒ©ç³»'} ${raceData.raceCondition || ''}`
                },
                horses: generateHorsesDataForRace(raceData),
                strategies: generateStrategiesForRace(raceData),
                analysis: generateAnalysisForRace(raceData),
                preview: generatePreviewDataForRace(raceData),
                allHorses: generateAllHorsesDataForRace(raceData),
                totalHorses: raceData.horses.length,
                lastUpdated: new Date().toISOString()
            };
        }

        function generateHorsesDataForRace(raceData) {
            const horses = {};
            const mainHorse = raceData.horses.find(h => h.mark === 'â—');
            const subHorse = raceData.horses.find(h => h.mark === 'â—‹' || h.mark === 'â—¯');
            const darkHorses = raceData.horses.filter(h => h.mark === 'â–²'); // è¤‡æ•°é ­å¯¾å¿œ

            if (mainHorse) {
                horses.main = {
                    number: mainHorse.number,
                    name: mainHorse.name,
                    type: "æœ¬å‘½",
                    confidence: (85 + Math.random() * 10).toFixed(1),
                    factors: [
                        {icon: "â˜…", text: `èƒ½åŠ›æŒ‡æ•°: ${(85 + Math.random() * 10).toFixed(1)} (1ä½)`},
                        {icon: "â˜…", text: `å®‰å®šæ€§ã‚¹ã‚³ã‚¢: ${(88 + Math.random() * 10).toFixed(1)}%`},
                        {icon: "â˜…", text: "å±•é–‹é©æ€§: Sè©•ä¾¡"},
                        {icon: "â˜…", text: `éå»5èµ°åå·®å€¤: ${(55 + Math.random() * 10).toFixed(1)}`}
                    ],
                    importance: [
                        {label: "å®‰å®šæ€§", value: 0.90 + Math.random() * 0.08},
                        {label: "èƒ½åŠ›ä¸Šä½æ€§", value: 0.85 + Math.random() * 0.08},
                        {label: "å±•é–‹åˆ©", value: 0.75 + Math.random() * 0.10}
                    ]
                };
            }

            if (subHorse) {
                horses.sub = {
                    number: subHorse.number,
                    name: subHorse.name,
                    type: "å¯¾æŠ—",
                    confidence: (75 + Math.random() * 10).toFixed(1),
                    factors: [
                        {icon: "â˜…", text: `ã‚¹ãƒ”ãƒ¼ãƒ‰æŒ‡æ•°: ${(75 + Math.random() * 10).toFixed(1)}`},
                        {icon: "â˜…", text: `å…ˆè¡ŒåŠ›: ${(82 + Math.random() * 15).toFixed(1)}%`},
                        {icon: "â˜…", text: "æ é †å„ªä½æ€§: Aç´š"},
                        {icon: "â˜…", text: "æŒç¶šåŠ›è©•ä¾¡: B+"}
                    ],
                    importance: [
                        {label: "å…ˆè¡ŒåŠ›", value: 0.85 + Math.random() * 0.10},
                        {label: "ã‚¹ãƒ”ãƒ¼ãƒ‰æŒ‡æ•°", value: 0.75 + Math.random() * 0.10},
                        {label: "æ é †å„ªä½", value: 0.70 + Math.random() * 0.10}
                    ]
                };
            }

            // â–²å°ï¼ˆå˜ç©´ï¼‰æœ€å¤§2é ­ã¾ã§å‡¦ç†
            if (darkHorses.length > 0) {
                horses.sub1 = {
                    number: darkHorses[0].number,
                    name: darkHorses[0].name,
                    type: "å˜ç©´",
                    confidence: (65 + Math.random() * 10).toFixed(1),
                    factors: [
                        {icon: "â˜…", text: `çˆ†ç™ºåŠ›æŒ‡æ•°: ${(80 + Math.random() * 15).toFixed(1)}`},
                        {icon: "â˜…", text: "ãƒ ãƒ©ä¿‚æ•°: é«˜å¤‰å‹•"},
                        {icon: "â˜…", text: "æ–¤é‡å„ªä½: +1kg"},
                        {icon: "â˜…", text: "å±•é–‹æ¬¡ç¬¬: è¦æ³¨æ„"}
                    ]
                };
                
                if (darkHorses.length > 1) {
                    horses.sub2 = {
                        number: darkHorses[1].number,
                        name: darkHorses[1].name,
                        type: "å˜ç©´2",
                        confidence: (60 + Math.random() * 10).toFixed(1),
                        factors: [
                            {icon: "â˜…", text: `çˆ†ç™ºåŠ›æŒ‡æ•°: ${(75 + Math.random() * 15).toFixed(1)}`},
                            {icon: "â˜…", text: "ç©´é¦¬é©æ€§: B+"},
                            {icon: "â˜…", text: "å¤‰å‹•ç‡: é«˜"},
                            {icon: "â˜…", text: "æœŸå¾…å€¤: ä¸­"}
                        ]
                    };
                }
            }

            return horses;
        }

        function generateStrategiesForRace(raceData) {
            const mainHorses = raceData.horses.filter(h => h.mark === 'â—');
            const subHorses = raceData.horses.filter(h => h.mark === 'â—‹' || h.mark === 'â—¯');
            const darkHorses = raceData.horses.filter(h => h.mark === 'â–²');
            const underHorses = raceData.horses.filter(h => h.mark === 'â–³');
            const pressHorses = raceData.horses.filter(h => h.mark === 'Ã—'); // Ã—å°ï¼ˆæŠ¼ã•ãˆï¼‰è¿½åŠ 
            
            const main = mainHorses[0]?.number || 1;
            const subs = subHorses.map(h => h.number);
            const darks = darkHorses.map(h => h.number);
            const unders = underHorses.map(h => h.number);
            const press = pressHorses.map(h => h.number); // Ã—å°ã®é¦¬ç•ªé…åˆ—

            return {
                safe: {
                    title: "æˆ¦ç•¥A: é«˜çš„ä¸­ç‡å‹",
                    recommendation: raceData.confidence > 80 ? 4 : 3,
                    hitRate: (70 + Math.random() * 15).toFixed(1),
                    returnRate: (110 + Math.random() * 30).toFixed(0),
                    riskLevel: "low",
                    bets: [
                        { type: "é¦¬å˜", horses: `${main} â†’ ${[...subs, ...darks].slice(0, 3).join(',')}`, points: `${Math.max(2, subs.length + Math.min(darks.length, 2))}ç‚¹` },
                        { type: "é¦¬é€£", horses: `${main} - ${[...subs, ...darks].slice(0, 3).join(',')}`, points: `${Math.max(2, subs.length + Math.min(darks.length, 2))}ç‚¹` },
                        { type: "3é€£è¤‡", horses: `${main}-${subs[0] || darks[0] || 2} - ${[...darks, ...unders].slice(0, 3).join(',')}`, points: "6ç‚¹" }
                    ],
                    expectedPayout: "3-6å€",
                    payoutType: "å …å®Ÿæ±ºç€æƒ³å®š"
                },
                balance: {
                    title: "æˆ¦ç•¥B: ãƒãƒ©ãƒ³ã‚¹å‹",
                    recommendation: raceData.confidence > 75 ? 3 : 2,
                    hitRate: (55 + Math.random() * 15).toFixed(1),
                    returnRate: (140 + Math.random() * 40).toFixed(0),
                    riskLevel: "medium",
                    bets: [
                        { type: "é¦¬å˜", horses: `${main} â†’ ${[...subs, ...darks].join(',')}`, points: `${Math.max(3, subs.length + darks.length)}ç‚¹` },
                        { type: "3é€£è¤‡", horses: `${main},${subs[0] || darks[0] || 2}-${[...darks, ...unders].join(',')}`, points: "10ç‚¹" },
                        { type: "ãƒ¯ã‚¤ãƒ‰", horses: `${main}-${[...subs, ...darks].join(',')}`, points: `${Math.max(2, subs.length + darks.length)}ç‚¹` }
                    ],
                    expectedPayout: "6-12å€",
                    payoutType: "ä¸­ç©´é…å½“æƒ³å®š"
                },
                aggressive: {
                    title: "æˆ¦ç•¥C: é«˜é…å½“è¿½æ±‚å‹",
                    recommendation: raceData.confidence > 70 ? 2 : 1,
                    hitRate: (25 + Math.random() * 20).toFixed(1),
                    returnRate: (250 + Math.random() * 200).toFixed(0),
                    riskLevel: "high",
                    bets: press.length > 0 ? [
                        // Ã—å°ãŒã‚ã‚‹å ´åˆï¼šÃ—å°ã‚’ä½¿ã£ãŸé«˜é…å½“ç‹™ã„
                        { type: "3é€£å˜", horses: `${press.slice(0,2).join(',')}â†’${main}â†’${[...subs, ...darks, ...unders].join(',')}`, points: `${Math.min(12, press.length * 4)}ç‚¹` },
                        { type: "é¦¬å˜", horses: `${press.join(',')}â†’${main},${subs[0] || darks[0] || 2}`, points: `${Math.min(8, press.length * 2)}ç‚¹` },
                        { type: "3é€£è¤‡", horses: `${press[0] || 3}-${main}-${[...darks, ...unders].join(',')}`, points: "6ç‚¹" }
                    ] : [
                        // Ã—å°ãŒãªã„å ´åˆï¼šå¾“æ¥ã®é«˜é…å½“æˆ¦ç•¥
                        { type: "3é€£å˜", horses: `${main}â†’${[...subs, ...darks].slice(0, 2).join(',')}â†’${[...darks, ...unders].join(',')}`, points: "12ç‚¹" },
                        { type: "3é€£å˜", horses: `${subs[0] || darks[0] || 2}â†’${main}â†’${[...darks, ...unders].join(',')}`, points: "8ç‚¹" },
                        { type: "é¦¬å˜", horses: `${darks[0] || 3}â†’${main},${subs[0] || 2}`, points: "2ç‚¹" }
                    ],
                    expectedPayout: press.length > 0 ? "20å€ä»¥ä¸Š" : "12å€ä»¥ä¸Š",
                    payoutType: press.length > 0 ? "å¤§ç©´ãƒ»ä¸‡é¦¬åˆ¸ç‹™ã„" : "å¤§ç©´è¦–é‡"
                }
            };
        }

        function generateAnalysisForRace(raceData) {
            const mainHorse = raceData.horses.find(h => h.mark === 'â—');
            return {
                raceExpected: `XGBoostãƒ¢ãƒ‡ãƒ«: â—${mainHorse ? mainHorse.number + mainHorse.name : 'æœ¬å‘½é¦¬'}ã®å®‰å®šæ€§ã‚’è©•ä¾¡ï¼ˆã‚¹ã‚³ã‚¢${raceData.confidence.toFixed(1)}ï¼‰`,
                keyIndicators: {
                    accuracy: (70 + Math.random() * 20).toFixed(1),
                    similarRaces: `${Math.floor(15 + Math.random() * 35)}ä»¶`,
                    confidenceInterval: `Â±${(3 + Math.random() * 5).toFixed(1)}`,
                    recommendedInvestment: raceData.confidence > 80 ? "è³‡é‡‘ã®2-4%" : raceData.confidence > 70 ? "è³‡é‡‘ã®1-2%" : "è³‡é‡‘ã®0.5-1%"
                }
            };
        }

        function generatePreviewDataForRace(raceData) {
            const mainHorse = raceData.horses.find(h => h.mark === 'â—');
            const subHorse = raceData.horses.find(h => h.mark === 'â—‹' || h.mark === 'â—¯');
            
            return {
                summary: `æ¨å¥¨æŠ•è³‡æˆ¦ç•¥: ${mainHorse ? mainHorse.name : 'æœ¬å‘½'}${subHorse ? 'ã€' + subHorse.name : ''}ã‚’ä¸­å¿ƒã¨ã—ãŸé¦¬å˜ã€æœŸå¾…å€¤+${(5 + Math.random() * 25).toFixed(1)}%`,
                features: "ç‰¹å¾´é‡é‡è¦åº¦: å®‰å®šæ€§(0.90)ã€èƒ½åŠ›ä¸Šä½æ€§(0.85)ã€å±•é–‹åˆ©(0.75)",
                riskAnalysis: raceData.confidence > 85 ? "ä½ãƒªã‚¹ã‚¯ã€å®‰å®šåç›Šå‹" : 
                             raceData.confidence > 75 ? "ä¸­ãƒªã‚¹ã‚¯ã€ãƒãƒ©ãƒ³ã‚¹å‹" : "ä½é…å½“ã€å …å®Ÿå‹"
            };
        }

        function generateAllHorsesDataForRace(raceData) {
            return raceData.horses.map(horse => ({
                number: horse.number,
                name: horse.name,
                mark: horse.mark,
                confidence: (50 + Math.random() * 40).toFixed(1),
                type: horse.mark === 'â—' ? 'æœ¬å‘½' : 
                      horse.mark === 'â—‹' || horse.mark === 'â—¯' ? 'å¯¾æŠ—' : 
                      horse.mark === 'â–²' ? 'å˜ç©´' : 
                      horse.mark === 'â–³' ? 'é€£ä¸‹' : 
                      horse.mark === 'Ã—' ? 'æŠ¼ã•ãˆ' : 'ãã®ä»–',
                factors: [
                    {icon: "â˜…", text: `ä¿¡é ¼åº¦: ${(50 + Math.random() * 40).toFixed(1)}%`}, 
                    {icon: "â˜…", text: horse.mark === 'Ã—' ? "å¤§ç©´é©æ€§: é«˜å¤‰å‹•" : "é©æ€§è©•ä¾¡: Bç´š"}
                ]
            }));
        }

        // å¤–éƒ¨äºˆæƒ³è§£æ
        function parseExternalPrediction(text) {
            const lines = text.split('\n').map(line => line.trim()).filter(line => line);
            const result = {
                horses: [],
                raceDate: null,
                trackName: null,
                raceNumber: null,
                raceName: null,
                raceDistance: null,
                confidence: 85,
                // æ–°è¦è¿½åŠ é …ç›®
                horseCount: 0,
                startTime: '',
                raceCondition: ''
            };

            // æ—¥ä»˜ã¨ç«¶é¦¬å ´æƒ…å ±ã‚’æŠ½å‡º
            const headerMatch = text.match(/(\d+\/\d+)([^\d]*?)([\dï¼-ï¼™]+)[ï¼²Rr]/i);
            if (headerMatch) {
                const [month, day] = headerMatch[1].split('/');
                const year = new Date().getFullYear();
                result.raceDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                
                const trackText = headerMatch[2];
                if (trackText.includes('å·å´')) result.trackName = 'å·å´';
                else if (trackText.includes('å¤§äº•')) result.trackName = 'å¤§äº•';
                else if (trackText.includes('èˆ¹æ©‹')) result.trackName = 'èˆ¹æ©‹';
                else if (trackText.includes('æµ¦å’Œ')) result.trackName = 'æµ¦å’Œ';

                result.raceNumber = parseInt(headerMatch[3].replace(/[ï¼-ï¼™]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0)));
            } else {
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ¬ãƒ¼ã‚¹ç•ªå·ã®ã¿ã‚’æŠ½å‡º
                const raceNumMatch = text.match(/([1-9]|1[0-2])[ï¼²Rr]/i);
                if (raceNumMatch) {
                    result.raceNumber = parseInt(raceNumMatch[1]);
                    result.trackName = 'å·å´ç«¶é¦¬'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
                } else {
                    console.warn('ãƒ¬ãƒ¼ã‚¹ç•ªå·ãŒè§£æã§ãã¾ã›ã‚“:', text.substring(0, 100));
                    // æš«å®šå€¤ã¨ã—ã¦1Rã‚’è¨­å®šï¼ˆå¾Œã§ä¸€æ‹¬å¤‰æ›ã§é©åˆ‡ãªç•ªå·ã‚’è¨­å®šï¼‰
                    result.raceNumber = 1;
                    result.trackName = 'å·å´ç«¶é¦¬';
                }
            }

            // ãƒ¬ãƒ¼ã‚¹åã¨è©³ç´°æƒ…å ±ã‚’æŠ½å‡ºï¼ˆè¤‡æ•°ãƒ‘ã‚¿ãƒ¼ãƒ³å¯¾å¿œï¼‰
            // ãƒ‘ã‚¿ãƒ¼ãƒ³1: å·å´1R 1,400mï¼ˆ11é ­ï¼‰ç™ºèµ°æ™‚åˆ»14:45 ãƒ„ã‚¯ãƒ„ã‚¯ãƒœã‚¦ã‚·è³ ï¼’æ­³(å››)
            const detailedPattern1 = text.match(/(\w+)(\d+)[ï¼²Rr]\s*([,\d]+)m[^\d]*ï¼ˆ(\d+)é ­ï¼‰[^\d]*(\d{1,2}[:ï¼š]\d{2})[^\n]*?([^\s\d]+è³?)[^\n]*?([^\n]*)/);
            
            // ãƒ‘ã‚¿ãƒ¼ãƒ³2: å·å´1R ãƒ„ã‚¯ãƒ„ã‚¯ãƒœã‚¦ã‚·è³ 1,400mï¼ˆ11é ­ï¼‰ï¼’æ­³(å››) 14:45
            const detailedPattern2 = text.match(/(\w+)(\d+)[ï¼²Rr]\s*([^\s\d]+è³?)[^\d]*([,\d]+)m[^\d]*ï¼ˆ(\d+)é ­ï¼‰[^\n]*?([^\d]*?)(\d{1,2}[:ï¼š]\d{2})/);
            
            // ãƒ‘ã‚¿ãƒ¼ãƒ³3: è·é›¢ã®ã¿æŠ½å‡º 1400m ã¾ãŸã¯ 1,400m
            const distancePattern = text.match(/(\d{1,2}[,]?\d{3})m/);
            
            // ãƒ‘ã‚¿ãƒ¼ãƒ³4: é ­æ•°ã®ã¿æŠ½å‡º ï¼ˆ11é ­ï¼‰
            const horseCountPattern = text.match(/ï¼ˆ(\d+)é ­ï¼‰/);
            
            // ãƒ‘ã‚¿ãƒ¼ãƒ³5: ç™ºèµ°æ™‚åˆ»ã®ã¿æŠ½å‡º 14:45
            const startTimePattern = text.match(/(\d{1,2}[:ï¼š]\d{2})/);

            if (detailedPattern1) {
                result.raceDistance = detailedPattern1[3] || '';
                result.horseCount = parseInt(detailedPattern1[4]) || 0;
                result.startTime = detailedPattern1[5] || '';
                result.raceName = detailedPattern1[6] || '';
                result.raceCondition = detailedPattern1[7] || '';
            } else if (detailedPattern2) {
                result.raceName = detailedPattern2[3] || '';
                result.raceDistance = detailedPattern2[4] || '';
                result.horseCount = parseInt(detailedPattern2[5]) || 0;
                result.raceCondition = detailedPattern2[6] || '';
                result.startTime = detailedPattern2[7] || '';
            } else {
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šã‚·ãƒ³ãƒ—ãƒ«ãªãƒ¬ãƒ¼ã‚¹åæŠ½å‡º
                const raceNameMatch = text.match(/\d+[ï¼²Rr]\s+([^\nâ—â—‹â–²â–³Ã—â˜†â˜…]+)/i);
                if (raceNameMatch) {
                    result.raceName = raceNameMatch[1].trim();
                }
                
                // å€‹åˆ¥ã«è©³ç´°æƒ…å ±ã‚’æŠ½å‡º
                if (distancePattern) {
                    result.raceDistance = distancePattern[1];
                }
                if (horseCountPattern) {
                    result.horseCount = parseInt(horseCountPattern[1]);
                }
                if (startTimePattern) {
                    result.startTime = startTimePattern[1];
                }
            }

            // é¦¬æƒ…å ±ã‚’æŠ½å‡ºï¼ˆè¤‡æ•°ãƒ‘ã‚¿ãƒ¼ãƒ³ã«å¯¾å¿œã€Ã—å°ã‚‚å«ã‚€ï¼‰
            const horsePatterns = [
                /([â—â—‹â—¯â–²â–³Ã—â˜†â˜…])\s*([ï¼-ï¼™0-9]+)\s*(.+?)(?=[\nâ—â—‹â—¯â–²â–³Ã—â˜†â˜…]|$)/g,
                /([â—â—‹â—¯â–²â–³Ã—â˜†â˜…])([ï¼-ï¼™0-9]+)(.+?)(?=[\nâ—â—‹â—¯â–²â–³Ã—â˜†â˜…]|$)/g,
                /([â—â—‹â—¯â–²â–³Ã—â˜†â˜…])\s*([^\s]+)/g
            ];

            for (const pattern of horsePatterns) {
                const matches = [...text.matchAll(pattern)];
                if (matches.length > 0) {
                    matches.forEach(match => {
                        const mark = match[1];
                        const numberStr = match[2] || '';
                        const name = (match[3] || match[2] || '').trim();
                        
                        // é¦¬ç•ªã‚’æŠ½å‡ºï¼ˆå…¨è§’â†’åŠè§’å¤‰æ›ï¼‰
                        const number = parseInt(numberStr.replace(/[ï¼-ï¼™]/g, s => 
                            String.fromCharCode(s.charCodeAt(0) - 0xFEE0)
                        )) || result.horses.length + 1;

                        if (name && !name.match(/^[ï¼-ï¼™0-9]+$/)) {
                            result.horses.push({ mark, number, name: name.replace(/^[ï¼-ï¼™0-9]+/, '') });
                        }
                    });
                    if (result.horses.length > 0) break;
                }
            }
            
            // å°ã®é ­æ•°åˆ¶é™ã‚’é©ç”¨
            // â—:1é ­ã€â—‹:1é ­ã€â–²:æœ€å¤§2é ­ã€â–³:æœ€å¤§4é ­ã€Ã—:æœ€å¤§6é ­
            const limitedHorses = [];
            const counts = { 'â—': 0, 'â—‹': 0, 'â—¯': 0, 'â–²': 0, 'â–³': 0, 'Ã—': 0 };
            const limits = { 'â—': 1, 'â—‹': 1, 'â—¯': 1, 'â–²': 2, 'â–³': 4, 'Ã—': 6 };
            
            result.horses.forEach(horse => {
                const mark = horse.mark === 'â—¯' ? 'â—‹' : horse.mark; // â—¯ã‚’â—‹ã«çµ±ä¸€
                if (counts[mark] !== undefined && counts[mark] < (limits[mark] || 99)) {
                    limitedHorses.push(horse);
                    counts[mark]++;
                }
            });
            result.horses = limitedHorses;

            // ä¿¡é ¼åº¦ã‚’å°ã®åˆ†å¸ƒã‹ã‚‰è¨ˆç®—
            const mainCount = result.horses.filter(h => h.mark === 'â—').length;
            const subCount = result.horses.filter(h => h.mark === 'â—‹' || h.mark === 'â—¯').length;
            if (mainCount === 1 && subCount <= 2) {
                result.confidence = 88 + Math.random() * 7; // 88-95%
            } else if (mainCount === 1) {
                result.confidence = 82 + Math.random() * 6; // 82-88%
            } else {
                result.confidence = 75 + Math.random() * 7; // 75-82%
            }

            return result;
        }

        // é¦¬ã®è©•ä¾¡è¦ç´ ã‚’è‡ªå‹•ç”Ÿæˆ
        function generateHorseFactors(horse) {
            const factors = [];
            
            if (horse.mark === 'â—') {
                factors.push(`èƒ½åŠ›æŒ‡æ•°: ${(85 + Math.random() * 10).toFixed(1)}`);
                factors.push(`å®‰å®šæ€§: ${(88 + Math.random() * 10).toFixed(1)}%`);
                factors.push('å±•é–‹é©æ€§: S');
            } else if (horse.mark === 'â—‹' || horse.mark === 'â—¯') {
                factors.push(`ã‚¹ãƒ”ãƒ¼ãƒ‰æŒ‡æ•°: ${(75 + Math.random() * 10).toFixed(1)}`);
                factors.push(`å…ˆè¡ŒåŠ›: ${(82 + Math.random() * 15).toFixed(1)}%`);
                factors.push('æ é †å„ªä½æ€§: A');
            } else if (horse.mark === 'â–²') {
                factors.push(`çˆ†ç™ºåŠ›: ${(80 + Math.random() * 15).toFixed(1)}`);
                factors.push('ãƒ ãƒ©ä¿‚æ•°: é«˜å¤‰å‹•');
                factors.push('å±•é–‹æ¬¡ç¬¬');
            } else if (horse.mark === 'â–³') {
                factors.push(`æŒç¶šåŠ›: ${(70 + Math.random() * 15).toFixed(1)}`);
                factors.push('é€£å¯¾ç‡: ä¸­ä½');
                factors.push('ç´ç©´å€™è£œ');
            } else {
                factors.push(`åŸºç¤èƒ½åŠ›: ${(65 + Math.random() * 15).toFixed(1)}`);
                factors.push('ç‰¹æ®Šæ¡ä»¶é©æ€§');
            }
            
            return factors;
        }


        function generateHorsesData() {
            const horses = {};
            const mainHorse = parsedPredictionData.horses.find(h => h.mark === 'â—');
            const subHorse = parsedPredictionData.horses.find(h => h.mark === 'â—‹' || h.mark === 'â—¯');
            const darkHorse = parsedPredictionData.horses.find(h => h.mark === 'â–²');

            if (mainHorse) {
                horses.main = {
                    number: mainHorse.number,
                    name: mainHorse.name,
                    type: "æœ¬å‘½",
                    confidence: (85 + Math.random() * 10).toFixed(1),
                    factors: [
                        {icon: "â˜…", text: `èƒ½åŠ›æŒ‡æ•°: ${(85 + Math.random() * 10).toFixed(1)} (1ä½)`},
                        {icon: "â˜…", text: `å®‰å®šæ€§ã‚¹ã‚³ã‚¢: ${(88 + Math.random() * 10).toFixed(1)}%`},
                        {icon: "â˜…", text: "å±•é–‹é©æ€§: Sè©•ä¾¡"},
                        {icon: "â˜…", text: `éå»5èµ°åå·®å€¤: ${(55 + Math.random() * 10).toFixed(1)}`}
                    ],
                    importance: [
                        {label: "å®‰å®šæ€§", value: 0.95},
                        {label: "èƒ½åŠ›ä¸Šä½æ€§", value: 0.88},
                        {label: "å±•é–‹åˆ©", value: 0.82}
                    ]
                };
            }

            if (subHorse) {
                horses.sub = {
                    number: subHorse.number,
                    name: subHorse.name,
                    type: "å¯¾æŠ—",
                    confidence: (75 + Math.random() * 10).toFixed(1),
                    factors: [
                        {icon: "â˜…", text: `ã‚¹ãƒ”ãƒ¼ãƒ‰æŒ‡æ•°: ${(75 + Math.random() * 10).toFixed(1)}`},
                        {icon: "â˜…", text: `å…ˆè¡ŒåŠ›: ${(82 + Math.random() * 15).toFixed(1)}%`},
                        {icon: "â˜…", text: "æ é †å„ªä½æ€§: Aç´š"},
                        {icon: "â˜…", text: "æŒç¶šåŠ›è©•ä¾¡: B+"}
                    ],
                    importance: [
                        {label: "å…ˆè¡ŒåŠ›", value: 0.89},
                        {label: "ã‚¹ãƒ”ãƒ¼ãƒ‰æŒ‡æ•°", value: 0.81},
                        {label: "æ é †å„ªä½", value: 0.74}
                    ]
                };
            }

            if (darkHorse) {
                horses.dark = {
                    number: darkHorse.number,
                    name: darkHorse.name,
                    type: "å˜ç©´",
                    confidence: (65 + Math.random() * 10).toFixed(1),
                    factors: [
                        {icon: "â˜…", text: `çˆ†ç™ºåŠ›æŒ‡æ•°: ${(80 + Math.random() * 15).toFixed(1)}`},
                        {icon: "â˜…", text: "ãƒ ãƒ©ä¿‚æ•°: é«˜å¤‰å‹•"},
                        {icon: "â˜…", text: "æ–¤é‡å„ªä½: +1kg"},
                        {icon: "â˜…", text: "å±•é–‹æ¬¡ç¬¬: è¦æ³¨æ„"}
                    ]
                };
            }

            return horses;
        }

        // æŠ•è³‡æˆ¦ç•¥ã‚’è‡ªå‹•ç”Ÿæˆ
        function generateStrategies(parsed) {
            const mainHorses = parsed.horses.filter(h => h.mark === 'â—');
            const subHorses = parsed.horses.filter(h => h.mark === 'â—‹' || h.mark === 'â—¯');
            const darkHorses = parsed.horses.filter(h => h.mark === 'â–²');
            const underHorses = parsed.horses.filter(h => h.mark === 'â–³');
            
            const main = mainHorses[0]?.number || 1;
            const subs = subHorses.map(h => h.number);
            const darks = darkHorses.map(h => h.number);
            const unders = underHorses.map(h => h.number);

            return {
                safe: {
                    title: "æˆ¦ç•¥A: é«˜çš„ä¸­ç‡å‹",
                    recommendation: 4,
                    hitRate: (75 + Math.random() * 10).toFixed(1),
                    returnRate: (120 + Math.random() * 30).toFixed(0),
                    riskLevel: "low",
                    bets: [
                        { type: "é¦¬å˜", horses: `${main} â†’ ${[...subs, ...darks].slice(0, 3).join(',')}`, points: `${subs.length + Math.min(darks.length, 2)}ç‚¹` },
                        { type: "é¦¬é€£", horses: `${main} - ${[...subs, ...darks].slice(0, 3).join(',')}`, points: `${subs.length + Math.min(darks.length, 2)}ç‚¹` },
                        { type: "3é€£è¤‡", horses: `${main}-${subs[0] || darks[0]} - ${[...darks, ...unders].slice(0, 3).join(',')}`, points: "6ç‚¹" }
                    ],
                    expectedPayout: "3-6å€",
                    payoutType: "å …å®Ÿæ±ºç€æƒ³å®š"
                },
                balance: {
                    title: "æˆ¦ç•¥B: ãƒãƒ©ãƒ³ã‚¹å‹",
                    recommendation: 3,
                    hitRate: (60 + Math.random() * 10).toFixed(1),
                    returnRate: (160 + Math.random() * 40).toFixed(0),
                    riskLevel: "medium",
                    bets: [
                        { type: "é¦¬å˜", horses: `${main} â†’ ${[...subs, ...darks].join(',')}`, points: `${subs.length + darks.length}ç‚¹` },
                        { type: "3é€£è¤‡", horses: `${main},${subs[0] || darks[0]}-${[...darks, ...unders].join(',')}`, points: "10ç‚¹" },
                        { type: "ãƒ¯ã‚¤ãƒ‰", horses: `${main}-${[...subs, ...darks].join(',')}`, points: `${subs.length + darks.length}ç‚¹` }
                    ],
                    expectedPayout: "6-12å€",
                    payoutType: "ä¸­ç©´é…å½“æƒ³å®š"
                },
                aggressive: {
                    title: "æˆ¦ç•¥C: é«˜é…å½“è¿½æ±‚å‹",
                    recommendation: 2,
                    hitRate: (35 + Math.random() * 15).toFixed(1),
                    returnRate: (280 + Math.random() * 120).toFixed(0),
                    riskLevel: "high",
                    bets: [
                        { type: "3é€£å˜", horses: `${main}â†’${[...subs, ...darks].slice(0, 2).join(',')}â†’${[...darks, ...unders].join(',')}`, points: "12ç‚¹" },
                        { type: "3é€£å˜", horses: `${subs[0] || darks[0]}â†’${main}â†’${[...darks, ...unders].join(',')}`, points: "8ç‚¹" },
                        { type: "é¦¬å˜", horses: `${darks[0] || 3}â†’${main},${subs[0] || 2}`, points: "2ç‚¹" }
                    ],
                    expectedPayout: "15å€ä»¥ä¸Š",
                    payoutType: "å¤§ç©´è¦–é‡"
                }
            };
        }

        function generateAnalysis(parsed) {
            const mainHorse = parsed.horses.find(h => h.mark === 'â—');
            return {
                raceExpected: `XGBoostãƒ¢ãƒ‡ãƒ«: â—${mainHorse ? mainHorse.number + mainHorse.name : 'æœ¬å‘½é¦¬'}ã®å®‰å®šæ€§ã‚’è©•ä¾¡ï¼ˆã‚¹ã‚³ã‚¢${parsed.confidence.toFixed(1)}ï¼‰`,
                keyIndicators: {
                    accuracy: (75 + Math.random() * 15).toFixed(1),
                    similarRaces: `${Math.floor(20 + Math.random() * 30)}ä»¶`,
                    confidenceInterval: `Â±${(3 + Math.random() * 4).toFixed(1)}`,
                    recommendedInvestment: "è³‡é‡‘ã®2-4%"
                }
            };
        }

        function generatePreviewData(parsed) {
            const mainHorse = parsed.horses.find(h => h.mark === 'â—');
            const subHorse = parsed.horses.find(h => h.mark === 'â—‹' || h.mark === 'â—¯');
            
            return {
                summary: `æ¨å¥¨æŠ•è³‡æˆ¦ç•¥: ${mainHorse ? mainHorse.name : 'æœ¬å‘½'}${subHorse ? 'ã€' + subHorse.name : ''}ã‚’ä¸­å¿ƒã¨ã—ãŸé¦¬å˜ã€æœŸå¾…å€¤+${(10 + Math.random() * 20).toFixed(1)}%`,
                features: "ç‰¹å¾´é‡é‡è¦åº¦: å®‰å®šæ€§(0.95)ã€èƒ½åŠ›ä¸Šä½æ€§(0.88)ã€å±•é–‹åˆ©(0.82)",
                riskAnalysis: parsed.confidence > 85 ? "ä½ãƒªã‚¹ã‚¯ã€å®‰å®šåç›Šå‹" : "ä¸­ãƒªã‚¹ã‚¯ã€ãƒãƒ©ãƒ³ã‚¹å‹"
            };
        }

        function generateAllHorsesData() {
            return parsedPredictionData.horses.map(horse => ({
                number: horse.number,
                name: horse.name,
                mark: horse.mark,
                confidence: (60 + Math.random() * 30).toFixed(1),
                type: horse.mark === 'â—' ? 'æœ¬å‘½' : 
                      horse.mark === 'â—‹' || horse.mark === 'â—¯' ? 'å¯¾æŠ—' : 
                      horse.mark === 'â–²' ? 'å˜ç©´' : 
                      horse.mark === 'â–³' ? 'é€£ä¸‹' : 'æŠ¼ã•ãˆ',
                factors: [{icon: "â˜…", text: `ä¿¡é ¼åº¦: ${(60 + Math.random() * 30).toFixed(1)}%`}, {icon: "â˜…", text: "é©æ€§è©•ä¾¡: Bç´š"}]
            }));
        }

        // ===== å€‹åˆ¥ãƒ¬ãƒ¼ã‚¹ç·¨é›†æ©Ÿèƒ½ =====
        window.editRace = function(raceNumber) {
            currentEditingRace = raceNumber;
            
            // ãƒ¬ãƒ¼ã‚¹ç·¨é›†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
            const editSection = document.getElementById('race-edit-section');
            editSection.style.display = 'block';
            
            // ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°
            const title = document.getElementById('race-edit-title');
            const tierMap = {
                '1R': 'premium', '2R': 'premium', '3R': 'premium', '4R': 'premium', '5R': 'premium',
                '6R': 'premium', '7R': 'premium', '8R': 'premium', '9R': 'premium',
                '10R': 'standard', '11R': 'ãƒ¡ã‚¤ãƒ³ãƒ»free', '12R': 'standard'
            };
            title.textContent = `ç·¨é›†ä¸­: ${raceNumber} (${tierMap[raceNumber] || 'unknown'})`;
            
            // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯èª­ã¿è¾¼ã¿
            if (allRacesData && allRacesData.races) {
                const existingRace = allRacesData.races.find(r => r.raceNumber === raceNumber);
                if (existingRace) {
                    loadRaceDataToForm(existingRace);
                } else {
                    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
                    loadDefaultRaceData(raceNumber);
                }
            } else {
                loadDefaultRaceData(raceNumber);
            }
            
            logAllRaces(`ğŸ¯ ${raceNumber}ã®è©³ç´°ç·¨é›†ã‚’é–‹å§‹ã—ã¾ã—ãŸ`);
            
            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ç·¨é›†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«ç§»å‹•
            editSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        };

        function loadRaceDataToForm(raceData) {
            // ãƒ¬ãƒ¼ã‚¹åŸºæœ¬æƒ…å ±ã‚’èª­ã¿è¾¼ã¿
            document.getElementById('edit-race-name').value = raceData.raceName || '';
            document.getElementById('edit-confidence').value = raceData.raceInfo?.confidence || '';
            document.getElementById('edit-ability-index').value = raceData.raceInfo?.abilityIndex || '';
            document.getElementById('edit-recommendation').value = raceData.raceInfo?.recommendation || 'B+';
            document.getElementById('edit-expected-return').value = raceData.raceInfo?.expectedReturn || '';
            
            // é¦¬æƒ…å ±ã‚’èª­ã¿è¾¼ã¿
            if (raceData.horses?.main) {
                document.getElementById('edit-main-number').value = raceData.horses.main.number || '';
                document.getElementById('edit-main-name').value = raceData.horses.main.name || '';
                document.getElementById('edit-main-confidence').value = raceData.horses.main.confidence || '';
            }
            
            if (raceData.horses?.sub1) {
                document.getElementById('edit-sub1-number').value = raceData.horses.sub1.number || '';
                document.getElementById('edit-sub1-name').value = raceData.horses.sub1.name || '';
                document.getElementById('edit-sub1-confidence').value = raceData.horses.sub1.confidence || '';
            }
            
            if (raceData.horses?.sub2) {
                document.getElementById('edit-sub2-number').value = raceData.horses.sub2.number || '';
                document.getElementById('edit-sub2-name').value = raceData.horses.sub2.name || '';
                document.getElementById('edit-sub2-confidence').value = raceData.horses.sub2.confidence || '';
            }
        }

        function loadDefaultRaceData(raceNumber) {
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
            const raceNum = parseInt(raceNumber.replace('R', ''));
            
            document.getElementById('edit-race-name').value = `ã‚µãƒ©ç³»3æ­³ä»¥ä¸Š`;
            document.getElementById('edit-confidence').value = (85 + Math.random() * 10).toFixed(1);
            document.getElementById('edit-ability-index').value = (75 + Math.random() * 20).toFixed(1);
            document.getElementById('edit-recommendation').value = raceNum === 11 ? 'A+' : 'B+';
            document.getElementById('edit-expected-return').value = (120 + Math.random() * 50).toFixed(0);
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé¦¬æƒ…å ±
            document.getElementById('edit-main-number').value = Math.floor(Math.random() * 12) + 1;
            document.getElementById('edit-main-name').value = `æœ¬å‘½é¦¬${raceNum}`;
            document.getElementById('edit-main-confidence').value = (85 + Math.random() * 10).toFixed(1);
            
            document.getElementById('edit-sub1-number').value = Math.floor(Math.random() * 12) + 1;
            document.getElementById('edit-sub1-name').value = `å¯¾æŠ—é¦¬${raceNum}`;
            document.getElementById('edit-sub1-confidence').value = (75 + Math.random() * 10).toFixed(1);
            
            document.getElementById('edit-sub2-number').value = Math.floor(Math.random() * 12) + 1;
            document.getElementById('edit-sub2-name').value = `å˜ç©´é¦¬${raceNum}`;
            document.getElementById('edit-sub2-confidence').value = (65 + Math.random() * 10).toFixed(1);
        }

        window.saveRaceEdit = function() {
            if (!currentEditingRace) {
                showAlert('ç·¨é›†ä¸­ã®ãƒ¬ãƒ¼ã‚¹ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }
            
            try {
                // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const raceData = {
                    raceNumber: currentEditingRace,
                    raceName: document.getElementById('edit-race-name').value,
                    tier: getRaceTier(parseInt(currentEditingRace.replace('R', ''))),
                    isMainRace: isMainRace(parseInt(currentEditingRace.replace('R', ''))),
                    displayOrder: parseInt(currentEditingRace.replace('R', '')),
                    raceInfo: {
                        title: `å·å´${currentEditingRace} ${document.getElementById('edit-race-name').value}`,
                        date: new Date().toISOString().split('T')[0],
                        track: "å·å´ç«¶é¦¬",
                        raceNumber: currentEditingRace,
                        raceName: document.getElementById('edit-race-name').value,
                        confidence: document.getElementById('edit-confidence').value,
                        abilityIndex: document.getElementById('edit-ability-index').value,
                        recommendation: document.getElementById('edit-recommendation').value,
                        expectedReturn: document.getElementById('edit-expected-return').value
                    },
                    horses: {
                        main: {
                            number: parseInt(document.getElementById('edit-main-number').value),
                            name: document.getElementById('edit-main-name').value,
                            type: 'æœ¬å‘½',
                            confidence: document.getElementById('edit-main-confidence').value
                        },
                        sub1: {
                            number: parseInt(document.getElementById('edit-sub1-number').value),
                            name: document.getElementById('edit-sub1-name').value,
                            type: 'å¯¾æŠ—',
                            confidence: document.getElementById('edit-sub1-confidence').value
                        },
                        sub2: {
                            number: parseInt(document.getElementById('edit-sub2-number').value),
                            name: document.getElementById('edit-sub2-name').value,
                            type: 'å˜ç©´',
                            confidence: document.getElementById('edit-sub2-confidence').value
                        }
                    }
                };
                
                // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                if (!allRacesData) {
                    allRacesData = {
                        raceDate: new Date().toISOString().split('T')[0],
                        track: "å·å´ç«¶é¦¬",
                        totalRaces: 12,
                        races: []
                    };
                }
                
                // æ—¢å­˜ãƒ¬ãƒ¼ã‚¹ã‚’æ›´æ–°ã¾ãŸã¯æ–°è¦è¿½åŠ 
                const existingIndex = allRacesData.races.findIndex(r => r.raceNumber === currentEditingRace);
                if (existingIndex >= 0) {
                    allRacesData.races[existingIndex] = raceData;
                } else {
                    allRacesData.races.push(raceData);
                }
                
                // ã‚½ãƒ¼ãƒˆ
                allRacesData.races.sort((a, b) => a.displayOrder - b.displayOrder);
                
                updateRaceStatus();
                logAllRaces(`âœ… ${currentEditingRace}ã®å¤‰æ›´ã‚’ä¿å­˜ã—ã¾ã—ãŸ`);
                showAlert(`${currentEditingRace}ã®å¤‰æ›´ã‚’ä¿å­˜ã—ã¾ã—ãŸ`, 'success');
                
            } catch (error) {
                console.error('ãƒ¬ãƒ¼ã‚¹ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                showAlert('ãƒ¬ãƒ¼ã‚¹ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                logAllRaces(`âŒ ${currentEditingRace}ã®ä¿å­˜ã«å¤±æ•—: ${error.message}`);
            }
        };

        window.cancelRaceEdit = function() {
            document.getElementById('race-edit-section').style.display = 'none';
            currentEditingRace = null;
            logAllRaces('âŒ ãƒ¬ãƒ¼ã‚¹ç·¨é›†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
        };

        window.resetRaceToDefault = function() {
            if (!currentEditingRace) return;
            
            if (confirm(`${currentEditingRace}ã®è¨­å®šã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ`)) {
                loadDefaultRaceData(currentEditingRace);
                logAllRaces(`ğŸ”„ ${currentEditingRace}ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã«æˆ»ã—ã¾ã—ãŸ`);
                showAlert(`${currentEditingRace}ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã—ã¾ã—ãŸ`, 'success');
            }
        };

        // ===== ãã®ä»–ã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° =====
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const text = element.value || element.textContent;
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    showAlert('ğŸ“‹ JSONãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'success');
                }).catch((err) => {
                    console.error('Clipboard copy failed:', err);
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: å¤ã„æ–¹æ³•ã‚’è©¦è¡Œ
                    fallbackCopyTextToClipboard(element, text);
                });
            } else {
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: å¤ã„æ–¹æ³•
                fallbackCopyTextToClipboard(element, text);
            }
        }
        
        function fallbackCopyTextToClipboard(element, text) {
            element.select();
            element.setSelectionRange(0, 99999); // ãƒ¢ãƒã‚¤ãƒ«ç”¨
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showAlert('ğŸ“‹ JSONãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'success');
                } else {
                    showAlert('âŒ ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§é¸æŠã—ã¦ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„', 'error');
                }
            } catch (err) {
                console.error('Fallback copy failed:', err);
                showAlert('âŒ ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§é¸æŠã—ã¦ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„', 'error');
            }
        }

        function downloadJson() {
            if (!allRacesData) {
                showAlert('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }

            const jsonString = JSON.stringify(allRacesData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'allRacesPrediction.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showAlert('JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ', 'success');
        }

        // ===== ãƒ¬ãƒ¼ã‚¹è¨­å®šæ¤œè¨¼é–¢æ•° =====
        function validateRaceConfiguration(data) {
            const errors = [];
            
            // 11RãŒãƒ¡ã‚¤ãƒ³ãƒ¬ãƒ¼ã‚¹ã‹ãƒã‚§ãƒƒã‚¯
            const race11 = data.races?.find(r => r.raceNumber === '11R');
            if (race11) {
                if (race11.tier !== 'free') {
                    errors.push('âŒ ã‚¨ãƒ©ãƒ¼: 11RãŒfreeã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆç¾åœ¨: ' + race11.tier + 'ï¼‰');
                }
                if (!race11.isMainRace) {
                    errors.push('âŒ ã‚¨ãƒ©ãƒ¼: 11Rã®isMainRaceãŒtrueã§ã¯ã‚ã‚Šã¾ã›ã‚“');
                }
            }
            
            // 12RãŒèª¤ã£ã¦freeã«ãªã£ã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯
            const race12 = data.races?.find(r => r.raceNumber === '12R');
            if (race12) {
                if (race12.tier === 'free') {
                    errors.push('âŒ é‡å¤§ã‚¨ãƒ©ãƒ¼: 12RãŒç„¡æ–™è¨­å®šã«ãªã£ã¦ã„ã¾ã™ï¼12Rã¯standardã§ã™ï¼');
                }
                if (race12.isMainRace) {
                    errors.push('âŒ é‡å¤§ã‚¨ãƒ©ãƒ¼: 12RãŒãƒ¡ã‚¤ãƒ³ãƒ¬ãƒ¼ã‚¹ã«ãªã£ã¦ã„ã¾ã™ï¼11RãŒãƒ¡ã‚¤ãƒ³ã§ã™ï¼');
                }
            }
            
            // planAccessã®ãƒã‚§ãƒƒã‚¯
            if (data.planAccess?.free?.races) {
                if (data.planAccess.free.races.includes('12R')) {
                    errors.push('âŒ ã‚¨ãƒ©ãƒ¼: planAccess.free.racesã«12RãŒå«ã¾ã‚Œã¦ã„ã¾ã™');
                }
                if (!data.planAccess.free.races.includes('11R')) {
                    errors.push('âŒ ã‚¨ãƒ©ãƒ¼: planAccess.free.racesã«11RãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                }
            }
            
            if (errors.length > 0) {
                console.error('ãƒ¬ãƒ¼ã‚¹è¨­å®šæ¤œè¨¼ã‚¨ãƒ©ãƒ¼:');
                errors.forEach(err => {
                    console.error(err);
                    logAllRaces(err);
                });
                showAlert('ãƒ¬ãƒ¼ã‚¹è¨­å®šã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'error');
                return false;
            }
            
            console.log('âœ… ãƒ¬ãƒ¼ã‚¹è¨­å®šæ¤œè¨¼: æ­£å¸¸');
            return true;
        }

        // ===== åˆæœŸåŒ– =====
        document.addEventListener('DOMContentLoaded', function() {
            logAllRaces('ğŸš€ ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†');
            updateImportanceBars();
            generateRaceEditButtons(); // ãƒ¬ãƒ¼ã‚¹ç·¨é›†ãƒœã‚¿ãƒ³ã‚’å‹•çš„ç”Ÿæˆ
            
            // åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆã‚‚ã—ã‚ã‚Œã°ï¼‰
            if (allRacesData) {
                validateRaceConfiguration(allRacesData);
            }
        });
    </script>
</body>
</html>