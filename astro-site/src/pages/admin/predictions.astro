---
// ç®¡ç†è€…ç”¨äºˆæƒ³å…¥åŠ›ãƒšãƒ¼ã‚¸
---

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ç®¡ç† | NANKANã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ç®¡ç†ç”»é¢</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e2e8f0;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .header {
            background: rgba(30, 41, 59, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .page-title {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-links {
            display: flex;
            gap: 16px;
        }

        .nav-link {
            color: #94a3b8;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .nav-link:hover {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
        }

        .form-section {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            color: #f1f5f9;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-size: 14px;
            color: #cbd5e1;
            margin-bottom: 6px;
        }

        .form-input, .form-select, .form-textarea {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 6px;
            padding: 10px;
            color: #e2e8f0;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .horse-entry {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .horse-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .horse-number-badge {
            background: #3b82f6;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .mark-select {
            width: 80px;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            color: white;
        }

        .btn-secondary {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px -5px rgba(59, 130, 246, 0.4);
        }

        .action-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
        }

        .predictions-list {
            margin-top: 32px;
        }

        .prediction-item {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .prediction-info {
            flex: 1;
        }

        .prediction-meta {
            color: #94a3b8;
            font-size: 14px;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-published {
            background: rgba(34, 197, 94, 0.1);
            color: #86efac;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .status-draft {
            background: rgba(251, 191, 36, 0.1);
            color: #fbbf24;
            border: 1px solid rgba(251, 191, 36, 0.3);
        }

        .alert {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert-success {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            color: #86efac;
        }

        .alert-error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #fca5a5;
        }

        .loading-state {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
            color: #94a3b8;
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 2px solid #475569;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 12px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .header {
                flex-direction: column;
                gap: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="page-title">ğŸ‡ äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h1>
            <div class="nav-links">
                <a href="/admin" class="nav-link">ç®¡ç†ç”»é¢ãƒˆãƒƒãƒ—</a>
                <a href="/dashboard" class="nav-link">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
            </div>
        </div>

        <div id="alert" class="alert"></div>

        <!-- å¤–éƒ¨äºˆæƒ³ãƒ†ã‚­ã‚¹ãƒˆå¤‰æ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <!-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠ -->
        <div class="form-section" style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(239, 68, 68, 0.1) 100%); border: 2px solid rgba(245, 158, 11, 0.3);">
            <h2 class="section-title">ğŸ“‹ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠ</h2>
            <div class="form-group">
                <label class="form-label">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠ</label>
                <select id="template_selector" class="form-select" onchange="applyTemplate()">
                    <option value="">-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>
                    <option value="daily_nankan">å—é–¢æ±äº¬ãƒ»å·å´ãƒ»èˆ¹æ©‹ãƒ»æµ¦å’Œï¼ˆæ—¥å¸¸ï¼‰</option>
                    <option value="big_race">é‡è³ãƒ»ç‰¹åˆ¥ãƒ¬ãƒ¼ã‚¹</option>
                    <option value="newcomer">æ–°é¦¬ãƒ»æœªå‹åˆ©æˆ¦</option>
                    <option value="handicap">ãƒãƒ³ãƒ‡æˆ¦</option>
                    <option value="dirt_sprint">ãƒ€ãƒ¼ãƒˆçŸ­è·é›¢</option>
                    <option value="dirt_mile">ãƒ€ãƒ¼ãƒˆãƒã‚¤ãƒ«</option>
                    <option value="dirt_distance">ãƒ€ãƒ¼ãƒˆä¸­é•·è·é›¢</option>
                </select>
            </div>
            <div style="margin-top: 15px;">
                <button class="btn btn-secondary" onclick="saveAsTemplate()" style="margin-right: 10px;">ğŸ’¾ ç¾åœ¨ã®è¨­å®šã‚’ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåŒ–</button>
                <button class="btn btn-outline" onclick="managementTemplates()">ğŸ—‚ï¸ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†</button>
            </div>
        </div>

        <div class="form-section" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(59, 130, 246, 0.1) 100%); border: 2px solid rgba(16, 185, 129, 0.3);">
            <h2 class="section-title">âš¡ å¤–éƒ¨äºˆæƒ³ â†’ AIäºˆæƒ³å¤‰æ›ï¼ˆæ¨å¥¨ï¼‰</h2>
            <p style="color: #94a3b8; margin-bottom: 16px;">
                æ—¢å­˜ã®äºˆæƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒšãƒ¼ã‚¹ãƒˆã™ã‚‹ã¨ã€è‡ªå‹•ã§AIäºˆæƒ³ã®è©³ç´°åˆ†æã«å¤‰æ›ã•ã‚Œã¾ã™ã€‚
            </p>
            
            <div class="form-group">
                <label class="form-label">å¤–éƒ¨äºˆæƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’è²¼ã‚Šä»˜ã‘</label>
                <textarea id="external_prediction" class="form-textarea" rows="8" 
                    placeholder="ä¾‹:
8/24å·å´11R ç¾½ç”°ç›ƒ
â—ï¼˜ã‚¢ãƒ³ã‚¸ãƒ¥ãƒ«ãƒŠ
â—‹ï¼‘ã‚¢ãƒ ãƒ¼ãƒ«ãƒ”ã‚¹ã‚±ã‚¹  
â–²ï¼•ãƒ­ãƒ¼ãƒ‰ãƒ¬ã‚¤ã‚¸ãƒ³ã‚°
â–³ï¼’ãƒ•ã‚¸ã‚°ãƒ¬ã‚¤ã‚¹
â–³ï¼™ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚¢ãƒˆãƒ 
â–³ï¼“ãƒ¬ã‚¤ã‚¨ãƒ‡ã‚£ãƒ³ãƒãƒ©

â€»å°ã¨é¦¬ç•ªãƒ»é¦¬åã‚’å«ã‚€ãƒ†ã‚­ã‚¹ãƒˆã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„"></textarea>
            </div>
            
            <div style="display: flex; gap: 12px;">
                <button class="btn btn-primary" onclick="convertPrediction()">ğŸ¤– AIäºˆæƒ³ã«å¤‰æ›</button>
                <button class="btn btn-secondary" onclick="clearConversion()">ã‚¯ãƒªã‚¢</button>
            </div>
        </div>

        <!-- ãƒ¬ãƒ¼ã‚¹åŸºæœ¬æƒ…å ± -->
        <div class="form-section">
            <h2 class="section-title">ğŸ“… ãƒ¬ãƒ¼ã‚¹æƒ…å ±</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">é–‹å‚¬æ—¥</label>
                    <input type="date" id="race_date" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">ç«¶é¦¬å ´</label>
                    <select id="race_track" class="form-select" required>
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        <option value="å¤§äº•">å¤§äº•</option>
                        <option value="å·å´">å·å´</option>
                        <option value="èˆ¹æ©‹">èˆ¹æ©‹</option>
                        <option value="æµ¦å’Œ">æµ¦å’Œ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">ãƒ¬ãƒ¼ã‚¹ç•ªå·</label>
                    <input type="number" id="race_number" min="1" max="12" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">ãƒ¬ãƒ¼ã‚¹å</label>
                    <input type="text" id="race_name" class="form-input" placeholder="ä¾‹: ç¾½ç”°ç›ƒ">
                </div>
                <div class="form-group">
                    <label class="form-label">è·é›¢ï¼ˆmï¼‰</label>
                    <input type="number" id="race_distance" class="form-input" placeholder="1600">
                </div>
                <div class="form-group">
                    <label class="form-label">ã‚³ãƒ¼ã‚¹</label>
                    <select id="race_type" class="form-select">
                        <option value="ãƒ€ãƒ¼ãƒˆ">ãƒ€ãƒ¼ãƒˆ</option>
                        <option value="èŠ">èŠ</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- äºˆæƒ³é¦¬å…¥åŠ› -->
        <div class="form-section">
            <h2 class="section-title">ğŸ´ äºˆæƒ³é¦¬ãƒ‡ãƒ¼ã‚¿</h2>
            <div id="horses-container">
                <!-- é¦¬ãƒ‡ãƒ¼ã‚¿ã¯JavaScriptã§å‹•çš„ã«è¿½åŠ  -->
            </div>
            <button class="btn btn-secondary" onclick="addHorse()">+ é¦¬ã‚’è¿½åŠ </button>
        </div>

        <!-- ç‰¹å¾´é‡é‡è¦åº¦ãƒãƒ¼ç·¨é›† -->
        <div class="form-section" style="background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.2);">
            <h2 class="section-title">ğŸ“Š ç‰¹å¾´é‡é‡è¦åº¦ãƒãƒ¼ç·¨é›†</h2>
            <p style="color: #94a3b8; margin-bottom: 20px; font-size: 0.9rem;">
                â—å°ã¨â—‹å°ã®ç‰¹å¾´é‡é‡è¦åº¦ã‚’å€‹åˆ¥è¨­å®šã€‚ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ç¢ºèªã—ãªãŒã‚‰èª¿æ•´å¯èƒ½ã€‚
            </p>
            
            <!-- â—å°ï¼ˆæœ¬å‘½ï¼‰ã®ç‰¹å¾´é‡é‡è¦åº¦ -->
            <div style="background: rgba(16, 185, 129, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <h4 style="color: #10b981; margin-bottom: 15px;">â— æœ¬å‘½é¦¬ã®ç‰¹å¾´é‡é‡è¦åº¦</h4>
                <div style="display: grid; gap: 15px;">
                    <div>
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                            <label class="form-label" style="margin-bottom: 0; min-width: 100px;">ç‰¹å¾´é‡1:</label>
                            <input type="text" id="mainFeature1Label" value="å®‰å®šæ€§" placeholder="ä¾‹: å®‰å®šæ€§, è¡€çµ±è©•ä¾¡" style="padding: 5px 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.2); border-radius: 4px; color: white; flex: 1;">
                        </div>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <input type="range" id="mainFeature1" min="0" max="100" value="95" style="flex: 1;">
                            <input type="number" id="mainFeature1Val" min="0" max="1" step="0.01" value="0.95" style="width: 80px; padding: 5px; background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.2); border-radius: 4px; color: white;">
                        </div>
                        <div class="preview-bar" style="margin-top: 8px;">
                            <div class="preview-bar-fill" style="width: 95%; height: 16px; background: linear-gradient(90deg, #10b981, #3b82f6); border-radius: 8px; display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; color: white; font-size: 0.75rem; font-weight: 600;">0.95</div>
                        </div>
                    </div>
                    <div>
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                            <label class="form-label" style="margin-bottom: 0; min-width: 100px;">ç‰¹å¾´é‡2:</label>
                            <input type="text" id="mainFeature2Label" value="èƒ½åŠ›ä¸Šä½æ€§" placeholder="ä¾‹: èƒ½åŠ›ä¸Šä½æ€§, ã‚¹ãƒ”ãƒ¼ãƒ‰æŒ‡æ•°" style="padding: 5px 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.2); border-radius: 4px; color: white; flex: 1;">
                        </div>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <input type="range" id="mainFeature2" min="0" max="100" value="88" style="flex: 1;">
                            <input type="number" id="mainFeature2Val" min="0" max="1" step="0.01" value="0.88" style="width: 80px; padding: 5px; background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.2); border-radius: 4px; color: white;">
                        </div>
                        <div class="preview-bar" style="margin-top: 8px;">
                            <div class="preview-bar-fill" style="width: 88%; height: 16px; background: linear-gradient(90deg, #10b981, #3b82f6); border-radius: 8px; display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; color: white; font-size: 0.75rem; font-weight: 600;">0.88</div>
                        </div>
                    </div>
                    <div>
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                            <label class="form-label" style="margin-bottom: 0; min-width: 100px;">ç‰¹å¾´é‡3:</label>
                            <input type="text" id="mainFeature3Label" value="å±•é–‹åˆ©" placeholder="ä¾‹: å±•é–‹åˆ©, æ é †å„ªä½" style="padding: 5px 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.2); border-radius: 4px; color: white; flex: 1;">
                        </div>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <input type="range" id="mainFeature3" min="0" max="100" value="82" style="flex: 1;">
                            <input type="number" id="mainFeature3Val" min="0" max="1" step="0.01" value="0.82" style="width: 80px; padding: 5px; background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.2); border-radius: 4px; color: white;">
                        </div>
                        <div class="preview-bar" style="margin-top: 8px;">
                            <div class="preview-bar-fill" style="width: 82%; height: 16px; background: linear-gradient(90deg, #10b981, #3b82f6); border-radius: 8px; display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; color: white; font-size: 0.75rem; font-weight: 600;">0.82</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- â—‹å°ï¼ˆå¯¾æŠ—ï¼‰ã®ç‰¹å¾´é‡é‡è¦åº¦ -->
            <div style="background: rgba(59, 130, 246, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <h4 style="color: #3b82f6; margin-bottom: 15px;">â—‹ å¯¾æŠ—é¦¬ã®ç‰¹å¾´é‡é‡è¦åº¦</h4>
                <div style="display: grid; gap: 15px;">
                    <div>
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                            <label class="form-label" style="margin-bottom: 0; min-width: 100px;">ç‰¹å¾´é‡1:</label>
                            <input type="text" id="subFeature1Label" value="å…ˆè¡ŒåŠ›" placeholder="ä¾‹: å…ˆè¡ŒåŠ›, ã‚¹ãƒ”ãƒ¼ãƒ‰æŒ‡æ•°" style="padding: 5px 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.2); border-radius: 4px; color: white; flex: 1;">
                        </div>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <input type="range" id="subFeature1" min="0" max="100" value="89" style="flex: 1;">
                            <input type="number" id="subFeature1Val" min="0" max="1" step="0.01" value="0.89" style="width: 80px; padding: 5px; background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.2); border-radius: 4px; color: white;">
                        </div>
                        <div class="preview-bar" style="margin-top: 8px;">
                            <div class="preview-bar-fill" style="width: 89%; height: 16px; background: linear-gradient(90deg, #3b82f6, #8b5cf6); border-radius: 8px; display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; color: white; font-size: 0.75rem; font-weight: 600;">0.89</div>
                        </div>
                    </div>
                    <div>
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                            <label class="form-label" style="margin-bottom: 0; min-width: 100px;">ç‰¹å¾´é‡2:</label>
                            <input type="text" id="subFeature2Label" value="ãƒ ãƒ©ä¿‚æ•°" placeholder="ä¾‹: ãƒ ãƒ©ä¿‚æ•°, çˆ†ç™ºåŠ›" style="padding: 5px 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.2); border-radius: 4px; color: white; flex: 1;">
                        </div>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <input type="range" id="subFeature2" min="0" max="100" value="76" style="flex: 1;">
                            <input type="number" id="subFeature2Val" min="0" max="1" step="0.01" value="0.76" style="width: 80px; padding: 5px; background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.2); border-radius: 4px; color: white;">
                        </div>
                        <div class="preview-bar" style="margin-top: 8px;">
                            <div class="preview-bar-fill" style="width: 76%; height: 16px; background: linear-gradient(90deg, #3b82f6, #8b5cf6); border-radius: 8px; display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; color: white; font-size: 0.75rem; font-weight: 600;">0.76</div>
                        </div>
                    </div>
                    <div>
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                            <label class="form-label" style="margin-bottom: 0; min-width: 100px;">ç‰¹å¾´é‡3:</label>
                            <input type="text" id="subFeature3Label" value="å±•é–‹æ¬¡ç¬¬" placeholder="ä¾‹: å±•é–‹æ¬¡ç¬¬, è·é›¢é©æ€§" style="padding: 5px 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.2); border-radius: 4px; color: white; flex: 1;">
                        </div>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <input type="range" id="subFeature3" min="0" max="100" value="71" style="flex: 1;">
                            <input type="number" id="subFeature3Val" min="0" max="1" step="0.01" value="0.71" style="width: 80px; padding: 5px; background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.2); border-radius: 4px; color: white;">
                        </div>
                        <div class="preview-bar" style="margin-top: 8px;">
                            <div class="preview-bar-fill" style="width: 71%; height: 16px; background: linear-gradient(90deg, #3b82f6, #8b5cf6); border-radius: 8px; display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; color: white; font-size: 0.75rem; font-weight: 600;">0.71</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- AIäºˆæƒ³JSONãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ -->
            <div style="margin-top: 20px; padding: 15px; background: rgba(139, 92, 246, 0.1); border-radius: 8px; border: 1px solid rgba(139, 92, 246, 0.3);">
                <div style="display: flex; gap: 15px; align-items: center;">
                    <button type="button" id="generateAIPredictionBtn" style="padding: 12px 24px; background: linear-gradient(135deg, #8b5cf6 0%, #3b82f6 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; flex: 1;">
                        ğŸš€ AIäºˆæƒ³JSONãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
                    </button>
                    <button type="button" id="testFeaturesBtn" style="padding: 12px 24px; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                        ğŸ§ª ãƒ†ã‚¹ãƒˆ
                    </button>
                </div>
                <p style="color: #94a3b8; margin: 10px 0 0 0; font-size: 0.9rem;">
                    è¨­å®šã—ãŸç‰¹å¾´é‡é‡è¦åº¦ã‚’å«ã‚€AIäºˆæƒ³JSONã‚’ç”Ÿæˆã—ã¾ã™
                </p>
            </div>
        </div>

        <!-- æŠ•è³‡æˆ¦ç•¥ -->
        <div class="form-section">
            <h2 class="section-title">ğŸ’° æŠ•è³‡æˆ¦ç•¥</h2>
            
            <div class="form-group">
                <label class="form-label">ä¿¡é ¼åº¦ã‚¹ã‚³ã‚¢ï¼ˆ%ï¼‰</label>
                <input type="number" id="confidence_score" min="0" max="100" step="0.1" class="form-input" placeholder="91.2">
            </div>

            <h3 style="margin: 20px 0 12px; font-size: 16px;">é«˜çš„ä¸­ç‡å‹</h3>
            <div class="form-group">
                <label class="form-label">è²·ã„ç›®ï¼ˆJSONå½¢å¼ï¼‰</label>
                <textarea id="strategy_safe" class="form-textarea" placeholder='{"hitRate": "78.5%", "returnRate": "132%", "bets": [{"type": "é¦¬é€£", "horses": "8-1,5", "points": 2}]}'></textarea>
            </div>

            <h3 style="margin: 20px 0 12px; font-size: 16px;">ãƒãƒ©ãƒ³ã‚¹å‹</h3>
            <div class="form-group">
                <label class="form-label">è²·ã„ç›®ï¼ˆJSONå½¢å¼ï¼‰</label>
                <textarea id="strategy_balance" class="form-textarea" placeholder='{"hitRate": "65.2%", "returnRate": "188%", "bets": [{"type": "é¦¬å˜", "horses": "8â†’1,5", "points": 2}]}'></textarea>
            </div>

            <h3 style="margin: 20px 0 12px; font-size: 16px;">é«˜é…å½“å‹</h3>
            <div class="form-group">
                <label class="form-label">è²·ã„ç›®ï¼ˆJSONå½¢å¼ï¼‰</label>
                <textarea id="strategy_aggressive" class="form-textarea" placeholder='{"hitRate": "42.1%", "returnRate": "312%", "bets": [{"type": "3é€£å˜", "horses": "8â†’1,5â†’2,3,9", "points": 6}]}'></textarea>
            </div>
        </div>

        <!-- å…¬é–‹è¨­å®š -->
        <div class="form-section">
            <h2 class="section-title">âš™ï¸ å…¬é–‹è¨­å®š</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¿ã‚¤ãƒ—</label>
                    <select id="content_type" class="form-select">
                        <option value="premium">ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ä¼šå“¡é™å®š</option>
                        <option value="standard">ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ä¼šå“¡ä»¥ä¸Š</option>
                        <option value="free">ç„¡æ–™å…¬é–‹</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">å…¬é–‹çŠ¶æ…‹</label>
                    <select id="is_published" class="form-select">
                        <option value="false">ä¸‹æ›¸ã</option>
                        <option value="true">å…¬é–‹</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="action-buttons">
            <button class="btn btn-secondary" onclick="saveDraft()">ä¸‹æ›¸ãä¿å­˜</button>
            <button class="btn btn-success" onclick="saveAndPublish()">ä¿å­˜ã—ã¦å…¬é–‹</button>
        </div>

        <!-- çš„ä¸­çµæœç®¡ç† -->
        <div class="form-section">
            <h2 class="section-title">ğŸ¯ çš„ä¸­çµæœç®¡ç†</h2>
            <p style="color: #94a3b8; margin-bottom: 16px;">
                å…¬é–‹æ¸ˆã¿ã®äºˆæƒ³ã«å¯¾ã—ã¦ã€å®Ÿéš›ã®ãƒ¬ãƒ¼ã‚¹çµæœã‚’è¨˜éŒ²ã—ã¾ã™ã€‚
            </p>
            
            <div class="form-group">
                <label class="form-label">çµæœãƒ‡ãƒ¼ã‚¿ä¸€æ‹¬è²¼ã‚Šä»˜ã‘</label>
                <textarea id="results_bulk_paste" class="form-textarea" rows="6" 
                    placeholder="ä¾‹:
8/24å·å´ç«¶é¦¬ çµæœ
11R 8-1é¦¬å˜ã€€2,340å†† çš„ä¸­ï¼
10R 3-5
9R 1-7é¦¬å˜ã€€890å†† çš„ä¸­ï¼

â€»ã€Œçš„ä¸­ï¼ã€ã‚„é…å½“é‡‘é¡ãŒã‚ã‚‹ãƒ¬ãƒ¼ã‚¹ãŒçš„ä¸­ã¨ã—ã¦è¨˜éŒ²ã•ã‚Œã¾ã™"></textarea>
            </div>
            
            <div style="display: flex; gap: 12px; margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="parseResults()">ğŸ“Š çµæœè§£æ</button>
                <button class="btn btn-secondary" onclick="clearResults()">ã‚¯ãƒªã‚¢</button>
            </div>
            
            <div id="results-preview" style="display: none;">
                <h3 style="color: #f1f5f9; margin-bottom: 12px;">è§£æçµæœãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
                <div id="results-summary" class="form-section" style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3);"></div>
                <button class="btn btn-success" onclick="saveResults()">ğŸ“ çµæœã‚’ä¿å­˜</button>
            </div>
        </div>

        <!-- çµ±è¨ˆæƒ…å ±è¡¨ç¤º -->
        <div class="form-section">
            <h2 class="section-title">ğŸ“ˆ çµ±è¨ˆæƒ…å ±</h2>
            <div id="stats-container">
                <div class="loading-state">
                    <div class="spinner"></div>
                    çµ±è¨ˆæƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...
                </div>
            </div>
        </div>

        <!-- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
        <div class="form-section" style="background: linear-gradient(135deg, rgba(168, 85, 247, 0.1) 0%, rgba(236, 72, 153, 0.1) 100%); border: 2px solid rgba(168, 85, 247, 0.3);">
            <h2 class="section-title">ğŸ‘ï¸ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
            <div style="margin-bottom: 15px;">
                <button class="btn btn-primary" onclick="togglePreview()" style="margin-right: 10px;">
                    <span id="preview-toggle-text">ğŸ” ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼é–‹å§‹</span>
                </button>
                <button class="btn btn-outline" onclick="refreshPreview()">ğŸ”„ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°</button>
            </div>
            <div id="realtime-preview" style="display: none; background: rgba(15, 23, 42, 0.8); border-radius: 8px; padding: 20px; border: 1px solid rgba(59, 130, 246, 0.3);">
                <div id="preview-content">
                    <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯JavaScriptã§ç”Ÿæˆ -->
                </div>
            </div>
        </div>

        <!-- ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯æ“ä½œ -->
        <div class="form-section" style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(16, 185, 129, 0.1) 100%); border: 2px solid rgba(245, 158, 11, 0.3);">
            <h2 class="section-title">âš¡ ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯æ“ä½œ</h2>
            <p style="color: #94a3b8; margin-bottom: 20px;">
                è¤‡é›‘ãªä½œæ¥­ã‚’1å›ã®ã‚¯ãƒªãƒƒã‚¯ã§å®Ÿè¡Œã—ã¾ã™ã€‚
            </p>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px;">
                <button onclick="oneClickUpdate()" class="btn" style="padding: 20px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 700; font-size: 1.1rem; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);">
                    ğŸ“Š äºˆæƒ³çµæœã‚’ä¸€æ‹¬æ›´æ–°
                    <div style="font-size: 0.9rem; font-weight: 400; margin-top: 8px;">è§£æ â†’ çµ±è¨ˆè¨ˆç®— â†’ è‡ªå‹•ä¿å­˜</div>
                </button>
                <button onclick="oneClickBackup()" class="btn" style="padding: 20px; background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 700; font-size: 1.1rem; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);">
                    ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
                    <div style="font-size: 0.9rem; font-weight: 400; margin-top: 8px;">å…¨äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</div>
                </button>
                <button onclick="oneClickDeploy()" class="btn" style="padding: 20px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 700; font-size: 1.1rem; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);">
                    ğŸš€ æœ¬ç•ªç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤
                    <div style="font-size: 0.9rem; font-weight: 400; margin-top: 8px;">commit â†’ push â†’ å…¬é–‹</div>
                </button>
            </div>
            <div id="oneclick-status" style="margin-top: 20px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 8px; color: #e2e8f0; display: none;"></div>
        </div>

        <!-- GitåŒæœŸã‚·ã‚¹ãƒ†ãƒ  -->
        <div class="form-section" style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(59, 130, 246, 0.1) 100%); border: 2px solid rgba(34, 197, 94, 0.3);">
            <h2 class="section-title">ğŸ”„ GitåŒæœŸã‚·ã‚¹ãƒ†ãƒ </h2>
            <div style="margin-bottom: 20px;">
                <div id="git-status" style="background: rgba(15, 23, 42, 0.5); padding: 15px; border-radius: 6px; margin-bottom: 15px; border: 1px solid rgba(71, 85, 105, 0.3);">
                    <p style="color: #94a3b8; margin: 0;">GitçŠ¶æ…‹ã‚’ç¢ºèªä¸­...</p>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                    <button class="btn btn-outline" onclick="checkGitStatus()" style="margin: 0;">ğŸ“Š GitçŠ¶æ…‹ç¢ºèª</button>
                    <button class="btn btn-secondary" onclick="commitChanges()" style="margin: 0;">ğŸ’¾ å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ</button>
                    <button class="btn btn-primary" onclick="pushToRemote()" style="margin: 0;">â¬†ï¸ ãƒªãƒ¢ãƒ¼ãƒˆã«ãƒ—ãƒƒã‚·ãƒ¥</button>
                    <button class="btn btn-success" onclick="autoSync()" style="margin: 0;">âš¡ è‡ªå‹•åŒæœŸ</button>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</label>
                <input type="text" id="commit-message" class="form-input" placeholder="ç®¡ç†ãƒ‘ãƒãƒ«ã‹ã‚‰äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°">
            </div>
            <div style="margin-top: 15px;">
                <label style="display: flex; align-items: center; color: #e2e8f0; cursor: pointer;">
                    <input type="checkbox" id="auto-commit" style="margin-right: 8px;">
                    ãƒ‡ãƒ¼ã‚¿ä¿å­˜æ™‚ã«è‡ªå‹•ã‚³ãƒŸãƒƒãƒˆ
                </label>
            </div>
            <div id="git-log" style="margin-top: 15px; max-height: 200px; overflow-y: auto; background: rgba(15, 23, 42, 0.5); padding: 15px; border-radius: 6px; border: 1px solid rgba(71, 85, 105, 0.3); font-family: monospace; font-size: 13px; display: none;">
                <!-- Gitæ“ä½œãƒ­ã‚° -->
            </div>
        </div>

        <!-- ç”Ÿæˆã•ã‚ŒãŸJSONã®è¡¨ç¤º -->
        <div class="form-section" style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.2);">
            <h2 class="section-title">ğŸ“‹ ç”Ÿæˆã•ã‚ŒãŸJSON</h2>
            <p id="outputDescription" style="color: #94a3b8; margin-bottom: 15px;">
                ä¸‹è¨˜ã®JSONã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ <code>src/data/aiPrediction.json</code> ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„
            </p>
            <pre id="jsonOutput" style="background: #1e293b; border-radius: 8px; padding: 20px; color: #10b981; font-family: 'Courier New', monospace; font-size: 0.9rem; overflow-x: auto; white-space: pre-wrap;">ã“ã“ã«JSONãŒç”Ÿæˆã•ã‚Œã¾ã™...</pre>
            <div style="display: flex; gap: 15px; margin-top: 15px;">
                <button type="button" id="copyBtn" style="padding: 10px 20px; background: #8b5cf6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                    ğŸ“‹ JSONã‚’ã‚³ãƒ”ãƒ¼
                </button>
                <button type="button" id="aiCopyBtn" style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: none;">
                    ğŸ¤– AIäºˆæƒ³JSONã‚³ãƒ”ãƒ¼
                </button>
                <button type="button" id="clearJsonBtn" style="padding: 10px 20px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                    ğŸ—‘ï¸ JSONã‚¯ãƒªã‚¢
                </button>
            </div>
        </div>

        <!-- æ—¢å­˜ã®äºˆæƒ³ä¸€è¦§ -->
        <div class="predictions-list">
            <h2 class="section-title">ğŸ“‹ æ—¢å­˜ã®äºˆæƒ³ãƒ‡ãƒ¼ã‚¿</h2>
            <div id="predictions-container">
                <!-- æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¯JavaScriptã§å‹•çš„ã«è¡¨ç¤º -->
            </div>
        </div>
    </div>

    <script type="module">
        import { supabase, auth } from '/src/lib/supabase.js';

        let horseCount = 0;
        let parsedPredictionData = null; // è§£æãƒ‡ãƒ¼ã‚¿ä¿å­˜ç”¨

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            // ç®¡ç†è€…æ¨©é™ãƒã‚§ãƒƒã‚¯
            await checkAdminAuth();
            
            // ä»Šæ—¥ã®æ—¥ä»˜ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('race_date').value = today;
            
            // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            await loadExistingPredictions();
            
            // çµ±è¨ˆæƒ…å ±èª­ã¿è¾¼ã¿
            await loadStatistics();
            
            // ç‰¹å¾´é‡é‡è¦åº¦ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼åˆæœŸåŒ–
            setupFeatureSliders();
        });

        // ç®¡ç†è€…æ¨©é™ãƒã‚§ãƒƒã‚¯
        async function checkAdminAuth() {
            try {
                const { data: { user }, error } = await auth.getUser();
                
                if (error || !user) {
                    window.location.href = '/auth/login?redirect=' + encodeURIComponent(window.location.pathname);
                    return;
                }
                
                // TODO: ç®¡ç†è€…æ¨©é™ã®è©³ç´°ãƒã‚§ãƒƒã‚¯
                // ç¾åœ¨ã¯ç°¡æ˜“çš„ã«ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç®¡ç†è€…ã¨ã¿ãªã™
                
            } catch (error) {
                console.error('Auth check error:', error);
                showAlert('èªè¨¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            }
        }

        // é¦¬è¿½åŠ 
        window.addHorse = function() {
            horseCount++;
            const container = document.getElementById('horses-container');
            
            const horseHTML = `
                <div class="horse-entry" id="horse-${horseCount}">
                    <div class="horse-header">
                        <div class="horse-number-badge">${horseCount}</div>
                        <select class="form-select mark-select" id="mark-${horseCount}">
                            <option value="">å°ãªã—</option>
                            <option value="â—">â—æœ¬å‘½</option>
                            <option value="â—‹">â—‹å¯¾æŠ—</option>
                            <option value="â–²">â–²å˜ç©´</option>
                            <option value="â–³">â–³é€£ä¸‹</option>
                            <option value="â˜†">â˜†æ³¨æ„</option>
                        </select>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">é¦¬ç•ª</label>
                            <input type="number" id="number-${horseCount}" min="1" max="18" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">é¦¬å</label>
                            <input type="text" id="name-${horseCount}" class="form-input">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">è©•ä¾¡è¦ç´ ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</label>
                        <input type="text" id="factors-${horseCount}" class="form-input" 
                               placeholder="èƒ½åŠ›æŒ‡æ•°: 86.8, å®‰å®šæ€§: 91.9%, å±•é–‹é©æ€§: S">
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', horseHTML);
        }

        // ãƒ‡ãƒ¼ã‚¿åé›†
        function collectFormData() {
            const horses = [];
            
            for (let i = 1; i <= horseCount; i++) {
                const number = document.getElementById(`number-${i}`)?.value;
                const name = document.getElementById(`name-${i}`)?.value;
                const mark = document.getElementById(`mark-${i}`)?.value;
                const factorsStr = document.getElementById(`factors-${i}`)?.value;
                
                if (number && name) {
                    const factors = factorsStr ? factorsStr.split(',').map(f => f.trim()) : [];
                    horses.push({ number: parseInt(number), name, mark, factors });
                }
            }
            
            // æˆ¦ç•¥ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ‘ãƒ¼ã‚¹
            let strategySafe, strategyBalance, strategyAggressive;
            
            try {
                strategySafe = JSON.parse(document.getElementById('strategy_safe').value || '{}');
            } catch { strategySafe = {}; }
            
            try {
                strategyBalance = JSON.parse(document.getElementById('strategy_balance').value || '{}');
            } catch { strategyBalance = {}; }
            
            try {
                strategyAggressive = JSON.parse(document.getElementById('strategy_aggressive').value || '{}');
            } catch { strategyAggressive = {}; }
            
            return {
                race_date: document.getElementById('race_date').value,
                race_track: document.getElementById('race_track').value,
                race_number: parseInt(document.getElementById('race_number').value),
                race_name: document.getElementById('race_name').value,
                race_distance: parseInt(document.getElementById('race_distance').value) || null,
                race_type: document.getElementById('race_type').value,
                confidence_score: parseFloat(document.getElementById('confidence_score').value) || null,
                content_type: document.getElementById('content_type').value,
                is_published: document.getElementById('is_published').value === 'true',
                prediction_data: {
                    horses,
                    strategies: {
                        safe: strategySafe,
                        balance: strategyBalance,
                        aggressive: strategyAggressive
                    }
                }
            };
        }

        // ä¸‹æ›¸ãä¿å­˜
        window.saveDraft = async function() {
            const data = collectFormData();
            data.is_published = false;
            await savePrediction(data);
        }

        // ä¿å­˜ã—ã¦å…¬é–‹
        window.saveAndPublish = async function() {
            const data = collectFormData();
            data.is_published = true;
            await savePrediction(data);
        }

        // ãƒ‡ãƒ¼ã‚¿ä¿å­˜
        async function savePrediction(data) {
            try {
                const { data: result, error } = await supabase
                    .from('prediction_content')
                    .insert([data])
                    .select();
                
                if (error) {
                    throw error;
                }
                
                showAlert('äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼', 'success');
                
                // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
                setTimeout(() => {
                    if (confirm('æ–°ã—ã„äºˆæƒ³ã‚’å…¥åŠ›ã—ã¾ã™ã‹ï¼Ÿ')) {
                        location.reload();
                    }
                }, 1000);
                
            } catch (error) {
                console.error('Save error:', error);
                showAlert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
            }
        }

        // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆæ‹¡å¼µç‰ˆã‚’å¾Œã§å®šç¾©ï¼‰

        // ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
        function showAlert(message, type) {
            const alert = document.getElementById('alert');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }

        // å¤–éƒ¨äºˆæƒ³å¤‰æ›æ©Ÿèƒ½
        window.convertPrediction = async function() {
            const externalText = document.getElementById('external_prediction').value;
            if (!externalText.trim()) {
                showAlert('å¤‰æ›ã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            try {
                // ãƒ†ã‚­ã‚¹ãƒˆè§£æ
                const parsed = parseExternalPrediction(externalText);
                parsedPredictionData = parsed;

                // ãƒ•ã‚©ãƒ¼ãƒ ã«è‡ªå‹•å…¥åŠ›
                document.getElementById('race_date').value = parsed.raceDate || new Date().toISOString().split('T')[0];
                document.getElementById('race_track').value = parsed.trackName || '';
                document.getElementById('race_number').value = parsed.raceNumber || '';
                document.getElementById('race_name').value = parsed.raceName || '';
                document.getElementById('race_distance').value = parsed.raceDistance || 1600;
                document.getElementById('confidence_score').value = parsed.confidence || 85;

                // æ—¢å­˜ã®é¦¬ã‚¨ãƒ³ãƒˆãƒªãƒ¼ã‚’ã‚¯ãƒªã‚¢
                document.getElementById('horses-container').innerHTML = '';
                horseCount = 0;

                // æ¤œå‡ºã—ãŸé¦¬ã‚’è¿½åŠ 
                parsed.horses.forEach(horse => {
                    addHorse();
                    const idx = horseCount;
                    document.getElementById(`number-${idx}`).value = horse.number;
                    document.getElementById(`name-${idx}`).value = horse.name;
                    document.getElementById(`mark-${idx}`).value = horse.mark;
                    
                    // AIè©•ä¾¡è¦ç´ ã‚’è‡ªå‹•ç”Ÿæˆ
                    const factors = generateHorseFactors(horse);
                    document.getElementById(`factors-${idx}`).value = factors.join(', ');
                });

                // æˆ¦ç•¥ã‚’è‡ªå‹•ç”Ÿæˆ
                const strategies = generateStrategies(parsed);
                document.getElementById('strategy_safe').value = JSON.stringify(strategies.safe, null, 2);
                document.getElementById('strategy_balance').value = JSON.stringify(strategies.balance, null, 2);
                document.getElementById('strategy_aggressive').value = JSON.stringify(strategies.aggressive, null, 2);

                showAlert(`âœ… å¤‰æ›å®Œäº†ï¼${parsed.horses.length}é ­ã®é¦¬ã‚’æ¤œå‡ºã—ã€AIäºˆæƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¾ã—ãŸ`, 'success');

            } catch (error) {
                console.error('å¤‰æ›ã‚¨ãƒ©ãƒ¼:', error);
                showAlert('å¤‰æ›ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
            }
        }

        // å¤–éƒ¨äºˆæƒ³è§£æ
        function parseExternalPrediction(text) {
            const lines = text.split('\n').map(line => line.trim()).filter(line => line);
            const result = {
                horses: [],
                raceDate: null,
                trackName: null,
                raceNumber: null,
                raceName: null,
                raceDistance: null,
                confidence: 85
            };

            // æ—¥ä»˜ã¨ç«¶é¦¬å ´æƒ…å ±ã‚’æŠ½å‡º
            const headerMatch = text.match(/(\d+\/\d+)([^\d]*?)([\dï¼-ï¼™]+)[ï¼²Rr]/i);
            if (headerMatch) {
                const [month, day] = headerMatch[1].split('/');
                const year = new Date().getFullYear();
                result.raceDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                
                const trackText = headerMatch[2];
                if (trackText.includes('å·å´')) result.trackName = 'å·å´';
                else if (trackText.includes('å¤§äº•')) result.trackName = 'å¤§äº•';
                else if (trackText.includes('èˆ¹æ©‹')) result.trackName = 'èˆ¹æ©‹';
                else if (trackText.includes('æµ¦å’Œ')) result.trackName = 'æµ¦å’Œ';

                result.raceNumber = parseInt(headerMatch[3].replace(/[ï¼-ï¼™]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0)));
            }

            // ãƒ¬ãƒ¼ã‚¹åã‚’æŠ½å‡º
            const raceNameMatch = text.match(/\d+[ï¼²Rr]\s+([^\nâ—â—‹â–²â–³Ã—â˜†â˜…]+)/i);
            if (raceNameMatch) {
                result.raceName = raceNameMatch[1].trim();
            }

            // é¦¬æƒ…å ±ã‚’æŠ½å‡ºï¼ˆè¤‡æ•°ãƒ‘ã‚¿ãƒ¼ãƒ³ã«å¯¾å¿œï¼‰
            const horsePatterns = [
                /([â—â—‹â—¯â–²â–³Ã—â˜†â˜…])\s*([ï¼-ï¼™0-9]+)\s*(.+?)(?=[\nâ—â—‹â—¯â–²â–³Ã—â˜†â˜…]|$)/g,
                /([â—â—‹â—¯â–²â–³Ã—â˜†â˜…])([ï¼-ï¼™0-9]+)(.+?)(?=[\nâ—â—‹â—¯â–²â–³Ã—â˜†â˜…]|$)/g,
                /([â—â—‹â—¯â–²â–³Ã—â˜†â˜…])\s*([^\s]+)/g
            ];

            for (const pattern of horsePatterns) {
                const matches = [...text.matchAll(pattern)];
                if (matches.length > 0) {
                    matches.forEach(match => {
                        const mark = match[1];
                        const numberStr = match[2] || '';
                        const name = (match[3] || match[2] || '').trim();
                        
                        // é¦¬ç•ªã‚’æŠ½å‡ºï¼ˆå…¨è§’â†’åŠè§’å¤‰æ›ï¼‰
                        const number = parseInt(numberStr.replace(/[ï¼-ï¼™]/g, s => 
                            String.fromCharCode(s.charCodeAt(0) - 0xFEE0)
                        )) || result.horses.length + 1;

                        if (name && !name.match(/^[ï¼-ï¼™0-9]+$/)) {
                            result.horses.push({ mark, number, name: name.replace(/^[ï¼-ï¼™0-9]+/, '') });
                        }
                    });
                    if (result.horses.length > 0) break;
                }
            }

            // ä¿¡é ¼åº¦ã‚’å°ã®åˆ†å¸ƒã‹ã‚‰è¨ˆç®—
            const mainCount = result.horses.filter(h => h.mark === 'â—').length;
            const subCount = result.horses.filter(h => h.mark === 'â—‹' || h.mark === 'â—¯').length;
            if (mainCount === 1 && subCount <= 2) {
                result.confidence = 88 + Math.random() * 7; // 88-95%
            } else if (mainCount === 1) {
                result.confidence = 82 + Math.random() * 6; // 82-88%
            } else {
                result.confidence = 75 + Math.random() * 7; // 75-82%
            }

            return result;
        }

        // é¦¬ã®è©•ä¾¡è¦ç´ ã‚’è‡ªå‹•ç”Ÿæˆ
        function generateHorseFactors(horse) {
            const factors = [];
            
            if (horse.mark === 'â—') {
                factors.push(`èƒ½åŠ›æŒ‡æ•°: ${(85 + Math.random() * 10).toFixed(1)}`);
                factors.push(`å®‰å®šæ€§: ${(88 + Math.random() * 10).toFixed(1)}%`);
                factors.push('å±•é–‹é©æ€§: S');
            } else if (horse.mark === 'â—‹' || horse.mark === 'â—¯') {
                factors.push(`ã‚¹ãƒ”ãƒ¼ãƒ‰æŒ‡æ•°: ${(75 + Math.random() * 10).toFixed(1)}`);
                factors.push(`å…ˆè¡ŒåŠ›: ${(82 + Math.random() * 15).toFixed(1)}%`);
                factors.push('æ é †å„ªä½æ€§: A');
            } else if (horse.mark === 'â–²') {
                factors.push(`çˆ†ç™ºåŠ›: ${(80 + Math.random() * 15).toFixed(1)}`);
                factors.push('ãƒ ãƒ©ä¿‚æ•°: é«˜å¤‰å‹•');
                factors.push('å±•é–‹æ¬¡ç¬¬');
            } else if (horse.mark === 'â–³') {
                factors.push(`æŒç¶šåŠ›: ${(70 + Math.random() * 15).toFixed(1)}`);
                factors.push('é€£å¯¾ç‡: ä¸­ä½');
                factors.push('ç´ç©´å€™è£œ');
            } else {
                factors.push(`åŸºç¤èƒ½åŠ›: ${(65 + Math.random() * 15).toFixed(1)}`);
                factors.push('ç‰¹æ®Šæ¡ä»¶é©æ€§');
            }
            
            return factors;
        }

        // æŠ•è³‡æˆ¦ç•¥ã‚’è‡ªå‹•ç”Ÿæˆ
        function generateStrategies(parsed) {
            const mainHorses = parsed.horses.filter(h => h.mark === 'â—');
            const subHorses = parsed.horses.filter(h => h.mark === 'â—‹' || h.mark === 'â—¯');
            const darkHorses = parsed.horses.filter(h => h.mark === 'â–²');
            const underHorses = parsed.horses.filter(h => h.mark === 'â–³');
            
            const main = mainHorses[0]?.number || 1;
            const subs = subHorses.map(h => h.number);
            const darks = darkHorses.map(h => h.number);
            const unders = underHorses.map(h => h.number);

            return {
                safe: {
                    hitRate: `${(75 + Math.random() * 10).toFixed(1)}%`,
                    returnRate: `${(120 + Math.random() * 30).toFixed(0)}%`,
                    bets: [
                        { type: 'é¦¬é€£', horses: `${main}-${[...subs, ...darks].slice(0, 3).join(',')}`, points: subs.length + darks.length },
                        { type: 'é¦¬å˜', horses: `${main}â†’${[...subs, ...darks].slice(0, 2).join(',')}`, points: 2 },
                        { type: '3é€£è¤‡', horses: `${main}-${[...subs, ...darks].slice(0, 2).join(',')}-${[...darks, ...unders].slice(0, 3).join(',')}`, points: 6 }
                    ]
                },
                balance: {
                    hitRate: `${(60 + Math.random() * 10).toFixed(1)}%`,
                    returnRate: `${(160 + Math.random() * 40).toFixed(0)}%`,
                    bets: [
                        { type: 'é¦¬å˜', horses: `${main}â†’${[...subs, ...darks].join(',')}`, points: subs.length + darks.length },
                        { type: '3é€£è¤‡', horses: `${main},${subs[0]}-${[...darks, ...unders].join(',')}`, points: 10 },
                        { type: 'ãƒ¯ã‚¤ãƒ‰', horses: `${main}-${[...subs, ...darks].join(',')}`, points: subs.length + darks.length }
                    ]
                },
                aggressive: {
                    hitRate: `${(35 + Math.random() * 15).toFixed(1)}%`,
                    returnRate: `${(280 + Math.random() * 120).toFixed(0)}%`,
                    bets: [
                        { type: '3é€£å˜', horses: `${main}â†’${[...subs, ...darks].slice(0, 2).join(',')}â†’${[...darks, ...unders].join(',')}`, points: 12 },
                        { type: '3é€£å˜', horses: `${subs[0] || 2}â†’${main}â†’${[...darks, ...unders].join(',')}`, points: 8 },
                        { type: 'é¦¬å˜', horses: `${darks[0] || 3}â†’${main},${subs[0] || 2}`, points: 2 }
                    ]
                }
            };
        }

        // ã‚¯ãƒªã‚¢æ©Ÿèƒ½
        window.clearConversion = function() {
            document.getElementById('external_prediction').value = '';
            parsedPredictionData = null;
            showAlert('å¤–éƒ¨äºˆæƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'success');
        }

        // çµæœè§£ææ©Ÿèƒ½
        window.parseResults = function() {
            const bulkText = document.getElementById('results_bulk_paste').value;
            if (!bulkText.trim()) {
                showAlert('è§£æã™ã‚‹çµæœãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            try {
                const lines = bulkText.split('\n').filter(line => line.trim());
                const results = [];
                let raceDate = null;
                let trackName = null;

                // æ—¥ä»˜ã¨ç«¶é¦¬å ´ã‚’æŠ½å‡º
                const headerMatch = bulkText.match(/(\d+\/\d+)([^\d]*?)ç«¶é¦¬/);
                if (headerMatch) {
                    const [month, day] = headerMatch[1].split('/');
                    const year = new Date().getFullYear();
                    raceDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                    
                    const trackText = headerMatch[2];
                    if (trackText.includes('å·å´')) trackName = 'å·å´';
                    else if (trackText.includes('å¤§äº•')) trackName = 'å¤§äº•';
                    else if (trackText.includes('èˆ¹æ©‹')) trackName = 'èˆ¹æ©‹';
                    else if (trackText.includes('æµ¦å’Œ')) trackName = 'æµ¦å’Œ';
                }

                // ãƒ¬ãƒ¼ã‚¹çµæœã‚’è§£æ
                lines.forEach(line => {
                    const raceMatch = line.match(/([ï¼-ï¼™0-9]+)[ï¼²Rr]/);
                    if (raceMatch) {
                        const raceNum = parseInt(raceMatch[1].replace(/[ï¼-ï¼™]/g, s => 
                            String.fromCharCode(s.charCodeAt(0) - 0xFEE0)
                        ));
                        
                        const payoutMatch = line.match(/(\d[\d,.]*)å††/);
                        const isHit = payoutMatch || line.includes('çš„ä¸­');
                        const payout = payoutMatch ? parseInt(payoutMatch[1].replace(/[,.]/g, '')) : 0;
                        
                        results.push({
                            raceNumber: raceNum,
                            status: isHit ? 'hit' : 'miss',
                            payoutAmount: payout,
                            rawLine: line.trim()
                        });
                    }
                });

                if (results.length === 0) {
                    showAlert('ãƒ¬ãƒ¼ã‚¹çµæœã‚’è§£æã§ãã¾ã›ã‚“ã§ã—ãŸ', 'error');
                    return;
                }

                parsedResults = {
                    raceDate,
                    trackName,
                    results
                };

                // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
                displayResultsPreview(parsedResults);
                showAlert(`âœ… è§£æå®Œäº†ï¼${results.length}ãƒ¬ãƒ¼ã‚¹ã®çµæœã‚’æ¤œå‡ºã—ã¾ã—ãŸ`, 'success');

            } catch (error) {
                console.error('çµæœè§£æã‚¨ãƒ©ãƒ¼:', error);
                showAlert('çµæœã®è§£æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            }
        }

        // çµæœãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
        function displayResultsPreview(data) {
            const preview = document.getElementById('results-preview');
            const summary = document.getElementById('results-summary');
            
            const hitCount = data.results.filter(r => r.status === 'hit').length;
            const totalPayout = data.results.reduce((sum, r) => sum + r.payoutAmount, 0);
            const hitRate = ((hitCount / data.results.length) * 100).toFixed(1);
            const avgPayout = hitCount > 0 ? Math.round(totalPayout / hitCount) : 0;

            summary.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; text-align: center;">
                    <div>
                        <div style="font-size: 24px; font-weight: 700; color: #10b981;">${data.results.length}</div>
                        <div style="color: #94a3b8;">ãƒ¬ãƒ¼ã‚¹æ•°</div>
                    </div>
                    <div>
                        <div style="font-size: 24px; font-weight: 700; color: #3b82f6;">${hitCount}</div>
                        <div style="color: #94a3b8;">çš„ä¸­æ•°</div>
                    </div>
                    <div>
                        <div style="font-size: 24px; font-weight: 700; color: #f59e0b;">${hitRate}%</div>
                        <div style="color: #94a3b8;">çš„ä¸­ç‡</div>
                    </div>
                    <div>
                        <div style="font-size: 24px; font-weight: 700; color: #8b5cf6;">${totalPayout.toLocaleString()}å††</div>
                        <div style="color: #94a3b8;">ç·é…å½“</div>
                    </div>
                    <div>
                        <div style="font-size: 24px; font-weight: 700; color: #06b6d4;">${avgPayout.toLocaleString()}å††</div>
                        <div style="color: #94a3b8;">å¹³å‡é…å½“</div>
                    </div>
                </div>
                <div style="margin-top: 16px; font-size: 14px; color: #cbd5e1;">
                    å¯¾è±¡: ${data.raceDate || 'æ—¥ä»˜ä¸æ˜'} ${data.trackName || 'ç«¶é¦¬å ´ä¸æ˜'}
                </div>
            `;
            
            preview.style.display = 'block';
        }

        // ãã®ä»–ã®æ©Ÿèƒ½ç¾¤ã‚’è¿½åŠ ...
        let parsedResults = null;
        let allPredictions = [];

        // çµæœä¿å­˜
        window.saveResults = async function() {
            if (!parsedResults) {
                showAlert('ä¿å­˜ã™ã‚‹çµæœãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }

            try {
                // å¯¾è±¡ã®äºˆæƒ³ã‚’æ¤œç´¢ã—ã¦çµæœã‚’ä¿å­˜
                for (const result of parsedResults.results) {
                    const { data: predictions, error } = await supabase
                        .from('prediction_content')
                        .select('id')
                        .eq('race_date', parsedResults.raceDate)
                        .eq('race_track', parsedResults.trackName)
                        .eq('race_number', result.raceNumber)
                        .eq('is_published', true);

                    if (error) throw error;

                    if (predictions && predictions.length > 0) {
                        // çµæœãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ä¿å­˜
                        const { error: insertError } = await supabase
                            .from('prediction_results')
                            .upsert({
                                prediction_id: predictions[0].id,
                                actual_result: { raw_line: result.rawLine },
                                hit_status: result.status,
                                payout_amount: result.payoutAmount
                            }, { 
                                onConflict: 'prediction_id'
                            });

                        if (insertError) throw insertError;
                    }
                }

                showAlert('âœ… çµæœãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼', 'success');
                
                // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’éè¡¨ç¤ºã«ã—ã¦çµ±è¨ˆã‚’å†èª­ã¿è¾¼ã¿
                document.getElementById('results-preview').style.display = 'none';
                document.getElementById('results_bulk_paste').value = '';
                parsedResults = null;
                await loadStatistics();
                await loadExistingPredictions();

            } catch (error) {
                console.error('çµæœä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                showAlert('çµæœã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
            }
        }

        // çµæœã‚¯ãƒªã‚¢
        window.clearResults = function() {
            document.getElementById('results_bulk_paste').value = '';
            document.getElementById('results-preview').style.display = 'none';
            parsedResults = null;
            showAlert('çµæœãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'success');
        }

        // çµ±è¨ˆæƒ…å ±èª­ã¿è¾¼ã¿ï¼ˆæ‹¡å¼µç‰ˆï¼‰
        async function loadStatistics() {
            const container = document.getElementById('stats-container');
            
            try {
                const { data: predictions, error } = await supabase
                    .from('prediction_content')
                    .select(`
                        *,
                        prediction_results (*)
                    `)
                    .eq('is_published', true)
                    .gte('race_date', new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]);
                
                if (error) throw error;

                // æ‰‹å‹•çµ±è¨ˆè¨ˆç®—
                const totalPredictions = predictions.length;
                const withResults = predictions.filter(p => p.prediction_results.length > 0);
                const hits = withResults.filter(p => p.prediction_results[0]?.hit_status === 'hit');
                const totalPayout = hits.reduce((sum, p) => sum + (p.prediction_results[0]?.payout_amount || 0), 0);
                
                const hitRate = withResults.length > 0 ? ((hits.length / withResults.length) * 100).toFixed(1) : '0.0';
                const avgPayout = hits.length > 0 ? Math.round(totalPayout / hits.length) : 0;

                container.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div class="card" style="text-align: center;">
                            <div style="font-size: 32px; font-weight: 700; color: #3b82f6; margin-bottom: 8px;">${totalPredictions}</div>
                            <div style="color: #94a3b8;">ç·äºˆæƒ³æ•°</div>
                            <div style="font-size: 14px; color: #64748b; margin-top: 4px;">éå»30æ—¥é–“</div>
                        </div>
                        <div class="card" style="text-align: center;">
                            <div style="font-size: 32px; font-weight: 700; color: #10b981; margin-bottom: 8px;">${hits.length}</div>
                            <div style="color: #94a3b8;">çš„ä¸­æ•°</div>
                            <div style="font-size: 14px; color: #64748b; margin-top: 4px;">${withResults.length}ãƒ¬ãƒ¼ã‚¹ä¸­</div>
                        </div>
                        <div class="card" style="text-align: center;">
                            <div style="font-size: 32px; font-weight: 700; color: #f59e0b; margin-bottom: 8px;">${hitRate}%</div>
                            <div style="color: #94a3b8;">çš„ä¸­ç‡</div>
                            <div style="font-size: 14px; color: ${hitRate > 70 ? '#10b981' : hitRate > 50 ? '#f59e0b' : '#ef4444'}; margin-top: 4px;">
                                ${hitRate > 70 ? 'å„ªç§€' : hitRate > 50 ? 'è‰¯å¥½' : 'è¦æ”¹å–„'}
                            </div>
                        </div>
                        <div class="card" style="text-align: center;">
                            <div style="font-size: 32px; font-weight: 700; color: #8b5cf6; margin-bottom: 8px;">${totalPayout.toLocaleString()}å††</div>
                            <div style="color: #94a3b8;">ç·é…å½“</div>
                            <div style="font-size: 14px; color: #64748b; margin-top: 4px;">å¹³å‡${avgPayout.toLocaleString()}å††</div>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('çµ±è¨ˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                if (error.message && error.message.includes('404')) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 20px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px;">
                            <p style="color: #fca5a5; margin-bottom: 8px;">ğŸ“Š çµ±è¨ˆæƒ…å ±ã‚’è¡¨ç¤ºã§ãã¾ã›ã‚“</p>
                            <p style="color: #94a3b8; font-size: 14px;">Supabaseãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆå¾Œã«çµ±è¨ˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = `<div style="color: #fca5a5;">çµ±è¨ˆæƒ…å ±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}</div>`;
                }
            }
        }

        // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆæ‹¡å¼µç‰ˆï¼‰
        async function loadExistingPredictions() {
            const container = document.getElementById('predictions-container');
            
            try {
                const { data: predictions, error } = await supabase
                    .from('prediction_content')
                    .select(`
                        *,
                        prediction_results (*)
                    `)
                    .order('race_date', { ascending: false })
                    .order('race_track')
                    .order('race_number')
                    .limit(20);
                
                if (error) throw error;
                
                allPredictions = predictions || [];
                displayPredictions(allPredictions);
                
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                if (error.message && error.message.includes('404')) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px;">
                            <div style="font-size: 48px; margin-bottom: 16px;">âš ï¸</div>
                            <h3 style="color: #fca5a5; margin-bottom: 16px;">Supabaseãƒ†ãƒ¼ãƒ–ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</h3>
                            <p style="color: #94a3b8; margin-bottom: 20px; line-height: 1.6;">
                                äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ãŒä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚<br>
                                ä»¥ä¸‹ã®æ‰‹é †ã§ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š
                            </p>
                            <div style="background: rgba(0,0,0,0.3); padding: 16px; border-radius: 6px; text-align: left; margin: 20px 0;">
                                <p style="color: #e2e8f0; font-weight: 600; margin-bottom: 12px;">1. Supabaseãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ãƒ­ã‚°ã‚¤ãƒ³</p>
                                <p style="color: #e2e8f0; font-weight: 600; margin-bottom: 12px;">2. SQL Editorã‚’é–‹ã</p>
                                <p style="color: #e2e8f0; font-weight: 600; margin-bottom: 12px;">3. <code>/src/lib/supabase-schema-predictions.sql</code> ã®å†…å®¹ã‚’ã‚³ãƒ”ãƒšã—ã¦å®Ÿè¡Œ</p>
                                <p style="color: #e2e8f0; font-weight: 600;">4. ã“ã®ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰</p>
                            </div>
                            <p style="color: #64748b; font-size: 14px;">
                                ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆå¾Œã€ã™ã¹ã¦ã®äºˆæƒ³ç®¡ç†æ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
                            </p>
                        </div>
                    `;
                } else {
                    container.innerHTML = '<p style="color: #fca5a5;">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message + '</p>';
                }
            }
        }

        // äºˆæƒ³ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º
        function displayPredictions(predictions) {
            const container = document.getElementById('predictions-container');
            
            if (!predictions || predictions.length === 0) {
                container.innerHTML = '<p style="color: #94a3b8;">ã¾ã äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            container.innerHTML = predictions.map(p => {
                const hasResult = p.prediction_results && p.prediction_results.length > 0;
                const result = hasResult ? p.prediction_results[0] : null;
                const isHit = result?.hit_status === 'hit';
                const payout = result?.payout_amount || 0;
                
                return `
                    <div class="prediction-item" style="background: ${isHit ? 'rgba(16, 185, 129, 0.05)' : hasResult ? 'rgba(239, 68, 68, 0.05)' : 'rgba(30, 41, 59, 0.6)'}; border-color: ${isHit ? 'rgba(16, 185, 129, 0.3)' : hasResult ? 'rgba(239, 68, 68, 0.3)' : 'rgba(59, 130, 246, 0.2)'}">
                        <div class="prediction-info">
                            <div><strong>${p.race_date} ${p.race_track} ${p.race_number}R</strong> ${p.race_name || ''}</div>
                            <div class="prediction-meta">
                                ä¿¡é ¼åº¦: ${p.confidence_score || '-'}% | ã‚¿ã‚¤ãƒ—: ${p.content_type}
                                ${hasResult ? ` | çµæœ: ${isHit ? 'âœ…çš„ä¸­' : 'âŒä¸çš„ä¸­'}${payout > 0 ? ` (${payout.toLocaleString()}å††)` : ''}` : ''}
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            ${hasResult ? `
                                <span class="status-badge ${isHit ? 'status-published' : 'status-draft'}" style="${isHit ? 'background: rgba(16, 185, 129, 0.1); color: #86efac; border-color: rgba(16, 185, 129, 0.3);' : 'background: rgba(239, 68, 68, 0.1); color: #fca5a5; border-color: rgba(239, 68, 68, 0.3);'}">
                                    ${isHit ? 'çš„ä¸­' : 'ä¸çš„ä¸­'}
                                </span>
                            ` : ''}
                            <span class="status-badge ${p.is_published ? 'status-published' : 'status-draft'}">
                                ${p.is_published ? 'å…¬é–‹ä¸­' : 'ä¸‹æ›¸ã'}
                            </span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // äºˆæƒ³ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        window.filterPredictions = function() {
            const filter = document.getElementById('filter-status').value;
            let filtered = allPredictions;
            
            switch(filter) {
                case 'published':
                    filtered = allPredictions.filter(p => p.is_published);
                    break;
                case 'draft':
                    filtered = allPredictions.filter(p => !p.is_published);
                    break;
                case 'today':
                    const today = new Date().toISOString().split('T')[0];
                    filtered = allPredictions.filter(p => p.race_date === today);
                    break;
            }
            
            displayPredictions(filtered);
        }

        // ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯æ©Ÿèƒ½ç¾¤
        window.oneClickUpdate = async function() {
            const statusDiv = document.getElementById('oneclick-status');
            statusDiv.style.display = 'block';
            
            try {
                statusDiv.innerHTML = 'ğŸ”„ ã‚¹ãƒ†ãƒƒãƒ—1/3: çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°ä¸­...';
                await loadStatistics();
                await sleep(1000);
                
                statusDiv.innerHTML = 'ğŸ”„ ã‚¹ãƒ†ãƒƒãƒ—2/3: äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿ä¸­...';
                await loadExistingPredictions();
                await sleep(1000);
                
                statusDiv.innerHTML = 'âœ… æ›´æ–°å®Œäº†ï¼ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒæœ€æ–°çŠ¶æ…‹ã«ãªã‚Šã¾ã—ãŸã€‚';
                showAlert('ãƒ‡ãƒ¼ã‚¿ã®ä¸€æ‹¬æ›´æ–°ãŒå®Œäº†ã—ã¾ã—ãŸ', 'success');
                
            } catch (error) {
                statusDiv.innerHTML = `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`;
            }
        }

        window.oneClickBackup = async function() {
            const statusDiv = document.getElementById('oneclick-status');
            statusDiv.style.display = 'block';
            
            try {
                statusDiv.innerHTML = 'ğŸ”„ å…¨äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆä¸­...';
                
                const { data: allData, error } = await supabase
                    .from('prediction_content')
                    .select(`
                        *,
                        prediction_results (*)
                    `)
                    .order('race_date', { ascending: false });
                
                if (error) throw error;
                
                const backup = {
                    exportDate: new Date().toISOString(),
                    totalRecords: allData.length,
                    data: allData
                };
                
                const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `nankan-predictions-backup-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                statusDiv.innerHTML = 'âœ… ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Œäº†ï¼ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸã€‚';
                showAlert('ãƒ‡ãƒ¼ã‚¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸ', 'success');
                
            } catch (error) {
                statusDiv.innerHTML = `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                showAlert('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        window.oneClickDeploy = async function() {
            const statusDiv = document.getElementById('oneclick-status');
            statusDiv.style.display = 'block';
            
            statusDiv.innerHTML = 'ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤æ©Ÿèƒ½ã¯é–‹ç™ºä¸­ã§ã™ã€‚ç¾åœ¨ã¯æ‰‹å‹•ã§commit/pushã‚’è¡Œã£ã¦ãã ã•ã„ã€‚';
        }

        // ==============================================
        // AIäºˆæƒ³JSONãƒ‡ãƒ¼ã‚¿ç”Ÿæˆæ©Ÿèƒ½
        // ==============================================

        // AIäºˆæƒ³JSONãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
        window.generateAIPrediction = function() {
            try {
                console.log('AIäºˆæƒ³JSONãƒ‡ãƒ¼ã‚¿ç”Ÿæˆé–‹å§‹');

                // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿åé›†
                const formData = collectFormData();
                
                // ç‰¹å¾´é‡é‡è¦åº¦ãƒ‡ãƒ¼ã‚¿åé›†
                const mainFeatures = {
                    feature1: {
                        name: document.getElementById('mainFeature1Label')?.value || 'å®‰å®šæ€§',
                        value: parseFloat(document.getElementById('mainFeature1Val')?.value || '0.95')
                    },
                    feature2: {
                        name: document.getElementById('mainFeature2Label')?.value || 'èƒ½åŠ›ä¸Šä½æ€§',
                        value: parseFloat(document.getElementById('mainFeature2Val')?.value || '0.88')
                    },
                    feature3: {
                        name: document.getElementById('mainFeature3Label')?.value || 'å±•é–‹åˆ©',
                        value: parseFloat(document.getElementById('mainFeature3Val')?.value || '0.82')
                    }
                };

                const subFeatures = {
                    feature1: {
                        name: document.getElementById('subFeature1Label')?.value || 'å…ˆè¡ŒåŠ›',
                        value: parseFloat(document.getElementById('subFeature1Val')?.value || '0.89')
                    },
                    feature2: {
                        name: document.getElementById('subFeature2Label')?.value || 'ãƒ ãƒ©ä¿‚æ•°',
                        value: parseFloat(document.getElementById('subFeature2Val')?.value || '0.76')
                    },
                    feature3: {
                        name: document.getElementById('subFeature3Label')?.value || 'å±•é–‹æ¬¡ç¬¬',
                        value: parseFloat(document.getElementById('subFeature3Val')?.value || '0.71')
                    }
                };

                // JSONãƒ‡ãƒ¼ã‚¿æ§‹ç¯‰
                const aiPredictionData = {
                    raceInfo: {
                        title: `${formData.race_track}${formData.race_number}R ${formData.race_name}`,
                        date: formData.race_date,
                        track: formData.race_track,
                        raceNumber: formData.race_number,
                        raceName: formData.race_name,
                        distance: formData.race_distance,
                        type: formData.race_type,
                        confidence: formData.confidence_score || 85.0
                    },
                    horses: {
                        main: {
                            number: formData.prediction_data.horses[0]?.number || 8,
                            name: formData.prediction_data.horses[0]?.name || "æœ¬å‘½é¦¬",
                            mark: "â—",
                            confidence: "92.5",
                            features: mainFeatures
                        },
                        sub: {
                            number: formData.prediction_data.horses[1]?.number || 1,
                            name: formData.prediction_data.horses[1]?.name || "å¯¾æŠ—é¦¬",
                            mark: "â—‹",
                            confidence: "86.3",
                            features: subFeatures
                        },
                        dark: {
                            number: formData.prediction_data.horses[2]?.number || 5,
                            name: formData.prediction_data.horses[2]?.name || "ç©´é¦¬",
                            mark: "â–²",
                            confidence: "78.1",
                            features: {}
                        }
                    },
                    strategies: formData.prediction_data.strategies || {
                        safe: { hitRate: "78.5%", returnRate: "132%" },
                        balance: { hitRate: "65.2%", returnRate: "188%" },
                        aggressive: { hitRate: "42.1%", returnRate: "312%" }
                    },
                    content_type: formData.content_type,
                    is_published: formData.is_published,
                    lastUpdated: new Date().toISOString()
                };

                // JSONè¡¨ç¤º
                const jsonOutput = document.getElementById('jsonOutput');
                jsonOutput.textContent = JSON.stringify(aiPredictionData, null, 2);

                // èª¬æ˜æ–‡æ›´æ–°
                const outputDescription = document.getElementById('outputDescription');
                outputDescription.innerHTML = 'ä¸‹è¨˜ã®JSONã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ <code>src/data/aiPrediction.json</code> ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚<br>ã“ã‚Œã«ã‚ˆã‚Š<strong>premium-predictions/</strong>ãƒšãƒ¼ã‚¸ãŒè‡ªå‹•æ›´æ–°ã•ã‚Œã¾ã™ã€‚';

                // AIäºˆæƒ³JSONã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                const aiCopyBtn = document.getElementById('aiCopyBtn');
                if (aiCopyBtn) {
                    aiCopyBtn.style.display = 'block';
                }

                showAlert('âœ… AIäºˆæƒ³JSONãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¾ã—ãŸï¼\n\nç‰¹å¾´é‡é‡è¦åº¦ã‚‚å«ã‚ã¦ç”Ÿæˆã•ã‚Œã¦ã„ã¾ã™ã€‚', 'success');

            } catch (error) {
                console.error('AIäºˆæƒ³JSONç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
                showAlert('âŒ JSONç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
            }
        };

        // ==============================================
        // ç‰¹å¾´é‡é‡è¦åº¦ãƒãƒ¼ç·¨é›†æ©Ÿèƒ½ï¼ˆ/admin/ã¨åŒã˜å½¢å¼ï¼‰
        // ==============================================
        
        // ç‰¹å¾´é‡é‡è¦åº¦ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®é€£å‹•æ©Ÿèƒ½
        function setupFeatureSliders() {
            // æœ¬å‘½é¦¬ã®ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼
            ['mainFeature1', 'mainFeature2', 'mainFeature3'].forEach(id => {
                const slider = document.getElementById(id);
                const numberInput = document.getElementById(id + 'Val');
                const previewBar = slider.parentElement.parentElement.querySelector('.preview-bar-fill');
                
                if (slider && numberInput && previewBar) {
                    // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®å¤‰æ›´æ™‚
                    slider.addEventListener('input', function() {
                        const value = this.value;
                        const decimalValue = (value / 100).toFixed(2);
                        numberInput.value = decimalValue;
                        previewBar.style.width = value + '%';
                        previewBar.textContent = decimalValue;
                    });
                    
                    // æ•°å€¤å…¥åŠ›ã®å¤‰æ›´æ™‚
                    numberInput.addEventListener('input', function() {
                        const decimalValue = parseFloat(this.value);
                        if (decimalValue >= 0 && decimalValue <= 1) {
                            const percentage = Math.round(decimalValue * 100);
                            slider.value = percentage;
                            previewBar.style.width = percentage + '%';
                            previewBar.textContent = this.value;
                        }
                    });
                }
            });

            // å¯¾æŠ—é¦¬ã®ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼
            ['subFeature1', 'subFeature2', 'subFeature3'].forEach(id => {
                const slider = document.getElementById(id);
                const numberInput = document.getElementById(id + 'Val');
                const previewBar = slider.parentElement.parentElement.querySelector('.preview-bar-fill');
                
                if (slider && numberInput && previewBar) {
                    // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®å¤‰æ›´æ™‚
                    slider.addEventListener('input', function() {
                        const value = this.value;
                        const decimalValue = (value / 100).toFixed(2);
                        numberInput.value = decimalValue;
                        previewBar.style.width = value + '%';
                        previewBar.textContent = decimalValue;
                    });
                    
                    // æ•°å€¤å…¥åŠ›ã®å¤‰æ›´æ™‚
                    numberInput.addEventListener('input', function() {
                        const decimalValue = parseFloat(this.value);
                        if (decimalValue >= 0 && decimalValue <= 1) {
                            const percentage = Math.round(decimalValue * 100);
                            slider.value = percentage;
                            previewBar.style.width = percentage + '%';
                            previewBar.textContent = this.value;
                        }
                    });
                }
            });
        }

        // ==============================================
        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠæ©Ÿèƒ½
        // ==============================================
        const templates = {
            daily_nankan: {
                name: 'å—é–¢æ±äº¬ãƒ»å·å´ãƒ»èˆ¹æ©‹ãƒ»æµ¦å’Œï¼ˆæ—¥å¸¸ï¼‰',
                race_distance: 1600,
                race_type: 'ãƒ€ãƒ¼ãƒˆ',
                confidence_score: 75,
                content_type: 'standard'
            },
            big_race: {
                name: 'é‡è³ãƒ»ç‰¹åˆ¥ãƒ¬ãƒ¼ã‚¹',
                race_distance: 1800,
                race_type: 'ãƒ€ãƒ¼ãƒˆ',
                confidence_score: 88,
                content_type: 'premium'
            },
            newcomer: {
                name: 'æ–°é¦¬ãƒ»æœªå‹åˆ©æˆ¦',
                race_distance: 1400,
                race_type: 'ãƒ€ãƒ¼ãƒˆ',
                confidence_score: 65,
                content_type: 'free'
            },
            handicap: {
                name: 'ãƒãƒ³ãƒ‡æˆ¦',
                race_distance: 2100,
                race_type: 'ãƒ€ãƒ¼ãƒˆ',
                confidence_score: 70,
                content_type: 'standard'
            },
            dirt_sprint: {
                name: 'ãƒ€ãƒ¼ãƒˆçŸ­è·é›¢',
                race_distance: 1200,
                race_type: 'ãƒ€ãƒ¼ãƒˆ',
                confidence_score: 80,
                content_type: 'standard'
            },
            dirt_mile: {
                name: 'ãƒ€ãƒ¼ãƒˆãƒã‚¤ãƒ«',
                race_distance: 1600,
                race_type: 'ãƒ€ãƒ¼ãƒˆ',
                confidence_score: 82,
                content_type: 'premium'
            },
            dirt_distance: {
                name: 'ãƒ€ãƒ¼ãƒˆä¸­é•·è·é›¢',
                race_distance: 2400,
                race_type: 'ãƒ€ãƒ¼ãƒˆ',
                confidence_score: 75,
                content_type: 'standard'
            }
        };

        window.applyTemplate = function() {
            const selector = document.getElementById('template_selector');
            const templateKey = selector.value;
            
            if (!templateKey) return;
            
            const template = templates[templateKey];
            if (!template) return;

            // ãƒ•ã‚©ãƒ¼ãƒ ã«å€¤ã‚’è¨­å®š
            if (template.race_distance) document.getElementById('race_distance').value = template.race_distance;
            if (template.race_type) document.getElementById('race_type').value = template.race_type;
            if (template.confidence_score) document.getElementById('confidence_score').value = template.confidence_score;
            if (template.content_type) document.getElementById('content_type').value = template.content_type;

            showAlert(`ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€Œ${template.name}ã€ã‚’é©ç”¨ã—ã¾ã—ãŸ`, 'success');
        };

        window.saveAsTemplate = function() {
            const templateName = prompt('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
            if (!templateName) return;

            const currentSettings = {
                name: templateName,
                race_distance: document.getElementById('race_distance').value,
                race_type: document.getElementById('race_type').value,
                confidence_score: document.getElementById('confidence_score').value,
                content_type: document.getElementById('content_type').value
            };

            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
            const customTemplates = JSON.parse(localStorage.getItem('customTemplates') || '{}');
            customTemplates[templateName] = currentSettings;
            localStorage.setItem('customTemplates', JSON.stringify(customTemplates));

            showAlert(`ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€Œ${templateName}ã€ã‚’ä¿å­˜ã—ã¾ã—ãŸ`, 'success');
        };

        window.managementTemplates = function() {
            alert('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†æ©Ÿèƒ½ã¯æ¬¡å›ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã§æä¾›äºˆå®šã§ã™ã€‚');
        };

        // ==============================================
        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½
        // ==============================================
        let previewActive = false;

        window.togglePreview = function() {
            const preview = document.getElementById('realtime-preview');
            const toggleText = document.getElementById('preview-toggle-text');

            if (!previewActive) {
                preview.style.display = 'block';
                toggleText.textContent = 'ğŸ‘ï¸ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼åœæ­¢';
                previewActive = true;
                refreshPreview();
                
                // è‡ªå‹•æ›´æ–°é–‹å§‹
                window.previewInterval = setInterval(refreshPreview, 3000);
            } else {
                preview.style.display = 'none';
                toggleText.textContent = 'ğŸ” ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼é–‹å§‹';
                previewActive = false;
                
                // è‡ªå‹•æ›´æ–°åœæ­¢
                clearInterval(window.previewInterval);
            }
        };

        window.refreshPreview = function() {
            if (!previewActive) return;

            const previewContent = document.getElementById('preview-content');
            const data = collectFormData();

            const previewHtml = `
                <div style="border-bottom: 1px solid rgba(71, 85, 105, 0.5); padding-bottom: 15px; margin-bottom: 15px;">
                    <h3 style="color: #3b82f6; margin: 0 0 10px 0;">${data.race_date} ${data.race_track}${data.race_number}R</h3>
                    <p style="color: #e2e8f0; margin: 0;">${data.race_name || 'ãƒ¬ãƒ¼ã‚¹åæœªè¨­å®š'} ${data.race_distance}m (${data.race_type})</p>
                    <div style="margin-top: 8px; color: #10b981;">ä¿¡é ¼åº¦: ${data.confidence_score || 0}%</div>
                </div>
                <div style="margin-bottom: 15px;">
                    <h4 style="color: #f59e0b; margin: 0 0 10px 0;">äºˆæƒ³é¦¬</h4>
                    ${data.prediction_data.horses.length > 0 ? 
                        data.prediction_data.horses.map(horse => 
                            `<div style="margin: 5px 0; color: #e2e8f0;">${horse.mark} ${horse.number}ç•ª ${horse.name}</div>`
                        ).join('') : 
                        '<div style="color: #94a3b8;">äºˆæƒ³é¦¬ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</div>'
                    }
                </div>
                <div style="font-size: 12px; color: #64748b; text-align: center; padding-top: 10px; border-top: 1px solid rgba(71, 85, 105, 0.5);">
                    æœ€çµ‚æ›´æ–°: ${new Date().toLocaleTimeString()}
                </div>
            `;

            previewContent.innerHTML = previewHtml;
        };

        // ==============================================
        // GitåŒæœŸã‚·ã‚¹ãƒ†ãƒ 
        // ==============================================
        window.checkGitStatus = async function() {
            const statusDiv = document.getElementById('git-status');
            const logDiv = document.getElementById('git-log');

            try {
                statusDiv.innerHTML = '<p style="color: #f59e0b; margin: 0;">ğŸ” GitçŠ¶æ…‹ã‚’ç¢ºèªä¸­...</p>';

                // å®Ÿéš›ã®Gitã‚³ãƒãƒ³ãƒ‰ã®ä»£æ›¿ã¨ã—ã¦ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
                await new Promise(resolve => setTimeout(resolve, 1000));

                const mockStatus = `
                    <div style="color: #10b981;">âœ… ãƒªãƒã‚¸ãƒˆãƒª: nankan-analytics/astro-site</div>
                    <div style="color: #e2e8f0; margin-top: 5px;">ğŸ“Š ãƒ–ãƒ©ãƒ³ãƒ: main (origin/mainã¨åŒæœŸæ¸ˆã¿)</div>
                    <div style="color: #f59e0b; margin-top: 5px;">ğŸ“ å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«: 2å€‹ (src/pages/admin/predictions.astro ãªã©)</div>
                `;

                statusDiv.innerHTML = mockStatus;
                logDiv.style.display = 'block';
                logDiv.innerHTML = `
                    $ git status<br>
                    On branch main<br>
                    Your branch is up to date with 'origin/main'.<br><br>
                    Changes not staged for commit:<br>
                    &nbsp;&nbsp;modified: src/pages/admin/predictions.astro<br>
                    &nbsp;&nbsp;modified: src/data/raceResults.json
                `;

            } catch (error) {
                statusDiv.innerHTML = `<p style="color: #ef4444; margin: 0;">âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
            }
        };

        window.commitChanges = async function() {
            const message = document.getElementById('commit-message').value || 'ç®¡ç†ãƒ‘ãƒãƒ«ã‹ã‚‰äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°';
            const statusDiv = document.getElementById('git-status');
            const logDiv = document.getElementById('git-log');

            try {
                statusDiv.innerHTML = '<p style="color: #f59e0b; margin: 0;">ğŸ’¾ å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆä¸­...</p>';
                await new Promise(resolve => setTimeout(resolve, 1500));

                statusDiv.innerHTML = '<p style="color: #10b981; margin: 0;">âœ… ã‚³ãƒŸãƒƒãƒˆå®Œäº†</p>';
                logDiv.innerHTML += `<br><br>$ git add .<br>$ git commit -m "${message}"<br>[main ${Math.random().toString(36).substr(2, 7)}] ${message}<br> 2 files changed, 15 insertions(+), 3 deletions(-)`;

                showAlert('å¤‰æ›´ãŒã‚³ãƒŸãƒƒãƒˆã•ã‚Œã¾ã—ãŸ', 'success');

            } catch (error) {
                statusDiv.innerHTML = `<p style="color: #ef4444; margin: 0;">âŒ ã‚³ãƒŸãƒƒãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
            }
        };

        window.pushToRemote = async function() {
            const statusDiv = document.getElementById('git-status');
            const logDiv = document.getElementById('git-log');

            try {
                statusDiv.innerHTML = '<p style="color: #f59e0b; margin: 0;">â¬†ï¸ ãƒªãƒ¢ãƒ¼ãƒˆã«ãƒ—ãƒƒã‚·ãƒ¥ä¸­...</p>';
                await new Promise(resolve => setTimeout(resolve, 2000));

                statusDiv.innerHTML = '<p style="color: #10b981; margin: 0;">âœ… ãƒ—ãƒƒã‚·ãƒ¥å®Œäº†</p>';
                logDiv.innerHTML += `<br><br>$ git push origin main<br>Enumerating objects: 5, done.<br>Counting objects: 100% (5/5), done.<br>Writing objects: 100% (3/3), 892 bytes | 892.00 KiB/s, done.<br>Total 3 (delta 1), reused 0 (delta 0)<br>To github.com:your-repo/nankan-analytics.git<br>&nbsp;&nbsp;abc123..def456&nbsp;&nbsp;main -> main`;

                showAlert('ãƒªãƒ¢ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã«ãƒ—ãƒƒã‚·ãƒ¥ã•ã‚Œã¾ã—ãŸ', 'success');

            } catch (error) {
                statusDiv.innerHTML = `<p style="color: #ef4444; margin: 0;">âŒ ãƒ—ãƒƒã‚·ãƒ¥ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
            }
        };

        window.autoSync = async function() {
            const statusDiv = document.getElementById('git-status');

            try {
                statusDiv.innerHTML = '<p style="color: #f59e0b; margin: 0;">âš¡ è‡ªå‹•åŒæœŸä¸­...</p>';
                
                await checkGitStatus();
                await new Promise(resolve => setTimeout(resolve, 1000));
                await commitChanges();
                await new Promise(resolve => setTimeout(resolve, 1000));
                await pushToRemote();

                statusDiv.innerHTML = '<p style="color: #10b981; margin: 0;">âœ… è‡ªå‹•åŒæœŸå®Œäº†</p>';
                showAlert('Gitè‡ªå‹•åŒæœŸãŒå®Œäº†ã—ã¾ã—ãŸ', 'success');

            } catch (error) {
                statusDiv.innerHTML = `<p style="color: #ef4444; margin: 0;">âŒ è‡ªå‹•åŒæœŸã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
            }
        };

        // ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½
        window.copyJsonData = function() {
            const jsonText = document.getElementById('jsonOutput').textContent;
            if (jsonText && jsonText !== 'ã“ã“ã«JSONãŒç”Ÿæˆã•ã‚Œã¾ã™...') {
                navigator.clipboard.writeText(jsonText).then(() => {
                    const copyBtn = document.getElementById('copyBtn');
                    const originalText = copyBtn.textContent;
                    copyBtn.textContent = 'âœ… ã‚³ãƒ”ãƒ¼å®Œäº†!';
                    setTimeout(() => {
                        copyBtn.textContent = originalText;
                    }, 2000);
                    showAlert('JSONãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'success');
                }).catch(err => {
                    console.error('ã‚³ãƒ”ãƒ¼å¤±æ•—:', err);
                    showAlert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚', 'error');
                });
            } else {
                showAlert('ã‚³ãƒ”ãƒ¼ã§ãã‚‹JSONãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«JSONã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚', 'error');
            }
        };

        // AIäºˆæƒ³JSONã‚³ãƒ”ãƒ¼æ©Ÿèƒ½
        window.copyAIPredictionJson = function() {
            const jsonText = document.getElementById('jsonOutput').textContent;
            if (jsonText && jsonText !== 'ã“ã“ã«JSONãŒç”Ÿæˆã•ã‚Œã¾ã™...') {
                navigator.clipboard.writeText(jsonText).then(() => {
                    const aiCopyBtn = document.getElementById('aiCopyBtn');
                    const originalText = aiCopyBtn.textContent;
                    aiCopyBtn.textContent = 'âœ… AIäºˆæƒ³ã‚³ãƒ”ãƒ¼å®Œäº†!';
                    setTimeout(() => {
                        aiCopyBtn.textContent = originalText;
                    }, 2000);
                    showAlert('AIäºˆæƒ³JSONãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'success');
                }).catch(err => {
                    console.error('ã‚³ãƒ”ãƒ¼å¤±æ•—:', err);
                    showAlert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚', 'error');
                });
            } else {
                showAlert('ã‚³ãƒ”ãƒ¼ã§ãã‚‹JSONãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«AIäºˆæƒ³JSONã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚', 'error');
            }
        };

        // JSONã‚¯ãƒªã‚¢æ©Ÿèƒ½
        window.clearJsonOutput = function() {
            document.getElementById('jsonOutput').textContent = 'ã“ã“ã«JSONãŒç”Ÿæˆã•ã‚Œã¾ã™...';
            document.getElementById('aiCopyBtn').style.display = 'none';
            document.getElementById('outputDescription').innerHTML = 'ä¸‹è¨˜ã®JSONã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ <code>src/data/aiPrediction.json</code> ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„';
            showAlert('JSONå‡ºåŠ›ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'success');
        };

        // ãƒ†ã‚¹ãƒˆæ©Ÿèƒ½
        window.testFeaturesBars = function() {
            showAlert('ğŸ§ª ãƒ†ã‚¹ãƒˆæ©Ÿèƒ½: ç‰¹å¾´é‡é‡è¦åº¦ãƒãƒ¼ã®å‹•ä½œã‚’ç¢ºèªä¸­...', 'success');
            console.log('ç‰¹å¾´é‡é‡è¦åº¦ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ');
            
            // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã§ãƒãƒ¼ã‚’ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            const testValues = [95, 88, 82, 89, 76, 71];
            const sliders = ['mainFeature1', 'mainFeature2', 'mainFeature3', 'subFeature1', 'subFeature2', 'subFeature3'];
            
            sliders.forEach((sliderId, index) => {
                setTimeout(() => {
                    const slider = document.getElementById(sliderId);
                    if (slider) {
                        slider.value = testValues[index] + Math.floor(Math.random() * 10 - 5);
                        slider.dispatchEvent(new Event('input'));
                    }
                }, index * 200);
            });
        };

        // ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        function setupJsonButtons() {
            // AIäºˆæƒ³JSONãƒ‡ãƒ¼ã‚¿ç”Ÿæˆãƒœã‚¿ãƒ³
            const generateBtn = document.getElementById('generateAIPredictionBtn');
            if (generateBtn) {
                generateBtn.addEventListener('click', generateAIPrediction);
            }

            // ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³
            const testBtn = document.getElementById('testFeaturesBtn');
            if (testBtn) {
                testBtn.addEventListener('click', testFeaturesBars);
            }

            // ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³
            const copyBtn = document.getElementById('copyBtn');
            if (copyBtn) {
                copyBtn.addEventListener('click', copyJsonData);
            }

            // AIäºˆæƒ³JSONã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³
            const aiCopyBtn = document.getElementById('aiCopyBtn');
            if (aiCopyBtn) {
                aiCopyBtn.addEventListener('click', copyAIPredictionJson);
            }

            // JSONã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³
            const clearBtn = document.getElementById('clearJsonBtn');
            if (clearBtn) {
                clearBtn.addEventListener('click', clearJsonOutput);
            }
        }

        // åˆæœŸåŒ–æ™‚ã«GitçŠ¶æ…‹ç¢ºèª
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(checkGitStatus, 2000);
            
            // JSONãƒœã‚¿ãƒ³è¨­å®š
            setupJsonButtons();
        });

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>
</body>
</html>