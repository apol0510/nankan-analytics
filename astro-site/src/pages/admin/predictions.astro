---
export const prerender = true;// ç°¡ç•¥åŒ–ã•ã‚ŒãŸç®¡ç†è€…ç”¨äºˆæƒ³å…¥åŠ›ãƒšãƒ¼ã‚¸
import { getRaceTier, isMainRace, getRaceDisplayName, getMainRaceNumber } from '../../lib/race-config.js';
import { validateAllRacesPrediction, autoFixData, getValidationSummary } from '../../lib/data-validator.js';
import { convertToStarRating } from '../../lib/shared-prediction-logic.js';
---

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨ãƒ¬ãƒ¼ã‚¹äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ç®¡ç† | NANKANã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ç®¡ç†ç”»é¢</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e2e8f0;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .header {
            background: rgba(30, 41, 59, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .page-title {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-links {
            display: flex;
            gap: 16px;
        }

        .nav-link {
            color: #94a3b8;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .nav-link:hover {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
        }

        .form-section {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            color: #f1f5f9;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(107, 114, 128, 0.3);
        }

        .alert {
            padding: 16px 20px;
            border-radius: 8px;
            margin: 16px 0;
            font-weight: 500;
            display: none;
        }

        .alert.success {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(5, 150, 105, 0.2) 100%);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: #10b981;
        }

        .alert.error {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, rgba(220, 38, 38, 0.2) 100%);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }

        .feature-importance-controls {
            background: rgba(15, 23, 42, 0.5);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .slider {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: rgba(71, 85, 105, 0.5);
            outline: none;
            cursor: pointer;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            cursor: pointer;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-weight: 600;
            color: #f1f5f9;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 8px;
            background: rgba(30, 41, 59, 0.5);
            color: #e2e8f0;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }


        .race-card {
            background: rgba(15, 23, 42, 0.7);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .race-card:hover {
            border-color: rgba(59, 130, 246, 0.5);
            background: rgba(30, 41, 59, 0.7);
        }

        .race-status {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-complete {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .status-incomplete {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }

        .status-empty {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        #loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #94a3b8;
        }

        .operation-log {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 8px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            color: #94a3b8;
        }

        /* ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideOut {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-10px);
            }
        }

        .alert {
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .alert.error {
            border-left: 4px solid #ef4444;
        }

        .alert.success {
            border-left: 4px solid #10b981;
        }

        .alert.warning {
            border-left: 4px solid #f59e0b;
        }

        .alert.info {
            border-left: 4px solid #3b82f6;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="page-title">ğŸ‡ å…¨ãƒ¬ãƒ¼ã‚¹äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h1>
            <div class="nav-links">
                <a href="/" class="nav-link">ğŸ  ãƒ›ãƒ¼ãƒ </a>
                <a href="/admin" class="nav-link">âš™ï¸ ç®¡ç†ç”»é¢</a>
            </div>
        </div>

        <div id="alert" class="alert"></div>

        <!-- å¤–éƒ¨äºˆæƒ³ â†’ AIäºˆæƒ³å¤‰æ›ï¼ˆ1ã€œ12ãƒ¬ãƒ¼ã‚¹ä¸€æ‹¬å‡¦ç†ï¼‰ -->
        <div class="form-section" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(59, 130, 246, 0.1) 100%); border: 2px solid rgba(16, 185, 129, 0.3);">
            <h2 class="section-title">âš¡ å¤–éƒ¨äºˆæƒ³ â†’ AIäºˆæƒ³å¤‰æ›ï¼ˆ1ã€œ12ãƒ¬ãƒ¼ã‚¹ä¸€æ‹¬å‡¦ç†ï¼‰</h2>
            <p style="color: #94a3b8; margin-bottom: 16px;">
                1ã€œ12ãƒ¬ãƒ¼ã‚¹å…¨ã¦ã®å¤–éƒ¨äºˆæƒ³ã‚’ä¸€åº¦ã«è²¼ã‚Šä»˜ã‘ã‚‹ã¨ã€å…¨ãƒ¬ãƒ¼ã‚¹åˆ†ã®AIäºˆæƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ‹¬ç”Ÿæˆã—ã¾ã™ã€‚<br>
                allRacesPrediction.jsonå½¢å¼ã§å‡ºåŠ›ã•ã‚Œã‚‹ã®ã§ã€ãã®ã¾ã¾ç½®ãæ›ãˆå¯èƒ½ã§ã™ã€‚
            </p>
            
            <div class="form-group">
                <label class="form-label">å…¨ãƒ¬ãƒ¼ã‚¹äºˆæƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’è²¼ã‚Šä»˜ã‘ï¼ˆ1Rã€œ12Rï¼‰</label>
                <textarea id="external_prediction" class="form-textarea" rows="20" 
                    placeholder="ä»¥ä¸‹ã®å½¢å¼ã§1Rã€œ12Rå…¨ãƒ¬ãƒ¼ã‚¹ã‚’ä¸€åº¦ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„:

ã€æ–°å½¢å¼ã€‘å¤šé‡å°å¯¾å¿œï¼ˆæ¨å¥¨ï¼‰:
8/26å·å´1R 1400mï¼ˆ11é ­ï¼‰ç™ºèµ°æ™‚åˆ»14:45 2æ­³æ–°é¦¬
1ç•ª â–³ â–³ â— â–³ ãƒ“ãƒªãƒ¼ãƒ´ã‚¤ãƒ³ãƒŸãƒ¼
2ç•ª â—‹ â–² â–³ ã‚¿ã‚¤ãƒ ãƒ•ãƒ¬ãƒ¼ãƒ 
3ç•ª â— â—‹ â—‹ ã‚»ãƒ¬ãƒ³ãƒ‡ã‚£ãƒ”ãƒ†ã‚£

8/26å·å´2R 1200mï¼ˆ10é ­ï¼‰ç™ºèµ°æ™‚åˆ»15:20 3æ­³æœªå‹åˆ©
5ç•ª â— â—‹ â–² ãƒ–ãƒ©ã‚¤ãƒˆã‚¹ã‚¿ãƒ¼
3ç•ª â—‹ â–³ ãƒãƒ¼ãƒ–ãƒ«ãƒ‘ãƒ¯ãƒ¼
1ç•ª â–² â—‹ ã‚¢ãƒ¼ãƒªãƒ¼ãƒãƒ¼ãƒ‰

ã€æ—§å½¢å¼ã€‘å˜ä¸€å°ï¼ˆç¶™ç¶šã‚µãƒãƒ¼ãƒˆï¼‰:
8/26å·å´1R 1400mï¼ˆ11é ­ï¼‰ç™ºèµ°æ™‚åˆ»14:45 2æ­³æ–°é¦¬
â—8ã‚­ãƒãƒ§ã‚¦
â—‹6ãƒã‚¤ãƒœãƒ³ãƒ‰
â–²2ãƒˆã‚¥ãƒ«ãƒ¼ãƒ“ãƒ¥ãƒ¼ãƒ†ã‚£

...ï¼ˆ5Rã€œ12R ã¾ã§åŒæ§˜ã«ç¶šã‘ã‚‹ï¼‰

ã€é‡è¦ã€‘
ãƒ»æ–°å½¢å¼: é¦¬ç•ª å°1 å°2 å°3... é¦¬åï¼ˆã‚¹ã‚³ã‚¢è‡ªå‹•è¨ˆç®—ãƒ»å½¹å‰²è‡ªå‹•å‰²ã‚Šå½“ã¦ï¼‰
ãƒ»å„ãƒ¬ãƒ¼ã‚¹è¡Œ: æœˆ/æ—¥ï¼‹ç«¶é¦¬å ´åï¼‹ãƒ¬ãƒ¼ã‚¹ç•ªå·ï¼‹è·é›¢ï¼‹é ­æ•°ï¼‹ç™ºèµ°æ™‚åˆ»ï¼‹ãƒ¬ãƒ¼ã‚¹å
ãƒ»å°ã®ç‚¹æ•°: â—+7, â—‹+6, â–²+5, â–³+4, Ã—+0ï¼ˆãƒ™ãƒ¼ã‚¹62ptï¼‰"></textarea>
            </div>
            
            <div style="display: flex; gap: 12px; margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="convertAllRaces()">ğŸ¤– å…¨ãƒ¬ãƒ¼ã‚¹ä¸€æ‹¬å¤‰æ›ãƒ»JSONç”Ÿæˆ</button>
                <button class="btn btn-secondary" onclick="clearConversion()">ã‚¯ãƒªã‚¢</button>
            </div>

            <!-- å‡¦ç†çŠ¶æ³è¡¨ç¤º -->
            <div id="conversion-progress" style="background: rgba(15, 23, 42, 0.8); padding: 15px; border-radius: 8px; display: none; font-family: monospace; font-size: 12px; color: #94a3b8; max-height: 150px; overflow-y: auto;">
                <!-- å‡¦ç†ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã‚‹ -->
            </div>
        </div>


        <!-- [DELETED] ä¸è¦ãªã‚»ã‚¯ã‚·ãƒ§ãƒ³å‰Šé™¤æ¸ˆã¿ -->

        <!-- ç‰¹å¾´é‡é‡è¦åº¦ãƒãƒ¼ç·¨é›† -->
        <div class="form-section" style="background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.2);">
            <h2 class="section-title">ğŸ“Š ç‰¹å¾´é‡é‡è¦åº¦ãƒãƒ¼ç·¨é›†</h2>
            <p style="color: #94a3b8; margin-bottom: 20px; font-size: 0.9rem;">
                â—å°ã¨â—‹å°ã®ç‰¹å¾´é‡é‡è¦åº¦ã‚’å€‹åˆ¥è¨­å®šã€‚ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ç¢ºèªã—ãªãŒã‚‰èª¿æ•´å¯èƒ½ã€‚
            </p>
            
            <!-- â—å°ï¼ˆæœ¬å‘½ï¼‰ã®ç‰¹å¾´é‡é‡è¦åº¦ -->
            <div class="feature-importance-controls" style="background: rgba(16, 185, 129, 0.1);">
                <h4 style="color: #10b981; margin-bottom: 15px;">â— æœ¬å‘½é¦¬ã®ç‰¹å¾´é‡é‡è¦åº¦</h4>
                <div class="slider-container">
                    <label style="min-width: 80px; font-size: 0.9rem;">ç‰¹å¾´é‡1:</label>
                    <input type="text" id="mainFeature1Label" value="å®‰å®šæ€§" placeholder="ç‰¹å¾´é‡å" style="width: 120px; padding: 5px 8px; font-size: 0.8rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.2); border-radius: 4px; color: white;">
                    <input type="range" id="mainFeature1" class="slider" min="0" max="1" step="0.01" value="0.95" onchange="updateImportanceBars()">
                    <span id="mainFeature1Value" style="min-width: 40px; font-size: 0.9rem;">95%</span>
                </div>
                <div class="slider-container">
                    <label style="min-width: 80px; font-size: 0.9rem;">ç‰¹å¾´é‡2:</label>
                    <input type="text" id="mainFeature2Label" value="èƒ½åŠ›ä¸Šä½æ€§" placeholder="ç‰¹å¾´é‡å" style="width: 120px; padding: 5px 8px; font-size: 0.8rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.2); border-radius: 4px; color: white;">
                    <input type="range" id="mainFeature2" class="slider" min="0" max="1" step="0.01" value="0.88" onchange="updateImportanceBars()">
                    <span id="mainFeature2Value" style="min-width: 40px; font-size: 0.9rem;">88%</span>
                </div>
                <div class="slider-container">
                    <label style="min-width: 80px; font-size: 0.9rem;">ç‰¹å¾´é‡3:</label>
                    <input type="text" id="mainFeature3Label" value="å±•é–‹åˆ©" placeholder="ç‰¹å¾´é‡å" style="width: 120px; padding: 5px 8px; font-size: 0.8rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.2); border-radius: 4px; color: white;">
                    <input type="range" id="mainFeature3" class="slider" min="0" max="1" step="0.01" value="0.82" onchange="updateImportanceBars()">
                    <span id="mainFeature3Value" style="min-width: 40px; font-size: 0.9rem;">82%</span>
                </div>
            </div>

            <!-- â—‹å°ï¼ˆå¯¾æŠ—ï¼‰ã®ç‰¹å¾´é‡é‡è¦åº¦ -->
            <div class="feature-importance-controls" style="background: rgba(59, 130, 246, 0.1);">
                <h4 style="color: #3b82f6; margin-bottom: 15px;">â—‹ å¯¾æŠ—é¦¬ã®ç‰¹å¾´é‡é‡è¦åº¦</h4>
                <div class="slider-container">
                    <label style="min-width: 80px; font-size: 0.9rem;">ç‰¹å¾´é‡1:</label>
                    <input type="text" id="subFeature1Label" value="å…ˆè¡ŒåŠ›" placeholder="ç‰¹å¾´é‡å" style="width: 120px; padding: 5px 8px; font-size: 0.8rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.2); border-radius: 4px; color: white;">
                    <input type="range" id="subFeature1" class="slider" min="0" max="1" step="0.01" value="0.96" onchange="updateImportanceBars()">
                    <span id="subFeature1Value" style="min-width: 40px; font-size: 0.9rem;">96%</span>
                </div>
                <div class="slider-container">
                    <label style="min-width: 80px; font-size: 0.9rem;">ç‰¹å¾´é‡2:</label>
                    <input type="text" id="subFeature2Label" value="ã‚¹ãƒ”ãƒ¼ãƒ‰æŒ‡æ•°" placeholder="ç‰¹å¾´é‡å" style="width: 120px; padding: 5px 8px; font-size: 0.8rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.2); border-radius: 4px; color: white;">
                    <input type="range" id="subFeature2" class="slider" min="0" max="1" step="0.01" value="0.85" onchange="updateImportanceBars()">
                    <span id="subFeature2Value" style="min-width: 40px; font-size: 0.9rem;">85%</span>
                </div>
                <div class="slider-container">
                    <label style="min-width: 80px; font-size: 0.9rem;">ç‰¹å¾´é‡3:</label>
                    <input type="text" id="subFeature3Label" value="æ é †å„ªä½" placeholder="ç‰¹å¾´é‡å" style="width: 120px; padding: 5px 8px; font-size: 0.8rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.2); border-radius: 4px; color: white;">
                    <input type="range" id="subFeature3" class="slider" min="0" max="1" step="0.01" value="0.79" onchange="updateImportanceBars()">
                    <span id="subFeature3Value" style="min-width: 40px; font-size: 0.9rem;">79%</span>
                </div>
            </div>

            <div style="margin-top: 20px; text-align: center;">
                <button class="btn btn-primary" onclick="applyImportanceToSelectedRace()">
                    ğŸ¯ é¸æŠä¸­ãƒ¬ãƒ¼ã‚¹ã«é©ç”¨
                </button>
                <button class="btn btn-secondary" onclick="previewImportanceBars()" style="margin-left: 10px;">
                    ğŸ‘ï¸ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
                </button>
            </div>
        </div>

        <!-- å€‹åˆ¥ãƒ¬ãƒ¼ã‚¹è©³ç´°ç·¨é›† -->
        <div class="form-section" id="race-edit-section" style="display: none; background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3);">
            <h2 class="section-title">ğŸ¯ å€‹åˆ¥ãƒ¬ãƒ¼ã‚¹è©³ç´°ç·¨é›†</h2>
            <div id="race-edit-header" style="margin-bottom: 20px; padding: 15px; background: rgba(15, 23, 42, 0.5); border-radius: 8px;">
                <h3 id="race-edit-title" style="color: #8b5cf6; margin-bottom: 10px;">ç·¨é›†ä¸­: -</h3>
                <p style="color: #94a3b8; font-size: 0.9rem;">ã“ã¡ã‚‰ã§å€‹åˆ¥ãƒ¬ãƒ¼ã‚¹ã®è©³ç´°è¨­å®šã‚’è¡Œã„ã¾ã™ã€‚å¤‰æ›´å¾Œã¯ã€Œé©ç”¨ã€ãƒœã‚¿ãƒ³ã§ä¿å­˜ã—ã¦ãã ã•ã„ã€‚</p>
            </div>

            <!-- ãƒ¬ãƒ¼ã‚¹åŸºæœ¬æƒ…å ± -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 25px;">
                <!-- ãƒ¬ãƒ¼ã‚¹æƒ…å ± -->
                <div style="background: rgba(15, 23, 42, 0.5); padding: 15px; border-radius: 8px;">
                    <h4 style="color: #10b981; margin-bottom: 15px;">ğŸ“Š ãƒ¬ãƒ¼ã‚¹åŸºæœ¬æƒ…å ±</h4>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <input type="text" id="edit-race-name" placeholder="ãƒ¬ãƒ¼ã‚¹å" 
                               style="padding: 8px 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.2); border-radius: 6px; color: white;">
                        <input type="text" id="edit-ability-index" placeholder="èƒ½åŠ›æŒ‡æ•°" 
                               style="padding: 8px 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.2); border-radius: 6px; color: white;">
                        <select id="edit-recommendation" 
                                style="padding: 8px 12px; background: rgba(15,23,42,0.8); border: 1px solid rgba(148,163,184,0.2); border-radius: 6px; color: white;">
                            <option value="A+">A+ (æœ€å¼·æ¨å¥¨)</option>
                            <option value="A">A (å¼·æ¨å¥¨)</option>
                            <option value="B+">B+ (æ¨å¥¨)</option>
                            <option value="B">B (ã‚„ã‚„æ¨å¥¨)</option>
                            <option value="C+">C+ (æ¡ä»¶ä»˜ã)</option>
                            <option value="C">C (æ³¨æ„)</option>
                        </select>
                        <input type="text" id="edit-expected-return" placeholder="æœŸå¾…å›åç‡ (%)" 
                               style="padding: 8px 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.2); border-radius: 6px; color: white;">
                    </div>
                </div>

                <!-- äºˆæƒ³é¦¬æƒ…å ± -->
                <div style="background: rgba(15, 23, 42, 0.5); padding: 15px; border-radius: 8px;">
                    <h4 style="color: #3b82f6; margin-bottom: 15px;">ğŸ‡ äºˆæƒ³é¦¬æƒ…å ±</h4>
                    
                    <!-- æœ¬å‘½é¦¬ -->
                    <div style="margin-bottom: 15px; padding: 10px; background: rgba(16, 185, 129, 0.1); border-radius: 6px;">
                        <h5 style="color: #10b981; margin-bottom: 8px;">â— æœ¬å‘½</h5>
                        <div style="display: flex; gap: 10px;">
                            <input type="number" id="edit-main-number" placeholder="é¦¬ç•ª" min="1" max="16" 
                                   style="width: 70px; padding: 6px 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.2); border-radius: 4px; color: white;">
                            <input type="text" id="edit-main-name" placeholder="é¦¬å" 
                                   style="flex: 1; padding: 6px 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.2); border-radius: 4px; color: white;">
                        </div>
                    </div>

                    <!-- å¯¾æŠ—é¦¬ -->
                    <div style="margin-bottom: 15px; padding: 10px; background: rgba(59, 130, 246, 0.1); border-radius: 6px;">
                        <h5 style="color: #3b82f6; margin-bottom: 8px;">â—‹ å¯¾æŠ—</h5>
                        <div style="display: flex; gap: 10px;">
                            <input type="number" id="edit-sub1-number" placeholder="é¦¬ç•ª" min="1" max="16" 
                                   style="width: 70px; padding: 6px 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.2); border-radius: 4px; color: white;">
                            <input type="text" id="edit-sub1-name" placeholder="é¦¬å" 
                                   style="flex: 1; padding: 6px 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.2); border-radius: 4px; color: white;">
                        </div>
                    </div>

                    <!-- å˜ç©´é¦¬ -->
                    <div style="margin-bottom: 10px; padding: 10px; background: rgba(245, 158, 11, 0.1); border-radius: 6px;">
                        <h5 style="color: #f59e0b; margin-bottom: 8px;">â–² å˜ç©´</h5>
                        <div style="display: flex; gap: 10px;">
                            <input type="number" id="edit-sub2-number" placeholder="é¦¬ç•ª" min="1" max="16" 
                                   style="width: 70px; padding: 6px 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.2); border-radius: 4px; color: white;">
                            <input type="text" id="edit-sub2-name" placeholder="é¦¬å" 
                                   style="flex: 1; padding: 6px 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.2); border-radius: 4px; color: white;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ“ä½œãƒœã‚¿ãƒ³ -->
            <div style="display: flex; gap: 12px; justify-content: center;">
                <button class="btn btn-success" onclick="saveRaceEdit()">âœ… å¤‰æ›´ã‚’é©ç”¨</button>
                <button class="btn btn-secondary" onclick="cancelRaceEdit()">âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn btn-warning" onclick="resetRaceToDefault()">ğŸ”„ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™</button>
            </div>
        </div>

        <div id="loading">
            <p>ğŸ”„ å‡¦ç†ä¸­...</p>
        </div>

        <!-- ç”Ÿæˆã•ã‚ŒãŸJSONã®è¡¨ç¤º -->
        <div class="form-section" style="display: none;" id="json-output-section">
            <h2 class="section-title">ğŸ“„ ç”ŸæˆJSON</h2>
            <textarea id="json-output" class="form-textarea" rows="20" readonly 
                style="font-family: 'Monaco', 'Menlo', monospace; font-size: 12px; background: rgba(15, 23, 42, 0.8);"></textarea>
            <div style="margin-top: 12px; display: flex; gap: 12px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="copyToClipboard('json-output')">ğŸ“‹ JSONã‚’ã‚³ãƒ”ãƒ¼</button>
                <button class="btn btn-secondary" onclick="downloadJson()">ğŸ’¾ JSONãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
            </div>
            <div style="margin-top: 15px; padding: 12px; background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 6px;">
                <p style="color: #f59e0b; font-size: 0.9rem; margin-bottom: 8px;"><strong>ğŸ“ ä¿å­˜æ‰‹é †:</strong></p>
                <ol style="color: #e2e8f0; font-size: 0.85rem; margin-left: 20px; line-height: 1.4;">
                    <li>ã€ŒJSONãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€ãƒœã‚¿ãƒ³ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜</li>
                    <li>ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã€ŒallRacesPrediction.jsonã€ã‚’<strong>src/data/</strong>ãƒ•ã‚©ãƒ«ãƒ€ã«é…ç½®</li>
                    <li>æ—¢å­˜ã®allRacesPrediction.jsonãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸Šæ›¸ã</li>
                    <li>ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆãƒ¡ã‚¤ãƒ³ã‚µã‚¤ãƒˆï¼‰ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦å¤‰æ›´ã‚’ç¢ºèª</li>
                </ol>
                <p style="color: #94a3b8; font-size: 0.8rem; margin-top: 8px;">
                    âš ï¸ ãƒ¬ãƒ¼ã‚¹åã®å¤‰æ›´ã¯ç®¡ç†ç”»é¢ã§ã®ã¿è¡Œã„ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã«åæ˜ ã™ã‚‹ã«ã¯ä¸Šè¨˜æ‰‹é †ãŒå¿…è¦ã§ã™ã€‚
                </p>
            </div>
        </div>
    </div>

    <script>
        // ===== ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° =====
        let allRacesData = null;
        let currentEditingRace = null;

        // ===== å…±æœ‰ãƒ­ã‚¸ãƒƒã‚¯é–¢æ•° (ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ç”¨) =====
        function convertToStarRating(text, horseType, score) {
            // ã‚¹ã‚³ã‚¢ãŒæ•°å€¤ã§ãªã„å ´åˆã¯ãƒ†ã‚­ã‚¹ãƒˆã‚’ãã®ã¾ã¾è¿”ã™
            if (typeof score !== 'number' && typeof score !== 'string') {
                return text;
            }

            const numScore = typeof score === 'string' ? parseInt(score) : score;

            // ã‚¹ã‚³ã‚¢ãŒæœ‰åŠ¹ãªæ•°å€¤ã§ãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ã‚­ã‚¹ãƒˆ
            if (isNaN(numScore)) {
                return text;
            }

            // 89ä»¥ä¸Šã¯4ã¤æ˜Ÿã€88ä»¥ä¸‹ã¯3ã¤æ˜Ÿ
            const stars = numScore >= 89 ? 'â˜…â˜…â˜…â˜…' : 'â˜…â˜…â˜…';

            return `ç·åˆè©•ä¾¡:${stars}`;
        }

        // ãƒ¬ãƒ¼ã‚¹è¨­å®šï¼ˆrace-config.jsã¨åŒã˜å®šç¾©ï¼‰
        const RACE_TIERS = {
            1: 'premium', 2: 'premium', 3: 'premium',
            4: 'premium', 5: 'premium', 6: 'premium',
            7: 'premium', 8: 'premium', 9: 'premium',
            10: 'standard',
            11: 'free',     // ãƒ¡ã‚¤ãƒ³ãƒ¬ãƒ¼ã‚¹
            12: 'standard'
        };
        
        // race-config.jsäº’æ›ã®é–¢æ•°
        function getRaceTier(raceNumber) {
            return RACE_TIERS[raceNumber] || 'premium';
        }
        
        function isMainRace(raceNumber) {
            return raceNumber === 11;
        }
        
        function getRaceDisplayName(raceNumber) {
            const tier = getRaceTier(raceNumber);
            const isMain = isMainRace(raceNumber);
            
            if (isMain) {
                return `${raceNumber}Rç·¨é›† (ãƒ¡ã‚¤ãƒ³ãƒ»free)`;
            } else if (tier === 'standard') {
                return `${raceNumber}Rç·¨é›† (standard)`;
            } else {
                return `${raceNumber}Rç·¨é›† (premium)`;
            }
        }
        
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¬ãƒ¼ã‚¹åç”Ÿæˆé–¢æ•°
        function getDefaultRaceName(raceNumber) {
            const raceNames = {
                1: '2æ­³æ–°é¦¬',
                2: '3æ­³æœªå‹åˆ©',
                3: '3æ­³1å‹ã‚¯ãƒ©ã‚¹',
                4: 'ã‚µãƒ©ç³»3æ­³ä»¥ä¸Š',
                5: '3æ­³ä»¥ä¸Š1å‹ã‚¯ãƒ©ã‚¹',
                6: 'ã‚µãƒ©ç³»3æ­³ä»¥ä¸Š',
                7: '3æ­³ä»¥ä¸Š2å‹ã‚¯ãƒ©ã‚¹',
                8: 'ã‚ªãƒ¼ãƒ—ãƒ³',
                9: 'é‡è³',
                10: 'ç‰¹åˆ¥æˆ¦',
                11: 'ãƒ¡ã‚¤ãƒ³ãƒ¬ãƒ¼ã‚¹', // 11Rã¯ãƒ¡ã‚¤ãƒ³ãƒ¬ãƒ¼ã‚¹
                12: 'ã‚µãƒ©ç³»3æ­³ä»¥ä¸Š'
            };
            
            return raceNames[raceNumber] || 'ã‚µãƒ©ç³»3æ­³ä»¥ä¸Š';
        }
        let parsedPredictionData = null;

        // ãƒ‡ãƒ¼ã‚¿ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°ï¼ˆdata-validator.jsã®æ©Ÿèƒ½ã‚’åˆ©ç”¨ï¼‰
        function validateAllRaces() {
            if (!allRacesData) {
                handleError('æ¤œè¨¼ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚', 'ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼');
                return;
            }
            
            // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
            const validation = validateAllRacesPredictionInternal(allRacesData);
            
            // çµæœè¡¨ç¤º
            const alertBox = document.getElementById('alert');
            if (validation.valid) {
                showSuccess('ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼æˆåŠŸ: ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒæ­£å¸¸ã§ã™', 'ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼');
            } else {
                let message = 'âš ï¸ ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ã§å•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ:\n\n';
                
                if (validation.errors.length > 0) {
                    message += 'ã€ã‚¨ãƒ©ãƒ¼ã€‘\n';
                    validation.errors.forEach(e => message += `â€¢ ${e}\n`);
                }
                
                if (validation.warnings.length > 0) {
                    message += '\nã€è­¦å‘Šï¼ˆè‡ªå‹•ä¿®æ­£å¯èƒ½ï¼‰ã€‘\n';
                    validation.warnings.forEach(w => message += `â€¢ ${w}\n`);
                }
                
                message += '\nè‡ªå‹•ä¿®æ­£ã‚’é©ç”¨ã—ã¾ã™ã‹ï¼Ÿ';
                
                if (confirm(message)) {
                    // è‡ªå‹•ä¿®æ­£é©ç”¨
                    allRacesData = validation.fixed || allRacesData;
                    showSuccess('ãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•ä¿®æ­£ã—ã¾ã—ãŸ', 'ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼');
                    
                    // JSONã‚’å†ç”Ÿæˆ
                    const jsonOutput = document.getElementById('json-output');
                    jsonOutput.value = JSON.stringify(allRacesData, null, 2);
                }
            }
        }
        
        // å†…éƒ¨ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°ï¼ˆdata-validator.jsã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
        function validateAllRacesPredictionInternal(data) {
            const errors = [];
            const warnings = [];
            const fixed = JSON.parse(JSON.stringify(data));
            
            // å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒã‚§ãƒƒã‚¯
            if (!data.raceDate) errors.push('é–‹å‚¬æ—¥ãŒæœªè¨­å®š');
            if (!data.track) errors.push('ç«¶é¦¬å ´ãŒæœªè¨­å®š');
            if (!data.totalRaces) errors.push('ç·ãƒ¬ãƒ¼ã‚¹æ•°ãŒæœªè¨­å®š');
            
            // å„ãƒ¬ãƒ¼ã‚¹ã®ãƒã‚§ãƒƒã‚¯
            if (data.races && Array.isArray(data.races)) {
                data.races.forEach((race, index) => {
                    const raceNum = parseInt(race.raceNumber);
                    const expectedNum = index + 1;
                    
                    // tieræ¤œè¨¼
                    const correctTier = getRaceTier(raceNum || expectedNum);
                    if (race.tier !== correctTier) {
                        warnings.push(`${race.raceNumber}: tierã‚’${race.tier}â†’${correctTier}ã«ä¿®æ­£`);
                        fixed.races[index].tier = correctTier;
                    }
                    
                    // ãƒ¡ã‚¤ãƒ³ãƒ¬ãƒ¼ã‚¹ãƒ•ãƒ©ã‚°æ¤œè¨¼
                    const shouldBeMain = isMainRace(raceNum || expectedNum);
                    if (race.isMainRace !== shouldBeMain) {
                        warnings.push(`${race.raceNumber}: isMainRaceã‚’${race.isMainRace}â†’${shouldBeMain}ã«ä¿®æ­£`);
                        fixed.races[index].isMainRace = shouldBeMain;
                    }
                    
                    // é¦¬ãƒ‡ãƒ¼ã‚¿ãƒã‚§ãƒƒã‚¯
                    if (!race.horses?.main?.number) {
                        errors.push(`${race.raceNumber}: æœ¬å‘½é¦¬ãŒæœªè¨­å®š`);
                    }
                    
                    // importanceå€¤ã®æ­£è¦åŒ–ï¼ˆ1ä»¥ä¸Šãªã‚‰100ã§å‰²ã‚‹ï¼‰
                    ['main', 'sub'].forEach(horseType => {
                        if (race.horses?.[horseType]?.importance) {
                            race.horses[horseType].importance.forEach((item, idx) => {
                                if (item.value > 1) {
                                    warnings.push(`${race.raceNumber}: ${horseType}é¦¬ã®importanceå€¤ã‚’æ­£è¦åŒ–`);
                                    fixed.races[index].horses[horseType].importance[idx].value = item.value / 100;
                                }
                            });
                        }
                    });
                });
            }
            
            return {
                valid: errors.length === 0,
                errors,
                warnings,
                fixed: errors.length === 0 ? fixed : null
            };
        }
        
        // ãƒ¬ãƒ¼ã‚¹ç·¨é›†ãƒœã‚¿ãƒ³ã‚’å‹•çš„ç”Ÿæˆ
        function generateRaceEditButtons() {
            const container = document.getElementById('raceEditButtons');
            if (!container) return;
            
            container.innerHTML = '';
            for (let i = 1; i <= 12; i++) {
                const button = document.createElement('button');
                button.className = 'btn btn-secondary';
                button.textContent = getRaceDisplayName(i);
                button.style.justifyContent = 'center';
                
                // ãƒ¡ã‚¤ãƒ³ãƒ¬ãƒ¼ã‚¹ï¼ˆ11Rï¼‰ã¯ç‰¹åˆ¥ãªã‚¹ã‚¿ã‚¤ãƒ«
                if (isMainRace(i)) {
                    button.style.background = 'linear-gradient(135deg, rgba(16, 185, 129, 0.3) 0%, rgba(59, 130, 246, 0.3) 100%)';
                    button.style.border = '2px solid rgba(16, 185, 129, 0.5)';
                }
                
                button.onclick = () => editRace(`${i}R`);
                container.appendChild(button);
            }
        }
        
        // ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° =====
        // ===== ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æ”¹å–„ =====
        function showAlert(message, type = 'success') {
            const alert = document.getElementById('alert');
            const typeConfig = {
                success: { icon: 'âœ…', color: '#10b981', bgColor: 'rgba(16, 185, 129, 0.1)' },
                error: { icon: 'âŒ', color: '#ef4444', bgColor: 'rgba(239, 68, 68, 0.1)' },
                warning: { icon: 'âš ï¸', color: '#f59e0b', bgColor: 'rgba(245, 158, 11, 0.1)' },
                info: { icon: 'ğŸ’¡', color: '#3b82f6', bgColor: 'rgba(59, 130, 246, 0.1)' }
            };
            
            const config = typeConfig[type] || typeConfig.info;
            
            alert.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 16px;">${config.icon}</span>
                    <span>${message}</span>
                </div>
            `;
            alert.className = `alert ${type}`;
            alert.style.cssText = `
                display: block;
                background: ${config.bgColor};
                color: ${config.color};
                border: 1px solid ${config.color}33;
                padding: 12px 16px;
                border-radius: 8px;
                margin: 12px 0;
                backdrop-filter: blur(10px);
                animation: slideIn 0.3s ease;
            `;
            
            // è‡ªå‹•æ¶ˆå»
            setTimeout(() => {
                if (alert.style.display !== 'none') {
                    alert.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => alert.style.display = 'none', 300);
                }
            }, 5000);
        }
        
        // ã‚¨ãƒ©ãƒ¼å‡¦ç†ã®çµ±ä¸€åŒ–
        function handleError(error, context = '') {
            console.error(`[${context}] ã‚¨ãƒ©ãƒ¼:`, error);
            
            let message = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
            
            if (typeof error === 'string') {
                message = error;
            } else if (error.message) {
                // ã‚ˆãã‚ã‚‹ã‚¨ãƒ©ãƒ¼ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ã«å¤‰æ›
                if (error.message.includes('fetch')) {
                    message = 'ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“ã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„';
                } else if (error.message.includes('JSON')) {
                    message = 'ãƒ‡ãƒ¼ã‚¿å½¢å¼ã«å•é¡ŒãŒã‚ã‚Šã¾ã™';
                } else if (error.message.includes('timeout')) {
                    message = 'å‡¦ç†ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚å†è©¦è¡Œã—ã¦ãã ã•ã„';
                } else {
                    message = error.message;
                }
            }
            
            showAlert(`${context ? `[${context}] ` : ''}${message}`, 'error');
        }
        
        // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤º
        function showSuccess(message, context = '') {
            showAlert(`${context ? `[${context}] ` : ''}${message}`, 'success');
        }
        
        // è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤º
        function showWarning(message, context = '') {
            showAlert(`${context ? `[${context}] ` : ''}${message}`, 'warning');
        }

        function logAllRaces(message) {
            const log = document.getElementById('all-races-log');
            if (!log) {
                console.warn('all-races-log element not found');
                return;
            }

            const timestamp = new Date().toLocaleTimeString();
            log.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            log.scrollTop = log.scrollHeight;
        }

        // ===== ç”Ÿæˆãƒ‡ãƒ¼ã‚¿ç¢ºèªãƒ»ç·¨é›†ã‚·ã‚¹ãƒ†ãƒ  =====
        // å¤–éƒ¨å¤‰æ•°: å¤‰æ›ã‚·ã‚¹ãƒ†ãƒ ã§ç”Ÿæˆã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ
        let generatedRacesData = null;
        
        // å¤‰æ›ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘å–ã‚‹é–¢æ•°ï¼ˆå¤‰æ›å®Œäº†æ™‚ã«å‘¼ã³å‡ºã•ã‚Œã‚‹ï¼‰
        window.setGeneratedData = function(jsonData) {
            generatedRacesData = jsonData;
            allRacesData = jsonData; // å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚
            refreshGeneratedData();
            logAllRaces(`âœ… ${jsonData.totalRaces}ãƒ¬ãƒ¼ã‚¹åˆ†ã®ãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘å–ã‚Šã¾ã—ãŸ`);
        };
        
        // ç”Ÿæˆãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
        window.refreshGeneratedData = function() {
            if (!generatedRacesData) {
                showAlert('ã¾ãšä¸Šã®ã€Œå…¨ãƒ¬ãƒ¼ã‚¹ä¸€æ‹¬å¤‰æ›ãƒ»JSONç”Ÿæˆã€ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„', 'info');
                updateDataStatus('å¤‰æ›å®Ÿè¡Œå¾…ã¡');
                return;
            }
            
            logAllRaces(`ğŸ“Š ${generatedRacesData.raceDate} ${generatedRacesData.track} ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºä¸­...`);
            
            // UIæ›´æ–°
            updateDataStatus(`${generatedRacesData.totalRaces}ãƒ¬ãƒ¼ã‚¹ç”Ÿæˆæ¸ˆã¿`);
            updateRaceStatus();
            generateRaceEditButtons();
            
            logAllRaces('âœ… ç”Ÿæˆãƒ‡ãƒ¼ã‚¿ã®è¡¨ç¤ºå®Œäº†');
            showAlert('ç”Ÿæˆãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ', 'success');
        };
        
        // æœ€çµ‚JSONã‚’ã‚³ãƒ”ãƒ¼
        window.copyGeneratedJSON = function() {
            if (!generatedRacesData) {
                showAlert('ã¾ãšå¤‰æ›ã‚’å®Ÿè¡Œã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            const jsonString = JSON.stringify(generatedRacesData, null, 2);
            
            // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
            if (navigator.clipboard) {
                navigator.clipboard.writeText(jsonString).then(() => {
                    logAllRaces('âœ… JSONã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
                    showAlert('JSONã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\nallRacesPrediction.jsonã«è²¼ã‚Šä»˜ã‘ã¦ã‚³ãƒŸãƒƒãƒˆã—ã¦ãã ã•ã„ã€‚', 'success');
                }).catch(() => {
                    fallbackCopy(jsonString);
                });
            } else {
                fallbackCopy(jsonString);
            }
        };
        
        // ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼
        window.validateGeneratedData = function() {
            if (!generatedRacesData) {
                showAlert('æ¤œè¨¼ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }
            
            logAllRaces('ğŸ” ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ã‚’å®Ÿè¡Œä¸­...');
            
            const validation = validateAllRacesPredictionInternal(generatedRacesData);
            
            if (validation.valid) {
                logAllRaces('âœ… ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼: å•é¡Œãªã—');
                showAlert('ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼å®Œäº†: ã™ã¹ã¦æ­£å¸¸ã§ã™', 'success');
            } else {
                logAllRaces(`âš ï¸ ${validation.errors.length}å€‹ã®å•é¡Œã‚’ç™ºè¦‹`);
                showAlert(`ãƒ‡ãƒ¼ã‚¿ã«${validation.errors.length}å€‹ã®å•é¡ŒãŒã‚ã‚Šã¾ã™`, 'warning');
            }
        };
        
        // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function updateDataStatus(message) {
            const statusElement = document.getElementById('data-status');
            if (statusElement) {
                statusElement.textContent = message;
            }
        }
        
        function fallbackCopy(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                logAllRaces('âœ… JSONã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ–¹å¼ï¼‰');
                showAlert('JSONã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼', 'success');
            } catch (err) {
                logAllRaces('âŒ ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
                showAlert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
            document.body.removeChild(textArea);
        }

        window.validateAllRaces = function() {
            if (!allRacesData) {
                showAlert('å…ˆã«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„', 'error');
                return;
            }

            logAllRaces('ğŸ” ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’æ¤œè¨¼ä¸­...');
            
            const validation = {
                totalRaces: allRacesData.races?.length || 0,
                premiumRaces: 0,
                standardRaces: 0,
                freeRaces: 0,
                mainRace: null,
                errors: []
            };

            if (allRacesData.races) {
                allRacesData.races.forEach(race => {
                    switch(race.tier) {
                        case 'premium': validation.premiumRaces++; break;
                        case 'standard': validation.standardRaces++; break;
                        case 'free': validation.freeRaces++; break;
                    }
                    
                    if (race.isMainRace) {
                        validation.mainRace = race.raceNumber;
                    }
                });
            }

            logAllRaces(`ğŸ“Š æ¤œè¨¼çµæœ: ${validation.totalRaces}ãƒ¬ãƒ¼ã‚¹ (ãƒ—ãƒ¬ãƒŸã‚¢ãƒ :${validation.premiumRaces}, ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰:${validation.standardRaces}, ç„¡æ–™:${validation.freeRaces})`);
            logAllRaces(`ğŸ¯ ãƒ¡ã‚¤ãƒ³ãƒ¬ãƒ¼ã‚¹: ${validation.mainRace || 'æœªè¨­å®š'}`);
            
            showAlert(`ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼å®Œäº†: ${validation.totalRaces}ãƒ¬ãƒ¼ã‚¹ã‚’ç¢ºèªã—ã¾ã—ãŸ`, 'success');
        };

        window.saveAllRaces = function() {
            if (!allRacesData) {
                showAlert('ä¿å­˜ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }

            try {
                const jsonString = JSON.stringify(allRacesData, null, 2);
                
                // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
                navigator.clipboard.writeText(jsonString).then(() => {
                    logAllRaces('ğŸ“‹ JSONãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
                    showAlert('JSONãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚allRacesPrediction.jsonã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚', 'success');
                    
                    // JSONè¡¨ç¤ºã‚¨ãƒªã‚¢ã«ã‚‚å‡ºåŠ›
                    document.getElementById('json-output').value = jsonString;
                    document.getElementById('json-output-section').style.display = 'block';
                    
                }).catch(() => {
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«è¡¨ç¤º
                    document.getElementById('json-output').value = jsonString;
                    document.getElementById('json-output-section').style.display = 'block';
                    showAlert('JSONãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚', 'success');
                });
                
            } catch (error) {
                logAllRaces(`âŒ ä¿å­˜ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                showAlert(`ä¿å­˜ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        };

        window.generatePreview = function() {
            if (!allRacesData) {
                showAlert('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }

            logAllRaces('ğŸ‘ï¸ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç”Ÿæˆä¸­...');
            
            const preview = {
                æ¦‚è¦: `${allRacesData.track} ${allRacesData.raceDate}`,
                å…¨ãƒ¬ãƒ¼ã‚¹æ•°: allRacesData.races?.length || 0,
                ãƒ—ãƒ¬ãƒŸã‚¢ãƒ : allRacesData.races?.filter(r => r.tier === 'premium').length || 0,
                ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰: allRacesData.races?.filter(r => r.tier === 'standard').length || 0,
                ç„¡æ–™: allRacesData.races?.filter(r => r.tier === 'free').length || 0,
                ãƒ¡ã‚¤ãƒ³ãƒ¬ãƒ¼ã‚¹: allRacesData.races?.find(r => r.isMainRace)?.raceNumber || 'æœªè¨­å®š'
            };

            logAllRaces('âœ… ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆå®Œäº†');
            showAlert(`ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼: ${preview.æ¦‚è¦} - å…¨${preview.å…¨ãƒ¬ãƒ¼ã‚¹æ•°}ãƒ¬ãƒ¼ã‚¹ (ãƒ—ãƒ¬ãƒŸã‚¢ãƒ :${preview.ãƒ—ãƒ¬ãƒŸã‚¢ãƒ }, ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰:${preview.ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰}, ç„¡æ–™:${preview.ç„¡æ–™})`, 'success');
        };

        window.editRace = function(raceNumber) {
            currentEditingRace = raceNumber;
            logAllRaces(`ğŸ¯ ${raceNumber}ã®ç·¨é›†ã‚’é–‹å§‹`);
            showAlert(`${raceNumber}ãŒé¸æŠã•ã‚Œã¾ã—ãŸã€‚ç‰¹å¾´é‡é‡è¦åº¦ãƒãƒ¼ç·¨é›†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§èª¿æ•´ã—ã¦ãã ã•ã„ã€‚`, 'success');
            
            // ãƒ¬ãƒ¼ã‚¹é¸æŠçŠ¶æ…‹ã‚’è¦–è¦šçš„ã«è¡¨ç¤º
            document.querySelectorAll('.btn-secondary').forEach(btn => {
                btn.style.background = 'linear-gradient(135deg, #6b7280 0%, #4b5563 100%)';
            });
            
            event.target.style.background = 'linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%)';
        };

        function updateRaceStatus() {
            const statusContainer = document.getElementById('all-races-status');
            if (!statusContainer) {
                console.warn('all-races-status element not found');
                return;
            }

            if (!allRacesData?.races) {
                statusContainer.innerHTML = '<div style="color: #ef4444;">ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“</div>';
                return;
            }

            statusContainer.innerHTML = '';
            
            allRacesData.races.forEach(race => {
                const hasDetailedData = race.horses?.main?.importance && race.strategies && race.analysis;
                const statusClass = hasDetailedData ? 'status-complete' : 'status-incomplete';
                const statusText = hasDetailedData ? 'å®Œäº†' : 'åŸºæœ¬ã®ã¿';
                
                const card = document.createElement('div');
                card.className = 'race-card';
                card.innerHTML = `
                    <div style="font-weight: 600; color: #f1f5f9; margin-bottom: 8px;">${race.raceNumber}</div>
                    <div style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 8px;">${race.raceName}</div>
                    <div class="race-status ${statusClass}">${statusText}</div>
                `;
                statusContainer.appendChild(card);
            });
        }

        // ===== ç‰¹å¾´é‡é‡è¦åº¦ãƒãƒ¼ç·¨é›†æ©Ÿèƒ½ =====
        window.updateImportanceBars = function() {
            // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å€¤æ›´æ–°ï¼ˆãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆè¡¨ç¤ºï¼‰
            document.getElementById('mainFeature1Value').textContent = Math.round(document.getElementById('mainFeature1').value * 100) + '%';
            document.getElementById('mainFeature2Value').textContent = Math.round(document.getElementById('mainFeature2').value * 100) + '%';
            document.getElementById('mainFeature3Value').textContent = Math.round(document.getElementById('mainFeature3').value * 100) + '%';
            document.getElementById('subFeature1Value').textContent = Math.round(document.getElementById('subFeature1').value * 100) + '%';
            document.getElementById('subFeature2Value').textContent = Math.round(document.getElementById('subFeature2').value * 100) + '%';
            document.getElementById('subFeature3Value').textContent = Math.round(document.getElementById('subFeature3').value * 100) + '%';
        };

        window.applyImportanceToSelectedRace = function() {
            if (!currentEditingRace) {
                showAlert('å…ˆã«ãƒ¬ãƒ¼ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            if (!allRacesData?.races) {
                showAlert('å…ˆã«ãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„', 'error');
                return;
            }

            const race = allRacesData.races.find(r => r.raceNumber === currentEditingRace);
            if (!race) {
                showAlert('é¸æŠã•ã‚ŒãŸãƒ¬ãƒ¼ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                return;
            }

            // ç‰¹å¾´é‡é‡è¦åº¦ãƒ‡ãƒ¼ã‚¿ã‚’é©ç”¨
            if (!race.horses) race.horses = {};
            
            // æœ¬å‘½é¦¬ã®ç‰¹å¾´é‡é‡è¦åº¦
            if (!race.horses.main) race.horses.main = {};
            race.horses.main.importance = [
                { 
                    label: document.getElementById('mainFeature1Label').value || 'ç‰¹å¾´é‡1', 
                    value: parseFloat(document.getElementById('mainFeature1').value) 
                },
                { 
                    label: document.getElementById('mainFeature2Label').value || 'ç‰¹å¾´é‡2', 
                    value: parseFloat(document.getElementById('mainFeature2').value) 
                },
                { 
                    label: document.getElementById('mainFeature3Label').value || 'ç‰¹å¾´é‡3', 
                    value: parseFloat(document.getElementById('mainFeature3').value) 
                }
            ];

            // å¯¾æŠ—é¦¬ã®ç‰¹å¾´é‡é‡è¦åº¦
            if (!race.horses.sub) race.horses.sub = {};
            race.horses.sub.importance = [
                { 
                    label: document.getElementById('subFeature1Label').value || 'ç‰¹å¾´é‡1', 
                    value: parseFloat(document.getElementById('subFeature1').value) 
                },
                { 
                    label: document.getElementById('subFeature2Label').value || 'ç‰¹å¾´é‡2', 
                    value: parseFloat(document.getElementById('subFeature2').value) 
                },
                { 
                    label: document.getElementById('subFeature3Label').value || 'ç‰¹å¾´é‡3', 
                    value: parseFloat(document.getElementById('subFeature3').value) 
                }
            ];

            logAllRaces(`âœ… ${currentEditingRace}ã«ç‰¹å¾´é‡é‡è¦åº¦ã‚’é©ç”¨ã—ã¾ã—ãŸ`);
            showAlert(`${currentEditingRace}ã«ç‰¹å¾´é‡é‡è¦åº¦ã‚’é©ç”¨ã—ã¾ã—ãŸ`, 'success');
            updateRaceStatus();
        };

        window.previewImportanceBars = function() {
            const preview = {
                'æœ¬å‘½é¦¬': [
                    `${document.getElementById('mainFeature1Label').value}: ${document.getElementById('mainFeature1').value}`,
                    `${document.getElementById('mainFeature2Label').value}: ${document.getElementById('mainFeature2').value}`,
                    `${document.getElementById('mainFeature3Label').value}: ${document.getElementById('mainFeature3').value}`
                ],
                'å¯¾æŠ—é¦¬': [
                    `${document.getElementById('subFeature1Label').value}: ${document.getElementById('subFeature1').value}`,
                    `${document.getElementById('subFeature2Label').value}: ${document.getElementById('subFeature2').value}`,
                    `${document.getElementById('subFeature3Label').value}: ${document.getElementById('subFeature3').value}`
                ]
            };
            
            logAllRaces('ğŸ‘ï¸ ç‰¹å¾´é‡é‡è¦åº¦ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼:');
            logAllRaces(`æœ¬å‘½: ${preview['æœ¬å‘½é¦¬'].join(', ')}`);
            logAllRaces(`å¯¾æŠ—: ${preview['å¯¾æŠ—é¦¬'].join(', ')}`);
            
            showAlert('ç‰¹å¾´é‡é‡è¦åº¦ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãƒ­ã‚°ã«è¡¨ç¤ºã—ã¾ã—ãŸ', 'success');
        };

        // ===== å…¨ãƒ¬ãƒ¼ã‚¹ä¸€æ‹¬å¤‰æ›æ©Ÿèƒ½ =====
        window.convertAllRaces = async function() {
            const externalText = document.getElementById('external_prediction').value;
            if (!externalText.trim()) {
                showAlert('å¤‰æ›ã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            const progressDiv = document.getElementById('conversion-progress');
            if (!progressDiv) {
                console.warn('conversion-progress element not found');
                showAlert('é€²æ—è¡¨ç¤ºã‚¨ãƒªã‚¢ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                return;
            }

            progressDiv.style.display = 'block';
            progressDiv.innerHTML = '';

            function logProgress(message) {
                const timestamp = new Date().toLocaleTimeString();
                if (progressDiv) {
                    progressDiv.innerHTML += `<div>[${timestamp}] ${message}</div>`;
                    progressDiv.scrollTop = progressDiv.scrollHeight;
                }
            }

            try {
                logProgress('ğŸ” å…¨ãƒ¬ãƒ¼ã‚¹ãƒ†ã‚­ã‚¹ãƒˆã‚’è§£æä¸­...');
                
                // å…¨ãƒ¬ãƒ¼ã‚¹åˆ†ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’è§£æ
                const allRacesData = parseAllRacesPrediction(externalText);
                
                logProgress(`âœ… ${allRacesData.races.length}ãƒ¬ãƒ¼ã‚¹ã‚’æ¤œå‡ºã—ã¾ã—ãŸ`);
                logProgress('ğŸ¤– å„ãƒ¬ãƒ¼ã‚¹ã®AIäºˆæƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆä¸­...');

                // å„ãƒ¬ãƒ¼ã‚¹ã®AIäºˆæƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
                const races = [];
                for (let i = 0; i < allRacesData.races.length; i++) {
                    const raceData = allRacesData.races[i];
                    logProgress(`å‡¦ç†ä¸­: ${raceData.raceNumber}R (${raceData.horses.length}é ­)`);
                    
                    const aiRaceData = generateRaceData(raceData, allRacesData);
                    races.push(aiRaceData);
                }

                // allRacesPrediction.jsonå½¢å¼ã§å‡ºåŠ›
                const finalData = {
                    raceDate: allRacesData.raceDate,
                    track: allRacesData.track,
                    totalRaces: races.length,
                    races: races,
                    planAccess: {
                        free: {
                            races: ["11R"],
                            description: "ãƒ¡ã‚¤ãƒ³ãƒ¬ãƒ¼ã‚¹ã®ã¿ï¼ˆæœ€çµ‚ãƒ¬ãƒ¼ã‚¹ã®1ã¤å‰ï¼‰"
                        },
                        standard: {
                            races: ["10R", "11R", "12R"],
                            description: "å¾ŒåŠ3ãƒ¬ãƒ¼ã‚¹"
                        },
                        premium: {
                            races: ["1R", "2R", "3R", "4R", "5R", "6R", "7R", "8R", "9R", "10R", "11R", "12R"],
                            description: "å…¨ãƒ¬ãƒ¼ã‚¹"
                        }
                    }
                };

                // ãƒ¡ã‚¤ãƒ³ãƒ¬ãƒ¼ã‚¹è¨­å®šï¼ˆ11Rã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
                const mainRaceIndex = races.findIndex(r => r.raceNumber === '11R');
                if (mainRaceIndex !== -1) {
                    races[mainRaceIndex].isMainRace = true;
                }

                // JSONã‚’è¡¨ç¤º
                const jsonString = JSON.stringify(finalData, null, 2);
                document.getElementById('json-output').value = jsonString;
                document.getElementById('json-output-section').style.display = 'block';

                logProgress(`ğŸ‰ å®Œäº†ï¼å…¨${races.length}ãƒ¬ãƒ¼ã‚¹ã®AIäºˆæƒ³JSONã‚’ç”Ÿæˆã—ã¾ã—ãŸ`);
                showAlert(`âœ… å…¨ãƒ¬ãƒ¼ã‚¹å¤‰æ›å®Œäº†ï¼${races.length}ãƒ¬ãƒ¼ã‚¹ã®AIäºˆæƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¾ã—ãŸ`, 'success');

            } catch (error) {
                console.error('å¤‰æ›ã‚¨ãƒ©ãƒ¼:', error);
                logProgress(`âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                showAlert('å¤‰æ›ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
            }
        }

        window.clearConversion = function() {
            document.getElementById('external_prediction').value = '';
            document.getElementById('conversion-progress').style.display = 'none';
            document.getElementById('json-output-section').style.display = 'none';
            parsedPredictionData = null;
            showAlert('ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'success');
        }

        // å…¨ãƒ¬ãƒ¼ã‚¹è§£æï¼ˆè¤‡æ•°ãƒ¬ãƒ¼ã‚¹å¯¾å¿œï¼‰
        function parseAllRacesPrediction(text) {
            const sections = text.split(/\n\s*\n/).filter(section => section.trim());
            const result = {
                races: [],
                raceDate: null,
                track: null
            };

            let globalDate = null;
            let globalTrack = null;

            for (const section of sections) {
                try {
                    const raceData = parseExternalPrediction(section);
                    if (raceData.horses.length > 0) {
                        // æœ€åˆã«è¦‹ã¤ã‘ãŸæ—¥ä»˜ãƒ»ç«¶é¦¬å ´ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«è¨­å®š
                        if (!globalDate && raceData.raceDate) globalDate = raceData.raceDate;
                        if (!globalTrack && raceData.trackName) globalTrack = raceData.trackName;
                        
                        result.races.push(raceData);
                    }
                } catch (error) {
                    console.warn('ãƒ¬ãƒ¼ã‚¹ã‚»ã‚¯ã‚·ãƒ§ãƒ³è§£æã‚¨ãƒ©ãƒ¼:', section, error);
                }
            }

            // æ—¥ä»˜ãƒ»ç«¶é¦¬å ´è¨­å®š
            result.raceDate = globalDate || new Date().toISOString().split('T')[0];
            result.track = globalTrack || 'å·å´ç«¶é¦¬';

            // ãƒ¬ãƒ¼ã‚¹ç•ªå·é †ã«ã‚½ãƒ¼ãƒˆ
            result.races.sort((a, b) => (a.raceNumber || 99) - (b.raceNumber || 99));

            return result;
        }

        // ãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆï¼ˆçµ±ä¸€é–¢æ•°ï¼‰
        function generateRaceData(raceData, allRacesData) {
            // race-config.jsã‹ã‚‰ä¸€å…ƒç®¡ç†ã•ã‚ŒãŸè¨­å®šã‚’ä½¿ç”¨
            const raceNum = raceData.raceNumber || 1;
            
            return {
                raceNumber: raceNum + 'R',
                raceName: raceData.raceName || getDefaultRaceName(raceNum),
                tier: getRaceTier(raceNum),
                isMainRace: false, // å¾Œã§è¨­å®š
                displayOrder: raceData.raceNumber,
                raceInfo: {
                    title: `${allRacesData.track.replace('ç«¶é¦¬', '')}${raceData.raceNumber || 1}R ${raceData.raceName || 'ã‚µãƒ©ç³»'}`,
                    date: allRacesData.raceDate,
                    track: allRacesData.track,
                    raceNumber: (raceData.raceNumber || 1) + 'R',
                    raceName: raceData.raceName || getDefaultRaceName(raceData.raceNumber || raceNum),
                    abilityIndex: (50 + Math.random() * 40).toFixed(1),
                    recommendation: "B+",
                    expectedReturn: (70 + Math.random() * 80).toFixed(0),
                    // æ–°è¦è¿½åŠ ï¼šãƒ¬ãƒ¼ã‚¹è©³ç´°æƒ…å ±
                    distance: raceData.raceDistance ? raceData.raceDistance + 'm' : '',
                    horseCount: raceData.horseCount || 0,
                    startTime: raceData.startTime || '',
                    raceCondition: raceData.raceCondition || '',
                    // è¡¨ç¤ºç”¨çµ±åˆæ–‡å­—åˆ—
                    raceDetails: `${allRacesData.track || 'å·å´'}${raceData.raceNumber}R ${raceData.raceDistance ? raceData.raceDistance + 'm' : ''} ${raceData.horseCount ? 'ï¼ˆ' + raceData.horseCount + 'é ­ï¼‰' : ''} ${raceData.startTime ? 'ç™ºèµ°æ™‚åˆ»' + raceData.startTime : ''} ${raceData.raceName || 'ã‚µãƒ©ç³»'} ${raceData.raceCondition || ''}`
                },
                horses: generateHorsesDataForRace(raceData),
                strategies: generateStrategiesForRace(raceData),
                analysis: generateAnalysisForRace(raceData),
                preview: generatePreviewDataForRace(raceData),
                allHorses: generateAllHorsesDataForRace(raceData),
                totalHorses: raceData.horses.length,
                lastUpdated: new Date().toISOString()
            };
        }

        function generateHorsesDataForRace(raceData) {
            const horses = {};
            
            // ã‚¹ã‚³ã‚¢ãƒ™ãƒ¼ã‚¹ã§ã®è‡ªå‹•å½¹å‰²å‰²ã‚Šå½“ã¦
            const sortedHorses = [...raceData.horses].sort((a, b) => {
                const scoreA = a.score || 62;
                const scoreB = b.score || 62;
                if (scoreB === scoreA) {
                    // åŒç‚¹ã®å ´åˆã¯ç™»å ´é †ï¼ˆé…åˆ—ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼‰ã§æ±ºå®š
                    return raceData.horses.indexOf(a) - raceData.horses.indexOf(b);
                }
                return scoreB - scoreA;
            });
            
            // å½¹å‰²è‡ªå‹•å‰²ã‚Šå½“ã¦ï¼ˆã‚¹ã‚³ã‚¢é †ãƒ»åŒç‚¹ãªã‚‰ç™»å ´é †ï¼‰
            const mainHorse = sortedHorses[0]; // æœ€é«˜ã‚¹ã‚³ã‚¢â†’æœ¬å‘½ï¼ˆ1é ­å›ºå®šï¼‰
            const subHorse = sortedHorses[1]; // 2ç•ªç›®â†’å¯¾æŠ—ï¼ˆ1é ­å›ºå®šï¼‰
            const darkHorses = sortedHorses.slice(2, 4); // 3-4ç•ªç›®â†’å˜ç©´ï¼ˆ2é ­å›ºå®šï¼‰
            const underHorses = sortedHorses.slice(4, 8); // 5-8ç•ªç›®â†’é€£ä¸‹ï¼ˆ1-4é ­ï¼‰
            const pressHorses = sortedHorses.slice(8); // 9ç•ªç›®ä»¥é™â†’Ã—æŠ‘ãˆï¼ˆ0-4é ­ï¼‰
            
            // äº’æ›æ€§ã®ãŸã‚ã€å¾“æ¥ã®å°ã«ã‚ˆã‚‹åˆ†é¡ã‚‚ä½µç”¨
            const legacyMainHorse = raceData.horses.find(h => h.mark === 'â—');
            const legacySubHorse = raceData.horses.find(h => h.mark === 'â—‹' || h.mark === 'â—¯');
            const legacyDarkHorses = raceData.horses.filter(h => h.mark === 'â–²');

            // ã‚¹ã‚³ã‚¢ãƒ™ãƒ¼ã‚¹ï¼ˆå„ªå…ˆï¼‰ã¾ãŸã¯å¾“æ¥ã®å°ãƒ™ãƒ¼ã‚¹ã§æœ¬å‘½ã‚’è¨­å®š
            const selectedMain = mainHorse || legacyMainHorse;
            if (selectedMain) {
                horses.main = {
                    number: selectedMain.number,
                    name: selectedMain.name,
                    type: "æœ¬å‘½",
                    factors: [
                        {icon: "â˜…", text: convertToStarRating("ç·åˆè©•ä¾¡:â˜…â˜…â˜…", "æœ¬å‘½", selectedMain.score || 85)},
                        ...(selectedMain.score ? [{icon: "ğŸ¯", text: `ç´¯ç©ã‚¹ã‚³ã‚¢: ${selectedMain.score}pt`}] : [])
                    ],
                    importance: [
                        {label: "å®‰å®šæ€§", value: ((selectedMain.score || 85) + 3) / 100},
                        {label: "èƒ½åŠ›ä¸Šä½æ€§", value: ((selectedMain.score || 85) + 3) / 100},
                        {label: "å±•é–‹åˆ©", value: ((selectedMain.score || 85) - 6) / 100}
                    ]
                };
            }

            // ã‚¹ã‚³ã‚¢ãƒ™ãƒ¼ã‚¹ï¼ˆå„ªå…ˆï¼‰ã¾ãŸã¯å¾“æ¥ã®å°ãƒ™ãƒ¼ã‚¹ã§å¯¾æŠ—ã‚’è¨­å®š
            const selectedSub = subHorse || legacySubHorse;
            if (selectedSub) {
                horses.sub = {
                    number: selectedSub.number,
                    name: selectedSub.name,
                    type: "å¯¾æŠ—",
                    factors: [
                        {icon: "â˜…", text: convertToStarRating("ç·åˆè©•ä¾¡:â˜…â˜…â˜…", "å¯¾æŠ—", selectedSub.score || 85)},
                        ...(selectedSub.score ? [{icon: "ğŸ¯", text: `ç´¯ç©ã‚¹ã‚³ã‚¢: ${selectedSub.score}pt`}] : [])
                    ],
                    importance: [
                        {label: "å…ˆè¡ŒåŠ›", value: ((selectedSub.score || 85) + 8) / 100},
                        {label: "ã‚¹ãƒ”ãƒ¼ãƒ‰æŒ‡æ•°", value: ((selectedSub.score || 85) - 6) / 100},
                        {label: "æ é †å„ªä½", value: ((selectedSub.score || 85) - 2) / 100}
                    ]
                };
            }

            // â–²å°ï¼ˆå˜ç©´ï¼‰æœ€å¤§2é ­ã¾ã§å‡¦ç†
            if (darkHorses.length > 0) {
                horses.sub1 = {
                    number: darkHorses[0].number,
                    name: darkHorses[0].name,
                    type: "å˜ç©´",
                    factors: [
                        {icon: "ğŸ¯", text: `ç´¯ç©ã‚¹ã‚³ã‚¢: ${darkHorses[0].score || 75}pt`}
                    ],
                    importance: [
                        {label: "å®‰å®šæ€§", value: ((darkHorses[0].score || 75) - 5) / 100},
                        {label: "çˆ†ç™ºåŠ›", value: ((darkHorses[0].score || 75) + 5) / 100},
                        {label: "å±•é–‹åˆ©", value: (darkHorses[0].score || 75) / 100}
                    ]
                };
                
                if (darkHorses.length > 1) {
                    horses.sub2 = {
                        number: darkHorses[1].number,
                        name: darkHorses[1].name,
                        type: "å˜ç©´2",
                        factors: [
                            {icon: "ğŸ¯", text: `ç´¯ç©ã‚¹ã‚³ã‚¢: ${darkHorses[1].score || 70}pt`}
                        ],
                        importance: [
                            {label: "çˆ†ç™ºåŠ›", value: (darkHorses[1].score || 70) / 100},
                            {label: "ç©´é¦¬é©æ€§", value: (darkHorses[1].score || 70) / 100},
                            {label: "å±•é–‹åˆ©", value: (darkHorses[1].score || 70) / 100}
                        ]
                    };
                }
            }

            return horses;
        }

        function generateStrategiesForRace(raceData) {
            const mainHorses = raceData.horses.filter(h => h.mark === 'â—');
            const subHorses = raceData.horses.filter(h => h.mark === 'â—‹' || h.mark === 'â—¯');
            const darkHorses = raceData.horses.filter(h => h.mark === 'â–²');
            const underHorses = raceData.horses.filter(h => h.mark === 'â–³');
            const pressHorses = raceData.horses.filter(h => h.mark === 'Ã—'); // Ã—å°ï¼ˆæŠ¼ã•ãˆï¼‰è¿½åŠ 
            
            const main = mainHorses[0]?.number || 1;
            const subs = subHorses.map(h => h.number);
            const darks = darkHorses.map(h => h.number);
            const unders = underHorses.map(h => h.number);
            const press = pressHorses.map(h => h.number); // Ã—å°ã®é¦¬ç•ªé…åˆ—

            return {
                safe: {
                    title: "æˆ¦ç•¥A: é«˜çš„ä¸­ç‡å‹",
                    recommendation: 3,
                    hitRate: (70 + Math.random() * 15).toFixed(1),
                    returnRate: (110 + Math.random() * 30).toFixed(0),
                    riskLevel: "low",
                    bets: [
                        { type: "é¦¬å˜", horses: `${main} â†’ ${[...subs, ...darks].slice(0, 3).join(',')}`, points: `${Math.max(2, subs.length + Math.min(darks.length, 2))}ç‚¹` },
                        { type: "é¦¬é€£", horses: `${main} - ${[...subs, ...darks].slice(0, 3).join(',')}`, points: `${Math.max(2, subs.length + Math.min(darks.length, 2))}ç‚¹` },
                        { type: "3é€£è¤‡", horses: `${main}-${subs[0] || darks[0] || 2} - ${[...darks, ...unders].slice(0, 3).join(',')}`, points: "6ç‚¹" }
                    ],
                    expectedPayout: "3-6å€",
                    payoutType: "å …å®Ÿæ±ºç€æƒ³å®š"
                },
                balance: {
                    title: "æˆ¦ç•¥B: ãƒãƒ©ãƒ³ã‚¹å‹",
                    recommendation: 2,
                    hitRate: (55 + Math.random() * 15).toFixed(1),
                    returnRate: (140 + Math.random() * 40).toFixed(0),
                    riskLevel: "medium",
                    bets: [
                        { type: "é¦¬å˜", horses: `${main} â†’ ${[...subs, ...darks].join(',')}`, points: `${Math.max(3, subs.length + darks.length)}ç‚¹` },
                        { type: "3é€£è¤‡", horses: `${main},${subs[0] || darks[0] || 2}-${[...darks, ...unders].join(',')}`, points: "10ç‚¹" },
                        { type: "ãƒ¯ã‚¤ãƒ‰", horses: `${main}-${[...subs, ...darks].join(',')}`, points: `${Math.max(2, subs.length + darks.length)}ç‚¹` }
                    ],
                    expectedPayout: "6-12å€",
                    payoutType: "ä¸­ç©´é…å½“æƒ³å®š"
                },
                aggressive: {
                    title: "æˆ¦ç•¥C: é«˜é…å½“è¿½æ±‚å‹",
                    recommendation: 2,
                    hitRate: (25 + Math.random() * 20).toFixed(1),
                    returnRate: (250 + Math.random() * 200).toFixed(0),
                    riskLevel: "high",
                    bets: press.length > 0 ? [
                        // Ã—å°ãŒã‚ã‚‹å ´åˆï¼šÃ—å°ã‚’ä½¿ã£ãŸé«˜é…å½“ç‹™ã„
                        { type: "3é€£å˜", horses: `${press.slice(0,2).join(',')}â†’${main}â†’${[...subs, ...darks, ...unders].join(',')}`, points: `${Math.min(12, press.length * 4)}ç‚¹` },
                        { type: "é¦¬å˜", horses: `${press.join(',')}â†’${main},${subs[0] || darks[0] || 2}`, points: `${Math.min(8, press.length * 2)}ç‚¹` },
                        { type: "3é€£è¤‡", horses: `${press[0] || 3}-${main}-${[...darks, ...unders].join(',')}`, points: "6ç‚¹" }
                    ] : [
                        // Ã—å°ãŒãªã„å ´åˆï¼šå¾“æ¥ã®é«˜é…å½“æˆ¦ç•¥
                        { type: "3é€£å˜", horses: `${main}â†’${[...subs, ...darks].slice(0, 2).join(',')}â†’${[...darks, ...unders].join(',')}`, points: "12ç‚¹" },
                        { type: "3é€£å˜", horses: `${subs[0] || darks[0] || 2}â†’${main}â†’${[...darks, ...unders].join(',')}`, points: "8ç‚¹" },
                        { type: "é¦¬å˜", horses: `${darks[0] || 3}â†’${main},${subs[0] || 2}`, points: "2ç‚¹" }
                    ],
                    expectedPayout: press.length > 0 ? "20å€ä»¥ä¸Š" : "12å€ä»¥ä¸Š",
                    payoutType: press.length > 0 ? "å¤§ç©´ãƒ»ä¸‡é¦¬åˆ¸ç‹™ã„" : "å¤§ç©´è¦–é‡"
                }
            };
        }

        function generateAnalysisForRace(raceData) {
            const mainHorse = raceData.horses.find(h => h.mark === 'â—');
            return {
                raceExpected: `XGBoostãƒ¢ãƒ‡ãƒ«: â—${mainHorse ? mainHorse.number + mainHorse.name : 'æœ¬å‘½é¦¬'}ã®å®‰å®šæ€§ã‚’è©•ä¾¡`,
                keyIndicators: {
                    accuracy: (70 + Math.random() * 20).toFixed(1),
                    similarRaces: `${Math.floor(15 + Math.random() * 35)}ä»¶`,
                    recommendedInvestment: "è³‡é‡‘ã®1-2%"
                }
            };
        }

        function generatePreviewDataForRace(raceData) {
            const mainHorse = raceData.horses.find(h => h.mark === 'â—');
            const subHorse = raceData.horses.find(h => h.mark === 'â—‹' || h.mark === 'â—¯');
            
            return {
                summary: `æ¨å¥¨æŠ•è³‡æˆ¦ç•¥: ${mainHorse ? mainHorse.name : 'æœ¬å‘½'}${subHorse ? 'ã€' + subHorse.name : ''}ã‚’ä¸­å¿ƒã¨ã—ãŸé¦¬å˜ã€æœŸå¾…å€¤+${(5 + Math.random() * 25).toFixed(1)}%`,
                features: "ç‰¹å¾´é‡é‡è¦åº¦: å®‰å®šæ€§(0.90)ã€èƒ½åŠ›ä¸Šä½æ€§(0.85)ã€å±•é–‹åˆ©(0.75)",
                riskAnalysis: "ä¸­ãƒªã‚¹ã‚¯ã€ãƒãƒ©ãƒ³ã‚¹å‹"
            };
        }

        function generateAllHorsesDataForRace(raceData) {
            // ã‚¹ã‚³ã‚¢ãƒ™ãƒ¼ã‚¹ã§å½¹å‰²ã‚’æ±ºå®š
            const sortedHorses = [...raceData.horses].sort((a, b) => {
                const scoreA = a.score || 62;
                const scoreB = b.score || 62;
                if (scoreB === scoreA) {
                    return raceData.horses.indexOf(a) - raceData.horses.indexOf(b);
                }
                return scoreB - scoreA;
            });
            
            return raceData.horses.map(horse => {
                const index = sortedHorses.indexOf(horse);
                let type, displayMark;
                
                if (index === 0) {
                    type = 'æœ¬å‘½';
                    displayMark = 'â—';
                } else if (index === 1) {
                    type = 'å¯¾æŠ—';
                    displayMark = 'â—‹';
                } else if (index >= 2 && index <= 3) {
                    type = 'å˜ç©´';
                    displayMark = 'â–²';
                } else if (index >= 4 && index <= 7) {
                    type = 'é€£ä¸‹';
                    displayMark = 'â–³';
                } else {
                    type = 'æŠ¼ã•ãˆ';
                    displayMark = 'Ã—';
                }
                
                return {
                    number: horse.number,
                    name: horse.name,
                    mark: displayMark,
                    type: type,
                    factors: [
 
                        {icon: "â˜…", text: type === 'æŠ¼ã•ãˆ' ? "å¤§ç©´é©æ€§: é«˜å¤‰å‹•" : convertToStarRating("ç·åˆè©•ä¾¡:â˜…â˜…â˜…", type, horse.score)},
                        ...(horse.score ? [{icon: "ğŸ¯", text: `ç´¯ç©ã‚¹ã‚³ã‚¢: ${horse.score}pt`}] : [])
                    ]
                };
            });
        }

        // å¤–éƒ¨äºˆæƒ³è§£æ
        function parseExternalPrediction(text) {
            const lines = text.split('\n').map(line => line.trim()).filter(line => line);
            const result = {
                horses: [],
                raceDate: null,
                trackName: null,
                raceNumber: null,
                raceName: null,
                raceDistance: null,
                // æ–°è¦è¿½åŠ é …ç›®
                horseCount: 0,
                startTime: '',
                raceCondition: ''
            };

            // æ—¥ä»˜ã¨ç«¶é¦¬å ´æƒ…å ±ã‚’æŠ½å‡º
            const headerMatch = text.match(/(\d+\/\d+)([^\d]*?)([\dï¼-ï¼™]+)[ï¼²Rr]/i);
            if (headerMatch) {
                const [month, day] = headerMatch[1].split('/');
                const year = new Date().getFullYear();
                result.raceDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                
                const trackText = headerMatch[2];
                if (trackText.includes('å·å´')) result.trackName = 'å·å´';
                else if (trackText.includes('å¤§äº•')) result.trackName = 'å¤§äº•';
                else if (trackText.includes('èˆ¹æ©‹')) result.trackName = 'èˆ¹æ©‹';
                else if (trackText.includes('æµ¦å’Œ')) result.trackName = 'æµ¦å’Œ';

                result.raceNumber = parseInt(headerMatch[3].replace(/[ï¼-ï¼™]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0)));
            } else {
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ¬ãƒ¼ã‚¹ç•ªå·ã®ã¿ã‚’æŠ½å‡º
                const raceNumMatch = text.match(/([1-9]|1[0-2])[ï¼²Rr]/i);
                if (raceNumMatch) {
                    result.raceNumber = parseInt(raceNumMatch[1]);
                    result.trackName = 'å·å´ç«¶é¦¬'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
                } else {
                    console.warn('ãƒ¬ãƒ¼ã‚¹ç•ªå·ãŒè§£æã§ãã¾ã›ã‚“:', text.substring(0, 100));
                    // æš«å®šå€¤ã¨ã—ã¦1Rã‚’è¨­å®šï¼ˆå¾Œã§ä¸€æ‹¬å¤‰æ›ã§é©åˆ‡ãªç•ªå·ã‚’è¨­å®šï¼‰
                    result.raceNumber = 1;
                    result.trackName = 'å·å´ç«¶é¦¬';
                }
            }

            // ãƒ¬ãƒ¼ã‚¹åã¨è©³ç´°æƒ…å ±ã‚’æŠ½å‡ºï¼ˆè¤‡æ•°ãƒ‘ã‚¿ãƒ¼ãƒ³å¯¾å¿œï¼‰
            // ãƒ‘ã‚¿ãƒ¼ãƒ³1: å·å´1R 1,400mï¼ˆ11é ­ï¼‰ç™ºèµ°æ™‚åˆ»14:45 ãƒ„ã‚¯ãƒ„ã‚¯ãƒœã‚¦ã‚·è³ ï¼’æ­³(å››)
            const detailedPattern1 = text.match(/(\w+)(\d+)[ï¼²Rr]\s*([,\d]+)m[^\d]*ï¼ˆ(\d+)é ­ï¼‰[^\d]*(\d{1,2}[:ï¼š]\d{2})[^\n]*?([^\s\d]+è³?)[^\n]*?([^\n]*)/);
            
            // ãƒ‘ã‚¿ãƒ¼ãƒ³2: å·å´1R ãƒ„ã‚¯ãƒ„ã‚¯ãƒœã‚¦ã‚·è³ 1,400mï¼ˆ11é ­ï¼‰ï¼’æ­³(å››) 14:45
            const detailedPattern2 = text.match(/(\w+)(\d+)[ï¼²Rr]\s*([^\s\d]+è³?)[^\d]*([,\d]+)m[^\d]*ï¼ˆ(\d+)é ­ï¼‰[^\n]*?([^\d]*?)(\d{1,2}[:ï¼š]\d{2})/);
            
            // ãƒ‘ã‚¿ãƒ¼ãƒ³3: è·é›¢ã®ã¿æŠ½å‡º 1400m ã¾ãŸã¯ 1,400m
            const distancePattern = text.match(/(\d{1,2}[,]?\d{3})m/);
            
            // ãƒ‘ã‚¿ãƒ¼ãƒ³4: é ­æ•°ã®ã¿æŠ½å‡º ï¼ˆ11é ­ï¼‰
            const horseCountPattern = text.match(/ï¼ˆ(\d+)é ­ï¼‰/);
            
            // ãƒ‘ã‚¿ãƒ¼ãƒ³5: ç™ºèµ°æ™‚åˆ»ã®ã¿æŠ½å‡º 14:45
            const startTimePattern = text.match(/(\d{1,2}[:ï¼š]\d{2})/);

            if (detailedPattern1) {
                result.raceDistance = detailedPattern1[3] || '';
                result.horseCount = parseInt(detailedPattern1[4]) || 0;
                result.startTime = detailedPattern1[5] || '';
                result.raceName = detailedPattern1[6] || '';
                result.raceCondition = detailedPattern1[7] || '';
            } else if (detailedPattern2) {
                result.raceName = detailedPattern2[3] || '';
                result.raceDistance = detailedPattern2[4] || '';
                result.horseCount = parseInt(detailedPattern2[5]) || 0;
                result.raceCondition = detailedPattern2[6] || '';
                result.startTime = detailedPattern2[7] || '';
            } else {
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šã‚·ãƒ³ãƒ—ãƒ«ãªãƒ¬ãƒ¼ã‚¹åæŠ½å‡º
                const raceNameMatch = text.match(/\d+[ï¼²Rr]\s+([^\nâ—â—‹â–²â–³Ã—â˜†â˜…]+)/i);
                if (raceNameMatch) {
                    result.raceName = raceNameMatch[1].trim();
                }
                
                // å€‹åˆ¥ã«è©³ç´°æƒ…å ±ã‚’æŠ½å‡º
                if (distancePattern) {
                    result.raceDistance = distancePattern[1];
                }
                if (horseCountPattern) {
                    result.horseCount = parseInt(horseCountPattern[1]);
                }
                if (startTimePattern) {
                    result.startTime = startTimePattern[1];
                }
            }

            // é¦¬æƒ…å ±ã‚’æŠ½å‡ºï¼ˆè¤‡æ•°ãƒ‘ã‚¿ãƒ¼ãƒ³ã«å¯¾å¿œã€Ã—å°ã‚‚å«ã‚€ï¼‰
            const horsePatterns = [
                /([â—â—‹â—¯â–²â–³Ã—â˜†â˜…])\s*([ï¼-ï¼™0-9]+)\s*(.+?)(?=[\nâ—â—‹â—¯â–²â–³Ã—â˜†â˜…]|$)/g,
                /([â—â—‹â—¯â–²â–³Ã—â˜†â˜…])([ï¼-ï¼™0-9]+)(.+?)(?=[\nâ—â—‹â—¯â–²â–³Ã—â˜†â˜…]|$)/g,
                /([â—â—‹â—¯â–²â–³Ã—â˜†â˜…])\s*([^\s]+)/g
            ];

            for (const pattern of horsePatterns) {
                const matches = [...text.matchAll(pattern)];
                if (matches.length > 0) {
                    matches.forEach(match => {
                        const mark = match[1];
                        const numberStr = match[2] || '';
                        const name = (match[3] || match[2] || '').trim();
                        
                        // é¦¬ç•ªã‚’æŠ½å‡ºï¼ˆå…¨è§’â†’åŠè§’å¤‰æ›ï¼‰
                        const number = parseInt(numberStr.replace(/[ï¼-ï¼™]/g, s => 
                            String.fromCharCode(s.charCodeAt(0) - 0xFEE0)
                        )) || result.horses.length + 1;

                        if (name && !name.match(/^[ï¼-ï¼™0-9]+$/)) {
                            result.horses.push({ mark, number, name: name.replace(/^[ï¼-ï¼™0-9]+/, '') });
                        }
                    });
                    if (result.horses.length > 0) break;
                }
            }
            
            // å°ã®é ­æ•°åˆ¶é™ã‚’é©ç”¨
            // â—:1é ­ã€â—‹:1é ­ã€â–²:æœ€å¤§2é ­ã€â–³:æœ€å¤§4é ­ã€Ã—:æœ€å¤§6é ­
            const limitedHorses = [];
            const counts = { 'â—': 0, 'â—‹': 0, 'â—¯': 0, 'â–²': 0, 'â–³': 0, 'Ã—': 0 };
            const limits = { 'â—': 1, 'â—‹': 1, 'â—¯': 1, 'â–²': 2, 'â–³': 4, 'Ã—': 6 };
            
            result.horses.forEach(horse => {
                const mark = horse.mark === 'â—¯' ? 'â—‹' : horse.mark; // â—¯ã‚’â—‹ã«çµ±ä¸€
                if (counts[mark] !== undefined && counts[mark] < (limits[mark] || 99)) {
                    limitedHorses.push(horse);
                    counts[mark]++;
                }
            });
            result.horses = limitedHorses;

            const mainCount = result.horses.filter(h => h.mark === 'â—').length;
            const subCount = result.horses.filter(h => h.mark === 'â—‹' || h.mark === 'â—¯').length;
            if (mainCount === 1 && subCount <= 2) {
            } else if (mainCount === 1) {
            } else {
            }

            return result;
        }

        // é¦¬ã®æ–°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ factors ç”Ÿæˆï¼ˆç´¯ç©ã‚¹ã‚³ã‚¢ã®ã¿ï¼‰
        function generateHorseFactors(horse) {
            return [
                {icon: "ğŸ¯", text: `ç´¯ç©ã‚¹ã‚³ã‚¢: ${horse.score || 65}pt`}
            ];
        }


        function generateHorsesData() {
            const horses = {};
            const mainHorse = parsedPredictionData.horses.find(h => h.mark === 'â—');
            const subHorse = parsedPredictionData.horses.find(h => h.mark === 'â—‹' || h.mark === 'â—¯');
            const darkHorse = parsedPredictionData.horses.find(h => h.mark === 'â–²');

            if (mainHorse) {
                horses.main = {
                    number: mainHorse.number,
                    name: mainHorse.name,
                    type: "æœ¬å‘½",
                    factors: [
                        {icon: "â˜…", text: convertToStarRating("ç·åˆè©•ä¾¡:â˜…â˜…â˜…", "æœ¬å‘½", mainHorse.score || 85)},
                        {icon: "ğŸ¯", text: `ç´¯ç©ã‚¹ã‚³ã‚¢: ${mainHorse.score || 85}pt`}
                    ],
                    importance: [
                        {label: "å®‰å®šæ€§", value: ((mainHorse.score || 85) + 3) / 100},
                        {label: "èƒ½åŠ›ä¸Šä½æ€§", value: ((mainHorse.score || 85) + 3) / 100},
                        {label: "å±•é–‹åˆ©", value: ((mainHorse.score || 85) - 6) / 100}
                    ]
                };
            }

            if (subHorse) {
                horses.sub = {
                    number: subHorse.number,
                    name: subHorse.name,
                    type: "å¯¾æŠ—",
                    factors: [
                        {icon: "â˜…", text: convertToStarRating("ç·åˆè©•ä¾¡:â˜…â˜…â˜…", "å¯¾æŠ—", subHorse.score || 85)},
                        {icon: "ğŸ¯", text: `ç´¯ç©ã‚¹ã‚³ã‚¢: ${subHorse.score || 85}pt`}
                    ],
                    importance: [
                        {label: "å…ˆè¡ŒåŠ›", value: ((subHorse.score || 85) + 8) / 100},
                        {label: "ã‚¹ãƒ”ãƒ¼ãƒ‰æŒ‡æ•°", value: ((subHorse.score || 85) - 6) / 100},
                        {label: "æ é †å„ªä½", value: ((subHorse.score || 85) - 2) / 100}
                    ]
                };
            }

            if (darkHorse) {
                horses.dark = {
                    number: darkHorse.number,
                    name: darkHorse.name,
                    type: "å˜ç©´",
                    factors: [
                        {icon: "ğŸ¯", text: `ç´¯ç©ã‚¹ã‚³ã‚¢: ${darkHorse.score || 75}pt`}
                    ],
                    importance: [
                        {label: "å®‰å®šæ€§", value: ((darkHorse.score || 75) - 5) / 100},
                        {label: "çˆ†ç™ºåŠ›", value: ((darkHorse.score || 75) + 5) / 100},
                        {label: "å±•é–‹åˆ©", value: (darkHorse.score || 75) / 100}
                    ]
                };
            }

            return horses;
        }

        // æŠ•è³‡æˆ¦ç•¥ã‚’è‡ªå‹•ç”Ÿæˆ
        function generateStrategies(parsed) {
            const mainHorses = parsed.horses.filter(h => h.mark === 'â—');
            const subHorses = parsed.horses.filter(h => h.mark === 'â—‹' || h.mark === 'â—¯');
            const darkHorses = parsed.horses.filter(h => h.mark === 'â–²');
            const underHorses = parsed.horses.filter(h => h.mark === 'â–³');
            
            const main = mainHorses[0]?.number || 1;
            const subs = subHorses.map(h => h.number);
            const darks = darkHorses.map(h => h.number);
            const unders = underHorses.map(h => h.number);

            return {
                safe: {
                    title: "æˆ¦ç•¥A: é«˜çš„ä¸­ç‡å‹",
                    recommendation: 4,
                    hitRate: (75 + Math.random() * 10).toFixed(1),
                    returnRate: (120 + Math.random() * 30).toFixed(0),
                    riskLevel: "low",
                    bets: [
                        { type: "é¦¬å˜", horses: `${main} â†’ ${[...subs, ...darks].slice(0, 3).join(',')}`, points: `${subs.length + Math.min(darks.length, 2)}ç‚¹` },
                        { type: "é¦¬é€£", horses: `${main} - ${[...subs, ...darks].slice(0, 3).join(',')}`, points: `${subs.length + Math.min(darks.length, 2)}ç‚¹` },
                        { type: "3é€£è¤‡", horses: `${main}-${subs[0] || darks[0]} - ${[...darks, ...unders].slice(0, 3).join(',')}`, points: "6ç‚¹" }
                    ],
                    expectedPayout: "3-6å€",
                    payoutType: "å …å®Ÿæ±ºç€æƒ³å®š"
                },
                balance: {
                    title: "æˆ¦ç•¥B: ãƒãƒ©ãƒ³ã‚¹å‹",
                    recommendation: 3,
                    hitRate: (60 + Math.random() * 10).toFixed(1),
                    returnRate: (160 + Math.random() * 40).toFixed(0),
                    riskLevel: "medium",
                    bets: [
                        { type: "é¦¬å˜", horses: `${main} â†’ ${[...subs, ...darks].join(',')}`, points: `${subs.length + darks.length}ç‚¹` },
                        { type: "3é€£è¤‡", horses: `${main},${subs[0] || darks[0]}-${[...darks, ...unders].join(',')}`, points: "10ç‚¹" },
                        { type: "ãƒ¯ã‚¤ãƒ‰", horses: `${main}-${[...subs, ...darks].join(',')}`, points: `${subs.length + darks.length}ç‚¹` }
                    ],
                    expectedPayout: "6-12å€",
                    payoutType: "ä¸­ç©´é…å½“æƒ³å®š"
                },
                aggressive: {
                    title: "æˆ¦ç•¥C: é«˜é…å½“è¿½æ±‚å‹",
                    recommendation: 2,
                    hitRate: (35 + Math.random() * 15).toFixed(1),
                    returnRate: (280 + Math.random() * 120).toFixed(0),
                    riskLevel: "high",
                    bets: [
                        { type: "3é€£å˜", horses: `${main}â†’${[...subs, ...darks].slice(0, 2).join(',')}â†’${[...darks, ...unders].join(',')}`, points: "12ç‚¹" },
                        { type: "3é€£å˜", horses: `${subs[0] || darks[0]}â†’${main}â†’${[...darks, ...unders].join(',')}`, points: "8ç‚¹" },
                        { type: "é¦¬å˜", horses: `${darks[0] || 3}â†’${main},${subs[0] || 2}`, points: "2ç‚¹" }
                    ],
                    expectedPayout: "15å€ä»¥ä¸Š",
                    payoutType: "å¤§ç©´è¦–é‡"
                }
            };
        }

        function generateAnalysis(parsed) {
            const mainHorse = parsed.horses.find(h => h.mark === 'â—');
            return {
                raceExpected: `XGBoostãƒ¢ãƒ‡ãƒ«: â—${mainHorse ? mainHorse.number + mainHorse.name : 'æœ¬å‘½é¦¬'}ã®å®‰å®šæ€§ã‚’è©•ä¾¡`,
                keyIndicators: {
                    accuracy: (75 + Math.random() * 15).toFixed(1),
                    similarRaces: `${Math.floor(20 + Math.random() * 30)}ä»¶`,
                    recommendedInvestment: "è³‡é‡‘ã®2-4%"
                }
            };
        }

        function generatePreviewData(parsed) {
            const mainHorse = parsed.horses.find(h => h.mark === 'â—');
            const subHorse = parsed.horses.find(h => h.mark === 'â—‹' || h.mark === 'â—¯');
            
            return {
                summary: `æ¨å¥¨æŠ•è³‡æˆ¦ç•¥: ${mainHorse ? mainHorse.name : 'æœ¬å‘½'}${subHorse ? 'ã€' + subHorse.name : ''}ã‚’ä¸­å¿ƒã¨ã—ãŸé¦¬å˜ã€æœŸå¾…å€¤+${(10 + Math.random() * 20).toFixed(1)}%`,
                features: "ç‰¹å¾´é‡é‡è¦åº¦: å®‰å®šæ€§(0.95)ã€èƒ½åŠ›ä¸Šä½æ€§(0.88)ã€å±•é–‹åˆ©(0.82)",
                riskAnalysis: "ä¸­ãƒªã‚¹ã‚¯ã€ãƒãƒ©ãƒ³ã‚¹å‹"
            };
        }

        function generateAllHorsesData() {
            return parsedPredictionData.horses.map(horse => ({
                number: horse.number,
                name: horse.name,
                mark: horse.mark,
                type: horse.mark === 'â—' ? 'æœ¬å‘½' : 
                      horse.mark === 'â—‹' || horse.mark === 'â—¯' ? 'å¯¾æŠ—' : 
                      horse.mark === 'â–²' ? 'å˜ç©´' : 
                      horse.mark === 'â–³' ? 'é€£ä¸‹' : 'æŠ¼ã•ãˆ',
                factors: [{icon: "â˜…", text: convertToStarRating("ç·åˆè©•ä¾¡:â˜…â˜…â˜…", horse.mark === 'â—' ? 'æœ¬å‘½' : horse.mark === 'â—‹' || horse.mark === 'â—¯' ? 'å¯¾æŠ—' : horse.mark === 'â–²' ? 'å˜ç©´' : horse.mark === 'â–³' ? 'é€£ä¸‹' : 'æŠ¼ã•ãˆ', horse.score)}]
            }));
        }

        // ===== å€‹åˆ¥ãƒ¬ãƒ¼ã‚¹ç·¨é›†æ©Ÿèƒ½ =====
        window.editRace = function(raceNumber) {
            currentEditingRace = raceNumber;
            
            // ãƒ¬ãƒ¼ã‚¹ç·¨é›†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
            const editSection = document.getElementById('race-edit-section');
            editSection.style.display = 'block';
            
            // ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°
            const title = document.getElementById('race-edit-title');
            const tierMap = {
                '1R': 'premium', '2R': 'premium', '3R': 'premium', '4R': 'premium', '5R': 'premium',
                '6R': 'premium', '7R': 'premium', '8R': 'premium', '9R': 'premium',
                '10R': 'standard', '11R': 'ãƒ¡ã‚¤ãƒ³ãƒ»free', '12R': 'standard'
            };
            title.textContent = `ç·¨é›†ä¸­: ${raceNumber} (${tierMap[raceNumber] || 'unknown'})`;
            
            // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯èª­ã¿è¾¼ã¿
            if (allRacesData && allRacesData.races) {
                const existingRace = allRacesData.races.find(r => r.raceNumber === raceNumber);
                if (existingRace) {
                    loadRaceDataToForm(existingRace);
                } else {
                    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
                    loadDefaultRaceData(raceNumber);
                }
            } else {
                loadDefaultRaceData(raceNumber);
            }
            
            logAllRaces(`ğŸ¯ ${raceNumber}ã®è©³ç´°ç·¨é›†ã‚’é–‹å§‹ã—ã¾ã—ãŸ`);
            
            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ç·¨é›†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«ç§»å‹•
            editSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        };

        function loadRaceDataToForm(raceData) {
            // ãƒ¬ãƒ¼ã‚¹åŸºæœ¬æƒ…å ±ã‚’èª­ã¿è¾¼ã¿
            document.getElementById('edit-race-name').value = raceData.raceName || '';
            document.getElementById('edit-ability-index').value = raceData.raceInfo?.abilityIndex || '';
            document.getElementById('edit-recommendation').value = raceData.raceInfo?.recommendation || 'B+';
            document.getElementById('edit-expected-return').value = raceData.raceInfo?.expectedReturn || '';
            
            // é¦¬æƒ…å ±ã‚’èª­ã¿è¾¼ã¿
            if (raceData.horses?.main) {
                document.getElementById('edit-main-number').value = raceData.horses.main.number || '';
                document.getElementById('edit-main-name').value = raceData.horses.main.name || '';
            }
            
            if (raceData.horses?.sub1) {
                document.getElementById('edit-sub1-number').value = raceData.horses.sub1.number || '';
                document.getElementById('edit-sub1-name').value = raceData.horses.sub1.name || '';
            }
            
            if (raceData.horses?.sub2) {
                document.getElementById('edit-sub2-number').value = raceData.horses.sub2.number || '';
                document.getElementById('edit-sub2-name').value = raceData.horses.sub2.name || '';
            }
        }

        function loadDefaultRaceData(raceNumber) {
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
            const raceNum = parseInt(raceNumber.replace('R', ''));
            
            document.getElementById('edit-race-name').value = `ã‚µãƒ©ç³»3æ­³ä»¥ä¸Š`;
            document.getElementById('edit-ability-index').value = (75 + Math.random() * 20).toFixed(1);
            document.getElementById('edit-recommendation').value = raceNum === 11 ? 'A+' : 'B+';
            document.getElementById('edit-expected-return').value = (120 + Math.random() * 50).toFixed(0);
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé¦¬æƒ…å ±
            document.getElementById('edit-main-number').value = Math.floor(Math.random() * 12) + 1;
            document.getElementById('edit-main-name').value = `æœ¬å‘½é¦¬${raceNum}`;
            
            document.getElementById('edit-sub1-number').value = Math.floor(Math.random() * 12) + 1;
            document.getElementById('edit-sub1-name').value = `å¯¾æŠ—é¦¬${raceNum}`;
            
            document.getElementById('edit-sub2-number').value = Math.floor(Math.random() * 12) + 1;
            document.getElementById('edit-sub2-name').value = `å˜ç©´é¦¬${raceNum}`;
        }

        window.saveRaceEdit = function() {
            if (!currentEditingRace) {
                showAlert('ç·¨é›†ä¸­ã®ãƒ¬ãƒ¼ã‚¹ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }
            
            try {
                // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const raceData = {
                    raceNumber: currentEditingRace,
                    raceName: document.getElementById('edit-race-name').value,
                    tier: getRaceTier(parseInt(currentEditingRace.replace('R', ''))),
                    isMainRace: isMainRace(parseInt(currentEditingRace.replace('R', ''))),
                    displayOrder: parseInt(currentEditingRace.replace('R', '')),
                    raceInfo: {
                        title: `å·å´${currentEditingRace} ${document.getElementById('edit-race-name').value}`,
                        date: new Date().toISOString().split('T')[0],
                        track: "å·å´ç«¶é¦¬",
                        raceNumber: currentEditingRace,
                        raceName: document.getElementById('edit-race-name').value,
                        abilityIndex: document.getElementById('edit-ability-index').value,
                        recommendation: document.getElementById('edit-recommendation').value,
                        expectedReturn: document.getElementById('edit-expected-return').value
                    },
                    horses: {
                        main: {
                            number: parseInt(document.getElementById('edit-main-number').value),
                            name: document.getElementById('edit-main-name').value,
                            type: 'æœ¬å‘½',
                        },
                        sub1: {
                            number: parseInt(document.getElementById('edit-sub1-number').value),
                            name: document.getElementById('edit-sub1-name').value,
                            type: 'å¯¾æŠ—',
                        },
                        sub2: {
                            number: parseInt(document.getElementById('edit-sub2-number').value),
                            name: document.getElementById('edit-sub2-name').value,
                            type: 'å˜ç©´',
                        }
                    }
                };
                
                // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                if (!allRacesData) {
                    allRacesData = {
                        raceDate: new Date().toISOString().split('T')[0],
                        track: "å·å´ç«¶é¦¬",
                        totalRaces: 12,
                        races: []
                    };
                }
                
                // æ—¢å­˜ãƒ¬ãƒ¼ã‚¹ã‚’æ›´æ–°ã¾ãŸã¯æ–°è¦è¿½åŠ 
                const existingIndex = allRacesData.races.findIndex(r => r.raceNumber === currentEditingRace);
                if (existingIndex >= 0) {
                    allRacesData.races[existingIndex] = raceData;
                } else {
                    allRacesData.races.push(raceData);
                }
                
                // ã‚½ãƒ¼ãƒˆ
                allRacesData.races.sort((a, b) => a.displayOrder - b.displayOrder);
                
                updateRaceStatus();
                logAllRaces(`âœ… ${currentEditingRace}ã®å¤‰æ›´ã‚’ä¿å­˜ã—ã¾ã—ãŸ`);
                showAlert(`${currentEditingRace}ã®å¤‰æ›´ã‚’ä¿å­˜ã—ã¾ã—ãŸ`, 'success');
                
            } catch (error) {
                console.error('ãƒ¬ãƒ¼ã‚¹ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                showAlert('ãƒ¬ãƒ¼ã‚¹ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                logAllRaces(`âŒ ${currentEditingRace}ã®ä¿å­˜ã«å¤±æ•—: ${error.message}`);
            }
        };

        window.cancelRaceEdit = function() {
            document.getElementById('race-edit-section').style.display = 'none';
            currentEditingRace = null;
            logAllRaces('âŒ ãƒ¬ãƒ¼ã‚¹ç·¨é›†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
        };

        window.resetRaceToDefault = function() {
            if (!currentEditingRace) return;
            
            if (confirm(`${currentEditingRace}ã®è¨­å®šã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ`)) {
                loadDefaultRaceData(currentEditingRace);
                logAllRaces(`ğŸ”„ ${currentEditingRace}ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã«æˆ»ã—ã¾ã—ãŸ`);
                showAlert(`${currentEditingRace}ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã—ã¾ã—ãŸ`, 'success');
            }
        };

        // ===== ãã®ä»–ã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° =====
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const text = element.value || element.textContent;
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    showAlert('ğŸ“‹ JSONãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'success');
                }).catch((err) => {
                    console.error('Clipboard copy failed:', err);
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: å¤ã„æ–¹æ³•ã‚’è©¦è¡Œ
                    fallbackCopyTextToClipboard(element, text);
                });
            } else {
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: å¤ã„æ–¹æ³•
                fallbackCopyTextToClipboard(element, text);
            }
        }
        
        function fallbackCopyTextToClipboard(element, text) {
            element.select();
            element.setSelectionRange(0, 99999); // ãƒ¢ãƒã‚¤ãƒ«ç”¨
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showAlert('ğŸ“‹ JSONãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'success');
                } else {
                    showAlert('âŒ ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§é¸æŠã—ã¦ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„', 'error');
                }
            } catch (err) {
                console.error('Fallback copy failed:', err);
                showAlert('âŒ ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§é¸æŠã—ã¦ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„', 'error');
            }
        }

        function downloadJson() {
            if (!allRacesData) {
                showAlert('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }

            const jsonString = JSON.stringify(allRacesData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'allRacesPrediction.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showAlert('JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’src/data/allRacesPrediction.jsonã«ä¿å­˜ã—ã¦ãã ã•ã„', 'success');
        }

        // ===== ãƒ¬ãƒ¼ã‚¹è¨­å®šæ¤œè¨¼é–¢æ•° =====
        function validateRaceConfiguration(data) {
            const errors = [];
            
            // 11RãŒãƒ¡ã‚¤ãƒ³ãƒ¬ãƒ¼ã‚¹ã‹ãƒã‚§ãƒƒã‚¯
            const race11 = data.races?.find(r => r.raceNumber === '11R');
            if (race11) {
                if (race11.tier !== 'free') {
                    errors.push('âŒ ã‚¨ãƒ©ãƒ¼: 11RãŒfreeã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆç¾åœ¨: ' + race11.tier + 'ï¼‰');
                }
                if (!race11.isMainRace) {
                    errors.push('âŒ ã‚¨ãƒ©ãƒ¼: 11Rã®isMainRaceãŒtrueã§ã¯ã‚ã‚Šã¾ã›ã‚“');
                }
            }
            
            // 12RãŒèª¤ã£ã¦freeã«ãªã£ã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯
            const race12 = data.races?.find(r => r.raceNumber === '12R');
            if (race12) {
                if (race12.tier === 'free') {
                    errors.push('âŒ é‡å¤§ã‚¨ãƒ©ãƒ¼: 12RãŒç„¡æ–™è¨­å®šã«ãªã£ã¦ã„ã¾ã™ï¼12Rã¯standardã§ã™ï¼');
                }
                if (race12.isMainRace) {
                    errors.push('âŒ é‡å¤§ã‚¨ãƒ©ãƒ¼: 12RãŒãƒ¡ã‚¤ãƒ³ãƒ¬ãƒ¼ã‚¹ã«ãªã£ã¦ã„ã¾ã™ï¼11RãŒãƒ¡ã‚¤ãƒ³ã§ã™ï¼');
                }
            }
            
            // planAccessã®ãƒã‚§ãƒƒã‚¯
            if (data.planAccess?.free?.races) {
                if (data.planAccess.free.races.includes('12R')) {
                    errors.push('âŒ ã‚¨ãƒ©ãƒ¼: planAccess.free.racesã«12RãŒå«ã¾ã‚Œã¦ã„ã¾ã™');
                }
                if (!data.planAccess.free.races.includes('11R')) {
                    errors.push('âŒ ã‚¨ãƒ©ãƒ¼: planAccess.free.racesã«11RãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                }
            }
            
            if (errors.length > 0) {
                console.error('ãƒ¬ãƒ¼ã‚¹è¨­å®šæ¤œè¨¼ã‚¨ãƒ©ãƒ¼:');
                errors.forEach(err => {
                    console.error(err);
                    logAllRaces(err);
                });
                showAlert('ãƒ¬ãƒ¼ã‚¹è¨­å®šã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'error');
                return false;
            }
            
            console.log('âœ… ãƒ¬ãƒ¼ã‚¹è¨­å®šæ¤œè¨¼: æ­£å¸¸');
            return true;
        }

        // ===== å€‹åˆ¥ãƒ¬ãƒ¼ã‚¹ç·¨é›†æ©Ÿèƒ½ =====
        window.editRace = function(raceNumber) {
            if (!allRacesData || !allRacesData.races) {
                showAlert('å…ˆã«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„', 'error');
                return;
            }

            const race = allRacesData.races.find(r => r.raceNumber === raceNumber + 'R');
            if (!race) {
                showAlert(`${raceNumber}Rã®ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`, 'error');
                return;
            }

            currentEditingRace = race;
            
            // ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã«å€¤ã‚’è¨­å®š
            document.getElementById('edit-race-name').value = race.raceName || '';
            document.getElementById('edit-ability-index').value = race.raceInfo?.abilityIndex || '';
            document.getElementById('edit-recommendation').value = race.raceInfo?.recommendation || 'A';
            document.getElementById('edit-expected-return').value = race.raceInfo?.expectedReturn || '';
            
            // é¦¬æƒ…å ±è¨­å®š
            if (race.horses?.main) {
                document.getElementById('edit-main-number').value = race.horses.main.number || '';
                document.getElementById('edit-main-name').value = race.horses.main.name || '';
            }
            
            if (race.horses?.sub) {
                document.getElementById('edit-sub1-number').value = race.horses.sub.number || '';
                document.getElementById('edit-sub1-name').value = race.horses.sub.name || '';
            }
            
            if (race.horses?.sub1) {
                document.getElementById('edit-sub2-number').value = race.horses.sub1.number || '';
                document.getElementById('edit-sub2-name').value = race.horses.sub1.name || '';
            }
            
            // ç·¨é›†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
            document.getElementById('race-edit-section').style.display = 'block';
            document.getElementById('race-edit-title').textContent = `ç·¨é›†ä¸­: ${raceNumber}R ${race.raceName || ''}`;
            
            // ç·¨é›†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            document.getElementById('race-edit-section').scrollIntoView({ behavior: 'smooth' });
            
            logAllRaces(`ğŸ“ ${raceNumber}R ã®ç·¨é›†ã‚’é–‹å§‹`);
        };

        window.saveRaceEdit = function() {
            if (!currentEditingRace) {
                showAlert('ç·¨é›†ä¸­ã®ãƒ¬ãƒ¼ã‚¹ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }

            try {
                // ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰å€¤ã‚’å–å¾—ã—ã¦æ›´æ–°
                currentEditingRace.raceName = document.getElementById('edit-race-name').value || currentEditingRace.raceName;
                
                if (!currentEditingRace.raceInfo) {
                    currentEditingRace.raceInfo = {};
                }
                
                currentEditingRace.raceInfo.abilityIndex = document.getElementById('edit-ability-index').value || currentEditingRace.raceInfo.abilityIndex;
                currentEditingRace.raceInfo.recommendation = document.getElementById('edit-recommendation').value || currentEditingRace.raceInfo.recommendation;
                currentEditingRace.raceInfo.expectedReturn = document.getElementById('edit-expected-return').value || currentEditingRace.raceInfo.expectedReturn;
                
                // ãƒ¬ãƒ¼ã‚¹åã®æ›´æ–°ã‚’raceInfoã®titleã¨raceNameã«ã‚‚åæ˜ 
                currentEditingRace.raceInfo.raceName = currentEditingRace.raceName;
                currentEditingRace.raceInfo.title = `${allRacesData.track.replace('ç«¶é¦¬', '')}${currentEditingRace.raceNumber} ${currentEditingRace.raceName}`;
                
                // é¦¬æƒ…å ±æ›´æ–°
                if (currentEditingRace.horses?.main) {
                    const mainNumber = document.getElementById('edit-main-number').value;
                    const mainName = document.getElementById('edit-main-name').value;
                    
                    if (mainNumber) currentEditingRace.horses.main.number = parseInt(mainNumber);
                    if (mainName) currentEditingRace.horses.main.name = mainName;
                }
                
                if (currentEditingRace.horses?.sub) {
                    const subNumber = document.getElementById('edit-sub1-number').value;
                    const subName = document.getElementById('edit-sub1-name').value;
                    
                    if (subNumber) currentEditingRace.horses.sub.number = parseInt(subNumber);
                    if (subName) currentEditingRace.horses.sub.name = subName;
                }
                
                if (currentEditingRace.horses?.sub1) {
                    const sub2Number = document.getElementById('edit-sub2-number').value;
                    const sub2Name = document.getElementById('edit-sub2-name').value;
                    
                    if (sub2Number) currentEditingRace.horses.sub1.number = parseInt(sub2Number);
                    if (sub2Name) currentEditingRace.horses.sub1.name = sub2Name;
                }
                
                // lastUpdatedã‚’æ›´æ–°
                currentEditingRace.lastUpdated = new Date().toISOString();
                
                logAllRaces(`âœ… ${currentEditingRace.raceNumber} ã®å¤‰æ›´ã‚’ä¿å­˜ã—ã¾ã—ãŸ`);
                showAlert(`${currentEditingRace.raceNumber} ${currentEditingRace.raceName} ã®å¤‰æ›´ã‚’ä¿å­˜ã—ã¾ã—ãŸ`, 'success');
                
                // ç·¨é›†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º
                document.getElementById('race-edit-section').style.display = 'none';
                currentEditingRace = null;
                
                // ãƒ¬ãƒ¼ã‚¹ãƒœã‚¿ãƒ³ã‚’æ›´æ–°
                updateRaceStatus();
                
            } catch (error) {
                handleError(error, 'ãƒ¬ãƒ¼ã‚¹ä¿å­˜');
            }
        };

        window.cancelRaceEdit = function() {
            document.getElementById('race-edit-section').style.display = 'none';
            currentEditingRace = null;
            logAllRaces('âŒ ãƒ¬ãƒ¼ã‚¹ç·¨é›†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
        };

        window.resetRaceToDefault = function() {
            if (!currentEditingRace) {
                showAlert('ç·¨é›†ä¸­ã®ãƒ¬ãƒ¼ã‚¹ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }

            const raceNumber = parseInt(currentEditingRace.raceNumber.replace('R', ''));
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã§ä¸Šæ›¸ã
            currentEditingRace.raceName = getDefaultRaceName(raceNumber);
            currentEditingRace.raceInfo.raceName = currentEditingRace.raceName;
            currentEditingRace.raceInfo.title = `${allRacesData.track.replace('ç«¶é¦¬', '')}${currentEditingRace.raceNumber} ${currentEditingRace.raceName}`;
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’åæ˜ 
            document.getElementById('edit-race-name').value = currentEditingRace.raceName;
            
            logAllRaces(`ğŸ”„ ${currentEditingRace.raceNumber} ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã«æˆ»ã—ã¾ã—ãŸ`);
            showAlert('ãƒ¬ãƒ¼ã‚¹æƒ…å ±ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã—ã¾ã—ãŸ', 'warning');
        };

        // ===== å¤–éƒ¨äºˆæƒ³ä¸€æ‹¬å¤‰æ›æ©Ÿèƒ½ =====
        window.convertAllRaces = function() {
            const inputText = document.getElementById('external_prediction').value.trim();
            
            if (!inputText) {
                showAlert('å¤–éƒ¨äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            try {
                showConversionProgress('ğŸ”„ å¤–éƒ¨äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ã®è§£æã‚’é–‹å§‹...');
                
                // å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã‚’è§£æ
                const parsedData = parseAllRacesFromInput(inputText);
                
                if (!parsedData.races || parsedData.races.length === 0) {
                    throw new Error('æœ‰åŠ¹ãªãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                }

                showConversionProgress(`ğŸ“Š ${parsedData.races.length}ãƒ¬ãƒ¼ã‚¹ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œå‡ºã—ã¾ã—ãŸ`);
                
                // AIäºˆæƒ³å½¢å¼ã«å¤‰æ›
                const allRacesData = convertToAIPredictionFormat(parsedData);
                
                // JSONã‚’ç”Ÿæˆãƒ»è¡¨ç¤º
                const jsonString = JSON.stringify(allRacesData, null, 2);
                document.getElementById('json-output').value = jsonString;
                document.getElementById('json-output-section').style.display = 'block';
                
                // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ã‚‚ä¿å­˜
                window.allRacesData = allRacesData;
                
                showConversionProgress(`âœ… å®Œäº†ï¼å…¨${parsedData.races.length}ãƒ¬ãƒ¼ã‚¹ã®AIäºˆæƒ³JSONã‚’ç”Ÿæˆã—ã¾ã—ãŸ`);
                showAlert(`å¤–éƒ¨äºˆæƒ³ã‚’æ­£å¸¸ã«AIäºˆæƒ³å½¢å¼ã«å¤‰æ›ã—ã¾ã—ãŸï¼ˆ${parsedData.races.length}ãƒ¬ãƒ¼ã‚¹ï¼‰`, 'success');
                
                // æ–°ã‚·ã‚¹ãƒ†ãƒ ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã™
                if (typeof setGeneratedData === 'function') {
                    setGeneratedData(allRacesData);
                }
                
                updateRaceStatus();
                
            } catch (error) {
                console.error('å¤‰æ›ã‚¨ãƒ©ãƒ¼:', error);
                showConversionProgress(`âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                showAlert('å¤‰æ›ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
            }
        };

        window.clearConversion = function() {
            const externalInput = document.getElementById('external_prediction');
            const progressDiv = document.getElementById('conversion-progress');
            const outputSection = document.getElementById('json-output-section');

            if (externalInput) externalInput.value = '';
            if (progressDiv) progressDiv.style.display = 'none';
            if (outputSection) outputSection.style.display = 'none';

            showAlert('ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'success');
        };

        function showConversionProgress(message) {
            const progressDiv = document.getElementById('conversion-progress');
            if (!progressDiv) {
                console.warn('conversion-progress element not found in showConversionProgress');
                return;
            }

            const timestamp = new Date().toLocaleTimeString();

            if (progressDiv.style.display === 'none') {
                progressDiv.style.display = 'block';
                progressDiv.innerHTML = '';
            }

            progressDiv.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            progressDiv.scrollTop = progressDiv.scrollHeight;
        }

        // å¤–éƒ¨äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ã®ãƒ‘ãƒ¼ã‚¹ï¼ˆ1ã€œ12ãƒ¬ãƒ¼ã‚¹ä¸€æ‹¬å¯¾å¿œï¼‰
        function parseAllRacesFromInput(inputText) {
            const result = {
                races: [],
                raceDate: null,
                track: null
            };

            // è¡Œã”ã¨ã«åˆ†å‰²
            const lines = inputText.split('\n').map(line => line.trim()).filter(line => line);
            
            let currentRace = null;
            let globalDate = null;
            let globalTrack = null;

            for (const line of lines) {
                // ãƒ¬ãƒ¼ã‚¹æƒ…å ±è¡Œã®æ¤œå‡ºï¼ˆä¾‹: "8/24å·å´2R 1,200mï¼ˆ10é ­ï¼‰ç™ºèµ°æ™‚åˆ»15:20 ã‚µãƒ©ç³»3æ­³"ï¼‰
                const raceInfoMatch = line.match(/(\d+\/\d+)([^\d]*?)(\d+)R\s*([^\s]+)\s*[ï¼ˆ(](\d+)é ­[ï¼‰)]\s*ç™ºèµ°æ™‚åˆ»(\d+:\d+)\s*(.+)/);
                
                if (raceInfoMatch) {
                    // å‰ã®ãƒ¬ãƒ¼ã‚¹ã‚’ä¿å­˜
                    if (currentRace && currentRace.horses.length > 0) {
                        result.races.push(currentRace);
                    }
                    
                    // æ–°ã—ã„ãƒ¬ãƒ¼ã‚¹ã‚’é–‹å§‹
                    const [, date, track, raceNum, distance, horseCount, startTime, raceName] = raceInfoMatch;
                    
                    if (!globalDate) globalDate = convertDateFormat(date);
                    if (!globalTrack) globalTrack = extractTrackName(track);
                    
                    currentRace = {
                        raceNumber: parseInt(raceNum),
                        raceName: raceName.trim(),
                        raceDate: globalDate,
                        trackName: globalTrack,
                        raceDistance: distance.replace(/[^\d]/g, ''),
                        horseCount: parseInt(horseCount),
                        startTime: startTime,
                        horses: [],
                    };
                    
                    showConversionProgress(`ğŸ“ ${raceNum}R ${raceName} ã‚’è§£æä¸­...`);
                    continue;
                }

                // é¦¬æƒ…å ±ã®æ¤œå‡º
                // æ–°å½¢å¼: "8ç•ª â— â—‹ â–² â–² ã‚­ãƒãƒ§ã‚¦" 
                // æ—§å½¢å¼: "â—8ã‚­ãƒãƒ§ã‚¦" ã‚‚ç¶™ç¶šå¯¾å¿œ
                const newFormatMatch = line.match(/^(\d+)ç•ª\s+([â—â—‹â–²â–³Ã—\s]+)\s+(.+)/);
                const oldFormatMatch = line.match(/^([â—â—‹â–²â–³Ã—])(\d+)(.+)/);
                
                if (newFormatMatch && currentRace) {
                    const [, number, marksStr, name] = newFormatMatch;
                    const marks = marksStr.trim().split(/\s+/).filter(mark => /[â—â—‹â–²â–³Ã—]/.test(mark));
                    
                    // ç´¯ç©ã‚¹ã‚³ã‚¢è¨ˆç®—ï¼ˆãƒ™ãƒ¼ã‚¹62pt + å°ã®å€¤ï¼‰
                    const markValues = {'â—': 7, 'â—‹': 6, 'â–²': 5, 'â–³': 4, 'Ã—': 0};
                    const totalScore = 62 + marks.reduce((sum, mark) => sum + (markValues[mark] || 0), 0);
                    
                    currentRace.horses.push({
                        mark: marks[0] || 'â–³', // æœ€åˆã®å°ã‚’è¡¨ç¤ºç”¨ãƒãƒ¼ã‚¯ã¨ã—ã¦ä½¿ç”¨
                        marks: marks, // å…¨å°ã‚’ä¿å­˜
                        number: parseInt(number),
                        name: name.trim(),
                        score: totalScore
                    });
                } else if (oldFormatMatch && currentRace) {
                    // æ—§å½¢å¼å¯¾å¿œï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
                    const [, mark, number, name] = oldFormatMatch;
                    const markValues = {'â—': 7, 'â—‹': 6, 'â–²': 5, 'â–³': 4, 'Ã—': 0};
                    const totalScore = 62 + (markValues[mark] || 0);
                    
                    currentRace.horses.push({
                        mark: mark,
                        marks: [mark],
                        number: parseInt(number),
                        name: name.trim(),
                        score: totalScore
                    });
                }
            }

            // æœ€å¾Œã®ãƒ¬ãƒ¼ã‚¹ã‚’ä¿å­˜
            if (currentRace && currentRace.horses.length > 0) {
                result.races.push(currentRace);
            }

            result.raceDate = globalDate || new Date().toISOString().split('T')[0];
            result.track = globalTrack || 'å·å´ç«¶é¦¬';

            return result;
        }

        // æ—¥ä»˜å½¢å¼å¤‰æ›ï¼ˆ8/24 â†’ 2025-08-24ï¼‰
        function convertDateFormat(dateStr) {
            const [month, day] = dateStr.split('/').map(num => parseInt(num));
            const year = new Date().getFullYear();
            
            return `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
        }

        // ç«¶é¦¬å ´åæŠ½å‡º
        function extractTrackName(trackStr) {
            const trackNames = {
                'å·å´': 'å·å´ç«¶é¦¬',
                'å¤§äº•': 'å¤§äº•ç«¶é¦¬', 
                'èˆ¹æ©‹': 'èˆ¹æ©‹ç«¶é¦¬',
                'æµ¦å’Œ': 'æµ¦å’Œç«¶é¦¬'
            };
            
            for (const [key, value] of Object.entries(trackNames)) {
                if (trackStr.includes(key)) {
                    return value;
                }
            }
            
            return 'å·å´ç«¶é¦¬'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
        }

        // AIäºˆæƒ³å½¢å¼ã¸ã®å¤‰æ›
        function convertToAIPredictionFormat(parsedData) {
            const result = {
                raceDate: parsedData.raceDate,
                track: parsedData.track,
                totalRaces: parsedData.races.length,
                races: parsedData.races.map(race => generateRaceData(race, parsedData)),
                planAccess: {
                    free: { races: ["11R"] },
                    standard: { races: ["10R", "12R"] },
                    premium: { races: ["1R", "2R", "3R", "4R", "5R", "6R", "7R", "8R", "9R"] }
                },
                lastUpdated: new Date().toISOString(),
                dataVersion: "2.0",
                generatedBy: "NANKANã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ "
            };

            // ãƒ¡ã‚¤ãƒ³ãƒ¬ãƒ¼ã‚¹è¨­å®š
            const mainRace = result.races.find(r => r.raceNumber === '11R');
            if (mainRace) {
                mainRace.isMainRace = true;
            }

            return result;
        }

        // ===== åˆæœŸåŒ– =====
        document.addEventListener('DOMContentLoaded', function() {
            logAllRaces('ğŸš€ ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†');
            updateImportanceBars();
            generateRaceEditButtons(); // ãƒ¬ãƒ¼ã‚¹ç·¨é›†ãƒœã‚¿ãƒ³ã‚’å‹•çš„ç”Ÿæˆ
            
            // åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆã‚‚ã—ã‚ã‚Œã°ï¼‰
            if (allRacesData) {
                validateRaceConfiguration(allRacesData);
            }
        });
    </script>
</body>
</html>