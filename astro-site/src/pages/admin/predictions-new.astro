---
export const prerender = true;
import BaseLayout from '../../layouts/BaseLayout.astro';
---

<BaseLayout title="æ–°äºˆæƒ³ã‚·ã‚¹ãƒ†ãƒ  - å®Œæˆå½¢ãƒ‡ãƒ¼ã‚¿å…¥åŠ›" description="ãƒã‚³ã¡ã‚ƒã‚“ã®å®Œæˆå½¢ãƒ‡ãƒ¼ã‚¿å…¥åŠ›ã‚·ã‚¹ãƒ†ãƒ ">
    <div class="container">
        <div class="header-section">
            <div class="ai-badge">
                <span class="pulse"></span>
                <span class="ai-status">æ–°ã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºä¸­</span>
            </div>
            <h1>ğŸš€ æ–°äºˆæƒ³ã‚·ã‚¹ãƒ†ãƒ  - å®Œæˆå½¢ãƒ‡ãƒ¼ã‚¿å…¥åŠ›</h1>
            <p>ãƒã‚³ã¡ã‚ƒã‚“ãŒå®Œæˆå½¢ãƒ‡ãƒ¼ã‚¿ã‚’ç›´æ¥å…¥åŠ› â†’ ã‚¯ãƒ­ãŒå˜ç´”åæ˜ ã™ã‚‹ã‚·ã‚¹ãƒ†ãƒ </p>
        </div>

        <div class="form-section">
            <form id="prediction-form">
                <div class="race-info-section">
                    <h2>ğŸ“… ãƒ¬ãƒ¼ã‚¹åŸºæœ¬æƒ…å ±</h2>
                    <div class="form-group">
                        <label>é–‹å‚¬æ—¥</label>
                        <input type="date" id="race-date" name="race-date" required>
                    </div>
                    <div class="form-group">
                        <label>ç«¶é¦¬å ´</label>
                        <select id="track" name="track" required>
                            <option value="å¤§äº•ç«¶é¦¬">å¤§äº•ç«¶é¦¬</option>
                            <option value="å·å´ç«¶é¦¬">å·å´ç«¶é¦¬</option>
                            <option value="èˆ¹æ©‹ç«¶é¦¬">èˆ¹æ©‹ç«¶é¦¬</option>
                            <option value="æµ¦å’Œç«¶é¦¬">æµ¦å’Œç«¶é¦¬</option>
                        </select>
                    </div>
                </div>

                <div class="prediction-input-section">
                    <h2>ğŸ¯ å®Œæˆå½¢äºˆæƒ³ãƒ‡ãƒ¼ã‚¿å…¥åŠ›</h2>
                    <div class="input-format-guide">
                        <h3>ğŸ“ å…¥åŠ›å½¢å¼ï¼ˆä¾‹ï¼‰</h3>
                        <pre class="format-example">
å·å´1R 1400mï¼ˆ11é ­ï¼‰ç™ºèµ°æ™‚åˆ»14:45 2æ­³æ–°é¦¬

ã€æˆ¦ç•¥Aï¼šå°‘ç‚¹æ•°çš„ä¸­å‹ã€‘
é¦¬å˜ 9 â†’ 11,5,6 (3ç‚¹)
AIãƒ¢ãƒ‡ãƒ«äºˆæ¸¬: çš„ä¸­ç‡65%

ã€æˆ¦ç•¥Bï¼šãƒãƒ©ãƒ³ã‚¹å‹ã€‘
é¦¬å˜ 9 â‡” 1,2,3,4 (8ç‚¹)
é¦¬å˜ 11 â†’ 9,5,6 (3ç‚¹)
AIãƒ¢ãƒ‡ãƒ«äºˆæ¸¬: çš„ä¸­ç‡58%

ã€æˆ¦ç•¥Cï¼šé«˜é…å½“è¿½æ±‚å‹ã€‘
é¦¬å˜ 9 â†’ 7,8 (2ç‚¹)
é¦¬å˜ 11 â‡” 1,2,3,4,7,8 (12ç‚¹)
AIãƒ¢ãƒ‡ãƒ«äºˆæ¸¬: çš„ä¸­ç‡38%

â—9ç•ª æœ¬å‘½ ç´¯ç©ã‚¹ã‚³ã‚¢85pt å®‰å®šæ€§88% èƒ½åŠ›ä¸Šä½æ€§88% å±•é–‹åˆ©79%
â—‹11ç•ª å¯¾æŠ— ç´¯ç©ã‚¹ã‚³ã‚¢81pt å®‰å®šæ€§82% èƒ½åŠ›ä¸Šä½æ€§85% å±•é–‹åˆ©76%
â–²5ç•ª å˜ç©´ ç´¯ç©ã‚¹ã‚³ã‚¢78pt å®‰å®šæ€§79% èƒ½åŠ›ä¸Šä½æ€§80% å±•é–‹åˆ©73%
â–²6ç•ª å˜ç©´ ç´¯ç©ã‚¹ã‚³ã‚¢75pt å®‰å®šæ€§76% èƒ½åŠ›ä¸Šä½æ€§78% å±•é–‹åˆ©70%

é€£ä¸‹å€™è£œé¦¬: 1,2,3,4ç•ª
æŠ¼ã•ãˆå€™è£œé¦¬: 7,8ç•ª</pre>
                    </div>

                    <div class="form-group">
                        <label>å…¨ãƒ¬ãƒ¼ã‚¹äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ï¼ˆå®Œæˆå½¢ï¼‰</label>
                        <textarea id="prediction-data" name="prediction-data" rows="30" placeholder="ä¸Šè¨˜ã®å½¢å¼ã§ãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„..."></textarea>
                    </div>
                </div>

                <div class="action-buttons">
                    <button type="button" id="preview-btn" class="btn-primary">ğŸ“‹ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
                    <button type="button" id="generate-json-btn" class="btn-success">ğŸš€ JSONç”Ÿæˆ</button>
                    <button type="button" id="download-json-btn" class="btn-download" style="display: none;">ğŸ“¥ JSONãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                </div>
            </form>
        </div>

        <div id="preview-section" class="preview-section" style="display: none;">
            <h2>ğŸ‘€ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
            <div id="preview-content"></div>
        </div>

        <div id="json-output-section" class="json-section" style="display: none;">
            <h2>ğŸ“„ ç”Ÿæˆã•ã‚ŒãŸJSON</h2>
            <pre id="json-output"></pre>
        </div>
    </div>

    <script>
        let generatedJsonData = null;

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½
        document.getElementById('preview-btn').addEventListener('click', function() {
            const predictionData = document.getElementById('prediction-data').value;
            const previewSection = document.getElementById('preview-section');
            const previewContent = document.getElementById('preview-content');

            if (!predictionData.trim()) {
                alert('äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            // ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
            const races = parsePredictionData(predictionData);
            let previewHtml = '';

            races.forEach((race, index) => {
                previewHtml += `
                    <div class="race-preview">
                        <h3>${race.title}</h3>
                        <div class="race-details">
                            ${race.raceName ? `<div><strong>ãƒ¬ãƒ¼ã‚¹å:</strong> ${race.raceName}</div>` : ''}
                            ${race.startTime ? `<div><strong>ç™ºèµ°æ™‚åˆ»:</strong> ${race.startTime}</div>` : ''}
                            ${race.distance ? `<div><strong>è·é›¢:</strong> ${race.distance}</div>` : ''}
                            ${race.horseCount ? `<div><strong>é ­æ•°:</strong> ${race.horseCount}</div>` : ''}
                        </div>
                        <div class="strategies">
                            <div class="strategy">
                                <h4>ğŸ¯ å°‘ç‚¹æ•°çš„ä¸­å‹</h4>
                                <div class="bets">${race.strategyA.join('<br>')}</div>
                                ${race.aiPredictions.strategyA ? `<div class="ai-prediction">AIäºˆæ¸¬: ${race.aiPredictions.strategyA}%</div>` : ''}
                            </div>
                            <div class="strategy">
                                <h4>âš–ï¸ ãƒãƒ©ãƒ³ã‚¹å‹</h4>
                                <div class="bets">${race.strategyB.join('<br>')}</div>
                                ${race.aiPredictions.strategyB ? `<div class="ai-prediction">AIäºˆæ¸¬: ${race.aiPredictions.strategyB}%</div>` : ''}
                            </div>
                            <div class="strategy">
                                <h4>ğŸš€ é«˜é…å½“è¿½æ±‚å‹</h4>
                                <div class="bets">${race.strategyC.join('<br>')}</div>
                                ${race.aiPredictions.strategyC ? `<div class="ai-prediction">AIäºˆæ¸¬: ${race.aiPredictions.strategyC}%</div>` : ''}
                            </div>
                        </div>
                        <div class="horses">
                            <h4>é¦¬æƒ…å ±</h4>
                            <div class="horse-list">
                                ${race.horses.map(horse => {
                                    return `
                                        <div class="horse-item">
                                            <div class="horse-basic">${horse.mark}${horse.number} ${horse.name || ''} ç´¯ç©ã‚¹ã‚³ã‚¢: ${horse.score}pt</div>
                                            ${horse.features.stability ? `<div class="horse-features">ç‰¹å¾´é‡é‡è¦åº¦ å®‰å®šæ€§${horse.features.stability}% èƒ½åŠ›ä¸Šä½æ€§${horse.features.ability}% å±•é–‹åˆ©${horse.features.positioning}%</div>` : ''}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                        ${race.renzuCandidates.length > 0 ? `
                            <div class="candidates">
                                <h4>é€£ä¸‹å€™è£œé¦¬</h4>
                                <div>${race.renzuCandidates.join(', ')}</div>
                            </div>
                        ` : ''}
                        ${race.osaeCandidates.length > 0 ? `
                            <div class="candidates">
                                <h4>æŠ¼ã•ãˆå€™è£œé¦¬</h4>
                                <div>${race.osaeCandidates.join(', ')}</div>
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            previewContent.innerHTML = previewHtml;
            previewSection.style.display = 'block';
        });

        // JSONç”Ÿæˆæ©Ÿèƒ½
        document.getElementById('generate-json-btn').addEventListener('click', function() {
            const raceDate = document.getElementById('race-date').value;
            const track = document.getElementById('track').value;
            const predictionData = document.getElementById('prediction-data').value;

            if (!raceDate || !track || !predictionData.trim()) {
                alert('ã™ã¹ã¦ã®å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const races = parsePredictionData(predictionData);
            const jsonData = generateJsonData(raceDate, track, races);

            generatedJsonData = jsonData;
            document.getElementById('json-output').textContent = JSON.stringify(jsonData, null, 2);
            document.getElementById('json-output-section').style.display = 'block';
            document.getElementById('download-json-btn').style.display = 'inline-block';
        });

        // JSONãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½
        document.getElementById('download-json-btn').addEventListener('click', function() {
            if (!generatedJsonData) return;

            const blob = new Blob([JSON.stringify(generatedJsonData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `allRacesPrediction-${generatedJsonData.raceDate}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        // ãƒã‚³ã¡ã‚ƒã‚“ã®å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿å½¢å¼å¯¾å¿œãƒ‘ãƒ¼ã‚¹å‡¦ç†ï¼ˆå®Œå…¨æ–°è¨­è¨ˆï¼‰
        function parsePredictionData(data) {
            const races = [];

            // ã¾ãšã¯å…¨ãƒ‡ãƒ¼ã‚¿ã‚’è¡Œã«åˆ†è§£ã—ã¦åˆ†æ
            const allLines = data.split('\n').map(line => line.trim()).filter(line => line);
            console.log(`ğŸ“„ å…¨è¡Œæ•°: ${allLines.length}`);

            // ãƒ¬ãƒ¼ã‚¹ã®é–‹å§‹ä½ç½®ã‚’ç‰¹å®šï¼ˆãƒ¬ãƒ¼ã‚¹ç•ªå·ã‚’å«ã‚€è¡Œï¼‰
            const raceStartIndices = [];
            allLines.forEach((line, index) => {
                // ã‚ˆã‚ŠæŸ”è»Ÿãªãƒ‘ã‚¿ãƒ¼ãƒ³: å…¨è§’ãƒ»åŠè§’ãƒ¬ãƒ¼ã‚¹ç•ªå·ã‚’å«ã‚€è¡Œã‚’å…¨ã¦æ¤œå‡º
                if (line.match(/^(ï¼‘R|ï¼’R|ï¼“R|ï¼”R|ï¼•R|ï¼–R|ï¼—R|ï¼˜R|ï¼™R|ï¼‘ï¼R|ï¼‘ï¼‘R|ï¼‘ï¼’R|1R|2R|3R|4R|5R|6R|7R|8R|9R|10R|11R|12R|å¤§äº•\d{1,2}R)/i)) {
                    raceStartIndices.push(index);
                    console.log(`ğŸ¯ ãƒ¬ãƒ¼ã‚¹é–‹å§‹æ¤œå‡º: è¡Œ${index}: "${line}"`);
                }
            });

            console.log(`ğŸ æ¤œå‡ºã•ã‚ŒãŸãƒ¬ãƒ¼ã‚¹é–‹å§‹ä½ç½®: [${raceStartIndices.join(', ')}]`);

            // å„ãƒ¬ãƒ¼ã‚¹ã®ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
            for (let i = 0; i < raceStartIndices.length; i++) {
                const startIndex = raceStartIndices[i];
                const endIndex = i < raceStartIndices.length - 1 ? raceStartIndices[i + 1] : allLines.length;

                const raceLines = allLines.slice(startIndex, endIndex);
                console.log(`ğŸ‡ ãƒ¬ãƒ¼ã‚¹${i + 1}: è¡Œ${startIndex}-${endIndex - 1} (${raceLines.length}è¡Œ)`);

                const race = parseRaceData(raceLines, i + 1);
                if (race) {
                    races.push(race);
                }
            }

            console.log(`ğŸ æœ€çµ‚çµæœ: ${races.length}ãƒ¬ãƒ¼ã‚¹ã‚’æ¤œå‡ºã—ã¾ã—ãŸ`);
            return races;
        }

        // å€‹åˆ¥ãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã®ãƒ‘ãƒ¼ã‚¹å‡¦ç†
        function parseRaceData(raceLines, raceIndex) {
            const race = {
                title: '',
                raceName: '',
                startTime: '',
                distance: '',
                raceType: '',
                horseCount: '',
                strategyA: [],
                strategyB: [],
                strategyC: [],
                horses: [],
                aiPredictions: {
                    strategyA: null,
                    strategyB: null,
                    strategyC: null
                },
                renzuCandidates: [],
                osaeCandidates: []
            };

            console.log(`ğŸ“„ ãƒ¬ãƒ¼ã‚¹${raceIndex}ãƒ©ã‚¤ãƒ³æ•°: ${raceLines.length}`);

            // ãƒ¬ãƒ¼ã‚¹ç•ªå·ã‚’æ¤œå‡º
            let raceNumber = null;
            let raceNumberLine = raceLines.find(line => line.match(/^\d{1,2}R$/));

            if (raceNumberLine) {
                raceNumber = raceNumberLine;
            } else {
                // ã€Œå¤§äº•02Rã€å½¢å¼ã‚‚ãƒã‚§ãƒƒã‚¯
                const trackRaceLine = raceLines.find(line => line.match(/å¤§äº•(\d{1,2})R/));
                if (trackRaceLine) {
                    const match = trackRaceLine.match(/å¤§äº•(\d{1,2})R/);
                    raceNumber = match[1] + 'R';
                } else {
                    // æœ€åˆã®è¡Œã«æ•°å­—+RãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                    const firstLine = raceLines[0];
                    if (firstLine && firstLine.match(/(\d{1,2})R/)) {
                        const match = firstLine.match(/(\d{1,2})R/);
                        raceNumber = match[1] + 'R';
                    } else if (firstLine && firstLine.match(/(ï¼‘|ï¼’|ï¼“|ï¼”|ï¼•|ï¼–|ï¼—|ï¼˜|ï¼™|ï¼‘ï¼|ï¼‘ï¼‘|ï¼‘ï¼’)R/)) {
                        // å…¨è§’æ•°å­—ã‚’åŠè§’æ•°å­—ã«å¤‰æ›
                        const fullWidthMap = {'ï¼‘': '1', 'ï¼’': '2', 'ï¼“': '3', 'ï¼”': '4', 'ï¼•': '5', 'ï¼–': '6', 'ï¼—': '7', 'ï¼˜': '8', 'ï¼™': '9', 'ï¼‘ï¼': '10', 'ï¼‘ï¼‘': '11', 'ï¼‘ï¼’': '12'};
                        const match = firstLine.match(/(ï¼‘|ï¼’|ï¼“|ï¼”|ï¼•|ï¼–|ï¼—|ï¼˜|ï¼™|ï¼‘ï¼|ï¼‘ï¼‘|ï¼‘ï¼’)R/);
                        raceNumber = fullWidthMap[match[1]] + 'R';
                        console.log(`ğŸ”„ å…¨è§’æ•°å­—å¤‰æ›: ${match[1]}R â†’ ${raceNumber}`);
                    }
                }
            }

            if (raceNumber) {
                race.title = raceNumber;
                console.log(`ğŸ‡ ãƒ¬ãƒ¼ã‚¹æ¤œå‡º: "${raceNumber}" - å…¨ãƒ©ã‚¤ãƒ³æ•°: ${raceLines.length}`);
            } else {
                console.log(`âŒ ãƒ¬ãƒ¼ã‚¹ç•ªå·æœªæ¤œå‡º - æœ€åˆã®è¡Œ: "${raceLines[0]}", å…¨è¡Œ: [${raceLines.slice(0, 5).join(', ')}]`);
                return null;
            }

            // é¦¬æƒ…å ±ã‚’æ¤œç´¢
            let horseStartIndex = -1;
            let horseEndIndex = -1;

            for (let i = 0; i < raceLines.length; i++) {
                const line = raceLines[i];
                if (line.match(/^[â—â—‹â–²â–³Ã—]\s+\d+\s+/)) {
                    if (horseStartIndex === -1) {
                        horseStartIndex = i;
                    }
                    horseEndIndex = i;
                }
            }

            console.log(`ğŸ é¦¬æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³: ${horseStartIndex} - ${horseEndIndex}`);

            // é¦¬æƒ…å ±ã‚’ãƒ‘ãƒ¼ã‚¹ï¼ˆè¤‡æ•°è¡Œå½¢å¼å¯¾å¿œï¼‰
            if (horseStartIndex !== -1) {
                let currentHorse = null;

                for (let i = horseStartIndex; i <= horseEndIndex; i++) {
                    const line = raceLines[i];
                    console.log(`ğŸ” é¦¬æƒ…å ±è¡Œãƒã‚§ãƒƒã‚¯: "${line}"`);

                    // 1è¡Œå½¢å¼ã®é¦¬æƒ…å ±ï¼ˆâ— 11 ã‚ªãƒ¼ãƒ«ã‚¹ã‚¿ãƒ¼ã‚º æœ¬å‘½ ç·åˆè©•ä¾¡:â˜…â˜…â˜… ç´¯ç©ã‚¹ã‚³ã‚¢: 88pt ç‰¹å¾´é‡é‡è¦åº¦ å®‰å®šæ€§91% èƒ½åŠ›ä¸Šä½æ€§90% å±•é–‹åˆ©81%ï¼‰
                    const singleLineMatch = line.match(/^([â—â—‹â–²â–³Ã—])\s+(\d+)\s+(\S+)\s+.*?ç´¯ç©ã‚¹ã‚³ã‚¢[:\s]*(\d+)pt.*?å®‰å®šæ€§(\d+(?:\.\d+)?)%.*?èƒ½åŠ›ä¸Šä½æ€§(\d+(?:\.\d+)?)%.*?å±•é–‹åˆ©(\d+(?:\.\d+)?)%/);
                    if (singleLineMatch) {
                        // å‰ã®é¦¬ãŒã‚ã‚‹å ´åˆã¯ä¿å­˜
                        if (currentHorse) {
                            race.horses.push(currentHorse);
                            console.log(`ğŸ´ é¦¬è¿½åŠ : ${currentHorse.mark}${currentHorse.number} ${currentHorse.name} (${currentHorse.score}pt)`);
                        }

                        // 1è¡Œå½¢å¼ã®é¦¬æƒ…å ±ã‚’å®Œå…¨ã«å‡¦ç†ã—ã¦å³åº§ã«ä¿å­˜
                        const horseData = {
                            mark: singleLineMatch[1],
                            number: parseInt(singleLineMatch[2]),
                            name: singleLineMatch[3],
                            score: parseInt(singleLineMatch[4]),
                            features: {
                                stability: parseFloat(singleLineMatch[5]),
                                ability: parseFloat(singleLineMatch[6]),
                                positioning: parseFloat(singleLineMatch[7])
                            }
                        };
                        race.horses.push(horseData);
                        console.log(`ğŸ´ 1è¡Œå½¢å¼é¦¬è¿½åŠ : ${horseData.mark}${horseData.number} ${horseData.name} (${horseData.score}pt) å®‰å®šæ€§${horseData.features.stability}%`);
                        currentHorse = null; // ãƒªã‚»ãƒƒãƒˆ
                        continue;
                    }

                    // è¤‡æ•°è¡Œå½¢å¼ã®é¦¬ã®åŸºæœ¬æƒ…å ±è¡Œï¼ˆâ— 11 ã‚ªãƒ¼ãƒ«ã‚¹ã‚¿ãƒ¼ã‚º æœ¬å‘½ï¼‰
                    const horseBasicMatch = line.match(/^([â—â—‹â–²â–³Ã—])\s+(\d+)\s+(\S+)\s+(.*)/);
                    if (horseBasicMatch) {
                        // å‰ã®é¦¬ãŒã‚ã‚‹å ´åˆã¯ä¿å­˜
                        if (currentHorse) {
                            race.horses.push(currentHorse);
                            console.log(`ğŸ´ é¦¬è¿½åŠ : ${currentHorse.mark}${currentHorse.number} ${currentHorse.name} (${currentHorse.score}pt)`);
                        }

                        // æ–°ã—ã„é¦¬ã®æƒ…å ±ã‚’é–‹å§‹
                        currentHorse = {
                            mark: horseBasicMatch[1],
                            number: parseInt(horseBasicMatch[2]),
                            name: horseBasicMatch[3],
                            score: 0,
                            features: {}
                        };
                        console.log(`ğŸ†• æ–°ã—ã„é¦¬é–‹å§‹: ${currentHorse.mark}${currentHorse.number} ${currentHorse.name}`);
                        continue;
                    }

                    // ç´¯ç©ã‚¹ã‚³ã‚¢è¡Œ
                    const scoreMatch = line.match(/ç´¯ç©ã‚¹ã‚³ã‚¢[:\s]*(\d+)pt/);
                    if (scoreMatch && currentHorse) {
                        currentHorse.score = parseInt(scoreMatch[1]);
                        console.log(`ğŸ“Š ã‚¹ã‚³ã‚¢è¨­å®š: ${currentHorse.name} = ${currentHorse.score}pt`);
                        continue;
                    }

                    // ç‰¹å¾´é‡è¡Œï¼ˆå€‹åˆ¥è¡Œå½¢å¼ï¼‰
                    const stabilityMatch = line.match(/å®‰å®šæ€§(\d+(?:\.\d+)?)%/);
                    if (stabilityMatch && currentHorse) {
                        currentHorse.features.stability = parseFloat(stabilityMatch[1]);
                        continue;
                    }

                    const abilityMatch = line.match(/èƒ½åŠ›ä¸Šä½æ€§(\d+(?:\.\d+)?)%/);
                    if (abilityMatch && currentHorse) {
                        currentHorse.features.ability = parseFloat(abilityMatch[1]);
                        continue;
                    }

                    const positioningMatch = line.match(/å±•é–‹åˆ©(\d+(?:\.\d+)?)%/);
                    if (positioningMatch && currentHorse) {
                        currentHorse.features.positioning = parseFloat(positioningMatch[1]);
                        continue;
                    }
                }

                // æœ€å¾Œã®é¦¬ã‚’ä¿å­˜
                if (currentHorse) {
                    race.horses.push(currentHorse);
                    console.log(`ğŸ´ é¦¬è¿½åŠ : ${currentHorse.mark}${currentHorse.number} ${currentHorse.name} (${currentHorse.score}pt)`);
                }
            }

            // æˆ¦ç•¥æƒ…å ±ã‚’ãƒ‘ãƒ¼ã‚¹ï¼ˆç°¡ç•¥ç‰ˆï¼‰
            const strategyText = raceLines.join(' ');

            // Strategy A
            const strategyAMatch = strategyText.match(/å°‘ç‚¹æ•°çš„ä¸­å‹[^ãƒé«˜]*?AIäºˆæ¸¬(\d+)%/);
            if (strategyAMatch) {
                race.aiPredictions.strategyA = parseInt(strategyAMatch[1]);
                race.strategyA = [`é¦¬å˜ (3ç‚¹)`];
            }

            // Strategy B
            const strategyBMatch = strategyText.match(/ãƒãƒ©ãƒ³ã‚¹å‹[^é«˜]*?AIäºˆæ¸¬(\d+)%/);
            if (strategyBMatch) {
                race.aiPredictions.strategyB = parseInt(strategyBMatch[1]);
                race.strategyB = [`é¦¬å˜çµ„ã¿åˆã‚ã› (11ç‚¹)`];
            }

            // Strategy C
            const strategyCMatch = strategyText.match(/é«˜é…å½“è¿½æ±‚å‹[^A-Z]*?AIäºˆæ¸¬(\d+)%/);
            if (strategyCMatch) {
                race.aiPredictions.strategyC = parseInt(strategyCMatch[1]);
                race.strategyC = [`é¦¬å˜é«˜é…å½“çµ„ã¿åˆã‚ã› (14ç‚¹)`];
            }

            // é€£ä¸‹å€™è£œé¦¬ãƒ»æŠ¼ã•ãˆå€™è£œé¦¬ã‚’ãƒ‘ãƒ¼ã‚¹
            const fullText = raceLines.join(' ');
            console.log(`ğŸ” å€™è£œé¦¬æ¤œç´¢å¯¾è±¡ãƒ†ã‚­ã‚¹ãƒˆ: ${fullText}`);

            // é€£ä¸‹å€™è£œé¦¬ã‚’æŠ½å‡ºï¼ˆã€Œé€£ä¸‹å€™è£œé¦¬: 1,2,3,4ç•ªã€å½¢å¼ï¼‰
            const renzuMatch = fullText.match(/é€£ä¸‹å€™è£œé¦¬[:\s]*([0-9,]+)ç•ª?/);
            if (renzuMatch) {
                race.renzuCandidates = renzuMatch[1].split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n));
                console.log(`ğŸ¯ é€£ä¸‹å€™è£œé¦¬æŠ½å‡ºæˆåŠŸ: [${race.renzuCandidates.join(',')}]`);
            } else {
                console.warn(`âš ï¸ é€£ä¸‹å€™è£œé¦¬ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
            }

            // æŠ¼ã•ãˆå€™è£œé¦¬ã‚’æŠ½å‡ºï¼ˆã€ŒæŠ¼ã•ãˆå€™è£œé¦¬: 7,8ç•ªã€å½¢å¼ï¼‰
            const osaeMatch = fullText.match(/æŠ¼ã•ãˆå€™è£œé¦¬[:\s]*([0-9,]+)ç•ª?/);
            if (osaeMatch) {
                race.osaeCandidates = osaeMatch[1].split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n));
                console.log(`ğŸ¯ æŠ¼ã•ãˆå€™è£œé¦¬æŠ½å‡ºæˆåŠŸ: [${race.osaeCandidates.join(',')}]`);
            } else {
                console.warn(`âš ï¸ æŠ¼ã•ãˆå€™è£œé¦¬ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
            }

            console.log(`âœ… ãƒ¬ãƒ¼ã‚¹å®Œæˆ: ${race.title} (é¦¬${race.horses.length}é ­, é€£ä¸‹${race.renzuCandidates.length}é ­, æŠ¼ã•ãˆ${race.osaeCandidates.length}é ­)`);
            return race;
        }

        // JSONç”Ÿæˆå‡¦ç†ï¼ˆè©³ç´°ãƒ‡ãƒ¼ã‚¿å¯¾å¿œï¼‰
        function generateJsonData(raceDate, track, races) {
            return {
                raceDate: raceDate,
                track: track,
                totalRaces: races.length,
                races: races.map((race, index) => ({
                    raceNumber: `${index + 1}R`,
                    raceName: race.raceName || race.title,
                    tier: index < Math.floor(races.length * 0.75) ? "premium" : (index === races.length - 2 ? "free" : "standard"),
                    isMainRace: index === races.length - 2,
                    displayOrder: index + 1,
                    raceInfo: {
                        title: race.title,
                        raceName: race.raceName,
                        startTime: race.startTime,
                        distance: race.distance,
                        horseCount: race.horseCount,
                        date: raceDate,
                        track: track
                    },
                    horses: {
                        main: race.horses.find(h => h.mark === 'â—') || race.horses[0],
                        sub: race.horses.find(h => h.mark === 'â—‹') || race.horses[1],
                        sub1: race.horses.find(h => h.mark === 'â–²') || race.horses[2],
                        sub2: race.horses[3],
                        allHorses: [
                            // ä¸»è¦é¦¬
                            ...race.horses.map(horse => ({
                                ...horse,
                                type: horse.mark === 'â—' ? 'æœ¬å‘½' :
                                      horse.mark === 'â—‹' ? 'å¯¾æŠ—' :
                                      horse.mark === 'â–²' ? 'å˜ç©´' :
                                      horse.mark === 'â–³' ? 'é€£ä¸‹' : 'other'
                            })),
                            // é€£ä¸‹å€™è£œé¦¬ã‚’è¿½åŠ 
                            ...race.renzuCandidates.filter(num => !race.horses.some(h => h.number === num))
                                .map(num => ({
                                    mark: 'â–³',
                                    number: num,
                                    name: `é€£ä¸‹å€™è£œ${num}`,
                                    score: 0,
                                    features: {},
                                    type: 'é€£ä¸‹'
                                })),
                            // æŠ¼ã•ãˆå€™è£œé¦¬ã‚’è¿½åŠ 
                            ...race.osaeCandidates.filter(num => !race.horses.some(h => h.number === num) && !race.renzuCandidates.includes(num))
                                .map(num => ({
                                    mark: 'Ã—',
                                    number: num,
                                    name: `æŠ¼ã•ãˆå€™è£œ${num}`,
                                    score: 0,
                                    features: {},
                                    type: 'æŠ¼ã•ãˆ'
                                }))
                        ]
                    },
                    candidates: {
                        renzu: race.renzuCandidates,
                        osae: race.osaeCandidates
                    },
                    strategies: {
                        safe: {
                            title: 'ğŸ¯ å°‘ç‚¹æ•°çš„ä¸­å‹ãƒ¢ãƒ‡ãƒ«',
                            bets: race.strategyA,
                            aiPrediction: race.aiPredictions.strategyA
                        },
                        balance: {
                            title: 'âš–ï¸ ãƒãƒ©ãƒ³ã‚¹å‹ãƒ¢ãƒ‡ãƒ«',
                            bets: race.strategyB,
                            aiPrediction: race.aiPredictions.strategyB
                        },
                        aggressive: {
                            title: 'ğŸš€ é«˜é…å½“è¿½æ±‚å‹ãƒ¢ãƒ‡ãƒ«',
                            bets: race.strategyC,
                            aiPrediction: race.aiPredictions.strategyC
                        }
                    }
                }))
            };
        }
    </script>

    <style>
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #0f172a;
            color: #e2e8f0;
            min-height: 100vh;
        }

        .header-section {
            text-align: center;
            margin-bottom: 40px;
        }

        .ai-badge {
            display: inline-flex;
            align-items: center;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 20px;
            padding: 8px 16px;
            margin-bottom: 20px;
        }

        .pulse {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .form-section {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #94a3b8;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid #334155;
            border-radius: 6px;
            color: #e2e8f0;
            font-size: 14px;
        }

        .form-group textarea {
            font-family: monospace;
            resize: vertical;
        }

        .format-example {
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid #334155;
            border-radius: 6px;
            padding: 15px;
            font-size: 12px;
            color: #94a3b8;
            overflow-x: auto;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 30px;
        }

        .btn-primary, .btn-success, .btn-download {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-download {
            background: #8b5cf6;
            color: white;
        }

        .btn-primary:hover, .btn-success:hover, .btn-download:hover {
            transform: translateY(-1px);
            opacity: 0.9;
        }

        .preview-section, .json-section {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 12px;
            padding: 30px;
            margin-top: 30px;
        }

        .race-preview {
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background: rgba(15, 23, 42, 0.3);
        }

        .race-details {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .race-details div {
            font-size: 14px;
            color: #cbd5e1;
        }

        .ai-prediction {
            margin-top: 8px;
            padding: 4px 8px;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 4px;
            font-size: 12px;
            color: #10b981;
            font-weight: 600;
        }

        .candidates {
            margin-top: 15px;
            padding: 10px;
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 6px;
        }

        .candidates h4 {
            margin: 0 0 8px 0;
            color: #3b82f6;
            font-size: 14px;
        }

        .candidates div {
            font-size: 13px;
            color: #cbd5e1;
        }

        .strategies {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .strategy {
            background: rgba(15, 23, 42, 0.5);
            border-radius: 6px;
            padding: 15px;
        }

        .strategy h4 {
            margin: 0 0 10px 0;
            color: #10b981;
        }

        .bets {
            font-family: monospace;
            font-size: 12px;
            line-height: 1.6;
        }

        .horses {
            margin-top: 20px;
            font-size: 14px;
        }

        .horse-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .horse-item {
            padding: 8px 12px;
            background: rgba(30, 41, 59, 0.3);
            border: 1px solid #334155;
            border-radius: 6px;
            margin-bottom: 5px;
        }

        .horse-basic {
            font-weight: 600;
            color: #e2e8f0;
            margin-bottom: 4px;
        }

        .horse-features {
            font-size: 12px;
            color: #94a3b8;
            line-height: 1.4;
        }

        #json-output {
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid #334155;
            border-radius: 6px;
            padding: 15px;
            font-size: 11px;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</BaseLayout>