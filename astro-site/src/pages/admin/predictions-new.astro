---
export const prerender = true;
import BaseLayout from '../../layouts/BaseLayout.astro';
---

<BaseLayout title="新予想システム - 完成形データ入力" description="マコちゃんの完成形データ入力システム">
    <div class="container">
        <div class="header-section">
            <div class="ai-badge">
                <span class="pulse"></span>
                <span class="ai-status">新システム開発中</span>
            </div>
            <h1>🚀 新予想システム - 完成形データ入力</h1>
            <p>マコちゃんが完成形データを直接入力 → クロが単純反映するシステム</p>
        </div>

        <div class="form-section">
            <form id="prediction-form">
                <div class="race-info-section">
                    <h2>📅 レース基本情報</h2>
                    <div class="form-group">
                        <label>開催日</label>
                        <input type="date" id="race-date" name="race-date" required>
                    </div>
                    <div class="form-group">
                        <label>競馬場</label>
                        <select id="track" name="track" required>
                            <option value="大井競馬">大井競馬</option>
                            <option value="川崎競馬">川崎競馬</option>
                            <option value="船橋競馬">船橋競馬</option>
                            <option value="浦和競馬">浦和競馬</option>
                        </select>
                    </div>
                </div>

                <div class="prediction-input-section">
                    <h2>🎯 完成形予想データ入力</h2>
                    <div class="input-format-guide">
                        <h3>📝 入力形式（例）</h3>
                        <pre class="format-example">
川崎1R 1400m（11頭）発走時刻14:45 2歳新馬

【戦略A：少点数的中型】
馬単 9 → 11,5,6 (3点)
AIモデル予測: 的中率65%

【戦略B：バランス型】
馬単 9 ⇔ 1,2,3,4 (8点)
馬単 11 → 9,5,6 (3点)
AIモデル予測: 的中率58%

【戦略C：高配当追求型】
馬単 9 → 7,8 (2点)
馬単 11 ⇔ 1,2,3,4,7,8 (12点)
AIモデル予測: 的中率38%

◎9番 本命 累積スコア85pt 安定性88% 能力上位性88% 展開利79%
○11番 対抗 累積スコア81pt 安定性82% 能力上位性85% 展開利76%
▲5番 単穴 累積スコア78pt 安定性79% 能力上位性80% 展開利73%
▲6番 単穴 累積スコア75pt 安定性76% 能力上位性78% 展開利70%

連下候補馬: 1,2,3,4番
押さえ候補馬: 7,8番</pre>
                    </div>

                    <div class="form-group">
                        <label>全レース予想データ（完成形）</label>
                        <textarea id="prediction-data" name="prediction-data" rows="30" placeholder="上記の形式でレースデータを貼り付けてください..."></textarea>
                    </div>
                </div>

                <div class="action-buttons">
                    <button type="button" id="preview-btn" class="btn-primary">📋 プレビュー</button>
                    <button type="button" id="generate-json-btn" class="btn-success">🚀 JSON生成</button>
                    <button type="button" id="download-json-btn" class="btn-download" style="display: none;">📥 JSONダウンロード</button>
                </div>
            </form>
        </div>

        <div id="preview-section" class="preview-section" style="display: none;">
            <h2>👀 プレビュー</h2>
            <div id="preview-content"></div>
        </div>

        <div id="json-output-section" class="json-section" style="display: none;">
            <h2>📄 生成されたJSON</h2>
            <pre id="json-output"></pre>
        </div>
    </div>

    <script>
        let generatedJsonData = null;

        // プレビュー機能
        document.getElementById('preview-btn').addEventListener('click', function() {
            const predictionData = document.getElementById('prediction-data').value;
            const previewSection = document.getElementById('preview-section');
            const previewContent = document.getElementById('preview-content');

            if (!predictionData.trim()) {
                alert('予想データを入力してください');
                return;
            }

            // シンプルなプレビュー表示
            const races = parsePredictionData(predictionData);
            let previewHtml = '';

            races.forEach((race, index) => {
                previewHtml += `
                    <div class="race-preview">
                        <h3>${race.title}</h3>
                        <div class="race-details">
                            ${race.raceName ? `<div><strong>レース名:</strong> ${race.raceName}</div>` : ''}
                            ${race.startTime ? `<div><strong>発走時刻:</strong> ${race.startTime}</div>` : ''}
                            ${race.distance ? `<div><strong>距離:</strong> ${race.distance}</div>` : ''}
                            ${race.horseCount ? `<div><strong>頭数:</strong> ${race.horseCount}</div>` : ''}
                        </div>
                        <div class="strategies">
                            <div class="strategy">
                                <h4>🎯 少点数的中型</h4>
                                <div class="bets">${race.strategyA.join('<br>')}</div>
                                ${race.aiPredictions.strategyA ? `<div class="ai-prediction">AI予測: ${race.aiPredictions.strategyA}%</div>` : ''}
                            </div>
                            <div class="strategy">
                                <h4>⚖️ バランス型</h4>
                                <div class="bets">${race.strategyB.join('<br>')}</div>
                                ${race.aiPredictions.strategyB ? `<div class="ai-prediction">AI予測: ${race.aiPredictions.strategyB}%</div>` : ''}
                            </div>
                            <div class="strategy">
                                <h4>🚀 高配当追求型</h4>
                                <div class="bets">${race.strategyC.join('<br>')}</div>
                                ${race.aiPredictions.strategyC ? `<div class="ai-prediction">AI予測: ${race.aiPredictions.strategyC}%</div>` : ''}
                            </div>
                        </div>
                        <div class="horses">
                            <h4>馬情報</h4>
                            ${race.horses.map(horse => {
                                let horseInfo = `<span>${horse.mark}${horse.number}番 ${horse.name || ''} ${horse.score}pt`;
                                if (horse.features.stability) {
                                    horseInfo += `<br>&nbsp;&nbsp;特徴量: 安定性${horse.features.stability}% 能力上位性${horse.features.ability}% 展開利${horse.features.positioning}%`;
                                }
                                horseInfo += '</span>';
                                return horseInfo;
                            }).join('<br>')}
                        </div>
                        ${race.renzuCandidates.length > 0 ? `
                            <div class="candidates">
                                <h4>連下候補馬</h4>
                                <div>${race.renzuCandidates.join(', ')}</div>
                            </div>
                        ` : ''}
                        ${race.osaeCandidates.length > 0 ? `
                            <div class="candidates">
                                <h4>押さえ候補馬</h4>
                                <div>${race.osaeCandidates.join(', ')}</div>
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            previewContent.innerHTML = previewHtml;
            previewSection.style.display = 'block';
        });

        // JSON生成機能
        document.getElementById('generate-json-btn').addEventListener('click', function() {
            const raceDate = document.getElementById('race-date').value;
            const track = document.getElementById('track').value;
            const predictionData = document.getElementById('prediction-data').value;

            if (!raceDate || !track || !predictionData.trim()) {
                alert('すべての必須項目を入力してください');
                return;
            }

            const races = parsePredictionData(predictionData);
            const jsonData = generateJsonData(raceDate, track, races);

            generatedJsonData = jsonData;
            document.getElementById('json-output').textContent = JSON.stringify(jsonData, null, 2);
            document.getElementById('json-output-section').style.display = 'block';
            document.getElementById('download-json-btn').style.display = 'inline-block';
        });

        // JSONダウンロード機能
        document.getElementById('download-json-btn').addEventListener('click', function() {
            if (!generatedJsonData) return;

            const blob = new Blob([JSON.stringify(generatedJsonData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `allRacesPrediction-${generatedJsonData.raceDate}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        // マコちゃんの詳細形式対応パース処理（レース名・発走時刻・距離対応＋柔軟対応）
        function parsePredictionData(data) {
            const races = [];
            const raceBlocks = data.split(/(?=\w+\d+R\s)/).filter(block => block.trim());

            raceBlocks.forEach(block => {
                if (!block.trim()) return;

                const race = {
                    title: '',
                    raceName: '',
                    startTime: '',
                    distance: '',
                    raceType: '',
                    horseCount: '',
                    strategyA: [],
                    strategyB: [],
                    strategyC: [],
                    horses: [],
                    aiPredictions: {
                        strategyA: null,
                        strategyB: null,
                        strategyC: null
                    },
                    renzuCandidates: [],    // 連下候補馬
                    osaeCandidates: []      // 押さえ候補馬
                };

                const lines = block.split('\n').map(line => line.trim()).filter(line => line);
                let currentStrategy = null;

                lines.forEach(line => {
                    // レース基本情報の詳細解析（柔軟対応）
                    if (line.match(/\w+\d+R/)) {
                        race.title = line;

                        // 距離抽出
                        const distanceMatch = line.match(/(\d+)m/);
                        if (distanceMatch) race.distance = distanceMatch[1] + 'm';

                        // 発走時刻抽出（柔軟パターン対応）
                        const timeMatch = line.match(/発走時刻?(\d{1,2}):?(\d{2})/);
                        if (timeMatch) {
                            race.startTime = `${timeMatch[1]}:${timeMatch[2]}`;
                        }

                        // 頭数抽出
                        const horseCountMatch = line.match(/（(\d+)頭）/);
                        if (horseCountMatch) race.horseCount = horseCountMatch[1] + '頭';

                        // レース名抽出（最後の部分）
                        const raceNameMatch = line.match(/\d+頭）\s*(.+)$/);
                        if (raceNameMatch) race.raceName = raceNameMatch[1].trim();
                    }

                    // 戦略セクション判定（柔軟対応）
                    else if (line.includes('【戦略A') || line.includes('少点数的中型')) {
                        currentStrategy = 'A';
                    }
                    else if (line.includes('【戦略B') || line.includes('バランス型')) {
                        currentStrategy = 'B';
                    }
                    else if (line.includes('【戦略C') || line.includes('高配当追求型')) {
                        currentStrategy = 'C';
                    }

                    // 馬単の買い目（戦略別で正確に振り分け）
                    else if (line.startsWith('馬単')) {
                        if (currentStrategy === 'A') race.strategyA.push(line);
                        else if (currentStrategy === 'B') race.strategyB.push(line);
                        else if (currentStrategy === 'C') race.strategyC.push(line);
                    }

                    // AI予測値の抽出（柔軟パターン対応）
                    else if (line.includes('AIモデル予測') || line.includes('AI予測')) {
                        const predictionMatch = line.match(/(\d+(?:\.\d+)?)%/);
                        if (predictionMatch && currentStrategy) {
                            const percentage = parseFloat(predictionMatch[1]);
                            if (currentStrategy === 'A') race.aiPredictions.strategyA = percentage;
                            else if (currentStrategy === 'B') race.aiPredictions.strategyB = percentage;
                            else if (currentStrategy === 'C') race.aiPredictions.strategyC = percentage;
                        }
                    }

                    // 連下候補馬
                    else if (line.includes('連下候補馬')) {
                        const candidatesMatch = line.match(/連下候補馬[：:]\s*(.+)/);
                        if (candidatesMatch) {
                            race.renzuCandidates = candidatesMatch[1].split(/[,，\s]+/).map(s => s.trim()).filter(s => s);
                        }
                    }

                    // 押さえ候補馬
                    else if (line.includes('抑え候補馬') || line.includes('押さえ候補馬')) {
                        const candidatesMatch = line.match(/[抑押]さえ候補馬[：:]\s*(.+)/);
                        if (candidatesMatch) {
                            race.osaeCandidates = candidatesMatch[1].split(/[,，\s]+/).map(s => s.trim()).filter(s => s);
                        }
                    }

                    // 馬情報（詳細形式対応・柔軟パターン対応）
                    else if (line.match(/^[◎○▲△×]?\d+番/)) {
                        // 基本的な馬情報の抽出（柔軟パターン）
                        const basicMatch = line.match(/^([◎○▲△×]?)(\d+)番\s*(.+?)\s*累積スコア(\d+)pt/);
                        if (basicMatch) {
                            const horseData = {
                                mark: basicMatch[1] || '',
                                number: parseInt(basicMatch[2]),
                                name: basicMatch[3].trim(),
                                score: parseInt(basicMatch[4]),
                                features: {}
                            };

                            // 特徴量重要度の抽出（柔軟パターン対応）
                            const featureMatch = line.match(/安定性[\s:：]*(\d+(?:\.\d+)?)%.*?能力上位性[\s:：]*(\d+(?:\.\d+)?)%.*?展開利[\s:：]*(\d+(?:\.\d+)?)%/);
                            if (featureMatch) {
                                horseData.features = {
                                    stability: parseFloat(featureMatch[1]),
                                    ability: parseFloat(featureMatch[2]),
                                    positioning: parseFloat(featureMatch[3])
                                };
                            }

                            race.horses.push(horseData);
                        }
                        // 簡易形式にもフォールバック対応
                        else {
                            const simpleMatch = line.match(/^([◎○▲△×]?)(\d+)番\s*(\w*)\s*.*?(\d+)pt/);
                            if (simpleMatch) {
                                race.horses.push({
                                    mark: simpleMatch[1] || '',
                                    number: parseInt(simpleMatch[2]),
                                    name: simpleMatch[3] || '',
                                    score: parseInt(simpleMatch[4]),
                                    features: {}
                                });
                            }
                        }
                    }
                });

                if (race.title) races.push(race);
            });

            return races;
        }

        // JSON生成処理（詳細データ対応）
        function generateJsonData(raceDate, track, races) {
            return {
                raceDate: raceDate,
                track: track,
                totalRaces: races.length,
                races: races.map((race, index) => ({
                    raceNumber: `${index + 1}R`,
                    raceName: race.raceName || race.title,
                    tier: index < Math.floor(races.length * 0.75) ? "premium" : (index === races.length - 2 ? "free" : "standard"),
                    isMainRace: index === races.length - 2,
                    displayOrder: index + 1,
                    raceInfo: {
                        title: race.title,
                        raceName: race.raceName,
                        startTime: race.startTime,
                        distance: race.distance,
                        horseCount: race.horseCount,
                        date: raceDate,
                        track: track
                    },
                    horses: {
                        main: race.horses.find(h => h.mark === '◎') || race.horses[0],
                        sub: race.horses.find(h => h.mark === '○') || race.horses[1],
                        sub1: race.horses.find(h => h.mark === '▲') || race.horses[2],
                        sub2: race.horses[3],
                        allHorses: race.horses.map(horse => ({
                            ...horse,
                            type: horse.mark === '◎' ? 'main' :
                                  horse.mark === '○' ? 'sub' :
                                  horse.mark === '▲' ? 'sub1' :
                                  horse.mark === '△' ? 'sub2' : 'other'
                        }))
                    },
                    candidates: {
                        renzu: race.renzuCandidates,
                        osae: race.osaeCandidates
                    },
                    strategies: {
                        safe: {
                            title: '🎯 少点数的中型モデル',
                            bets: race.strategyA,
                            aiPrediction: race.aiPredictions.strategyA
                        },
                        balance: {
                            title: '⚖️ バランス型モデル',
                            bets: race.strategyB,
                            aiPrediction: race.aiPredictions.strategyB
                        },
                        aggressive: {
                            title: '🚀 高配当追求型モデル',
                            bets: race.strategyC,
                            aiPrediction: race.aiPredictions.strategyC
                        }
                    }
                }))
            };
        }
    </script>

    <style>
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #0f172a;
            color: #e2e8f0;
            min-height: 100vh;
        }

        .header-section {
            text-align: center;
            margin-bottom: 40px;
        }

        .ai-badge {
            display: inline-flex;
            align-items: center;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 20px;
            padding: 8px 16px;
            margin-bottom: 20px;
        }

        .pulse {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .form-section {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #94a3b8;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid #334155;
            border-radius: 6px;
            color: #e2e8f0;
            font-size: 14px;
        }

        .form-group textarea {
            font-family: monospace;
            resize: vertical;
        }

        .format-example {
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid #334155;
            border-radius: 6px;
            padding: 15px;
            font-size: 12px;
            color: #94a3b8;
            overflow-x: auto;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 30px;
        }

        .btn-primary, .btn-success, .btn-download {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-download {
            background: #8b5cf6;
            color: white;
        }

        .btn-primary:hover, .btn-success:hover, .btn-download:hover {
            transform: translateY(-1px);
            opacity: 0.9;
        }

        .preview-section, .json-section {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 12px;
            padding: 30px;
            margin-top: 30px;
        }

        .race-preview {
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background: rgba(15, 23, 42, 0.3);
        }

        .race-details {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .race-details div {
            font-size: 14px;
            color: #cbd5e1;
        }

        .ai-prediction {
            margin-top: 8px;
            padding: 4px 8px;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 4px;
            font-size: 12px;
            color: #10b981;
            font-weight: 600;
        }

        .candidates {
            margin-top: 15px;
            padding: 10px;
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 6px;
        }

        .candidates h4 {
            margin: 0 0 8px 0;
            color: #3b82f6;
            font-size: 14px;
        }

        .candidates div {
            font-size: 13px;
            color: #cbd5e1;
        }

        .strategies {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .strategy {
            background: rgba(15, 23, 42, 0.5);
            border-radius: 6px;
            padding: 15px;
        }

        .strategy h4 {
            margin: 0 0 10px 0;
            color: #10b981;
        }

        .bets {
            font-family: monospace;
            font-size: 12px;
            line-height: 1.6;
        }

        .horses {
            margin-top: 20px;
            font-size: 14px;
        }

        .horses span {
            display: inline-block;
            margin-right: 15px;
            margin-bottom: 5px;
        }

        #json-output {
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid #334155;
            border-radius: 6px;
            padding: 15px;
            font-size: 11px;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</BaseLayout>