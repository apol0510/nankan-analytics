---
export const prerender = false;
import BaseLayout from '../../layouts/BaseLayout.astro';
---

<BaseLayout title="çš„ä¸­çµæœç®¡ç†" description="NANKANã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹çš„ä¸­çµæœæ›´æ–°ç®¡ç†ç”»é¢">
    <div class="admin-container">
        <h1>ğŸ¯ çš„ä¸­çµæœç®¡ç†ç”»é¢</h1>
        <p class="subtitle">æ˜¨æ—¥ã®çš„ä¸­çµæœã¨å…ˆé€±ã®çš„ä¸­çµæœã‚’æ›´æ–°ã§ãã¾ã™</p>

        <!-- æ˜¨æ—¥ã®çš„ä¸­çµæœã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <section class="results-section">
            <h2>ğŸ“Š æ˜¨æ—¥ã®çš„ä¸­çµæœ</h2>

            <!-- ã‚³ãƒ”ãƒšå…¥åŠ›ã‚¨ãƒªã‚¢ -->
            <div class="paste-section">
                <h3>ğŸ“ çµæœã‚’ã‚³ãƒ”ãƒšã§å…¥åŠ›</h3>
                <textarea id="paste-input" placeholder="ï¼™/ï¼‘ï¼—å¤§äº•ç«¶é¦¬äºˆæƒ³ çµæœ
ï¼‘ï¼² 11-ï¼’é¦¬å˜ã€€2.250å†† çš„ä¸­ï¼
ï¼’ï¼² ï¼˜-ï¼‘é¦¬å˜ã€€1.060å†† çš„ä¸­ï¼
ï¼“ï¼² ï¼’-ï¼˜é¦¬å˜ã€€2.380å†† çš„ä¸­ï¼
ï¼”ï¼² ï¼™-ï¼‘
ï¼•ï¼² 13-11é¦¬å˜ã€€3.300å†† çš„ä¸­ï¼
..." rows="15"></textarea>
                <button id="parse-btn" class="parse-btn">ğŸ“‹ è‡ªå‹•è§£æã—ã¦å…¥åŠ›</button>
            </div>

            <div class="auto-fields">
                <div class="form-group">
                    <label>é–‹å‚¬æ—¥ï¼ˆè‡ªå‹•æŠ½å‡ºï¼‰</label>
                    <input type="text" id="yesterday-date" placeholder="ã‚³ãƒ”ãƒšè§£æã§è‡ªå‹•å…¥åŠ›" readonly />
                </div>
                <div class="form-group">
                    <label>ç«¶é¦¬å ´ï¼ˆè‡ªå‹•æŠ½å‡ºï¼‰</label>
                    <input type="text" id="yesterday-track" placeholder="ã‚³ãƒ”ãƒšè§£æã§è‡ªå‹•å…¥åŠ›" readonly />
                </div>
            </div>
            <div class="form-group">
                <label>ç·ãƒ¬ãƒ¼ã‚¹æ•°</label>
                <input type="number" id="yesterday-totalRaces" value="12" />
            </div>
            <div class="form-group">
                <label>çš„ä¸­ãƒ¬ãƒ¼ã‚¹æ•°</label>
                <input type="number" id="yesterday-hits" value="6" />
            </div>
            <div class="form-group">
                <label>çš„ä¸­ç‡ï¼ˆ%ï¼‰</label>
                <input type="text" id="yesterday-hitRate" placeholder="50.0" />
            </div>
            <div class="form-group">
                <label>ç·é…å½“ï¼ˆå††ï¼‰</label>
                <input type="number" id="yesterday-payout" placeholder="47870" />
            </div>
            <div class="form-group">
                <label>å›åç‡ï¼ˆ%ï¼‰</label>
                <input type="text" id="yesterday-returnRate" placeholder="399.2" />
            </div>

        </section>

        <!-- å…ˆé€±ã®çš„ä¸­çµæœã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <section class="results-section">
            <h2>ğŸ“ˆ å…ˆé€±ã®çš„ä¸­çµæœï¼ˆãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ï¼‰</h2>
            <p class="info">å…ˆé€±ã®çš„ä¸­çµæœã¯index.astroå†…ã«ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã™ã€‚</p>
            <p class="info">ç¾åœ¨ã®ä»•æ§˜ã§ã¯ã€ç›´æ¥index.astroãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</p>
            <div class="note">
                <strong>è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹é€±é–“ãƒ‡ãƒ¼ã‚¿:</strong>
                <ul>
                    <li>æœŸé–“: 8/11ã€œ8/15 å¤§äº•ç«¶é¦¬</li>
                    <li>çš„ä¸­ç‡: 78.6% (44/56)</li>
                    <li>é€±é–“é…å½“: Â¥122,580</li>
                    <li>é€±é–“å›åç‡: 218.9%</li>
                </ul>
            </div>
        </section>

        <div class="button-container">
            <button id="update-btn" class="update-btn">
                ğŸ“ æ˜¨æ—¥ã®çš„ä¸­çµæœã‚’æ›´æ–°
            </button>
            <button id="preview-btn" class="preview-btn">
                ğŸ‘ï¸ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
            </button>
        </div>

        <div id="preview-container" class="preview-container" style="display: none;">
            <h3>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
            <pre id="preview-content"></pre>
        </div>
    </div>

    <style>
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
            margin-bottom: 10px;
        }

        .subtitle {
            text-align: center;
            color: #94a3b8;
            margin-bottom: 40px;
        }

        .results-section {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .results-section h2 {
            color: #e2e8f0;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .results-section h3 {
            color: #cbd5e1;
            margin-top: 30px;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #94a3b8;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 8px;
            color: #e2e8f0;
            font-size: 1rem;
        }

        .form-group input:focus {
            outline: none;
            border-color: #3b82f6;
            background: rgba(15, 23, 42, 0.8);
        }


        .button-container {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 40px;
        }

        .update-btn,
        .preview-btn {
            padding: 15px 40px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 1.1rem;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }

        .update-btn {
            background: linear-gradient(135deg, #10b981, #22c55e);
            color: white;
        }

        .update-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
        }

        .preview-btn {
            background: linear-gradient(135deg, #3b82f6, #6366f1);
            color: white;
        }

        .preview-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.3);
        }

        .preview-container {
            margin-top: 30px;
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 12px;
            padding: 20px;
        }

        .preview-container h3 {
            color: #e2e8f0;
            margin-bottom: 15px;
        }

        .preview-container pre {
            background: rgba(15, 23, 42, 0.8);
            padding: 15px;
            border-radius: 8px;
            color: #10b981;
            overflow-x: auto;
            font-size: 0.9rem;
        }

        .info {
            color: #94a3b8;
            font-style: italic;
            margin: 10px 0;
        }

        .note {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }

        .note strong {
            color: #3b82f6;
        }

        .note ul {
            margin: 10px 0 0 20px;
            color: #cbd5e1;
        }

        .note li {
            margin: 5px 0;
        }

        .paste-section {
            background: rgba(59, 130, 246, 0.05);
            border: 2px dashed rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .paste-section h3 {
            color: #3b82f6;
            margin-bottom: 15px;
        }

        .paste-section textarea {
            width: 100%;
            padding: 15px;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 8px;
            color: #e2e8f0;
            font-family: monospace;
            font-size: 0.9rem;
            line-height: 1.6;
            resize: vertical;
        }

        .paste-section textarea:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .parse-btn {
            margin-top: 15px;
            padding: 12px 30px;
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .parse-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(139, 92, 246, 0.3);
        }

        .divider {
            text-align: center;
            color: #64748b;
            margin: 30px 0;
            position: relative;
        }

        .divider::before,
        .divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: calc(50% - 80px);
            height: 1px;
            background: rgba(148, 163, 184, 0.2);
        }

        .divider::before {
            left: 0;
        }

        .divider::after {
            right: 0;
        }

        .auto-fields {
            background: rgba(34, 197, 94, 0.05);
            border: 1px solid rgba(34, 197, 94, 0.2);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .auto-fields .form-group input {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            color: #22c55e;
            cursor: not-allowed;
        }

        .auto-fields .form-group label {
            color: #22c55e;
        }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', function() {

            // ã‚³ãƒ”ãƒšè§£ææ©Ÿèƒ½
            document.getElementById('parse-btn').addEventListener('click', function() {
                const pasteText = document.getElementById('paste-input').value;
                if (!pasteText) {
                    alert('çµæœãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„');
                    return;
                }

                // 1è¡Œç›®ã‹ã‚‰æ—¥ä»˜ã¨ç«¶é¦¬å ´ã‚’æŠ½å‡º
                const lines = pasteText.split('\n');
                const firstLine = lines[0];
                const dateMatch = firstLine.match(/(\d+)[\/æœˆ](\d+)/);
                const trackMatch = firstLine.match(/(å¤§äº•|å·å´|èˆ¹æ©‹|æµ¦å’Œ)ç«¶é¦¬/);

                if (dateMatch) {
                    const month = dateMatch[1];
                    const day = dateMatch[2];
                    document.getElementById('yesterday-date').value = `${month}/${day}`;
                }

                if (trackMatch) {
                    document.getElementById('yesterday-track').value = `${trackMatch[1]}ç«¶é¦¬`;
                }

                // ãƒ¬ãƒ¼ã‚¹çµæœã‚’è§£æ
                let totalPayout = 0;
                let hitCount = 0;
                const raceResults = {};

                for (let i = 1; i <= 12; i++) {
                    raceResults[i] = { status: 'miss', payout: 0 };
                }

                lines.forEach(line => {
                    console.log('è§£æä¸­ã®è¡Œ:', line);

                    // ãƒ¬ãƒ¼ã‚¹ç•ªå·ã‚’æŠ½å‡ºï¼ˆå…¨è§’ãƒ»åŠè§’ä¸¡å¯¾å¿œï¼‰
                    const raceMatch = line.match(/([ï¼-ï¼™\d]+)[ï¼²R]/);
                    if (!raceMatch) return;

                    // å…¨è§’æ•°å­—ã‚’åŠè§’æ•°å­—ã«å¤‰æ›
                    const raceNumStr = raceMatch[1].replace(/[ï¼-ï¼™]/g, function(s) {
                        return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);
                    });
                    const raceNum = parseInt(raceNumStr);
                    if (raceNum < 1 || raceNum > 12) return;

                    console.log(`${raceNum}R ã‚’è§£æä¸­:`, line);

                    // çš„ä¸­åˆ¤å®šï¼ˆã€Œçš„ä¸­ã€ã¾ãŸã¯ã€Œï¼ã€ãŒã‚ã‚‹å ´åˆï¼‰
                    const isHit = line.includes('çš„ä¸­') || line.includes('ï¼');

                    if (isHit) {
                        raceResults[raceNum].status = 'hit';
                        hitCount++;
                        console.log(`${raceNum}R: çš„ä¸­ã¨åˆ¤å®š`);

                        // é…å½“é‡‘é¡ã‚’æŠ½å‡ºï¼ˆã‚ˆã‚ŠæŸ”è»Ÿãªãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
                        const payoutMatch = line.match(/([0-9,\.]+)å††/);
                        if (payoutMatch) {
                            // ã‚«ãƒ³ãƒã‚’é™¤å»
                            const payoutStr = payoutMatch[1].replace(/[,ï¼Œ]/g, '');

                            let payout;
                            if (payoutStr.includes('.')) {
                                // å°æ•°ç‚¹ãŒã‚ã‚‹å ´åˆï¼ˆ2.250 â†’ 2250ã€1.700 â†’ 1700ï¼‰
                                payout = Math.round(parseFloat(payoutStr) * 1000);
                            } else {
                                // å°æ•°ç‚¹ãŒãªã„å ´åˆï¼ˆ330 â†’ 330ï¼‰
                                payout = parseInt(payoutStr);
                            }

                            raceResults[raceNum].payout = payout;
                            totalPayout += payout;
                            console.log(`${raceNum}R: é…å½“ ${payout}å††`);
                        }
                    } else {
                        raceResults[raceNum].status = 'miss';
                        raceResults[raceNum].payout = 0;
                        console.log(`${raceNum}R: ä¸çš„ä¸­ã¨åˆ¤å®š`);
                    }
                });

                // ãƒ•ã‚©ãƒ¼ãƒ ã«åæ˜ ï¼ˆå‰Šé™¤æ¸ˆã¿ï¼‰

                // é›†è¨ˆå€¤ã‚’è¨­å®š
                document.getElementById('yesterday-totalRaces').value = 12;
                document.getElementById('yesterday-hits').value = hitCount;
                document.getElementById('yesterday-payout').value = totalPayout;

                // çš„ä¸­ç‡ã¨å›åç‡ã‚’è¨ˆç®—
                const hitRate = ((hitCount / 12) * 100).toFixed(1);
                // 1ãƒ¬ãƒ¼ã‚¹å½“ãŸã‚Š10ç‚¹ï¼ˆ1,000å††ï¼‰ã§è³¼å…¥ã¨ã—ã¦è¨ˆç®—
                const totalCost = 12 * 1000; // 12ãƒ¬ãƒ¼ã‚¹ Ã— 1,000å††
                // æµ®å‹•å°æ•°ç‚¹æ¼”ç®—ã®ç²¾åº¦ã‚’è£œæ­£ã—ã¦å››æ¨äº”å…¥
                const percentage = (totalPayout / totalCost) * 100;
                const returnRate = Math.round(percentage + 0.0000001); // å¾®å°å€¤ã‚’åŠ ç®—ã—ã¦ç²¾åº¦è£œæ­£
                console.log(`å›åç‡è¨ˆç®—: ${totalPayout} Ã· ${totalCost} = ${percentage} â†’ ${returnRate}`);
                document.getElementById('yesterday-hitRate').value = hitRate;
                document.getElementById('yesterday-returnRate').value = returnRate;

                alert(`âœ… è§£æå®Œäº†ï¼\nçš„ä¸­: ${hitCount}/12 (${hitRate}%)\nç·é…å½“: Â¥${totalPayout.toLocaleString()}\nå›åç‡: ${returnRate}%`);
            });

            // çš„ä¸­ç‡è‡ªå‹•è¨ˆç®—
            document.getElementById('yesterday-hits').addEventListener('input', function() {
                const hits = parseInt(this.value) || 0;
                const total = parseInt(document.getElementById('yesterday-totalRaces').value) || 12;
                const rate = ((hits / total) * 100).toFixed(1);
                document.getElementById('yesterday-hitRate').value = rate;
            });

            // å›åç‡è‡ªå‹•è¨ˆç®—
            document.getElementById('yesterday-payout').addEventListener('input', function() {
                const payout = parseInt(this.value) || 0;
                const total = parseInt(document.getElementById('yesterday-totalRaces').value) || 12;
                // 1ãƒ¬ãƒ¼ã‚¹å½“ãŸã‚Š10ç‚¹ï¼ˆ1,000å††ï¼‰ã§è¨ˆç®—
                const percentage = (payout / (total * 1000)) * 100;
                const returnRate = Math.round(percentage + 0.0000001); // ç²¾åº¦è£œæ­£
                document.getElementById('yesterday-returnRate').value = returnRate;
            });

            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½
            document.getElementById('preview-btn').addEventListener('click', function() {
                const data = collectFormData();
                document.getElementById('preview-content').textContent = JSON.stringify(data, null, 2);
                document.getElementById('preview-container').style.display = 'block';
            });

            // ãƒ‡ãƒ¼ã‚¿åé›†é–¢æ•°
            function collectFormData() {
                return {
                    date: document.getElementById('yesterday-date').value,
                    track: document.getElementById('yesterday-track').value,
                    totalRaces: parseInt(document.getElementById('yesterday-totalRaces').value),
                    hits: parseInt(document.getElementById('yesterday-hits').value),
                    hitRate: document.getElementById('yesterday-hitRate').value + '%',
                    payout: parseInt(document.getElementById('yesterday-payout').value),
                    returnRate: document.getElementById('yesterday-returnRate').value + '%',
                    races: [] // ãƒ¬ãƒ¼ã‚¹åˆ¥çµæœã¯å‰Šé™¤æ¸ˆã¿
                };
            }

            // æ›´æ–°ãƒœã‚¿ãƒ³
            document.getElementById('update-btn').addEventListener('click', async function() {
                const data = collectFormData();

                try {
                    const response = await fetch('/.netlify/functions/update-race-results', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    });

                    if (response.ok) {
                        alert('âœ… çš„ä¸­çµæœã‚’æ›´æ–°ã—ã¾ã—ãŸï¼');
                    } else {
                        // Netlify FunctionãŒå­˜åœ¨ã—ãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                        console.log('æ›´æ–°ãƒ‡ãƒ¼ã‚¿:', data);
                        alert('ğŸ“‹ ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§raceResults.jsonã‚’æ›´æ–°ã—ã¦ãã ã•ã„ã€‚');
                    }
                } catch (error) {
                    console.error('æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                    console.log('æ›´æ–°ãƒ‡ãƒ¼ã‚¿:', data);
                    alert('âš ï¸ è‡ªå‹•æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ‰‹å‹•ã§raceResults.jsonã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚');
                }
            });
        });
    </script>
</BaseLayout>