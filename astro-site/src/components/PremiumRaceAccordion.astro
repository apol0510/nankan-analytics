---
// プレミアム予想レースアコーディオンの共通コンポーネント
export interface Props {
    raceNumber: string;
    raceInfo: {
        title: string;
        raceName: string;
        confidence: number;
        track: string;
    };
    allHorses: Array<{
        number: number;
        name: string;
        mark: string;
        confidence: number;
        factors: Array<{
            icon: string;
            text: string;
        }>;
    }>;
    horses: {
        main?: {
            importance?: Array<{
                feature: string;
                score: number;
            }>;
        };
    };
    strategies: {
        safe: any;
        balance: any;
        aggressive: any;
    };
    analysis: any;
}

const { raceNumber, raceInfo, allHorses, horses, strategies, analysis } = Astro.props;
const raceId = `race-${raceNumber.toLowerCase()}`;
const toggleFunctionName = `toggleRace${raceNumber}`;
---

<div class={`race-${raceNumber.toLowerCase()}-accordion`}>
    <div class="race-accordion-header" onclick={`${toggleFunctionName}()`}>
        <div class="race-basic-info">
            <span class="race-number">{raceNumber}</span>
            <span class="race-name">{raceInfo.raceName}</span>
            <span class="race-tier-badge">第{raceNumber}レース</span>
        </div>
        <div class="race-preview">
            <span class="toggle-icon" id={`toggle-${raceNumber.toLowerCase()}`}>▼</span>
        </div>
    </div>
    
    <div class="race-accordion-content" id={raceId} style="max-height: 0; opacity: 0;">
        <div class={`race-content-${raceNumber.toLowerCase()}`}>
            
            <!-- AI選出馬分析 -->
            <div class="analysis-section">
                <h2 class="section-title">
                    <span>🤖</span>
                    <span>AIモデル選出馬 - XGBoost×LSTM統合分析</span>
                </h2>

                {/* ◎印（本命）- 最も大きく表示 */}
                {allHorses && allHorses.filter(h => h.mark === '◎').map((horse, index) => (
                    <div class="horse-card horse-card-main">
                        <div class="horse-header">
                            <div>
                                <span class="horse-mark-main">◎</span>
                                <span class="horse-number">{horse.number}</span>
                                <span class="horse-name">{horse.name}</span>
                                <span class="horse-type" style="margin-left: 10px; color: #10b981; font-weight: 600;">本命</span>
                            </div>
                        </div>
                        <div class="ai-factors">
                            {horse.factors.map(factor => (
                                <div class="factor">
                                    <span class="factor-icon">{factor.icon}</span>
                                    <span>{factor.text}</span>
                                </div>
                            ))}
                        </div>
                        
                        {/* 本命馬のみ特徴量重要度を表示 */}
                        {horses.main && horses.main.importance && (
                            <div class="feature-importance">
                                <h4 style="color: #94a3b8; font-size: 0.9rem; margin-bottom: 10px;">特徴量重要度</h4>
                                {horses.main.importance.map(item => (
                                    <div class="importance-item">
                                        <span class="feature-name">{item.feature}</span>
                                        <div class="importance-bar">
                                            <div class="importance-fill" style={`width: ${item.score}%`}></div>
                                        </div>
                                        <span class="importance-score">{item.score}%</span>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                ))}

                {/* ○印（対抗）*/}
                {allHorses && allHorses.filter(h => h.mark === '○').map((horse, index) => (
                    <div class="horse-card horse-card-rival">
                        <div class="horse-header">
                            <div>
                                <span class="horse-mark-rival">○</span>
                                <span class="horse-number">{horse.number}</span>
                                <span class="horse-name">{horse.name}</span>
                                <span class="horse-type" style="margin-left: 10px; color: #f59e0b; font-weight: 600;">対抗</span>
                            </div>
                        </div>
                        <div class="ai-factors">
                            {horse.factors.map(factor => (
                                <div class="factor">
                                    <span class="factor-icon">{factor.icon}</span>
                                    <span>{factor.text}</span>
                                </div>
                            ))}
                        </div>
                    </div>
                ))}

                {/* △印（単穴）*/}
                {allHorses && allHorses.filter(h => h.mark === '△').map((horse, index) => (
                    <div class="horse-card horse-card-dark">
                        <div class="horse-header">
                            <div>
                                <span class="horse-mark-dark">△</span>
                                <span class="horse-number">{horse.number}</span>
                                <span class="horse-name">{horse.name}</span>
                                <span class="horse-type" style="margin-left: 10px; color: #8b5cf6; font-weight: 600;">単穴</span>
                            </div>
                        </div>
                        <div class="ai-factors">
                            {horse.factors.map(factor => (
                                <div class="factor">
                                    <span class="factor-icon">{factor.icon}</span>
                                    <span>{factor.text}</span>
                                </div>
                            ))}
                        </div>
                    </div>
                ))}

                {/* ▲印（連下穴）*/}
                {allHorses && allHorses.filter(h => h.mark === '▲').map((horse, index) => (
                    <div class="horse-card horse-card-warning">
                        <div class="horse-header">
                            <div>
                                <span class="horse-mark-warning">▲</span>
                                <span class="horse-number">{horse.number}</span>
                                <span class="horse-name">{horse.name}</span>
                                <span class="horse-type" style="margin-left: 10px; color: #f97316; font-weight: 600;">連下穴</span>
                            </div>
                        </div>
                        <div class="ai-factors">
                            {horse.factors.map(factor => (
                                <div class="factor">
                                    <span class="factor-icon">{factor.icon}</span>
                                    <span>{factor.text}</span>
                                </div>
                            ))}
                        </div>
                    </div>
                ))}
            </div>

            <!-- 投資戦略セクション -->
            <div class="strategy-section">
                <h2 class="section-title">
                    <span>💰</span>
                    <span>AIモデル投資戦略</span>
                </h2>
                
                <div class="bet-strategy">
                    <div class="strategy-title">🎯 戦略A: 高的中率型（推奨度 ★★★★☆）</div>
                    <div style="color: #94a3b8; margin-bottom: 15px;">
                        AIモデル予測: 的中率{strategies.safe.hitRate}% / 期待回収率{strategies.safe.returnRate}%
                    </div>
                    <div class="bet-list">
                        {strategies.safe.bets.map(bet => (
                            <div class="bet-item">
                                <span class="bet-type">{bet.type}</span>
                                <span class="bet-horses">{bet.horses}</span>
                                <span class="bet-points">{bet.points}</span>
                            </div>
                        ))}
                    </div>
                    <div class="risk-indicator">
                        <span style="color: #64748b; font-size: 0.85rem;">リスク:</span>
                        <div class="risk-bar active risk-low" style="width: 30%;"></div>
                        <div class="risk-bar"></div>
                        <div class="risk-bar"></div>
                    </div>
                    <div class="expected-return">
                        <div class="return-value">推定配当 {strategies.safe.expectedPayout}</div>
                        <div style="color: #94a3b8; font-size: 0.9rem;">{strategies.safe.payoutType}</div>
                    </div>
                </div>

                <div class="bet-strategy">
                    <div class="strategy-title">⚖️ 戦略B: バランス型（推奨度 ★★★☆☆）</div>
                    <div style="color: #94a3b8; margin-bottom: 15px;">
                        AIモデル予測: 的中率{strategies.balance.hitRate}% / 期待回収率{strategies.balance.returnRate}%
                    </div>
                    <div class="bet-list">
                        {strategies.balance.bets.map(bet => (
                            <div class="bet-item">
                                <span class="bet-type">{bet.type}</span>
                                <span class="bet-horses">{bet.horses}</span>
                                <span class="bet-points">{bet.points}</span>
                            </div>
                        ))}
                    </div>
                    <div class="risk-indicator">
                        <span style="color: #64748b; font-size: 0.85rem;">リスク:</span>
                        <div class="risk-bar active risk-medium" style="width: 60%;"></div>
                        <div class="risk-bar"></div>
                        <div class="risk-bar"></div>
                    </div>
                    <div class="expected-return">
                        <div class="return-value">推定配当 {strategies.balance.expectedPayout}</div>
                        <div style="color: #94a3b8; font-size: 0.9rem;">{strategies.balance.payoutType}</div>
                    </div>
                </div>

                <div class="bet-strategy">
                    <div class="strategy-title">⚡ 戦略C: 高配当追求型（推奨度 ★★☆☆☆）</div>
                    <div style="color: #94a3b8; margin-bottom: 15px;">
                        AIモデル予想: 的中率{strategies.aggressive.hitRate}% / 期待回収率{strategies.aggressive.returnRate}%
                    </div>
                    <div class="bet-list">
                        {strategies.aggressive.bets.map(bet => (
                            <div class="bet-item">
                                <span class="bet-type">{bet.type}</span>
                                <span class="bet-horses">{bet.horses}</span>
                                <span class="bet-points">{bet.points}</span>
                            </div>
                        ))}
                    </div>
                    <div class="risk-indicator">
                        <span style="color: #64748b; font-size: 0.85rem;">リスク:</span>
                        <div class="risk-bar active risk-high" style="width: 100%;"></div>
                        <div class="risk-bar"></div>
                        <div class="risk-bar"></div>
                    </div>
                    <div class="expected-return">
                        <div class="return-value">推定配当 {strategies.aggressive.expectedPayout}</div>
                        <div style="color: #94a3b8; font-size: 0.9rem;">{strategies.aggressive.payoutType}</div>
                    </div>
                </div>
            </div>

            <!-- データ分析セクション -->
            <div class="analysis-data-section">
                <h2 class="section-title">
                    <span>📊</span>
                    <span>詳細データ分析</span>
                </h2>
                
                <div class="analysis-grid">
                    <div class="analysis-card">
                        <div class="analysis-header">🏁 レース特性分析</div>
                        <div class="analysis-content">
                            <p>{analysis.raceCharacteristics}</p>
                        </div>
                    </div>
                    
                    <div class="analysis-card">
                        <div class="analysis-header">📈 馬場傾向</div>
                        <div class="analysis-content">
                            <p>{analysis.trackTrend}</p>
                        </div>
                    </div>
                    
                    <div class="analysis-card">
                        <div class="analysis-header">🌤️ 天候・馬場状態</div>
                        <div class="analysis-content">
                            <p>{analysis.weather}</p>
                        </div>
                    </div>
                    
                    <div class="analysis-card">
                        <div class="analysis-content">
                            <p>{analysis.confidenceReason}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* 基本的なスタイルは既存のものを継承 */
    .race-accordion-header {
        background: rgba(30, 41, 59, 0.6);
        border: 1px solid rgba(59, 130, 246, 0.3);
        border-radius: 12px;
        padding: 20px;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        backdrop-filter: blur(10px);
    }

    .race-accordion-content {
        overflow: hidden;
        transition: max-height 0.5s ease, opacity 0.3s ease;
        background: rgba(15, 23, 42, 0.8);
        border: 1px solid rgba(59, 130, 246, 0.2);
        border-radius: 12px;
        margin-bottom: 20px;
    }

    .race-accordion-content.expanded {
        max-height: 5000px !important;
        opacity: 1 !important;
        padding: 20px;
    }

    .section-title {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 1.3rem;
        font-weight: 700;
        color: #3b82f6;
        margin-bottom: 25px;
        padding-bottom: 10px;
        border-bottom: 2px solid rgba(59, 130, 246, 0.3);
    }

    /* 馬券カードスタイル */
    .horse-card {
        background: rgba(30, 41, 59, 0.6);
        border-left: 4px solid;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 15px;
        backdrop-filter: blur(10px);
    }

    .horse-card-main { border-left-color: #10b981; }
    .horse-card-rival { border-left-color: #f59e0b; }
    .horse-card-dark { border-left-color: #8b5cf6; }
    .horse-card-warning { border-left-color: #f97316; }

    .bet-strategy {
        background: rgba(30, 41, 59, 0.6);
        border: 1px solid rgba(59, 130, 246, 0.3);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        backdrop-filter: blur(10px);
    }

    .strategy-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: #3b82f6;
        margin-bottom: 15px;
    }

    .bet-list {
        margin-bottom: 15px;
    }

    .bet-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid rgba(148, 163, 184, 0.1);
    }

    .risk-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 15px;
    }

    .risk-bar {
        height: 6px;
        background: rgba(148, 163, 184, 0.2);
        border-radius: 3px;
        flex: 1;
    }

    .risk-bar.active.risk-low { background: #10b981; }
    .risk-bar.active.risk-medium { background: #f59e0b; }
    .risk-bar.active.risk-high { background: #ef4444; }

    .expected-return {
        text-align: center;
        padding: 12px;
        background: rgba(59, 130, 246, 0.1);
        border-radius: 8px;
    }

    .analysis-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    .analysis-card {
        background: rgba(30, 41, 59, 0.4);
        border: 1px solid rgba(148, 163, 184, 0.2);
        border-radius: 8px;
        padding: 15px;
    }

    .analysis-header {
        font-weight: 600;
        color: #3b82f6;
        margin-bottom: 10px;
        font-size: 0.9rem;
    }
</style>