---
// ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
export interface Props {
    requiredPlan: 'free' | 'standard' | 'premium' | 'Premium Predictions' | 'Premium Sanrenpuku' | 'Premium Combo' | 'Premium Plus';
    showUpgrade?: boolean;
}

const { requiredPlan, showUpgrade = true } = Astro.props;
---

<div id="access-control" data-required-plan={requiredPlan}>
    <!-- èª­ã¿è¾¼ã¿ä¸­è¡¨ç¤º -->
    <div id="loading-state" class="access-loading">
        <div class="spinner"></div>
        <p>ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’ç¢ºèªä¸­...</p>
    </div>
    
    <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div id="content-area" class="hidden">
        <slot />
    </div>
    
    <!-- ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
    <div id="access-denied" class="access-denied hidden">
        <div class="denied-icon">ğŸ”’</div>
        <h2>ã“ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ã”è¦§ã„ãŸã ãã«ã¯ä¼šå“¡ç™»éŒ²ãŒå¿…è¦ã§ã™</h2>
        <p class="denied-message"></p>
        
        {showUpgrade && (
            <div class="upgrade-options">
                <a href="/pricing/" class="upgrade-btn primary">æ–™é‡‘ãƒ—ãƒ©ãƒ³ã‚’è¦‹ã‚‹</a>
                <a href="/auth/login" class="upgrade-btn secondary">ãƒ­ã‚°ã‚¤ãƒ³</a>
            </div>
        )}
    </div>
</div>

<style>
    .access-loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 60px 20px;
        color: #94a3b8;
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 3px solid rgba(59, 130, 246, 0.2);
        border-top: 3px solid #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .hidden {
        display: none !important;
    }

    .access-denied {
        text-align: center;
        padding: 80px 20px;
        background: rgba(30, 41, 59, 0.8);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(59, 130, 246, 0.3);
        border-radius: 16px;
        margin: 40px auto;
        max-width: 600px;
    }

    .denied-icon {
        font-size: 64px;
        margin-bottom: 24px;
        filter: grayscale(0.5);
        opacity: 0.8;
    }

    .access-denied h2 {
        color: #f1f5f9;
        font-size: 24px;
        margin-bottom: 16px;
    }

    .denied-message {
        color: #94a3b8;
        font-size: 16px;
        line-height: 1.6;
        margin-bottom: 32px;
    }

    .upgrade-options {
        display: flex;
        gap: 16px;
        justify-content: center;
        flex-wrap: wrap;
    }

    .upgrade-btn {
        padding: 12px 24px;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.3s;
        display: inline-block;
    }

    .upgrade-btn.primary {
        background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
        color: white;
    }

    .upgrade-btn.primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
    }

    .upgrade-btn.secondary {
        background: transparent;
        color: #3b82f6;
        border: 2px solid rgba(59, 130, 246, 0.5);
    }

    .upgrade-btn.secondary:hover {
        background: rgba(59, 130, 246, 0.1);
        border-color: #3b82f6;
    }
</style>

<script>
    // ç’°å¢ƒåˆ¤å®š
    function isDevelopmentMode() {
        // é–‹ç™ºç’°å¢ƒåˆ¤å®šï¼šlocalhostã¾ãŸã¯ãƒãƒ¼ãƒˆç•ªå·ãŒã‚ã‚‹å ´åˆ
        const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        const hasDevPort = window.location.port === '4321' || window.location.port === '3000';
        
        return isLocalhost || hasDevPort;
    }

    // ç°¡æ˜“èªè¨¼çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯ï¼ˆèªè¨¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ä½¿ç”¨ã¾ã§ï¼‰
    function getCurrentUserPlan() {
        console.log('ğŸ” èªè¨¼çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯é–‹å§‹');
        
        // 0. ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³æƒ…å ±ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆå„ªå…ˆï¼‰
        const demoKeys = Object.keys(localStorage).filter(key => key.startsWith('demo_subscription_'));
        if (demoKeys.length > 0) {
            try {
                const demoData = JSON.parse(localStorage.getItem(demoKeys[0]));
                console.log('ğŸ­ ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰èªè¨¼:', demoData);
                return {
                    user: { id: 'demo_user', email: 'demo@example.com', demo: true },
                    plan: demoData.planType.toLowerCase(),
                    planType: 'Monthly',
                    lifetimeSanrenpuku: false
                };
            } catch (error) {
                console.error('Demo data parsing error:', error);
            }
        }

        // 1. æ—§å½¢å¼ã®test_subscription_ãƒ‡ãƒ¼ã‚¿ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆæœ€å„ªå…ˆ - æœ¬ç•ªã§å®Ÿéš›ã«ä½¿ç”¨ä¸­ï¼‰
        const testSubscriptionKeys = Object.keys(localStorage).filter(key => key.startsWith('test_subscription_'));
        if (testSubscriptionKeys.length > 0) {
            try {
                const testData = JSON.parse(localStorage.getItem(testSubscriptionKeys[0]));
                console.log('ğŸ“¦ æ—§å½¢å¼èªè¨¼ãƒ‡ãƒ¼ã‚¿ç™ºè¦‹:', testData);
                return {
                    user: { id: testData.userId, legacy: true },
                    plan: testData.planType.toLowerCase(),
                    planType: 'Monthly',
                    lifetimeSanrenpuku: false
                };
            } catch (error) {
                console.error('Test subscription data parsing error:', error);
            }
        }

        // 2. æ–°å½¢å¼ã®user-planãƒã‚§ãƒƒã‚¯ï¼ˆ2026-02-09æ›´æ–°: Lifetimeå¯¾å¿œï¼‰
        const userPlanData = localStorage.getItem('user-plan');
        if (userPlanData) {
            try {
                const userData = JSON.parse(userPlanData);
                console.log('âœ… user-planèªè¨¼:', userData);
                return {
                    user: { email: userData.email },
                    plan: userData.plan || 'free',
                    planType: userData.planType || 'Monthly',  // è¿½åŠ 
                    lifetimeSanrenpuku: userData.lifetimeSanrenpuku || false  // è¿½åŠ 
                };
            } catch (error) {
                console.error('User plan parsing error:', error);
            }
        }

        // 3. æ—§å½¢å¼ã®isLoggedInãƒã‚§ãƒƒã‚¯ï¼ˆäº’æ›æ€§ï¼‰
        const isLoggedIn = localStorage.getItem('isLoggedIn');
        const userPlan = localStorage.getItem('userPlan');
        if (isLoggedIn === 'true') {
            console.log('âœ… æ—§å½¢å¼èªè¨¼ï¼ˆisLoggedInï¼‰:', userPlan);
            return {
                user: { legacy: true },
                plan: userPlan || 'free',
                planType: 'Monthly',
                lifetimeSanrenpuku: false
            };
        }

        // 4. nankan_userèªè¨¼æƒ…å ±ã‚’å–å¾—ï¼ˆæ–°ãƒ†ã‚¹ãƒˆèªè¨¼ç”¨ãƒ»2026-02-09æ›´æ–°: Lifetimeå¯¾å¿œï¼‰
        const nankanUser = localStorage.getItem('nankan_user');
        if (nankanUser) {
            try {
                const userData = JSON.parse(nankanUser);
                console.log('âœ… nankan_userèªè¨¼:', userData);
                return {
                    user: { email: userData.email, name: userData.name },
                    plan: userData.plan || 'free',
                    planType: userData.planType || 'Monthly',  // è¿½åŠ 
                    lifetimeSanrenpuku: userData.lifetimeSanrenpuku || false  // è¿½åŠ 
                };
            } catch (error) {
                console.error('Nankan user parsing error:', error);
            }
        }

        // 5. ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰èªè¨¼æƒ…å ±ã‚’å–å¾—ï¼ˆ2026-02-09æ›´æ–°: Lifetimeå¯¾å¿œï¼‰
        const authData = localStorage.getItem('auth_data');
        if (authData) {
            try {
                const { user, plan, expiresAt, planType, lifetimeSanrenpuku } = JSON.parse(authData);

                // æœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯
                if (new Date() > new Date(expiresAt)) {
                    localStorage.removeItem('auth_data');
                    return { user: null, plan: 'free', planType: 'Monthly', lifetimeSanrenpuku: false };
                }

                return {
                    user,
                    plan: plan || 'free',
                    planType: planType || 'Monthly',
                    lifetimeSanrenpuku: lifetimeSanrenpuku || false
                };
            } catch (error) {
                console.error('Auth data parsing error:', error);
                localStorage.removeItem('auth_data');
            }
        }

        // 6. ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒã‚§ãƒƒã‚¯ï¼ˆ2026-02-09æ›´æ–°: Lifetimeå¯¾å¿œï¼‰
        const sessionAuth = sessionStorage.getItem('temp_auth');
        if (sessionAuth) {
            try {
                const { plan, planType, lifetimeSanrenpuku } = JSON.parse(sessionAuth);
                return {
                    user: { temp: true },
                    plan: plan || 'free',
                    planType: planType || 'Monthly',
                    lifetimeSanrenpuku: lifetimeSanrenpuku || false
                };
            } catch (error) {
                sessionStorage.removeItem('temp_auth');
            }
        }

        // 7. ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯æœªç™»éŒ²
        console.log('âŒ èªè¨¼ãƒ‡ãƒ¼ã‚¿ãªã— - æœªç™»éŒ²çŠ¶æ…‹');
        return { user: null, plan: null, planType: 'Monthly', lifetimeSanrenpuku: false };
    }

    // ãƒ—ãƒ©ãƒ³éšå±¤ãƒã‚§ãƒƒã‚¯ï¼ˆ2026-02-09æ›´æ–°: Lifetimeå¯¾å¿œï¼‰
    function canAccessContent(userPlan, requiredPlan, user, planType = 'Monthly', lifetimeSanrenpuku = false) {
        // ğŸš¨ 2025-11-26è¿½åŠ : é€€ä¼šç”³è«‹ãƒã‚§ãƒƒã‚¯ï¼ˆæœ€å„ªå…ˆï¼‰
        const isWithdrawalRequested = localStorage.getItem('isWithdrawalRequested') === 'true';
        if (isWithdrawalRequested) {
            console.log(`ğŸš« é€€ä¼šç”³è«‹æ¸ˆã¿æ¤œå‡º - ãƒ—ãƒ©ãƒ³ã‚’å¼·åˆ¶çš„ã«Freeã¨ã—ã¦æ‰±ã„ã¾ã™`);
            return requiredPlan === 'free' && user !== null; // ç„¡æ–™ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
        }

        // ğŸ”§ 2025-11-26å¼·åŒ–: æœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯ï¼ˆisExpiredãƒ•ãƒ©ã‚°å„ªå…ˆï¼‰
        const isExpired = localStorage.getItem('isExpired') === 'true';
        const validUntil = localStorage.getItem('validUntil');
        let effectivePlan = userPlan;

        // isExpiredãƒ•ãƒ©ã‚° ã¾ãŸã¯ validUntilæ—¥ä»˜ãƒã‚§ãƒƒã‚¯
        if (isExpired) {
            console.log(`âš ï¸ æœ‰åŠ¹æœŸé™åˆ‡ã‚Œæ¤œå‡ºï¼ˆisExpiredãƒ•ãƒ©ã‚°ï¼‰ - ãƒ—ãƒ©ãƒ³ã‚’å¼·åˆ¶çš„ã«Freeã¨ã—ã¦æ‰±ã„ã¾ã™`);
            effectivePlan = 'Free';
        } else if (validUntil && validUntil !== 'null') {
            const expiry = new Date(validUntil);
            const now = new Date();

            if (expiry < now) {
                console.log(`âš ï¸ æœ‰åŠ¹æœŸé™åˆ‡ã‚Œæ¤œå‡ºï¼ˆvalidUntilæ—¥ä»˜ï¼‰: ${validUntil} - ãƒ—ãƒ©ãƒ³ã‚’å¼·åˆ¶çš„ã«Freeã¨ã—ã¦æ‰±ã„ã¾ã™`);
                effectivePlan = 'Free';
            }
        }

        const planHierarchy = {
            // æ—§ãƒ—ãƒ©ãƒ³ï¼ˆäº’æ›æ€§ç¶­æŒï¼‰
            'free': 0,
            'Free': 0,
            'standard': 1,
            'Standard': 1,
            'premium': 2,
            'Premium': 2,

            // æ–°ãƒ—ãƒ©ãƒ³ï¼ˆ2026-02-09æ›´æ–°ï¼‰
            'Premium Predictions': 2,      // é¦¬å˜ã®ã¿ï¼ˆå»ƒæ­¢äºˆå®šï¼‰
            'Premium Sanrenpuku': 2,       // ä¸‰é€£è¤‡ã®ã¿ï¼ˆå»ƒæ­¢äºˆå®šï¼‰
            'Premium Combo': 3,            // é¦¬å˜+ä¸‰é€£è¤‡ï¼ˆå»ƒæ­¢äºˆå®šï¼‰
            'Premium Plus': 4              // 1éè¶…ç²¾å¯†ï¼ˆÂ¥68,000ãƒ»å˜å“ï¼‰
        };

        const userLevel = planHierarchy[effectivePlan] || 0;  // effectivePlanã‚’ä½¿ç”¨
        const requiredLevel = planHierarchy[requiredPlan] || 0;

        console.log(`ğŸ” ã‚¢ã‚¯ã‚»ã‚¹ãƒã‚§ãƒƒã‚¯è©³ç´°:`, {
            userPlan, effectivePlan, requiredPlan, user,
            userLevel, requiredLevel,
            hasUser: user !== null,
            validUntil: validUntil
        });

        // ç„¡æ–™ãƒ—ãƒ©ãƒ³ãŒå¿…è¦ãªå ´åˆ - ç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
        if (requiredPlan === 'free') {
            const hasValidFreeUser = user !== null && (user.email || user.legacy || user.demo || user.temp || user.isTest);
            console.log(`ğŸ†“ ç„¡æ–™ä¼šå“¡é™å®šã‚³ãƒ³ãƒ†ãƒ³ãƒ„ - ç™»éŒ²ãƒã‚§ãƒƒã‚¯:`, hasValidFreeUser, { user, plan });
            return hasValidFreeUser; // ç™»éŒ²æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯
        }

        // ä¸‰é€£è¤‡å°‚ç”¨ãƒšãƒ¼ã‚¸ã®ç‰¹æ®Šå‡¦ç†ï¼ˆ2026-02-09æ›´æ–°: Lifetime Sanrenpukuå¯¾å¿œï¼‰
        if (requiredPlan === 'Premium Sanrenpuku') {
            const hasValidUser = user !== null && (user.email || user.legacy || user.demo || user.temp || user.isTest);

            // ğŸ”§ æœ‰åŠ¹æœŸé™åˆ‡ã‚Œã®å ´åˆã¯ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯
            if (effectivePlan === 'Free') {
                console.log(`ğŸ ä¸‰é€£è¤‡ã‚¢ã‚¯ã‚»ã‚¹ãƒã‚§ãƒƒã‚¯: Free - ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦`);
                return false;
            }

            // 1. Premium Sanrenpuku ã¾ãŸã¯ Premium Combo ã§ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ï¼ˆå¾“æ¥ãƒ—ãƒ©ãƒ³ï¼‰
            if (effectivePlan === 'Premium Sanrenpuku' || effectivePlan === 'Premium Combo') {
                console.log(`ğŸ ä¸‰é€£è¤‡ã‚¢ã‚¯ã‚»ã‚¹ãƒã‚§ãƒƒã‚¯: ${effectivePlan} - ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯`);
                return hasValidUser;
            }

            // 2. âœ… Sanrenpuku Lifetimeè³¼å…¥è€…ï¼ˆæ–°ä»•æ§˜ï¼‰
            //    - Premiumæœ‰åŠ¹ä¸­ã®ã¿Sanrenpukuæ©Ÿèƒ½ãŒä½¿ãˆã‚‹
            if (lifetimeSanrenpuku === true && effectivePlan === 'Premium') {
                console.log(`ğŸ ä¸‰é€£è¤‡ã‚¢ã‚¯ã‚»ã‚¹ãƒã‚§ãƒƒã‚¯: Sanrenpuku Lifetime + Premium - ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯`);
                return hasValidUser;
            }

            console.log(`ğŸ ä¸‰é€£è¤‡ã‚¢ã‚¯ã‚»ã‚¹ãƒã‚§ãƒƒã‚¯: ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦`, { userPlan, effectivePlan, hasValidUser, lifetimeSanrenpuku });
            return false;
        }

        // é¦¬å˜å°‚ç”¨ãƒšãƒ¼ã‚¸ã®ç‰¹æ®Šå‡¦ç†ï¼ˆpremium, Premium, Premium Predictionsï¼‰ï¼ˆæœ‰åŠ¹æœŸé™è€ƒæ…®ï¼‰
        if (requiredPlan === 'premium' || requiredPlan === 'Premium' || requiredPlan === 'Premium Predictions') {
            const hasValidUser = user !== null && (user.email || user.legacy || user.demo || user.temp || user.isTest);
            // Premium / Premium Predictions ã¾ãŸã¯ Premium Combo ã§ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
            // âš ï¸ userLevelã¯ä½¿ã‚ãªã„ï¼ˆPremium Sanrenpukuç­‰ãŒèª¤ã£ã¦ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¦ã—ã¾ã†ãŸã‚ï¼‰
            // ğŸ”§ æœ‰åŠ¹æœŸé™åˆ‡ã‚Œã®å ´åˆã¯ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯
            const canAccess = hasValidUser && effectivePlan !== 'Free' && (
                effectivePlan === 'Premium' ||
                effectivePlan === 'premium' ||
                effectivePlan === 'Premium Predictions' ||
                effectivePlan === 'Premium Combo'
            );
            console.log(`ğŸ‡ é¦¬å˜ã‚¢ã‚¯ã‚»ã‚¹ãƒã‚§ãƒƒã‚¯:`, canAccess, { userPlan, effectivePlan, hasValidUser });
            return canAccess;
        }

        // æœ‰æ–™ãƒ—ãƒ©ãƒ³ã®å ´åˆã¯å¾“æ¥é€šã‚Šã®éšå±¤ãƒã‚§ãƒƒã‚¯ + ç™»éŒ²ãƒã‚§ãƒƒã‚¯
        const hasValidUser = user !== null && (user.email || user.legacy || user.demo || user.temp || user.isTest);
        const hasAccess = userLevel >= requiredLevel && hasValidUser;
        console.log(`ğŸ’ æœ‰æ–™ã‚¢ã‚¯ã‚»ã‚¹ãƒã‚§ãƒƒã‚¯:`, hasAccess, { userLevel, requiredLevel, hasValidUser, userPlan, requiredPlan });
        return hasAccess;
    }

    // ãƒ—ãƒ©ãƒ³è¡¨ç¤ºåå–å¾—ï¼ˆ2025-10-30æ›´æ–°ï¼‰
    function getPlanDisplayName(plan) {
        const displayNames = {
            // æ—§ãƒ—ãƒ©ãƒ³
            'free': 'ç„¡æ–™ãƒ—ãƒ©ãƒ³',
            'Free': 'ç„¡æ–™ãƒ—ãƒ©ãƒ³',
            'standard': 'ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ãƒ—ãƒ©ãƒ³',
            'Standard': 'ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ãƒ—ãƒ©ãƒ³',
            'premium': 'ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³',
            'Premium': 'ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³',

            // æ–°ãƒ—ãƒ©ãƒ³ï¼ˆ2025-10-30è¿½åŠ ï¼‰
            'Premium Predictions': 'Premium Predictionsï¼ˆé¦¬å˜ï¼‰',
            'Premium Sanrenpuku': 'Premium Sanrenpukuï¼ˆä¸‰é€£è¤‡ï¼‰',
            'Premium Combo': 'Premium Comboï¼ˆé¦¬å˜+ä¸‰é€£è¤‡ï¼‰',
            'Premium Plus': 'Premium Plusï¼ˆ1éè¶…ç²¾å¯†ï¼‰'
        };
        return displayNames[plan] || 'ä¸æ˜ãªãƒ—ãƒ©ãƒ³';
    }

    async function checkAccess() {
        const accessControl = document.getElementById('access-control');
        const loadingState = document.getElementById('loading-state');
        const contentArea = document.getElementById('content-area');
        const accessDenied = document.getElementById('access-denied');
        
        const requiredPlan = accessControl.dataset.requiredPlan;
        
        try {
            // èªè¨¼çŠ¶æ…‹ã®å–å¾—ï¼ˆ2026-02-09æ›´æ–°: Lifetimeå¯¾å¿œï¼‰
            const { user, plan, planType, lifetimeSanrenpuku } = getCurrentUserPlan();
            console.log(`ğŸ”’ èªè¨¼ãƒã‚§ãƒƒã‚¯ - ãƒ¦ãƒ¼ã‚¶ãƒ¼:`, user, `ãƒ—ãƒ©ãƒ³:`, plan, `PlanType:`, planType, `LifetimeSanrenpuku:`, lifetimeSanrenpuku, `å¿…è¦ãƒ—ãƒ©ãƒ³:`, requiredPlan);

            // é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ã§ã®å„ªå…ˆè¡¨ç¤ºï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
            if (isDevelopmentMode()) {
                console.log('ğŸ”§ é–‹ç™ºãƒ¢ãƒ¼ãƒ‰: èªè¨¼æƒ…å ±ã‚’å„ªå…ˆè¡¨ç¤º');
                // é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ã§ã¯10ç§’ä»¥å†…ã«èªè¨¼ãŒå®Œäº†ã—ãªã„å ´åˆã¯å¼·åˆ¶è¡¨ç¤º
                setTimeout(() => {
                    if (loadingState && !loadingState.classList.contains('hidden')) {
                        console.log('âš ï¸ é–‹ç™ºãƒ¢ãƒ¼ãƒ‰: èªè¨¼ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ - å¼·åˆ¶è¡¨ç¤ºå®Ÿè¡Œ');
                        loadingState.style.display = 'none';
                        loadingState.classList.add('hidden');
                        if (contentArea) {
                            contentArea.style.display = 'block';
                            contentArea.classList.remove('hidden');
                        }
                    }
                }, 10000);
            }
            
            // ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãƒã‚§ãƒƒã‚¯ï¼ˆ2026-02-09æ›´æ–°: Lifetimeå¯¾å¿œï¼‰
            if (canAccessContent(plan, requiredPlan, user, planType, lifetimeSanrenpuku)) {
                // ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯
                console.log(`âœ… ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯: ${getPlanDisplayName(plan)} â†’ ${requiredPlan}ã‚³ãƒ³ãƒ†ãƒ³ãƒ„`);
                console.log('ğŸ“‹ DOMè¦ç´ çŠ¶æ…‹ - loading:', loadingState, 'content:', contentArea, 'denied:', accessDenied);
                
                // å¼·åˆ¶çš„ã«DOMæ“ä½œã‚’å®Ÿè¡Œ
                if (loadingState) {
                    loadingState.style.display = 'none';
                    loadingState.classList.add('hidden');
                }
                if (contentArea) {
                    contentArea.style.display = 'block';
                    contentArea.classList.remove('hidden');
                }
                if (accessDenied) {
                    accessDenied.style.display = 'none';
                    accessDenied.classList.add('hidden');
                }
                
                console.log('ğŸ”“ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤ºå®Œäº†:', {
                    loading: loadingState ? loadingState.style.display : 'ãªã—',
                    content: contentArea ? contentArea.style.display : 'ãªã—',
                    denied: accessDenied ? accessDenied.style.display : 'ãªã—'
                });
            } else {
                // ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦
                console.log(`âŒ ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦: ${getPlanDisplayName(plan)} â†’ ${requiredPlan}ã‚³ãƒ³ãƒ†ãƒ³ãƒ„`);
                loadingState.classList.add('hidden');
                contentArea.classList.add('hidden'); // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’æ˜ç¤ºçš„ã«éè¡¨ç¤º
                accessDenied.classList.remove('hidden');
                
                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
                const deniedMessage = accessDenied.querySelector('.denied-message');
                
                if (!user) {
                    if (requiredPlan === 'free') {
                        deniedMessage.textContent = 'ç„¡æ–™äºˆæƒ³ã¯ä¼šå“¡ç™»éŒ²ãªã—ã§ã‚‚ã”è¦§ã„ãŸã ã‘ã¾ã™ã€‚ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚';
                    } else {
                        deniedMessage.textContent = 'ã‚ˆã‚Šè©³ç´°ãªäºˆæƒ³ã‚’ã”è¦§ã„ãŸã ãã«ã¯ã€ä¼šå“¡ç™»éŒ²ã¨ãƒ—ãƒ©ãƒ³ã®ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ãŒå¿…è¦ã§ã™ã€‚';
                    }
                } else {
                    const currentPlanName = getPlanDisplayName(plan);
                    const requiredPlanName = getPlanDisplayName(requiredPlan);
                    
                    deniedMessage.textContent = `ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³: ${currentPlanName}\nã“ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«ã¯ã€Œ${requiredPlanName}ã€ä»¥ä¸Šã®ãƒ—ãƒ©ãƒ³ãŒå¿…è¦ã§ã™ã€‚`;
                }
            }
        } catch (error) {
            console.error('âŒ ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã‚¨ãƒ©ãƒ¼:', error);
            
            // æœ¬ç•ªç’°å¢ƒã§ã¯ã‚¨ãƒ©ãƒ¼æ™‚ã¯ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦ï¼ˆå®‰å…¨å´ã«å€’ã™ï¼‰
            if (!isDevelopmentMode()) {
                console.log('ğŸ”’ æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰: ã‚¨ãƒ©ãƒ¼æ™‚ã¯ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦');
                loadingState.classList.add('hidden');
                accessDenied.classList.remove('hidden');
                
                const deniedMessage = accessDenied.querySelector('.denied-message');
                deniedMessage.textContent = 'ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
            } else {
                // é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ã§ã®ã¿ã‚¨ãƒ©ãƒ¼æ™‚ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯
                console.log('ğŸ”§ é–‹ç™ºãƒ¢ãƒ¼ãƒ‰: ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚è¡¨ç¤ºç¶™ç¶š');
                loadingState.classList.add('hidden');
                contentArea.classList.remove('hidden');
            }
        }
    }

    // âš ï¸ setTestAuth/clearTestAuthé–¢æ•°ã¯ public/test-auth.js ã§å®šç¾©ã•ã‚Œã¦ã„ã¾ã™
    // ã“ã“ã§ã®å†å®šç¾©ã¯å‰Šé™¤ã—ã¾ã—ãŸï¼ˆé‡è¤‡é˜²æ­¢ï¼‰

    document.addEventListener('DOMContentLoaded', () => {
        console.log('ğŸ“‹ DOMContentLoaded - AccessControlåˆæœŸåŒ–é–‹å§‹');

        // DOMè¦ç´ ãŒç¢ºå®Ÿã«å­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
        const accessControl = document.getElementById('access-control');
        const loadingState = document.getElementById('loading-state');
        const contentArea = document.getElementById('content-area');
        const accessDenied = document.getElementById('access-denied');

        if (!accessControl || !loadingState || !contentArea || !accessDenied) {
            console.error('âŒ å¿…è¦ãªDOMè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', {
                accessControl: !!accessControl,
                loadingState: !!loadingState,
                contentArea: !!contentArea,
                accessDenied: !!accessDenied
            });
            // DOMè¦ç´ ãŒä¸è¶³ã—ã¦ã„ã‚‹å ´åˆã§ã‚‚æœ€ä½é™ã®è¡¨ç¤ºã‚’è¡Œã†
            if (contentArea) {
                contentArea.style.display = 'block';
                contentArea.classList.remove('hidden');
            }
            return;
        }

        console.log('âœ… å…¨DOMè¦ç´ ç¢ºèªå®Œäº† - AccessControlå®Ÿè¡Œé–‹å§‹');

        // DOMè¦ç´ ã®å®Œå…¨ãªæº–å‚™ã‚’å¾…ã¤ãŸã‚å°‘ã—é…å»¶
        setTimeout(() => {
            checkAccess();
        }, 50);
    });
</script>