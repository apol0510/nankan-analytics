---
// „Ç¢„ÇØ„Çª„ÇπÂà∂Âæ°„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà
export interface Props {
    requiredPlan: 'free' | 'standard' | 'premium';
    showUpgrade?: boolean;
}

const { requiredPlan, showUpgrade = true } = Astro.props;
---

<div id="access-control" data-required-plan={requiredPlan}>
    <!-- Ë™≠„ÅøËæº„Åø‰∏≠Ë°®Á§∫ -->
    <div id="loading-state" class="access-loading">
        <div class="spinner"></div>
        <p>„Ç¢„ÇØ„Çª„ÇπÊ®©Èôê„ÇíÁ¢∫Ë™ç‰∏≠...</p>
    </div>
    
    <!-- „Ç≥„É≥„ÉÜ„É≥„ÉÑË°®Á§∫„Ç®„É™„Ç¢ -->
    <div id="content-area" class="hidden">
        <slot />
    </div>
    
    <!-- „Ç¢„ÇØ„Çª„ÇπÊãíÂê¶„É°„ÉÉ„Çª„Éº„Ç∏ -->
    <div id="access-denied" class="access-denied hidden">
        <div class="denied-icon">üîí</div>
        <h2>„Åì„ÅÆ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Çí„ÅîË¶ß„ÅÑ„Åü„Å†„Åè„Å´„ÅØ‰ºöÂì°ÁôªÈå≤„ÅåÂøÖË¶Å„Åß„Åô</h2>
        <p class="denied-message"></p>
        
        {showUpgrade && (
            <div class="upgrade-options">
                <a href="/pricing/" class="upgrade-btn primary">ÊñôÈáë„Éó„É©„É≥„ÇíË¶ã„Çã</a>
                <a href="/auth/login" class="upgrade-btn secondary">„É≠„Ç∞„Ç§„É≥</a>
            </div>
        )}
    </div>
</div>

<style>
    .access-loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 60px 20px;
        color: #94a3b8;
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 3px solid rgba(59, 130, 246, 0.2);
        border-top: 3px solid #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .hidden {
        display: none !important;
    }

    .access-denied {
        text-align: center;
        padding: 80px 20px;
        background: rgba(30, 41, 59, 0.8);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(59, 130, 246, 0.3);
        border-radius: 16px;
        margin: 40px auto;
        max-width: 600px;
    }

    .denied-icon {
        font-size: 64px;
        margin-bottom: 24px;
        filter: grayscale(0.5);
        opacity: 0.8;
    }

    .access-denied h2 {
        color: #f1f5f9;
        font-size: 24px;
        margin-bottom: 16px;
    }

    .denied-message {
        color: #94a3b8;
        font-size: 16px;
        line-height: 1.6;
        margin-bottom: 32px;
    }

    .upgrade-options {
        display: flex;
        gap: 16px;
        justify-content: center;
        flex-wrap: wrap;
    }

    .upgrade-btn {
        padding: 12px 24px;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.3s;
        display: inline-block;
    }

    .upgrade-btn.primary {
        background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
        color: white;
    }

    .upgrade-btn.primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
    }

    .upgrade-btn.secondary {
        background: transparent;
        color: #3b82f6;
        border: 2px solid rgba(59, 130, 246, 0.5);
    }

    .upgrade-btn.secondary:hover {
        background: rgba(59, 130, 246, 0.1);
        border-color: #3b82f6;
    }
</style>

<script>
    // Áí∞Â¢ÉÂà§ÂÆö
    function isDevelopmentMode() {
        // ÈñãÁô∫Áí∞Â¢ÉÂà§ÂÆöÔºölocalhost„Åæ„Åü„ÅØ„Éù„Éº„ÉàÁï™Âè∑„Åå„ÅÇ„ÇãÂ†¥Âêà
        const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        const hasDevPort = window.location.port === '4321' || window.location.port === '3000';
        
        return isLocalhost || hasDevPort;
    }

    // Á∞°ÊòìË™çË®ºÁä∂ÊÖã„ÉÅ„Çß„ÉÉ„ÇØÔºàË™çË®º„É¢„Ç∏„É•„Éº„É´‰ΩøÁî®„Åæ„ÅßÔºâ
    function getCurrentUserPlan() {
        console.log('üîç Ë™çË®ºÁä∂ÊÖã„ÉÅ„Çß„ÉÉ„ÇØÈñãÂßã');
        
        // 0. „Éá„É¢„É¢„Éº„Éâ„ÅÆ„Çµ„Éñ„Çπ„ÇØ„É™„Éó„Ç∑„Éß„É≥ÊÉÖÂ†±„Çí„ÉÅ„Çß„ÉÉ„ÇØÔºàÂÑ™ÂÖàÔºâ
        const demoKeys = Object.keys(localStorage).filter(key => key.startsWith('demo_subscription_'));
        if (demoKeys.length > 0) {
            try {
                const demoData = JSON.parse(localStorage.getItem(demoKeys[0]));
                console.log('üé≠ „Éá„É¢„É¢„Éº„ÉâË™çË®º:', demoData);
                return { 
                    user: { id: 'demo_user', email: 'demo@example.com', demo: true }, 
                    plan: demoData.planType.toLowerCase() 
                };
            } catch (error) {
                console.error('Demo data parsing error:', error);
            }
        }

        // 1. ÊóßÂΩ¢Âºè„ÅÆtest_subscription_„Éá„Éº„Çø„Çí„ÉÅ„Çß„ÉÉ„ÇØÔºàÊúÄÂÑ™ÂÖà - Êú¨Áï™„ÅßÂÆüÈöõ„Å´‰ΩøÁî®‰∏≠Ôºâ
        const testSubscriptionKeys = Object.keys(localStorage).filter(key => key.startsWith('test_subscription_'));
        if (testSubscriptionKeys.length > 0) {
            try {
                const testData = JSON.parse(localStorage.getItem(testSubscriptionKeys[0]));
                console.log('üì¶ ÊóßÂΩ¢ÂºèË™çË®º„Éá„Éº„ÇøÁô∫Ë¶ã:', testData);
                return { 
                    user: { id: testData.userId, legacy: true }, 
                    plan: testData.planType.toLowerCase() 
                };
            } catch (error) {
                console.error('Test subscription data parsing error:', error);
            }
        }

        // 2. Êñ∞ÂΩ¢Âºè„ÅÆuser-plan„ÉÅ„Çß„ÉÉ„ÇØ
        const userPlanData = localStorage.getItem('user-plan');
        if (userPlanData) {
            try {
                const userData = JSON.parse(userPlanData);
                console.log('‚úÖ user-planË™çË®º:', userData);
                return { 
                    user: { email: userData.email }, 
                    plan: userData.plan || 'free' 
                };
            } catch (error) {
                console.error('User plan parsing error:', error);
            }
        }

        // 3. ÊóßÂΩ¢Âºè„ÅÆisLoggedIn„ÉÅ„Çß„ÉÉ„ÇØÔºà‰∫íÊèõÊÄßÔºâ
        const isLoggedIn = localStorage.getItem('isLoggedIn');
        const userPlan = localStorage.getItem('userPlan');
        if (isLoggedIn === 'true') {
            console.log('‚úÖ ÊóßÂΩ¢ÂºèË™çË®ºÔºàisLoggedInÔºâ:', userPlan);
            return { 
                user: { legacy: true }, 
                plan: userPlan || 'free' 
            };
        }

        // 4. „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Åã„ÇâË™çË®ºÊÉÖÂ†±„ÇíÂèñÂæó
        const authData = localStorage.getItem('auth_data');
        if (authData) {
            try {
                const { user, plan, expiresAt } = JSON.parse(authData);
                
                // ÊúâÂäπÊúüÈôê„ÉÅ„Çß„ÉÉ„ÇØ
                if (new Date() > new Date(expiresAt)) {
                    localStorage.removeItem('auth_data');
                    return { user: null, plan: 'free' };
                }
                
                return { user, plan: plan || 'free' };
            } catch (error) {
                console.error('Auth data parsing error:', error);
                localStorage.removeItem('auth_data');
            }
        }

        // 5. „Çª„ÉÉ„Ç∑„Éß„É≥„Çπ„Éà„É¨„Éº„Ç∏„ÉÅ„Çß„ÉÉ„ÇØ
        const sessionAuth = sessionStorage.getItem('temp_auth');
        if (sessionAuth) {
            try {
                const { plan } = JSON.parse(sessionAuth);
                return { user: { temp: true }, plan: plan || 'free' };
            } catch (error) {
                sessionStorage.removeItem('temp_auth');
            }
        }

        // 6. „Éá„Éï„Ç©„É´„Éà„ÅØÊú™ÁôªÈå≤
        console.log('‚ùå Ë™çË®º„Éá„Éº„Çø„Å™„Åó - Êú™ÁôªÈå≤Áä∂ÊÖã');
        return { user: null, plan: null };
    }

    // „Éó„É©„É≥ÈöéÂ±§„ÉÅ„Çß„ÉÉ„ÇØ
    function canAccessContent(userPlan, requiredPlan, user) {
        const planHierarchy = {
            'free': 0,
            'standard': 1,
            'premium': 2
        };
        
        const userLevel = planHierarchy[userPlan] || 0;
        const requiredLevel = planHierarchy[requiredPlan] || 0;
        
        console.log(`üîç „Ç¢„ÇØ„Çª„Çπ„ÉÅ„Çß„ÉÉ„ÇØË©≥Á¥∞:`, {
            userPlan, requiredPlan, user, 
            userLevel, requiredLevel,
            hasUser: user !== null
        });
        
        // ÁÑ°Êñô„Éó„É©„É≥„ÅåÂøÖË¶Å„Å™Â†¥Âêà - ÁôªÈå≤„É¶„Éº„Ç∂„Éº„ÅÆ„Åø„Ç¢„ÇØ„Çª„ÇπÂèØËÉΩ
        if (requiredPlan === 'free') {
            const hasValidFreeUser = user !== null && (user.email || user.legacy || user.demo || user.temp);
            console.log(`üÜì ÁÑ°Êñô‰ºöÂì°ÈôêÂÆö„Ç≥„É≥„ÉÜ„É≥„ÉÑ - ÁôªÈå≤„ÉÅ„Çß„ÉÉ„ÇØ:`, hasValidFreeUser, { user, plan });
            return hasValidFreeUser; // ÁôªÈå≤Ê∏à„Åø„É¶„Éº„Ç∂„Éº„ÅÆ„Åø„Ç¢„ÇØ„Çª„ÇπË®±ÂèØ
        }
        
        // ÊúâÊñô„Éó„É©„É≥„ÅÆÂ†¥Âêà„ÅØÂæìÊù•ÈÄö„Çä„ÅÆÈöéÂ±§„ÉÅ„Çß„ÉÉ„ÇØ + ÁôªÈå≤„ÉÅ„Çß„ÉÉ„ÇØ
        const hasValidUser = user !== null && (user.email || user.legacy || user.demo || user.temp);
        const hasAccess = userLevel >= requiredLevel && hasValidUser;
        console.log(`üíé ÊúâÊñô„Ç¢„ÇØ„Çª„Çπ„ÉÅ„Çß„ÉÉ„ÇØ:`, hasAccess, { userLevel, requiredLevel, hasValidUser });
        return hasAccess;
    }

    // „Éó„É©„É≥Ë°®Á§∫ÂêçÂèñÂæó
    function getPlanDisplayName(plan) {
        const displayNames = {
            'free': 'ÁÑ°Êñô„Éó„É©„É≥',
            'standard': '„Çπ„Çø„É≥„ÉÄ„Éº„Éâ„Éó„É©„É≥',
            'premium': '„Éó„É¨„Éü„Ç¢„É†„Éó„É©„É≥'
        };
        return displayNames[plan] || '‰∏çÊòé„Å™„Éó„É©„É≥';
    }

    async function checkAccess() {
        const accessControl = document.getElementById('access-control');
        const loadingState = document.getElementById('loading-state');
        const contentArea = document.getElementById('content-area');
        const accessDenied = document.getElementById('access-denied');
        
        const requiredPlan = accessControl.dataset.requiredPlan;
        
        try {
            // Ë™çË®ºÁä∂ÊÖã„ÅÆÂèñÂæó
            const { user, plan } = getCurrentUserPlan();
            console.log(`üîí Ë™çË®º„ÉÅ„Çß„ÉÉ„ÇØ - „É¶„Éº„Ç∂„Éº:`, user, `„Éó„É©„É≥:`, plan, `ÂøÖË¶Å„Éó„É©„É≥:`, requiredPlan);

            // ÈñãÁô∫„É¢„Éº„Éâ„Åß„ÅÆÂÑ™ÂÖàË°®Á§∫Ôºà„Éá„Éê„ÉÉ„Ç∞Áî®Ôºâ
            if (isDevelopmentMode()) {
                console.log('üîß ÈñãÁô∫„É¢„Éº„Éâ: Ë™çË®ºÊÉÖÂ†±„ÇíÂÑ™ÂÖàË°®Á§∫');
            }
            
            // „Ç¢„ÇØ„Çª„ÇπÊ®©Èôê„ÉÅ„Çß„ÉÉ„ÇØ
            if (canAccessContent(plan, requiredPlan, user)) {
                // „Ç¢„ÇØ„Çª„ÇπË®±ÂèØ
                console.log(`‚úÖ „Ç¢„ÇØ„Çª„ÇπË®±ÂèØ: ${getPlanDisplayName(plan)} ‚Üí ${requiredPlan}„Ç≥„É≥„ÉÜ„É≥„ÉÑ`);
                console.log('üìã DOMË¶ÅÁ¥†Áä∂ÊÖã - loading:', loadingState, 'content:', contentArea, 'denied:', accessDenied);
                
                // Âº∑Âà∂ÁöÑ„Å´DOMÊìç‰Ωú„ÇíÂÆüË°å
                if (loadingState) {
                    loadingState.style.display = 'none';
                    loadingState.classList.add('hidden');
                }
                if (contentArea) {
                    contentArea.style.display = 'block';
                    contentArea.classList.remove('hidden');
                }
                if (accessDenied) {
                    accessDenied.style.display = 'none';
                    accessDenied.classList.add('hidden');
                }
                
                console.log('üîì „Ç≥„É≥„ÉÜ„É≥„ÉÑË°®Á§∫ÂÆå‰∫Ü:', {
                    loading: loadingState ? loadingState.style.display : '„Å™„Åó',
                    content: contentArea ? contentArea.style.display : '„Å™„Åó',
                    denied: accessDenied ? accessDenied.style.display : '„Å™„Åó'
                });
            } else {
                // „Ç¢„ÇØ„Çª„ÇπÊãíÂê¶
                console.log(`‚ùå „Ç¢„ÇØ„Çª„ÇπÊãíÂê¶: ${getPlanDisplayName(plan)} ‚Üí ${requiredPlan}„Ç≥„É≥„ÉÜ„É≥„ÉÑ`);
                loadingState.classList.add('hidden');
                contentArea.classList.add('hidden'); // „Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíÊòéÁ§∫ÁöÑ„Å´ÈùûË°®Á§∫
                accessDenied.classList.remove('hidden');
                
                // „É°„ÉÉ„Çª„Éº„Ç∏„Çí„Ç´„Çπ„Çø„Éû„Ç§„Ç∫
                const deniedMessage = accessDenied.querySelector('.denied-message');
                
                if (!user) {
                    if (requiredPlan === 'free') {
                        deniedMessage.textContent = 'ÁÑ°Êñô‰∫àÊÉ≥„ÅØ‰ºöÂì°ÁôªÈå≤„Å™„Åó„Åß„ÇÇ„ÅîË¶ß„ÅÑ„Åü„Å†„Åë„Åæ„Åô„ÄÇ„Ç∑„Çπ„ÉÜ„É†„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Å¶„ÅÑ„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ';
                    } else {
                        deniedMessage.textContent = '„Çà„ÇäË©≥Á¥∞„Å™‰∫àÊÉ≥„Çí„ÅîË¶ß„ÅÑ„Åü„Å†„Åè„Å´„ÅØ„ÄÅ‰ºöÂì°ÁôªÈå≤„Å®„Éó„É©„É≥„ÅÆ„Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„Éâ„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ';
                    }
                } else {
                    const currentPlanName = getPlanDisplayName(plan);
                    const requiredPlanName = getPlanDisplayName(requiredPlan);
                    
                    deniedMessage.textContent = `ÁèæÂú®„ÅÆ„Éó„É©„É≥: ${currentPlanName}\n„Åì„ÅÆ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Å´„ÅØ„Äå${requiredPlanName}„Äç‰ª•‰∏ä„ÅÆ„Éó„É©„É≥„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ`;
                }
            }
        } catch (error) {
            console.error('‚ùå „Ç¢„ÇØ„Çª„ÇπÂà∂Âæ°„Ç®„É©„Éº:', error);
            
            // Êú¨Áï™Áí∞Â¢É„Åß„ÅØ„Ç®„É©„ÉºÊôÇ„ÅØ„Ç¢„ÇØ„Çª„ÇπÊãíÂê¶ÔºàÂÆâÂÖ®ÂÅ¥„Å´ÂÄí„ÅôÔºâ
            if (!isDevelopmentMode()) {
                console.log('üîí Êú¨Áï™„É¢„Éº„Éâ: „Ç®„É©„ÉºÊôÇ„ÅØ„Ç¢„ÇØ„Çª„ÇπÊãíÂê¶');
                loadingState.classList.add('hidden');
                accessDenied.classList.remove('hidden');
                
                const deniedMessage = accessDenied.querySelector('.denied-message');
                deniedMessage.textContent = '„Ç∑„Çπ„ÉÜ„É†„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ„Åó„Å∞„Çâ„ÅèÂæÖ„Å£„Å¶„Åã„ÇâÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ';
            } else {
                // ÈñãÁô∫„É¢„Éº„Éâ„Åß„ÅÆ„Åø„Ç®„É©„ÉºÊôÇ„Ç¢„ÇØ„Çª„ÇπË®±ÂèØ
                console.log('üîß ÈñãÁô∫„É¢„Éº„Éâ: „Ç®„É©„ÉºÊôÇ„ÇÇË°®Á§∫Á∂ôÁ∂ö');
                loadingState.classList.add('hidden');
                contentArea.classList.remove('hidden');
            }
        }
    }

    // „ÉÜ„Çπ„ÉàÁî®„Éò„É´„Éë„ÉºÈñ¢Êï∞ÔºàÈñãÁô∫ÊôÇ„ÅÆ„ÅøÔºâ
    window.setTestAuth = function(plan = 'premium', duration = 3600000) {
        const authData = {
            user: { id: 'test', email: 'test@example.com' },
            plan: plan,
            expiresAt: new Date(Date.now() + duration).toISOString()
        };
        localStorage.setItem('auth_data', JSON.stringify(authData));
        console.log(`üß™ „ÉÜ„Çπ„ÉàË™çË®ºË®≠ÂÆö: ${plan} (${duration/1000/60}ÂàÜÈñì)`);
        location.reload();
    };

    window.clearTestAuth = function() {
        localStorage.removeItem('auth_data');
        sessionStorage.removeItem('temp_auth');
        console.log('üßπ „ÉÜ„Çπ„ÉàË™çË®º„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü');
        location.reload();
    };

    document.addEventListener('DOMContentLoaded', () => {
        console.log('üìã DOMContentLoaded - AccessControlÂàùÊúüÂåñÈñãÂßã');
        // DOMË¶ÅÁ¥†„ÅÆÂÆåÂÖ®„Å™Ê∫ñÂÇô„ÇíÂæÖ„Å§„Åü„ÇÅÂ∞ë„ÅóÈÅÖÂª∂
        setTimeout(() => {
            checkAccess();
        }, 100);
    });
</script>